{"version":3,"file":"126.c3f72531807aba222900.chunk.js","mappings":"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","sources":["webpack://tweb/./src/components/button.ts","webpack://tweb/./src/components/codeInputField.ts","webpack://tweb/./src/components/monkeys/password.ts","webpack://tweb/./src/components/monkeys/tracking.ts","webpack://tweb/./src/components/passwordInputField.ts","webpack://tweb/./src/components/putPreloader.ts","webpack://tweb/./src/components/ripple.ts","webpack://tweb/./src/helpers/cleanSearchText.ts","webpack://tweb/./src/helpers/dom/htmlToSpan.ts","webpack://tweb/./src/helpers/sequentialDom.ts","webpack://tweb/./src/components/appSearch.ts","webpack://tweb/./src/components/inputSearch.ts","webpack://tweb/./src/components/buttonIcon.ts","webpack://tweb/./src/components/sliderTab.ts","webpack://tweb/./src/components/slider.ts","webpack://tweb/./src/components/avatarEdit.ts","webpack://tweb/./src/components/buttonCorner.ts","webpack://tweb/./src/helpers/date.ts","webpack://tweb/./src/components/wrappers/getUserStatusString.ts","webpack://tweb/./src/components/sidebarLeft/tabs/newGroup.ts","webpack://tweb/./src/components/visibilityIntersector.ts","webpack://tweb/./src/helpers/array/findAndSpliceAll.ts","webpack://tweb/./src/components/lazyLoadQueueIntersector.ts","webpack://tweb/./src/components/lazyLoadQueue.ts","webpack://tweb/./src/lib/appManagers/utils/photos/choosePhotoSize.ts","webpack://tweb/./src/helpers/array/accumulate.ts","webpack://tweb/./src/components/groupedLayout.ts","webpack://tweb/./src/components/prepareAlbum.ts","webpack://tweb/./src/helpers/dom/renderImageFromUrl.ts","webpack://tweb/./src/helpers/dom/renderImageWithFadeIn.ts","webpack://tweb/./src/components/singleTransition.ts","webpack://tweb/./src/components/preloader.ts","webpack://tweb/./src/helpers/heavyQueue.ts","webpack://tweb/./src/helpers/blur.ts","webpack://tweb/./src/helpers/bytes/getPreviewURLFromBytes.ts","webpack://tweb/./src/helpers/bytes/bytesToDataURL.ts","webpack://tweb/./src/helpers/getPreviewURLFromThumb.ts","webpack://tweb/./src/helpers/getImageFromStrippedThumb.ts","webpack://tweb/./src/helpers/getStrippedThumbIfNeeded.ts","webpack://tweb/./src/helpers/setAttachmentSize.ts","webpack://tweb/./src/components/wrappers/photo.ts","webpack://tweb/./src/helpers/dom/createVideo.ts","webpack://tweb/./src/helpers/string/toHHMMSS.ts","webpack://tweb/./src/config/font.ts","webpack://tweb/./src/helpers/canvas/getTextWidth.ts","webpack://tweb/./src/components/middleEllipsis.ts","webpack://tweb/./src/helpers/schedulers/throttleWithRaf.ts","webpack://tweb/./src/helpers/schedulers/throttleWith.ts","webpack://tweb/./src/helpers/formatBytes.ts","webpack://tweb/./src/helpers/dom/attachGrabListeners.ts","webpack://tweb/./src/components/rangeSelector.ts","webpack://tweb/./src/components/mediaProgressLine.ts","webpack://tweb/./src/lib/appManagers/utils/messages/getMessageSenderPeerIdOrName.ts","webpack://tweb/./src/components/peerTitle.ts","webpack://tweb/./src/components/wrappers/senderToPeer.ts","webpack://tweb/./src/components/wrappers/sentTime.ts","webpack://tweb/./src/components/audio.ts","webpack://tweb/./src/components/wrappers/video.ts","webpack://tweb/./src/components/wrappers/album.ts","webpack://tweb/./src/components/wrappers/document.ts","webpack://tweb/./src/helpers/saveLottiePreview.ts","webpack://tweb/./src/components/wrappers/stickerAnimation.ts","webpack://tweb/./src/components/wrappers/sticker.ts","webpack://tweb/./src/helpers/bytes/getPathFromBytes.ts","webpack://tweb/./src/components/editPeer.ts","webpack://tweb/./src/components/radioForm.ts","webpack://tweb/./src/components/row.ts","webpack://tweb/./src/helpers/clipboard.ts","webpack://tweb/./src/components/radioField.ts","webpack://tweb/./src/components/toast.ts","webpack://tweb/./src/lib/richTextProcessor/isUsernameValid.ts","webpack://tweb/./src/components/usernameInputField.ts","webpack://tweb/./src/components/popups/peer.ts","webpack://tweb/./src/components/sidebarRight/tabs/chatType.ts","webpack://tweb/./src/helpers/scrollableLoader.ts","webpack://tweb/./src/helpers/windowSize.ts","webpack://tweb/./src/helpers/array/filterAsync.ts","webpack://tweb/./src/helpers/number/numberThousandSplitter.ts","webpack://tweb/./src/components/wrappers/getChatMembersString.ts","webpack://tweb/./src/components/appSelectPeers.ts","webpack://tweb/./src/components/popups/pickUser.ts","webpack://tweb/./src/components/sidebarRight/tabs/userPermissions.ts","webpack://tweb/./src/components/sidebarRight/tabs/groupPermissions.ts","webpack://tweb/./src/lib/appManagers/utils/chats/combineParticipantBannedRights.ts","webpack://tweb/./src/components/popups/deleteDialog.ts","webpack://tweb/./src/components/sidebarRight/tabs/chatReactions.ts","webpack://tweb/./src/components/sidebarRight/tabs/editChat.ts","webpack://tweb/./src/components/wrappers/formatUserPhone.ts","webpack://tweb/./src/components/sidebarRight/tabs/editContact.ts","webpack://tweb/./src/components/sidebarLeft/tabs/addMembers.ts","webpack://tweb/./src/components/generateFakeIcon.ts","webpack://tweb/./src/components/generateTitleIcons.ts","webpack://tweb/./src/components/generateVerifiedIcon.ts","webpack://tweb/./src/lib/appManagers/utils/peers/getPeerColorById.ts","webpack://tweb/./src/lib/richTextProcessor/getAbbreviation.ts","webpack://tweb/./src/components/putPhoto.ts","webpack://tweb/./src/components/wrappers/getPeerInitials.ts","webpack://tweb/./src/helpers/contextMenuController.ts","webpack://tweb/./src/components/swipeHandler.ts","webpack://tweb/./src/components/peerProfileAvatars.ts","webpack://tweb/./src/components/wrappers/peerTitle.ts","webpack://tweb/./src/components/peerProfile.ts","webpack://tweb/./src/components/sidebarRight/tabs/sharedMedia.ts","webpack://tweb/./src/components/sidebarRight/index.ts","webpack://tweb/./src/components/sidebarRight/tabs/pollResults.ts","webpack://tweb/./src/components/stackedAvatars.ts","webpack://tweb/./src/components/poll.ts","webpack://tweb/./src/components/divAndCaption.ts","webpack://tweb/./src/helpers/dom/htmlToDocumentFragment.ts","webpack://tweb/./src/helpers/restrictions.ts","webpack://tweb/./src/helpers/string/escapeRegExp.ts","webpack://tweb/./src/lib/appManagers/utils/messages/isMessageRestricted.ts","webpack://tweb/./src/helpers/formatCallDuration.ts","webpack://tweb/./src/helpers/formatDuration.ts","webpack://tweb/./src/config/currencies.ts","webpack://tweb/./src/helpers/paymentsWrapCurrencyAmount.ts","webpack://tweb/./src/components/wrappers/joinVoiceChatAnchor.ts","webpack://tweb/./src/components/wrappers/messageActionTextNewUnsafe.ts","webpack://tweb/./src/components/wrappers/messageActionTextNew.ts","webpack://tweb/./src/components/wrappers/messageForReply.ts","webpack://tweb/./src/components/chat/replyContainer.ts","webpack://tweb/./src/components/wrappers/reply.ts","webpack://tweb/./src/components/wrappers/stickerSetThumb.ts","webpack://tweb/./src/components/wrappers/stickerToRow.ts","webpack://tweb/./src/helpers/dom/positionElementByIndex.ts","webpack://tweb/./src/helpers/sortedList.ts","webpack://tweb/./src/components/sortedUserList.ts","webpack://tweb/./src/helpers/dom/attachContextMenuListener.ts","webpack://tweb/./src/helpers/dom/handleHorizontalSwipe.ts","webpack://tweb/./src/helpers/dom/handleTabSwipe.ts","webpack://tweb/./src/components/buttonMenu.ts","webpack://tweb/./src/components/popups/forward.ts","webpack://tweb/./src/components/popups/deleteMessages.ts","webpack://tweb/./src/components/popups/sendNow.ts","webpack://tweb/./src/helpers/dom/cancelSelection.ts","webpack://tweb/./src/components/chat/selection.ts","webpack://tweb/./src/helpers/dom/getSelectedText.ts","webpack://tweb/./src/components/wrappers/webPageDescription.ts","webpack://tweb/./src/components/wrappers/webPageTitle.ts","webpack://tweb/./src/helpers/positionMenu.ts","webpack://tweb/./src/components/appSearchSuper..ts","webpack://tweb/./src/helpers/dom/lockTouchScroll.ts","webpack://tweb/./src/components/buttonMenuToggle.ts","webpack://tweb/./src/lib/appManagers/utils/privacy/getPrivacyRulesDetails.ts","webpack://tweb/./src/lib/appManagers/utils/privacy/privacyType.ts","webpack://tweb/./src/components/privacySection.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacy/phoneNumber.ts","webpack://tweb/./src/helpers/dom/anchorCopy.ts","webpack://tweb/./src/components/wrappers/stickerEmoji.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/passwordSet.ts","webpack://tweb/./src/helpers/dom/canFocus.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/emailConfirmation.ts","webpack://tweb/./src/lib/richTextProcessor/matchEmail.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/email.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/hint.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/reEnterPassword.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/enterPassword.ts","webpack://tweb/./src/components/sidebarLeft/tabs/2fa/index.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacy/lastSeen.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacy/profilePhoto.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacy/forwardMessages.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacy/addToGroups.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacy/calls.ts","webpack://tweb/./src/components/sidebarLeft/tabs/activeSessions.ts","webpack://tweb/./src/components/sidebarLeft/tabs/blockedUsers.ts","webpack://tweb/./src/helpers/string/convertKeyToInputKey.ts","webpack://tweb/./src/components/confirmationPopup.ts","webpack://tweb/./src/components/sidebarLeft/tabs/privacyAndSecurity.ts","webpack://tweb/./src/helpers/averageColor.ts","webpack://tweb/./src/helpers/highlightningColor.ts","webpack://tweb/./src/components/chat/gradientRenderer.ts","webpack://tweb/./src/components/colorPicker.ts","webpack://tweb/./src/components/sidebarLeft/tabs/backgroundColor.ts","webpack://tweb/./src/helpers/canvas/scaleMediaElement.ts","webpack://tweb/./src/components/sidebarLeft/tabs/background.ts","webpack://tweb/./src/helpers/files/requestFile.ts","webpack://tweb/./src/components/popups/stickers.ts","webpack://tweb/./src/components/sidebarLeft/tabs/quickReaction.ts","webpack://tweb/./src/components/sidebarLeft/tabs/generalSettings.ts","webpack://tweb/./src/helpers/eachMinute.ts","webpack://tweb/./src/helpers/eachTimeout.ts","webpack://tweb/./src/components/sidebarLeft/tabs/editProfile.ts","webpack://tweb/./src/components/sidebarLeft/tabs/includedChats.ts","webpack://tweb/./src/components/sidebarLeft/tabs/editFolder.ts","webpack://tweb/./src/components/sidebarLeft/tabs/chatFolders.ts","webpack://tweb/./src/components/sidebarLeft/tabs/notifications.ts","webpack://tweb/./src/components/sidebarLeft/tabs/language.ts","webpack://tweb/./src/components/sidebarLeft/tabs/autoDownload/photo.ts","webpack://tweb/./src/components/sidebarLeft/tabs/autoDownload/file.ts","webpack://tweb/./src/components/sidebarLeft/tabs/autoDownload/video.ts","webpack://tweb/./src/components/sidebarLeft/tabs/dataAndStorage.ts","webpack://tweb/./src/components/sidebarLeft/tabs/settings.ts","webpack://tweb/./src/components/sidebarLeft/tabs/newChannel.ts","webpack://tweb/./src/components/popups/createContact.ts","webpack://tweb/./src/components/sidebarLeft/tabs/contacts.ts","webpack://tweb/./src/components/sidebarLeft/tabs/archivedTab.ts","webpack://tweb/./src/components/sidebarLeft/tabs/peopleNearby.ts","webpack://tweb/./src/helpers/number/formatNumber.ts","webpack://tweb/./src/components/sidebarLeft/index.ts","webpack://tweb/./src/components/chat/bubbleGroups.ts","webpack://tweb/./src/helpers/array/partition.ts","webpack://tweb/./src/components/popups/datePicker.ts","webpack://tweb/./src/components/stickyIntersector.ts","webpack://tweb/./src/components/chat/reaction.ts","webpack://tweb/./src/components/chat/reactions.ts","webpack://tweb/./src/components/chat/replies.ts","webpack://tweb/./src/components/chat/messageRender.ts","webpack://tweb/./src/helpers/dom/getElementByPoint.ts","webpack://tweb/./src/helpers/dom/reflowScrollableElement.ts","webpack://tweb/./src/lib/mtproto/constants.ts","webpack://tweb/./src/helpers/dom/getVisibleRect.ts","webpack://tweb/./src/lib/appManagers/internalLink.ts","webpack://tweb/./src/components/popups/joinChatInvite.ts","webpack://tweb/./src/helpers/scrollSaver.ts","webpack://tweb/./src/helpers/dom/superIntersectionObserver.ts","webpack://tweb/./src/lib/appManagers/utils/messages/isMentionUnread.ts","webpack://tweb/./src/helpers/middlewarePromise.ts","webpack://tweb/./src/lib/richTextProcessor/getEmojiEntityFromEmoji.ts","webpack://tweb/./src/components/emoticonsDropdown/tabs/emoji.ts","webpack://tweb/./src/lib/richTextProcessor/wrapSingleEmoji.ts","webpack://tweb/./src/components/lazyLoadQueueRepeat2.ts","webpack://tweb/./src/components/gifsMasonry.ts","webpack://tweb/./src/components/emoticonsDropdown/tabs/gifs.ts","webpack://tweb/./src/components/lazyLoadQueueRepeat.ts","webpack://tweb/./src/components/emoticonsDropdown/tabs/stickers.ts","webpack://tweb/./src/components/sidebarRight/tabs/gifs.ts","webpack://tweb/./src/components/sidebarRight/tabs/stickers.ts","webpack://tweb/./src/helpers/dropdownHover.ts","webpack://tweb/./src/components/emoticonsDropdown/index.ts","webpack://tweb/./src/helpers/cacheCallback.ts","webpack://tweb/./src/helpers/string/replaceNonNumber.ts","webpack://tweb/./src/helpers/cards/cardBrands.ts","webpack://tweb/./src/helpers/array/createArray.ts","webpack://tweb/./src/helpers/string/buggedNumbers.ts","webpack://tweb/./src/helpers/cards/patternCharacters.ts","webpack://tweb/./src/helpers/cards/cardFormattingPatterns.ts","webpack://tweb/./src/helpers/cards/formatValueByPattern.ts","webpack://tweb/./src/helpers/cards/validateCard.ts","webpack://tweb/./src/helpers/string/nbsp.ts","webpack://tweb/./src/components/popups/paymentVerification.ts","webpack://tweb/./src/components/popups/paymentCard.ts","webpack://tweb/./src/helpers/cards/formatInputValueByPattern.ts","webpack://tweb/./src/components/popups/paymentCardConfirmation.ts","webpack://tweb/./src/components/popups/paymentShipping.ts","webpack://tweb/./src/components/popups/paymentShippingMethods.ts","webpack://tweb/./src/components/popups/payment.ts","webpack://tweb/./src/components/chat/bubbles.ts","webpack://tweb/./src/helpers/dom/copyFromElement.ts","webpack://tweb/./src/components/wrappers/groupedDocuments.ts","webpack://tweb/./src/components/wrappers/poll.ts","webpack://tweb/./src/helpers/dom/getViewportSlice.ts","webpack://tweb/./src/components/popups/unpinMessage.ts","webpack://tweb/./src/helpers/dom/isSelectionEmpty.ts","webpack://tweb/./src/helpers/preloadAnimatedEmojiSticker.ts","webpack://tweb/./src/components/popups/reportMessagesConfirm.ts","webpack://tweb/./src/components/popups/reportMessages.ts","webpack://tweb/./src/components/popups/sponsored.ts","webpack://tweb/./src/components/popups/reactedList.ts","webpack://tweb/./src/components/chat/reactionsMenu.ts","webpack://tweb/./src/components/chat/contextMenu.ts","webpack://tweb/./src/components/chat/sendContextMenu.ts","webpack://tweb/./src/components/popups/createPoll.ts","webpack://tweb/./src/helpers/createPoster.ts","webpack://tweb/./src/helpers/getGifDuration.ts","webpack://tweb/./src/components/popups/newMedia.ts","webpack://tweb/./src/helpers/dom/attachListNavigation.ts","webpack://tweb/./src/components/chat/autocompleteHelper.ts","webpack://tweb/./src/components/chat/stickersHelper.ts","webpack://tweb/./src/components/popups/schedule.ts","webpack://tweb/./src/helpers/dom/getRichValueWithCaret.ts","webpack://tweb/./src/components/chat/emojiHelper.ts","webpack://tweb/./src/components/chat/autocompletePeerHelper.ts","webpack://tweb/./src/components/chat/commandsHelper.ts","webpack://tweb/./src/components/chat/autocompleteHelperController.ts","webpack://tweb/./src/components/chat/mentionsHelper.ts","webpack://tweb/./src/components/chat/replyKeyboard.ts","webpack://tweb/./src/components/chat/inlineHelper.ts","webpack://tweb/./src/components/chat/botCommands.ts","webpack://tweb/./src/helpers/modifyAckedResult.ts","webpack://tweb/./src/components/chat/sendAs.ts","webpack://tweb/./src/components/inputFieldAnimated.ts","webpack://tweb/./src/components/chat/input.ts","webpack://tweb/./src/components/wrappers/draft.ts","webpack://tweb/./src/helpers/dom/setCaretAt.ts","webpack://tweb/./src/components/chat/pinnedContainer.ts","webpack://tweb/./src/components/volumeSelector.ts","webpack://tweb/./src/components/chat/audio.ts","webpack://tweb/./src/components/chat/pinnedMessageBorder.ts","webpack://tweb/./src/components/chat/pinnedMessage.ts","webpack://tweb/./src/helpers/dom/handleScrollSideEvent.ts","webpack://tweb/./src/components/popups/mute.ts","webpack://tweb/./src/helpers/audioAssetPlayer.ts","webpack://tweb/./src/components/groupCall/getAudioAsset.ts","webpack://tweb/./src/lib/calls/helpers/getAudioConstraints.ts","webpack://tweb/./src/environment/constraintSupport.ts","webpack://tweb/./src/lib/calls/helpers/getScreenConstraints.ts","webpack://tweb/./src/lib/calls/helpers/getScreenStream.ts","webpack://tweb/./src/lib/calls/helpers/getStream.ts","webpack://tweb/./src/lib/calls/helpers/getStreamCached.ts","webpack://tweb/./src/lib/calls/helpers/stopTrack.ts","webpack://tweb/./src/lib/calls/stringFromLineBuilder.ts","webpack://tweb/./src/lib/calls/utils.ts","webpack://tweb/./src/lib/calls/sdpBuilder.ts","webpack://tweb/./src/lib/calls/streamManager.ts","webpack://tweb/./src/lib/calls/constants.ts","webpack://tweb/./src/lib/calls/callInstanceBase.ts","webpack://tweb/./src/lib/calls/helpers/getVideoConstraints.ts","webpack://tweb/./src/lib/calls/localConferenceDescription.ts","webpack://tweb/./src/lib/calls/callConnectionInstanceBase.ts","webpack://tweb/./src/lib/calls/helpers/createPeerConnection.ts","webpack://tweb/./src/lib/calls/helpers/createDataChannel.ts","webpack://tweb/./src/lib/calls/sdp/index.ts","webpack://tweb/./src/helpers/string/splitStringByLimitWithRest.ts","webpack://tweb/./src/helpers/uniqueNumberGenerator.ts","webpack://tweb/./src/lib/calls/sdp/attributeSplitted.ts","webpack://tweb/./src/lib/calls/sdp/mediaLineParts.ts","webpack://tweb/./src/lib/calls/sdp/line.ts","webpack://tweb/./src/lib/calls/sdp/attributeInner.ts","webpack://tweb/./src/lib/calls/sdp/attributes.ts","webpack://tweb/./src/lib/calls/sdp/mediaSection.ts","webpack://tweb/./src/lib/calls/sdp/sessionSection.ts","webpack://tweb/./src/lib/calls/sdp/utils.ts","webpack://tweb/./src/lib/calls/helpers/parseMediaSectionInfo.ts","webpack://tweb/./src/lib/calls/helpers/parseSourceGroups.ts","webpack://tweb/./src/lib/calls/groupCallState.ts","webpack://tweb/./src/lib/calls/groupCallConnectionInstance.ts","webpack://tweb/./src/lib/calls/helpers/processMediaSection.ts","webpack://tweb/./src/lib/calls/helpers/filterServerCodecs.ts","webpack://tweb/./src/lib/calls/helpers/fixLocalOffer.ts","webpack://tweb/./src/lib/calls/groupCallInstance.ts","webpack://tweb/./src/lib/calls/groupCallsController.ts","webpack://tweb/./src/lib/calls/helpers/createMainStreamManager.ts","webpack://tweb/./src/components/chat/topbar.ts","webpack://tweb/./src/components/sidebarRight/tabs/search.ts","webpack://tweb/./src/components/chat/search.ts","webpack://tweb/./src/components/chat/patternRenderer.ts","webpack://tweb/./src/components/chat/chat.ts","webpack://tweb/./src/helpers/autoDownload.ts","webpack://tweb/./src/components/chat/markupTooltip.ts","webpack://tweb/./src/helpers/dom/getSelectedNodes.ts","webpack://tweb/./src/helpers/generatePathData.ts","webpack://tweb/./src/components/chat/dragAndDrop.ts","webpack://tweb/./src/helpers/dom/disableTransition.ts","webpack://tweb/./src/components/lineBlobDrawable.ts","webpack://tweb/./src/components/topbarWeave.ts","webpack://tweb/./src/helpers/dom/customProperties.ts","webpack://tweb/./src/lib/rlottie/rlottieIcon.ts","webpack://tweb/./src/components/superIcon.ts","webpack://tweb/./src/components/groupCall/microphoneIcon.ts","webpack://tweb/./src/components/groupCall/participantMutedIcon.ts","webpack://tweb/./src/components/groupCall/index.ts","webpack://tweb/./src/components/groupCall/participantStatus.ts","webpack://tweb/./src/components/groupCall/participantsList.ts","webpack://tweb/./src/helpers/dom/controlsHover.ts","webpack://tweb/./src/components/call/videoCanvasBlur.ts","webpack://tweb/./src/components/groupCall/participantVideo.ts","webpack://tweb/./src/components/groupCall/participantVideos.ts","webpack://tweb/./src/components/groupCall/participants.ts","webpack://tweb/./src/components/groupCall/description.ts","webpack://tweb/./src/components/groupCall/title.ts","webpack://tweb/./src/components/call/button.ts","webpack://tweb/./src/components/movableElement.ts","webpack://tweb/./src/helpers/movablePanel.ts","webpack://tweb/./src/helpers/toggleClassName.ts","webpack://tweb/./src/lib/calls/callState.ts","webpack://tweb/./src/components/call/description.ts","webpack://tweb/./src/components/groupCall/microphoneIconMini.ts","webpack://tweb/./src/components/call/index.ts","webpack://tweb/./src/lib/calls/helpers/parseSignalingData.ts","webpack://tweb/./src/lib/calls/callConnectionInstance.ts","webpack://tweb/./src/components/call/getAudioAsset.ts","webpack://tweb/./src/lib/calls/callsController.ts","webpack://tweb/./src/lib/crypto/subtle.ts","webpack://tweb/./src/lib/calls/p2P/p2PEncryptor.ts","webpack://tweb/./src/lib/crypto/utils/sha256.ts","webpack://tweb/./src/lib/calls/p2P/chromeP2PSdpBuilder.ts","webpack://tweb/./src/lib/calls/p2P/p2PSdpBuilder.js","webpack://tweb/./src/lib/calls/p2P/firefoxP2PSdpBuilder.js","webpack://tweb/./src/lib/calls/p2P/safariP2PSdpBuilder.js","webpack://tweb/./src/lib/calls/callInstance.ts","webpack://tweb/./src/lib/calls/p2P/getCallProtocol.ts","webpack://tweb/./src/lib/calls/p2P/getRtcConfiguration.ts","webpack://tweb/./src/components/topbarCall.ts","webpack://tweb/./src/lib/appManagers/uiNotificationsManager.ts","webpack://tweb/./src/helpers/files/getFilesFromEvent.ts","webpack://tweb/./src/lib/appManagers/appImManager.ts","webpack://tweb/./src/lib/mediaPlayer.ts","webpack://tweb/./src/components/appMediaViewerBase.ts","webpack://tweb/./src/helpers/fillPropertyValue.ts","webpack://tweb/./src/components/appMediaViewer.ts","webpack://tweb/./src/helpers/avatarListLoader.ts","webpack://tweb/./src/components/appMediaViewerAvatar.ts","webpack://tweb/./src/components/avatar.ts","webpack://tweb/./src/components/dialogsContextMenu.ts","webpack://tweb/./src/components/sendingStatus.ts","webpack://tweb/./src/components/connectionStatus.ts","webpack://tweb/./src/helpers/easing/easeInOutSine.ts","webpack://tweb/./src/helpers/canvas/roundRect.ts","webpack://tweb/./src/components/groupCallActiveIcon.ts","webpack://tweb/./src/helpers/canvas/shimmer.ts","webpack://tweb/./src/helpers/dialogsPlaceholder.ts","webpack://tweb/./src/helpers/canvas/drawCircle.ts","webpack://tweb/./src/lib/appManagers/appDialogsManager.ts","webpack://tweb/./public/recorder.min.js"],"sourcesContent":["/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\nimport ripple from \"./ripple\";\r\n\r\nexport type ButtonOptions = Partial<{\r\n  noRipple: true, \r\n  onlyMobile: true, \r\n  icon: string, \r\n  rippleSquare: true, \r\n  text: LangPackKey, \r\n  disabled: boolean,\r\n  asDiv: boolean\r\n}>;\r\n\r\nconst Button = (className: string, options: ButtonOptions = {}) => {\r\n  const button: HTMLButtonElement = document.createElement(options.asDiv ? 'div' : 'button') as any;\r\n  button.className = className + (options.icon ? ' tgico-' + options.icon : '');\r\n\r\n  if(!options.noRipple) {\r\n    if(options.rippleSquare) {\r\n      button.classList.add('rp-square');\r\n    }\r\n\r\n    ripple(button);\r\n  }\r\n\r\n  if(options.onlyMobile) {\r\n    button.classList.add('only-handhelds');\r\n  }\r\n\r\n  if(options.disabled) {\r\n    button.setAttribute('disabled', 'true');\r\n  }\r\n\r\n  if(options.text) {\r\n    button.append(i18n(options.text));\r\n  }\r\n\r\n  return button;\r\n};\r\n\r\nexport default Button;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport InputField, { InputFieldOptions } from \"./inputField\";\r\n\r\nexport default class CodeInputField extends InputField {\r\n  constructor(options: InputFieldOptions & {\r\n    length: number,\r\n    onFill: (code: string) => void\r\n  }) {\r\n    super({\r\n      plainText: true,\r\n      ...options\r\n    });\r\n\r\n    const input = this.input as HTMLInputElement;\r\n    input.type = 'tel';\r\n    input.setAttribute('required', '');\r\n    input.autocomplete = 'off';\r\n\r\n    let lastLength = 0;\r\n    this.input.addEventListener('input', (e) => {\r\n      this.input.classList.remove('error');\r\n      this.setLabel();\r\n  \r\n      const value = this.value.replace(/\\D/g, '').slice(0, options.length);\r\n      this.setValueSilently(value);\r\n  \r\n      const length = this.value.length;\r\n      if(length === options.length) { // submit code\r\n        options.onFill(this.value);\r\n      } else if(length === lastLength) {\r\n        return;\r\n      }\r\n  \r\n      lastLength = length;\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport lottieLoader, { LottieLoader } from \"../../lib/rlottie/lottieLoader\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\nimport PasswordInputField from \"../passwordInputField\";\r\n\r\nexport default class PasswordMonkey {\r\n  public container: HTMLElement;\r\n  public animation: RLottiePlayer;\r\n  public needFrame = 0;\r\n  protected loadPromise: ReturnType<LottieLoader['waitForFirstFrame']>;\r\n\r\n  constructor(protected passwordInputField: PasswordInputField, protected size: number) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('media-sticker-wrapper');\r\n  }\r\n\r\n  public load() {\r\n    if(this.loadPromise) return this.loadPromise;\r\n    return this.loadPromise = lottieLoader.loadAnimationAsAsset({\r\n      container: this.container,\r\n      loop: false,\r\n      autoplay: false,\r\n      width: this.size,\r\n      height: this.size,\r\n      noCache: true\r\n    //}, 'assets/img/TwoFactorSetupMonkeyClose.tgs').then((_animation) => {\r\n    }, 'TwoFactorSetupMonkeyPeek').then((_animation) => {\r\n      //return;\r\n      this.animation = _animation;\r\n      this.animation.addEventListener('enterFrame', currentFrame => {\r\n        //console.log('enterFrame', currentFrame, this.needFrame);\r\n\r\n        if((this.animation.direction === 1 && currentFrame >= this.needFrame) ||\r\n          (this.animation.direction === -1 && currentFrame <= this.needFrame)) {\r\n            this.animation.setSpeed(1);\r\n            this.animation.pause();\r\n        } \r\n      });\r\n\r\n      this.passwordInputField.onVisibilityClickAdditional = () => {\r\n        if(this.passwordInputField.passwordVisible) {\r\n          this.animation.setDirection(1);\r\n          this.animation.curFrame = 0;\r\n          this.needFrame = 16;\r\n          this.animation.play();\r\n        } else {\r\n          this.animation.setDirection(-1);\r\n          this.animation.curFrame = 16;\r\n          this.needFrame = 0;\r\n          this.animation.play();\r\n        }\r\n      };\r\n\r\n      return lottieLoader.waitForFirstFrame(_animation);\r\n    });\r\n  }\r\n\r\n  public remove() {\r\n    if(this.animation) {\r\n      this.animation.remove();\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport InputField from \"../inputField\";\r\nimport lottieLoader from \"../../lib/rlottie/lottieLoader\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\n\r\nexport default class TrackingMonkey {\r\n  public container: HTMLElement;\r\n\r\n  protected max = 45;\r\n  protected needFrame = 0;\r\n\r\n  protected animation: RLottiePlayer;\r\n  protected idleAnimation: RLottiePlayer;\r\n\r\n  protected loadPromise: Promise<any>;\r\n\r\n  constructor(protected inputField: InputField, protected size: number) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('media-sticker-wrapper');\r\n\r\n    const input = inputField.input;\r\n\r\n    input.addEventListener('blur', () => {\r\n      this.playAnimation(0);\r\n    });\r\n\r\n    input.addEventListener('input', (e) => {\r\n      this.playAnimation(inputField.value.length);\r\n    });\r\n\r\n    /* codeInput.addEventListener('focus', () => {\r\n      playAnimation(Math.max(codeInput.value.length, 1));\r\n    }); */\r\n  }\r\n\r\n  // 1st symbol = frame 15\r\n  // end symbol = frame 165\r\n  public playAnimation(length: number) {\r\n    if(!this.animation) return;\r\n\r\n    length = Math.min(length, 30);\r\n    let frame: number;\r\n    if(length) {\r\n      frame = Math.round(Math.min(this.max, length) * (165 / this.max) + 11.33);\r\n\r\n      if(this.idleAnimation) {\r\n        this.idleAnimation.stop(true);\r\n        this.idleAnimation.canvas.style.display = 'none';\r\n      }\r\n      \r\n      this.animation.canvas.style.display = '';\r\n    } else {\r\n      /* const cb = (frameNo: number) => {\r\n        if(frameNo <= 1) { */\r\n          /* idleAnimation.play();\r\n          idleAnimation.canvas.style.display = '';\r\n          animation.canvas.style.display = 'none'; */\r\n      /*     animation.removeListener('enterFrame', cb);\r\n        }\r\n      };\r\n      animation.addListener('enterFrame', cb); */\r\n      \r\n      frame = 0;\r\n    }\r\n    //animation.playSegments([1, 2]);\r\n\r\n    const direction = this.needFrame > frame ? -1 : 1;\r\n    //console.log('keydown', length, frame, direction);\r\n\r\n    this.animation.setDirection(direction);\r\n    if(this.needFrame !== 0 && frame === 0) {\r\n      this.animation.setSpeed(7);\r\n    }\r\n    /* let diff = Math.abs(needFrame - frame * direction);\r\n    if((diff / 20) > 1) animation.setSpeed(diff / 20 | 0); */\r\n    this.needFrame = frame;\r\n    \r\n    this.animation.play();\r\n\r\n    /* animation.goToAndStop(15, true); */\r\n    //animation.goToAndStop(length / max * );\r\n  }\r\n\r\n  public load() {\r\n    if(this.loadPromise) return this.loadPromise;\r\n    return this.loadPromise = Promise.all([\r\n      lottieLoader.loadAnimationAsAsset({\r\n        container: this.container,\r\n        loop: true,\r\n        autoplay: true,\r\n        width: this.size,\r\n        height: this.size\r\n      }, 'TwoFactorSetupMonkeyIdle').then((animation) => {\r\n        this.idleAnimation = animation;\r\n\r\n        // ! animationIntersector will stop animation instantly\r\n        if(!this.inputField.value.length) {\r\n          animation.play();\r\n        }\r\n\r\n        return lottieLoader.waitForFirstFrame(animation);\r\n      }),\r\n\r\n      lottieLoader.loadAnimationAsAsset({\r\n        container: this.container,\r\n        loop: false,\r\n        autoplay: false,\r\n        width: this.size,\r\n        height: this.size\r\n      }, 'TwoFactorSetupMonkeyTracking').then((_animation) => {\r\n        this.animation = _animation;\r\n\r\n        if(!this.inputField.value.length) {\r\n          this.animation.canvas.style.display = 'none';\r\n        }\r\n\r\n        this.animation.addEventListener('enterFrame', currentFrame => {\r\n          //console.log('enterFrame', currentFrame, needFrame);\r\n          //let currentFrame = Math.round(e.currentTime);\r\n          \r\n          if((this.animation.direction === 1 && currentFrame >= this.needFrame) ||\r\n            (this.animation.direction === -1 && currentFrame <= this.needFrame)) {\r\n            this.animation.setSpeed(1);\r\n            this.animation.pause();\r\n          }\r\n\r\n          if(currentFrame === 0 && this.needFrame === 0) {\r\n            //animation.curFrame = 0;\r\n            \r\n            if(this.idleAnimation) {\r\n              this.idleAnimation.canvas.style.display = '';\r\n              this.idleAnimation.play();\r\n              this.animation.canvas.style.display = 'none';\r\n            }\r\n          }\r\n        });\r\n        //console.log(animation.getDuration(), animation.getDuration(true));\r\n\r\n        return lottieLoader.waitForFirstFrame(_animation);\r\n      })\r\n    ]);\r\n  }\r\n\r\n  public remove() {\r\n    if(this.animation) this.animation.remove();\r\n    if(this.idleAnimation) this.idleAnimation.remove();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// import { IS_MOBILE_SAFARI, IS_SAFARI } from \"../environment/userAgent\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport InputField, { InputFieldOptions } from \"./inputField\";\r\n\r\nexport default class PasswordInputField extends InputField {\r\n  public passwordVisible = false;\r\n  public toggleVisible: HTMLElement;\r\n  public onVisibilityClickAdditional: () => void;\r\n\r\n  constructor(options: InputFieldOptions = {}) {\r\n    super({\r\n      plainText: true,\r\n      ...options\r\n    });\r\n\r\n    const input = this.input as HTMLInputElement;\r\n    input.type = 'password';\r\n    input.setAttribute('required', '');\r\n    input.name = 'notsearch_password';\r\n    input.autocomplete = 'off';\r\n\r\n    /* if(IS_SAFARI && !IS_MOBILE_SAFARI) {\r\n      input.setAttribute('readonly', '');\r\n      input.addEventListener('focus', () => {\r\n        input.removeAttribute('readonly');\r\n      }, {once: true});\r\n    } */\r\n\r\n    // * https://stackoverflow.com/a/35949954/6758968\r\n    const stealthy = document.createElement('input');\r\n    stealthy.classList.add('stealthy');\r\n    stealthy.tabIndex = -1;\r\n    stealthy.type = 'password';\r\n    input.parentElement.prepend(stealthy);\r\n    input.parentElement.insertBefore(stealthy.cloneNode(), input.nextSibling);\r\n\r\n    const toggleVisible = this.toggleVisible = document.createElement('span');\r\n    toggleVisible.classList.add('toggle-visible', 'tgico');\r\n\r\n    this.container.classList.add('input-field-password');\r\n    this.container.append(toggleVisible);\r\n\r\n    toggleVisible.addEventListener('click', this.onVisibilityClick);\r\n    toggleVisible.addEventListener('touchend', this.onVisibilityClick);\r\n  }\r\n\r\n  public onVisibilityClick = (e: Event) => {\r\n    cancelEvent(e);\r\n    this.passwordVisible = !this.passwordVisible;\r\n\r\n    this.toggleVisible.classList.toggle('eye-hidden', this.passwordVisible);\r\n    (this.input as HTMLInputElement).type = this.passwordVisible ? 'text' : 'password';\r\n    this.onVisibilityClickAdditional && this.onVisibilityClickAdditional();\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\n\r\nexport function putPreloader(elem: Element, returnDiv = false): HTMLElement {\r\n  const html = `\r\n  <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"preloader-circular\" viewBox=\"25 25 50 50\">\r\n  <circle class=\"preloader-path\" cx=\"50\" cy=\"50\" r=\"20\" fill=\"none\" stroke-miterlimit=\"10\"/>\r\n  </svg>`;\r\n\r\n  if(returnDiv) {\r\n    const div = document.createElement('div');\r\n    div.classList.add('preloader');\r\n    div.innerHTML = html;\r\n\r\n    if(elem) {\r\n      elem.appendChild(div);\r\n    }\r\n\r\n    return div;\r\n  }\r\n  \r\n  elem.insertAdjacentHTML('beforeend', html);\r\n  return elem.lastElementChild as HTMLElement;\r\n}\r\n\r\nMOUNT_CLASS_TO.putPreloader = putPreloader;\r\n\r\nexport function setButtonLoader(elem: HTMLButtonElement, icon = 'check') {\r\n  elem.classList.remove('tgico-' + icon);\r\n  elem.disabled = true;\r\n  putPreloader(elem);\r\n\r\n  return () => {\r\n    elem.innerHTML = '';\r\n    elem.classList.add('tgico-' + icon);\r\n    elem.removeAttribute('disabled');\r\n  };\r\n}\r\n\r\n/* export function parseMenuButtonsTo(to: {[name: string]: HTMLElement}, elements: HTMLCollection | NodeListOf<HTMLElement>) {\r\n  Array.from(elements).forEach((el) => {\r\n    const match = el.className.match(/(?:^|\\s)menu-(.+?)(?:$|\\s)/);\r\n    if(!match) return;\r\n    to[match[1]] = el as HTMLElement;\r\n  });\r\n} */\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport sequentialDom from \"../helpers/sequentialDom\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport findUpAsChild from \"../helpers/dom/findUpAsChild\";\r\n\r\nlet rippleClickId = 0;\r\nexport default function ripple(\r\n  elem: HTMLElement, \r\n  callback: (id: number) => Promise<boolean | void> = () => Promise.resolve(), \r\n  onEnd: (id: number) => void = null, \r\n  prepend = false,\r\n  attachListenerTo = elem\r\n) {\r\n  //return;\r\n  if(elem.querySelector('.c-ripple')) return;\r\n  elem.classList.add('rp');\r\n  \r\n  let r = document.createElement('div');\r\n  r.classList.add('c-ripple');\r\n\r\n  const isSquare = elem.classList.contains('rp-square');\r\n  if(isSquare) {\r\n    r.classList.add('is-square');\r\n  }\r\n\r\n  elem[prepend ? 'prepend' : 'append'](r);\r\n\r\n  let handler: () => void;\r\n  //let animationEndPromise: Promise<number>;\r\n  const drawRipple = (clientX: number, clientY: number) => {\r\n    const startTime = Date.now();\r\n    const elem = document.createElement('div');\r\n\r\n    const clickId = rippleClickId++;\r\n    \r\n    //console.log('ripple drawRipple');\r\n    \r\n    const duration = +window.getComputedStyle(r).getPropertyValue('--ripple-duration').replace('s', '') * 1000;\r\n    //console.log('ripple duration', duration);\r\n\r\n    handler = () => {\r\n    //handler = () => animationEndPromise.then((duration) => {\r\n      //console.log('ripple animation was:', duration);\r\n\r\n      //const duration = isSquare || mediaSizes.isMobile ? 200 : 700;\r\n      //return;\r\n      let elapsedTime = Date.now() - startTime;\r\n      const cb = () => {\r\n        //console.log('ripple elapsedTime total pre-remove:', Date.now() - startTime);\r\n        sequentialDom.mutate(() => {\r\n          elem.remove();\r\n        });\r\n        \r\n        if(onEnd) onEnd(clickId);\r\n      };\r\n      if(elapsedTime < duration) {\r\n        let delay = Math.max(duration - elapsedTime, duration / 2);\r\n        setTimeout(() => elem.classList.add('hiding'), Math.max(delay - duration / 2, 0));\r\n\r\n        setTimeout(cb, delay);\r\n      } else {\r\n        elem.classList.add('hiding');\r\n        setTimeout(cb, duration / 2);\r\n      }\r\n\r\n      if(!IS_TOUCH_SUPPORTED) {\r\n        window.removeEventListener('contextmenu', handler);\r\n      }\r\n\r\n      handler = null;\r\n      touchStartFired = false;\r\n    };\r\n    //});\r\n\r\n    callback && callback(clickId);\r\n\r\n    /* callback().then((bad) => {\r\n      if(bad) {\r\n        span.remove();\r\n        return;\r\n      } */\r\n      \r\n      //console.log('ripple after promise', Date.now() - startTime);\r\n      //console.log('ripple tooSlow:', tooSlow);\r\n      /* if(tooSlow) {\r\n        span.remove();\r\n        return;\r\n      } */\r\n\r\n      window.requestAnimationFrame(() => {\r\n        const rect = r.getBoundingClientRect();\r\n        elem.classList.add('c-ripple__circle');\r\n\r\n        const clickX = clientX - rect.left;\r\n        const clickY = clientY - rect.top;\r\n\r\n        const radius = Math.sqrt((Math.abs(clickY - rect.height / 2) + rect.height / 2) ** 2 + (Math.abs(clickX - rect.width / 2) + rect.width / 2) ** 2);\r\n        const size = radius;\r\n\r\n        // center of circle\r\n        const x = clickX - size / 2;\r\n        const y = clickY - size / 2;\r\n\r\n        //console.log('ripple click', offsetFromCenter, size, clickX, clickY);\r\n\r\n        elem.style.width = elem.style.height = size + 'px';\r\n        elem.style.left = x + 'px';\r\n        elem.style.top = y + 'px';\r\n\r\n        //     \r\n        /* animationEndPromise = new Promise((resolve) => {\r\n          span.addEventListener('animationend', () => {\r\n            // 713 -> 700\r\n            resolve(((Date.now() - startTime) / 100 | 0) * 100);\r\n          }, {once: true});\r\n        }); */\r\n        \r\n        //             \r\n        /* span.style.display = 'none';\r\n        r.append(span);\r\n        duration = +window.getComputedStyle(span).getPropertyValue('animation-duration').replace('s', '') * 1000;\r\n        span.style.display = ''; */\r\n\r\n        r.append(elem);\r\n\r\n        //r.classList.add('active');\r\n        //handler();\r\n      });\r\n    //});\r\n  };\r\n\r\n  const isRippleUnneeded = (e: Event) => e.target !== elem && (\r\n      ['BUTTON', 'A'].includes((e.target as HTMLElement).tagName) \r\n      || findUpClassName(e.target as HTMLElement, 'c-ripple') !== r\r\n    ) && (\r\n      attachListenerTo === elem \r\n      || !findUpAsChild(e.target, attachListenerTo)\r\n    );\r\n\r\n  // TODO: rename this variable\r\n  let touchStartFired = false;\r\n  if(IS_TOUCH_SUPPORTED) {\r\n    let touchEnd = () => {\r\n      handler && handler();\r\n    };\r\n  \r\n    attachListenerTo.addEventListener('touchstart', (e) => {\r\n      if(!rootScope.settings.animationsEnabled) {\r\n        return;\r\n      }\r\n\r\n      //console.log('ripple touchstart', e);\r\n      if(e.touches.length > 1 || touchStartFired || isRippleUnneeded(e)) {\r\n        return;\r\n      }\r\n      \r\n      //console.log('touchstart', e);\r\n      touchStartFired = true;\r\n  \r\n      let {clientX, clientY} = e.touches[0];\r\n      drawRipple(clientX, clientY);\r\n      attachListenerTo.addEventListener('touchend', touchEnd, {once: true});\r\n  \r\n      window.addEventListener('touchmove', (e) => {\r\n        e.cancelBubble = true;\r\n        e.stopPropagation();\r\n        touchEnd();\r\n        attachListenerTo.removeEventListener('touchend', touchEnd);\r\n      }, {once: true});\r\n    }, {passive: true});\r\n  } else {\r\n    attachListenerTo.addEventListener('mousedown', (e) => {\r\n      if(![0, 2].includes(e.button)) { // only left and right buttons\r\n        return;\r\n      }\r\n\r\n      if(!rootScope.settings.animationsEnabled) {\r\n        return;\r\n      }\r\n      //console.log('ripple mousedown', e, e.target, findUpClassName(e.target as HTMLElement, 'c-ripple') === r);\r\n\r\n      if(attachListenerTo.dataset.ripple === '0' || isRippleUnneeded(e)) {\r\n        return;\r\n      } else if(touchStartFired) {\r\n        touchStartFired = false;\r\n        return;\r\n      }\r\n  \r\n      let {clientX, clientY} = e;\r\n      drawRipple(clientX, clientY);\r\n      window.addEventListener('mouseup', handler, {once: true, passive: true});\r\n      window.addEventListener('contextmenu', handler, {once: true, passive: true});\r\n    }, {passive: true});\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport LatinizeMap from \"../config/latinizeMap\";\r\n\r\nexport const badCharsRe = /[`~!@#$%^&*()\\-_=+\\[\\]\\\\|{}'\";:\\/?.>,<]+/g;\r\nconst trimRe = /^\\s+|\\s$/g;\r\n\r\nconst C2L: {[k: string]: string} = {\r\n  : 'q',\r\n  : 'w',\r\n  : 'e',\r\n  : 'r',\r\n  : 't',\r\n  : 'y',\r\n  : 'u',\r\n  : 'i',\r\n  : 'o',\r\n  : 'p',\r\n  : '[',\r\n  : ']',\r\n  : 'a',\r\n  : 's',\r\n  : 'd',\r\n  : 'f',\r\n  : 'g',\r\n  : 'h',\r\n  : 'j',\r\n  : 'k',\r\n  : 'l',\r\n  : ';',\r\n  : '\\'',\r\n  : 'z',\r\n  : 'x',\r\n  : 'c',\r\n  : 'v',\r\n  : 'b',\r\n  : 'n',\r\n  : 'm',\r\n  : ',',\r\n  : '.',\r\n  '.': '/'\r\n};\r\n\r\nexport function clearBadCharsAndTrim(text: string) {\r\n  return text.replace(badCharsRe, '').replace(trimRe, '');\r\n}\r\n\r\nexport function fixCyrillic(text: string) {\r\n  return text.toLowerCase().replace(/[\\w-]/g, (ch) => {\r\n    const latinizeCh = C2L[ch];\r\n    return latinizeCh ?? ch;\r\n  });\r\n}\r\n\r\nexport function latinizeString(text: string) {\r\n  return text.replace(/[^A-Za-z0-9]/g, (ch) => {\r\n    const latinizeCh = LatinizeMap[ch];\r\n    return latinizeCh ?? ch;\r\n  });\r\n}\r\n\r\nexport default function cleanSearchText(text: string, latinize = true) {\r\n  return processSearchText(text, {\r\n    clearBadChars: true,\r\n    latinize,\r\n    ignoreCase: true\r\n  });\r\n}\r\n\r\nexport type ProcessSearchTextOptions = Partial<{\r\n  clearBadChars: boolean,\r\n  latinize: boolean,\r\n  ignoreCase: boolean,\r\n  includeTag: boolean\r\n}>;\r\n\r\nexport function processSearchText(text: string, options: ProcessSearchTextOptions = {}) {\r\n  const hasTag = options.includeTag && text.charAt(0) === '%';\r\n  const originalText = text;\r\n  if(options.clearBadChars) text = clearBadCharsAndTrim(text);\r\n  if(options.latinize) text = latinizeString(text);\r\n  if(options.ignoreCase) text = text.toLowerCase();\r\n  if(hasTag) text = '%' + text;\r\n  if(options.latinize) text += '\\x01' + fixCyrillic(originalText);\r\n  return text;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function htmlToSpan(html: string | DocumentFragment) {\r\n  const span = document.createElement('span');\r\n  if(typeof(html) === 'string') span.innerHTML = html;\r\n  else span.append(html);\r\n  return span;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { fastRaf } from \"./schedulers\";\r\nimport deferredPromise, { CancellablePromise } from \"./cancellablePromise\";\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport isInDOM from \"./dom/isInDOM\";\r\n\r\nclass SequentialDom {\r\n  private promises: Partial<{\r\n    read: CancellablePromise<void>,\r\n    write: CancellablePromise<void>\r\n  }> = {};\r\n  private raf = fastRaf.bind(null);\r\n  private scheduled = false;\r\n\r\n  private do(kind: keyof SequentialDom['promises'], callback?: VoidFunction) {\r\n    let promise = this.promises[kind];\r\n    if(!promise) {\r\n      this.scheduleFlush();\r\n      promise = this.promises[kind] = deferredPromise<void>();\r\n    }\r\n\r\n    if(callback !== undefined) {\r\n      promise.then(() => callback());\r\n    }\r\n    \r\n    return promise;\r\n  }\r\n\r\n  public measure(callback?: VoidFunction) {\r\n    return this.do('read', callback);\r\n  }\r\n\r\n  public mutate(callback?: VoidFunction) {\r\n    return this.do('write', callback);\r\n  }\r\n\r\n  /**\r\n   * Will fire instantly if element is not connected\r\n   * @param element \r\n   * @param callback \r\n   */\r\n  public mutateElement(element: HTMLElement, callback?: VoidFunction) {\r\n    const isConnected = isInDOM(element);\r\n    const promise = isConnected ? this.mutate() : Promise.resolve();\r\n\r\n    if(callback !== undefined) {\r\n      if(isConnected) {\r\n        callback();\r\n      } else {\r\n        promise.then(() => callback());\r\n      }\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  private scheduleFlush() {\r\n    if(!this.scheduled) {\r\n      this.scheduled = true;\r\n\r\n      this.raf(() => {\r\n        this.promises.read && this.promises.read.resolve();\r\n        this.promises.write && this.promises.write.resolve();\r\n\r\n        this.scheduled = false;\r\n        this.promises = {};\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\nconst sequentialDom = new SequentialDom();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.sequentialDom = sequentialDom);\r\nexport default sequentialDom;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDialogsManager from \"../lib/appManagers/appDialogsManager\";\r\nimport Scrollable from \"./scrollable\";\r\nimport InputSearch from \"./inputSearch\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\nimport rootScope from \"../lib/rootScope\";\r\n\r\nexport class SearchGroup {\r\n  container: HTMLDivElement;\r\n  nameEl: HTMLDivElement;\r\n  list: HTMLUListElement;\r\n\r\n  constructor(\r\n    public name: LangPackKey | boolean, \r\n    public type: string, \r\n    private clearable = true, \r\n    className?: string, \r\n    clickable = true, \r\n    public autonomous = true, \r\n    public onFound?: () => void\r\n  ) {\r\n    this.list = appDialogsManager.createChatList();\r\n    this.container = document.createElement('div');\r\n    if(className) this.container.className = className;\r\n    \r\n    if(name) {\r\n      this.nameEl = document.createElement('div');\r\n      this.nameEl.classList.add('search-group__name');\r\n      if(typeof(name) === 'string') {\r\n        this.nameEl.append(i18n(name));\r\n      }\r\n      this.container.append(this.nameEl);\r\n    }\r\n    \r\n    this.container.classList.add('search-group', 'search-group-' + type);\r\n    this.container.append(this.list);\r\n    this.container.style.display = 'none';\r\n\r\n    if(clickable) {\r\n      appDialogsManager.setListClickListener(this.list, onFound, undefined, autonomous);\r\n    }\r\n  }\r\n\r\n  clear() {\r\n    this.container.style.display = 'none';\r\n\r\n    if(this.clearable) {\r\n      this.list.innerHTML = '';\r\n    }\r\n  }\r\n\r\n  setActive() {\r\n    this.container.style.display = '';\r\n  }\r\n\r\n  toggle() {\r\n    if(this.list.childElementCount) {\r\n      this.setActive();\r\n    } else {\r\n      this.clear();\r\n    }\r\n  }\r\n}\r\n\r\nexport type SearchGroupType = 'contacts' | 'globalContacts' | 'messages' | string;\r\n\r\nexport default class AppSearch {\r\n  private minMsgId = 0;\r\n  private loadedCount = -1;\r\n  private foundCount = -1;\r\n\r\n  private searchPromise: Promise<void> = null;\r\n  private searchTimeout: number = 0;\r\n\r\n  private query = '';\r\n\r\n  private listsContainer: HTMLDivElement = null;\r\n\r\n  private peerId: PeerId; // 0 - means global\r\n  private threadId = 0;\r\n\r\n  private scrollable: Scrollable;\r\n\r\n  constructor(public container: HTMLElement, public searchInput: InputSearch, public searchGroups: {[group in SearchGroupType]: SearchGroup}, public onSearch?: (count: number) => void) {\r\n    this.scrollable = new Scrollable(this.container);\r\n    this.listsContainer = this.scrollable.container as HTMLDivElement;\r\n    for(let i in this.searchGroups) {\r\n      this.listsContainer.append(this.searchGroups[i as SearchGroupType].container);\r\n    }\r\n\r\n    if(this.searchGroups.messages) {\r\n      this.scrollable.setVirtualContainer(this.searchGroups.messages.list);\r\n    }\r\n\r\n    this.searchInput.onChange = (value) => {\r\n      /* if(!value.trim()) {\r\n        //this.peerId = 0;\r\n        return;\r\n      } */\r\n      \r\n      this.query = value;\r\n      this.reset(false);\r\n      this.searchMore();\r\n    };\r\n\r\n    this.scrollable.onScrolledBottom = () => {\r\n      if(!this.query.trim()) return;\r\n    \r\n      if(!this.searchTimeout) {\r\n        this.searchTimeout = window.setTimeout(() => {\r\n          this.searchMore();\r\n          this.searchTimeout = 0;\r\n        }, 0);\r\n      }\r\n    };\r\n  }\r\n\r\n  public reset(all = true) {\r\n    if(all) {\r\n      this.searchInput.value = '';\r\n      this.query = '';\r\n      this.peerId = undefined;\r\n      this.threadId = 0;\r\n    }\r\n\r\n    this.minMsgId = 0;\r\n    this.loadedCount = -1;\r\n    this.foundCount = -1;\r\n\r\n    for(let i in this.searchGroups) {\r\n      this.searchGroups[i as SearchGroupType].clear();\r\n    }\r\n    \r\n    this.searchPromise = null;\r\n  }\r\n\r\n  public beginSearch(peerId?: PeerId, threadId = 0, query = '') {\r\n    this.peerId = peerId;\r\n    this.threadId = threadId;\r\n\r\n    if(this.query !== query) {\r\n      this.searchInput.inputField.value = query;\r\n    }\r\n\r\n    this.searchInput.input.focus();\r\n  }\r\n\r\n  public searchMore() {\r\n    if(this.searchPromise) return this.searchPromise;\r\n    \r\n    const query = this.query;\r\n    \r\n    if(!query.trim()) {\r\n      this.onSearch && this.onSearch(0);\r\n      return;\r\n    }\r\n    \r\n    if(this.foundCount !== -1 && this.loadedCount >= this.foundCount) {\r\n      return Promise.resolve();\r\n    }\r\n    \r\n    const maxId = this.minMsgId || 0;\r\n\r\n    return this.searchPromise = rootScope.managers.appMessagesManager.getSearch({\r\n      peerId: this.peerId, \r\n      query, \r\n      inputFilter: {_: 'inputMessagesFilterEmpty'}, \r\n      maxId, \r\n      limit: 20,\r\n      threadId: this.threadId\r\n    }).then((res) => {\r\n      this.searchPromise = null;\r\n      \r\n      if(this.searchInput.value !== query) {\r\n        return;\r\n      }\r\n      \r\n      //console.log('input search result:', this.peerId, query, null, maxId, 20, res);\r\n      \r\n      const {count, history} = res;\r\n      \r\n      if(history.length && history[0].mid === this.minMsgId) {\r\n        history.shift();\r\n      }\r\n      \r\n      const searchGroup = this.searchGroups.messages;\r\n\r\n      history.forEach((message) => {\r\n        try {\r\n          const peerId = this.peerId ? message.fromId : message.peerId;\r\n          appDialogsManager.addDialogAndSetLastMessage({\r\n            peerId, \r\n            container: this.scrollable/* searchGroup.list */, \r\n            avatarSize: 54,\r\n            meAsSaved: false,\r\n            message,\r\n            query\r\n          });\r\n        } catch(err) {\r\n          console.error('[appSearch] render search result', err);\r\n        }\r\n      });\r\n\r\n      searchGroup.toggle();\r\n      \r\n      this.minMsgId = history.length && history[history.length - 1].mid;\r\n      \r\n      if(this.loadedCount === -1) {\r\n        this.loadedCount = 0;\r\n      }\r\n      this.loadedCount += history.length;\r\n      \r\n      if(this.foundCount === -1) {\r\n        this.foundCount = count;\r\n\r\n        if(searchGroup.nameEl) {\r\n          replaceContent(searchGroup.nameEl, i18n(count ? 'Chat.Search.MessagesFound' : 'Chat.Search.NoMessagesFound', [count]));\r\n        }\r\n        \r\n        this.onSearch && this.onSearch(this.foundCount);\r\n      }\r\n    }).catch((err) => {\r\n      console.error('search error', err);\r\n      this.searchPromise = null;\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n//import { getRichValue } from \"../helpers/dom\";\r\nimport { LangPackKey } from \"../lib/langPack\";\r\nimport InputField from \"./inputField\";\r\n\r\nexport default class InputSearch {\r\n  public container: HTMLElement;\r\n  public input: HTMLElement;\r\n  public inputField: InputField;\r\n  public clearBtn: HTMLElement;\r\n\r\n  public prevValue = '';\r\n  public timeout = 0;\r\n  public onChange: (value: string) => void;\r\n  public onClear: () => void;\r\n\r\n  constructor(placeholder: LangPackKey, onChange?: (value: string) => void) {\r\n    this.inputField = new InputField({\r\n      placeholder,\r\n      plainText: true\r\n    });\r\n\r\n    this.container = this.inputField.container;\r\n    this.container.classList.remove('input-field');\r\n    this.container.classList.add('input-search');\r\n\r\n    this.onChange = onChange;\r\n\r\n    this.input = this.inputField.input;\r\n    this.input.classList.add('input-search-input');\r\n\r\n    const searchIcon = document.createElement('i');\r\n    searchIcon.classList.add('tgico', 'tgico-search');\r\n\r\n    this.clearBtn = document.createElement('i');\r\n    this.clearBtn.classList.add('tgico', 'btn-icon', 'tgico-close');\r\n\r\n    this.input.addEventListener('input', this.onInput);\r\n    this.clearBtn.addEventListener('click', this.onClearClick);\r\n\r\n    this.container.append(searchIcon, this.clearBtn);\r\n  }\r\n  \r\n  onInput = () => {\r\n    if(!this.onChange) return;\r\n\r\n    let value = this.value;\r\n\r\n    //this.input.classList.toggle('is-empty', !value.trim());\r\n\r\n    if(value !== this.prevValue) {\r\n      this.prevValue = value;\r\n      clearTimeout(this.timeout);\r\n      this.timeout = window.setTimeout(() => {\r\n        this.onChange(value);\r\n      }, 200);\r\n    }\r\n  };\r\n\r\n  onClearClick = () => {\r\n    this.value = '';\r\n    this.onChange && this.onChange('');\r\n    this.onClear && this.onClear();\r\n  };\r\n\r\n  get value() {\r\n    return this.inputField.value;\r\n  }\r\n\r\n  set value(value: string) {\r\n    this.prevValue = value;\r\n    clearTimeout(this.timeout);\r\n    this.inputField.value = value;\r\n  }\r\n\r\n  public remove() {\r\n    clearTimeout(this.timeout);\r\n    this.input.removeEventListener('input', this.onInput);\r\n    this.clearBtn.removeEventListener('click', this.onClearClick);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Button from \"./button\";\r\n\r\nconst ButtonIcon = (className?: string, options: Partial<{noRipple: true, onlyMobile: true, asDiv: boolean}> = {}) => {\r\n  const button = Button('btn-icon', {\r\n    icon: className || undefined, \r\n    ...options\r\n  });\r\n\r\n  return button;\r\n};\r\n\r\nexport default ButtonIcon;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport EventListenerBase from \"../helpers/eventListenerBase\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\nimport ButtonIcon from \"./buttonIcon\";\r\nimport Scrollable from \"./scrollable\";\r\nimport SidebarSlider from \"./slider\";\r\n\r\nexport interface SliderTab {\r\n  onOpen?: () => void,\r\n  onOpenAfterTimeout?: () => void,\r\n  onClose?: () => void,\r\n  onCloseAfterTimeout?: () => void\r\n}\r\n\r\nexport interface SliderSuperTabConstructable<T extends SliderSuperTab = any> {\r\n  new(slider: SidebarSlider, destroyable: boolean): T;\r\n}\r\n\r\nexport interface SliderSuperTabEventableConstructable {\r\n  new(slider: SidebarSlider, destroyable: boolean): SliderSuperTabEventable;\r\n}\r\n\r\nexport default class SliderSuperTab implements SliderTab {\r\n  public container: HTMLElement;\r\n\r\n  public header: HTMLElement;\r\n  public closeBtn: HTMLElement;\r\n  public title: HTMLElement;\r\n\r\n  public content: HTMLElement;\r\n  public scrollable: Scrollable;\r\n\r\n  public slider: SidebarSlider;\r\n  public destroyable: boolean;\r\n  public listenerSetter: ListenerSetter;\r\n\r\n  public managers: AppManagers;\r\n\r\n  constructor(slider: SidebarSlider, destroyable?: boolean) {\r\n    this._constructor(slider, destroyable);\r\n  }\r\n\r\n  public _constructor(slider: SidebarSlider, destroyable = true): any {\r\n    this.slider = slider;\r\n    this.destroyable = destroyable;\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('tabs-tab', 'sidebar-slider-item');\r\n\r\n    // * Header\r\n    this.header = document.createElement('div');\r\n    this.header.classList.add('sidebar-header');\r\n\r\n    this.closeBtn = ButtonIcon('left sidebar-close-button', {noRipple: true});\r\n    this.title = document.createElement('div');\r\n    this.title.classList.add('sidebar-header__title');\r\n    this.header.append(this.closeBtn, this.title);\r\n\r\n    // * Content\r\n    this.content = document.createElement('div');\r\n    this.content.classList.add('sidebar-content');\r\n\r\n    this.scrollable = new Scrollable(this.content, undefined, undefined, true);\r\n\r\n    this.container.append(this.header, this.content);\r\n\r\n    if(this.slider) {\r\n      this.slider.addTab(this);\r\n    }\r\n    \r\n    this.listenerSetter = new ListenerSetter();\r\n  }\r\n\r\n  public close() {\r\n    return this.slider.closeTab(this);\r\n  }\r\n\r\n  public async open(...args: any[]) {\r\n    if(this.init) {\r\n      try {\r\n        const result = this.init();\r\n        this.init = null;\r\n\r\n        if(result instanceof Promise) {\r\n          await result;\r\n        }\r\n      } catch(err) {\r\n        console.error('open tab error', err);\r\n      }\r\n    }\r\n\r\n    this.slider.selectTab(this);\r\n  }\r\n\r\n  protected init(): Promise<any> | any {\r\n\r\n  }\r\n\r\n  public onCloseAfterTimeout() {\r\n    if(this.destroyable) { // ! WARNING,            !\r\n      this.slider.tabs.delete(this);\r\n      this.container.remove();\r\n      this.scrollable.destroy();\r\n      this.listenerSetter?.removeAll();\r\n    }\r\n  }\r\n\r\n  protected setTitle(key: LangPackKey) {\r\n    this.title.innerHTML = '';\r\n    this.title.append(i18n(key));\r\n  }\r\n}\r\n\r\nexport class SliderSuperTabEventable extends SliderSuperTab {\r\n  public eventListener: EventListenerBase<{\r\n    destroy: () => void\r\n  }>;\r\n\r\n  constructor(slider: SidebarSlider) {\r\n    super(slider);\r\n    this.eventListener = new EventListenerBase();\r\n  }\r\n\r\n  onCloseAfterTimeout() {\r\n    this.eventListener.dispatchEvent('destroy');\r\n    this.eventListener.cleanup();\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n\r\n/* // @ts-ignore\r\ninterface SliderSuperEventsTab extends SliderSuperTab, EventListenerBase<{}> {\r\n  superConstructor: (...args: any[]) => any;\r\n}\r\nclass SliderSuperEventsTab implements SliderSuperEventsTab {\r\n  constructor(slider: SidebarSlider) {\r\n    this.superConstructor([slider, true]);\r\n  }\r\n}\r\napplyMixins(SliderSuperEventsTab, [SliderSuperTab, EventListenerBase]);\r\n\r\n(window as any).lol = SliderSuperEventsTab\r\n\r\nexport {SliderSuperEventsTab}; */\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { horizontalMenu } from \"./horizontalMenu\";\r\nimport { TransitionSlider } from \"./transition\";\r\nimport appNavigationController, { NavigationItem } from \"./appNavigationController\";\r\nimport SliderSuperTab, { SliderSuperTabConstructable, SliderTab } from \"./sliderTab\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport indexOfAndSplice from \"../helpers/array/indexOfAndSplice\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\n\r\nconst TRANSITION_TIME = 250;\r\n\r\nexport type {SliderTab};\r\nexport {SliderSuperTab};\r\n\r\nexport default class SidebarSlider {\r\n  protected _selectTab: ReturnType<typeof horizontalMenu>;\r\n  public historyTabIds: (number | SliderSuperTab)[] = []; // * key is any, since right sidebar is ugly nowz\r\n  public tabsContainer: HTMLElement;\r\n  public sidebarEl: HTMLElement;\r\n  public tabs: Map<any, SliderTab>; // * key is any, since right sidebar is ugly now\r\n  private canHideFirst = false;\r\n  private navigationType: NavigationItem['type'];\r\n  protected managers: AppManagers;\r\n\r\n  constructor(options: {\r\n    sidebarEl: SidebarSlider['sidebarEl'],\r\n    tabs?: SidebarSlider['tabs'],\r\n    canHideFirst?: SidebarSlider['canHideFirst'],\r\n    navigationType: SidebarSlider['navigationType']\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    if(!this.tabs) {\r\n      this.tabs = new Map();\r\n    }\r\n\r\n    this.tabsContainer = this.sidebarEl.querySelector('.sidebar-slider');\r\n    this._selectTab = TransitionSlider(this.tabsContainer, 'navigation', TRANSITION_TIME);\r\n    if(!this.canHideFirst) {\r\n      this._selectTab(0);\r\n    }\r\n\r\n    Array.from(this.sidebarEl.querySelectorAll('.sidebar-close-button') as any as HTMLElement[]).forEach((el) => {\r\n      attachClickEvent(el, this.onCloseBtnClick);\r\n    });\r\n  }\r\n\r\n  public onCloseBtnClick = () => {\r\n    const item = appNavigationController.findItemByType(this.navigationType);\r\n    if(item) {\r\n      appNavigationController.back(this.navigationType);\r\n    } else if(this.historyTabIds.length) {\r\n      this.closeTab(this.historyTabIds[this.historyTabIds.length - 1]);\r\n    }\r\n    // this.closeTab();\r\n  };\r\n\r\n  public closeTab = (id?: number | SliderSuperTab, animate?: boolean, isNavigation?: boolean) => {\r\n    if(id !== undefined && this.historyTabIds[this.historyTabIds.length - 1] !== id) {\r\n      return false;\r\n    }\r\n\r\n    //console.log('sidebar-close-button click:', this.historyTabIDs);\r\n    const closingId = this.historyTabIds.pop(); // pop current\r\n    this.onCloseTab(closingId, animate, isNavigation);\r\n\r\n    const tab = this.historyTabIds[this.historyTabIds.length - 1];\r\n    this._selectTab(tab !== undefined ? (tab instanceof SliderSuperTab ? tab.container : tab) : (this.canHideFirst ? -1 : 0), animate);\r\n    return true;\r\n  };\r\n\r\n  public selectTab(id: number | SliderSuperTab): boolean {\r\n    /* if(id instanceof SliderSuperTab) {\r\n      id = id.id;\r\n    } */\r\n\r\n    if(this.historyTabIds[this.historyTabIds.length - 1] === id) {\r\n      return false;\r\n    }\r\n\r\n    const tab: SliderTab = id instanceof SliderSuperTab ? id : this.tabs.get(id);\r\n    if(tab) {\r\n      if(tab.onOpen) {\r\n        tab.onOpen();\r\n      }\r\n  \r\n      if(tab.onOpenAfterTimeout) {\r\n        setTimeout(() => {\r\n          tab.onOpenAfterTimeout();\r\n        }, TRANSITION_TIME);\r\n      }\r\n    }\r\n\r\n    //if(!this.canHideFirst || this.historyTabIds.length) {\r\n      appNavigationController.pushItem({\r\n        type: this.navigationType, \r\n        onPop: (canAnimate) => {\r\n          this.closeTab(undefined, canAnimate, true);\r\n          return true;\r\n        }\r\n      });\r\n    //}\r\n    \r\n    this.historyTabIds.push(id);\r\n    this._selectTab(id instanceof SliderSuperTab ? id.container : id);\r\n    return true;\r\n  }\r\n\r\n  public removeTabFromHistory(id: number | SliderSuperTab) {\r\n    indexOfAndSplice(this.historyTabIds, id);\r\n    this.onCloseTab(id, undefined);\r\n  }\r\n\r\n  public sliceTabsUntilTab(tabConstructor: SliderSuperTabConstructable, preserveTab: SliderSuperTab) {\r\n    for(let i = this.historyTabIds.length - 1; i >= 0; --i) {\r\n      const tab = this.historyTabIds[i];\r\n      if(tab === preserveTab) continue;\r\n      else if(tab instanceof tabConstructor) {\r\n        break;\r\n      }\r\n\r\n      this.removeTabFromHistory(tab);\r\n      //appNavigationController.removeByType(this.navigationType, true);\r\n    }\r\n  }\r\n\r\n  public getTab<T extends SliderSuperTab>(tabConstructor: SliderSuperTabConstructable<T>) {\r\n    return this.historyTabIds.find((t) => t instanceof tabConstructor) as T;\r\n  }\r\n\r\n  public isTabExists(tabConstructor: SliderSuperTabConstructable) {\r\n    return !!this.getTab(tabConstructor);\r\n  }\r\n\r\n  protected onCloseTab(id: number | SliderSuperTab, animate: boolean, isNavigation?: boolean) {\r\n    if(!isNavigation) {\r\n      appNavigationController.removeByType(this.navigationType, true);\r\n    }\r\n\r\n    const tab: SliderTab = id instanceof SliderSuperTab ? id : this.tabs.get(id);\r\n    if(tab) {\r\n      if(tab.onClose) {\r\n        tab.onClose();\r\n      }\r\n\r\n      if(tab.onCloseAfterTimeout) {\r\n        setTimeout(() => {\r\n          tab.onCloseAfterTimeout();\r\n        }, TRANSITION_TIME + 30);\r\n      }\r\n    }\r\n  }\r\n\r\n  public addTab(tab: SliderSuperTab) {\r\n    if(!tab.container.parentElement) {\r\n      this.tabsContainer.append(tab.container);\r\n\r\n      if(tab.closeBtn) {\r\n        tab.closeBtn.addEventListener('click', this.onCloseBtnClick);\r\n      }\r\n    }\r\n  }\r\n\r\n  public createTab<T extends SliderSuperTab>(ctor: SliderSuperTabConstructable<T>, doNotAppend?: boolean) {\r\n    const tab = new ctor(doNotAppend ? undefined : this, true);\r\n    tab.managers = this.managers;\r\n    return tab;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { CancellablePromise } from \"../helpers/cancellablePromise\";\r\nimport type { InputFile } from \"../layer\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport PopupElement from \"./popups\";\r\nimport PopupAvatar from \"./popups/avatar\";\r\n\r\nexport default class AvatarEdit {\r\n  public container: HTMLElement;\r\n  private canvas: HTMLCanvasElement;\r\n  private icon: HTMLSpanElement;\r\n\r\n  constructor(onChange: (uploadAvatar: () => CancellablePromise<InputFile>) => void) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('avatar-edit');\r\n\r\n    this.canvas = document.createElement('canvas');\r\n    this.canvas.classList.add('avatar-edit-canvas');\r\n\r\n    this.icon = document.createElement('span');\r\n    this.icon.classList.add('tgico', 'tgico-cameraadd');\r\n\r\n    this.container.append(this.canvas, this.icon);\r\n\r\n    attachClickEvent(this.container, () => {\r\n      PopupElement.createPopup(PopupAvatar).open(this.canvas, onChange);\r\n    });\r\n  }\r\n\r\n  public clear() {\r\n    const ctx = this.canvas.getContext('2d');\r\n    ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Button from \"./button\";\r\n\r\nconst ButtonCorner = (options: Partial<{className: string, icon: string, noRipple: true, onlyMobile: true, asDiv: boolean}> = {}) => {\r\n  const button = Button('btn-circle btn-corner z-depth-1' + (options.className ? ' ' + options.className : ''), options);\r\n  return button;\r\n};\r\n\r\nexport default ButtonCorner;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport I18n, { i18n } from \"../lib/langPack\";\r\n\r\nexport const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];\r\nexport const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\r\n\r\nexport const ONE_DAY = 86400;\r\n\r\n// https://stackoverflow.com/a/6117889\r\nexport const getWeekNumber = (date: Date) => {\r\n  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));\r\n  const dayNum = d.getUTCDay() || 7;\r\n  d.setUTCDate(d.getUTCDate() + 4 - dayNum);\r\n  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\r\n  return Math.ceil((((d.getTime() - yearStart.getTime()) / ONE_DAY) + 1) / 7);\r\n};\r\n\r\nexport function formatDateAccordingToTodayNew(time: Date) {\r\n  const today = new Date();\r\n  const now = today.getTime() / 1000 | 0;\r\n  const timestamp = time.getTime() / 1000 | 0;\r\n\r\n  const options: Intl.DateTimeFormatOptions = {};\r\n  if((now - timestamp) < ONE_DAY && today.getDate() === time.getDate()) { // if the same day\r\n    options.hour = options.minute = '2-digit';\r\n  } else if(today.getFullYear() !== time.getFullYear()) { // different year\r\n    options.year = options.day = 'numeric';\r\n    options.month = '2-digit';\r\n  } else if((now - timestamp) < (ONE_DAY * 7) && getWeekNumber(today) === getWeekNumber(time)) { // current week\r\n    options.weekday = 'short';\r\n  } else { // same year\r\n    options.month = 'short';\r\n    options.day = 'numeric';\r\n  }\r\n\r\n  return new I18n.IntlDateElement({\r\n    date: time,\r\n    options\r\n  }).element;\r\n}\r\n\r\nexport function formatFullSentTimeRaw(timestamp: number, options: {\r\n  capitalize?: boolean\r\n} = {}) {\r\n  const date = new Date();\r\n  const time = new Date(timestamp * 1000);\r\n  const now = date.getTime() / 1000;\r\n\r\n  const timeEl = formatTime(time);\r\n\r\n  let dateEl: Node | string;\r\n  if((now - timestamp) < ONE_DAY && date.getDate() === time.getDate()) { // if the same day\r\n    dateEl = i18n(options.capitalize ? 'Date.Today' : 'Peer.Status.Today');\r\n  } else if((now - timestamp) < (ONE_DAY * 2) && (date.getDate() - 1) === time.getDate()) { // yesterday\r\n    dateEl = i18n(options.capitalize ? 'Yesterday' : 'Peer.Status.Yesterday');\r\n\r\n    if(options.capitalize) {\r\n      (dateEl as HTMLElement).style.textTransform = 'capitalize';\r\n    }\r\n  } else if(date.getFullYear() !== time.getFullYear()) { // different year\r\n    dateEl = new I18n.IntlDateElement({\r\n      date: time,\r\n      options: {\r\n        month: 'short',\r\n        day: 'numeric',\r\n        year: 'numeric'\r\n      }\r\n    }).element;\r\n    // dateStr = months[time.getMonth()].slice(0, 3) + ' ' + time.getDate() + ', ' + time.getFullYear();\r\n  } else {\r\n    dateEl = new I18n.IntlDateElement({\r\n      date: time,\r\n      options: {\r\n        month: 'short',\r\n        day: 'numeric'\r\n      }\r\n    }).element;\r\n    // dateStr = months[time.getMonth()].slice(0, 3) + ' ' + time.getDate();\r\n  }\r\n\r\n  return {dateEl, timeEl};\r\n}\r\n\r\nexport function formatFullSentTime(timestamp: number) {\r\n  const {dateEl, timeEl} = formatFullSentTimeRaw(timestamp, {\r\n    capitalize: true\r\n  });\r\n\r\n  const fragment = document.createDocumentFragment();\r\n  fragment.append(dateEl, ' ', i18n('ScheduleController.at'), ' ', timeEl);\r\n  return fragment;\r\n}\r\n\r\nexport function formatTime(date: Date) {\r\n  return new I18n.IntlDateElement({\r\n    date,\r\n    options: {\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    }\r\n  }).element;\r\n}\r\n\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.formatDateAccordingToTodayNew = formatDateAccordingToTodayNew);\r\n\r\nexport const getFullDate = (date: Date, options: Partial<{\r\n  noTime: true, \r\n  noSeconds: true,\r\n  monthAsNumber: true,\r\n  leadingZero: true\r\n}> = {}) => {\r\n  const joiner = options.monthAsNumber ? '.' : ' ';\r\n  const time = ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2) + (options.noSeconds ? '' : ':' + ('0' + date.getSeconds()).slice(-2));\r\n\r\n  return (options.leadingZero ? ('0' + date.getDate()).slice(-2) : date.getDate()) + \r\n    joiner + (options.monthAsNumber ? ('0' + (date.getMonth() + 1)).slice(-2) : months[date.getMonth()]) + \r\n    joiner + date.getFullYear() + \r\n    (options.noTime ? '' : ', ' + time);\r\n};\r\n\r\n// https://github.com/DrKLO/Telegram/blob/d52b2c921abd3c1e8d6368858313ad0cb0468c07/TMessagesProj/src/main/java/org/telegram/ui/Adapters/FiltersView.java\r\nconst minYear = 2013;\r\nconst yearPattern = new RegExp(\"20[0-9]{1,2}\");\r\nconst monthYearOrDayPattern = new RegExp(\"(\\\\w{3,}) ([0-9]{0,4})\", 'i');\r\nconst yearOrDayAndMonthPattern = new RegExp(\"([0-9]{0,4}) (\\\\w{2,})\", 'i');\r\nconst shortDate = new RegExp(\"^([0-9]{1,4})(\\\\.| |/|\\\\-)([0-9]{1,4})$\", 'i');\r\nconst longDate = new RegExp(\"^([0-9]{1,2})(\\\\.| |/|\\\\-)([0-9]{1,2})(\\\\.| |/|\\\\-)([0-9]{1,4})$\", 'i');\r\nconst numberOfDaysEachMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];\r\nexport type DateData = {\r\n  title: string,\r\n  minDate: number,\r\n  maxDate: number,\r\n};\r\nexport function fillTipDates(query: string, dates: DateData[]) {\r\n  const q = query.trim().toLowerCase();\r\n\r\n  if(q.length < 3) {\r\n    return;\r\n  }\r\n\r\n  if(\"today\".indexOf(q) === 0) {\r\n    const date = new Date();\r\n    const year = date.getFullYear();\r\n    const month = date.getMonth();\r\n    const day = date.getDate();\r\n    date.setFullYear(year, month, day);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const minDate = date.getTime();\r\n    date.setFullYear(year, month, day + 1);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const maxDate = date.getTime() - 1;\r\n    dates.push({\r\n      title: 'Today',\r\n      minDate,\r\n      maxDate\r\n    });\r\n    return;\r\n  }\r\n\r\n  if(\"yesterday\".indexOf(q) === 0) {\r\n    const date = new Date();\r\n    const year = date.getFullYear();\r\n    const month = date.getMonth();\r\n    const day = date.getDate();\r\n    date.setFullYear(year, month, day);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const minDate = date.getTime() - 86400000;\r\n    date.setFullYear(year, month, day + 1);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const maxDate = date.getTime() - 86400001;\r\n    dates.push({\r\n      title: 'Yesterday',\r\n      minDate,\r\n      maxDate\r\n    });\r\n    return;\r\n  }\r\n\r\n  const dayOfWeek = getDayOfWeek(q);\r\n  if(dayOfWeek >= 0) {\r\n    const date = new Date();\r\n    const now = date.getTime();\r\n    const currentDay = date.getDay();\r\n    const distance = dayOfWeek - currentDay;\r\n    date.setDate(date.getDate() + distance);\r\n    if(date.getTime() > now) {\r\n      date.setTime(date.getTime() - 604800000);\r\n    }\r\n    const year = date.getFullYear()\r\n    const month = date.getMonth();\r\n    const day = date.getDate();\r\n    date.setFullYear(year, month, day);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const minDate = date.getTime();\r\n    date.setFullYear(year, month, day + 1);\r\n    date.setHours(0, 0, 0);\r\n\r\n    const maxDate = date.getTime() - 1;\r\n    dates.push({\r\n      title: formatWeekLong(minDate),\r\n      minDate,\r\n      maxDate\r\n    });\r\n    return;\r\n  }\r\n\r\n  let matches: any[];\r\n  if((matches = shortDate.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[3];\r\n    const k = parseInt(g1);\r\n    const k1 = parseInt(g2);\r\n    if(k > 0 && k <= 31) {\r\n      if(k1 >= minYear && k <= 12) {\r\n        const selectedYear = k1;\r\n        const month = k - 1;\r\n        createForMonthYear(dates, month, selectedYear);\r\n        return;\r\n      } else if (k1 <= 12) {\r\n        const day = k - 1;\r\n        const month = k1 - 1;\r\n        createForDayMonth(dates, day, month);\r\n      }\r\n    } else if (k >= minYear && k1 <= 12) {\r\n      const selectedYear = k;\r\n      const month = k1 - 1;\r\n      createForMonthYear(dates, month, selectedYear);\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  if((matches = longDate.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[3];\r\n    const g3 = matches[5];\r\n    if(!matches[2] === matches[4]) {\r\n      return;\r\n    }\r\n\r\n    const day = parseInt(g1);\r\n    const month = parseInt(g2) - 1;\r\n    let year = parseInt(g3);\r\n    if(year >= 10 && year <= 99) {\r\n      year += 2000;\r\n    }\r\n\r\n    const currentYear = new Date().getFullYear();\r\n    if(validDateForMonth(day - 1, month) && year >= minYear && year <= currentYear) {\r\n      const date = new Date();\r\n      date.setFullYear(year, month, day);\r\n      date.setHours(0, 0, 0);\r\n      \r\n      const minDate = date.getTime();\r\n      date.setFullYear(year, month, day + 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const maxDate = date.getTime() - 1;\r\n      dates.push({\r\n        title: formatterYearMax(minDate),\r\n        minDate,\r\n        maxDate\r\n      });\r\n      return;\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  if((matches = yearPattern.exec(q)) !== null) {\r\n    let selectedYear = +q;\r\n    const currentYear = new Date().getFullYear();\r\n    if(selectedYear < minYear) {\r\n      selectedYear = minYear;\r\n      for(let i = currentYear; i >= selectedYear; i--) {\r\n        const date = new Date();\r\n        date.setFullYear(i, 0, 1);\r\n        date.setHours(0, 0, 0);\r\n\r\n        const minDate = date.getTime();\r\n        date.setFullYear(i + 1, 0, 1);\r\n        date.setHours(0, 0, 0);\r\n\r\n        const maxDate = date.getTime() - 1;\r\n        dates.push({\r\n          title: '' + i,\r\n          minDate,\r\n          maxDate\r\n        });\r\n      }\r\n    } else if(selectedYear <= currentYear) {\r\n      const date = new Date();\r\n      date.setFullYear(selectedYear, 0, 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const minDate = date.getTime();\r\n      date.setFullYear(selectedYear + 1, 0, 1);\r\n      date.setHours(0, 0, 0);\r\n\r\n      const maxDate = date.getTime() - 1;\r\n      dates.push({\r\n        title: '' + selectedYear,\r\n        minDate,\r\n        maxDate\r\n      });\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  if((matches = monthYearOrDayPattern.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[2];\r\n    const month = getMonth(g1);\r\n    if(month >= 0) {\r\n      const k = +g2;\r\n      if(k > 0 && k <= 31) {\r\n        const day = k - 1;\r\n        createForDayMonth(dates, day, month);\r\n        return;\r\n      } else if(k >= minYear) {\r\n        const selectedYear = k;\r\n        createForMonthYear(dates, month, selectedYear);\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  if((matches = yearOrDayAndMonthPattern.exec(q)) !== null) {\r\n    const g1 = matches[1];\r\n    const g2 = matches[2];\r\n    const month = getMonth(g2);\r\n    if(month >= 0) {\r\n      const k = +g1;\r\n      if(k > 0 && k <= 31) {\r\n        const day = k - 1;\r\n        createForDayMonth(dates, day, month);\r\n        return;\r\n      } else if (k >= minYear) {\r\n        const selectedYear = k;\r\n        createForMonthYear(dates, month, selectedYear);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction createForMonthYear(dates: DateData[], month: number, selectedYear: number) {\r\n  const currentYear = new Date().getFullYear();\r\n  const today = Date.now();\r\n  if(selectedYear >= minYear && selectedYear <= currentYear) {\r\n    const date = new Date();\r\n    date.setFullYear(selectedYear, month, 1);\r\n    date.setHours(0, 0, 0);\r\n    const minDate = date.getTime();\r\n    if(minDate > today) {\r\n      return;\r\n    }\r\n    date.setMonth(date.getMonth() + 1);\r\n    const maxDate = date.getTime() - 1;\r\n\r\n    dates.push({\r\n      title: formatterMonthYear(minDate),\r\n      minDate,\r\n      maxDate\r\n    });\r\n  }\r\n}\r\n\r\nfunction createForDayMonth(dates: DateData[], day: number, month: number) {\r\n  if(validDateForMonth(day, month)) {\r\n    const currentYear = new Date().getFullYear();\r\n    const today = Date.now();\r\n    \r\n    for(let i = currentYear; i >= minYear; i--) {\r\n      if(month === 1 && day === 28 && !isLeapYear(i)) {\r\n        continue;\r\n      }\r\n\r\n      const date = new Date();\r\n      date.setFullYear(i, month, day + 1);\r\n      date.setHours(0, 0, 0);\r\n      \r\n      const minDate = date.getTime();\r\n      if(minDate > today) {\r\n        continue;\r\n      }\r\n\r\n      date.setFullYear(i, month, day + 2);\r\n      date.setHours(0, 0, 0);\r\n      const maxDate = date.getTime() - 1;\r\n      if(i === currentYear) {\r\n        dates.push({\r\n          title: formatterDayMonth(minDate),\r\n          minDate,\r\n          maxDate\r\n        });\r\n      } else {\r\n        dates.push({\r\n          title: formatterYearMax(minDate),\r\n          minDate,\r\n          maxDate\r\n        });\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction formatterMonthYear(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return months[date.getMonth()].slice(0, 3) + ' ' + date.getFullYear();\r\n}\r\n\r\nfunction formatterDayMonth(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return months[date.getMonth()].slice(0, 3) + ' ' + date.getDate();\r\n}\r\n\r\nfunction formatterYearMax(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return ('0' + date.getDate()).slice(-2) + '.' + ('0' + (date.getMonth() + 1)).slice(-2) + '.' + date.getFullYear();\r\n}\r\n\r\nfunction formatWeekLong(timestamp: number) {\r\n  const date = new Date(timestamp);\r\n  return days[date.getDay()];\r\n}\r\n\r\nfunction validDateForMonth(day: number, month: number) {\r\n  if(month >= 0 && month < 12) {\r\n    if(day >= 0 && day < numberOfDaysEachMonth[month]) {\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction isLeapYear(year: number) {\r\n  return ((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0);\r\n}\r\n\r\nfunction getMonth(q: string) {\r\n  /* String[] months = new String[]{\r\n          LocaleController.getString(\"January\", R.string.January).toLowerCase(),\r\n          LocaleController.getString(\"February\", R.string.February).toLowerCase(),\r\n          LocaleController.getString(\"March\", R.string.March).toLowerCase(),\r\n          LocaleController.getString(\"April\", R.string.April).toLowerCase(),\r\n          LocaleController.getString(\"May\", R.string.May).toLowerCase(),\r\n          LocaleController.getString(\"June\", R.string.June).toLowerCase(),\r\n          LocaleController.getString(\"July\", R.string.July).toLowerCase(),\r\n          LocaleController.getString(\"August\", R.string.August).toLowerCase(),\r\n          LocaleController.getString(\"September\", R.string.September).toLowerCase(),\r\n          LocaleController.getString(\"October\", R.string.October).toLowerCase(),\r\n          LocaleController.getString(\"November\", R.string.November).toLowerCase(),\r\n          LocaleController.getString(\"December\", R.string.December).toLowerCase()\r\n  }; */\r\n\r\n  /* String[] monthsEng = new String[12];\r\n  Calendar c = Calendar.getInstance();\r\n  for (int i = 1; i <= 12; i++) {\r\n      c.set(0, 0, 0, 0, 0, 0);\r\n      c.set(Calendar.MONTH, i);\r\n      monthsEng[i - 1] = c.getDisplayName(Calendar.MONTH, Calendar.LONG, Locale.ENGLISH).toLowerCase();\r\n  } */\r\n\r\n  q = q.toLowerCase();\r\n  for(let i = 0; i < 12; i++) {\r\n    const month = months[i].toLowerCase();\r\n    if(month.indexOf(q) === 0) {\r\n      return i;\r\n    }\r\n  }\r\n  return -1;\r\n}\r\n\r\nfunction getDayOfWeek(q: string) {\r\n  const c = new Date();\r\n  if(q.length <= 3) {\r\n    return -1;\r\n  }\r\n  \r\n  for(let i = 0; i < 7; i++) {\r\n    c.setDate(c.getDate() + 1);\r\n    \r\n    if(formatWeekLong(c.getTime()).toLowerCase().indexOf(q) === 0) {\r\n      return c.getDay();\r\n    }\r\n  }\r\n  return -1;\r\n}\r\n\r\nMOUNT_CLASS_TO.fillTipDates = fillTipDates;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { formatFullSentTimeRaw } from \"../../helpers/date\";\r\nimport { User } from \"../../layer\";\r\nimport { LangPackKey, i18n } from \"../../lib/langPack\";\r\nimport { REPLIES_PEER_ID, SERVICE_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\n\r\nexport default function getUserStatusString(user: User.user): HTMLElement {\r\n  if(!user) {\r\n    return document.createElement('span');\r\n  }\r\n\r\n  let key: LangPackKey;\r\n  let args: any[];\r\n\r\n  switch(user.id) {\r\n    case REPLIES_PEER_ID.toUserId():\r\n      key = 'Peer.RepliesNotifications';\r\n      break;\r\n    case SERVICE_PEER_ID.toUserId():\r\n      key = 'Peer.ServiceNotifications';\r\n      break;\r\n    default: {\r\n      if(user.pFlags.bot) {\r\n        key = 'Bot';\r\n        break;\r\n      }\r\n\r\n      if(user.pFlags.support) {\r\n        key = 'SupportStatus';\r\n        break;\r\n      }\r\n\r\n      switch(user.status?._) {\r\n        case 'userStatusRecently': {\r\n          key = 'Lately';\r\n          break;\r\n        }\r\n  \r\n        case 'userStatusLastWeek': {\r\n          key = 'WithinAWeek';\r\n          break;\r\n        }\r\n  \r\n        case 'userStatusLastMonth': {\r\n          key = 'WithinAMonth';\r\n          break;\r\n        }\r\n        \r\n        case 'userStatusOffline': {\r\n          const date = user.status.was_online;\r\n          const today = new Date();\r\n          const now = today.getTime() / 1000 | 0;\r\n          \r\n          const diff = now - date;\r\n          if(diff < 60) {\r\n            key = 'Peer.Status.justNow';\r\n          } else if(diff < 3600) {\r\n            key = 'Peer.Status.minAgo';\r\n            const c = diff / 60 | 0;\r\n            args = [c];\r\n          } else if(diff < 86400 && today.getDate() === new Date(date * 1000).getDate()) {\r\n            key = 'LastSeen.HoursAgo';\r\n            const c = diff / 3600 | 0;\r\n            args = [c];\r\n          } else {\r\n            key = 'Peer.Status.LastSeenAt';\r\n            const {dateEl, timeEl} = formatFullSentTimeRaw(date);\r\n            args = [dateEl, timeEl];\r\n          }\r\n          \r\n          break;\r\n        }\r\n  \r\n        case 'userStatusOnline': {\r\n          key = 'Online';\r\n          break;\r\n        }\r\n  \r\n        default: {\r\n          key = 'ALongTimeAgo';\r\n          break;\r\n        }\r\n      }\r\n\r\n      break;\r\n    }\r\n  }\r\n  \r\n  return i18n(key, args);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appSidebarLeft, { SettingSection } from \"..\";\r\nimport { InputFile } from \"../../../layer\";\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport InputField from \"../../inputField\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport AvatarEdit from \"../../avatarEdit\";\r\nimport I18n from \"../../../lib/langPack\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport getUserStatusString from \"../../wrappers/getUserStatusString\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\n\r\ninterface OpenStreetMapInterface {\r\n  place_id?: number;\r\n  license?: string;\r\n  osm_type?: string;\r\n  osm_id?: number;\r\n  lat?: string;\r\n  lon?: string;\r\n  display_name: string;\r\n  address?: object;\r\n  boundingbox?: object;\r\n}\r\n\r\nexport default class AppNewGroupTab extends SliderSuperTab {\r\n  private avatarEdit: AvatarEdit;\r\n  private uploadAvatar: () => Promise<InputFile> = null;\r\n  private peerIds: PeerId[];\r\n  private isGeoChat: boolean = false;\r\n  private nextBtn: HTMLButtonElement;\r\n  private groupNameInputField: InputField;\r\n  private list: HTMLUListElement;\r\n  private groupLocationInputField: InputField;\r\n  private userLocationCoords: {lat: number, long: number};\r\n  private userLocationAddress: string;\r\n\r\n  protected init() {\r\n    this.container.classList.add('new-group-container');\r\n    this.setTitle('NewGroup');\r\n\r\n    this.avatarEdit = new AvatarEdit((_upload) => {\r\n      this.uploadAvatar = _upload;\r\n    });\r\n\r\n    const section = new SettingSection({});\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    this.groupNameInputField = new InputField({\r\n      label: 'CreateGroup.NameHolder',\r\n      maxLength: 128\r\n    });\r\n\r\n    this.groupLocationInputField = new InputField({\r\n      label: 'ChatLocation',\r\n      name: 'location',\r\n      canBeEdited: false\r\n    });\r\n\r\n    inputWrapper.append(\r\n      this.groupNameInputField.container,\r\n      this.groupLocationInputField.container\r\n    );\r\n\r\n    this.listenerSetter.add(this.groupNameInputField.input)('input', () => {\r\n      const value = this.groupNameInputField.value;\r\n      let valueCheck = !!value.length && !this.groupNameInputField.input.classList.contains('error');\r\n      if(this.isGeoChat) valueCheck = valueCheck && !!this.userLocationCoords && !!this.userLocationAddress;\r\n      this.nextBtn.classList.toggle('is-visible', !!valueCheck);\r\n    });\r\n\r\n    this.nextBtn = ButtonCorner({icon: 'arrow_next'});\r\n\r\n    attachClickEvent(this.nextBtn, () => {\r\n      const title = this.groupNameInputField.value;\r\n\r\n      let promise: Promise<ChatId>;\r\n      if(this.isGeoChat) {\r\n        if(!this.userLocationAddress || !this.userLocationCoords) return;\r\n        promise = this.managers.appChatsManager.createChannel({\r\n          title, \r\n          about: '', \r\n          geo_point: {\r\n            _: 'inputGeoPoint',\r\n            ...this.userLocationCoords, \r\n          },\r\n          address: this.userLocationAddress,\r\n          megagroup: true\r\n        }).then((chatId) => {\r\n          if(this.uploadAvatar) {\r\n            this.uploadAvatar().then((inputFile) => {\r\n              this.managers.appChatsManager.editPhoto(chatId, inputFile);\r\n            });\r\n          }\r\n\r\n          if(this.peerIds.length) {\r\n            this.managers.appChatsManager.inviteToChannel(chatId, this.peerIds);\r\n          }\r\n\r\n          return chatId;\r\n        });\r\n      } else {\r\n        this.nextBtn.disabled = true;\r\n        promise = this.managers.appChatsManager.createChat(title, this.peerIds.map((peerId) => peerId.toUserId())).then((chatId) => {\r\n          if(this.uploadAvatar) {\r\n            this.uploadAvatar().then((inputFile) => {\r\n              this.managers.appChatsManager.editPhoto(chatId, inputFile);\r\n            });\r\n          }\r\n          \r\n          return chatId;\r\n        });\r\n      }\r\n\r\n      if(!promise) {\r\n        return;\r\n      }\r\n\r\n      promise.then((chatId) => {\r\n        appSidebarLeft.removeTabFromHistory(this);\r\n        appSidebarLeft.selectTab(0);\r\n\r\n        appImManager.setInnerPeer({peerId: chatId.toPeerId(true)});\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const chatsSection = new SettingSection({\r\n      name: 'Members',\r\n      nameArgs: [this.peerIds.length]\r\n    });\r\n\r\n    const list = this.list = appDialogsManager.createChatList({\r\n      new: true\r\n    });\r\n\r\n    chatsSection.content.append(list);\r\n\r\n    section.content.append(this.avatarEdit.container, inputWrapper);\r\n\r\n    this.content.append(this.nextBtn);\r\n    this.scrollable.append(section.container, chatsSection.container);\r\n  }\r\n\r\n  public onCloseAfterTimeout() {\r\n    this.avatarEdit.clear();\r\n    this.uploadAvatar = null;\r\n    this.groupNameInputField.value = '';\r\n    this.groupLocationInputField.container.classList.add('hide');\r\n    this.nextBtn.disabled = false;\r\n  }\r\n\r\n  public open(peerIds: PeerId[], isGeoChat: boolean = false) {\r\n    this.isGeoChat = isGeoChat;\r\n    this.peerIds = peerIds;\r\n    const result = super.open();\r\n    result.then(() => {\r\n      if(isGeoChat) {\r\n        this.setTitle('NearbyCreateGroup');\r\n        this.groupLocationInputField.container.classList.remove('hide');\r\n        this.groupLocationInputField.setValueSilently(I18n.format('Loading', true));\r\n        this.startLocating();\r\n      } else {\r\n        this.groupLocationInputField.container.classList.add('hide');\r\n      }\r\n\r\n      return Promise.all(this.peerIds.map(async(userId) => {\r\n        const {dom} = appDialogsManager.addDialogNew({\r\n          peerId: userId,\r\n          container: this.list,\r\n          rippleEnabled: false,\r\n          avatarSize: 48\r\n        });\r\n\r\n        dom.lastMessageSpan.append(getUserStatusString(await this.managers.appUsersManager.getUser(userId)));\r\n      }));\r\n    });\r\n    \r\n    return result;\r\n  }\r\n\r\n  private startLocating() {\r\n    navigator.geolocation.getCurrentPosition((location) => {\r\n      this.userLocationCoords = {\r\n        lat: location.coords.latitude,\r\n        long: location.coords.longitude\r\n      };\r\n\r\n      let uri = \"https://nominatim.openstreetmap.org/reverse\";\r\n      uri += \"?lat=\"+location.coords.latitude;\r\n      uri += \"&lon=\"+location.coords.longitude;\r\n      uri += \"&format=json\";\r\n      uri += \"&addressdetails=1\";\r\n      uri += \"&accept-language=en\";\r\n      fetch(uri)\r\n      .then((response) => response.json())\r\n      .then((response: OpenStreetMapInterface) => {\r\n        this.userLocationAddress = response.display_name;\r\n        this.groupLocationInputField.setValueSilently(response.display_name);\r\n      });\r\n    }, (error) => {\r\n      if(error instanceof GeolocationPositionError) {\r\n        this.groupLocationInputField.setValueSilently('Location permission denied. Please retry later.');\r\n      } else {\r\n        this.groupLocationInputField.setValueSilently('An error has occurred. Please retry later.');\r\n      }\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\ntype TargetType = HTMLElement;\r\nexport type OnVisibilityChangeItem = {target: TargetType, visible: boolean, entry: IntersectionObserverEntry};\r\nexport type OnVisibilityChange = (item: OnVisibilityChangeItem) => void;\r\n\r\nexport default class VisibilityIntersector {\r\n  private observer: IntersectionObserver;\r\n  private items: Map<TargetType, boolean> = new Map();\r\n  private locked = false;\r\n\r\n  constructor(onVisibilityChange: OnVisibilityChange, options?: IntersectionObserverInit) {\r\n    this.observer = new IntersectionObserver((entries) => {\r\n      if(this.locked) {\r\n        return;\r\n      }\r\n\r\n      const changed: OnVisibilityChangeItem[] = [];\r\n\r\n      entries.forEach((entry) => {\r\n        const target = entry.target as TargetType;\r\n\r\n        if(this.items.get(target) === entry.isIntersecting) {\r\n          return;\r\n        } else {\r\n          this.items.set(target, entry.isIntersecting);\r\n        }\r\n\r\n        /* if(entry.isIntersecting) {\r\n          console.log('ooo', entry);\r\n        } */\r\n\r\n        /* if(this.locked) {\r\n          return;\r\n        } */\r\n\r\n        const change: typeof changed[0] = {target, visible: entry.isIntersecting, entry};\r\n\r\n        // ! order will be incorrect so can't use it\r\n        // changed[entry.isIntersecting ? 'unshift' : 'push'](change);\r\n        changed.push(change);\r\n\r\n        //onVisibilityChange(target, entry.isIntersecting);\r\n      });\r\n\r\n      changed.forEach((item) => {\r\n        onVisibilityChange(item);\r\n      });\r\n    }, options);\r\n  }\r\n\r\n  public getVisible() {\r\n    const items: TargetType[] = [];\r\n    this.items.forEach((value, key) => {\r\n      if(value) {\r\n        items.push(key);\r\n      }\r\n    });\r\n\r\n    return items;\r\n  }\r\n\r\n  public clearVisible() {\r\n    const visible = this.getVisible();\r\n    for(const target of visible) {\r\n      this.items.set(target, false);\r\n    }\r\n  }\r\n\r\n  public isVisible(target: TargetType) {\r\n    return this.items.get(target);\r\n  }\r\n\r\n  public disconnect() {\r\n    this.observer.disconnect();\r\n    this.items.clear();\r\n  }\r\n\r\n  public refresh() {\r\n    this.observer.disconnect();\r\n\r\n    //window.requestAnimationFrame(() => {\r\n      const targets = [...this.items.keys()];\r\n      for(const target of targets) {\r\n        //this.items.set(target, false);\r\n        this.observer.observe(target);\r\n      }\r\n    //});\r\n  }\r\n\r\n  public refreshVisible() {\r\n    const visible = this.getVisible();\r\n    for(const target of visible) {\r\n      this.observer.unobserve(target);\r\n    }\r\n\r\n    for(const target of visible) {\r\n      this.observer.observe(target);\r\n    }\r\n  }\r\n\r\n  public observe(target: TargetType) {\r\n    this.items.set(target, false);\r\n    this.observer.observe(target);\r\n  }\r\n\r\n  public unobserve(target: TargetType) {\r\n    this.observer.unobserve(target);\r\n    this.items.delete(target);\r\n  }\r\n\r\n  public unlock() {\r\n    this.locked = false;\r\n  }\r\n\r\n  public unlockAndRefresh() {\r\n    this.unlock();\r\n    this.refresh();\r\n  }\r\n\r\n  public lock() {\r\n    this.locked = true;\r\n  }\r\n}\r\n","export default function findAndSpliceAll<T>(array: Array<T>, verify: (value: T, index: number, arr: typeof array) => boolean) {\r\n  const out: typeof array = [];\r\n  let idx = -1;\r\n  while((idx = array.findIndex(verify)) !== -1) {\r\n    out.push(array.splice(idx, 1)[0]);\r\n  }\r\n\r\n  return out;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport findAndSpliceAll from \"../helpers/array/findAndSpliceAll\";\r\nimport LazyLoadQueueBase, { LazyLoadElementBase } from \"./lazyLoadQueueBase\";\r\nimport VisibilityIntersector from \"./visibilityIntersector\";\r\n\r\nexport type LazyLoadElement = Omit<LazyLoadElementBase, 'load'> & {\r\n  load: (target?: HTMLElement) => Promise<any>,\r\n  div: HTMLElement\r\n  wasSeen?: boolean,\r\n};\r\n\r\nexport default class LazyLoadQueueIntersector extends LazyLoadQueueBase {\r\n  protected queue: Array<LazyLoadElement> = [];\r\n  protected inProcess: Set<LazyLoadElement> = new Set();\r\n\r\n  public intersector: VisibilityIntersector;\r\n  protected intersectorTimeout: number;\r\n\r\n  constructor(parallelLimit?: number) {\r\n    super(parallelLimit);\r\n  }\r\n\r\n  public lock() {\r\n    super.lock();\r\n    this.intersector.lock();\r\n  }\r\n\r\n  public unlock() {\r\n    super.unlock();\r\n    this.intersector.unlock();\r\n  }\r\n\r\n  public unlockAndRefresh() {\r\n    super.unlock();\r\n    this.intersector.unlockAndRefresh();\r\n  }\r\n\r\n  public clear() {\r\n    super.clear();\r\n    this.intersector.disconnect();\r\n  }\r\n\r\n  public refresh() {\r\n    this.intersector.refresh();\r\n  }\r\n\r\n  protected loadItem(item: LazyLoadElement) {\r\n    return item.load(item.div);\r\n  }\r\n\r\n  protected addElement(method: 'push' | 'unshift', el: LazyLoadElement) {\r\n    const item = this.queue.find((i) => i.div === el.div && i.load === el.load);\r\n    if(item) {\r\n      return false;\r\n    } else {\r\n      for(const item of this.inProcess) {\r\n        if(item.div === el.div && item.load === el.load) {\r\n          return false;\r\n        }\r\n      }\r\n    }\r\n\r\n    this.queue[method](el);\r\n    return true;\r\n  }\r\n\r\n  protected setProcessQueueTimeout() {\r\n    if(!this.intersectorTimeout) {\r\n      this.intersectorTimeout = window.setTimeout(() => {\r\n        this.intersectorTimeout = 0;\r\n        this.processQueue();\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  public push(el: LazyLoadElement) {\r\n    super.push(el);\r\n  }\r\n\r\n  public unshift(el: LazyLoadElement) {\r\n    super.unshift(el);\r\n  }\r\n\r\n  public unobserve(el: HTMLElement) {\r\n    findAndSpliceAll(this.queue, (i) => i.div === el);\r\n\r\n    this.intersector.unobserve(el);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport VisibilityIntersector, { OnVisibilityChangeItem } from \"./visibilityIntersector\";\r\nimport findAndSpliceAll from \"../helpers/array/findAndSpliceAll\";\r\nimport findAndSplice from \"../helpers/array/findAndSplice\";\r\nimport LazyLoadQueueIntersector, { LazyLoadElement } from \"./lazyLoadQueueIntersector\";\r\n\r\nexport default class LazyLoadQueue extends LazyLoadQueueIntersector {\r\n  constructor(parallelLimit?: number) {\r\n    super(parallelLimit);\r\n\r\n    this.intersector = new VisibilityIntersector(this.onVisibilityChange);\r\n  }\r\n\r\n  private onVisibilityChange = ({target, visible}: OnVisibilityChangeItem) => {\r\n    if(visible) {\r\n      /* if(DEBUG) {\r\n        this.log('isIntersecting', target);\r\n      } */\r\n\r\n      // need for set element first if scrolled\r\n      findAndSpliceAll(this.queue, (i) => i.div === target).forEach((item) => {\r\n        item.wasSeen = true;\r\n        this.queue.unshift(item);\r\n        //this.processQueue(item);\r\n      });\r\n\r\n      this.setProcessQueueTimeout();\r\n    }\r\n  };\r\n\r\n  protected getItem() {\r\n    return findAndSplice(this.queue, item => item.wasSeen);\r\n  }\r\n\r\n  public async processItem(item: LazyLoadElement) {\r\n    await super.processItem(item);\r\n    this.intersector.unobserve(item.div);\r\n  }\r\n\r\n  protected addElement(method: 'push' | 'unshift', el: LazyLoadElement) {\r\n    const inserted = super.addElement(method, el);\r\n\r\n    if(!inserted) return false;\r\n\r\n    this.intersector.observe(el.div);\r\n    /* if(el.wasSeen) {\r\n      this.processQueue(el);\r\n    } else  */if(!el.hasOwnProperty('wasSeen')) {\r\n      el.wasSeen = false;\r\n    }\r\n    \r\n    return true;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../../appDocsManager\";\r\nimport type { MyPhoto } from \"../../appPhotosManager\";\r\nimport type { PhotoSize, WebDocument } from \"../../../../layer\";\r\nimport calcImageInBox from \"../../../../helpers/calcImageInBox\";\r\n\r\nexport default function choosePhotoSize(\r\n  photo: MyPhoto | MyDocument | WebDocument, \r\n  boxWidth = 0, \r\n  boxHeight = 0, \r\n  useBytes = false, \r\n  pushDocumentSize = false\r\n) {\r\n  if(window.devicePixelRatio > 1) {\r\n    boxWidth *= 2;\r\n    boxHeight *= 2;\r\n  }\r\n  \r\n  /*\r\n  s\tbox\t100x100\r\n  m\tbox\t320x320\r\n  x\tbox\t800x800\r\n  y\tbox\t1280x1280\r\n  w\tbox\t2560x2560\r\n  a\tcrop\t160x160\r\n  b\tcrop\t320x320\r\n  c\tcrop\t640x640\r\n  d\tcrop\t1280x1280 */\r\n\r\n  let bestPhotoSize: PhotoSize = {_: 'photoSizeEmpty', type: ''};\r\n  let sizes = (photo as MyPhoto).sizes || (photo as MyDocument).thumbs as PhotoSize[];\r\n  if(pushDocumentSize && sizes && photo._ !== 'photo') {\r\n    sizes = sizes.concat({\r\n      _: 'photoSize', \r\n      w: photo.w, \r\n      h: photo.h, \r\n      size: photo.size, \r\n      type: undefined\r\n    });\r\n  }\r\n\r\n  if(sizes?.length) {\r\n    for(let i = 0, length = sizes.length; i < length; ++i) {\r\n      const photoSize = sizes[i];\r\n      if(!('w' in photoSize) && !('h' in photoSize)) continue;\r\n\r\n      bestPhotoSize = photoSize;\r\n\r\n      const size = calcImageInBox(photoSize.w, photoSize.h, boxWidth, boxHeight);\r\n      if(size.width >= boxWidth || size.height >= boxHeight) {\r\n        break;\r\n      }\r\n    }\r\n\r\n    if(useBytes && bestPhotoSize._ === 'photoSizeEmpty' && sizes[0]._ === 'photoStrippedSize') {\r\n      bestPhotoSize = sizes[0];\r\n    }\r\n  }\r\n  \r\n  return bestPhotoSize;\r\n}\r\n","export default function accumulate(arr: number[], initialValue: number) {\r\n  return arr.reduce((acc, value) => acc + value, initialValue);\r\n}\r\n","/*\r\nThis file is part of Telegram Desktop,\r\nthe official desktop application for the Telegram messaging service.\r\nFor license and copyright information please follow this link:\r\nhttps://github.com/telegramdesktop/tdesktop/blob/master/LEGAL\r\n*/\r\n\r\nimport accumulate from \"../helpers/array/accumulate\";\r\nimport clamp from \"../helpers/number/clamp\";\r\n\r\ntype Size = {w: number, h: number};\r\nexport type GroupMediaLayout = {\r\n  geometry: {\r\n    x: number,\r\n    y: number,\r\n    width: number,\r\n    height: number\r\n  },\r\n  sides: number\r\n};\r\ntype Attempt = {\r\n  lineCounts: number[],\r\n  heights: number[]\r\n};\r\nexport const RectPart = {\r\n  None: 0,\r\n  Top: 1,\r\n  Right: 2,\r\n  Bottom: 4,\r\n  Left: 8\r\n};\r\n\r\n// https://github.com/telegramdesktop/tdesktop/blob/4669c07dc5335cbf4795bbbe5b0ab7c007b9aee2/Telegram/SourceFiles/ui/grouped_layout.cpp\r\nexport class Layouter {\r\n  private count: number;\r\n  private ratios: number[];\r\n  private proportions: string;\r\n  private averageRatio: number;\r\n  private maxSizeRatio: number;\r\n\r\n  constructor(private sizes: Size[], private maxWidth: number, private minWidth: number, private spacing: number, private maxHeight = maxWidth) {\r\n    this.count = sizes.length;\r\n    this.ratios = Layouter.countRatios(sizes);\r\n    this.proportions = Layouter.countProportions(this.ratios);\r\n    this.averageRatio = accumulate(this.ratios, 1) / this.count; // warn\r\n    this.maxSizeRatio = maxWidth / this.maxHeight;\r\n  }\r\n\r\n  public layout(): GroupMediaLayout[] {\r\n    if(!this.count) return [];\r\n    //else if(this.count === 1) return this.layoutOne();\r\n\r\n    if(this.count >= 5 || this.ratios.find((r) => r > 2)) {\r\n      return new ComplexLayouter(this.ratios, this.averageRatio, this.maxWidth, this.minWidth, this.spacing).layout();\r\n    }\r\n\r\n    if(this.count === 2) return this.layoutTwo();\r\n    else if(this.count === 3) return this.layoutThree();\r\n    return this.layoutFour();\r\n  }\r\n\r\n  private layoutTwo(): ReturnType<Layouter['layout']> {\r\n    if((this.proportions === \"ww\")\r\n      && (this.averageRatio > 1.4 * this.maxSizeRatio)\r\n      && (this.ratios[1] - this.ratios[0] < 0.2)) {\r\n      return this.layoutTwoTopBottom();\r\n    } else if(this.proportions === \"ww\" || this.proportions === \"qq\") {\r\n      return this.layoutTwoLeftRightEqual();\r\n    }\r\n    return this.layoutTwoLeftRight();\r\n  }\r\n\r\n  private layoutThree(): ReturnType<Layouter['layout']> {\r\n    //console.log('layoutThree:', this);\r\n    if(this.proportions[0] === 'n') {\r\n      return this.layoutThreeLeftAndOther();\r\n    }\r\n    return this.layoutThreeTopAndOther();\r\n  }\r\n\r\n  private layoutFour(): ReturnType<Layouter['layout']> {\r\n    if(this.proportions[0] === 'w') {\r\n      return this.layoutFourTopAndOther();\r\n    }\r\n    return this.layoutFourLeftAndOther();\r\n  }\r\n\r\n  private layoutTwoTopBottom(): ReturnType<Layouter['layout']> {\r\n    const width = this.maxWidth;\r\n    const height = Math.round(Math.min(\r\n      width / this.ratios[0],\r\n      Math.min(\r\n        width / this.ratios[1],\r\n        (this.maxHeight - this.spacing) / 2)));\r\n  \r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width, height},\r\n        sides: RectPart.Left | RectPart.Top | RectPart.Right\r\n      },\r\n      {\r\n        geometry: {x: 0, y: height + this.spacing, width, height},\r\n        sides: RectPart.Left | RectPart.Bottom | RectPart.Right\r\n      },\r\n    ];\r\n  }\r\n\r\n  private layoutTwoLeftRightEqual(): ReturnType<Layouter['layout']> {\r\n    const width = (this.maxWidth - this.spacing) / 2;\r\n    const height = Math.round(Math.min(\r\n      width / this.ratios[0],\r\n      Math.min(width / this.ratios[1], this.maxHeight * 1)));\r\n  \r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width, height},\r\n        sides: RectPart.Top | RectPart.Left | RectPart.Bottom\r\n      },\r\n      {\r\n        geometry: {x: width + this.spacing, y: 0, width, height},\r\n        sides: RectPart.Top | RectPart.Right | RectPart.Bottom\r\n      },\r\n    ];\r\n  }\r\n\r\n  private layoutTwoLeftRight(): ReturnType<Layouter['layout']> {\r\n    const minimalWidth = Math.round(this.minWidth * 1.5);\r\n    const secondWidth = Math.min(\r\n      Math.round(Math.max(\r\n        0.4 * (this.maxWidth - this.spacing),\r\n        (this.maxWidth - this.spacing) / this.ratios[0]\r\n          / (1 / this.ratios[0] + 1 / this.ratios[1]))),\r\n      this.maxWidth - this.spacing - minimalWidth);\r\n    const firstWidth = this.maxWidth\r\n      - secondWidth\r\n      - this.spacing;\r\n    const height = Math.min(\r\n      this.maxHeight,\r\n      Math.round(Math.min(\r\n        firstWidth / this.ratios[0],\r\n        secondWidth / this.ratios[1])));\r\n  \r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width: firstWidth, height},\r\n        sides: RectPart.Top | RectPart.Left | RectPart.Bottom\r\n      },\r\n      {\r\n        geometry: {x: firstWidth + this.spacing, y: 0, width: secondWidth, height},\r\n        sides: RectPart.Top | RectPart.Right | RectPart.Bottom\r\n      },\r\n    ];\r\n  }\r\n\r\n  private layoutThreeLeftAndOther(): ReturnType<Layouter['layout']> {\r\n    const firstHeight = this.maxHeight;\r\n    const thirdHeight = Math.round(Math.min(\r\n      (this.maxHeight - this.spacing) / 2.,\r\n      (this.ratios[1] * (this.maxWidth - this.spacing)\r\n        / (this.ratios[2] + this.ratios[1]))));\r\n    const secondHeight = firstHeight\r\n      - thirdHeight\r\n      - this.spacing;\r\n    const rightWidth = Math.max(\r\n      this.minWidth,\r\n      Math.round(Math.min(\r\n        (this.maxWidth - this.spacing) / 2.,\r\n        Math.min(\r\n          thirdHeight * this.ratios[2],\r\n          secondHeight * this.ratios[1]))));\r\n    const leftWidth = Math.min(\r\n      Math.round(firstHeight * this.ratios[0]),\r\n      this.maxWidth - this.spacing - rightWidth);\r\n\r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width: leftWidth, height: firstHeight},\r\n        sides: RectPart.Top | RectPart.Left | RectPart.Bottom\r\n      },\r\n      {\r\n        geometry: {x: leftWidth + this.spacing, y: 0, width: rightWidth, height: secondHeight},\r\n        sides: RectPart.Top | RectPart.Right\r\n      },\r\n      {\r\n        geometry: {x: leftWidth + this.spacing, y: secondHeight + this.spacing, width: rightWidth, height: thirdHeight},\r\n        sides: RectPart.Bottom | RectPart.Right\r\n      },\r\n    ];\r\n  }\r\n  \r\n  private layoutThreeTopAndOther(): ReturnType<Layouter['layout']> {\r\n    const firstWidth = this.maxWidth;\r\n    const firstHeight = Math.round(Math.min(\r\n      firstWidth / this.ratios[0],\r\n      (this.maxHeight - this.spacing) * 0.66));\r\n    const secondWidth = (this.maxWidth - this.spacing) / 2;\r\n    const secondHeight = Math.min(\r\n      this.maxHeight - firstHeight - this.spacing,\r\n      Math.round(Math.min(\r\n        secondWidth / this.ratios[1],\r\n        secondWidth / this.ratios[2])));\r\n    const thirdWidth = firstWidth - secondWidth - this.spacing;\r\n  \r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width: firstWidth, height: firstHeight},\r\n        sides: RectPart.Left | RectPart.Top | RectPart.Right\r\n      },\r\n      {\r\n        geometry: {x: 0, y: firstHeight + this.spacing, width: secondWidth, height: secondHeight},\r\n        sides: RectPart.Bottom | RectPart.Left\r\n      },\r\n      {\r\n        geometry: {x: secondWidth + this.spacing, y: firstHeight + this.spacing, width: thirdWidth, height: secondHeight},\r\n        sides: RectPart.Bottom | RectPart.Right\r\n      },\r\n    ];\r\n  }\r\n\r\n  private layoutFourTopAndOther(): ReturnType<Layouter['layout']> {\r\n    const w = this.maxWidth;\r\n    const h0 = Math.round(Math.min(\r\n      w / this.ratios[0],\r\n      (this.maxHeight - this.spacing) * 0.66));\r\n    const h = Math.round(\r\n      (this.maxWidth - 2 * this.spacing)\r\n        / (this.ratios[1] + this.ratios[2] + this.ratios[3]));\r\n    const w0 = Math.max(\r\n      this.minWidth,\r\n      Math.round(Math.min(\r\n        (this.maxWidth - 2 * this.spacing) * 0.4,\r\n        h * this.ratios[1])));\r\n    const w2 = Math.round(Math.max(\r\n      Math.max(\r\n        this.minWidth * 1.,\r\n        (this.maxWidth - 2 * this.spacing) * 0.33),\r\n      h * this.ratios[3]));\r\n    const w1 = w - w0 - w2 - 2 * this.spacing;\r\n    const h1 = Math.min(\r\n      this.maxHeight - h0 - this.spacing,\r\n      h);\r\n  \r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width: w, height: h0},\r\n        sides: RectPart.Left | RectPart.Top | RectPart.Right\r\n      },\r\n      {\r\n        geometry: {x: 0, y: h0 + this.spacing, width: w0, height: h1},\r\n        sides: RectPart.Bottom | RectPart.Left\r\n      },\r\n      {\r\n        geometry: {x: w0 + this.spacing, y: h0 + this.spacing, width: w1, height: h1},\r\n        sides: RectPart.Bottom,\r\n      },\r\n      {\r\n        geometry: {x: w0 + this.spacing + w1 + this.spacing, y: h0 + this.spacing, width: w2, height: h1},\r\n        sides: RectPart.Right | RectPart.Bottom\r\n      },\r\n    ];\r\n  }\r\n\r\n  private layoutFourLeftAndOther(): ReturnType<Layouter['layout']> {\r\n    const h = this.maxHeight;\r\n    const w0 = Math.round(Math.min(\r\n      h * this.ratios[0],\r\n      (this.maxWidth - this.spacing) * 0.6));\r\n  \r\n    const w = Math.round(\r\n      (this.maxHeight - 2 * this.spacing)\r\n        / (1. / this.ratios[1] + 1. / this.ratios[2] + 1. / this.ratios[3])\r\n    );\r\n    const h0 = Math.round(w / this.ratios[1]);\r\n    const h1 = Math.round(w / this.ratios[2]);\r\n    const h2 = h - h0 - h1 - 2 * this.spacing;\r\n    const w1 = Math.max(\r\n      this.minWidth,\r\n      Math.min(this.maxWidth - w0 - this.spacing, w));\r\n  \r\n    return [\r\n      {\r\n        geometry: {x: 0, y: 0, width: w0, height: h},\r\n        sides: RectPart.Top | RectPart.Left | RectPart.Bottom\r\n      },\r\n      {\r\n        geometry: {x: w0 + this.spacing, y: 0, width: w1, height: h0},\r\n        sides: RectPart.Top | RectPart.Right\r\n      },\r\n      {\r\n        geometry: {x: w0 + this.spacing, y: h0 + this.spacing, width: w1, height: h1},\r\n        sides: RectPart.Right\r\n      },\r\n      {\r\n        geometry: {x: w0 + this.spacing, y: h0 + h1 + 2 * this.spacing, width: w1, height: h2},\r\n        sides: RectPart.Bottom | RectPart.Right\r\n      },\r\n    ];\r\n  }\r\n\r\n  private static countRatios(sizes: Size[]) {\r\n    return sizes.map((size) => size.w / size.h);\r\n  }\r\n\r\n  private static countProportions(ratios: number[]) {\r\n    return ratios.map((ratio) => (ratio > 1.2) ? 'w' : (ratio < 0.8) ? 'n' : 'q').join('');\r\n  }\r\n}\r\n\r\nclass ComplexLayouter {\r\n  private ratios: number[];\r\n  private count: number;\r\n\r\n  constructor(ratios: number[], private averageRatio: number, private maxWidth: number, private minWidth: number, private spacing: number, private maxHeight = maxWidth * 4 / 3) {\r\n    this.ratios = ComplexLayouter.cropRatios(ratios, averageRatio);\r\n    this.count = ratios.length;\r\n  }\r\n\r\n  private static cropRatios(ratios: number[], averageRatio: number) {\r\n    const kMaxRatio = 2.75;\r\n    const kMinRatio = 0.6667;\r\n    return ratios.map((ratio) => {\r\n      return averageRatio > 1.1\r\n\t\t\t  ? clamp(ratio, 1., kMaxRatio)\r\n\t\t\t  : clamp(ratio, kMinRatio, 1.);\r\n    });\r\n  }\r\n\r\n  public layout(): GroupMediaLayout[] {\r\n    let result = new Array<GroupMediaLayout>(this.count);\r\n\r\n    let attempts: Attempt[] = [];\r\n    const multiHeight = (offset: number, count: number) => {\r\n      const ratios = this.ratios.slice(offset, offset + count); // warn\r\n      const sum = accumulate(ratios, 0);\r\n      return (this.maxWidth - (count - 1) * this.spacing) / sum;\r\n    };\r\n    const pushAttempt = (lineCounts: number[]) => {\r\n      let heights: number[] = [];\r\n      let offset = 0;\r\n      for(let count of lineCounts) {\r\n        heights.push(multiHeight(offset, count));\r\n        offset += count;\r\n      }\r\n      attempts.push({lineCounts, heights}); // warn\r\n    };\r\n\r\n    for(let first = 1; first !== this.count; ++first) {\r\n      const second = this.count - first;\r\n      if(first > 3 || second > 3) {\r\n        continue;\r\n      }\r\n      pushAttempt([first, second]);\r\n    }\r\n    for(let first = 1; first !== this.count - 1; ++first) {\r\n      for(let second = 1; second !== this.count - first; ++second) {\r\n        const third = this.count - first - second;\r\n        if((first > 3)\r\n          || (second > ((this.averageRatio < 0.85) ? 4 : 3))\r\n          || (third > 3)) {\r\n          continue;\r\n        }\r\n        pushAttempt([first, second, third]);\r\n      }\r\n    }\r\n    for(let first = 1; first !== this.count - 1; ++first) {\r\n      for(let second = 1; second !== this.count - first; ++second) {\r\n        for(let third = 1; third !== this.count - first - second; ++third) {\r\n          const fourth = this.count - first - second - third;\r\n          if(first > 3 || second > 3 || third > 3 || fourth > 3) {\r\n            continue;\r\n          }\r\n          pushAttempt([first, second, third, fourth]);\r\n        }\r\n      }\r\n    }\r\n\r\n    let optimalAttempt: Attempt = null;\r\n    let optimalDiff = 0;\r\n    for(const attempt of attempts) {\r\n      const {heights, lineCounts: counts} = attempt;\r\n      const lineCount = counts.length;\r\n      const totalHeight = accumulate(heights, 0) \r\n        + this.spacing * (lineCount - 1);\r\n      const minLineHeight = Math.min(...heights);\r\n      const maxLineHeight = Math.max(...heights);\r\n      const bad1 = (minLineHeight < this.minWidth) ? 1.5 : 1;\r\n      const bad2 = (() => {\r\n        for(let line = 1; line !== lineCount; ++line) {\r\n          if(counts[line - 1] > counts[line]) {\r\n            return 1.5;\r\n          }\r\n        }\r\n        return 1.;\r\n      })();\r\n      const diff = Math.abs(totalHeight - this.maxHeight) * bad1 * bad2;\r\n      if(!optimalAttempt || diff < optimalDiff) {\r\n        optimalAttempt = attempt;\r\n        optimalDiff = diff;\r\n      }\r\n    }\r\n\r\n    const optimalCounts = optimalAttempt.lineCounts;\r\n\t  const optimalHeights = optimalAttempt.heights;\r\n    const rowCount = optimalCounts.length;\r\n    \r\n    let index = 0;\r\n    let y = 0;\r\n    for(let row = 0; row !== rowCount; ++row) {\r\n      const colCount = optimalCounts[row];\r\n      const lineHeight = optimalHeights[row];\r\n      const height = Math.round(lineHeight);\r\n\r\n      let x = 0;\r\n      for(let col = 0; col !== colCount; ++col) {\r\n        const sides = RectPart.None\r\n          | (row === 0 ? RectPart.Top : RectPart.None)\r\n          | (row === rowCount - 1 ? RectPart.Bottom : RectPart.None)\r\n          | (col === 0 ? RectPart.Left : RectPart.None)\r\n          | (col === colCount - 1 ? RectPart.Right : RectPart.None);\r\n\r\n        const ratio = this.ratios[index];\r\n        const width = (col === colCount - 1)\r\n          ? (this.maxWidth - x)\r\n          : Math.round(ratio * lineHeight);\r\n        result[index] = {\r\n          geometry: {x, y, width, height},\r\n          sides\r\n        };\r\n\r\n        x += width + this.spacing;\r\n        ++index;\r\n      }\r\n      y += height + this.spacing;\r\n    }\r\n\r\n    return result;\r\n  }\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Layouter, RectPart } from \"./groupedLayout\";\r\n\r\nexport default function prepareAlbum(options: {\r\n  container: HTMLElement,\r\n  items: {w: number, h: number}[],\r\n  maxWidth: number,\r\n  minWidth: number,\r\n  spacing: number,\r\n  maxHeight?: number,\r\n  forMedia?: true\r\n}) {\r\n  const layouter = new Layouter(options.items, options.maxWidth, options.minWidth, options.spacing, options.maxHeight);\r\n  const layout = layouter.layout();\r\n\r\n  const widthItem = layout.find((item) => item.sides & RectPart.Right);\r\n  const width = widthItem.geometry.width + widthItem.geometry.x;\r\n\r\n  const heightItem = layout.find((item) => item.sides & RectPart.Bottom);\r\n  const height = heightItem.geometry.height + heightItem.geometry.y;\r\n\r\n  const container = options.container;\r\n  container.style.width = width + 'px';\r\n  container.style.height = height + 'px';\r\n  const children = container.children;\r\n\r\n  layout.forEach(({geometry, sides}, idx) => {\r\n    let div: HTMLElement;\r\n    div = children[idx] as HTMLElement;\r\n    if(!div) {\r\n      div = document.createElement('div');\r\n      container.append(div);\r\n    }\r\n\r\n    div.classList.add('album-item', 'grouped-item');\r\n\r\n    div.style.width = (geometry.width / width * 100) + '%';\r\n    div.style.height = (geometry.height / height * 100) + '%';\r\n    div.style.top = (geometry.y / height * 100) + '%';\r\n    div.style.left = (geometry.x / width * 100) + '%';\r\n\r\n    if(sides & RectPart.Left && sides & RectPart.Top) {\r\n      div.style.borderTopLeftRadius = 'inherit';\r\n    }\r\n\r\n    if(sides & RectPart.Left && sides & RectPart.Bottom) {\r\n      div.style.borderBottomLeftRadius = 'inherit';\r\n    }\r\n\r\n    if(sides & RectPart.Right && sides & RectPart.Top) {\r\n      div.style.borderTopRightRadius = 'inherit';\r\n    }\r\n\r\n    if(sides & RectPart.Right && sides & RectPart.Bottom) {\r\n      div.style.borderBottomRightRadius = 'inherit';\r\n    }\r\n\r\n    if(options.forMedia) {\r\n      const mediaDiv = document.createElement('div');\r\n      mediaDiv.classList.add('album-item-media');\r\n  \r\n      div.append(mediaDiv);\r\n    }\r\n\r\n    // @ts-ignore\r\n    //div.style.backgroundColor = '#' + Math.floor(Math.random() * (2 ** 24 - 1)).toString(16).padStart(6, '0');\r\n  });\r\n\r\n  /* if(options.forMedia) {\r\n    layout.forEach((_, i) => {\r\n      const mediaDiv = document.createElement('div');\r\n      mediaDiv.classList.add('album-item-media');\r\n  \r\n      options.container.children[i].append(mediaDiv);\r\n    });\r\n  } */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// import { getHeavyAnimationPromise } from \"../../hooks/useHeavyAnimationCheck\";\r\n\r\nexport const loadedURLs: {[url: string]: boolean} = {};\r\nconst set = (elem: HTMLElement | HTMLImageElement | SVGImageElement | HTMLVideoElement, url: string) => {\r\n  if(elem instanceof HTMLImageElement || elem instanceof HTMLVideoElement) elem.src = url;\r\n  else if(elem instanceof SVGImageElement) elem.setAttributeNS(null, 'href', url);\r\n  else elem.style.backgroundImage = 'url(' + url + ')';\r\n};\r\n\r\n//    ,      ,    blob',      'load'  .\r\nexport default function renderImageFromUrl(\r\n  elem: HTMLElement | HTMLImageElement | SVGImageElement | HTMLVideoElement, \r\n  url: string, \r\n  callback?: () => void, \r\n  useCache = true\r\n) {\r\n  if(!url) {\r\n    console.error('renderImageFromUrl: no url?', elem, url);\r\n    callback && callback();\r\n    return;\r\n  }\r\n\r\n  if(((loadedURLs[url]/*  && false */) && useCache) || elem instanceof HTMLVideoElement) {\r\n    if(elem) {\r\n      set(elem, url);\r\n    }\r\n    \r\n    callback && callback();\r\n    // callback && getHeavyAnimationPromise().then(() => callback());\r\n  } else {\r\n    const isImage = elem instanceof HTMLImageElement;\r\n    const loader = isImage ? elem as HTMLImageElement : new Image();\r\n    //const loader = new Image();\r\n    loader.src = url;\r\n    //let perf = performance.now();\r\n    loader.addEventListener('load', () => {\r\n      if(!isImage && elem) {\r\n        set(elem, url);\r\n      }\r\n\r\n      loadedURLs[url] = true;\r\n      //console.log('onload:', url, performance.now() - perf);\r\n      // TODO:      ,       \r\n      // callback && getHeavyAnimationPromise().then(() => callback());\r\n      callback && callback();\r\n    }, {once: true});\r\n\r\n    if(callback) {\r\n      loader.addEventListener('error', (err) => {\r\n        console.error('Render image from url failed:', err, url, loader);\r\n        callback();\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\nexport function renderImageFromUrlPromise(elem: Parameters<typeof renderImageFromUrl>[0], url: string, useCache?: boolean) {\r\n  return new Promise<void>((resolve) => {\r\n    renderImageFromUrl(elem, url, resolve, useCache);\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport sequentialDom from \"../sequentialDom\";\r\nimport renderImageFromUrl from \"./renderImageFromUrl\";\r\n\r\nexport default function renderImageWithFadeIn(\r\n  container: HTMLElement, \r\n  image: HTMLImageElement, \r\n  url: string, \r\n  needFadeIn: boolean, \r\n  aspecter = container,\r\n  thumbImage?: HTMLElement\r\n) {\r\n  if(needFadeIn) {\r\n    image.classList.add('fade-in');\r\n  }\r\n\r\n  const promise = new Promise<void>((resolve) => {\r\n    /* if(photo._ === 'document') {\r\n      console.error('wrapPhoto: will render document', photo, size, cacheContext);\r\n      return resolve();\r\n    } */\r\n\r\n    renderImageFromUrl(image, url, () => {\r\n      sequentialDom.mutateElement(container, () => {\r\n        aspecter.append(image);\r\n\r\n        resolve();\r\n        /* fastRaf(() => {\r\n          resolve();\r\n        }); */\r\n\r\n        if(needFadeIn) {\r\n          image.addEventListener('animationend', () => {\r\n            sequentialDom.mutate(() => {\r\n              image.classList.remove('fade-in');\r\n              thumbImage?.remove();\r\n            });\r\n          }, {once: true});\r\n        } else {\r\n          thumbImage?.remove();\r\n        }\r\n      });\r\n    });\r\n  });\r\n\r\n  // recordPromise(promise, 'renderImageWithFadeIn');\r\n\r\n  return promise;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../lib/rootScope\";\r\n\r\nconst SetTransition = (\r\n  element: HTMLElement, \r\n  className: string, \r\n  forwards: boolean, \r\n  duration: number, \r\n  onTransitionEnd?: () => void, \r\n  useRafs?: number\r\n) => {\r\n  const {timeout, raf} = element.dataset;\r\n  if(timeout !== undefined) {\r\n    clearTimeout(+timeout);\r\n  }\r\n\r\n  // useRafs = undefined;\r\n  // duration = 0;\r\n\r\n  if(raf !== undefined) {\r\n    window.cancelAnimationFrame(+raf);\r\n    if(!useRafs) {\r\n      delete element.dataset.raf;\r\n    }\r\n  }\r\n\r\n  // if(forwards && className && element.classList.contains(className) && !element.classList.contains('animating')) {\r\n  //   return;\r\n  // }\r\n\r\n  if(useRafs && rootScope.settings.animationsEnabled && duration) {\r\n    element.dataset.raf = '' + window.requestAnimationFrame(() => {\r\n      delete element.dataset.raf;\r\n      SetTransition(element, className, forwards, duration, onTransitionEnd, useRafs - 1);\r\n    });\r\n\r\n    return;\r\n  }\r\n\r\n  if(forwards && className) {\r\n    element.classList.add(className);\r\n  }\r\n\r\n  const afterTimeout = () => {\r\n    delete element.dataset.timeout;\r\n    if(!forwards && className) {\r\n      element.classList.remove('backwards', className);\r\n    }\r\n\r\n    element.classList.remove('animating');\r\n    \r\n    onTransitionEnd && onTransitionEnd();\r\n  };\r\n\r\n  if(!rootScope.settings.animationsEnabled || !duration) {\r\n    element.classList.remove('animating', 'backwards');\r\n    afterTimeout();\r\n    return;\r\n  }\r\n\r\n  element.classList.add('animating');\r\n\r\n  element.classList.toggle('backwards', !forwards);\r\n  element.dataset.timeout = '' + setTimeout(afterTimeout, duration);\r\n};\r\n\r\nexport default SetTransition;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { CancellablePromise } from \"../helpers/cancellablePromise\";\r\nimport SetTransition from \"./singleTransition\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport isInDOM from \"../helpers/dom/isInDOM\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\n\r\nconst TRANSITION_TIME = 200;\r\n\r\nexport default class ProgressivePreloader {\r\n  public preloader: HTMLDivElement;\r\n  public circle: SVGCircleElement;\r\n  private cancelSvg: SVGSVGElement;\r\n  private downloadSvg: HTMLElement;\r\n  \r\n  private tempId = 0;\r\n  public detached = true;\r\n\r\n  public promise: CancellablePromise<any> = null;\r\n\r\n  public isUpload = false;\r\n  private cancelable = true;\r\n  private streamable = false;\r\n  private tryAgainOnFail = true;\r\n  private attachMethod: 'append' | 'prepend' = 'append';\r\n\r\n  public loadFunc: (e?: Event) => any;\r\n\r\n  public totalLength: number;\r\n\r\n  constructor(options?: Partial<{\r\n    isUpload: ProgressivePreloader['isUpload'],\r\n    cancelable: ProgressivePreloader['cancelable'], \r\n    streamable: ProgressivePreloader['streamable'], \r\n    tryAgainOnFail: ProgressivePreloader['tryAgainOnFail'],\r\n    attachMethod: ProgressivePreloader['attachMethod']\r\n  }>) {\r\n    if(options) {\r\n      safeAssign(this, options);\r\n    }\r\n\r\n    if(this.isUpload) {\r\n      this.tryAgainOnFail = false;\r\n    }\r\n  }\r\n\r\n  public constructContainer(options: Partial<{\r\n    color: 'transparent',\r\n    bold: boolean\r\n  }> = {}) {\r\n    if(!this.preloader) {\r\n      this.preloader = document.createElement('div');\r\n      this.preloader.classList.add('preloader-container');\r\n\r\n      if(options.color) {\r\n        this.preloader.classList.add('preloader-' + options.color);\r\n      }\r\n\r\n      if(options.bold) {\r\n        this.preloader.classList.add('preloader-bold');\r\n      }\r\n  \r\n      if(this.streamable) {\r\n        this.preloader.classList.add('preloader-streamable');\r\n      }\r\n    }\r\n  }\r\n\r\n  public constructDownloadIcon() {\r\n    this.constructContainer();\r\n  }\r\n\r\n  public construct() {\r\n    this.construct = null;\r\n\r\n    this.constructContainer();\r\n    \r\n    this.preloader.innerHTML = `\r\n    <div class=\"you-spin-me-round\">\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"preloader-circular\" viewBox=\"${this.streamable ? '25 25 50 50' : '27 27 54 54'}\">\r\n    <circle class=\"preloader-path-new\" cx=\"${this.streamable ? '50' : '54'}\" cy=\"${this.streamable ? '50' : '54'}\" r=\"${this.streamable ? 19 : 24}\" fill=\"none\" stroke-miterlimit=\"10\"/>\r\n    </svg>\r\n    </div>`;\r\n\r\n    if(this.streamable) {\r\n      this.totalLength = 118.61124420166016;\r\n    } else {\r\n      this.totalLength = 149.82473754882812;\r\n    }\r\n\r\n    if(this.cancelable) {\r\n      this.preloader.innerHTML += `\r\n      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"preloader-close\" viewBox=\"0 0 24 24\">\r\n        <g fill=\"none\" fill-rule=\"evenodd\">\r\n          <polygon points=\"0 0 24 0 24 24 0 24\"/>\r\n          <path fill=\"#000\" fill-rule=\"nonzero\" d=\"M5.20970461,5.38710056 L5.29289322,5.29289322 C5.65337718,4.93240926 6.22060824,4.90467972 6.61289944,5.20970461 L6.70710678,5.29289322 L12,10.585 L17.2928932,5.29289322 C17.6834175,4.90236893 18.3165825,4.90236893 18.7071068,5.29289322 C19.0976311,5.68341751 19.0976311,6.31658249 18.7071068,6.70710678 L13.415,12 L18.7071068,17.2928932 C19.0675907,17.6533772 19.0953203,18.2206082 18.7902954,18.6128994 L18.7071068,18.7071068 C18.3466228,19.0675907 17.7793918,19.0953203 17.3871006,18.7902954 L17.2928932,18.7071068 L12,13.415 L6.70710678,18.7071068 C6.31658249,19.0976311 5.68341751,19.0976311 5.29289322,18.7071068 C4.90236893,18.3165825 4.90236893,17.6834175 5.29289322,17.2928932 L10.585,12 L5.29289322,6.70710678 C4.93240926,6.34662282 4.90467972,5.77939176 5.20970461,5.38710056 L5.29289322,5.29289322 L5.20970461,5.38710056 Z\"/>\r\n        </g>\r\n      </svg>\r\n      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"preloader-download\" viewBox=\"0 0 24 24\">\r\n        <g fill=\"none\" fill-rule=\"evenodd\">\r\n          <polygon points=\"0 0 24 0 24 24 0 24\"/>\r\n          <path fill=\"#000\" fill-rule=\"nonzero\" d=\"M5,19 L19,19 C19.5522847,19 20,19.4477153 20,20 C20,20.5128358 19.6139598,20.9355072 19.1166211,20.9932723 L19,21 L5,21 C4.44771525,21 4,20.5522847 4,20 C4,19.4871642 4.38604019,19.0644928 4.88337887,19.0067277 L5,19 L19,19 L5,19 Z M11.8833789,3.00672773 L12,3 C12.5128358,3 12.9355072,3.38604019 12.9932723,3.88337887 L13,4 L13,13.585 L16.2928932,10.2928932 C16.6533772,9.93240926 17.2206082,9.90467972 17.6128994,10.2097046 L17.7071068,10.2928932 C18.0675907,10.6533772 18.0953203,11.2206082 17.7902954,11.6128994 L17.7071068,11.7071068 L12.7071068,16.7071068 C12.3466228,17.0675907 11.7793918,17.0953203 11.3871006,16.7902954 L11.2928932,16.7071068 L6.29289322,11.7071068 C5.90236893,11.3165825 5.90236893,10.6834175 6.29289322,10.2928932 C6.65337718,9.93240926 7.22060824,9.90467972 7.61289944,10.2097046 L7.70710678,10.2928932 L11,13.585 L11,4 C11,3.48716416 11.3860402,3.06449284 11.8833789,3.00672773 L12,3 L11.8833789,3.00672773 Z\"/>\r\n        </g>\r\n      </svg>`;\r\n\r\n      this.downloadSvg = this.preloader.lastElementChild as HTMLElement;\r\n      this.cancelSvg = this.downloadSvg.previousElementSibling as any;\r\n    } else {\r\n      this.preloader.classList.add('preloader-swing');\r\n    }\r\n    \r\n    this.circle = this.preloader.firstElementChild.firstElementChild.firstElementChild as SVGCircleElement;\r\n\r\n    if(this.cancelable) {\r\n      attachClickEvent(this.preloader, this.onClick);\r\n    }\r\n  }\r\n\r\n  public onClick = (e?: Event) => {\r\n    if(e) {\r\n      cancelEvent(e);\r\n    }\r\n\r\n    if(this.preloader.classList.contains('manual')) {\r\n      if(this.loadFunc) {\r\n        this.loadFunc(e);\r\n      }\r\n    } else {\r\n      if(this.promise && this.promise.cancel) {\r\n        this.promise.cancel();\r\n      }\r\n    }\r\n  };\r\n\r\n  public setDownloadFunction(func: ProgressivePreloader['loadFunc']) {\r\n    this.loadFunc = func;\r\n  }\r\n\r\n  public setManual() {\r\n    this.preloader.classList.add('manual');\r\n    this.setProgress(0);\r\n  }\r\n\r\n  public attachPromise(promise: CancellablePromise<any>) {\r\n    if(this.isUpload && this.promise) return;\r\n\r\n    this.promise = promise;\r\n\r\n    const tempId = --this.tempId;\r\n    const startTime = Date.now();\r\n\r\n    const onEnd = (err: Error) => {\r\n      promise.notify = promise.notifyAll = null;\r\n\r\n      if(tempId !== this.tempId) {\r\n        return;\r\n      }\r\n\r\n      const elapsedTime = Date.now() - startTime;\r\n\r\n      //console.log('[PP]: end', this.detached, performance.now());\r\n\r\n      if(!err && this.cancelable) {\r\n        this.setProgress(100);\r\n\r\n        const delay = TRANSITION_TIME * 0.75;\r\n\r\n        if(elapsedTime < delay) {\r\n          this.detach();\r\n        } else {\r\n          setTimeout(() => { // * wait for transition complete\r\n            if(tempId === this.tempId) {\r\n              this.detach();\r\n            }\r\n          }, delay);\r\n        }\r\n      } else {\r\n        if(this.tryAgainOnFail) {\r\n          this.attach(this.preloader.parentElement);\r\n          fastRaf(() => {\r\n            this.setManual();\r\n          });\r\n        } else {\r\n          this.detach();\r\n        }\r\n      }\r\n      \r\n      this.promise = promise = null;\r\n    };\r\n    \r\n    promise\r\n    .then(() => onEnd(null))\r\n    .catch((err) => onEnd(err));\r\n\r\n    if(promise.addNotifyListener) {\r\n      promise.addNotifyListener((details: {done: number, total: number}) => {\r\n        /* if(details.done >= details.total) {\r\n          onEnd();\r\n        } */\r\n\r\n        if(tempId !== this.tempId) return;\r\n\r\n        //console.log('preloader download', promise, details);\r\n        const percents = details.done / details.total * 100;\r\n        this.setProgress(percents);\r\n      });\r\n    }\r\n  }\r\n\r\n  public attach(elem: Element, reset = false, promise?: CancellablePromise<any>) {\r\n    if(this.construct) {\r\n      this.construct();\r\n    }\r\n\r\n    if(this.preloader.parentElement) {\r\n      this.preloader.classList.remove('manual');\r\n    }\r\n\r\n    this.detached = false;\r\n\r\n    if(promise/*  && false */) {\r\n      this.attachPromise(promise);\r\n    }\r\n\r\n    if(this.detached || this.preloader.parentElement !== elem) {\r\n      const useRafs = isInDOM(this.preloader) ? 1 : 2;\r\n      if(this.preloader.parentElement !== elem) {\r\n        elem[this.attachMethod](this.preloader);\r\n      }\r\n\r\n      SetTransition(this.preloader, 'is-visible', true, TRANSITION_TIME, undefined, useRafs);\r\n    }\r\n\r\n    if(this.cancelable && reset) {\r\n      this.setProgress(0);\r\n    }\r\n  }\r\n  \r\n  public detach() {\r\n    if(this.detached) {\r\n      return;\r\n    }\r\n    //return;\r\n\r\n    this.detached = true;\r\n\r\n    //return;\r\n    \r\n    if(this.preloader && this.preloader.parentElement) {\r\n      /* setTimeout(() =>  *///fastRaf(() => {\r\n        /* if(!this.detached) return;\r\n        this.detached = true; */\r\n\r\n        // fastRaf(() => {\r\n          //console.log('[PP]: detach after rAF', this.detached, performance.now());\r\n\r\n          // if(!this.detached || !this.preloader.parentElement) {\r\n          //   return;\r\n          // }\r\n\r\n          SetTransition(this.preloader, 'is-visible', false, TRANSITION_TIME, () => {\r\n            this.preloader.remove();\r\n          }, 1);\r\n        // });\r\n      //})/* , 5e3) */;\r\n    }\r\n  }\r\n  \r\n  public setProgress(percents: number) {\r\n    if(!this.totalLength && !isInDOM(this.circle)) {\r\n      return;\r\n    }\r\n    \r\n    if(percents === 0) {\r\n      this.circle.style.strokeDasharray = '';\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      if(!this.totalLength) {\r\n        this.totalLength = this.circle.getTotalLength();\r\n      }\r\n\r\n      //console.log('setProgress', (percents / 100 * totalLength));\r\n      this.circle.style.strokeDasharray = '' + Math.max(5, percents / 100 * this.totalLength) + ', ' + this.totalLength;\r\n    } catch(err) {}\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport deferredPromise, { CancellablePromise } from \"./cancellablePromise\";\r\nimport { getHeavyAnimationPromise } from \"../hooks/useHeavyAnimationCheck\";\r\nimport { fastRaf } from \"./schedulers\";\r\nimport { ArgumentTypes } from \"../types\";\r\n\r\ntype HeavyQueue<T extends HeavyQueue<any>> = {\r\n  items: ArgumentTypes<T['process']>[], \r\n  process: (...args: any[]) => ReturnType<T['process']>,\r\n  context: any,\r\n  promise?: CancellablePromise<ReturnType<T['process']>[]>\r\n};\r\nconst heavyQueue: HeavyQueue<any>[] = [];\r\nlet processingQueue = false;\r\n\r\nexport default function addHeavyTask<T extends HeavyQueue<T>>(queue: T, method: 'push' | 'unshift' = 'push') {\r\n  if(!queue.items.length) {\r\n    return Promise.resolve([]) as typeof promise;\r\n  }\r\n  \r\n  const promise = queue.promise = deferredPromise();\r\n  heavyQueue[method](queue);\r\n  processHeavyQueue();\r\n\r\n  return promise;\r\n}\r\n\r\nfunction processHeavyQueue() {\r\n  if(!processingQueue) {\r\n    const queue = heavyQueue.shift();\r\n    timedChunk(queue).finally(() => {\r\n      processingQueue = false;\r\n      if(heavyQueue.length) {\r\n        processHeavyQueue();\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nfunction timedChunk<T extends HeavyQueue<T>>(queue: HeavyQueue<T>) {\r\n  if(!queue.items.length) {\r\n    queue.promise.resolve([] as any);\r\n    return Promise.resolve([]);\r\n  }\r\n\r\n  const todo = queue.items.slice();\r\n  const results: ReturnType<T['process']>[] = [];\r\n\r\n  return new Promise<typeof results>((resolve, reject) => {\r\n    const f = async() => {\r\n      const start = performance.now();\r\n\r\n      do {\r\n        await getHeavyAnimationPromise();\r\n        const possiblePromise = queue.process.apply(queue.context, todo.shift());\r\n        let realResult: typeof results[0];\r\n        // @ts-ignore\r\n        if(possiblePromise instanceof Promise) {\r\n          try {\r\n            realResult = await possiblePromise;\r\n          } catch(err) {\r\n            reject(err);\r\n            return;\r\n          }\r\n        } else {\r\n          realResult = possiblePromise;\r\n        }\r\n\r\n        results.push(realResult);\r\n      } while(todo.length > 0 && (performance.now() - start) < 6);\r\n\r\n      if(todo.length > 0) {\r\n        fastRaf(f);\r\n        //setTimeout(f, 25);\r\n      } else {\r\n        resolve(results);\r\n      }\r\n    };\r\n\r\n    fastRaf(f);\r\n    //setTimeout(f, 25);\r\n  }).then(queue.promise.resolve, queue.promise.reject);\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type fastBlur from '../vendor/fastBlur';\r\nimport addHeavyTask from './heavyQueue';\r\nimport IS_CANVAS_FILTER_SUPPORTED from '../environment/canvasFilterSupport';\r\n\r\nconst RADIUS = 2;\r\nconst ITERATIONS = 2;\r\n\r\nlet requireBlurPromise: Promise<any>;\r\nlet fastBlurFunc: typeof fastBlur;\r\nif(!IS_CANVAS_FILTER_SUPPORTED) {\r\n  requireBlurPromise = import('../vendor/fastBlur').then((m) => {\r\n    fastBlurFunc = m.default;\r\n  });\r\n} else {\r\n  requireBlurPromise = Promise.resolve();\r\n}\r\n\r\nfunction processBlurNext(\r\n  img: HTMLImageElement, \r\n  radius: number, \r\n  iterations: number, \r\n  canvas: HTMLCanvasElement = document.createElement('canvas')\r\n) {\r\n  canvas.width = img.width;\r\n  canvas.height = img.height;\r\n\r\n  const ctx = canvas.getContext('2d', {alpha: false});\r\n  if(IS_CANVAS_FILTER_SUPPORTED) {\r\n    ctx.filter = `blur(${radius}px)`;\r\n    ctx.drawImage(img, -radius * 2, -radius * 2, canvas.width + radius * 4, canvas.height + radius * 4);\r\n  } else {\r\n    ctx.drawImage(img, 0, 0);\r\n    fastBlurFunc(ctx, 0, 0, canvas.width, canvas.height, radius, iterations);\r\n  }\r\n\r\n  return canvas;\r\n}\r\n\r\ntype CacheValue = {canvas: HTMLCanvasElement, promise: Promise<void>};\r\nconst cache: Map<string, CacheValue> = new Map();\r\nconst CACHE_SIZE = 150;\r\n\r\nexport default function blur(dataUri: string, radius: number = RADIUS, iterations: number = ITERATIONS) {\r\n  if(!dataUri) {\r\n    throw 'no dataUri for blur: ' + dataUri;\r\n  }\r\n\r\n  if(cache.size > CACHE_SIZE) {\r\n    cache.clear();\r\n  }\r\n\r\n  const canvas = document.createElement('canvas');\r\n  canvas.className = 'canvas-thumbnail';\r\n  \r\n  let cached = cache.get(dataUri);\r\n  if(!cached) {\r\n    const promise: CacheValue['promise'] = new Promise((resolve) => {\r\n      //return resolve(dataUri);\r\n      requireBlurPromise.then(() => {\r\n        const img = new Image();\r\n        img.onload = () => {\r\n          // if(IS_CANVAS_FILTER_SUPPORTED) {\r\n            // resolve(processBlurNext(img, radius, iterations));\r\n          // } else {\r\n            const promise = addHeavyTask({\r\n              items: [[img, radius, iterations, canvas]],\r\n              context: null,\r\n              process: processBlurNext\r\n            }, 'unshift');\r\n            \r\n            promise.then(() => {\r\n              resolve();\r\n            });\r\n          // }\r\n        };\r\n        img.src = dataUri;\r\n      });\r\n    });\r\n  \r\n    cache.set(dataUri, cached = {\r\n      canvas,\r\n      promise\r\n    });\r\n  } else {\r\n    canvas.width = cached.canvas.width;\r\n    canvas.height = cached.canvas.height;\r\n    cached.promise.then(() => {\r\n      canvas.getContext('2d').drawImage(cached.canvas, 0, 0, canvas.width, canvas.height);\r\n    });\r\n  }\r\n\r\n  return {\r\n    ...cached,\r\n    canvas\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { IS_SAFARI } from \"../../environment/userAgent\";\r\nimport bytesFromHex from \"./bytesFromHex\";\r\nimport bytesToDataURL from \"./bytesToDataURL\";\r\n\r\nconst JPEG_HEADER = bytesFromHex('ffd8ffe000104a46494600010100000100010000ffdb004300281c1e231e19282321232d2b28303c64413c37373c7b585d4964918099968f808c8aa0b4e6c3a0aadaad8a8cc8ffcbdaeef5ffffff9bc1fffffffaffe6fdfff8ffdb0043012b2d2d3c353c76414176f8a58ca5f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8ffc00011080000000003012200021101031101ffc4001f0000010501010101010100000000000000000102030405060708090a0bffc400b5100002010303020403050504040000017d01020300041105122131410613516107227114328191a1082342b1c11552d1f02433627282090a161718191a25262728292a3435363738393a434445464748494a535455565758595a636465666768696a737475767778797a838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae1e2e3e4e5e6e7e8e9eaf1f2f3f4f5f6f7f8f9faffc4001f0100030101010101010101010000000000000102030405060708090a0bffc400b51100020102040403040705040400010277000102031104052131061241510761711322328108144291a1b1c109233352f0156272d10a162434e125f11718191a262728292a35363738393a434445464748494a535455565758595a636465666768696a737475767778797a82838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae2e3e4e5e6e7e8e9eaf2f3f4f5f6f7f8f9faffda000c03010002110311003f00');\r\nconst JPEG_TAIL = bytesFromHex('ffd9');\r\n\r\nexport default function getPreviewURLFromBytes(bytes: Uint8Array | number[], isSticker = false) {\r\n  let arr: Uint8Array;\r\n  if(!isSticker) {\r\n    arr = new Uint8Array(JPEG_HEADER.concat(Array.from(bytes.slice(3)), JPEG_TAIL));\r\n    arr[164] = bytes[1];\r\n    arr[166] = bytes[2];\r\n  } else {\r\n    arr = bytes instanceof Uint8Array ? bytes : new Uint8Array(bytes);\r\n  }\r\n\r\n  let mimeType: string;\r\n  if(isSticker) {\r\n    mimeType = IS_SAFARI ? 'image/png' : 'image/webp';\r\n  } else {\r\n    mimeType = 'image/jpeg';\r\n  }\r\n\r\n  return bytesToDataURL(arr, mimeType);\r\n}\r\n","export default function bytesToDataURL(bytes: Uint8Array, mimeType: string = 'image/jpeg') {\r\n  return `data:${mimeType};base64,${btoa(String.fromCharCode(...bytes))}`;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport type { MyPhoto } from \"../lib/appManagers/appPhotosManager\";\r\nimport { PhotoSize } from \"../layer\";\r\n// import appDownloadManager from \"../lib/appManagers/appDownloadManager\";\r\nimport getPreviewURLFromBytes from \"./bytes/getPreviewURLFromBytes\";\r\n\r\nexport default function getPreviewURLFromThumb(photo: MyPhoto | MyDocument, thumb: PhotoSize.photoCachedSize | PhotoSize.photoStrippedSize, isSticker = false) {\r\n  // const cacheContext = appDownloadManager.getCacheContext(photo, thumb.type);\r\n  // return cacheContext.url || (cacheContext.url = getPreviewURLFromBytes(thumb.bytes, isSticker));\r\n  return getPreviewURLFromBytes(thumb.bytes, isSticker);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { PhotoSize } from \"../layer\";\r\nimport { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport { MyPhoto } from \"../lib/appManagers/appPhotosManager\";\r\nimport { renderImageFromUrlPromise } from \"./dom/renderImageFromUrl\";\r\nimport getPreviewURLFromThumb from \"./getPreviewURLFromThumb\";\r\nimport blur from './blur';\r\n\r\nexport default function getImageFromStrippedThumb(photo: MyPhoto | MyDocument, thumb: PhotoSize.photoCachedSize | PhotoSize.photoStrippedSize, useBlur: boolean) {\r\n  const url = getPreviewURLFromThumb(photo, thumb, false);\r\n\r\n  let element: HTMLImageElement | HTMLCanvasElement, loadPromise: Promise<void>;\r\n  if(!useBlur) {\r\n    element = new Image();\r\n    loadPromise = renderImageFromUrlPromise(element, url);\r\n  } else {\r\n    const result = blur(url);\r\n    element = result.canvas;\r\n    loadPromise = result.promise;\r\n  }\r\n\r\n  element.classList.add('thumbnail');\r\n  \r\n  return {image: element, loadPromise};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport type { MyPhoto } from \"../lib/appManagers/appPhotosManager\";\r\nimport type { ThumbCache } from \"../lib/storages/thumbs\";\r\nimport getImageFromStrippedThumb from \"./getImageFromStrippedThumb\";\r\n\r\nexport default function getStrippedThumbIfNeeded(photo: MyPhoto | MyDocument, cacheContext: ThumbCache, useBlur: boolean, ignoreCache = false) {\r\n  if(!cacheContext.downloaded || (['video', 'gif'] as MyDocument['type'][]).includes((photo as MyDocument).type) || ignoreCache) {\r\n    if(photo._ === 'document' && cacheContext.downloaded && !ignoreCache) {\r\n      return null;\r\n    }\r\n\r\n    const sizes = (photo as MyPhoto).sizes || (photo as MyDocument).thumbs;\r\n    const thumb = sizes?.length ? sizes.find((size) => size._ === 'photoStrippedSize') : null;\r\n    if(thumb && ('bytes' in thumb)) {\r\n      return getImageFromStrippedThumb(photo, thumb as any, useBlur);\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { PhotoSize, WebDocument } from \"../layer\";\r\nimport { REPLIES_HIDDEN_CHANNEL_ID } from \"../lib/mtproto/mtproto_config\";\r\nimport { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport { MyPhoto } from \"../lib/appManagers/appPhotosManager\";\r\nimport choosePhotoSize from \"../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport { MediaSize, makeMediaSize } from \"./mediaSize\";\r\nimport isWebDocument from \"../lib/appManagers/utils/webDocs/isWebDocument\";\r\n\r\nexport default function setAttachmentSize(\r\n  photo: MyPhoto | MyDocument | WebDocument, \r\n  element: HTMLElement | SVGForeignObjectElement, \r\n  boxWidth: number, \r\n  boxHeight: number, \r\n  noZoom = true, \r\n  message?: any,\r\n  pushDocumentSize?: boolean,\r\n  photoSize?: ReturnType<typeof choosePhotoSize>\r\n) {\r\n  const _isWebDocument = isWebDocument(photo);\r\n  // if(_isWebDocument && pushDocumentSize === undefined) {\r\n  //   pushDocumentSize = true;\r\n  // }\r\n\r\n  if(!photoSize) {\r\n    photoSize = choosePhotoSize(photo, boxWidth, boxHeight, undefined, pushDocumentSize);\r\n  }\r\n  //console.log('setAttachmentSize', photo, photo.sizes[0].bytes, div);\r\n  \r\n  let size: MediaSize;\r\n  const isDocument = photo._ === 'document';\r\n  if(isDocument || _isWebDocument) {\r\n    size = makeMediaSize(photo.w || (photoSize as PhotoSize.photoSize).w || 512, photo.h || (photoSize as PhotoSize.photoSize).h || 512);\r\n  } else {\r\n    size = makeMediaSize((photoSize as PhotoSize.photoSize).w || 100, (photoSize as PhotoSize.photoSize).h || 100);\r\n  }\r\n\r\n  let boxSize = makeMediaSize(boxWidth, boxHeight);\r\n\r\n  boxSize = size = size.aspect(boxSize, noZoom);\r\n\r\n  let isFit = true;\r\n\r\n  if(!isDocument || ['video', 'gif'].includes(photo.type) || _isWebDocument) {\r\n    if(boxSize.width < 200 && boxSize.height < 200) { // make at least one side this big\r\n      boxSize = size = size.aspectCovered(makeMediaSize(200, 200));\r\n    }\r\n\r\n    if(message && \r\n      (message.message || \r\n        message.reply_to_mid || \r\n        message.media.webpage || \r\n        (message.replies && message.replies.pFlags.comments && message.replies.channel_id.toChatId() !== REPLIES_HIDDEN_CHANNEL_ID)\r\n      )\r\n    ) { // make sure that bubble block is human-readable\r\n      if(boxSize.width < 320) {\r\n        boxSize = makeMediaSize(320, boxSize.height);\r\n        isFit = false;\r\n      }\r\n    }\r\n\r\n    if(isFit && boxSize.width < 120 && message) { // if image is too narrow\r\n      boxSize = makeMediaSize(120, boxSize.height);\r\n      isFit = false;\r\n    }\r\n  }\r\n\r\n  // if(element instanceof SVGForeignObjectElement) {\r\n  //   element.setAttributeNS(null, 'width', '' + w);\r\n  //   element.setAttributeNS(null, 'height', '' + h);\r\n\r\n  //   //console.log('set dimensions to svg element:', element, w, h);\r\n  // } else {\r\n    element.style.width = boxSize.width + 'px';\r\n    element.style.height = boxSize.height + 'px';\r\n  // }\r\n  \r\n  return {photoSize, size, isFit};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport renderImageWithFadeIn from \"../../helpers/dom/renderImageWithFadeIn\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport { Message, PhotoSize, WebDocument } from \"../../layer\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport { MyPhoto } from \"../../lib/appManagers/appPhotosManager\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport ProgressivePreloader from \"../preloader\";\r\nimport blur from '../../helpers/blur';\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getStrippedThumbIfNeeded from \"../../helpers/getStrippedThumbIfNeeded\";\r\nimport setAttachmentSize from \"../../helpers/setAttachmentSize\";\r\nimport choosePhotoSize from \"../../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport type { ThumbCache } from \"../../lib/storages/thumbs\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\nimport isWebDocument from \"../../lib/appManagers/utils/webDocs/isWebDocument\";\r\n\r\nexport default async function wrapPhoto({photo, message, container, boxWidth, boxHeight, withTail, isOut, lazyLoadQueue, middleware, size, withoutPreloader, loadPromises, autoDownloadSize, noBlur, noThumb, noFadeIn, blurAfter, managers = rootScope.managers}: {\r\n  photo: MyPhoto | MyDocument | WebDocument, \r\n  message?: Message.message | Message.messageService, \r\n  container: HTMLElement, \r\n  boxWidth?: number, \r\n  boxHeight?: number, \r\n  withTail?: boolean, \r\n  isOut?: boolean, \r\n  lazyLoadQueue?: LazyLoadQueue, \r\n  middleware?: () => boolean, \r\n  size?: PhotoSize,\r\n  withoutPreloader?: boolean,\r\n  loadPromises?: Promise<any>[],\r\n  autoDownloadSize?: number,\r\n  noBlur?: boolean,\r\n  noThumb?: boolean,\r\n  noFadeIn?: boolean,\r\n  blurAfter?: boolean,\r\n  managers?: AppManagers,\r\n}) {\r\n  const isWebDoc = isWebDocument(photo);\r\n  if(!((photo as MyPhoto).sizes || (photo as MyDocument).thumbs) && !isWebDoc) {\r\n    if(boxWidth && boxHeight && !size && photo._ === 'document') {\r\n      setAttachmentSize(photo, container, boxWidth, boxHeight, undefined, message);\r\n    }\r\n\r\n    return {\r\n      loadPromises: {\r\n        thumb: Promise.resolve(),\r\n        full: Promise.resolve()\r\n      },\r\n      images: {\r\n        thumb: null,\r\n        full: null\r\n      },\r\n      preloader: null,\r\n      aspecter: null\r\n    };\r\n  }\r\n\r\n  let noAutoDownload = autoDownloadSize === 0;\r\n\r\n  if(!size) {\r\n    if(boxWidth === undefined) boxWidth = mediaSizes.active.regular.width;\r\n    if(boxHeight === undefined) boxHeight = mediaSizes.active.regular.height;\r\n  }\r\n\r\n  container.classList.add('media-container');\r\n  let aspecter = container;\r\n\r\n  let isFit = true;\r\n  let loadThumbPromise: Promise<any> = Promise.resolve();\r\n  let thumbImage: HTMLImageElement | HTMLCanvasElement;\r\n  let image: HTMLImageElement;\r\n  let cacheContext: ThumbCache;\r\n  const isGif = photo._ === 'document' && photo.mime_type === 'image/gif' && !size;\r\n  // if(withTail) {\r\n  //   image = wrapMediaWithTail(photo, message, container, boxWidth, boxHeight, isOut);\r\n  // } else {\r\n    image = new Image();\r\n\r\n    if(boxWidth && boxHeight && !size) { // !album\r\n      const set = setAttachmentSize(photo, container, boxWidth, boxHeight, undefined, message, undefined, isGif ? {\r\n        _: 'photoSize',\r\n        w: photo.w,\r\n        h: photo.h,\r\n        size: photo.size,\r\n        type: 'full'\r\n      } : undefined);\r\n      size = set.photoSize;\r\n      isFit = set.isFit;\r\n      cacheContext = await managers.thumbsStorage.getCacheContext(photo, size.type);\r\n\r\n      if(!isFit && !isWebDoc) {\r\n        aspecter = document.createElement('div');\r\n        aspecter.classList.add('media-container-aspecter');\r\n        aspecter.style.width = set.size.width + 'px';\r\n        aspecter.style.height = set.size.height + 'px';\r\n\r\n        const gotThumb = getStrippedThumbIfNeeded(photo, cacheContext, !noBlur, true);\r\n        if(gotThumb) {\r\n          loadThumbPromise = gotThumb.loadPromise;\r\n          const thumbImage = gotThumb.image; // local scope\r\n          thumbImage.classList.add('media-photo');\r\n          container.append(thumbImage);\r\n        } else {\r\n          const res = await wrapPhoto({\r\n            container,\r\n            message,\r\n            photo,\r\n            boxWidth: 0,\r\n            boxHeight: 0,\r\n            size,\r\n            lazyLoadQueue,\r\n            isOut,\r\n            loadPromises,\r\n            middleware,\r\n            withoutPreloader,\r\n            withTail,\r\n            autoDownloadSize,\r\n            noBlur,\r\n            noThumb: true,\r\n            blurAfter: true,\r\n            managers\r\n            //noFadeIn: true\r\n          });\r\n          const thumbImage = res.images.full;\r\n          thumbImage.classList.add('media-photo', 'thumbnail');\r\n          //container.append(thumbImage);\r\n        }\r\n\r\n        container.classList.add('media-container-fitted');\r\n        container.append(aspecter);\r\n      }\r\n    } else {\r\n      if(!size) {\r\n        size = choosePhotoSize(photo, boxWidth, boxHeight, true);\r\n      }\r\n      \r\n      cacheContext = await managers.thumbsStorage.getCacheContext(photo, size?.type);\r\n    }\r\n\r\n    if(!noThumb && !isWebDoc) {\r\n      const gotThumb = getStrippedThumbIfNeeded(photo, cacheContext, !noBlur);\r\n      if(gotThumb) {\r\n        loadThumbPromise = Promise.all([loadThumbPromise, gotThumb.loadPromise]);\r\n        thumbImage = gotThumb.image;\r\n        thumbImage.classList.add('media-photo');\r\n        aspecter.append(thumbImage);\r\n      }\r\n    }\r\n  // }\r\n\r\n  image.classList.add('media-photo');\r\n  \r\n  //console.log('wrapPhoto downloaded:', photo, photo.downloaded, container);\r\n\r\n  const needFadeIn = (thumbImage || !cacheContext.downloaded) && rootScope.settings.animationsEnabled && !noFadeIn;\r\n\r\n  let preloader: ProgressivePreloader;\r\n  const uploadingFileName = (message as Message.message)?.uploadingFileName;\r\n  if(!withoutPreloader) {\r\n    if(!cacheContext.downloaded || uploadingFileName) {\r\n      preloader = new ProgressivePreloader({\r\n        attachMethod: 'prepend',\r\n        isUpload: !!uploadingFileName\r\n      });\r\n    }\r\n\r\n    if(uploadingFileName) { // means upload\r\n      preloader.attachPromise(appDownloadManager.getUpload(uploadingFileName));\r\n      preloader.attach(container);\r\n      noAutoDownload = undefined;\r\n    }\r\n  }\r\n  \r\n\r\n  const getDownloadPromise = () => {\r\n    // const promise = isGif && !size ? \r\n    //   managers.appDocsManager.downloadDoc(photo, /* undefined,  */lazyLoadQueue?.queueId) : \r\n    //   managers.appPhotosManager.preloadPhoto(photo, size, lazyLoadQueue?.queueId, noAutoDownload);\r\n    const haveToDownload = isGif && !size;\r\n    const promise = appDownloadManager.downloadMediaURL({\r\n      media: photo,\r\n      thumb: size,\r\n      queueId: lazyLoadQueue?.queueId,\r\n      onlyCache: haveToDownload ? undefined : noAutoDownload\r\n    });\r\n\r\n    return promise;\r\n  };\r\n\r\n  const renderOnLoad = (url: string) => {\r\n    return renderImageWithFadeIn(container, image, url, needFadeIn, aspecter, thumbImage);\r\n  };\r\n\r\n  const onLoad = async(url: string) => {\r\n    if(middleware && !middleware()) return;\r\n\r\n    if(blurAfter) {\r\n      const result = blur(url, 12);\r\n      return result.promise.then(() => {\r\n        // image = result.canvas;\r\n        return renderOnLoad(result.canvas.toDataURL());\r\n      });\r\n    }\r\n\r\n    return renderOnLoad(url);\r\n  };\r\n\r\n  let loadPromise: Promise<any>;\r\n  const canAttachPreloader = (\r\n    (size as PhotoSize.photoSize).w >= 150 && \r\n    (size as PhotoSize.photoSize).h >= 150\r\n    ) || noAutoDownload;\r\n  const load = async() => {\r\n    if(noAutoDownload && !withoutPreloader && preloader) {\r\n      preloader.construct();\r\n      preloader.setManual();\r\n    }\r\n\r\n    const promise = getDownloadPromise();\r\n    const cacheContext = await managers.thumbsStorage.getCacheContext(photo, size?.type);\r\n    if(\r\n      preloader && \r\n      !cacheContext.downloaded && \r\n      !withoutPreloader && \r\n      canAttachPreloader\r\n    ) {\r\n      preloader.attach(container, false, promise);\r\n    }\r\n\r\n    noAutoDownload = undefined;\r\n\r\n    const renderPromise = promise.then(onLoad);\r\n    renderPromise.catch(() => {});\r\n    return {download: promise, render: renderPromise};\r\n  };\r\n\r\n  if(preloader) {\r\n    preloader.setDownloadFunction(load);\r\n  }\r\n  \r\n  if(cacheContext.downloaded) {\r\n    loadThumbPromise = loadPromise = (await load()).render;\r\n  } else {\r\n    if(!lazyLoadQueue) loadPromise = (await load()).render;\r\n    /* else if(noAutoDownload) {\r\n      preloader.construct();\r\n      preloader.setManual();\r\n      preloader.attach(container);\r\n    } */ else lazyLoadQueue.push({div: container, load: () => load().then(({download}) => download)});\r\n  }\r\n\r\n  if(loadPromises && loadThumbPromise) {\r\n    loadPromises.push(loadThumbPromise);\r\n  }\r\n\r\n  // const perf = performance.now();\r\n  await loadThumbPromise;\r\n\r\n  // const elapsedTime = performance.now() - perf;\r\n  // if(elapsedTime > 4) {\r\n  //   console.log('wrapping photo thumb time', elapsedTime, photo, size);\r\n  // }\r\n\r\n  return {\r\n    loadPromises: {\r\n      thumb: loadThumbPromise,\r\n      full: loadPromise || Promise.resolve()\r\n    },\r\n    images: {\r\n      thumb: thumbImage,\r\n      full: image\r\n    },\r\n    preloader,\r\n    aspecter\r\n  };\r\n}\r\n","export default function createVideo(options: {\r\n  pip?: boolean\r\n} = {}) {\r\n  const video = document.createElement('video');\r\n  if(!options.pip) video.disablePictureInPicture = true;\r\n  video.setAttribute('playsinline', 'true');\r\n  return video;\r\n}\r\n","export default function toHHMMSS(str: string | number, leadZero = false) {\r\n  const sec_num = parseInt(str + '', 10);\r\n  const hours = Math.floor(sec_num / 3600);\r\n  let minutes: any = Math.floor((sec_num - (hours * 3600)) / 60);\r\n  let seconds: any = sec_num - (hours * 3600) - (minutes * 60);\r\n  \r\n  if(hours) leadZero = true;\r\n  if(minutes < 10) minutes = leadZero ? \"0\" + minutes : minutes;\r\n  if(seconds < 10) seconds = \"0\" + seconds;\r\n  return (hours ? /* ('0' + hours).slice(-2) */hours + ':' : '') + minutes + ':' + seconds;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport const FontFamily = 'Roboto, -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Oxygen-Sans, Ubuntu, Cantarell, \"Helvetica Neue\", sans-serif';\r\nexport const FontSize = '16px';\r\nexport const FontWeight = '400';\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// import { MOUNT_CLASS_TO } from \"../../config/debug\";\r\n\r\nlet context: CanvasRenderingContext2D;\r\n/**\r\n * Get the text width\r\n * @param {string} text\r\n * @param {string} font\r\n */\r\nexport default function getTextWidth(text: string, font: string) {\r\n  // const perf = performance.now();\r\n  if(!context) {\r\n    const canvas = document.createElement('canvas');\r\n    context = canvas.getContext('2d', {alpha: false});\r\n    context.font = font;\r\n  }\r\n\r\n  //context.font = font;\r\n  const metrics = context.measureText(text);\r\n  // console.log('getTextWidth perf:', performance.now() - perf);\r\n  return metrics.width;\r\n  //return Math.round(metrics.width);\r\n}\r\n\r\n// MOUNT_CLASS_TO && (MOUNT_CLASS_TO.getTextWidth = getTextWidth);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { FontFamily, FontSize, FontWeight } from \"../config/font\";\r\nimport getTextWidth from \"../helpers/canvas/getTextWidth\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport clamp from \"../helpers/number/clamp\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\n\r\n// Thanks to https://stackoverflow.com/a/49349813\r\n\r\n/**\r\n * Attibute modifier to create middle ellipsis\r\n * When the attribute value is left blank the ellipsis will be in the middle\r\n * When positive the attribute value will be used as a percentage\r\n * When negative the attribute value will be used as character index counted from the end\r\n * @example\r\n *   <div data-middle-ellipsis>A Javascript solution to middle ellipsis</div>\r\n *   <div data-middle-ellipsis=\"20\">A Javascript solution to middle ellipsis</div>\r\n *   <div data-middle-ellipsis=\"-3\">A Javascript solution to middle ellipsis</div>\r\n */\r\nconst ellipsis = '';\r\nconst map: Map<HTMLElement, {\r\n  text: string,\r\n  textLength: number,\r\n  from: number,\r\n  multiplier: number,\r\n  font: string,\r\n  textWidth: number,\r\n  elementWidth: number\r\n}> = new Map();\r\n\r\nconst testQueue: Set<HTMLElement> = new Set();\r\nconst fontSize = '16px';\r\nlet pendingTest = false;\r\n\r\nfunction setTestQueue() {\r\n  if(pendingTest) {\r\n    return;\r\n  }\r\n\r\n  pendingTest = true;\r\n  fastRaf(() => {\r\n    pendingTest = false;\r\n    testQueueElements();\r\n  });\r\n}\r\n\r\nfunction testQueueElements() {\r\n  testQueue.forEach(testElement);\r\n  testQueue.clear();\r\n}\r\n\r\nwindow.addEventListener('resize', () => {\r\n  for(const [key] of map) {\r\n    testQueue.add(key);\r\n  }\r\n  \r\n  setTestQueue();\r\n}, {capture: true, passive: true});\r\n\r\nfunction getElementWidth(element: HTMLElement) {\r\n  const type = element.dataset.sizeType;\r\n  if(type) {\r\n    const mediaSize = mediaSizes.active;\r\n    // @ts-ignore\r\n    const size: MediaSize = mediaSize[type];\r\n    return size.width;\r\n  } \r\n  \r\n  return element.getBoundingClientRect().width;\r\n}\r\n\r\nfunction testElement(element: HTMLElement) {\r\n  //const perf = performance.now();\r\n  // do not recalculate variables a second time\r\n  let mapped = map.get(element);\r\n  const firstTime = !mapped;\r\n\r\n  let {text, textLength, from, multiplier, font, textWidth, elementWidth} = mapped || {};\r\n  //console.log('[MEE] testElement got mapped', mapped);\r\n\r\n  if(firstTime) {\r\n    text = element.textContent;\r\n    textLength = text.length;\r\n    from = /* parseFloat(element.getAttribute(attributeName)) ||  */50;\r\n    multiplier = from > 0 && from / 100;\r\n\r\n    //const perf = performance.now();\r\n    font = `${element.dataset.fontWeight || FontWeight} ${FontSize} ${FontFamily}`;\r\n    /* const computedStyle = window.getComputedStyle(elm, null);\r\n    font = `${computedStyle.getPropertyValue('font-weight')} ${computedStyle.getPropertyValue('font-size')} ${computedStyle.getPropertyValue('font-family')}`; */\r\n    //console.log('testMiddleEllipsis get computed style:', performance.now() - perf, font);\r\n\r\n    textWidth = getTextWidth(text, font);\r\n    //const perf = performance.now();\r\n    elementWidth = getElementWidth(element);\r\n    //console.log('testMiddleEllipsis get offsetWidth:', performance.now() - perf, font);\r\n    mapped = {text, textLength, from, multiplier, font, textWidth, elementWidth};\r\n    map.set(element, mapped);\r\n\r\n    //console.log('[MEE] testElement map set', element);\r\n  }\r\n  \r\n  const newElementWidth = getElementWidth(element);\r\n  const widthChanged = firstTime || elementWidth !== newElementWidth;\r\n  !firstTime && widthChanged && (mapped.elementWidth = elementWidth = newElementWidth);\r\n  \r\n  if(widthChanged) {\r\n    if(textWidth > elementWidth) {\r\n      element.setAttribute('title', text);\r\n      let smallerText = text;\r\n      let smallerWidth = elementWidth;\r\n      while(smallerText.length > 3) {\r\n        let smallerTextLength = smallerText.length;\r\n        const half = multiplier &&\r\n          clamp(multiplier * smallerTextLength << 0, 1, smallerTextLength - 2) ||\r\n          Math.max(smallerTextLength + from - 1, 1);\r\n        const half1 = smallerText.substr(0, half).replace(/\\s*$/,'');\r\n        const half2 = smallerText.substr(half + 1).replace(/^\\s*/,'');\r\n        smallerText = half1 + half2;\r\n        smallerWidth = getTextWidth(smallerText + ellipsis, font);\r\n        if(smallerWidth < elementWidth) {\r\n          element.textContent = half1 + ellipsis + half2;\r\n          break;\r\n        }\r\n      }\r\n\r\n      // * set new width after cutting text\r\n      mapped.elementWidth = getElementWidth(element);\r\n      //mapped.textWidth = smallerWidth;\r\n    } else {\r\n      element.removeAttribute('title');\r\n    }\r\n  }\r\n\r\n  //console.log('testMiddleEllipsis for element:', elm, performance.now() - perf);\r\n}\r\n\r\nexport class MiddleEllipsisElement extends HTMLElement {\r\n  connectedCallback() {\r\n    //console.log('[MEE]: connectedCallback before', map.has(this), testQueue.has(this), map.size, this.textContent, map);\r\n\r\n    map.set(this, null);\r\n    if(this.dataset.sizeType) {\r\n      testElement(this);\r\n    } else {\r\n      testQueue.add(this);\r\n      setTestQueue();\r\n    }\r\n    //testElement(this);\r\n\r\n    //console.log('[MEE]: connectedCallback after', map.has(this), map.size, testQueue.has(this), testQueue.size);\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    const deleted = map.delete(this);\r\n    testQueue.delete(this);\r\n    //console.log('[MEE]: disconnectedCallback', deleted, map.has(this), map.size, this.textContent, map);\r\n  }\r\n}\r\n\r\ncustomElements.define(\"middle-ellipsis-element\", MiddleEllipsisElement);\r\n","// * Jolly Cobra's schedulers\r\n\r\nimport { AnyToVoidFunction } from \"../../types\";\r\nimport { fastRaf } from \"../schedulers\";\r\nimport throttleWith from \"./throttleWith\";\r\n\r\nexport default function throttleWithRaf<F extends AnyToVoidFunction>(fn: F) {\r\n  return throttleWith(fastRaf, fn);\r\n}\r\n","// * Jolly Cobra's schedulers\r\n\r\nimport { AnyToVoidFunction } from \"../../types\";\r\n\r\nexport default function throttleWith<F extends AnyToVoidFunction>(schedulerFn: AnyToVoidFunction, fn: F) {\r\n  let waiting = false;\r\n  let args: Parameters<F>;\r\n\r\n  return (..._args: Parameters<F>) => {\r\n    args = _args;\r\n\r\n    if (!waiting) {\r\n      waiting = true;\r\n\r\n      schedulerFn(() => {\r\n        waiting = false;\r\n        // @ts-ignore\r\n        fn(...args);\r\n      });\r\n    }\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\n\r\nexport default function formatBytes(bytes: number, decimals = 2) {\r\n  if(bytes === 0) return i18n('FileSize.B', [0]);\r\n\r\n  const k = 1024;\r\n  const dm = decimals < 0 ? 0 : decimals;\r\n  const sizes: LangPackKey[] = ['FileSize.B', 'FileSize.KB', 'FileSize.MB', 'FileSize.GB'];\r\n\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n\r\n  return i18n(sizes[i], [parseFloat((bytes / Math.pow(k, i)).toFixed(dm))]);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport type GrabEvent = {x: number, y: number, isTouch?: boolean, event: TouchEvent | MouseEvent};\r\n\r\nexport default function attachGrabListeners(element: HTMLElement, \r\n  onStart: (position: GrabEvent) => void, \r\n  onMove: (position: GrabEvent) => void, \r\n  onEnd?: (position: GrabEvent) => void) {\r\n  // * Mouse\r\n  const onMouseMove = (event: MouseEvent) => {\r\n    onMove({x: event.pageX, y: event.pageY, event});\r\n  };\r\n\r\n  const onMouseUp = (event: MouseEvent) => {\r\n    document.removeEventListener('mousemove', onMouseMove);\r\n    element.addEventListener('mousedown', onMouseDown, {once: true});\r\n    onEnd && onEnd({x: event.pageX, y: event.pageY, event});\r\n  };\r\n\r\n  const onMouseDown = (event: MouseEvent) => {\r\n    if(event.button !== 0) {\r\n      element.addEventListener('mousedown', onMouseDown, {once: true});\r\n      return;\r\n    }\r\n\r\n    onStart({x: event.pageX, y: event.pageY, event});\r\n    onMouseMove(event);\r\n\r\n    document.addEventListener('mousemove', onMouseMove);\r\n    document.addEventListener('mouseup', onMouseUp, {once: true});\r\n  };\r\n\r\n  element.addEventListener('mousedown', onMouseDown, {once: true});\r\n\r\n  // * Touch\r\n  const onTouchMove = (event: TouchEvent) => {\r\n    event.preventDefault();\r\n    onMove({x: event.touches[0].clientX, y: event.touches[0].clientY, isTouch: true, event});\r\n  };\r\n\r\n  const onTouchEnd = (event: TouchEvent) => {\r\n    document.removeEventListener('touchmove', onTouchMove);\r\n    element.addEventListener('touchstart', onTouchStart, {passive: false, once: true});\r\n    onEnd && onEnd({x: event.touches[0].clientX, y: event.touches[0].clientY, isTouch: true, event});\r\n  };\r\n\r\n  const onTouchStart = (event: TouchEvent) => {\r\n    onStart({x: event.touches[0].clientX, y: event.touches[0].clientY, isTouch: true, event});\r\n    onTouchMove(event);\r\n\r\n    document.addEventListener('touchmove', onTouchMove, {passive: false});\r\n    document.addEventListener('touchend', onTouchEnd, {passive: false, once: true});\r\n  };\r\n\r\n  element.addEventListener('touchstart', onTouchStart, {passive: false, once: true});\r\n\r\n  return () => {\r\n    element.removeEventListener('mousedown', onMouseDown);\r\n    document.removeEventListener('mousemove', onMouseMove);\r\n    document.removeEventListener('mouseup', onMouseUp);\r\n\r\n    element.removeEventListener('touchstart', onTouchStart);\r\n    document.removeEventListener('touchmove', onTouchMove);\r\n    document.removeEventListener('touchend', onTouchEnd);\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport attachGrabListeners, { GrabEvent } from \"../helpers/dom/attachGrabListeners\";\r\nimport clamp from \"../helpers/number/clamp\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\n\r\nexport default class RangeSelector {\r\n  public container: HTMLDivElement;\r\n  protected filled: HTMLDivElement;\r\n  protected seek: HTMLInputElement;\r\n\r\n  public mousedown = false;\r\n  protected rect: DOMRect;\r\n  protected _removeListeners: () => void;\r\n\r\n  private events: Partial<{\r\n    //onMouseMove: ProgressLine['onMouseMove'],\r\n    onMouseDown: RangeSelector['onMouseDown'],\r\n    onMouseUp: RangeSelector['onMouseUp'],\r\n    onScrub: (value: number) => void\r\n  }> = {};\r\n\r\n  protected decimals: number;\r\n\r\n  protected step: number;\r\n  protected min: number;\r\n  protected max: number;\r\n  protected withTransition = false;\r\n  protected useTransform = false;\r\n  protected vertical = false;\r\n\r\n  constructor(\r\n    options: {\r\n      step: RangeSelector['step'],\r\n      min: RangeSelector['min'],\r\n      max: RangeSelector['max'],\r\n      withTransition?: RangeSelector['withTransition'],\r\n      useTransform?: RangeSelector['useTransform'],\r\n      vertical?: RangeSelector['vertical']\r\n    }, \r\n    value = 0\r\n  ) {\r\n    safeAssign(this, options);\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('progress-line');\r\n\r\n    // there is no sense in using transition with transform, because it is updating every frame\r\n    if(this.useTransform) {\r\n      this.container.classList.add('use-transform');\r\n    } else if(this.withTransition) {\r\n      this.container.classList.add('with-transition');\r\n    }\r\n\r\n    this.filled = document.createElement('div');\r\n    this.filled.classList.add('progress-line__filled');\r\n\r\n    const seek = this.seek = document.createElement('input');\r\n    seek.classList.add('progress-line__seek');\r\n    //seek.setAttribute('max', '0');\r\n    seek.type = 'range';\r\n    seek.step = '' + this.step;\r\n    seek.min = '' + this.min;\r\n    seek.max = '' + this.max;\r\n    seek.value = '' + value;\r\n\r\n    if(value) {\r\n      this.setProgress(value);\r\n    }\r\n\r\n    const stepStr = '' + this.step;\r\n    const index = stepStr.indexOf('.');\r\n    this.decimals = index === -1 ? 0 : stepStr.length - index - 1;\r\n\r\n    //this.setListeners();\r\n\r\n    this.container.append(this.filled, seek);\r\n  }\r\n\r\n  get value() {\r\n    return +this.seek.value;\r\n  }\r\n\r\n  public setHandlers(events: RangeSelector['events']) {\r\n    this.events = events;\r\n  }\r\n\r\n  protected onMouseMove = (event: GrabEvent) => {\r\n    this.scrub(event);\r\n  };\r\n\r\n  protected onMouseDown = (event: GrabEvent) => {\r\n    this.rect = this.container.getBoundingClientRect();\r\n    this.mousedown = true;\r\n    this.scrub(event);\r\n    this.container.classList.add('is-focused');\r\n    this.events?.onMouseDown && this.events.onMouseDown(event);\r\n  };\r\n\r\n  protected onMouseUp = (event: GrabEvent) => {\r\n    this.mousedown = false;\r\n    this.container.classList.remove('is-focused');\r\n    this.events?.onMouseUp && this.events.onMouseUp(event);\r\n  };\r\n\r\n  public setListeners() {\r\n    this.seek.addEventListener('input', this.onInput);\r\n    this._removeListeners = attachGrabListeners(this.container, this.onMouseDown, this.onMouseMove, this.onMouseUp);\r\n  }\r\n\r\n  public onInput = () => {\r\n    const value = +this.seek.value;\r\n    this.setFilled(value);\r\n    this.events?.onScrub && this.events.onScrub(value);\r\n  };\r\n\r\n  public setProgress(value: number) {\r\n    this.seek.value = '' + value;\r\n    this.setFilled(+this.seek.value); // clamp\r\n  }\r\n\r\n  public addProgress(value: number) {\r\n    this.seek.value = '' + (+this.seek.value + value);\r\n    this.setFilled(+this.seek.value); // clamp\r\n  }\r\n\r\n  public setFilled(value: number) {\r\n    let percents = (value - this.min) / (this.max - this.min);\r\n    percents = clamp(percents, 0, 1);\r\n    \r\n    // using scaleX and width even with vertical because it will be rotated\r\n    if(this.useTransform) {\r\n      this.filled.style.transform = `scaleX(${percents})`;\r\n    } else {\r\n      this.filled.style.width = (percents * 100) + '%';\r\n    }\r\n  }\r\n\r\n  protected scrub(event: GrabEvent) {\r\n    const rectMax = this.vertical ? this.rect.height : this.rect.width;\r\n    const offsetAxisValue = clamp(this.vertical ? -(event.y - this.rect.bottom) : event.x - this.rect.left, 0, rectMax);\r\n\r\n    let value = this.min + (offsetAxisValue / rectMax * (this.max - this.min));\r\n\r\n    if((value - this.min) < ((this.max - this.min) / 2)) {\r\n      value -= this.step / 10;\r\n    }\r\n    \r\n    value = +value.toFixed(this.decimals);\r\n    value = clamp(value, this.min, this.max);\r\n\r\n    //this.seek.value = '' + value;\r\n    //this.onInput();\r\n\r\n    this.setProgress(value);\r\n    this.events?.onScrub && this.events.onScrub(value);\r\n\r\n    return value;\r\n  }\r\n\r\n  public removeListeners() {\r\n    if(this._removeListeners) {\r\n      this._removeListeners();\r\n      this._removeListeners = null;\r\n    }\r\n\r\n    this.seek.removeEventListener('input', this.onInput);\r\n    \r\n    this.events = {};\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { GrabEvent } from \"../helpers/dom/attachGrabListeners\";\r\nimport appMediaPlaybackController from \"./appMediaPlaybackController\";\r\nimport RangeSelector from \"./rangeSelector\";\r\n\r\nexport default class MediaProgressLine extends RangeSelector {\r\n  protected filledLoad: HTMLDivElement;\r\n\r\n  protected progressRAF = 0;\r\n\r\n  protected media: HTMLMediaElement;\r\n  protected streamable: boolean;\r\n\r\n  constructor(media?: HTMLAudioElement | HTMLVideoElement, streamable?: boolean, withTransition?: boolean, useTransform?: boolean) {\r\n    super({\r\n      step: 1000 / 60 / 1000, \r\n      min: 0, \r\n      max: 1, \r\n      withTransition, \r\n      useTransform\r\n    }, 0);\r\n\r\n    if(media) {\r\n      this.setMedia(media, streamable);\r\n    }\r\n  }\r\n\r\n  public setMedia(media: HTMLMediaElement, streamable = false) {\r\n    if(this.media) {\r\n      this.removeListeners();\r\n    }\r\n\r\n    if(streamable && !this.filledLoad) {\r\n      this.filledLoad = document.createElement('div');\r\n      this.filledLoad.classList.add('progress-line__filled', 'progress-line__loaded');\r\n      this.container.prepend(this.filledLoad);\r\n      //this.setLoadProgress();\r\n    } else if(this.filledLoad) {\r\n      this.filledLoad.classList.toggle('hide', !streamable);\r\n    }\r\n\r\n    this.media = media;\r\n    this.streamable = streamable;\r\n    if(!media.paused || media.currentTime > 0) {\r\n      this.onPlay();\r\n    }\r\n\r\n    let wasPlaying = false;\r\n    this.setSeekMax();\r\n    this.setListeners();\r\n    this.setHandlers({\r\n      onMouseDown: () => {\r\n        wasPlaying = !this.media.paused;\r\n        wasPlaying && this.media.pause();\r\n      },\r\n\r\n      onMouseUp: (e) => {\r\n        // cancelEvent(e.event);\r\n        wasPlaying && this.media.play();\r\n      }\r\n    });\r\n  }\r\n\r\n  protected onLoadedData = () => {\r\n    this.max = this.media.duration;\r\n    this.seek.setAttribute('max', '' + this.max);\r\n  };\r\n\r\n  protected onEnded = () => {\r\n    this.setProgress();\r\n  };\r\n\r\n  protected onPlay = () => {\r\n    let r = () => {\r\n      this.setProgress();\r\n\r\n      this.progressRAF = this.media.paused ? 0 : window.requestAnimationFrame(r);\r\n    };\r\n\r\n    if(this.progressRAF) {\r\n      window.cancelAnimationFrame(this.progressRAF);\r\n    }\r\n\r\n    if(this.streamable) {\r\n      this.setLoadProgress();\r\n    }\r\n\r\n    this.progressRAF = window.requestAnimationFrame(r);\r\n  };\r\n\r\n  protected onTimeUpdate = () => {\r\n    if(this.media.paused) {\r\n      this.setProgress();\r\n\r\n      if(this.streamable) {\r\n        this.setLoadProgress();\r\n      }\r\n    }\r\n  };\r\n\r\n  protected onProgress = (e: Event) => {\r\n    this.setLoadProgress();\r\n  };\r\n\r\n  protected scrub(e: GrabEvent) {\r\n    const scrubTime = super.scrub(e);\r\n    this.media.currentTime = scrubTime;\r\n    return scrubTime;\r\n  }\r\n\r\n  protected setLoadProgress() {\r\n    if(appMediaPlaybackController.isSafariBuffering(this.media)) return;\r\n    const buf = this.media.buffered;\r\n    const numRanges = buf.length;\r\n\r\n    const currentTime = this.media.currentTime;\r\n    let nearestStart = 0, end = 0;\r\n    for(let i = 0; i < numRanges; ++i) {\r\n      const start = buf.start(i);\r\n      if(currentTime >= start && start >= nearestStart) {\r\n        nearestStart = start;\r\n        end = buf.end(i);\r\n      }\r\n\r\n      //console.log('onProgress range:', i, buf.start(i), buf.end(i), this.media);\r\n    }\r\n\r\n    //console.log('onProgress correct range:', nearestStart, end, this.media);\r\n\r\n    const percents = this.media.duration ? end / this.media.duration : 0;\r\n    this.filledLoad.style.width = (percents * 100) + '%';\r\n    //this.filledLoad.style.transform = 'scaleX(' + percents + ')';\r\n  }\r\n\r\n  protected setSeekMax() {\r\n    this.max = this.media.duration || 0;\r\n    if(this.max > 0) {\r\n      this.onLoadedData();\r\n    } else {\r\n      this.media.addEventListener('loadeddata', this.onLoadedData);\r\n    }\r\n  }\r\n\r\n  public setProgress() {\r\n    if(appMediaPlaybackController.isSafariBuffering(this.media)) return;\r\n    const currentTime = this.media.currentTime;\r\n\r\n    super.setProgress(currentTime);\r\n  }\r\n\r\n  public setListeners() {\r\n    super.setListeners();\r\n    this.media.addEventListener('ended', this.onEnded);\r\n    this.media.addEventListener('play', this.onPlay);\r\n    this.media.addEventListener('timeupdate', this.onTimeUpdate);\r\n    this.streamable && this.media.addEventListener('progress', this.onProgress);\r\n  }\r\n\r\n  public removeListeners() {\r\n    super.removeListeners();\r\n\r\n    if(this.media) {\r\n      this.media.removeEventListener('loadeddata', this.onLoadedData);\r\n      this.media.removeEventListener('ended', this.onEnded);\r\n      this.media.removeEventListener('play', this.onPlay);\r\n      this.media.removeEventListener('timeupdate', this.onTimeUpdate);\r\n      this.streamable && this.media.removeEventListener('progress', this.onProgress);\r\n    }\r\n\r\n    if(this.progressRAF) {\r\n      window.cancelAnimationFrame(this.progressRAF);\r\n      this.progressRAF = 0;\r\n    }\r\n  }\r\n}\r\n","import { Message } from \"../../../../layer\";\r\nimport type { MyMessage } from \"../../appMessagesManager\";\r\n\r\nexport default function getMessageSenderPeerIdOrName(message: MyMessage) {\r\n  if(message.fromId) {\r\n    return {\r\n      peerId: message.fromId\r\n    };\r\n  } else {\r\n    return {\r\n      fromName: (message as Message.message).fwd_from?.from_name\r\n    };\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { i18n } from \"../lib/langPack\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport { NULL_PEER_ID } from \"../lib/mtproto/mtproto_config\";\r\nimport limitSymbols from \"../helpers/string/limitSymbols\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport wrapEmojiText from \"../lib/richTextProcessor/wrapEmojiText\";\r\nimport getPeerTitle from \"./wrappers/getPeerTitle\";\r\n\r\nexport type PeerTitleOptions = {\r\n  peerId?: PeerId,\r\n  fromName?: string,\r\n  plainText?: boolean,\r\n  onlyFirstName?: boolean,\r\n  dialog?: boolean,\r\n  limitSymbols?: number,\r\n  managers?: AppManagers\r\n};\r\n\r\nconst weakMap: WeakMap<HTMLElement, PeerTitle> = new WeakMap();\r\n\r\nrootScope.addEventListener('peer_title_edit', (peerId) => {\r\n  const elements = Array.from(document.querySelectorAll(`.peer-title[data-peer-id=\"${peerId}\"]`)) as HTMLElement[];\r\n  elements.forEach((element) => {\r\n    const peerTitle = weakMap.get(element);\r\n    //console.log('in the summer silence i was doing nothing', peerTitle, peerId);\r\n\r\n    if(peerTitle) {\r\n      peerTitle.update();\r\n    }\r\n  });\r\n});\r\n\r\nexport default class PeerTitle {\r\n  public element: HTMLElement;\r\n  public peerId: PeerId;\r\n  private fromName: string;\r\n  private plainText = false;\r\n  private onlyFirstName = false;\r\n  private dialog = false;\r\n  private limitSymbols: number;\r\n  private managers: AppManagers;\r\n\r\n  constructor(options?: PeerTitleOptions) {\r\n    this.element = document.createElement('span');\r\n    this.element.classList.add('peer-title');\r\n    this.element.setAttribute('dir', 'auto');\r\n\r\n    if(options) {\r\n      this.update(options);\r\n    }\r\n    \r\n    weakMap.set(this.element, this);\r\n  }\r\n\r\n  public setOptions(options?: PeerTitleOptions) {\r\n    if(!options) {\r\n      return;\r\n    }\r\n\r\n    for(const i in options) {\r\n      // @ts-ignore\r\n      const value = options[i];\r\n\r\n      if(typeof(value) !== 'object') {\r\n        // @ts-ignore\r\n        this.element.dataset[i] = value ? '' + (typeof(value) === 'boolean' ? +value : value) : '0';\r\n      }\r\n\r\n      // @ts-ignore\r\n      this[i] = value;\r\n    }\r\n  }\r\n\r\n  public async update(options?: PeerTitleOptions) {\r\n    this.setOptions(options);\r\n\r\n    let fromName = this.fromName;\r\n    if(fromName !== undefined) {\r\n      if(this.limitSymbols !== undefined) {\r\n        fromName = limitSymbols(fromName, this.limitSymbols, this.limitSymbols);\r\n      }\r\n\r\n      setInnerHTML(this.element, wrapEmojiText(fromName));\r\n      return;\r\n    }\r\n\r\n    if(this.peerId === undefined) {\r\n      this.peerId = NULL_PEER_ID;\r\n    }\r\n\r\n    if(this.peerId !== rootScope.myId || !this.dialog) {\r\n      const managers = this.managers ?? rootScope.managers;\r\n      setInnerHTML(this.element, await getPeerTitle(this.peerId, this.plainText, this.onlyFirstName, this.limitSymbols, managers));\r\n    } else {\r\n      replaceContent(this.element, i18n(this.onlyFirstName ? 'Saved' : 'SavedMessages'));\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\nimport getMessageSenderPeerIdOrName from \"../../lib/appManagers/utils/messages/getMessageSenderPeerIdOrName\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport PeerTitle from \"../peerTitle\";\r\n\r\nexport default async function wrapSenderToPeer(message: MyMessage) {\r\n  const senderTitle: HTMLElement = document.createElement('span');\r\n  senderTitle.classList.add('sender-title');\r\n  \r\n  const fromMe = message.fromId === rootScope.myId && message.peerId !== rootScope.myId;\r\n  senderTitle.append(\r\n    fromMe ? \r\n      i18n('FromYou') : \r\n      new PeerTitle({\r\n        ...getMessageSenderPeerIdOrName(message),\r\n        dialog: message.peerId === rootScope.myId\r\n      }).element\r\n    );\r\n\r\n  if(await rootScope.managers.appPeersManager.isAnyGroup(message.peerId) || fromMe) {\r\n    const peerTitle = new PeerTitle({peerId: message.peerId}).element;\r\n    senderTitle.append('  ', peerTitle);\r\n  }\r\n\r\n  return senderTitle;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { formatDateAccordingToTodayNew } from \"../../helpers/date\";\r\nimport { MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\n\r\nexport default function wrapSentTime(message: MyMessage) {\r\n  const el: HTMLElement = document.createElement('span');\r\n  el.classList.add('sent-time');\r\n  el.append(formatDateAccordingToTodayNew(new Date(message.date * 1000)));\r\n\r\n  return el;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport { wrapPhoto } from \"./wrappers\";\r\nimport ProgressivePreloader from \"./preloader\";\r\nimport appMediaPlaybackController, { MediaItem, MediaSearchContext } from \"./appMediaPlaybackController\";\r\nimport { DocumentAttribute, Message } from \"../layer\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport { IS_SAFARI } from \"../environment/userAgent\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport LazyLoadQueue from \"./lazyLoadQueue\";\r\nimport deferredPromise, { CancellablePromise } from \"../helpers/cancellablePromise\";\r\nimport ListenerSetter, { Listener } from \"../helpers/listenerSetter\";\r\nimport noop from \"../helpers/noop\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport { joinElementsWith } from \"../lib/langPack\";\r\nimport { MiddleEllipsisElement } from \"./middleEllipsis\";\r\nimport { formatFullSentTime } from \"../helpers/date\";\r\nimport throttleWithRaf from \"../helpers/schedulers/throttleWithRaf\";\r\nimport { NULL_PEER_ID } from \"../lib/mtproto/mtproto_config\";\r\nimport formatBytes from \"../helpers/formatBytes\";\r\nimport { animateSingle } from \"../helpers/animation\";\r\nimport clamp from \"../helpers/number/clamp\";\r\nimport toHHMMSS from \"../helpers/string/toHHMMSS\";\r\nimport MediaProgressLine from \"./mediaProgressLine\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport wrapEmojiText from \"../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapSenderToPeer from \"./wrappers/senderToPeer\";\r\nimport wrapSentTime from \"./wrappers/sentTime\";\r\nimport getMediaFromMessage from \"../lib/appManagers/utils/messages/getMediaFromMessage\";\r\nimport appDownloadManager from \"../lib/appManagers/appDownloadManager\";\r\n\r\nrootScope.addEventListener('messages_media_read', ({mids, peerId}) => {\r\n  mids.forEach((mid) => {\r\n    const attr = `[data-mid=\"${mid}\"][data-peer-id=\"${peerId}\"]`;\r\n    (Array.from(document.querySelectorAll(`audio-element.is-unread${attr}, .media-round.is-unread${attr}`)) as AudioElement[]).forEach((elem) => {\r\n      elem.classList.remove('is-unread');\r\n    });\r\n  });\r\n});\r\n\r\n// https://github.com/LonamiWebs/Telethon/blob/4393ec0b83d511b6a20d8a20334138730f084375/telethon/utils.py#L1285\r\nexport function decodeWaveform(waveform: Uint8Array | number[]) {\r\n  if(!(waveform instanceof Uint8Array)) {\r\n    waveform = new Uint8Array(waveform);\r\n  }\r\n\r\n  const bitCount = waveform.length * 8;\r\n  const valueCount = bitCount / 5 | 0;\r\n  if(!valueCount) {\r\n    return new Uint8Array([]);\r\n  }\r\n\r\n  let result: Uint8Array;\r\n  try {\r\n    const dataView = new DataView(waveform.buffer);\r\n    result = new Uint8Array(valueCount);\r\n    for(let i = 0; i < valueCount; i++) {\r\n      const byteIndex = i * 5 / 8 | 0;\r\n      const bitShift = i * 5 % 8;\r\n      const value = dataView.getUint16(byteIndex, true);\r\n      result[i] = (value >> bitShift) & 0b00011111;\r\n    }\r\n  } catch(err) {\r\n    result = new Uint8Array([]);\r\n  }\r\n\r\n  /* var byteIndex = (valueCount - 1) / 8 | 0;\r\n  var bitShift = (valueCount - 1) % 8;\r\n  if(byteIndex === waveform.length - 1) {\r\n    var value = waveform[byteIndex];\r\n  } else {\r\n    var value = dataView.getUint16(byteIndex, true);\r\n  }\r\n  console.log('decoded waveform, setting last value:', value, byteIndex, bitShift);\r\n  result[valueCount - 1] = (value >> bitShift) & 0b00011111; */\r\n  return result;\r\n}\r\n\r\nfunction createWaveformBars(waveform: Uint8Array, duration: number) {\r\n  const barWidth = 2;\r\n  const barMargin = 2;      //mediaSizes.isMobile ? 2 : 1;\r\n  const barHeightMin = 4;   //mediaSizes.isMobile ? 3 : 2;\r\n  const barHeightMax = mediaSizes.isMobile ? 16 : 23;\r\n  // const availW = 150;       //mediaSizes.isMobile ? 152 : 190;\r\n\r\n  const minW = mediaSizes.isMobile ? 152 : 190;\r\n  const maxW = mediaSizes.isMobile ? 190 : 256;\r\n  const availW = clamp(duration / 60 * maxW, minW, maxW); // mediaSizes.isMobile ? 152 : 224;\r\n\r\n  const svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\r\n  svg.classList.add('audio-waveform-bars');\r\n  svg.setAttributeNS(null, 'width', '' + availW);\r\n  svg.setAttributeNS(null, 'height', '' + barHeightMax);\r\n  svg.setAttributeNS(null, 'viewBox', `0 0 ${availW} ${barHeightMax}`);\r\n\r\n  //console.log('decoded waveform:', waveform);\r\n\r\n  const normValue = Math.max(...waveform);\r\n  const wfSize = waveform.length ? waveform.length : 100;\r\n  const barCount = Math.min((availW / (barWidth + barMargin)) | 0, wfSize);\r\n\r\n  let maxValue = 0;\r\n  const maxDelta = barHeightMax - barHeightMin;\r\n\r\n  let html = '';\r\n  for(let i = 0, barX = 0, sumI = 0; i < wfSize; ++i) {\r\n    const value = waveform[i] || 0;\r\n    if((sumI + barCount) >= wfSize) { // draw bar\r\n      sumI = sumI + barCount - wfSize;\r\n\t\t\tif(sumI < (barCount + 1) / 2) {\r\n\t\t\t\tif(maxValue < value) maxValue = value;\r\n      }\r\n      \r\n      const bar_value = Math.max(((maxValue * maxDelta) + ((normValue + 1) / 2)) / (normValue + 1), barHeightMin);\r\n      \r\n      const h = `\r\n      <rect x=\"${barX}\" y=\"${barHeightMax - bar_value}\" width=\"${barWidth}\" height=\"${bar_value}\" rx=\"1\" ry=\"1\"></rect>\r\n      `;\r\n      html += h;\r\n\r\n      barX += barWidth + barMargin;\r\n\r\n      if(sumI < (barCount + 1) / 2) {\r\n        maxValue = 0;\r\n      } else {\r\n        maxValue = value;\r\n      }\r\n    } else {\r\n      if(maxValue < value) maxValue = value;\r\n\r\n      sumI += barCount;\r\n    }\r\n  }\r\n\r\n  const container = document.createElement('div');\r\n  container.classList.add('audio-waveform');\r\n  container.append(svg);\r\n\r\n  svg.insertAdjacentHTML('beforeend', html);\r\n  return {svg, container, availW};\r\n}\r\n\r\nasync function wrapVoiceMessage(audioEl: AudioElement) {\r\n  audioEl.classList.add('is-voice');\r\n\r\n  const message = audioEl.message;\r\n  const doc = getMediaFromMessage(message) as MyDocument;\r\n\r\n  if(message.pFlags.out) {\r\n    audioEl.classList.add('is-out');\r\n  }\r\n\r\n  let waveform = (doc.attributes.find((attribute) => attribute._ === 'documentAttributeAudio') as DocumentAttribute.documentAttributeAudio).waveform || new Uint8Array([]);\r\n  waveform = decodeWaveform(waveform.slice(0, 63));\r\n  \r\n  const {svg, container: svgContainer, availW} = createWaveformBars(waveform, doc.duration);\r\n  \r\n  const fakeSvgContainer = svgContainer.cloneNode(true) as HTMLElement;\r\n  fakeSvgContainer.classList.add('audio-waveform-fake');\r\n  svgContainer.classList.add('audio-waveform-background');\r\n\r\n  const waveformContainer = document.createElement('div');\r\n  waveformContainer.classList.add('audio-waveform-container');\r\n  waveformContainer.append(svgContainer, fakeSvgContainer);\r\n\r\n  const timeDiv = document.createElement('div');\r\n  timeDiv.classList.add('audio-time');\r\n  audioEl.append(waveformContainer, timeDiv);\r\n\r\n  let progress = svg as any as HTMLElement;\r\n  \r\n  const onLoad = () => {\r\n    let audio = audioEl.audio;\r\n\r\n    const setAnimation = () => {\r\n      animateSingle(() => {\r\n        if(!audio) return false;\r\n        onTimeUpdate();\r\n        return !audio.paused;\r\n      }, audioEl);\r\n    };\r\n\r\n    const onTimeUpdate = () => {\r\n      fakeSvgContainer.style.width = (audio.currentTime / audio.duration * 100) + '%';\r\n    };\r\n\r\n    if(!audio.paused || (audio.currentTime > 0 && audio.currentTime !== audio.duration)) {\r\n      onTimeUpdate();\r\n    }\r\n\r\n    const throttledTimeUpdate = throttleWithRaf(onTimeUpdate);\r\n    audioEl.addAudioListener('timeupdate', throttledTimeUpdate);\r\n    audioEl.addAudioListener('ended', throttledTimeUpdate);\r\n    audioEl.addAudioListener('play', setAnimation);\r\n\r\n    audioEl.readyPromise.then(() => {\r\n      let mousedown = false, mousemove = false;\r\n      progress.addEventListener('mouseleave', (e) => {\r\n        if(mousedown) {\r\n          audio.play();\r\n          mousedown = false;\r\n        }\r\n        mousemove = false;\r\n      })\r\n      progress.addEventListener('mousemove', (e) => {\r\n        mousemove = true;\r\n        if(mousedown) scrub(e);\r\n      });\r\n      progress.addEventListener('mousedown', (e) => {\r\n        e.preventDefault();\r\n        if(e.button !== 0) return;\r\n        if(!audio.paused) {\r\n          audio.pause();\r\n        }\r\n        \r\n        scrub(e);\r\n        mousedown = true;\r\n      });\r\n      progress.addEventListener('mouseup', (e) => {\r\n        if(mousemove && mousedown) {\r\n          audio.play();\r\n          mousedown = false;\r\n        }\r\n      });\r\n      attachClickEvent(progress, (e) => {\r\n        cancelEvent(e);\r\n        if(!audio.paused) scrub(e);\r\n      });\r\n      \r\n      function scrub(e: MouseEvent | TouchEvent) {\r\n        let offsetX: number;\r\n        if(e instanceof MouseEvent) {\r\n          offsetX = e.offsetX;\r\n        } else { // touch\r\n          const rect = (e.target as HTMLElement).getBoundingClientRect();\r\n          offsetX = e.targetTouches[0].pageX - rect.left;\r\n        }\r\n        \r\n        const scrubTime = offsetX / availW /* width */ * audio.duration;\r\n        audio.currentTime = scrubTime;\r\n      }\r\n    }, noop);\r\n    \r\n    return () => {\r\n      progress.remove();\r\n      progress = null;\r\n      audio = null;\r\n    };\r\n  };\r\n\r\n  return onLoad;\r\n}\r\n\r\nasync function wrapAudio(audioEl: AudioElement) {\r\n  const withTime = audioEl.withTime;\r\n\r\n  const message = audioEl.message;\r\n  const doc = getMediaFromMessage(message) as MyDocument;\r\n\r\n  const isVoice = doc.type === 'voice' || doc.type === 'round';\r\n  const descriptionEl = document.createElement('div');\r\n  descriptionEl.classList.add('audio-description');\r\n\r\n  const audioAttribute = doc.attributes.find((attr) => attr._ === 'documentAttributeAudio') as DocumentAttribute.documentAttributeAudio;\r\n  \r\n  if(!isVoice) {\r\n    const parts: (Node | string)[] = [];\r\n    if(audioAttribute?.performer) {\r\n      parts.push(wrapEmojiText(audioAttribute.performer));\r\n    }\r\n\r\n    if(withTime) {\r\n      parts.push(formatFullSentTime(message.date));\r\n    } else if(!parts.length) {\r\n      parts.push(formatBytes(doc.size));\r\n    }\r\n\r\n    if(audioEl.showSender) {\r\n      parts.push(await wrapSenderToPeer(message));\r\n    }\r\n\r\n    descriptionEl.append(...joinElementsWith(parts, '  '));\r\n  }\r\n\r\n  const html = `\r\n  <div class=\"audio-details\">\r\n    <div class=\"audio-title\"></div>\r\n    <div class=\"audio-subtitle\"><div class=\"audio-time\"></div></div>\r\n  </div>`;\r\n  audioEl.insertAdjacentHTML('beforeend', html);\r\n\r\n  const titleEl = audioEl.querySelector('.audio-title') as HTMLElement;\r\n\r\n  const middleEllipsisEl = new MiddleEllipsisElement();\r\n  middleEllipsisEl.dataset.fontWeight = audioEl.dataset.fontWeight;\r\n  middleEllipsisEl.dataset.sizeType = audioEl.dataset.sizeType;\r\n  if(isVoice) {\r\n    middleEllipsisEl.append(await wrapSenderToPeer(message));\r\n  } else {\r\n    setInnerHTML(middleEllipsisEl, wrapEmojiText(audioAttribute?.title ?? doc.file_name));\r\n  }\r\n\r\n  titleEl.append(middleEllipsisEl);\r\n\r\n  if(audioEl.showSender) {\r\n    titleEl.append(wrapSentTime(message));\r\n  }\r\n  \r\n  const subtitleDiv = audioEl.querySelector('.audio-subtitle') as HTMLDivElement;\r\n  subtitleDiv.append(descriptionEl);\r\n\r\n  const onLoad = () => {\r\n    let launched = false;\r\n\r\n    let progressLine = new MediaProgressLine(audioEl.audio, doc.supportsStreaming);\r\n\r\n    audioEl.addAudioListener('ended', () => {\r\n      audioEl.classList.remove('audio-show-progress');\r\n      // Reset subtitle\r\n      subtitleDiv.lastChild.replaceWith(descriptionEl);\r\n      launched = false;\r\n    });\r\n\r\n    const onPlay = () => {\r\n      if(!launched) {\r\n        audioEl.classList.add('audio-show-progress');\r\n        launched = true;\r\n\r\n        if(progressLine) {\r\n          subtitleDiv.lastChild.replaceWith(progressLine.container);\r\n        }\r\n      }\r\n    };\r\n\r\n    audioEl.addAudioListener('play', onPlay);\r\n\r\n    if(!audioEl.audio.paused || audioEl.audio.currentTime > 0) {\r\n      onPlay();\r\n    }\r\n\r\n    return () => {\r\n      progressLine.removeListeners();\r\n      progressLine.container.remove();\r\n      progressLine = null;\r\n    };\r\n  };\r\n\r\n  return onLoad;\r\n}\r\n\r\nfunction constructDownloadPreloader(tryAgainOnFail = true) {\r\n  const preloader = new ProgressivePreloader({cancelable: true, tryAgainOnFail});\r\n  preloader.construct();\r\n\r\n  if(!tryAgainOnFail) {\r\n    preloader.circle.setAttributeNS(null, 'r', '23');\r\n    preloader.totalLength = 143.58203125;\r\n  }\r\n\r\n  return preloader;\r\n}\r\n\r\nexport const findMediaTargets = (anchor: HTMLElement, anchorMid: number/* , useSearch: boolean */) => {\r\n  let prev: MediaItem[], next: MediaItem[];\r\n  // if(anchor.classList.contains('search-super-item') || !useSearch) {\r\n    const isBubbles = !anchor.classList.contains('search-super-item');\r\n    const container = findUpClassName(anchor, !isBubbles ? 'tabs-tab' : 'bubbles-inner');\r\n    if(container) {\r\n      const attr = `:not([data-is-outgoing=\"1\"])`;\r\n      const justAudioSelector = `.audio:not(.is-voice)${attr}`;\r\n      let selectors: string[];\r\n      if(!anchor.matches(justAudioSelector)) {\r\n        selectors = [`.audio.is-voice${attr}`, `.media-round${attr}`];\r\n      } else {\r\n        selectors = [justAudioSelector];\r\n      }\r\n\r\n      if(isBubbles) {\r\n        const prefix = '.bubble:not(.webpage) ';\r\n        selectors = selectors.map((s) => prefix + s);\r\n      }\r\n\r\n      const selector = selectors.join(', ');\r\n\r\n      const elements = Array.from(container.querySelectorAll(selector)) as HTMLElement[];\r\n      const idx = elements.indexOf(anchor);\r\n\r\n      const mediaItems: MediaItem[] = elements.map((element) => ({peerId: element.dataset.peerId.toPeerId(), mid: +element.dataset.mid}));\r\n\r\n      prev = mediaItems.slice(0, idx);\r\n      next = mediaItems.slice(idx + 1);\r\n    }\r\n  // }\r\n\r\n  if((next.length && next[0].mid < anchorMid) || (prev.length && prev[prev.length - 1].mid > anchorMid)) {\r\n    [prev, next] = [next.reverse(), prev.reverse()];\r\n  }\r\n\r\n  // prev = next = undefined;\r\n\r\n  return [prev, next];\r\n};\r\n\r\nexport default class AudioElement extends HTMLElement {\r\n  public audio: HTMLAudioElement;\r\n  public preloader: ProgressivePreloader;\r\n  public message: Message.message;\r\n  public withTime = false;\r\n  public voiceAsMusic = false;\r\n  public searchContext: MediaSearchContext;\r\n  public showSender = false;\r\n  public noAutoDownload: boolean;\r\n  public lazyLoadQueue: LazyLoadQueue;\r\n  public loadPromises: Promise<any>[];\r\n  public managers: AppManagers;\r\n\r\n  private listenerSetter = new ListenerSetter();\r\n  private onTypeDisconnect: () => void;\r\n  public onLoad: (autoload?: boolean) => void;\r\n  public readyPromise: CancellablePromise<void>;\r\n\r\n  public async render() {\r\n    this.classList.add('audio');\r\n    this.managers = rootScope.managers;\r\n\r\n    this.dataset.mid = '' + this.message.mid;\r\n    this.dataset.peerId = '' + this.message.peerId;\r\n\r\n    const doc = getMediaFromMessage(this.message) as MyDocument;\r\n    const isRealVoice = doc.type === 'voice';\r\n    const isVoice = !this.voiceAsMusic && isRealVoice;\r\n    const isOutgoing = this.message.pFlags.is_outgoing;\r\n    const uploadingFileName = this.message?.uploadingFileName;\r\n\r\n    const durationStr = toHHMMSS(doc.duration | 0);\r\n\r\n    this.innerHTML = `\r\n    <div class=\"audio-toggle audio-ico\">\r\n      <div class=\"audio-play-icon\">\r\n        <div class=\"part one\" x=\"0\" y=\"0\" fill=\"#fff\"></div>\r\n        <div class=\"part two\" x=\"0\" y=\"0\" fill=\"#fff\"></div>\r\n      </div>\r\n    </div>`;\r\n\r\n    const toggle = this.firstElementChild as HTMLElement;\r\n\r\n    const downloadDiv = document.createElement('div');\r\n    downloadDiv.classList.add('audio-download');\r\n\r\n    const isUnread = doc.type !== 'audio' && this.message && this.message.pFlags.media_unread;\r\n    if(isUnread) {\r\n      this.classList.add('is-unread');\r\n    }\r\n\r\n    if(uploadingFileName) {\r\n      this.classList.add('is-outgoing');\r\n      this.append(downloadDiv);\r\n    }\r\n\r\n    const onTypeLoad = await (isVoice ? wrapVoiceMessage(this) : wrapAudio(this));\r\n    \r\n    const audioTimeDiv = this.querySelector('.audio-time') as HTMLDivElement;\r\n    audioTimeDiv.innerHTML = durationStr;\r\n\r\n    const onLoad = this.onLoad = (autoload: boolean) => {\r\n      this.onLoad = undefined;\r\n\r\n      const audio = this.audio = appMediaPlaybackController.addMedia(this.message, autoload);\r\n\r\n      const readyPromise = this.readyPromise = deferredPromise<void>();\r\n      if(this.audio.readyState >= this.audio.HAVE_CURRENT_DATA) readyPromise.resolve();\r\n      else {\r\n        this.addAudioListener('canplay', () => readyPromise.resolve(), {once: true});\r\n      }\r\n\r\n      this.onTypeDisconnect = onTypeLoad();\r\n      \r\n      const getTimeStr = () => toHHMMSS(audio.currentTime | 0) + (isVoice ? (' / ' + durationStr) : '');\r\n\r\n      const onPlay = () => {\r\n        audioTimeDiv.innerText = getTimeStr();\r\n        toggle.classList.toggle('playing', !audio.paused);\r\n      };\r\n\r\n      if(!audio.paused || (audio.currentTime > 0 && audio.currentTime !== audio.duration)) {\r\n        onPlay();\r\n      }\r\n\r\n      const togglePlay = (e?: Event, paused = audio.paused) => {\r\n        e && cancelEvent(e);\r\n\r\n        if(paused) {\r\n          const hadSearchContext = !!this.searchContext;\r\n          if(appMediaPlaybackController.setSearchContext(this.searchContext || {\r\n            peerId: NULL_PEER_ID, \r\n            inputFilter: {_: 'inputMessagesFilterEmpty'}, \r\n            useSearch: false\r\n          })) {\r\n            const [prev, next] = !hadSearchContext ? [] : findMediaTargets(this, this.message.mid/* , this.searchContext.useSearch */);\r\n            appMediaPlaybackController.setTargets({peerId: this.message.peerId, mid: this.message.mid}, prev, next);\r\n          }\r\n\r\n          audio.play().catch(() => {});\r\n        } else {\r\n          audio.pause();\r\n        }\r\n      };\r\n\r\n      attachClickEvent(toggle, (e) => togglePlay(e), {listenerSetter: this.listenerSetter});\r\n\r\n      this.addAudioListener('ended', () => {\r\n        toggle.classList.remove('playing');\r\n        audioTimeDiv.innerText = durationStr;\r\n      });\r\n\r\n      this.addAudioListener('timeupdate', () => {\r\n        if((!audio.currentTime && audio.paused) || appMediaPlaybackController.isSafariBuffering(audio)) return;\r\n        audioTimeDiv.innerText = getTimeStr();\r\n      });\r\n\r\n      this.addAudioListener('pause', () => {\r\n        toggle.classList.remove('playing');\r\n      });\r\n\r\n      this.addAudioListener('play', onPlay);\r\n\r\n      return togglePlay;\r\n    };\r\n\r\n    if(doc.thumbs?.length) {\r\n      const imgs: HTMLElement[] = [];\r\n      const wrapped = await wrapPhoto({\r\n        photo: doc, \r\n        message: null, \r\n        container: toggle, \r\n        boxWidth: 48, \r\n        boxHeight: 48,\r\n        loadPromises: this.loadPromises,\r\n        withoutPreloader: true,\r\n        lazyLoadQueue: this.lazyLoadQueue\r\n      });\r\n      toggle.style.width = toggle.style.height = '';\r\n      if(wrapped.images.thumb) imgs.push(wrapped.images.thumb);\r\n      if(wrapped.images.full) imgs.push(wrapped.images.full);\r\n\r\n      this.classList.add('audio-with-thumb');\r\n      imgs.forEach((img) => img.classList.add('audio-thumb'));\r\n    }\r\n\r\n    if(!isOutgoing) {\r\n      let preloader: ProgressivePreloader = this.preloader;\r\n\r\n      const autoDownload = doc.type !== 'audio'/*  || !this.noAutoDownload */;\r\n      onLoad(autoDownload);\r\n\r\n      const r = (shouldPlay: boolean) => {\r\n        if(this.audio.src) {\r\n          return;\r\n        }\r\n\r\n        appMediaPlaybackController.resolveWaitingForLoadMedia(this.message.peerId, this.message.mid, this.message.pFlags.is_scheduled);\r\n\r\n        const onDownloadInit = () => {\r\n          if(shouldPlay) {\r\n            appMediaPlaybackController.willBePlayed(this.audio); // prepare for loading audio\r\n  \r\n            if(IS_SAFARI && !this.audio.autoplay) {\r\n              this.audio.autoplay = true;\r\n            }\r\n          }\r\n        };\r\n\r\n        onDownloadInit();\r\n\r\n        if(!preloader) {\r\n          if(doc.supportsStreaming) {\r\n            this.classList.add('corner-download');\r\n\r\n            let pauseListener: Listener;\r\n            const onPlay = () => {\r\n              const preloader = constructDownloadPreloader(false);\r\n              const deferred = deferredPromise<void>();\r\n              deferred.notifyAll({done: 75, total: 100});\r\n              deferred.catch(() => {\r\n                this.audio.pause();\r\n                appMediaPlaybackController.willBePlayed(undefined);\r\n              });\r\n              deferred.cancel = () => {\r\n                deferred.cancel = noop;\r\n                const err = new Error();\r\n                (err as any).type = 'CANCELED';\r\n                deferred.reject(err);\r\n              };\r\n              preloader.attach(downloadDiv, false, deferred);\r\n\r\n              pauseListener = this.addAudioListener('pause', () => {\r\n                deferred.cancel();\r\n              }, {once: true}) as any;\r\n\r\n              onDownloadInit();\r\n            };\r\n\r\n            /* if(!this.audio.paused) {\r\n              onPlay();\r\n            } */\r\n\r\n            const playListener: any = this.addAudioListener('play', onPlay);\r\n            this.readyPromise.then(() => {\r\n              this.listenerSetter.remove(playListener);\r\n              this.listenerSetter.remove(pauseListener);\r\n            });\r\n          } else {\r\n            preloader = constructDownloadPreloader();\r\n\r\n            if(!shouldPlay) {\r\n              this.readyPromise = deferredPromise();\r\n            }\r\n\r\n            const load = () => {\r\n              onDownloadInit();\r\n\r\n              const download = appDownloadManager.downloadMediaURL({media: doc});\r\n              \r\n              if(!shouldPlay) {\r\n                download.then(() => {\r\n                  this.readyPromise.resolve();\r\n                });\r\n              }\r\n\r\n              preloader.attach(downloadDiv, false, download);\r\n              return {download};\r\n            };\r\n\r\n            preloader.setDownloadFunction(load);\r\n            load();\r\n          }\r\n        }\r\n\r\n        if(this.classList.contains('corner-download')) {\r\n          toggle.append(downloadDiv);\r\n        } else {\r\n          this.append(downloadDiv);\r\n        }\r\n\r\n        this.classList.add('downloading');\r\n\r\n        this.readyPromise.then(() => {\r\n          this.classList.remove('downloading');\r\n          downloadDiv.classList.add('downloaded');\r\n          setTimeout(() => {\r\n            downloadDiv.remove();\r\n          }, 200);\r\n  \r\n          //setTimeout(() => {\r\n            // release loaded audio\r\n            if(appMediaPlaybackController.willBePlayedMedia === this.audio) {\r\n              this.audio.play();\r\n              appMediaPlaybackController.willBePlayed(undefined);\r\n            }\r\n          //}, 10e3);\r\n        });\r\n      };\r\n\r\n      if(!this.audio?.src) {\r\n        if(autoDownload) {\r\n          r(false);\r\n        } else {\r\n          attachClickEvent(toggle, () => {\r\n            r(true);\r\n          }, {once: true, capture: true, passive: false, listenerSetter: this.listenerSetter});\r\n        }\r\n      }\r\n    } else if(uploadingFileName) {\r\n      this.preloader = constructDownloadPreloader(false);\r\n      this.preloader.attachPromise(appDownloadManager.getUpload(uploadingFileName));\r\n      this.dataset.isOutgoing = '1';\r\n      this.preloader.attach(downloadDiv, false);\r\n      //onLoad();\r\n    }\r\n  }\r\n\r\n  get addAudioListener() {\r\n    return this.listenerSetter.add(this.audio);\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    setTimeout(() => {\r\n      if(this.isConnected) {\r\n        return;\r\n      }\r\n      \r\n      if(this.onTypeDisconnect) {\r\n        this.onTypeDisconnect();\r\n        this.onTypeDisconnect = null;\r\n      }\r\n  \r\n      if(this.readyPromise) {\r\n        this.readyPromise.reject();\r\n      }\r\n  \r\n      if(this.listenerSetter) {\r\n        this.listenerSetter.removeAll();\r\n        this.listenerSetter = null;\r\n      }\r\n  \r\n      if(this.preloader) {\r\n        this.preloader = null;\r\n      }\r\n    }, 100);\r\n  }\r\n}\r\n\r\ncustomElements.define(\"audio-element\", AudioElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { IS_SAFARI } from \"../../environment/userAgent\";\r\nimport { animateSingle } from \"../../helpers/animation\";\r\nimport { ChatAutoDownloadSettings } from \"../../helpers/autoDownload\";\r\nimport deferredPromise from \"../../helpers/cancellablePromise\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport createVideo from \"../../helpers/dom/createVideo\";\r\nimport isInDOM from \"../../helpers/dom/isInDOM\";\r\nimport renderImageFromUrl from \"../../helpers/dom/renderImageFromUrl\";\r\nimport mediaSizes, { ScreenSize } from \"../../helpers/mediaSizes\";\r\nimport onMediaLoad from \"../../helpers/onMediaLoad\";\r\nimport { fastRaf } from \"../../helpers/schedulers\";\r\nimport throttle from \"../../helpers/schedulers/throttle\";\r\nimport sequentialDom from \"../../helpers/sequentialDom\";\r\nimport toHHMMSS from \"../../helpers/string/toHHMMSS\";\r\nimport { Message, PhotoSize } from \"../../layer\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport { NULL_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport { ThumbCache } from \"../../lib/storages/thumbs\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport appMediaPlaybackController, { MediaSearchContext } from \"../appMediaPlaybackController\";\r\nimport { findMediaTargets } from \"../audio\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport ProgressivePreloader from \"../preloader\";\r\nimport wrapPhoto from './photo';\r\n\r\nconst MAX_VIDEO_AUTOPLAY_SIZE = 50 * 1024 * 1024; // 50 MB\r\n\r\nlet roundVideoCircumference = 0;\r\nmediaSizes.addEventListener('changeScreen', (from, to) => {\r\n  if(to === ScreenSize.mobile || from === ScreenSize.mobile) {\r\n    const elements = Array.from(document.querySelectorAll('.media-round .progress-ring')) as SVGSVGElement[];\r\n    const width = mediaSizes.active.round.width;\r\n    const halfSize = width / 2;\r\n    const radius = halfSize - 7;\r\n    roundVideoCircumference = 2 * Math.PI * radius;\r\n    elements.forEach((element) => {\r\n      element.setAttributeNS(null, 'width', '' + width);\r\n      element.setAttributeNS(null, 'height', '' + width);\r\n\r\n      const circle = element.firstElementChild as SVGCircleElement;\r\n      circle.setAttributeNS(null, 'cx', '' + halfSize);\r\n      circle.setAttributeNS(null, 'cy', '' + halfSize);\r\n      circle.setAttributeNS(null, 'r', '' + radius);\r\n\r\n      circle.style.strokeDasharray = roundVideoCircumference + ' ' + roundVideoCircumference;\r\n      circle.style.strokeDashoffset = '' + roundVideoCircumference;\r\n    });\r\n  }\r\n});\r\n\r\nexport default async function wrapVideo({doc, container, message, boxWidth, boxHeight, withTail, isOut, middleware, lazyLoadQueue, noInfo, group, onlyPreview, withoutPreloader, loadPromises, noPlayButton, size, searchContext, autoDownload, managers = rootScope.managers}: {\r\n  doc: MyDocument, \r\n  container?: HTMLElement, \r\n  message?: Message.message, \r\n  boxWidth?: number, \r\n  boxHeight?: number, \r\n  withTail?: boolean, \r\n  isOut?: boolean,\r\n  middleware?: () => boolean,\r\n  lazyLoadQueue?: LazyLoadQueue,\r\n  noInfo?: true,\r\n  noPlayButton?: boolean,\r\n  group?: string,\r\n  onlyPreview?: boolean,\r\n  withoutPreloader?: boolean,\r\n  loadPromises?: Promise<any>[],\r\n  autoDownload?: ChatAutoDownloadSettings,\r\n  size?: PhotoSize,\r\n  searchContext?: MediaSearchContext,\r\n  managers?: AppManagers\r\n}) {\r\n  const autoDownloadSize = autoDownload?.video;\r\n  let noAutoDownload = autoDownloadSize === 0;\r\n  const isAlbumItem = !(boxWidth && boxHeight);\r\n  const canAutoplay = /* doc.sticker ||  */(\r\n    (\r\n      doc.type !== 'video' || (\r\n        doc.size <= MAX_VIDEO_AUTOPLAY_SIZE && \r\n        !isAlbumItem\r\n      )\r\n    ) && (doc.type === 'gif' ? rootScope.settings.autoPlay.gifs : rootScope.settings.autoPlay.videos)\r\n  );\r\n  let spanTime: HTMLElement, spanPlay: HTMLElement;\r\n\r\n  if(!noInfo) {\r\n    spanTime = document.createElement('span');\r\n    spanTime.classList.add('video-time');\r\n    container.append(spanTime);\r\n  \r\n    let needPlayButton = false;\r\n    if(doc.type !== 'gif') {\r\n      spanTime.innerText = toHHMMSS(doc.duration, false);\r\n\r\n      if(!noPlayButton && doc.type !== 'round') {\r\n        if(canAutoplay && !noAutoDownload) {\r\n          spanTime.classList.add('tgico', 'can-autoplay');\r\n        } else {\r\n          needPlayButton = true;\r\n        }\r\n      }\r\n    } else {\r\n      spanTime.innerText = 'GIF';\r\n\r\n      if(!canAutoplay && !noPlayButton) {\r\n        needPlayButton = true;\r\n        noAutoDownload = undefined;\r\n      }\r\n    }\r\n\r\n    if(needPlayButton) {\r\n      spanPlay = document.createElement('span');\r\n      spanPlay.classList.add('video-play', 'tgico-largeplay', 'btn-circle', 'position-center');\r\n      container.append(spanPlay);\r\n    }\r\n  }\r\n\r\n  let res: {\r\n    thumb?: typeof photoRes,\r\n    loadPromise: Promise<any>\r\n  } = {} as any;\r\n\r\n  if(doc.mime_type === 'image/gif') {\r\n    const photoRes = await wrapPhoto({\r\n      photo: doc, \r\n      message, \r\n      container, \r\n      boxWidth, \r\n      boxHeight, \r\n      withTail, \r\n      isOut, \r\n      lazyLoadQueue, \r\n      middleware,\r\n      withoutPreloader,\r\n      loadPromises,\r\n      autoDownloadSize,\r\n      size,\r\n      managers\r\n    });\r\n\r\n    res.thumb = photoRes;\r\n    res.loadPromise = photoRes.loadPromises.full;\r\n    return res;\r\n  }\r\n\r\n  /* const video = doc.type === 'round' ? appMediaPlaybackController.addMedia(doc, message.mid) as HTMLVideoElement : document.createElement('video');\r\n  if(video.parentElement) {\r\n    video.remove();\r\n  } */\r\n\r\n  let preloader: ProgressivePreloader; // it must be here, otherwise will get error before initialization in round onPlay\r\n\r\n  const video = createVideo();\r\n  video.classList.add('media-video');\r\n  video.muted = true;\r\n  if(doc.type === 'round') {\r\n    const divRound = document.createElement('div');\r\n    divRound.classList.add('media-round', 'z-depth-1');\r\n    divRound.dataset.mid = '' + message.mid;\r\n    divRound.dataset.peerId = '' + message.peerId;\r\n    (divRound as any).message = message;\r\n\r\n    const size = mediaSizes.active.round;\r\n    const halfSize = size.width / 2;\r\n    const strokeWidth = 3.5;\r\n    const radius = halfSize - (strokeWidth * 2);\r\n    divRound.innerHTML = `<svg class=\"progress-ring\" width=\"${size.width}\" height=\"${size.width}\" style=\"transform: rotate(-90deg);\">\r\n      <circle class=\"progress-ring__circle\" stroke=\"white\" stroke-opacity=\"0.3\" stroke-width=\"${strokeWidth}\" cx=\"${halfSize}\" cy=\"${halfSize}\" r=\"${radius}\" fill=\"transparent\"/>\r\n    </svg>`;\r\n\r\n    const circle = divRound.firstElementChild.firstElementChild as SVGCircleElement;\r\n    if(!roundVideoCircumference) {\r\n      roundVideoCircumference = 2 * Math.PI * radius;\r\n    }\r\n    circle.style.strokeDasharray = roundVideoCircumference + ' ' + roundVideoCircumference;\r\n    circle.style.strokeDashoffset = '' + roundVideoCircumference;\r\n    \r\n    spanTime.classList.add('tgico');\r\n\r\n    const isUnread = message.pFlags.media_unread;\r\n    if(isUnread) {\r\n      divRound.classList.add('is-unread');\r\n    }\r\n\r\n    const canvas = document.createElement('canvas');\r\n    canvas.width = canvas.height = doc.w/*  * window.devicePixelRatio */;\r\n\r\n    divRound.prepend(canvas, spanTime);\r\n    divRound.append(video);\r\n    container.append(divRound);\r\n\r\n    const ctx = canvas.getContext('2d');\r\n    /* ctx.beginPath();\r\n    ctx.arc(canvas.width / 2, canvas.height / 2, canvas.width / 2, 0, Math.PI * 2);\r\n    ctx.clip(); */\r\n\r\n    const onLoad = () => {\r\n      const message: Message.message = (divRound as any).message;\r\n      const globalVideo = appMediaPlaybackController.addMedia(message, !noAutoDownload) as HTMLVideoElement;\r\n      const clear = () => {\r\n        (appImManager.chat.setPeerPromise || Promise.resolve()).finally(() => {\r\n          if(isInDOM(globalVideo)) {\r\n            return;\r\n          }\r\n  \r\n          globalVideo.removeEventListener('play', onPlay);\r\n          globalVideo.removeEventListener('timeupdate', throttledTimeUpdate);\r\n          globalVideo.removeEventListener('pause', onPaused);\r\n          globalVideo.removeEventListener('ended', onEnded);\r\n        });\r\n      };\r\n  \r\n      const onFrame = () => {\r\n        ctx.drawImage(globalVideo, 0, 0);\r\n  \r\n        const offset = roundVideoCircumference - globalVideo.currentTime / globalVideo.duration * roundVideoCircumference;\r\n        circle.style.strokeDashoffset = '' + offset;\r\n  \r\n        return !globalVideo.paused;\r\n      };\r\n\r\n      const onTimeUpdate = () => {\r\n        if(!globalVideo.duration) {\r\n          return;\r\n        }\r\n  \r\n        if(!isInDOM(globalVideo)) {\r\n          clear();\r\n          return;\r\n        }\r\n\r\n        if(globalVideo.paused) {\r\n          onFrame();\r\n        }\r\n  \r\n        spanTime.innerText = toHHMMSS(globalVideo.duration - globalVideo.currentTime, false);\r\n      };\r\n\r\n      const throttledTimeUpdate = throttle(() => {\r\n        fastRaf(onTimeUpdate);\r\n      }, 1000, false);\r\n  \r\n      const onPlay = () => {\r\n        video.classList.add('hide');\r\n        divRound.classList.remove('is-paused');\r\n        animateSingle(onFrame, canvas);\r\n  \r\n        if(preloader && preloader.preloader && preloader.preloader.classList.contains('manual')) {\r\n          preloader.onClick();\r\n        }\r\n      };\r\n  \r\n      const onPaused = () => {\r\n        if(!isInDOM(globalVideo)) {\r\n          clear();\r\n          return;\r\n        }\r\n  \r\n        divRound.classList.add('is-paused');\r\n      };\r\n  \r\n      const onEnded = () => {\r\n        video.classList.remove('hide');\r\n        divRound.classList.add('is-paused');\r\n        \r\n        video.currentTime = 0;\r\n        spanTime.innerText = toHHMMSS(globalVideo.duration, false);\r\n  \r\n        if(globalVideo.currentTime) {\r\n          globalVideo.currentTime = 0;\r\n        }\r\n      };\r\n  \r\n      globalVideo.addEventListener('play', onPlay);\r\n      globalVideo.addEventListener('timeupdate', throttledTimeUpdate);\r\n      globalVideo.addEventListener('pause', onPaused);\r\n      globalVideo.addEventListener('ended', onEnded);\r\n  \r\n      attachClickEvent(canvas, (e) => {\r\n        cancelEvent(e);\r\n  \r\n        // ! \r\n        if(preloader && !preloader.detached) {\r\n          preloader.onClick();\r\n        }\r\n        \r\n        // ! can't use it here. on Safari iOS video won't start.\r\n        /* if(globalVideo.readyState < 2) {\r\n          return;\r\n        } */\r\n  \r\n        if(globalVideo.paused) {\r\n          const hadSearchContext = !!searchContext;\r\n          if(appMediaPlaybackController.setSearchContext(searchContext || {\r\n            peerId: NULL_PEER_ID, \r\n            inputFilter: {_: 'inputMessagesFilterEmpty'}, \r\n            useSearch: false\r\n          })) {\r\n            const [prev, next] = !hadSearchContext ? [] : findMediaTargets(divRound, message.mid/* , searchContext.useSearch */);\r\n            appMediaPlaybackController.setTargets({peerId: message.peerId, mid: message.mid}, prev, next);\r\n          }\r\n          \r\n          globalVideo.play();\r\n        } else {\r\n          globalVideo.pause();\r\n        }\r\n      });\r\n  \r\n      if(globalVideo.paused) {\r\n        if(globalVideo.duration && globalVideo.currentTime !== globalVideo.duration && globalVideo.currentTime > 0) {\r\n          onFrame();\r\n          onTimeUpdate();\r\n          video.classList.add('hide');\r\n        } else {\r\n          onPaused();\r\n        }\r\n      } else {\r\n        onPlay();\r\n      }\r\n    };\r\n\r\n    if(message.pFlags.is_outgoing) {\r\n      (divRound as any).onLoad = onLoad;\r\n      divRound.dataset.isOutgoing = '1';\r\n    } else {\r\n      onLoad();\r\n    }\r\n  } else {\r\n    video.autoplay = true; //  safari\r\n  }\r\n\r\n  let photoRes: Awaited<ReturnType<typeof wrapPhoto>>;\r\n  if(message) {\r\n    photoRes = await wrapPhoto({\r\n      photo: doc, \r\n      message, \r\n      container, \r\n      boxWidth, \r\n      boxHeight, \r\n      withTail, \r\n      isOut, \r\n      lazyLoadQueue, \r\n      middleware,\r\n      withoutPreloader: true,\r\n      loadPromises,\r\n      autoDownloadSize: autoDownload?.photo,\r\n      size,\r\n      managers\r\n    });\r\n\r\n    res.thumb = photoRes;\r\n\r\n    if((!canAutoplay && doc.type !== 'gif') || onlyPreview) {\r\n      res.loadPromise = photoRes.loadPromises.full;\r\n      return res;\r\n    }\r\n\r\n    if(withTail) {\r\n      const foreignObject = (photoRes.images.thumb || photoRes.images.full).parentElement;\r\n      video.width = +foreignObject.getAttributeNS(null, 'width');\r\n      video.height = +foreignObject.getAttributeNS(null, 'height');\r\n      foreignObject.append(video);\r\n    }\r\n  } else { // * gifs masonry\r\n    // const gotThumb = managers.appDocsManager.getThumb(doc, false);\r\n    // if(gotThumb) {\r\n    //   gotThumb.promise.then(() => {\r\n    //     video.poster = gotThumb.cacheContext.url;\r\n    //   });\r\n    // }\r\n  }\r\n\r\n  if(!video.parentElement && container) {\r\n    (photoRes?.aspecter || container).append(video);\r\n  }\r\n\r\n  let cacheContext: ThumbCache;\r\n  const getCacheContext = async() => {\r\n    return cacheContext = await managers.thumbsStorage.getCacheContext(doc);\r\n  };\r\n\r\n  await getCacheContext();\r\n\r\n  const uploadFileName = message?.uploadingFileName;\r\n  if(uploadFileName) { // means upload\r\n    preloader = new ProgressivePreloader({\r\n      attachMethod: 'prepend',\r\n      isUpload: true\r\n    });\r\n    preloader.attachPromise(appDownloadManager.getUpload(uploadFileName));\r\n    preloader.attach(container, false);\r\n    noAutoDownload = undefined;\r\n  } else if(!cacheContext.downloaded && !doc.supportsStreaming && !withoutPreloader) {\r\n    preloader = new ProgressivePreloader({\r\n      attachMethod: 'prepend'\r\n    });\r\n  } else if(doc.supportsStreaming) {\r\n    preloader = new ProgressivePreloader({\r\n      cancelable: false,\r\n      attachMethod: 'prepend'\r\n    });\r\n  }\r\n\r\n  const renderDeferred = deferredPromise<void>();\r\n  video.addEventListener('error', (e) => {\r\n    if(video.error.code !== 4) {\r\n      console.error(\"Error \" + video.error.code + \"; details: \" + video.error.message);\r\n    }\r\n    \r\n    if(preloader && !uploadFileName) {\r\n      preloader.detach();\r\n    }\r\n\r\n    if(!renderDeferred.isFulfilled) {\r\n      renderDeferred.resolve();\r\n    }\r\n  }, {once: true});\r\n\r\n  onMediaLoad(video).then(() => {\r\n    if(group) {\r\n      animationIntersector.addAnimation(video, group);\r\n    }\r\n\r\n    if(preloader && !uploadFileName) {\r\n      preloader.detach();\r\n    }\r\n\r\n    renderDeferred.resolve();\r\n  });\r\n\r\n  if(doc.type === 'video') {\r\n    const onTimeUpdate = () => {\r\n      if(!video.duration) {\r\n        return;\r\n      }\r\n      \r\n      spanTime.innerText = toHHMMSS(video.duration - video.currentTime, false);\r\n    };\r\n\r\n    const throttledTimeUpdate = throttle(() => {\r\n      fastRaf(onTimeUpdate);\r\n    }, 1e3, false);\r\n\r\n    video.addEventListener('timeupdate', throttledTimeUpdate);\r\n\r\n    if(spanPlay) {\r\n      video.addEventListener('timeupdate', () => {\r\n        sequentialDom.mutateElement(spanPlay, () => {\r\n          spanPlay.remove();\r\n        });\r\n      }, {once: true});\r\n    }\r\n  }\r\n\r\n  video.muted = true;\r\n  video.loop = true;\r\n  //video.play();\r\n  video.autoplay = true;\r\n\r\n  let loadPhotoThumbFunc = noAutoDownload && photoRes?.preloader?.loadFunc;\r\n  const load = async() => {\r\n    if(preloader && noAutoDownload && !withoutPreloader) {\r\n      preloader.construct();\r\n      preloader.setManual();\r\n    }\r\n\r\n    await getCacheContext();\r\n    let loadPromise: Promise<any> = Promise.resolve();\r\n    if((preloader && !uploadFileName) || withoutPreloader) {\r\n      if(!cacheContext.downloaded && !doc.supportsStreaming) {\r\n        const promise = loadPromise = managers.apiFileManager.downloadMediaURL({media: doc, queueId: lazyLoadQueue?.queueId, onlyCache: noAutoDownload});\r\n        if(preloader) {\r\n          preloader.attach(container, false, promise);\r\n        }\r\n      } else if(doc.supportsStreaming) {\r\n        if(noAutoDownload) {\r\n          loadPromise = Promise.reject();\r\n        } else if(!cacheContext.downloaded && preloader) { // * check for uploading video\r\n          preloader.attach(container, false, null);\r\n          video.addEventListener(IS_SAFARI ? 'timeupdate' : 'canplay', () => {\r\n            preloader.detach();\r\n          }, {once: true});\r\n        }\r\n      }\r\n    }\r\n\r\n    if(!noAutoDownload && loadPhotoThumbFunc) {\r\n      loadPhotoThumbFunc();\r\n      loadPhotoThumbFunc = null;\r\n    }\r\n\r\n    noAutoDownload = undefined;\r\n\r\n    loadPromise.then(async() => {\r\n      if(middleware && !middleware()) {\r\n        renderDeferred.resolve();\r\n        return;\r\n      }\r\n\r\n      if(doc.type === 'round') {\r\n        appMediaPlaybackController.resolveWaitingForLoadMedia(message.peerId, message.mid, message.pFlags.is_scheduled);\r\n      }\r\n\r\n      await getCacheContext();\r\n      renderImageFromUrl(video, cacheContext.url);\r\n    }, () => {});\r\n\r\n    return {download: loadPromise, render: renderDeferred};\r\n  };\r\n\r\n  if(preloader && !uploadFileName) {\r\n    preloader.setDownloadFunction(load);\r\n  }\r\n\r\n  /* if(doc.size >= 20e6 && !doc.downloaded) {\r\n    let downloadDiv = document.createElement('div');\r\n    downloadDiv.classList.add('download');\r\n\r\n    let span = document.createElement('span');\r\n    span.classList.add('btn-circle', 'tgico-download');\r\n    downloadDiv.append(span);\r\n\r\n    downloadDiv.addEventListener('click', () => {\r\n      downloadDiv.remove();\r\n      loadVideo();\r\n    });\r\n\r\n    container.prepend(downloadDiv);\r\n\r\n    return;\r\n  } */\r\n\r\n  if(doc.type === 'gif' && !canAutoplay) {\r\n    attachClickEvent(container, (e) => {\r\n      cancelEvent(e);\r\n      spanPlay.remove();\r\n      load();\r\n    }, {capture: true, once: true});\r\n  } else {\r\n    res.loadPromise = !lazyLoadQueue ? \r\n      (await load()).render : \r\n      (lazyLoadQueue.push({div: container, load: () => load().then(({render}) => render)}), Promise.resolve());\r\n  }\r\n\r\n  return res;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { ChatAutoDownloadSettings } from \"../../helpers/autoDownload\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport { Message, PhotoSize } from \"../../layer\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getMediaFromMessage from \"../../lib/appManagers/utils/messages/getMediaFromMessage\";\r\nimport choosePhotoSize from \"../../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport Chat from \"../chat/chat\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport prepareAlbum from \"../prepareAlbum\";\r\nimport wrapPhoto from \"./photo\";\r\nimport wrapVideo from \"./video\";\r\n\r\nexport default function wrapAlbum({messages, attachmentDiv, middleware, uploading, lazyLoadQueue, isOut, chat, loadPromises, autoDownload, managers = rootScope.managers}: {\r\n  messages: Message.message[],\r\n  attachmentDiv: HTMLElement,\r\n  middleware?: () => boolean,\r\n  lazyLoadQueue?: LazyLoadQueue,\r\n  uploading?: boolean,\r\n  isOut: boolean,\r\n  chat: Chat,\r\n  loadPromises?: Promise<any>[],\r\n  autoDownload?: ChatAutoDownloadSettings,\r\n  managers?: AppManagers\r\n}) {\r\n  const items: {size: PhotoSize.photoSize, media: any, message: any}[] = [];\r\n\r\n  // !lowest msgID will be the FIRST in album\r\n  for(const message of messages) {\r\n    const media = getMediaFromMessage(message);\r\n\r\n    const size: any = media._ === 'photo' ? choosePhotoSize(media, 480, 480) : {w: media.w, h: media.h};\r\n    items.push({size, media, message});\r\n  }\r\n\r\n  /* // * pending\r\n  if(storage[0] < 0) {\r\n    items.reverse();\r\n  } */\r\n\r\n  prepareAlbum({\r\n    container: attachmentDiv,\r\n    items: items.map((i) => ({w: i.size.w, h: i.size.h})),\r\n    maxWidth: mediaSizes.active.album.width,\r\n    minWidth: 100,\r\n    spacing: 2,\r\n    forMedia: true\r\n  });\r\n\r\n  items.forEach((item, idx) => {\r\n    const {size, media, message} = item;\r\n\r\n    const div = attachmentDiv.children[idx] as HTMLElement;\r\n    div.dataset.mid = '' + message.mid;\r\n    div.dataset.peerId = '' + message.peerId;\r\n    const mediaDiv = div.firstElementChild as HTMLElement;\r\n    const isPhoto = media._ === 'photo';\r\n    let thumbPromise: Promise<any>;\r\n    if(isPhoto) {\r\n      thumbPromise = wrapPhoto({\r\n        photo: media,\r\n        message,\r\n        container: mediaDiv,\r\n        boxWidth: 0,\r\n        boxHeight: 0,\r\n        isOut,\r\n        lazyLoadQueue,\r\n        middleware,\r\n        size,\r\n        loadPromises,\r\n        autoDownloadSize: autoDownload.photo,\r\n        managers\r\n      });\r\n    } else {\r\n      thumbPromise = wrapVideo({\r\n        doc: message.media.document,\r\n        container: mediaDiv,\r\n        message,\r\n        boxWidth: 0,\r\n        boxHeight: 0,\r\n        withTail: false,\r\n        isOut,\r\n        lazyLoadQueue,\r\n        middleware,\r\n        loadPromises,\r\n        autoDownload,\r\n        managers\r\n      });\r\n    }\r\n\r\n    if(thumbPromise && loadPromises) {\r\n      loadPromises.push(thumbPromise);\r\n    }\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport MEDIA_MIME_TYPES_SUPPORTED from \"../../environment/mediaMimeTypesSupport\";\r\nimport { clearBadCharsAndTrim } from \"../../helpers/cleanSearchText\";\r\nimport { formatFullSentTime } from \"../../helpers/date\";\r\nimport { simulateClickEvent, attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport formatBytes from \"../../helpers/formatBytes\";\r\nimport { MediaSizeType } from \"../../helpers/mediaSizes\";\r\nimport noop from \"../../helpers/noop\";\r\nimport { Message, MessageMedia, WebPage } from \"../../layer\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getDownloadMediaDetails from \"../../lib/appManagers/utils/download/getDownloadMediaDetails\";\r\nimport choosePhotoSize from \"../../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport { joinElementsWith } from \"../../lib/langPack\";\r\nimport wrapPlainText from \"../../lib/richTextProcessor/wrapPlainText\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport type { ThumbCache } from \"../../lib/storages/thumbs\";\r\nimport { MediaSearchContext } from \"../appMediaPlaybackController\";\r\nimport AudioElement from \"../audio\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport { MiddleEllipsisElement } from \"../middleEllipsis\";\r\nimport ProgressivePreloader from \"../preloader\";\r\nimport wrapPhoto from './photo';\r\nimport wrapSenderToPeer from \"./senderToPeer\";\r\nimport wrapSentTime from \"./sentTime\";\r\n\r\nrootScope.addEventListener('document_downloading', (docId) => {\r\n  const elements = Array.from(document.querySelectorAll(`.document[data-doc-id=\"${docId}\"]`)) as HTMLElement[];\r\n  elements.forEach((element) => {\r\n    if(element.querySelector('.preloader-container.manual')) {\r\n      simulateClickEvent(element);\r\n    }\r\n  });\r\n});\r\n\r\nexport default async function wrapDocument({message, withTime, fontWeight, voiceAsMusic, showSender, searchContext, loadPromises, autoDownloadSize, lazyLoadQueue, sizeType, managers = rootScope.managers, cacheContext}: {\r\n  message: Message.message, \r\n  withTime?: boolean,\r\n  fontWeight?: number,\r\n  voiceAsMusic?: boolean,\r\n  showSender?: boolean,\r\n  searchContext?: MediaSearchContext,\r\n  loadPromises?: Promise<any>[],\r\n  autoDownloadSize?: number,\r\n  lazyLoadQueue?: LazyLoadQueue,\r\n  sizeType?: MediaSizeType,\r\n  managers?: AppManagers,\r\n  cacheContext?: ThumbCache\r\n}): Promise<HTMLElement> {\r\n  if(!fontWeight) fontWeight = 500;\r\n  if(!sizeType) sizeType = '' as any;\r\n  const noAutoDownload = autoDownloadSize === 0;\r\n\r\n  const doc = ((message.media as MessageMedia.messageMediaDocument).document || ((message.media as MessageMedia.messageMediaWebPage).webpage as WebPage.webPage).document) as MyDocument;\r\n  const uploadFileName = message?.uploadingFileName;\r\n  if(doc.type === 'audio' || doc.type === 'voice' || doc.type === 'round') {\r\n    const audioElement = new AudioElement();\r\n    audioElement.withTime = withTime;\r\n    audioElement.message = message;\r\n    audioElement.noAutoDownload = noAutoDownload;\r\n    audioElement.lazyLoadQueue = lazyLoadQueue;\r\n    audioElement.loadPromises = loadPromises;\r\n    \r\n    if(voiceAsMusic) audioElement.voiceAsMusic = voiceAsMusic;\r\n    if(searchContext) audioElement.searchContext = searchContext;\r\n    if(showSender) audioElement.showSender = showSender;\r\n\r\n    audioElement.dataset.fontWeight = '' + fontWeight;\r\n    audioElement.dataset.sizeType = sizeType;\r\n    await audioElement.render();\r\n    return audioElement;\r\n  }\r\n\r\n  let extSplitted = doc.file_name ? doc.file_name.split('.') : '';\r\n  let ext = '';\r\n  ext = extSplitted.length > 1 && Array.isArray(extSplitted) ? \r\n    clearBadCharsAndTrim(extSplitted.pop().split(' ', 1)[0].toLowerCase()) : \r\n    'file';\r\n\r\n  let docDiv = document.createElement('div');\r\n  docDiv.classList.add('document', `ext-${ext}`);\r\n  docDiv.dataset.docId = '' + doc.id;\r\n\r\n  // return docDiv;\r\n\r\n  const icoDiv = document.createElement('div');\r\n  icoDiv.classList.add('document-ico');\r\n\r\n  const hadContext = !!cacheContext;\r\n  const getCacheContext = () => {\r\n    return hadContext ? cacheContext : managers.thumbsStorage.getCacheContext(doc);\r\n  };\r\n\r\n  cacheContext = await getCacheContext();\r\n  if((doc.thumbs?.length || (message.pFlags.is_outgoing && cacheContext.url && doc.type === 'photo'))/*  && doc.mime_type !== 'image/gif' */) {\r\n    docDiv.classList.add('document-with-thumb');\r\n\r\n    let imgs: (HTMLImageElement | HTMLCanvasElement)[] = [];\r\n    // ! WARNING, use thumbs for check when thumb will be generated for media\r\n    if(message.pFlags.is_outgoing && ['photo', 'video'].includes(doc.type)) {\r\n      icoDiv.innerHTML = `<img src=\"${cacheContext.url}\">`;\r\n      imgs.push(icoDiv.firstElementChild as HTMLImageElement);\r\n    } else {\r\n      const perf = performance.now();\r\n      const wrapped = await wrapPhoto({\r\n        photo: doc, \r\n        message: null, \r\n        container: icoDiv, \r\n        boxWidth: 54, \r\n        boxHeight: 54,\r\n        loadPromises,\r\n        withoutPreloader: true,\r\n        lazyLoadQueue,\r\n        size: choosePhotoSize(doc, 54, 54, true),\r\n        managers\r\n      });\r\n      // console.log('was wrapping photo', performance.now() - perf);\r\n      icoDiv.style.width = icoDiv.style.height = '';\r\n      if(wrapped.images.thumb) imgs.push(wrapped.images.thumb);\r\n      if(wrapped.images.full) imgs.push(wrapped.images.full);\r\n    }\r\n\r\n    imgs.forEach((img) => img.classList.add('document-thumb'));\r\n  } else {\r\n    icoDiv.innerText = ext;\r\n  }\r\n\r\n  //let fileName = stringMiddleOverflow(doc.file_name || 'Unknown.file', 26);\r\n  let fileName = doc.file_name ? wrapPlainText(doc.file_name) : 'Unknown.file';\r\n  const descriptionEl = document.createElement('div');\r\n  descriptionEl.classList.add('document-description');\r\n  const descriptionParts: (HTMLElement | string | DocumentFragment)[] = [formatBytes(doc.size)];\r\n  \r\n  if(withTime) {\r\n    descriptionParts.push(formatFullSentTime(message.date));\r\n  }\r\n\r\n  if(showSender) {\r\n    descriptionParts.push(await wrapSenderToPeer(message));\r\n  }\r\n\r\n  docDiv.innerHTML = `\r\n  ${(cacheContext.downloaded && !uploadFileName) || !message.mid ? '' : `<div class=\"document-download\"></div>`}\r\n  <div class=\"document-name\"></div>\r\n  <div class=\"document-size\"></div>\r\n  `;\r\n\r\n  const nameDiv = docDiv.querySelector('.document-name') as HTMLElement;\r\n  const middleEllipsisEl = new MiddleEllipsisElement();\r\n  middleEllipsisEl.dataset.fontWeight = '' + fontWeight;\r\n  middleEllipsisEl.dataset.sizeType = sizeType;\r\n  middleEllipsisEl.textContent = fileName;\r\n  // setInnerHTML(middleEllipsisEl, fileName);\r\n\r\n  nameDiv.append(middleEllipsisEl);\r\n\r\n  if(showSender) {\r\n    nameDiv.append(wrapSentTime(message));\r\n  }\r\n\r\n  const sizeDiv = docDiv.querySelector('.document-size') as HTMLElement;\r\n  sizeDiv.append(...joinElementsWith(descriptionParts, '  '));\r\n\r\n  docDiv.prepend(icoDiv);\r\n\r\n  if(!uploadFileName && message.pFlags.is_outgoing && !message.mid) {\r\n    return docDiv;\r\n  }\r\n\r\n  let downloadDiv: HTMLElement, preloader: ProgressivePreloader = null;\r\n  const onLoad = () => {\r\n    if(downloadDiv) {\r\n      downloadDiv.classList.add('downloaded');\r\n      const _downloadDiv = downloadDiv;\r\n      setTimeout(() => {\r\n        _downloadDiv.remove();\r\n      }, 200);\r\n      downloadDiv = null;\r\n    }\r\n\r\n    if(preloader) {\r\n      preloader = null;\r\n    }\r\n  };\r\n\r\n  const load = async(e?: Event) => {\r\n    const save = !e || e.isTrusted;\r\n    const doc = await managers.appDocsManager.getDoc(docDiv.dataset.docId);\r\n    let download: Promise<any>;\r\n    const queueId = appImManager.chat.bubbles ? appImManager.chat.bubbles.lazyLoadQueue.queueId : undefined;\r\n    if(!save) {\r\n      download = appDownloadManager.downloadMediaVoid({media: doc, queueId});\r\n    } else if(doc.type === 'pdf') {\r\n      const canOpenAfter = /* managers.appDocsManager.downloading.has(doc.id) ||  */!preloader || preloader.detached;\r\n      download = appDownloadManager.downloadMediaURL({media: doc, queueId});\r\n      if(canOpenAfter) {\r\n        download.then(() => {\r\n          setTimeout(async() => { // wait for preloader animation end\r\n            const url = (await getCacheContext()).url;\r\n            window.open(url);\r\n          }, rootScope.settings.animationsEnabled ? 250 : 0);\r\n        });\r\n      }\r\n    } else if(MEDIA_MIME_TYPES_SUPPORTED.has(doc.mime_type) && doc.thumbs?.length) {\r\n      download = appDownloadManager.downloadMediaURL({media: doc, queueId});\r\n    } else {\r\n      download = appDownloadManager.downloadToDisc({media: doc, queueId});\r\n    }\r\n\r\n    if(downloadDiv) {\r\n      download.then(onLoad, noop);\r\n      preloader.attach(downloadDiv, true, download);\r\n    }\r\n  };\r\n\r\n  const {fileName: downloadFileName} = getDownloadMediaDetails({media: doc});\r\n  if(await managers.apiFileManager.isDownloading(downloadFileName)) {\r\n    downloadDiv = docDiv.querySelector('.document-download');\r\n    const promise = appDownloadManager.downloadMediaVoid({media: doc});\r\n\r\n    preloader = new ProgressivePreloader();\r\n    preloader.attach(downloadDiv, false, promise);\r\n    preloader.setDownloadFunction(load);\r\n  } else if(!cacheContext.downloaded || uploadFileName) {\r\n    downloadDiv = docDiv.querySelector('.document-download');\r\n    preloader = new ProgressivePreloader({\r\n      isUpload: !!uploadFileName\r\n    });\r\n\r\n    if(!uploadFileName) {\r\n      preloader.construct();\r\n      preloader.setManual();\r\n      preloader.attach(downloadDiv);\r\n      preloader.setDownloadFunction(load);\r\n\r\n      if(autoDownloadSize !== undefined && autoDownloadSize >= doc.size) {\r\n        simulateClickEvent(preloader.preloader);\r\n      }\r\n    } else {\r\n      const uploadPromise = appDownloadManager.getUpload(uploadFileName);\r\n      preloader.attachPromise(uploadPromise);\r\n      preloader.attach(downloadDiv);\r\n      uploadPromise.then(onLoad, noop);\r\n    }\r\n  }\r\n\r\n  attachClickEvent(docDiv, (e) => {\r\n    if(preloader) {\r\n      preloader.onClick(e);\r\n    } else {\r\n      load(e);\r\n    }\r\n  });\r\n\r\n  return docDiv;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport rootScope from \"../lib/rootScope\";\r\n\r\nconst savingLottiePreview: {[docId: DocId]: {width: number, height: number}} = {};\r\n\r\nexport function isSavingLottiePreview(doc: MyDocument, toneIndex: number) {\r\n  const key = doc.id + '-' + toneIndex;\r\n  return !!savingLottiePreview[key];\r\n}\r\n\r\nexport async function saveLottiePreview(doc: MyDocument, canvas: HTMLCanvasElement, toneIndex: number) {\r\n  const key = doc.id + '-' + toneIndex;\r\n  const {width, height} = canvas;\r\n  let saving = savingLottiePreview[key];\r\n  if(saving && saving.width >= width && saving.height >= height) {\r\n    return;\r\n  }\r\n\r\n  saving = savingLottiePreview[key] = {\r\n    width,\r\n    height\r\n  };\r\n\r\n  const thumb = await rootScope.managers.appDocsManager.getLottieCachedThumb(doc.id, toneIndex);\r\n  if(savingLottiePreview[key] !== saving) {\r\n    return;\r\n  }\r\n\r\n  if(thumb && thumb.w >= width && thumb.h >= height) {\r\n    return;\r\n  }\r\n\r\n  const promise = new Promise<Blob>((resolve) => {\r\n    canvas.toBlob((blob) => resolve(blob));\r\n  });\r\n  \r\n  const blob = await promise;\r\n  if(savingLottiePreview[key] !== saving) {\r\n    return;\r\n  }\r\n\r\n  //console.log('got lottie preview', doc, blob, URL.createObjectURL(blob));\r\n\r\n  rootScope.managers.appDocsManager.saveLottiePreview(doc.id, blob, width, height, toneIndex);\r\n\r\n  delete savingLottiePreview[key];\r\n\r\n  /* const reader = new FileReader();\r\n  reader.onloadend = (e) => {\r\n    const uint8 = new Uint8Array(e.target.result as ArrayBuffer);\r\n    const thumb: PhotoSize.photoStrippedSize = {\r\n      _: 'photoStrippedSize',\r\n      bytes: uint8,\r\n      type: 'i'\r\n    };\r\n\r\n    doc.stickerSavedThumbWidth = canvas.width;\r\n    doc.stickerSavedThumbHeight = canvas.width;\r\n\r\n    defineNotNumerableProperties(thumb, ['url']);\r\n    thumb.url = URL.createObjectURL(blob);\r\n    doc.thumbs.findAndSplice((t) => t._ === thumb._);\r\n    doc.thumbs.unshift(thumb);\r\n\r\n    if(!webpWorkerController.isWebpSupported()) {\r\n      doc.pFlags.stickerThumbConverted = true;\r\n    }\r\n\r\n    delete this.savingLottiePreview[doc.id];\r\n  };\r\n  reader.readAsArrayBuffer(blob); */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_VIBRATE_SUPPORTED from \"../../environment/vibrateSupport\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport isInDOM from \"../../helpers/dom/isInDOM\";\r\nimport throttleWithRaf from \"../../helpers/schedulers/throttleWithRaf\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\nimport wrapSticker from \"./sticker\";\r\n\r\nexport default function wrapStickerAnimation({\r\n  size,\r\n  doc,\r\n  middleware,\r\n  target,\r\n  side,\r\n  skipRatio,\r\n  play,\r\n  managers\r\n}: {\r\n  size: number,\r\n  doc: MyDocument,\r\n  middleware?: () => boolean,\r\n  target: HTMLElement,\r\n  side: 'left' | 'center' | 'right',\r\n  skipRatio?: number,\r\n  play: boolean,\r\n  managers?: AppManagers\r\n}) {\r\n  const animationDiv = document.createElement('div');\r\n  animationDiv.classList.add('emoji-animation');\r\n\r\n  // const size = 280;\r\n  animationDiv.style.width = size + 'px';\r\n  animationDiv.style.height = size + 'px';\r\n\r\n  const stickerPromise = wrapSticker({\r\n    div: animationDiv,\r\n    doc,\r\n    middleware,\r\n    withThumb: false,\r\n    needFadeIn: false,\r\n    loop: false,\r\n    width: size,\r\n    height: size,\r\n    play,\r\n    group: 'none',\r\n    skipRatio,\r\n    managers\r\n  }).then(({render}) => render).then((animation) => {\r\n    assumeType<RLottiePlayer>(animation);\r\n    animation.addEventListener('enterFrame', (frameNo) => {\r\n      if(frameNo === animation.maxFrame) {\r\n        animation.remove();\r\n        animationDiv.remove();\r\n        appImManager.chat.bubbles.scrollable.container.removeEventListener('scroll', onScroll);\r\n      }\r\n    });\r\n\r\n    if(IS_VIBRATE_SUPPORTED) {\r\n      animation.addEventListener('firstFrame', () => {\r\n        navigator.vibrate(100);\r\n      }, {once: true});\r\n    }\r\n\r\n    return animation;\r\n  });\r\n\r\n  const generateRandomSigned = (max: number) => {\r\n    const r = Math.random() * max * 2;\r\n    return r > max ? -r % max : r;\r\n  };\r\n\r\n  const randomOffsetX = generateRandomSigned(16);\r\n  const randomOffsetY = generateRandomSigned(4);\r\n  const stableOffsetX = size / 8 * (side === 'right' ? 1 : -1);\r\n  const setPosition = () => {\r\n    if(!isInDOM(target)) {\r\n      return;\r\n    }\r\n    \r\n    const rect = target.getBoundingClientRect();\r\n    /* const boxWidth = Math.max(rect.width, rect.height);\r\n    const boxHeight = Math.max(rect.width, rect.height);\r\n    const x = rect.left + ((boxWidth - size) / 2);\r\n    const y = rect.top + ((boxHeight - size) / 2); */\r\n\r\n    const rectX = side === 'right' ? rect.right : rect.left;\r\n\r\n    const addOffsetX = side === 'center' ? (rect.width - size) / 2 : (side === 'right' ? -size : 0) + stableOffsetX + randomOffsetX;\r\n    const x = rectX + addOffsetX;\r\n    // const y = rect.bottom - size + size / 4;\r\n    const y = rect.top + ((rect.height - size) / 2) + (side === 'center' ? 0 : randomOffsetY);\r\n    // animationDiv.style.transform = `translate(${x}px, ${y}px)`;\r\n    animationDiv.style.top = y + 'px';\r\n    animationDiv.style.left = x + 'px';\r\n  };\r\n\r\n  const onScroll = throttleWithRaf(setPosition);\r\n\r\n  appImManager.chat.bubbles.scrollable.container.addEventListener('scroll', onScroll);\r\n\r\n  setPosition();\r\n\r\n  appImManager.emojiAnimationContainer.append(animationDiv);\r\n\r\n  return {animationDiv, stickerPromise};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_WEBP_SUPPORTED from \"../../environment/webpSupport\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport getPathFromBytes from \"../../helpers/bytes/getPathFromBytes\";\r\nimport deferredPromise from \"../../helpers/cancellablePromise\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport createVideo from \"../../helpers/dom/createVideo\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport renderImageFromUrl from \"../../helpers/dom/renderImageFromUrl\";\r\nimport getImageFromStrippedThumb from \"../../helpers/getImageFromStrippedThumb\";\r\nimport getPreviewURLFromThumb from \"../../helpers/getPreviewURLFromThumb\";\r\nimport onMediaLoad from \"../../helpers/onMediaLoad\";\r\nimport { isSavingLottiePreview, saveLottiePreview } from \"../../helpers/saveLottiePreview\";\r\nimport throttle from \"../../helpers/schedulers/throttle\";\r\nimport sequentialDom from \"../../helpers/sequentialDom\";\r\nimport { PhotoSize } from \"../../layer\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getServerMessageId from \"../../lib/appManagers/utils/messageId/getServerMessageId\";\r\nimport choosePhotoSize from \"../../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport lottieLoader from \"../../lib/rlottie/lottieLoader\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport type { ThumbCache } from \"../../lib/storages/thumbs\";\r\nimport webpWorkerController from \"../../lib/webp/webpWorkerController\";\r\nimport { SendMessageEmojiInteractionData } from \"../../types\";\r\nimport { getEmojiToneIndex } from \"../../vendor/emoji\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport wrapStickerAnimation from \"./stickerAnimation\";\r\n\r\nexport default async function wrapSticker({doc, div, middleware, lazyLoadQueue, group, play, onlyThumb, emoji, width, height, withThumb, loop, loadPromises, needFadeIn, needUpscale, skipRatio, static: asStatic, managers = rootScope.managers}: {\r\n  doc: MyDocument, \r\n  div: HTMLElement, \r\n  middleware?: () => boolean, \r\n  lazyLoadQueue?: LazyLoadQueue, \r\n  group?: string, \r\n  play?: boolean, \r\n  onlyThumb?: boolean,\r\n  emoji?: string,\r\n  width?: number,\r\n  height?: number,\r\n  withThumb?: boolean,\r\n  loop?: boolean,\r\n  loadPromises?: Promise<any>[],\r\n  needFadeIn?: boolean,\r\n  needUpscale?: boolean,\r\n  skipRatio?: number,\r\n  static?: boolean,\r\n  managers?: AppManagers\r\n}) {\r\n  const stickerType = doc.sticker;\r\n  if(stickerType === 1) {\r\n    asStatic = true;\r\n  }\r\n\r\n  if(!width) {\r\n    width = !emoji ? 200 : undefined;\r\n  }\r\n\r\n  if(!height) {\r\n    height = !emoji ? 200 : undefined;\r\n  }\r\n\r\n  if(stickerType === 2) {\r\n    //LottieLoader.loadLottie();\r\n    lottieLoader.loadLottieWorkers();\r\n  }\r\n  \r\n  if(!stickerType) {\r\n    console.error('wrong doc for wrapSticker!', doc);\r\n    throw new Error('wrong doc for wrapSticker!');\r\n  }\r\n\r\n  div.dataset.docId = '' + doc.id;\r\n  div.classList.add('media-sticker-wrapper');\r\n\r\n  /* if(stickerType === 3) {\r\n    const videoRes = wrapVideo({\r\n      doc,\r\n      boxWidth: width,\r\n      boxHeight: height,\r\n      container: div,\r\n      group,\r\n      lazyLoadQueue,\r\n      middleware,\r\n      withoutPreloader: true,\r\n      loadPromises,\r\n      noPlayButton: true,\r\n      noInfo: true\r\n    });\r\n\r\n    if(videoRes.thumb) {\r\n      if(videoRes.thumb.images.thumb) {\r\n        videoRes.thumb.images.thumb.classList.add('media-sticker', 'thumbnail');\r\n      }\r\n\r\n      if(videoRes.thumb.images.full) {\r\n        videoRes.thumb.images.full.classList.add('media-sticker');\r\n      }\r\n    }\r\n\r\n    return videoRes.loadPromise;\r\n  } */\r\n  \r\n  //console.log('wrap sticker', doc, div, onlyThumb);\r\n\r\n  let cacheContext: ThumbCache;\r\n  let getCacheContext = async(type: string = cacheContext?.type) => {\r\n    return cacheContext = await managers.thumbsStorage.getCacheContext(doc, type);\r\n  };\r\n\r\n  if(asStatic && stickerType !== 1) {\r\n    const thumb = choosePhotoSize(doc, width, height, false) as PhotoSize.photoSize;\r\n    await getCacheContext(thumb.type);\r\n  } else {\r\n    await getCacheContext();\r\n  }\r\n\r\n  const toneIndex = emoji ? getEmojiToneIndex(emoji) : -1;\r\n  const downloaded = cacheContext.downloaded && !needFadeIn;\r\n\r\n  const isAnimated = !asStatic && (stickerType === 2 || stickerType === 3);\r\n  const isThumbNeededForType = isAnimated;\r\n  const lottieCachedThumb = stickerType === 2 || stickerType === 3 ? await managers.appDocsManager.getLottieCachedThumb(doc.id, toneIndex) : undefined;\r\n  \r\n  let loadThumbPromise = deferredPromise<void>();\r\n  let haveThumbCached = false;\r\n  if((\r\n      doc.thumbs?.length || \r\n      lottieCachedThumb\r\n    ) && \r\n    !div.firstElementChild && (\r\n      !downloaded || \r\n      isThumbNeededForType ||  \r\n      onlyThumb\r\n    ) && withThumb !== false/*  && doc.thumbs[0]._ !== 'photoSizeEmpty' */\r\n  ) {\r\n    let thumb = lottieCachedThumb || doc.thumbs[0];\r\n    \r\n    //console.log('wrap sticker', thumb, div);\r\n\r\n    let thumbImage: HTMLImageElement | HTMLCanvasElement;\r\n    const afterRender = () => {\r\n      if(!div.childElementCount) {\r\n        thumbImage.classList.add('media-sticker', 'thumbnail');\r\n        \r\n        sequentialDom.mutateElement(div, () => {\r\n          div.append(thumbImage);\r\n          loadThumbPromise.resolve();\r\n        });\r\n      }\r\n    };\r\n\r\n    if('url' in thumb) {\r\n      thumbImage = new Image();\r\n      renderImageFromUrl(thumbImage, thumb.url, afterRender);\r\n      haveThumbCached = true;\r\n    } else if('bytes' in thumb) {\r\n      if(thumb._ === 'photoPathSize') {\r\n        if(thumb.bytes.length) {\r\n          const d = getPathFromBytes(thumb.bytes);\r\n          const ns = 'http://www.w3.org/2000/svg';\r\n          const svg = document.createElementNS(ns, 'svg');\r\n          svg.classList.add('rlottie-vector', 'media-sticker', 'thumbnail');\r\n          svg.setAttributeNS(null, 'viewBox', `0 0 ${doc.w || 512} ${doc.h || 512}`);\r\n          \r\n          // const defs = document.createElementNS(ns, 'defs');\r\n          // const linearGradient = document.createElementNS(ns, 'linearGradient');\r\n          // linearGradient.setAttributeNS(null, 'id', 'g');\r\n          // linearGradient.setAttributeNS(null, 'x1', '-300%');\r\n          // linearGradient.setAttributeNS(null, 'x2', '-200%');\r\n          // linearGradient.setAttributeNS(null, 'y1', '0');\r\n          // linearGradient.setAttributeNS(null, 'y2', '0');\r\n          // const stops = [\r\n          //   ['-10%', '.1'],\r\n          //   ['30%', '.07'],\r\n          //   ['70%', '.07'],\r\n          //   ['110%', '.1']\r\n          // ].map(([offset, stopOpacity]) => {\r\n          //   const stop = document.createElementNS(ns, 'stop');\r\n          //   stop.setAttributeNS(null, 'offset', offset);\r\n          //   stop.setAttributeNS(null, 'stop-opacity', stopOpacity);\r\n          //   return stop;\r\n          // });\r\n          // const animates = [\r\n          //   ['-300%', '1200%'],\r\n          //   ['-200%', '1300%']\r\n          // ].map(([from, to], idx) => {\r\n          //   const animate = document.createElementNS(ns, 'animate');\r\n          //   animate.setAttributeNS(null, 'attributeName', 'x' + (idx + 1));\r\n          //   animate.setAttributeNS(null, 'from', from);\r\n          //   animate.setAttributeNS(null, 'to', to);\r\n          //   animate.setAttributeNS(null, 'dur', '3s');\r\n          //   animate.setAttributeNS(null, 'repeatCount', 'indefinite');\r\n          //   return animate;\r\n          // });\r\n          // linearGradient.append(...stops, ...animates);\r\n          // defs.append(linearGradient);\r\n          // svg.append(defs);\r\n\r\n          const path = document.createElementNS(ns, 'path');\r\n          path.setAttributeNS(null, 'd', d);\r\n          if(rootScope.settings.animationsEnabled) path.setAttributeNS(null, 'fill', 'url(#g)');\r\n          svg.append(path);\r\n          div.append(svg);\r\n        } else {\r\n          thumb = doc.thumbs.find((t) => (t as PhotoSize.photoStrippedSize).bytes?.length) || thumb;\r\n        }\r\n      } else if(toneIndex <= 0) {\r\n        thumbImage = new Image();\r\n\r\n        if((IS_WEBP_SUPPORTED || doc.pFlags.stickerThumbConverted || cacheContext.url)/*  && false */) {\r\n          renderImageFromUrl(thumbImage, getPreviewURLFromThumb(doc, thumb, true), afterRender);\r\n          haveThumbCached = true;\r\n        } else {\r\n          webpWorkerController.convert('main-' + doc.id, thumb.bytes).then((bytes) => {\r\n            managers.appDocsManager.saveWebPConvertedStrippedThumb(doc.id, bytes);\r\n            (thumb as PhotoSize.photoStrippedSize).bytes = bytes;\r\n            doc.pFlags.stickerThumbConverted = true;\r\n            \r\n            if(middleware && !middleware()) return;\r\n  \r\n            if(!div.childElementCount) {\r\n              renderImageFromUrl(thumbImage, getPreviewURLFromThumb(doc, thumb as PhotoSize.photoStrippedSize, true), afterRender);\r\n            }\r\n          }).catch(() => {});\r\n        }\r\n      }\r\n    } else if(((stickerType === 2 && toneIndex <= 0) || stickerType === 3) && (withThumb || onlyThumb)) {\r\n      const load = async() => {\r\n        if(div.childElementCount || (middleware && !middleware())) return;\r\n\r\n        const r = () => {\r\n          if(div.childElementCount || (middleware && !middleware())) return;\r\n          renderImageFromUrl(thumbImage, cacheContext.url, afterRender);\r\n        };\r\n  \r\n        await getCacheContext();\r\n        if(cacheContext.url) {\r\n          r();\r\n          return;\r\n        } else {\r\n          const res = getImageFromStrippedThumb(doc, thumb as PhotoSize.photoStrippedSize, true);\r\n          thumbImage = res.image;\r\n          res.loadPromise.then(r);\r\n          \r\n          // return managers.appDocsManager.getThumbURL(doc, thumb as PhotoSize.photoStrippedSize).promise.then(r);\r\n        }\r\n      };\r\n      \r\n      if(lazyLoadQueue && onlyThumb) {\r\n        lazyLoadQueue.push({div, load});\r\n        return;\r\n      } else {\r\n        load();\r\n\r\n        if((thumb as any).url) {\r\n          haveThumbCached = true;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  if(loadPromises && haveThumbCached) {\r\n    loadPromises.push(loadThumbPromise);\r\n  }\r\n\r\n  if(onlyThumb/*  || true */) { // for sticker panel\r\n    return;\r\n  }\r\n  \r\n  const load = async() => {\r\n    if(middleware && !middleware()) return;\r\n\r\n    if(stickerType === 2 && !asStatic) {\r\n      /* if(doc.id === '1860749763008266301') {\r\n        console.log('loaded sticker:', doc, div);\r\n      } */\r\n\r\n      //await new Promise((resolve) => setTimeout(resolve, 500));\r\n      //return;\r\n\r\n      //console.time('download sticker' + doc.id);\r\n\r\n      //appDocsManager.downloadDocNew(doc.id).promise.then((res) => res.json()).then(async(json) => {\r\n      //fetch(doc.url).then((res) => res.json()).then(async(json) => {\r\n      return await appDownloadManager.downloadMedia({media: doc, queueId: lazyLoadQueue?.queueId})\r\n      .then(async(blob) => {\r\n        //console.timeEnd('download sticker' + doc.id);\r\n        //console.log('loaded sticker:', doc, div/* , blob */);\r\n        if(middleware && !middleware()) {\r\n          throw new Error('wrapSticker 2 middleware');\r\n        }\r\n\r\n        let animation = await lottieLoader.loadAnimationWorker({\r\n          container: div,\r\n          loop: loop && !emoji,\r\n          autoplay: play,\r\n          animationData: blob,\r\n          width,\r\n          height,\r\n          name: 'doc' + doc.id,\r\n          needUpscale,\r\n          skipRatio,\r\n          toneIndex\r\n        }, group, middleware);\r\n\r\n        //const deferred = deferredPromise<void>();\r\n  \r\n        animation.addEventListener('firstFrame', () => {\r\n          const element = div.firstElementChild;\r\n          if(needFadeIn !== false) {\r\n            needFadeIn = (needFadeIn || !element || element.tagName === 'svg') && rootScope.settings.animationsEnabled;\r\n          }\r\n\r\n          const cb = () => {\r\n            if(element && element !== animation.canvas) {\r\n              element.remove();\r\n            }\r\n          };\r\n\r\n          if(!needFadeIn) {\r\n            if(element) {\r\n              sequentialDom.mutate(cb);\r\n            }\r\n          } else {\r\n            sequentialDom.mutate(() => {\r\n              animation.canvas.classList.add('fade-in');\r\n              if(element) {\r\n                element.classList.add('fade-out');\r\n              }\r\n  \r\n              animation.canvas.addEventListener('animationend', () => {\r\n                sequentialDom.mutate(() => {\r\n                  animation.canvas.classList.remove('fade-in');\r\n                  cb();\r\n                });\r\n              }, {once: true});\r\n            });\r\n          }\r\n\r\n          if(withThumb !== false) {\r\n            saveLottiePreview(doc, animation.canvas, toneIndex);\r\n          }\r\n\r\n          //deferred.resolve();\r\n        }, {once: true});\r\n  \r\n        if(emoji) {\r\n          const data: SendMessageEmojiInteractionData = {\r\n            a: [],\r\n            v: 1\r\n          };\r\n\r\n          let sendInteractionThrottled: () => void;\r\n\r\n          managers.appStickersManager.preloadAnimatedEmojiStickerAnimation(emoji);\r\n\r\n          attachClickEvent(div, async(e) => {\r\n            cancelEvent(e);\r\n            const animation = lottieLoader.getAnimation(div);\r\n  \r\n            if(animation.paused) {\r\n              const doc = await managers.appStickersManager.getAnimatedEmojiSoundDocument(emoji);\r\n              if(doc) {\r\n                const audio = document.createElement('audio');\r\n                audio.style.display = 'none';\r\n                div.parentElement.append(audio);\r\n\r\n                try {\r\n                  const url = await appDownloadManager.downloadMediaURL({media: doc});\r\n\r\n                  audio.src = url;\r\n                  audio.play();\r\n                  await onMediaLoad(audio, undefined, true);\r\n                  \r\n                  audio.addEventListener('ended', () => {\r\n                    audio.src = '';\r\n                    audio.remove();\r\n                  }, {once: true});\r\n                } catch(err) {\r\n                  \r\n                }\r\n              }\r\n\r\n              animation.autoplay = true;\r\n              animation.restart();\r\n            }\r\n\r\n            const peerId = appImManager.chat.peerId;\r\n            if(!peerId.isUser()) {\r\n              return;\r\n            }\r\n\r\n            const doc = await managers.appStickersManager.getAnimatedEmojiSticker(emoji, true);\r\n            if(!doc) {\r\n              return;\r\n            }\r\n            \r\n            const bubble = findUpClassName(div, 'bubble');\r\n            const isOut = bubble.classList.contains('is-out');\r\n\r\n            const {animationDiv} = wrapStickerAnimation({\r\n              doc,\r\n              middleware,\r\n              side: isOut ? 'right' : 'left',\r\n              size: 280,\r\n              target: div,\r\n              play: true\r\n            });\r\n\r\n            if(bubble) {\r\n              if(isOut) {\r\n                animationDiv.classList.add('is-out');\r\n              } else {\r\n                animationDiv.classList.add('is-in');\r\n              }\r\n            }\r\n\r\n            if(!sendInteractionThrottled) {\r\n              sendInteractionThrottled = throttle(() => {\r\n                const length = data.a.length;\r\n                if(!length) {\r\n                  return;\r\n                }\r\n      \r\n                const firstTime = data.a[0].t;\r\n      \r\n                data.a.forEach((a) => {\r\n                  a.t = (a.t - firstTime) / 1000;\r\n                });\r\n      \r\n                const bubble = findUpClassName(div, 'bubble');\r\n                managers.appMessagesManager.setTyping(appImManager.chat.peerId, {\r\n                  _: 'sendMessageEmojiInteraction',\r\n                  msg_id: getServerMessageId(+bubble.dataset.mid),\r\n                  emoticon: emoji,\r\n                  interaction: {\r\n                    _: 'dataJSON',\r\n                    data: JSON.stringify(data)\r\n                  }\r\n                }, true);\r\n      \r\n                data.a.length = 0;\r\n              }, 1000, false);\r\n            }\r\n\r\n            // using a trick here: simulated event from interlocutor's interaction won't fire ours\r\n            if(e.isTrusted) {\r\n              data.a.push({\r\n                i: 1,\r\n                t: Date.now()\r\n              });\r\n    \r\n              sendInteractionThrottled();\r\n            }\r\n          });\r\n        }\r\n\r\n        return animation;\r\n\r\n        //return deferred;\r\n        //await new Promise((resolve) => setTimeout(resolve, 5e3));\r\n      });\r\n\r\n      //console.timeEnd('render sticker' + doc.id);\r\n    } else if(asStatic || stickerType === 3) {\r\n      let media: HTMLElement;\r\n      if(asStatic) {\r\n        media = new Image();\r\n      } else {\r\n        media = createVideo();\r\n        (media as HTMLVideoElement).muted = true;\r\n\r\n        if(play) {\r\n          (media as HTMLVideoElement).autoplay = true;\r\n          (media as HTMLVideoElement).loop = true;\r\n        }\r\n      }\r\n\r\n      const thumbImage = div.firstElementChild !== media && div.firstElementChild;\r\n      if(needFadeIn !== false) {\r\n        needFadeIn = (needFadeIn || !downloaded || (asStatic ? thumbImage : (!thumbImage || thumbImage.tagName === 'svg'))) && rootScope.settings.animationsEnabled;\r\n      }\r\n\r\n      media.classList.add('media-sticker');\r\n\r\n      if(needFadeIn) {\r\n        media.classList.add('fade-in');\r\n      }\r\n\r\n      return new Promise<void>(async(resolve, reject) => {\r\n        const r = async() => {\r\n          if(middleware && !middleware()) return resolve();\r\n  \r\n          const onLoad = () => {\r\n            sequentialDom.mutateElement(div, () => {\r\n              div.append(media);\r\n              if(thumbImage) {\r\n                thumbImage.classList.add('fade-out');\r\n              }\r\n\r\n              if(stickerType === 3 && !isSavingLottiePreview(doc, toneIndex)) {\r\n                // const perf = performance.now();\r\n                assumeType<HTMLVideoElement>(media);\r\n                const canvas = document.createElement('canvas');\r\n                canvas.width = width * window.devicePixelRatio;\r\n                canvas.height = height * window.devicePixelRatio;\r\n                const ctx = canvas.getContext('2d');\r\n                ctx.drawImage(media, 0, 0, canvas.width, canvas.height);\r\n                saveLottiePreview(doc, canvas, toneIndex);\r\n                // console.log('perf', performance.now() - perf);\r\n              }\r\n\r\n              if(stickerType === 3 && group) {\r\n                animationIntersector.addAnimation(media as HTMLVideoElement, group);\r\n              }\r\n\r\n              resolve();\r\n\r\n              if(needFadeIn) {\r\n                media.addEventListener('animationend', () => {\r\n                  media.classList.remove('fade-in');\r\n                  if(thumbImage) {\r\n                    thumbImage.remove();\r\n                  }\r\n                }, {once: true});\r\n              }\r\n            });\r\n          };\r\n\r\n          await getCacheContext();\r\n          if(asStatic) {\r\n            renderImageFromUrl(media, cacheContext.url, onLoad);\r\n          } else {\r\n            (media as HTMLVideoElement).src = cacheContext.url;\r\n            onMediaLoad(media as HTMLVideoElement).then(onLoad);\r\n          }\r\n        };\r\n\r\n        await getCacheContext();\r\n        if(cacheContext.url) r();\r\n        else {\r\n          let promise: Promise<any>;\r\n          if(stickerType === 2 && asStatic) {\r\n            const thumb = choosePhotoSize(doc, width, height, false) as PhotoSize.photoSize;\r\n            // promise = managers.appDocsManager.getThumbURL(doc, thumb).promise\r\n            promise = appDownloadManager.downloadMediaURL({media: doc, thumb, queueId: lazyLoadQueue?.queueId});\r\n          } else {\r\n            promise = appDownloadManager.downloadMediaURL({media: doc, queueId: lazyLoadQueue?.queueId});\r\n          }\r\n            \r\n          promise.then(r, resolve);\r\n        }\r\n      });\r\n    }\r\n  };\r\n\r\n  const loadPromise: Promise<RLottiePlayer | void> = lazyLoadQueue && (!downloaded || isAnimated) ? \r\n    (lazyLoadQueue.push({div, load}), Promise.resolve()) : \r\n    load();\r\n\r\n  if(downloaded && (asStatic/*  || stickerType === 3 */)) {\r\n    loadThumbPromise = loadPromise as any;\r\n    if(loadPromises) {\r\n      loadPromises.push(loadThumbPromise);\r\n    }\r\n  }\r\n\r\n  return {render: loadPromise};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n/**\r\n  * https://core.telegram.org/api/files#vector-thumbnails\r\n  */\r\nexport default function getPathFromBytes(bytes: Uint8Array) {\r\n  const lookup = \"AACAAAAHAAALMAAAQASTAVAAAZaacaaaahaaalmaaaqastava.az0123456789-,\";\r\n\r\n  let path = 'M';\r\n  for(let i = 0, length = bytes.length; i < length; ++i) {\r\n    const num = bytes[i];\r\n\r\n    if(num >= (128 + 64)) {\r\n      path += lookup[num - 128 - 64];\r\n    } else {\r\n      if(num >= 128) {\r\n        path += ',';\r\n      } else if(num >= 64) {\r\n        path += '-'; \r\n      }\r\n      path += '' + (num & 63);\r\n    }\r\n  }\r\n  path += 'z';\r\n\r\n  return path;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { InputFile } from \"../layer\";\r\nimport AvatarEdit from \"./avatarEdit\";\r\nimport AvatarElement from \"./avatar\";\r\nimport InputField from \"./inputField\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport ButtonCorner from \"./buttonCorner\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\n\r\nexport default class EditPeer {\r\n  public nextBtn: HTMLButtonElement;\r\n\r\n  public uploadAvatar: () => Promise<InputFile>;\r\n  public avatarEdit: AvatarEdit;\r\n  public avatarElem: AvatarElement;\r\n\r\n  private inputFields: InputField[];\r\n  private listenerSetter: ListenerSetter;\r\n\r\n  private peerId: PeerId;\r\n\r\n  private _disabled = false;\r\n  private avatarSize = 120;\r\n\r\n  constructor(options: {\r\n    peerId?: EditPeer['peerId'],\r\n    inputFields: EditPeer['inputFields'],\r\n    listenerSetter: ListenerSetter,\r\n    doNotEditAvatar?: boolean,\r\n    withoutAvatar?: boolean,\r\n    nextBtn?: HTMLButtonElement,\r\n    avatarSize?: number\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    if(!this.nextBtn) {\r\n      this.nextBtn = ButtonCorner({icon: 'check'});\r\n    } else if(!this.nextBtn.classList.contains('btn-corner')) {\r\n      this.handleChange = () => {\r\n        this.nextBtn.toggleAttribute('disabled', !this.isChanged() || this.disabled);\r\n      };\r\n    }\r\n\r\n    if(!options.withoutAvatar) {\r\n      this.avatarElem = document.createElement('avatar-element') as AvatarElement;\r\n      this.avatarElem.classList.add('avatar-placeholder', 'avatar-' + this.avatarSize);\r\n      this.avatarElem.updateWithOptions({peerId: this.peerId});\r\n  \r\n      if(!options.doNotEditAvatar) {\r\n        this.avatarEdit = new AvatarEdit((_upload) => {\r\n          this.uploadAvatar = _upload;\r\n          this.handleChange();\r\n          this.avatarElem.remove();\r\n        });\r\n  \r\n        this.avatarEdit.container.append(this.avatarElem);\r\n      }\r\n    }\r\n\r\n    this.inputFields.forEach((inputField) => {\r\n      this.listenerSetter.add(inputField.input)('input', this.handleChange);\r\n    });\r\n\r\n    this.handleChange();\r\n  }\r\n\r\n  public get disabled() {\r\n    return this._disabled;\r\n  }\r\n\r\n  public set disabled(value) {\r\n    this._disabled = value;\r\n    this.inputFields.forEach((inputField) => inputField.input.toggleAttribute('disabled', value));\r\n    this.handleChange();\r\n  }\r\n\r\n  public lockWithPromise(promise: Promise<any>, unlockOnSuccess = false) {\r\n    this.disabled = true;\r\n    promise.then(() => {\r\n      if(unlockOnSuccess) {\r\n        this.disabled = false;\r\n      }\r\n    }, () => {\r\n      this.disabled = false;\r\n    });\r\n  }\r\n\r\n  public isChanged = () => {\r\n    if(this.uploadAvatar) {\r\n      return true;\r\n    }\r\n\r\n    let changedLength = 0, requiredLength = 0, requiredValidLength = 0;\r\n    this.inputFields.forEach((inputField) => {\r\n      if(inputField.isValid()) {\r\n        if(inputField.isChanged()) {\r\n          ++changedLength;\r\n        }\r\n\r\n        if(inputField.required) {\r\n          ++requiredValidLength;\r\n        }\r\n      }\r\n\r\n      if(inputField.required) {\r\n        ++requiredLength;\r\n      }\r\n    });\r\n\r\n    return requiredLength === requiredValidLength && changedLength > 0;\r\n  };\r\n\r\n  public handleChange = () => {\r\n    this.nextBtn.classList.toggle('is-visible', this.isChanged());\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function RadioForm(radios: {container: HTMLElement, input: HTMLInputElement}[], onChange: (value: string, event: Event) => void) {\r\n  const form = document.createElement('form');\r\n\r\n  radios.forEach((r) => {\r\n    const {container, input} = r;\r\n    form.append(container);\r\n    input.addEventListener('change', (e) => {\r\n      if(input.checked) {\r\n        onChange(input.value, e);\r\n      }\r\n    });\r\n  });\r\n\r\n  return form;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport CheckboxField from \"./checkboxField\";\r\nimport RadioField from \"./radioField\";\r\nimport ripple from \"./ripple\";\r\nimport { SliderSuperTab } from \"./slider\";\r\nimport RadioForm from \"./radioForm\";\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\n\r\nexport default class Row {\r\n  public container: HTMLElement;\r\n  public title: HTMLDivElement;\r\n  public titleRight: HTMLElement;\r\n  public subtitle: HTMLElement;\r\n  public media: HTMLElement;\r\n\r\n  public checkboxField: CheckboxField;\r\n  public radioField: RadioField;\r\n\r\n  public freezed = false;\r\n\r\n  constructor(options: Partial<{\r\n    icon: string,\r\n    subtitle: string | HTMLElement | DocumentFragment,\r\n    subtitleLangKey: LangPackKey,\r\n    subtitleLangArgs: any[],\r\n    radioField: Row['radioField'],\r\n    checkboxField: Row['checkboxField'],\r\n    noCheckboxSubtitle: boolean,\r\n    title: string | HTMLElement | DocumentFragment,\r\n    titleLangKey: LangPackKey,\r\n    titleRight: string | HTMLElement,\r\n    titleRightSecondary: string | HTMLElement,\r\n    clickable: boolean | ((e: Event) => void),\r\n    navigationTab: SliderSuperTab,\r\n    havePadding: boolean,\r\n    noRipple: boolean,\r\n    noWrap: boolean,\r\n    listenerSetter: ListenerSetter\r\n  }> = {}) {\r\n    this.container = document.createElement(options.radioField || options.checkboxField ? 'label' : 'div');\r\n    this.container.classList.add('row');\r\n\r\n    this.subtitle = document.createElement('div');\r\n    this.subtitle.classList.add('row-subtitle');\r\n    this.subtitle.setAttribute('dir', 'auto');\r\n    if(options.subtitle) {\r\n      if(typeof(options.subtitle) === 'string') {\r\n        setInnerHTML(this.subtitle, options.subtitle);\r\n      } else {\r\n        this.subtitle.append(options.subtitle);\r\n      }\r\n    } else if(options.subtitleLangKey) {\r\n      this.subtitle.append(i18n(options.subtitleLangKey, options.subtitleLangArgs));\r\n    }\r\n    this.container.append(this.subtitle);\r\n\r\n    let havePadding = !!options.havePadding;\r\n    if(options.radioField || options.checkboxField) {\r\n      if(options.radioField) {\r\n        this.radioField = options.radioField;\r\n        this.container.append(this.radioField.label);\r\n        havePadding = true;\r\n      }\r\n\r\n      if(options.checkboxField) {\r\n        this.checkboxField = options.checkboxField;\r\n        \r\n        const isToggle = options.checkboxField.label.classList.contains('checkbox-field-toggle');\r\n        if(isToggle) {\r\n          this.container.classList.add('row-with-toggle');\r\n          options.titleRight = this.checkboxField.label;\r\n        } else {\r\n          havePadding = true;\r\n          this.container.append(this.checkboxField.label);\r\n        }\r\n\r\n        if(!options.noCheckboxSubtitle && !isToggle) {\r\n          const onChange = () => {\r\n            replaceContent(this.subtitle, i18n(this.checkboxField.input.checked ? 'Checkbox.Enabled' : 'Checkbox.Disabled'));\r\n          };\r\n\r\n          if(options.listenerSetter) options.listenerSetter.add(this.checkboxField.input)('change', onChange);\r\n          else this.checkboxField.input.addEventListener('change', onChange);\r\n        }\r\n      }\r\n\r\n      const i = options.radioField || options.checkboxField;\r\n      i.label.classList.add('disable-hover');\r\n    } \r\n    \r\n    if(options.title || options.titleLangKey) {\r\n      let c: HTMLElement;\r\n      const titleRight = options.titleRight || options.titleRightSecondary;\r\n      if(titleRight) {\r\n        c = document.createElement('div');\r\n        c.classList.add('row-title-row');\r\n        this.container.append(c);\r\n      } else {\r\n        c = this.container;\r\n      }\r\n\r\n      this.title = document.createElement('div');\r\n      this.title.classList.add('row-title');\r\n      this.title.setAttribute('dir', 'auto');\r\n      if(options.noWrap) this.title.classList.add('no-wrap');\r\n      if(options.title) {\r\n        if(typeof(options.title) === 'string') {\r\n          this.title.innerHTML = options.title;\r\n        } else {\r\n          this.title.append(options.title);\r\n        }\r\n      } else {\r\n        this.title.append(i18n(options.titleLangKey));\r\n      }\r\n      c.append(this.title);\r\n\r\n      if(titleRight) {\r\n        const titleRightEl = this.titleRight = document.createElement('div');\r\n        titleRightEl.classList.add('row-title', 'row-title-right');\r\n\r\n        if(options.titleRightSecondary) {\r\n          titleRightEl.classList.add('row-title-right-secondary');\r\n        }\r\n\r\n        if(typeof(titleRight) === 'string') {\r\n          titleRightEl.innerHTML = titleRight;\r\n        } else {\r\n          titleRightEl.append(titleRight);\r\n        }\r\n\r\n        c.append(titleRightEl);\r\n      }\r\n    }\r\n\r\n    if(options.icon) {\r\n      havePadding = true;\r\n      this.title.classList.add('tgico', 'tgico-' + options.icon);\r\n      this.container.classList.add('row-with-icon');\r\n    }\r\n\r\n    if(havePadding) {\r\n      this.container.classList.add('row-with-padding');\r\n    }\r\n\r\n    if(options.navigationTab) {\r\n      options.clickable = () => options.navigationTab.open();\r\n    }\r\n\r\n    if(options.clickable || options.radioField || options.checkboxField) {\r\n      if(typeof(options.clickable) === 'function') {\r\n        attachClickEvent(this.container, (e) => {\r\n          if(this.freezed) return;\r\n          (options.clickable as any)(e);\r\n        }, {listenerSetter: options.listenerSetter});\r\n      }\r\n\r\n      this.container.classList.add('row-clickable', 'hover-effect');\r\n\r\n      if(!options.noRipple) {\r\n        ripple(this.container, undefined, undefined, true);\r\n      }\r\n\r\n      /* if(options.radioField || options.checkboxField) {\r\n        this.container.prepend(this.container.lastElementChild);\r\n      } */\r\n    }\r\n  }\r\n\r\n  public createMedia(size?: 'small') {\r\n    this.container.classList.add('row-with-padding');\r\n    \r\n    const media = this.media = document.createElement('div');\r\n    media.classList.add('row-media');\r\n\r\n    if(size) {\r\n      media.classList.add('row-media-' + size);\r\n    }\r\n\r\n    this.container.append(media);\r\n\r\n    return media;\r\n  }\r\n}\r\n\r\nexport const RadioFormFromRows = (rows: Row[], onChange: (value: string) => void) => {\r\n  return RadioForm(rows.map((r) => ({container: r.container, input: r.radioField.input})), onChange);\r\n};\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// https://stackoverflow.com/a/30810322\r\nfunction fallbackCopyTextToClipboard(text: string) {\r\n  var textArea = document.createElement(\"textarea\");\r\n  textArea.value = text;\r\n  \r\n  // Avoid scrolling to bottom\r\n  textArea.style.top = \"0\";\r\n  textArea.style.left = \"0\";\r\n  textArea.style.position = \"fixed\";\r\n\r\n  document.body.appendChild(textArea);\r\n  textArea.focus();\r\n  textArea.select();\r\n\r\n  try {\r\n    document.execCommand('copy');\r\n    //const successful = document.execCommand('copy');\r\n    //const msg = successful ? 'successful' : 'unsuccessful';\r\n    //console.log('Fallback: Copying text command was ' + msg);\r\n  } catch(err) {\r\n    //console.error('Fallback: Oops, unable to copy', err);\r\n  }\r\n\r\n  document.body.removeChild(textArea);\r\n}\r\n\r\nexport function copyTextToClipboard(text: string) {\r\n  if(!navigator.clipboard) {\r\n    fallbackCopyTextToClipboard(text);\r\n    return;\r\n  }\r\n  \r\n  navigator.clipboard.writeText(text);/* .then(function() {\r\n    console.log('Async: Copying to clipboard was successful!');\r\n  }, function(err) {\r\n    console.error('Async: Could not copy text: ', err);\r\n  }); */\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getDeepProperty from \"../helpers/object/getDeepProperty\";\r\nimport { LangPackKey, _i18n } from \"../lib/langPack\";\r\nimport apiManagerProxy from \"../lib/mtproto/mtprotoworker\";\r\nimport rootScope from \"../lib/rootScope\";\r\n\r\nexport default class RadioField {\r\n  public input: HTMLInputElement;\r\n  public label: HTMLLabelElement;\r\n  public main: HTMLElement;\r\n\r\n  constructor(options: {\r\n    text?: string, \r\n    langKey?: LangPackKey,\r\n    name: string, \r\n    value?: string, \r\n    stateKey?: string,\r\n    alignRight?: boolean\r\n  }) {\r\n    const label = this.label = document.createElement('label');\r\n    label.classList.add('radio-field');\r\n\r\n    if(options.alignRight) {\r\n      label.classList.add('radio-field-right');\r\n    }\r\n  \r\n    const input = this.input = document.createElement('input');\r\n    input.type = 'radio';\r\n    /* input.id =  */input.name = 'input-radio-' + options.name;\r\n  \r\n    if(options.value) {\r\n      input.value = options.value;\r\n  \r\n      if(options.stateKey) {\r\n        apiManagerProxy.getState().then((state) => {\r\n          input.checked = getDeepProperty(state, options.stateKey) === options.value;\r\n        });\r\n    \r\n        input.addEventListener('change', () => {\r\n          rootScope.managers.appStateManager.setByKey(options.stateKey, options.value);\r\n        });\r\n      }\r\n    }\r\n  \r\n    const main = this.main = document.createElement('div');\r\n    main.classList.add('radio-field-main');\r\n  \r\n    if(options.text) {\r\n      main.innerHTML = options.text;\r\n      /* const caption = document.createElement('div');\r\n      caption.classList.add('radio-field-main-caption');\r\n      caption.innerHTML = text;\r\n  \r\n      if(subtitle) {\r\n        label.classList.add('radio-field-with-subtitle');\r\n        caption.insertAdjacentHTML('beforeend', `<div class=\"radio-field-main-subtitle\">${subtitle}</div>`);\r\n      }\r\n  \r\n      main.append(caption); */\r\n    } else if(options.langKey) {\r\n      _i18n(main, options.langKey);\r\n    }\r\n  \r\n    label.append(input, main);\r\n  }\r\n\r\n  get checked() {\r\n    return this.input.checked;\r\n  }\r\n\r\n  set checked(checked: boolean) {\r\n    this.setValueSilently(checked);\r\n\r\n    const event = new Event('change', {bubbles: true, cancelable: true});\r\n    this.input.dispatchEvent(event);\r\n  }\r\n\r\n  public setValueSilently(checked: boolean) {\r\n    this.input.checked = checked;\r\n  }\r\n};\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport { FormatterArguments, i18n, LangPackKey } from \"../lib/langPack\";\r\n\r\nconst toastEl = document.createElement('div');\r\ntoastEl.classList.add('toast');\r\nexport function toast(content: string | Node) {\r\n  replaceContent(toastEl, content);\r\n  document.body.append(toastEl);\r\n\r\n  if(toastEl.dataset.timeout) clearTimeout(+toastEl.dataset.timeout);\r\n  toastEl.dataset.timeout = '' + setTimeout(() => {\r\n    toastEl.remove();\r\n    delete toastEl.dataset.timeout;\r\n  }, 3000);\r\n}\r\n\r\nexport function toastNew(options: Partial<{\r\n  langPackKey: LangPackKey,\r\n  langPackArguments: FormatterArguments\r\n}>) {\r\n  toast(i18n(options.langPackKey, options.langPackArguments));\r\n}\r\n","export default function isUsernameValid(username: string) {\r\n  return ((username.length >= 5 && username.length <= 32) || !username.length) && /^[a-zA-Z0-9_]*$/.test(username);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport debounce from \"../helpers/schedulers/debounce\";\r\nimport { LangPackKey } from \"../lib/langPack\";\r\nimport InputField, { InputFieldOptions, InputState } from \"./inputField\";\r\nimport isUsernameValid from \"../lib/richTextProcessor/isUsernameValid\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\n\r\nexport class UsernameInputField extends InputField {\r\n  private checkUsernamePromise: Promise<any>;\r\n  private checkUsernameDebounced: (username: string) => void;\r\n  public options: InputFieldOptions & {\r\n    peerId?: PeerId,\r\n    listenerSetter: ListenerSetter,\r\n    onChange?: () => void,\r\n    invalidText: LangPackKey,\r\n    takenText: LangPackKey,\r\n    availableText: LangPackKey,\r\n    head?: string\r\n  };\r\n\r\n  constructor(\r\n    options: UsernameInputField['options'], \r\n    private managers: AppManagers\r\n  ) {\r\n    super(options);\r\n\r\n    this.checkUsernameDebounced = debounce(this.checkUsername.bind(this), 150, false, true);\r\n\r\n    options.listenerSetter.add(this.input)('input', () => {\r\n      const value = this.getValue();\r\n\r\n      //console.log('userNameInput:', value);\r\n      if(value === this.originalValue || !value.length) {\r\n        this.setState(InputState.Neutral);\r\n        this.options.onChange && this.options.onChange();\r\n        return;\r\n      } else if(!isUsernameValid(value)) { // does not check the last underscore\r\n        this.setError(this.options.invalidText);\r\n      } else {\r\n        this.setState(InputState.Neutral);\r\n      }\r\n\r\n      if(this.input.classList.contains('error')) {\r\n        this.options.onChange && this.options.onChange();\r\n        return;\r\n      }\r\n\r\n      this.checkUsernameDebounced(value);\r\n    });\r\n  }\r\n\r\n  public getValue() {\r\n    let value = this.value;\r\n    if(this.options.head) {\r\n      value = value.slice(this.options.head.length);\r\n      this.setValueSilently(this.options.head + value);\r\n    }\r\n\r\n    return value;\r\n  }\r\n\r\n  private checkUsername(username: string) {\r\n    if(this.checkUsernamePromise) return;\r\n\r\n    if(this.options.peerId) {\r\n      this.checkUsernamePromise = this.managers.appChatsManager.checkUsername(this.options.peerId.toChatId(), username);\r\n    } else {\r\n      this.checkUsernamePromise = this.managers.appUsersManager.checkUsername(username);\r\n    }\r\n\r\n    this.checkUsernamePromise.then((available) => {\r\n      if(this.getValue() !== username) return;\r\n\r\n      if(available) {\r\n        this.setState(InputState.Valid, this.options.availableText);\r\n      } else {\r\n        this.setError(this.options.takenText);\r\n      }\r\n    }, (err) => {\r\n      if(this.getValue() !== username) return;\r\n\r\n      switch(err.type) {\r\n        case 'USERNAME_INVALID': {\r\n          this.setError(this.options.invalidText);\r\n          break;\r\n        }\r\n      }\r\n    }).then(() => {\r\n      this.checkUsernamePromise = undefined;\r\n      this.options.onChange && this.options.onChange();\r\n\r\n      const value = this.getValue();\r\n      if(value !== username && this.isValidToChange() && isUsernameValid(value)) {\r\n        this.checkUsername(value);\r\n      }\r\n    });\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport AvatarElement from \"../avatar\";\r\nimport PopupElement, { addCancelButton, PopupButton, PopupOptions } from \".\";\r\nimport { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport CheckboxField, { CheckboxFieldOptions } from \"../checkboxField\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\n\r\nexport type PopupPeerButton = Omit<PopupButton, 'callback'> & Partial<{callback: PopupPeerButtonCallback}>;\r\nexport type PopupPeerButtonCallbackCheckboxes = Set<LangPackKey>;\r\nexport type PopupPeerButtonCallback = (checkboxes?: PopupPeerButtonCallbackCheckboxes) => void;\r\nexport type PopupPeerCheckboxOptions = CheckboxFieldOptions & {checkboxField?: CheckboxField};\r\n\r\nexport type PopupPeerOptions = Omit<PopupOptions, 'buttons' | 'title'> & Partial<{\r\n  peerId: PeerId,\r\n  title: string | HTMLElement,\r\n  titleLangKey: LangPackKey,\r\n  titleLangArgs: any[],\r\n  noTitle: boolean,\r\n  description: string | DocumentFragment,\r\n  descriptionLangKey: LangPackKey,\r\n  descriptionLangArgs: any[],\r\n  buttons: Array<PopupPeerButton>,\r\n  checkboxes: Array<PopupPeerCheckboxOptions>\r\n}>;\r\nexport default class PopupPeer extends PopupElement {\r\n  protected description: HTMLParagraphElement;\r\n\r\n  constructor(private className: string, options: PopupPeerOptions = {}) {\r\n    super('popup-peer' + (className ? ' ' + className : ''), {\r\n      overlayClosable: true, \r\n      ...options,\r\n      title: true,\r\n      buttons: options.buttons && addCancelButton(options.buttons),\r\n    });\r\n\r\n    if(options.peerId) {\r\n      const avatarEl = new AvatarElement();\r\n      avatarEl.classList.add('avatar-32');\r\n      avatarEl.updateWithOptions({\r\n        isDialog: true,\r\n        peerId: options.peerId\r\n      });\r\n      this.header.prepend(avatarEl);\r\n    }\r\n\r\n    if(!options.noTitle) {\r\n      if(options.titleLangKey || !options.title) this.title.append(i18n(options.titleLangKey || 'AppName', options.titleLangArgs));\r\n      else if(options.title instanceof HTMLElement) {\r\n        this.title.append(options.title);\r\n      } else this.title.innerText = options.title || '';\r\n    }\r\n\r\n    const fragment = document.createDocumentFragment();\r\n\r\n    if(options.descriptionLangKey || options.description) {\r\n      const p = this.description = document.createElement('p');\r\n      p.classList.add('popup-description');\r\n      if(options.descriptionLangKey) p.append(i18n(options.descriptionLangKey, options.descriptionLangArgs));\r\n      else if(options.description) setInnerHTML(p, options.description);\r\n  \r\n      fragment.append(p);\r\n    }\r\n\r\n    if(options.checkboxes) {\r\n      this.container.classList.add('have-checkbox');\r\n      \r\n      options.checkboxes.forEach((o) => {\r\n        o.withRipple = true;\r\n        const checkboxField = new CheckboxField(o);\r\n        o.checkboxField = checkboxField;\r\n        fragment.append(checkboxField.label);\r\n      });\r\n\r\n      options.buttons.forEach((button) => {\r\n        if(button.callback) {\r\n          const original = button.callback;\r\n          button.callback = () => {\r\n            const c: Set<LangPackKey> = new Set();\r\n            options.checkboxes.forEach((o) => {\r\n              if(o.checkboxField.checked) {\r\n                c.add(o.text);\r\n              }\r\n            });\r\n            original(c);\r\n          };\r\n        }\r\n      });\r\n    }\r\n\r\n    this.container.insertBefore(fragment, this.header.nextElementSibling);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { copyTextToClipboard } from \"../../../helpers/clipboard\";\r\nimport { randomLong } from \"../../../helpers/random\";\r\nimport { Chat, ChatFull, ExportedChatInvite } from \"../../../layer\";\r\nimport Button from \"../../button\";\r\nimport { setButtonLoader } from \"../../putPreloader\";\r\nimport RadioField from \"../../radioField\";\r\nimport Row, { RadioFormFromRows } from \"../../row\";\r\nimport { SettingSection } from \"../../sidebarLeft\";\r\nimport { toast } from \"../../toast\";\r\nimport { UsernameInputField } from \"../../usernameInputField\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport I18n from \"../../../lib/langPack\";\r\nimport PopupPeer from \"../../popups/peer\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\n\r\nexport default class AppChatTypeTab extends SliderSuperTabEventable {\r\n  public chatId: ChatId;\r\n  public chatFull: ChatFull;\r\n\r\n  protected async init() {\r\n    this.container.classList.add('edit-peer-container', 'group-type-container');\r\n\r\n    const isBroadcast = await this.managers.appChatsManager.isBroadcast(this.chatId);\r\n\r\n    this.setTitle(isBroadcast ? 'ChannelType' : 'GroupType');\r\n\r\n    const section = new SettingSection({\r\n      name: isBroadcast ? 'ChannelType' : 'GroupType'\r\n    });\r\n\r\n    const random = randomLong();\r\n    const privateRow = new Row({\r\n      radioField: new RadioField({\r\n        langKey: isBroadcast ? 'ChannelPrivate' : 'MegaPrivate', \r\n        name: random, \r\n        value: 'private'\r\n      }),\r\n      subtitleLangKey: isBroadcast ? 'ChannelPrivateInfo' : 'MegaPrivateInfo'\r\n    });\r\n    const publicRow = new Row({\r\n      radioField: new RadioField({\r\n        langKey: isBroadcast ? 'ChannelPublic' : 'MegaPublic', \r\n        name: random, \r\n        value: 'public'\r\n      }),\r\n      subtitleLangKey: isBroadcast ? 'ChannelPublicInfo' : 'MegaPublicInfo'\r\n    });\r\n    const form = RadioFormFromRows([privateRow, publicRow], (value) => {\r\n      const a = [privateSection, publicSection];\r\n      if(value === 'public') a.reverse();\r\n\r\n      a[0].container.classList.remove('hide');\r\n      a[1].container.classList.add('hide');\r\n\r\n      onChange();\r\n    });\r\n\r\n    const chat: Chat = await this.managers.appChatsManager.getChat(this.chatId);\r\n\r\n    section.content.append(form);\r\n\r\n    const privateSection = new SettingSection({});\r\n\r\n    //let revoked = false;\r\n    const linkRow = new Row({\r\n      title: (this.chatFull.exported_invite as ExportedChatInvite.chatInviteExported).link,\r\n      subtitleLangKey: isBroadcast ? 'ChannelPrivateLinkHelp' : 'MegaPrivateLinkHelp',\r\n      clickable: () => {\r\n        copyTextToClipboard((this.chatFull.exported_invite as ExportedChatInvite.chatInviteExported).link);\r\n        toast(I18n.format('LinkCopied', true));\r\n      },\r\n      listenerSetter: this.listenerSetter\r\n    });\r\n\r\n    const btnRevoke = Button('btn-primary btn-transparent danger', {icon: 'delete', text: 'RevokeLink'});\r\n\r\n    attachClickEvent(btnRevoke, () => {\r\n      new PopupPeer('revoke-link', {\r\n        buttons: [{\r\n          langKey: 'RevokeButton',\r\n          callback: () => {\r\n            const toggle = toggleDisability([btnRevoke], true);\r\n            \r\n            this.managers.appProfileManager.getChatInviteLink(this.chatId, true).then((link) => {\r\n              toggle();\r\n              linkRow.title.innerHTML = link;\r\n              //revoked = true;\r\n              //onChange();\r\n            });\r\n          }\r\n        }],\r\n        titleLangKey: 'RevokeLink',\r\n        descriptionLangKey: 'RevokeAlert'\r\n      }).show();\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    privateSection.content.append(linkRow.container, btnRevoke);\r\n\r\n    const publicSection = new SettingSection({\r\n      caption: isBroadcast ? 'Channel.UsernameAboutChannel' : 'Channel.UsernameAboutGroup',\r\n      noDelimiter: true\r\n    });\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const placeholder = 't.me/';\r\n\r\n    const onChange = () => {\r\n      const changed = (privateRow.radioField.checked && (originalValue !== placeholder/*  || revoked */)) \r\n        || (linkInputField.isValidToChange() && linkInputField.input.classList.contains('valid'));\r\n      applyBtn.classList.toggle('is-visible', changed);\r\n    };\r\n\r\n    const linkInputField = new UsernameInputField({\r\n      label: 'SetUrlPlaceholder',\r\n      name: 'group-public-link',\r\n      plainText: true,\r\n      listenerSetter: this.listenerSetter,\r\n      availableText: 'Link.Available',\r\n      invalidText: 'Link.Invalid',\r\n      takenText: 'Link.Taken',\r\n      onChange: onChange,\r\n      peerId: this.chatId.toPeerId(true),\r\n      head: placeholder\r\n    }, this.managers);\r\n\r\n    const originalValue = placeholder + ((chat as Chat.channel).username || '');\r\n\r\n    inputWrapper.append(linkInputField.container)\r\n    publicSection.content.append(inputWrapper);\r\n\r\n    const applyBtn = ButtonCorner({icon: 'check', className: 'is-visible'});\r\n    this.content.append(applyBtn);\r\n\r\n    attachClickEvent(applyBtn, () => {\r\n      /* const unsetLoader =  */setButtonLoader(applyBtn);\r\n      const username = publicRow.radioField.checked ? linkInputField.getValue() : '';\r\n      this.managers.appChatsManager.migrateChat(this.chatId).then((channelId) => {\r\n        return this.managers.appChatsManager.updateUsername(channelId, username);\r\n      }).then(() => {\r\n        //unsetLoader();\r\n        this.close();\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    (originalValue !== placeholder ? publicRow : privateRow).radioField.checked = true;\r\n    linkInputField.setOriginalValue(originalValue);\r\n\r\n    this.scrollable.append(section.container, privateSection.container, publicSection.container);\r\n\r\n    {\r\n      const section = new SettingSection({\r\n        name: 'SavingContentTitle',\r\n        caption: isBroadcast ? 'RestrictSavingContentInfoChannel' : 'RestrictSavingContentInfoGroup'\r\n      });\r\n\r\n      const checkboxField = new CheckboxField({\r\n        text: 'RestrictSavingContent',\r\n        withRipple: true\r\n      });\r\n\r\n      this.listenerSetter.add(checkboxField.input)('change', () => {\r\n        const toggle = checkboxField.toggleDisability(true);\r\n        this.managers.appChatsManager.toggleNoForwards(this.chatId, checkboxField.checked).then(() => {\r\n          toggle();\r\n        });\r\n      });\r\n\r\n      const onChatUpdate = () => {\r\n        checkboxField.setValueSilently(!!(chat as Chat.channel).pFlags.noforwards);\r\n      };\r\n\r\n      this.listenerSetter.add(rootScope)('chat_update', (chatId) => {\r\n        if(this.chatId === chatId) {\r\n          onChatUpdate();\r\n        }\r\n      });\r\n\r\n      onChatUpdate();\r\n\r\n      section.content.append(checkboxField.label);\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Scrollable from \"../components/scrollable\";\r\nimport safeAssign from \"./object/safeAssign\";\r\n\r\nexport default class ScrollableLoader {\r\n  public loading = false;\r\n  private scrollable: Scrollable;\r\n  private getPromise: () => Promise<boolean>;\r\n  private promise: Promise<any>;\r\n  private loaded = false;\r\n\r\n  constructor(options: {\r\n    scrollable: ScrollableLoader['scrollable'],\r\n    getPromise: ScrollableLoader['getPromise']\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    options.scrollable.onScrolledBottom = () => {\r\n      this.load();\r\n    };\r\n  }\r\n  \r\n  public load() {\r\n    if(this.loaded) {\r\n      return Promise.resolve();\r\n    }\r\n    \r\n    if(this.loading) {\r\n      return this.promise;\r\n    }\r\n\r\n    this.loading = true;\r\n    this.promise = this.getPromise().then((done) => {\r\n      this.loading = false;\r\n      this.promise = undefined;\r\n\r\n      if(done) {\r\n        this.loaded = true;\r\n        this.scrollable.onScrolledBottom = null;\r\n      } else {\r\n        this.scrollable.checkForTriggers();\r\n      }\r\n    }, () => {\r\n      this.promise = undefined;\r\n      this.loading = false;\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { IS_WORKER } from \"./context\";\r\n\r\nexport class WindowSize {\r\n  public width: number;\r\n  public height: number;\r\n\r\n  constructor() {\r\n    if(IS_WORKER) {\r\n      return;\r\n    }\r\n    \r\n    // @ts-ignore\r\n    const w: any = 'visualViewport' in window ? window.visualViewport : window;\r\n    const set = () => {\r\n      this.width = w.width || w.innerWidth;\r\n      this.height = w.height || w.innerHeight;\r\n    };\r\n    w.addEventListener('resize', set);\r\n    set();\r\n  }\r\n}\r\n\r\nconst windowSize = new WindowSize();\r\nexport default windowSize;\r\n","type K = boolean;\r\nexport default async function filterAsync<T>(arr: T[], callback: (item: T, idx: number, arr: T[]) => Promise<K> | K) {\r\n  const promises = arr.map(async(item, idx, arr) => {\r\n    if(await callback(item, idx, arr)) {\r\n      return item;\r\n    }\r\n  });\r\n\r\n  return (await Promise.all(promises)).filter(Boolean);\r\n}\r\n","export default function numberThousandSplitter(x: number, joiner = ' ') {\r\n  const parts = x.toString().split(\".\");\r\n  parts[0] = parts[0].replace(/\\B(?=(\\d{3})+(?!\\d))/g, joiner);\r\n  return parts.join(\".\");\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport numberThousandSplitter from \"../../helpers/number/numberThousandSplitter\";\r\nimport { Chat, ChatParticipants } from \"../../layer\";\r\nimport { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport rootScope from \"../../lib/rootScope\";\r\n\r\nexport default async function getChatMembersString(chatId: ChatId, managers = rootScope.managers) {\r\n  const chat: Chat = await managers.appChatsManager.getChat(chatId);\r\n  if(chat._ === 'chatForbidden') {\r\n    return i18n('YouWereKicked');\r\n  }\r\n\r\n  const chatFull = await managers.appProfileManager.getCachedFullChat(chatId);\r\n  let count: number;\r\n  if(chatFull) {\r\n    if(chatFull._ === 'channelFull') {\r\n      count = chatFull.participants_count;\r\n    } else {\r\n      count = (chatFull.participants as ChatParticipants.chatParticipants).participants?.length;\r\n    }\r\n  } else {\r\n    count = (chat as Chat.chat).participants_count || (chat as any).participants?.participants.length;\r\n  }\r\n\r\n  const isBroadcast = (chat as Chat.channel).pFlags.broadcast;\r\n  count = count || 1;\r\n\r\n  let key: LangPackKey = isBroadcast ? 'Peer.Status.Subscribers' : 'Peer.Status.Member';\r\n  return i18n(key, [numberThousandSplitter(count)]);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { ChatRights } from \"../lib/appManagers/appChatsManager\";\r\nimport type { Dialog } from \"../lib/appManagers/appMessagesManager\";\r\nimport appDialogsManager from \"../lib/appManagers/appDialogsManager\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport Scrollable from \"./scrollable\";\r\nimport { FocusDirection } from \"../helpers/fastSmoothScroll\";\r\nimport CheckboxField from \"./checkboxField\";\r\nimport { i18n, LangPackKey, _i18n } from \"../lib/langPack\";\r\nimport findUpAttribute from \"../helpers/dom/findUpAttribute\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport PeerTitle from \"./peerTitle\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport debounce from \"../helpers/schedulers/debounce\";\r\nimport windowSize from \"../helpers/windowSize\";\r\nimport type { IsPeerType } from \"../lib/appManagers/appPeersManager\";\r\nimport { generateDelimiter, SettingSection } from \"./sidebarLeft\";\r\nimport { attachClickEvent, simulateClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport filterUnique from \"../helpers/array/filterUnique\";\r\nimport indexOfAndSplice from \"../helpers/array/indexOfAndSplice\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport findAndSplice from \"../helpers/array/findAndSplice\";\r\nimport AvatarElement from \"./avatar\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport filterAsync from \"../helpers/array/filterAsync\";\r\nimport getParticipantPeerId from \"../lib/appManagers/utils/chats/getParticipantPeerId\";\r\nimport getChatMembersString from \"./wrappers/getChatMembersString\";\r\nimport getUserStatusString from \"./wrappers/getUserStatusString\";\r\nimport { Chat, User } from \"../layer\";\r\nimport canSendToUser from \"../lib/appManagers/utils/users/canSendToUser\";\r\nimport hasRights from \"../lib/appManagers/utils/chats/hasRights\";\r\nimport getDialogIndex from \"../lib/appManagers/utils/dialogs/getDialogIndex\";\r\n\r\ntype SelectSearchPeerType = 'contacts' | 'dialogs' | 'channelParticipants';\r\n\r\n// TODO:    addMembers, ..  peerType: 'contacts',       -  ,      \r\n\r\nexport default class AppSelectPeers {\r\n  public container = document.createElement('div');\r\n  public list = appDialogsManager.createChatList(/* {\r\n    handheldsSize: 66,\r\n    avatarSize: 48\r\n  } */);\r\n  private chatsContainer = document.createElement('div');\r\n  public scrollable: Scrollable;\r\n  private selectedScrollable: Scrollable;\r\n  \r\n  private selectedContainer: HTMLElement;\r\n  public input: HTMLInputElement;\r\n  \r\n  //public selected: {[peerId: PeerId]: HTMLElement} = {};\r\n  public selected = new Set<PeerId | string>();\r\n\r\n  public freezed = false;\r\n\r\n  private folderId = 0;\r\n  private offsetIndex = 0;\r\n  private promise: Promise<any>;\r\n\r\n  private query = '';\r\n  private cachedContacts: PeerId[];\r\n\r\n  private loadedWhat: Partial<{[k in 'dialogs' | 'archived' | 'contacts' | 'channelParticipants']: true}> = {};\r\n\r\n  private renderedPeerIds: Set<PeerId> = new Set();\r\n\r\n  private appendTo: HTMLElement;\r\n  private onChange: (length: number) => void;\r\n  private peerType: SelectSearchPeerType[] = ['dialogs'];\r\n  private renderResultsFunc: (peerIds: PeerId[]) => void | Promise<void>;\r\n  private chatRightsAction: ChatRights;\r\n  private multiSelect = true;\r\n  private rippleEnabled = true;\r\n  private avatarSize = 48;\r\n  private exceptSelf = false;\r\n  private filterPeerTypeBy: IsPeerType[];\r\n\r\n  private tempIds: {[k in keyof AppSelectPeers['loadedWhat']]: number} = {};\r\n  private peerId: PeerId;\r\n\r\n  private placeholder: LangPackKey;\r\n\r\n  private selfPresence: LangPackKey = 'Presence.YourChat';\r\n  \r\n  private needSwitchList = false;\r\n\r\n  private sectionNameLangPackKey: LangPackKey;\r\n\r\n  private managers: AppManagers;\r\n  \r\n  constructor(options: {\r\n    appendTo: AppSelectPeers['appendTo'], \r\n    onChange?: AppSelectPeers['onChange'], \r\n    peerType?: AppSelectPeers['peerType'], \r\n    peerId?: AppSelectPeers['peerId'],\r\n    onFirstRender?: () => void, \r\n    renderResultsFunc?: AppSelectPeers['renderResultsFunc'], \r\n    chatRightsAction?: AppSelectPeers['chatRightsAction'], \r\n    multiSelect?: AppSelectPeers['multiSelect'],\r\n    rippleEnabled?: AppSelectPeers['rippleEnabled'],\r\n    avatarSize?: AppSelectPeers['avatarSize'],\r\n    placeholder?: AppSelectPeers['placeholder'],\r\n    selfPresence?: AppSelectPeers['selfPresence'],\r\n    exceptSelf?: AppSelectPeers['exceptSelf'],\r\n    filterPeerTypeBy?: AppSelectPeers['filterPeerTypeBy'],\r\n    sectionNameLangPackKey?: AppSelectPeers['sectionNameLangPackKey'],\r\n    managers: AppSelectPeers['managers']\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    this.container.classList.add('selector');\r\n\r\n    const f = (this.renderResultsFunc || this.renderResults).bind(this);\r\n    this.renderResultsFunc = async(peerIds) => {\r\n      if(this.needSwitchList) {\r\n        this.scrollable.splitUp.replaceWith(this.list);\r\n        this.scrollable.setVirtualContainer(this.list);\r\n        this.needSwitchList = false;\r\n      }\r\n      \r\n      peerIds = peerIds.filter((peerId) => {\r\n        const notRendered = !this.renderedPeerIds.has(peerId);\r\n        if(notRendered) this.renderedPeerIds.add(peerId);\r\n        return notRendered;\r\n      });\r\n\r\n      if(this.filterPeerTypeBy) {\r\n        peerIds = await filterAsync(peerIds, async(peerId) => {\r\n          if(peerId.isPeerId()) {\r\n            const peer = await this.managers.appPeersManager.getPeer(peerId);\r\n            if(!peer.deleted) {\r\n              for(const method of this.filterPeerTypeBy) {\r\n                if(await this.managers.appPeersManager[method](peerId)) {\r\n                  return true;\r\n                }\r\n              }\r\n            }\r\n          }\r\n\r\n          return true;\r\n        });\r\n      }\r\n\r\n      return f(peerIds);\r\n    };\r\n\r\n    this.input = document.createElement('input');\r\n    this.input.classList.add('selector-search-input');\r\n    if(this.placeholder) {\r\n      _i18n(this.input, this.placeholder, undefined, 'placeholder');\r\n    } else {\r\n      _i18n(this.input, 'SendMessageTo', undefined, 'placeholder');\r\n    }\r\n\r\n    this.input.type = 'text';\r\n\r\n    if(this.multiSelect) {\r\n      const section = new SettingSection({});\r\n      section.innerContainer.classList.add('selector-search-section');\r\n      let topContainer = document.createElement('div');\r\n      topContainer.classList.add('selector-search-container');\r\n  \r\n      this.selectedContainer = document.createElement('div');\r\n      this.selectedContainer.classList.add('selector-search');\r\n      \r\n      this.selectedContainer.append(this.input);\r\n      topContainer.append(this.selectedContainer);\r\n      this.selectedScrollable = new Scrollable(topContainer);\r\n  \r\n      // let delimiter = document.createElement('hr');\r\n\r\n      attachClickEvent(this.selectedContainer, (e) => {\r\n        if(this.freezed) return;\r\n        let target = e.target as HTMLElement;\r\n        target = findUpClassName(target, 'selector-user');\r\n  \r\n        if(!target) return;\r\n  \r\n        const peerId = target.dataset.key;\r\n        const li = this.chatsContainer.querySelector('[data-peer-id=\"' + peerId + '\"]') as HTMLElement;\r\n        if(!li) {\r\n          this.remove(peerId.toPeerId());\r\n        } else {\r\n          simulateClickEvent(li);\r\n        }\r\n      });\r\n\r\n      section.content.append(topContainer);\r\n      this.container.append(section.container/* , delimiter */);\r\n    }\r\n\r\n    this.chatsContainer.classList.add('chatlist-container');\r\n    // this.chatsContainer.append(this.list);\r\n    const section = new SettingSection({\r\n      name: this.sectionNameLangPackKey,\r\n      noShadow: true\r\n    });\r\n    section.content.append(this.list);\r\n    this.chatsContainer.append(section.container);\r\n    this.scrollable = new Scrollable(this.chatsContainer);\r\n    this.scrollable.setVirtualContainer(this.list);\r\n\r\n    attachClickEvent(this.chatsContainer, (e) => {\r\n      const target = findUpAttribute(e.target, 'data-peer-id') as HTMLElement;\r\n      cancelEvent(e);\r\n\r\n      if(!target) return;\r\n      if(this.freezed) return;\r\n\r\n      let key: PeerId | string = target.dataset.peerId;\r\n      key = key.isPeerId() ? key.toPeerId() : key;\r\n\r\n      if(!this.multiSelect) {\r\n        this.add(key);\r\n        return;\r\n      }\r\n\r\n      //target.classList.toggle('active');\r\n      if(this.selected.has(key)) {\r\n        this.remove(key);\r\n      } else {\r\n        this.add(key);\r\n      }\r\n\r\n      const checkbox = target.querySelector('input') as HTMLInputElement;\r\n      checkbox.checked = !checkbox.checked;\r\n    });\r\n\r\n    const debouncedInput = debounce(this.onInput, 200, false, true);\r\n    this.input.addEventListener('input', debouncedInput);\r\n\r\n    this.scrollable.onScrolledBottom = () => {\r\n      this.getMoreResults();\r\n    };\r\n\r\n    this.scrollable.container.prepend(generateDelimiter());\r\n\r\n    this.container.append(this.chatsContainer);\r\n    this.appendTo.append(this.container);\r\n\r\n    // WARNING TIMEOUT\r\n    setTimeout(() => {\r\n      let getResultsPromise = this.getMoreResults() as Promise<any>;\r\n      if(options.onFirstRender) {\r\n        getResultsPromise.then(() => {\r\n          options.onFirstRender();\r\n        });\r\n      }\r\n    }, 0);\r\n  }\r\n\r\n  private onInput = () => {\r\n    const value = this.input.value;\r\n    if(this.query !== value) {\r\n      if(this.peerType.includes('contacts') || this.peerType.includes('dialogs')) {\r\n        this.cachedContacts = null;\r\n      }\r\n      \r\n      if(this.peerType.includes('dialogs')) {\r\n        this.folderId = 0;\r\n        this.offsetIndex = 0;\r\n      }\r\n\r\n      for(let i in this.tempIds) {\r\n        // @ts-ignore\r\n        ++this.tempIds[i];\r\n      }\r\n\r\n      this.list = appDialogsManager.createChatList();\r\n\r\n      this.promise = null;\r\n      this.loadedWhat = {};\r\n      this.query = value;\r\n      this.renderedPeerIds.clear();\r\n      this.needSwitchList = true;\r\n      \r\n      //console.log('selectPeers input:', this.query);\r\n      this.getMoreResults();\r\n    }\r\n  };\r\n\r\n  private async renderSaved() {\r\n    if(\r\n      !this.exceptSelf && \r\n      !this.offsetIndex && \r\n      this.folderId === 0 && \r\n      this.peerType.includes('dialogs') && \r\n      (!this.query || await this.managers.appUsersManager.testSelfSearch(this.query))\r\n    ) {\r\n      await this.renderResultsFunc([rootScope.myId]);\r\n    }\r\n  }\r\n\r\n  private getTempId(type: keyof AppSelectPeers['tempIds']) {\r\n    if(this.tempIds[type] === undefined) {\r\n      this.tempIds[type] = 0;\r\n    }\r\n\r\n    return ++this.tempIds[type];\r\n  }\r\n\r\n  private async getMoreDialogs(): Promise<any> {\r\n    if(this.promise) return this.promise;\r\n\r\n    if(this.loadedWhat.dialogs && this.loadedWhat.archived) {\r\n      return;\r\n    }\r\n    \r\n    //   -   ,  ,    \r\n    const pageCount = windowSize.height / 72 * 1.25 | 0;\r\n\r\n    const tempId = this.getTempId('dialogs');\r\n    const promise = this.managers.appMessagesManager.getConversations(this.query, this.offsetIndex, pageCount, this.folderId, true);\r\n    this.promise = promise;\r\n    const value = await promise;\r\n    if(this.tempIds.dialogs !== tempId) {\r\n      return;\r\n    }\r\n\r\n    this.promise = null;\r\n\r\n    let dialogs = value.dialogs as Dialog[];\r\n    if(dialogs.length) {\r\n      const newOffsetIndex = getDialogIndex(dialogs[dialogs.length - 1]) || 0;\r\n\r\n      dialogs = dialogs.slice();\r\n      findAndSplice(dialogs, d => d.peerId === rootScope.myId); // no my account\r\n\r\n      if(this.chatRightsAction) {\r\n        dialogs = await filterAsync(dialogs, (d) => this.filterByRights(d.peerId));\r\n      }\r\n\r\n      await this.renderSaved();\r\n\r\n      this.offsetIndex = newOffsetIndex;\r\n    }\r\n\r\n    this.renderResultsFunc(dialogs.map((dialog) => dialog.peerId));\r\n    \r\n    if(value.isEnd) {\r\n      if(!this.loadedWhat.dialogs) {\r\n        await this.renderSaved();\r\n\r\n        this.loadedWhat.dialogs = true;\r\n        this.offsetIndex = 0;\r\n        this.folderId = 1;\r\n\r\n        return this.getMoreDialogs();\r\n      } else {\r\n        this.loadedWhat.archived = true;\r\n\r\n        if(!this.loadedWhat.contacts/*  && this.peerType.includes('contacts') */) {\r\n          return this.getMoreContacts();\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private async filterByRights(peerId: PeerId) {\r\n    const peer: User | Chat = await this.managers.appPeersManager.getPeer(peerId);\r\n    if(peerId.isUser()) {\r\n      return this.chatRightsAction !== 'send_messages' || canSendToUser(peer as User.user);\r\n    } else if(hasRights(peer as Chat.chat, this.chatRightsAction)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  private async getMoreContacts() {\r\n    if(this.promise) return this.promise;\r\n\r\n    if(this.loadedWhat.contacts) {\r\n      return;\r\n    }\r\n\r\n    const isGlobalSearch = this.peerType.includes('contacts');\r\n\r\n    if(!this.cachedContacts) {\r\n      /* const promises: Promise<any>[] = [appUsersManager.getContacts(this.query)];\r\n      if(!this.peerType.includes('dialogs')) {\r\n        promises.push(appMessagesManager.getConversationsAll());\r\n      }\r\n\r\n      this.promise = Promise.all(promises);\r\n      this.cachedContacts = (await this.promise)[0].slice(); */\r\n      const tempId = this.getTempId('contacts');\r\n      const promise = Promise.all([\r\n        isGlobalSearch ? this.managers.appUsersManager.getContactsPeerIds(this.query) : [],\r\n        this.query ? this.managers.appUsersManager.searchContacts(this.query) : undefined\r\n      ]);\r\n\r\n      this.promise = promise;\r\n      let [cachedContacts, searchResult] = await promise;\r\n      if(this.tempIds.contacts !== tempId) {\r\n        return;\r\n      }\r\n\r\n      if(searchResult) {\r\n        // do not add global result if only dialogs needed\r\n        let resultPeerIds = isGlobalSearch ? searchResult.my_results.concat(searchResult.results) : searchResult.my_results;\r\n\r\n        if(this.chatRightsAction) {\r\n          resultPeerIds = await filterAsync(resultPeerIds, (peerId) => this.filterByRights(peerId));\r\n        }\r\n\r\n        if(!this.peerType.includes('dialogs')) {\r\n          resultPeerIds = resultPeerIds.filter((peerId) => peerId.isUser());\r\n        }\r\n\r\n        this.cachedContacts = filterUnique(cachedContacts.concat(resultPeerIds));\r\n      } else this.cachedContacts = cachedContacts.slice();\r\n\r\n      indexOfAndSplice(this.cachedContacts, rootScope.myId); // no my account\r\n      this.promise = null;\r\n    }\r\n\r\n    // if(this.cachedContacts.length) {\r\n      const pageCount = windowSize.height / 72 * 1.25 | 0;\r\n      const arr = this.cachedContacts.splice(0, pageCount);\r\n      this.renderResultsFunc(arr);\r\n    // }\r\n    \r\n    if(!this.cachedContacts.length) {\r\n      this.loadedWhat.contacts = true;\r\n\r\n      // need to load non-contacts\r\n      /* if(!this.peerType.includes('dialogs')) {\r\n        return this.getMoreDialogs();\r\n      } */\r\n    }\r\n  }\r\n\r\n  private async getMoreChannelParticipants() {\r\n    if(this.promise) return this.promise;\r\n\r\n    if(this.loadedWhat.channelParticipants) {\r\n      return;\r\n    }\r\n\r\n    const pageCount = 50; // same as in group permissions to use cache\r\n\r\n    const tempId = this.getTempId('channelParticipants');\r\n    const promise = this.managers.appProfileManager.getChannelParticipants(this.peerId.toChatId(), {_: 'channelParticipantsSearch', q: this.query}, pageCount, this.list.childElementCount);\r\n    const participants = await promise;\r\n    if(this.tempIds.channelParticipants !== tempId) {\r\n      return;\r\n    }\r\n    \r\n    const peerIds = participants.participants.map((participant) => {\r\n      return getParticipantPeerId(participant);\r\n    });\r\n    indexOfAndSplice(peerIds, rootScope.myId);\r\n    this.renderResultsFunc(peerIds);\r\n\r\n    if(this.list.childElementCount >= participants.count || participants.participants.length < pageCount) {\r\n      this.loadedWhat.channelParticipants = true;\r\n    }\r\n  }\r\n\r\n  checkForTriggers = () => {\r\n    this.scrollable.checkForTriggers();\r\n  };\r\n\r\n  private getMoreResults() {\r\n    const get = () => {\r\n      const promises: Promise<any>[] = [];\r\n\r\n      // if(!loadedAllDialogs && (this.peerType.includes('dialogs')/*  || this.peerType.includes('contacts') */)) {\r\n      //   if(!loadAllDialogsPromise) {\r\n      //     loadAllDialogsPromise = appMessagesManager.getConversationsAll()\r\n      //     .then(() => {\r\n      //       loadedAllDialogs = true;\r\n      //     }).finally(() => {\r\n      //       loadAllDialogsPromise = null;\r\n      //     });\r\n      //   }\r\n\r\n      //   promises.push(loadAllDialogsPromise);\r\n      // }\r\n  \r\n      if((this.peerType.includes('dialogs')/*  || this.loadedWhat.contacts */) && !this.loadedWhat.archived) { // to load non-contacts\r\n        promises.push(this.getMoreDialogs());\r\n  \r\n        if(!this.loadedWhat.archived) {\r\n          return promises;\r\n        }\r\n      }\r\n      \r\n      if((this.peerType.includes('contacts') || this.peerType.includes('dialogs')) && !this.loadedWhat.contacts) {\r\n        promises.push(this.getMoreContacts());\r\n      }\r\n\r\n      if(this.peerType.includes('channelParticipants') && !this.loadedWhat.channelParticipants) {\r\n        promises.push(this.getMoreChannelParticipants());\r\n      }\r\n  \r\n      return promises;\r\n    };\r\n    \r\n    const promises = get();\r\n    const promise = Promise.all(promises);\r\n    if(promises.length) {\r\n      promise.then(this.checkForTriggers);\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  private async renderResults(peerIds: PeerId[]) {\r\n    //console.log('will renderResults:', peerIds);\r\n\r\n    //     \r\n    if(!this.peerType.includes('dialogs') && this.loadedWhat.contacts) {\r\n      peerIds = await filterAsync(peerIds, (peerId) => {\r\n        return this.managers.appUsersManager.isNonContactUser(peerId);\r\n      });\r\n    }\r\n\r\n    peerIds.forEach(async(peerId) => {\r\n      const {dom} = appDialogsManager.addDialogNew({\r\n        peerId: peerId,\r\n        container: this.scrollable,\r\n        rippleEnabled: this.rippleEnabled,\r\n        avatarSize: this.avatarSize\r\n      });\r\n\r\n      if(this.multiSelect) {\r\n        const selected = this.selected.has(peerId);\r\n        const checkboxField = new CheckboxField();\r\n\r\n        if(selected) {\r\n          //dom.listEl.classList.add('active');\r\n          checkboxField.input.checked = true;\r\n        }\r\n\r\n        dom.containerEl.prepend(checkboxField.label);\r\n      }\r\n\r\n      let subtitleEl: HTMLElement;\r\n      if(peerId.isAnyChat()) {\r\n        subtitleEl = await getChatMembersString(peerId.toChatId());\r\n      } else if(peerId === rootScope.myId) {\r\n        subtitleEl = i18n(this.selfPresence);\r\n      } else {\r\n        subtitleEl = getUserStatusString(await this.managers.appUsersManager.getUser(peerId.toUserId()));\r\n      }\r\n\r\n      dom.lastMessageSpan.append(subtitleEl);\r\n    });\r\n  }\r\n\r\n  public add(key: PeerId | string, title?: string | HTMLElement, scroll = true) {\r\n    //console.trace('add');\r\n    this.selected.add(key);\r\n\r\n    if(!this.multiSelect) {\r\n      this.onChange(this.selected.size);\r\n      return;\r\n    }\r\n\r\n    if(this.query.trim()) {\r\n      this.input.value = '';\r\n      this.onInput();\r\n    }\r\n\r\n    const div = document.createElement('div');\r\n    div.classList.add('selector-user', 'scale-in');\r\n\r\n    const avatarEl = new AvatarElement();\r\n    avatarEl.classList.add('selector-user-avatar', 'tgico', 'avatar-32');\r\n    avatarEl.isDialog = true;\r\n\r\n    div.dataset.key = '' + key;\r\n    if(key.isPeerId()) {\r\n      if(title === undefined) {\r\n        title = new PeerTitle({peerId: key.toPeerId(), dialog: true}).element;\r\n      }\r\n\r\n      avatarEl.updateWithOptions({\r\n        peerId: key as PeerId\r\n      });\r\n    }\r\n\r\n    if(title) {\r\n      if(typeof(title) === 'string') {\r\n        div.innerHTML = title;\r\n      } else {\r\n        replaceContent(div, title);\r\n        div.append(title);\r\n      }\r\n    }\r\n\r\n    div.insertAdjacentElement('afterbegin', avatarEl);\r\n\r\n    this.selectedContainer.insertBefore(div, this.input);\r\n    //this.selectedScrollable.scrollTop = this.selectedScrollable.scrollHeight;\r\n    this.onChange && this.onChange(this.selected.size);\r\n    \r\n    if(scroll) {\r\n      this.selectedScrollable.scrollIntoViewNew({\r\n        element: this.input, \r\n        position: 'center'\r\n      });\r\n    }\r\n    \r\n    return div;\r\n  }\r\n\r\n  public remove(key: PeerId | string) {\r\n    if(!this.multiSelect) return;\r\n    //const div = this.selected[peerId];\r\n    const div = this.selectedContainer.querySelector(`[data-key=\"${key}\"]`) as HTMLElement;\r\n    div.classList.remove('scale-in');\r\n    void div.offsetWidth;\r\n    div.classList.add('scale-out');\r\n\r\n    const onAnimationEnd = () => {\r\n      this.selected.delete(key);\r\n      div.remove();\r\n      this.onChange && this.onChange(this.selected.size);\r\n    };\r\n\r\n    if(rootScope.settings.animationsEnabled) {\r\n      div.addEventListener('animationend', onAnimationEnd, {once: true});\r\n    } else {\r\n      onAnimationEnd();\r\n    }\r\n  }\r\n\r\n  public getSelected() {\r\n    return [...this.selected];\r\n  }\r\n\r\n  public addInitial(values: any[]) {\r\n    values.forEach((value) => {\r\n      this.add(value, undefined, false);\r\n    });\r\n\r\n    window.requestAnimationFrame(() => { // ! not the best place for this raf though it works\r\n      this.selectedScrollable.scrollIntoViewNew({\r\n        element: this.input, \r\n        position: 'center', \r\n        forceDirection: FocusDirection.Static\r\n      });\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport AppSelectPeers from \"../appSelectPeers\";\r\nimport PopupElement from \".\";\r\nimport { LangPackKey, _i18n } from \"../../lib/langPack\";\r\n\r\nexport default class PopupPickUser extends PopupElement {\r\n  protected selector: AppSelectPeers;\r\n  \r\n  constructor(options: {\r\n    peerTypes: AppSelectPeers['peerType'], \r\n    onSelect?: (peerId: PeerId) => Promise<void> | void, \r\n    placeholder: LangPackKey,\r\n    chatRightsAction?: AppSelectPeers['chatRightsAction'],\r\n    peerId?: number,\r\n    selfPresence?: LangPackKey\r\n  }) {\r\n    super('popup-forward', {closable: true, overlayClosable: true, body: true, title: true});\r\n\r\n    this.selector = new AppSelectPeers({\r\n      appendTo: this.body, \r\n      onChange: async() => {\r\n        const selected = this.selector.getSelected();\r\n        const peerId = selected[selected.length - 1].toPeerId();\r\n        \r\n        if(options.onSelect) {\r\n          const res = options.onSelect(peerId);\r\n          if(res instanceof Promise) {\r\n            try {\r\n              await res;\r\n            } catch(err) {\r\n              return;\r\n            }\r\n          }\r\n        }\r\n\r\n        this.selector = null;\r\n        this.hide();\r\n      }, \r\n      peerType: options.peerTypes, \r\n      onFirstRender: () => {\r\n        this.show();\r\n        this.selector.checkForTriggers(); // ! due to zero height before mounting\r\n\r\n        if(!IS_TOUCH_SUPPORTED) {\r\n          this.selector.input.focus();\r\n        }\r\n      }, \r\n      chatRightsAction: options.chatRightsAction, \r\n      multiSelect: false,\r\n      rippleEnabled: false,\r\n      avatarSize: 46,\r\n      peerId: options.peerId,\r\n      placeholder: options.placeholder,\r\n      selfPresence: options.selfPresence,\r\n      managers: this.managers\r\n    });\r\n\r\n    //this.scrollable = new Scrollable(this.body);\r\n\r\n    this.title.append(this.selector.input);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport deepEqual from \"../../../helpers/object/deepEqual\";\r\nimport { ChannelParticipant } from \"../../../layer\";\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport Button from \"../../button\";\r\nimport { SettingSection } from \"../../sidebarLeft\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport getUserStatusString from \"../../wrappers/getUserStatusString\";\r\nimport { ChatPermissions } from \"./groupPermissions\";\r\n\r\nexport default class AppUserPermissionsTab extends SliderSuperTabEventable {\r\n  public participant: ChannelParticipant;\r\n  public chatId: ChatId;\r\n  public userId: UserId;\r\n\r\n  protected async init() {\r\n    this.container.classList.add('edit-peer-container', 'user-permissions-container');\r\n    this.setTitle('UserRestrictions');\r\n\r\n    let destroyListener: () => void;\r\n\r\n    {\r\n      const section = new SettingSection({\r\n        name: 'UserRestrictionsCanDo',\r\n      });\r\n      \r\n      const div = document.createElement('div');\r\n      div.classList.add('chatlist-container');\r\n      section.content.insertBefore(div, section.title);\r\n\r\n      const list = appDialogsManager.createChatList({new: true});\r\n      div.append(list);\r\n\r\n      const {dom} = appDialogsManager.addDialogNew({\r\n        peerId: this.userId.toPeerId(false),\r\n        container: list,\r\n        rippleEnabled: true,\r\n        avatarSize: 48\r\n      });\r\n\r\n      dom.lastMessageSpan.append(getUserStatusString(await this.managers.appUsersManager.getUser(this.userId)));\r\n\r\n      const p = new ChatPermissions({\r\n        chatId: this.chatId,\r\n        listenerSetter: this.listenerSetter,\r\n        appendTo: section.content,\r\n        participant: this.participant._ === 'channelParticipantBanned' ? this.participant : undefined\r\n      }, this.managers);\r\n\r\n      destroyListener = () => {\r\n        //appChatsManager.editChatDefaultBannedRights(this.chatId, p.takeOut());\r\n        const rights = p.takeOut();\r\n        if(this.participant._ === 'channelParticipantBanned' && deepEqual(this.participant.banned_rights.pFlags, rights.pFlags)) {\r\n          return;\r\n        }\r\n\r\n        this.managers.appChatsManager.editBanned(this.chatId, this.participant, rights);\r\n      };\r\n\r\n      this.eventListener.addEventListener('destroy', destroyListener, {once: true});\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n    \r\n    {\r\n      const section = new SettingSection({});\r\n\r\n      if(this.participant._ === 'channelParticipantBanned') {\r\n        const btnDeleteException = Button('btn-primary btn-transparent danger', {icon: 'delete', text: 'GroupPermission.Delete'});\r\n\r\n        attachClickEvent(btnDeleteException, () => {\r\n          const toggle = toggleDisability([btnDeleteException], true);\r\n          this.managers.appChatsManager.clearChannelParticipantBannedRights(this.chatId, this.participant).then(() => {\r\n            this.eventListener.removeEventListener('destroy', destroyListener);\r\n            this.close();\r\n          }, () => {\r\n            toggle();\r\n          });\r\n        }, {listenerSetter: this.listenerSetter});\r\n  \r\n        section.content.append(btnDeleteException);\r\n      }\r\n\r\n      const btnDelete = Button('btn-primary btn-transparent danger', {icon: 'deleteuser', text: 'UserRestrictionsBlock'});\r\n\r\n      attachClickEvent(btnDelete, () => {\r\n        const toggle = toggleDisability([btnDelete], true);\r\n        this.managers.appChatsManager.kickFromChannel(this.chatId, this.participant).then(() => {\r\n          this.eventListener.removeEventListener('destroy', destroyListener);\r\n          this.close();\r\n        });\r\n        /* new PopupPeer('popup-group-kick-user', {\r\n          peerId: -this.chatId,\r\n          title: 'Ban User?',\r\n          description: `Are you sure you want to ban <b>${appPeersManager.getPeerTitle(this.userId)}</b>`,\r\n          buttons: addCancelButton([{\r\n            text: 'BAN',\r\n            callback: () => {\r\n              const toggle = toggleDisability([btnDelete], true);\r\n\r\n              appChatsManager.kickFromChannel(this.chatId, this.participant).then(() => {\r\n                this.eventListener.removeEventListener('destroy', destroyListener);\r\n                this.close();\r\n              }, () => {\r\n                toggle();\r\n              });\r\n            },\r\n            isDanger: true\r\n          }])\r\n        }).show(); */\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      section.content.append(btnDelete);\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport findUpTag from \"../../../helpers/dom/findUpTag\";\r\nimport replaceContent from \"../../../helpers/dom/replaceContent\";\r\nimport ListenerSetter from \"../../../helpers/listenerSetter\";\r\nimport ScrollableLoader from \"../../../helpers/scrollableLoader\";\r\nimport { ChannelParticipant, Chat, ChatBannedRights, Update } from \"../../../layer\";\r\nimport { ChatRights } from \"../../../lib/appManagers/appChatsManager\";\r\nimport appDialogsManager, { DIALOG_LIST_ELEMENT_TAG } from \"../../../lib/appManagers/appDialogsManager\";\r\nimport { AppManagers } from \"../../../lib/appManagers/managers\";\r\nimport combineParticipantBannedRights from \"../../../lib/appManagers/utils/chats/combineParticipantBannedRights\";\r\nimport hasRights from \"../../../lib/appManagers/utils/chats/hasRights\";\r\nimport getPeerId from \"../../../lib/appManagers/utils/peers/getPeerId\";\r\nimport I18n, { i18n, join, LangPackKey } from \"../../../lib/langPack\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport PopupPickUser from \"../../popups/pickUser\";\r\nimport Row from \"../../row\";\r\nimport { SettingSection } from \"../../sidebarLeft\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport { toast } from \"../../toast\";\r\nimport AppUserPermissionsTab from \"./userPermissions\";\r\n\r\nexport class ChatPermissions {\r\n  public v: Array<{\r\n    flags: ChatRights[],\r\n    text: LangPackKey,\r\n    exceptionText: LangPackKey,\r\n    checkboxField?: CheckboxField,\r\n  }>;\r\n  private toggleWith: Partial<{[chatRight in ChatRights]: ChatRights[]}>;\r\n\r\n  constructor(private options: {\r\n    chatId: ChatId,\r\n    listenerSetter: ListenerSetter,\r\n    appendTo: HTMLElement,\r\n    participant?: ChannelParticipant.channelParticipantBanned\r\n  }, private managers: AppManagers) {\r\n    this.construct();\r\n  }\r\n\r\n  public async construct() {\r\n    this.v = [\r\n      {flags: ['send_messages'], text: 'UserRestrictionsSend', exceptionText: 'UserRestrictionsNoSend'},\r\n      {flags: ['send_media'], text: 'UserRestrictionsSendMedia', exceptionText: 'UserRestrictionsNoSendMedia'},\r\n      {flags: ['send_stickers', 'send_gifs'], text: 'UserRestrictionsSendStickers', exceptionText: 'UserRestrictionsNoSendStickers'},\r\n      {flags: ['send_polls'], text: 'UserRestrictionsSendPolls', exceptionText: 'UserRestrictionsNoSendPolls'},\r\n      {flags: ['embed_links'], text: 'UserRestrictionsEmbedLinks', exceptionText: 'UserRestrictionsNoEmbedLinks'},\r\n      {flags: ['invite_users'], text: 'UserRestrictionsInviteUsers', exceptionText: 'UserRestrictionsNoInviteUsers'},\r\n      {flags: ['pin_messages'], text: 'UserRestrictionsPinMessages', exceptionText: 'UserRestrictionsNoPinMessages'},\r\n      {flags: ['change_info'], text: 'UserRestrictionsChangeInfo', exceptionText: 'UserRestrictionsNoChangeInfo'}\r\n    ];\r\n\r\n    this.toggleWith = {\r\n      'send_messages': ['send_media', 'send_stickers', 'send_polls', 'embed_links']\r\n    };\r\n\r\n    const options = this.options;\r\n    const chat: Chat.chat | Chat.channel = await this.managers.appChatsManager.getChat(options.chatId);\r\n    const defaultBannedRights = chat.default_banned_rights;\r\n    const rights = options.participant ? combineParticipantBannedRights(chat as Chat.channel, options.participant.banned_rights) : defaultBannedRights;\r\n    \r\n    const restrictionText: LangPackKey = options.participant ? 'UserRestrictionsDisabled' : 'EditCantEditPermissionsPublic';\r\n    for(const info of this.v) {\r\n      const mainFlag = info.flags[0];\r\n      info.checkboxField = new CheckboxField({\r\n        text: info.text,\r\n        checked: hasRights(chat, mainFlag, rights),\r\n        restriction: true,\r\n        withRipple: true\r\n      });\r\n\r\n      if((\r\n          options.participant && \r\n          defaultBannedRights.pFlags[mainFlag as keyof typeof defaultBannedRights['pFlags']]\r\n        ) || (\r\n          (chat as Chat.channel).username &&\r\n          (\r\n            info.flags.includes('pin_messages') ||\r\n            info.flags.includes('change_info')\r\n          )\r\n        )\r\n      ) {\r\n        info.checkboxField.input.disabled = true;\r\n        \r\n        /* options.listenerSetter.add(info.checkboxField.input)('change', (e) => {\r\n          if(!e.isTrusted) {\r\n            return;\r\n          }\r\n\r\n          cancelEvent(e);\r\n          toast('This option is disabled for all members in Group Permissions.');\r\n          info.checkboxField.checked = false;\r\n        }); */\r\n\r\n        attachClickEvent(info.checkboxField.label, (e) => {\r\n          toast(I18n.format(restrictionText, true));\r\n        }, {listenerSetter: options.listenerSetter});\r\n      }\r\n\r\n      if(this.toggleWith[mainFlag]) {\r\n        options.listenerSetter.add(info.checkboxField.input)('change', () => {\r\n          if(!info.checkboxField.checked) {\r\n            const other = this.v.filter((i) => this.toggleWith[mainFlag].includes(i.flags[0]));\r\n            other.forEach((info) => {\r\n              info.checkboxField.checked = false;\r\n            });\r\n          }\r\n        });\r\n      }\r\n\r\n      options.appendTo.append(info.checkboxField.label);\r\n    }\r\n  }\r\n\r\n  public takeOut() {\r\n    const rights: ChatBannedRights = {\r\n      _: 'chatBannedRights',\r\n      until_date: 0x7FFFFFFF,\r\n      pFlags: {}\r\n    };\r\n\r\n    for(const info of this.v) {\r\n      const banned = !info.checkboxField.checked;\r\n      if(banned) {\r\n        info.flags.forEach((flag) => {\r\n          // @ts-ignore\r\n          rights.pFlags[flag] = true;\r\n        });\r\n      }\r\n    }\r\n\r\n    return rights;\r\n  }\r\n}\r\n\r\nexport default class AppGroupPermissionsTab extends SliderSuperTabEventable {\r\n  public chatId: ChatId;\r\n\r\n  protected async init() {\r\n    this.container.classList.add('edit-peer-container', 'group-permissions-container');\r\n    this.setTitle('ChannelPermissions');\r\n\r\n    let chatPermissions: ChatPermissions;\r\n    {\r\n      const section = new SettingSection({\r\n        name: 'ChannelPermissionsHeader',\r\n      });\r\n\r\n      chatPermissions = new ChatPermissions({\r\n        chatId: this.chatId,\r\n        listenerSetter: this.listenerSetter,\r\n        appendTo: section.content,\r\n      }, this.managers);\r\n\r\n      this.eventListener.addEventListener('destroy', () => {\r\n        this.managers.appChatsManager.editChatDefaultBannedRights(this.chatId, chatPermissions.takeOut());\r\n      }, {once: true});\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n    \r\n    {\r\n      const section = new SettingSection({\r\n        name: 'PrivacyExceptions'\r\n      });\r\n\r\n      const addExceptionRow = new Row({\r\n        titleLangKey: 'ChannelAddException',\r\n        subtitleLangKey: 'Loading',\r\n        icon: 'adduser',\r\n        clickable: () => {\r\n          new PopupPickUser({\r\n            peerTypes: ['channelParticipants'],\r\n            onSelect: (peerId) => {\r\n              setTimeout(() => {\r\n                openPermissions(peerId);\r\n              }, 0);\r\n            },\r\n            placeholder: 'ExceptionModal.Search.Placeholder',\r\n            peerId: -this.chatId,\r\n          });\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      const openPermissions = async(peerId: PeerId) => {\r\n        let participant: AppUserPermissionsTab['participant'];\r\n        try {\r\n          participant = await this.managers.appProfileManager.getChannelParticipant(this.chatId, peerId) as any;\r\n        } catch(err) {\r\n          toast('User is no longer participant');\r\n          return;\r\n        }\r\n\r\n        const tab = this.slider.createTab(AppUserPermissionsTab);\r\n        tab.participant = participant;\r\n        tab.chatId = this.chatId;\r\n        tab.userId = peerId;\r\n        tab.open();\r\n      };\r\n\r\n      section.content.append(addExceptionRow.container);\r\n\r\n      /* const removedUsersRow = new Row({\r\n        titleLangKey: 'ChannelBlockedUsers',\r\n        subtitleLangKey: 'NoBlockedUsers',\r\n        icon: 'deleteuser',\r\n        clickable: true\r\n      });\r\n\r\n      section.content.append(removedUsersRow.container); */\r\n\r\n      const c = section.generateContentElement();\r\n      c.classList.add('chatlist-container');\r\n      \r\n      const list = appDialogsManager.createChatList({new: true});\r\n      c.append(list);\r\n\r\n      attachClickEvent(list, (e) => {\r\n        const target = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG);\r\n        if(!target) return;\r\n\r\n        const peerId = target.dataset.peerId.toPeerId();\r\n        openPermissions(peerId);\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      const setSubtitle = async(li: Element, participant: ChannelParticipant.channelParticipantBanned) => {\r\n        const bannedRights = participant.banned_rights;//appChatsManager.combineParticipantBannedRights(this.chatId, participant.banned_rights);\r\n        const defaultBannedRights = ((await this.managers.appChatsManager.getChat(this.chatId)) as Chat.channel).default_banned_rights;\r\n        //const combinedRights = appChatsManager.combineParticipantBannedRights(this.chatId, bannedRights);\r\n\r\n        const cantWhat: LangPackKey[] = []/* , canWhat: LangPackKey[] = [] */;\r\n        chatPermissions.v.forEach((info) => {\r\n          const mainFlag = info.flags[0];\r\n          // @ts-ignore\r\n          if(bannedRights.pFlags[mainFlag] && !defaultBannedRights.pFlags[mainFlag]) {\r\n            cantWhat.push(info.exceptionText);\r\n          // @ts-ignore\r\n          }/*  else if(!combinedRights.pFlags[mainFlag]) {\r\n            canWhat.push(info.exceptionText);\r\n          } */\r\n        });\r\n\r\n        const el = li.querySelector('.user-last-message') as HTMLElement;\r\n\r\n        if(cantWhat.length) {\r\n          el.innerHTML = '';\r\n          el.append(...join(cantWhat.map((t) => i18n(t)), false));\r\n        }/*  else if(canWhat.length) {\r\n          str = 'Can ' + canWhat.join(canWhat.length === 2 ? ' and ' : ', ');\r\n        } */\r\n  \r\n        el.classList.toggle('hide', !cantWhat.length);\r\n      };\r\n\r\n      const add = (participant: ChannelParticipant.channelParticipantBanned, append: boolean) => {\r\n        const {dom} = appDialogsManager.addDialogNew({\r\n          peerId: getPeerId(participant.peer),\r\n          container: list,\r\n          rippleEnabled: true,\r\n          avatarSize: 48,\r\n          append\r\n        });\r\n\r\n        setSubtitle(dom.listEl, participant);\r\n\r\n        //dom.titleSpan.innerHTML = 'Chinaza Akachi';\r\n        //dom.lastMessageSpan.innerHTML = 'Can Add Users and Pin Messages';\r\n      };\r\n\r\n      // this.listenerSetter.add(rootScope)('updateChannelParticipant', (update: Update.updateChannelParticipant) => {\r\n      //   const needAdd = update.new_participant?._ === 'channelParticipantBanned' && !update.new_participant.banned_rights.pFlags.view_messages;\r\n      //   const li = list.querySelector(`[data-peer-id=\"${update.user_id}\"]`);\r\n      //   if(needAdd) {\r\n      //     if(!li) {\r\n      //       add(update.new_participant as ChannelParticipant.channelParticipantBanned, false);\r\n      //     } else {\r\n      //       setSubtitle(li, update.new_participant as ChannelParticipant.channelParticipantBanned);\r\n      //     }\r\n\r\n      //     if(update.prev_participant?._ !== 'channelParticipantBanned') {\r\n      //       ++exceptionsCount;\r\n      //     }\r\n      //   } else {\r\n      //     if(li) {\r\n      //       li.remove();\r\n      //     }\r\n\r\n      //     if(update.prev_participant?._ === 'channelParticipantBanned') {\r\n      //       --exceptionsCount;\r\n      //     }\r\n      //   }\r\n\r\n      //   setLength();\r\n      // });\r\n\r\n      const setLength = () => {\r\n        replaceContent(addExceptionRow.subtitle, i18n(exceptionsCount ? 'Permissions.ExceptionsCount' : 'Permissions.NoExceptions', [exceptionsCount]));\r\n      };\r\n\r\n      let exceptionsCount = 0;\r\n      let loader: ScrollableLoader;\r\n      const setLoader = () => {\r\n        const LOAD_COUNT = 50;\r\n        loader = new ScrollableLoader({\r\n          scrollable: this.scrollable,\r\n          getPromise: () => {\r\n            return this.managers.appProfileManager.getChannelParticipants(this.chatId, {_: 'channelParticipantsBanned', q: ''}, LOAD_COUNT, list.childElementCount).then((res) => {\r\n              for(const participant of res.participants) {\r\n                add(participant as ChannelParticipant.channelParticipantBanned, true);\r\n              }\r\n  \r\n              exceptionsCount = res.count;\r\n              setLength();\r\n  \r\n              return res.participants.length < LOAD_COUNT || res.count === list.childElementCount;\r\n            });\r\n          }\r\n        });\r\n\r\n        return loader.load();\r\n      };\r\n\r\n      this.scrollable.append(section.container);\r\n\r\n      if(await this.managers.appChatsManager.isChannel(this.chatId)) {\r\n        await setLoader();\r\n      } else {\r\n        setLength();\r\n        \r\n        this.listenerSetter.add(rootScope)('dialog_migrate', ({migrateFrom, migrateTo}) => {\r\n          if(this.chatId === migrateFrom) {\r\n            this.chatId = migrateTo;\r\n            setLoader();\r\n          }\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    this.scrollable.onScroll();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport copy from \"../../../../helpers/object/copy\";\r\nimport { ChatBannedRights, Chat } from \"../../../../layer\";\r\n\r\nexport default function combineParticipantBannedRights(chat: Chat.channel, rights: ChatBannedRights) {\r\n  if(chat.default_banned_rights) {\r\n    rights = copy(rights);\r\n    const defaultRights = chat.default_banned_rights.pFlags;\r\n    for(let i in defaultRights) {\r\n      // @ts-ignore\r\n      rights.pFlags[i] = defaultRights[i];\r\n    }\r\n  }\r\n\r\n  return rights;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \".\";\r\nimport type { PeerType } from \"../../lib/appManagers/appPeersManager\";\r\nimport { LangPackKey } from \"../../lib/langPack\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport PopupPeer, { PopupPeerButtonCallbackCheckboxes, PopupPeerOptions } from \"./peer\";\r\n\r\nexport default class PopupDeleteDialog {\r\n  constructor(\r\n    private peerId: PeerId, \r\n    // actionType: 'leave' | 'delete', \r\n    private peerType?: PeerType, \r\n    private onSelect?: (promise: Promise<any>) => void\r\n  ) {\r\n    this.construct();\r\n  }\r\n\r\n  private async construct() {\r\n    let {peerId, peerType, onSelect} = this;\r\n    const peerTitleElement = new PeerTitle({peerId}).element;\r\n\r\n    const managers = PopupElement.MANAGERS;\r\n    if(peerType === undefined) {\r\n      peerType = await managers.appPeersManager.getDialogType(peerId);\r\n    }\r\n\r\n    /* const callbackFlush = (checked: PopupPeerButtonCallbackCheckboxes) => {\r\n      const promise = appMessagesManager.flushHistory(peerId, checkboxes ? !checked[checkboxes[0].text] : undefined);\r\n      onSelect && onSelect(promise);\r\n    }; */\r\n\r\n    const callbackLeave = (checked: PopupPeerButtonCallbackCheckboxes, flush = checkboxes && !!checked.size) => {\r\n      let promise = managers.appChatsManager.leave(peerId.toChatId());\r\n      \r\n      if(flush) {\r\n        promise = promise.finally(() => {\r\n          return managers.appMessagesManager.flushHistory(peerId);\r\n        }) as any;\r\n      }\r\n      \r\n      onSelect && onSelect(promise);\r\n    };\r\n\r\n    const callbackDelete = (checked: PopupPeerButtonCallbackCheckboxes) => {\r\n      let promise: Promise<any>;\r\n\r\n      if(peerId.isUser()) {\r\n        promise = managers.appMessagesManager.flushHistory(peerId, false, checkboxes ? !!checked.size : undefined);\r\n      } else {\r\n        if(checked.size) {\r\n          promise = managers.appChatsManager.delete(peerId.toChatId());\r\n        } else {\r\n          return callbackLeave(checked);\r\n        }\r\n      }\r\n      \r\n      onSelect && onSelect(promise);\r\n    };\r\n\r\n    let title: LangPackKey, description: LangPackKey, descriptionArgs: any[], buttons: PopupPeerOptions['buttons'], checkboxes: PopupPeerOptions['checkboxes'];\r\n    switch(peerType) {\r\n      case 'channel': {\r\n        if(/* actionType === 'delete' &&  */await managers.appChatsManager.hasRights(peerId.toChatId(), 'delete_chat')) {\r\n          title = 'ChannelDeleteMenu';\r\n          description = 'AreYouSureDeleteAndExitChannel';\r\n          buttons = [{\r\n            langKey: 'ChannelDeleteMenu',\r\n            isDanger: true,\r\n            callback: callbackDelete\r\n          }];\r\n\r\n          checkboxes = [{\r\n            text: 'DeleteChannelForAll'\r\n          }];\r\n        } else {\r\n          title = 'LeaveChannelMenu';\r\n          description = 'ChannelLeaveAlertWithName';\r\n          descriptionArgs = [peerTitleElement];\r\n          buttons = [{\r\n            langKey: 'LeaveChannel',\r\n            isDanger: true,\r\n            callback: callbackLeave\r\n          }];\r\n        }\r\n\r\n        break;\r\n      }\r\n\r\n      /* case 'megagroup': {\r\n        title = 'Leave Group?';\r\n        description = `Are you sure you want to leave this group?`;\r\n        buttons = [{\r\n          text: 'LEAVE ' + peerTitleElement,\r\n          isDanger: true,\r\n          callback: callbackLeave\r\n        }];\r\n\r\n        break;\r\n      } */\r\n\r\n      case 'chat': {\r\n        title = 'DeleteChatUser';\r\n        description = 'AreYouSureDeleteThisChatWithUser';\r\n        descriptionArgs = [peerTitleElement];\r\n\r\n        buttons = [{\r\n          langKey: 'DeleteChatUser',\r\n          isDanger: true,\r\n          callback: callbackDelete\r\n        }];\r\n\r\n        checkboxes = [{\r\n          text: 'DeleteMessagesOptionAlso',\r\n          textArgs: [\r\n            new PeerTitle({peerId}).element\r\n          ]\r\n        }];\r\n\r\n        break;\r\n      }\r\n\r\n      case 'saved': {\r\n        title = 'DeleteChatUser';\r\n        description = 'AreYouSureDeleteThisChatSavedMessages';\r\n        buttons = [{\r\n          langKey: 'DeleteChatUser',\r\n          isDanger: true,\r\n          callback: callbackDelete\r\n        }];\r\n\r\n        break;\r\n      }\r\n\r\n      case 'megagroup':\r\n      case 'group': {\r\n        if(/* actionType === 'delete' &&  */await managers.appChatsManager.hasRights(peerId.toChatId(), 'delete_chat')) {\r\n          title = 'DeleteMegaMenu';\r\n          description = 'AreYouSureDeleteAndExit';\r\n          buttons = [{\r\n            langKey: 'DeleteMegaMenu',\r\n            isDanger: true,\r\n            callback: callbackDelete\r\n          }];\r\n\r\n          checkboxes = [{\r\n            text: 'DeleteChat.DeleteGroupForAll'\r\n          }];\r\n        } else {\r\n          title = 'LeaveMegaMenu';\r\n          description = 'AreYouSureDeleteAndExitName';\r\n          descriptionArgs = [peerTitleElement];\r\n          buttons = [{\r\n            langKey: 'DeleteChatUser',\r\n            isDanger: true,\r\n            callback: (checkboxes) => callbackLeave(checkboxes, true)\r\n          }];\r\n        }\r\n\r\n        break;\r\n      }\r\n    }\r\n\r\n    new PopupPeer('popup-delete-chat', {\r\n      peerId,\r\n      titleLangKey: title,\r\n      descriptionLangKey: description,\r\n      descriptionLangArgs: descriptionArgs,\r\n      buttons,\r\n      checkboxes\r\n    }).show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport debounce from \"../../../helpers/schedulers/debounce\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport Row from \"../../row\";\r\nimport { SettingSection } from \"../../sidebarLeft\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport { wrapStickerToRow } from \"../../wrappers\";\r\n\r\nexport default class AppChatReactionsTab extends SliderSuperTabEventable {\r\n  public chatId: ChatId;\r\n\r\n  protected async init() {\r\n    this.setTitle('Reactions');\r\n\r\n    const availableReactions = await this.managers.appReactionsManager.getActiveAvailableReactions();\r\n    const chatFull = await this.managers.appProfileManager.getChatFull(this.chatId);\r\n    let originalReactions = chatFull.available_reactions ?? [];\r\n    const enabledReactions = new Set(originalReactions);\r\n\r\n    const toggleSection = new SettingSection({\r\n      caption: await this.managers.appChatsManager.isBroadcast(this.chatId) ? 'EnableReactionsChannelInfo' : 'EnableReactionsGroupInfo'\r\n    });\r\n\r\n    const toggleCheckboxField = new CheckboxField({toggle: true, checked: !!enabledReactions.size});\r\n    const toggleRow = new Row({\r\n      checkboxField: toggleCheckboxField,\r\n      titleLangKey: 'EnableReactions',\r\n      listenerSetter: this.listenerSetter\r\n    });\r\n\r\n    toggleSection.content.append(toggleRow.container);\r\n\r\n    const reactionsSection = new SettingSection({\r\n      name: 'AvailableReactions'\r\n    });\r\n\r\n    const checkboxFields = availableReactions.map((availableReaction) => {\r\n      const checkboxField = new CheckboxField({\r\n        toggle: true, \r\n        checked: enabledReactions.has(availableReaction.reaction)\r\n      });\r\n\r\n      this.listenerSetter.add(checkboxField.input)('change', () => {\r\n        if(checkboxField.checked) {\r\n          enabledReactions.add(availableReaction.reaction);\r\n\r\n          if(!toggleCheckboxField.checked) {\r\n            toggleCheckboxField.setValueSilently(true);\r\n          }\r\n        } else {\r\n          enabledReactions.delete(availableReaction.reaction);\r\n\r\n          if(!enabledReactions.size && toggleCheckboxField.checked) {\r\n            toggleCheckboxField.setValueSilently(false);\r\n          }\r\n        }\r\n\r\n        saveReactionsDebounced();\r\n      });\r\n\r\n      const row = new Row({\r\n        checkboxField,\r\n        title: availableReaction.title,\r\n        havePadding: true,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      wrapStickerToRow({\r\n        row,\r\n        doc: availableReaction.static_icon,\r\n        size: 'small'\r\n      });\r\n\r\n      reactionsSection.content.append(row.container);\r\n\r\n      return checkboxField;\r\n    });\r\n\r\n    this.listenerSetter.add(toggleRow.checkboxField.input)('change', () => {\r\n      if(!toggleCheckboxField.checked) {\r\n        checkboxFields.forEach((checkboxField) => checkboxField.checked = false);\r\n        saveReactionsDebounced();\r\n      } else if(checkboxFields.every((checkboxField) => !checkboxField.checked)) {\r\n        checkboxFields.forEach((checkboxField) => checkboxField.checked = true);\r\n        saveReactionsDebounced();\r\n      }\r\n    });\r\n\r\n    const saveReactions = async() => {\r\n      const newReactions = Array.from(enabledReactions);\r\n      if([...newReactions].sort().join() === [...originalReactions].sort().join()) {\r\n        return;\r\n      }\r\n\r\n      const chatFull = await this.managers.appProfileManager.getCachedFullChat(this.chatId);\r\n      if(chatFull) {\r\n        chatFull.available_reactions = newReactions;\r\n      }\r\n      \r\n      this.managers.appChatsManager.setChatAvailableReactions(this.chatId, newReactions);\r\n      originalReactions = newReactions;\r\n    };\r\n\r\n    const saveReactionsDebounced = debounce(saveReactions, 3000, false, true);\r\n\r\n    this.eventListener.addEventListener('destroy', saveReactions, {once: true});\r\n\r\n    this.scrollable.append(toggleSection.container, reactionsSection.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\"\r\nimport InputField from \"../../inputField\";\r\nimport EditPeer from \"../../editPeer\";\r\nimport { SettingSection } from \"../../sidebarLeft\";\r\nimport Row from \"../../row\";\r\nimport Button from \"../../button\";\r\nimport { ChatRights } from \"../../../lib/appManagers/appChatsManager\";\r\nimport { Chat, ChatFull } from \"../../../layer\";\r\nimport AppChatTypeTab from \"./chatType\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport AppGroupPermissionsTab from \"./groupPermissions\";\r\nimport { i18n, LangPackKey } from \"../../../lib/langPack\";\r\nimport PopupDeleteDialog from \"../../popups/deleteDialog\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport AppChatReactionsTab from \"./chatReactions\";\r\nimport hasRights from \"../../../lib/appManagers/utils/chats/hasRights\";\r\n\r\nexport default class AppEditChatTab extends SliderSuperTab {\r\n  private chatNameInputField: InputField;\r\n  private descriptionInputField: InputField;\r\n  private editPeer: EditPeer;\r\n  private tempId: number;\r\n  public chatId: ChatId;\r\n\r\n  protected async _init() {\r\n    // * cleanup prev\r\n    this.listenerSetter.removeAll();\r\n    this.scrollable.container.innerHTML = '';\r\n    this.tempId ??= 0;\r\n    const tempId = ++this.tempId;\r\n\r\n    this.container.classList.add('edit-peer-container', 'edit-group-container');\r\n    this.setTitle('Edit');\r\n    \r\n    let chatFull = await this.managers.appProfileManager.getChatFull(this.chatId, true);\r\n\r\n    const chat: Chat.chat | Chat.channel = await this.managers.appChatsManager.getChat(this.chatId);\r\n    const isBroadcast = await this.managers.appChatsManager.isBroadcast(this.chatId);\r\n    const isChannel = await this.managers.appChatsManager.isChannel(this.chatId);\r\n\r\n    const chatUpdateListeners: (() => void)[] = [];\r\n    const addChatUpdateListener = (callback: () => void) => {\r\n      chatUpdateListeners.push(callback);\r\n    };\r\n\r\n    this.listenerSetter.add(rootScope)('chat_update', (chatId) => {\r\n      if(this.chatId === chatId) {\r\n        chatUpdateListeners.forEach((callback) => callback());\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('chat_full_update', async(chatId) => {\r\n      if(this.chatId === chatId) {\r\n        chatFull = await this.managers.appProfileManager.getCachedFullChat(chatId) || chatFull;\r\n      }\r\n    });\r\n\r\n    const peerId = this.chatId.toPeerId(true);\r\n    const canChangeType = await this.managers.appChatsManager.hasRights(this.chatId, 'change_type');\r\n    const canChangePermissions = await this.managers.appChatsManager.hasRights(this.chatId, 'change_permissions');\r\n\r\n    {\r\n      const section = new SettingSection({noDelimiter: true});\r\n      const inputFields: InputField[] = [];\r\n\r\n      const inputWrapper = document.createElement('div');\r\n      inputWrapper.classList.add('input-wrapper');\r\n  \r\n      this.chatNameInputField = new InputField({\r\n        label: isBroadcast ? 'EnterChannelName' : 'CreateGroup.NameHolder',\r\n        name: 'chat-name',\r\n        maxLength: 255,\r\n        required: true\r\n      });\r\n      this.descriptionInputField = new InputField({\r\n        label: 'DescriptionPlaceholder',\r\n        name: 'chat-description',\r\n        maxLength: 255\r\n      });\r\n      \r\n      this.chatNameInputField.setOriginalValue(chat.title);\r\n      this.descriptionInputField.setOriginalValue(chatFull.about);\r\n\r\n      inputWrapper.append(this.chatNameInputField.container, this.descriptionInputField.container);\r\n      \r\n      inputFields.push(this.chatNameInputField, this.descriptionInputField);\r\n\r\n      this.editPeer = new EditPeer({\r\n        peerId,\r\n        inputFields,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n      this.content.append(this.editPeer.nextBtn);\r\n\r\n      section.content.append(this.editPeer.avatarEdit.container, inputWrapper);\r\n    \r\n      if(canChangeType) {\r\n        const chatTypeRow = new Row({\r\n          titleLangKey: isBroadcast ? 'ChannelType' : 'GroupType',\r\n          clickable: () => {\r\n            const tab = this.slider.createTab(AppChatTypeTab);\r\n            tab.chatId = this.chatId;\r\n            tab.chatFull = chatFull;\r\n            tab.open();\r\n\r\n            this.listenerSetter.add(tab.eventListener)('destroy', setChatTypeSubtitle);\r\n          },\r\n          icon: 'lock',\r\n          listenerSetter: this.listenerSetter\r\n        });\r\n\r\n        const setChatTypeSubtitle = () => {\r\n          chatTypeRow.subtitle.textContent = '';\r\n\r\n          let key: LangPackKey;\r\n          if(isBroadcast) {\r\n            key = (chat as Chat.channel).username ? 'TypePublic' : 'TypePrivate';\r\n          } else {\r\n            key = (chat as Chat.channel).username ? 'TypePublicGroup' : 'TypePrivateGroup';\r\n          }\r\n\r\n          chatTypeRow.subtitle.append(i18n(key));\r\n        };\r\n\r\n        setChatTypeSubtitle();\r\n        section.content.append(chatTypeRow.container);\r\n      }\r\n\r\n      if(canChangeType || canChangePermissions) {\r\n        const reactionsRow = new Row({\r\n          titleLangKey: 'Reactions',\r\n          icon: 'reactions',\r\n          clickable: () => {\r\n            const tab = this.slider.createTab(AppChatReactionsTab);\r\n            tab.chatId = this.chatId;\r\n            tab.open().then(() => {\r\n              if(this.tempId !== tempId) {\r\n                return;\r\n              }\r\n              \r\n              this.listenerSetter.add(tab.eventListener)('destroy', setReactionsLength);\r\n            });\r\n          },\r\n          listenerSetter: this.listenerSetter\r\n        });\r\n\r\n        const availableReactions = await this.managers.appReactionsManager.getAvailableReactions();\r\n        const availableReactionsLength = availableReactions.filter((availableReaction) => !availableReaction.pFlags.inactive).length;\r\n        const setReactionsLength = () => {\r\n          const reactions = chatFull.available_reactions ?? [];\r\n          reactionsRow.subtitle.innerHTML = reactions.length + '/' + availableReactionsLength;\r\n        };\r\n\r\n        setReactionsLength();\r\n\r\n        section.content.append(reactionsRow.container);\r\n      }\r\n\r\n      if(canChangePermissions && !isBroadcast) {\r\n        const flags = [\r\n          'send_messages',\r\n          'send_media',\r\n          'send_stickers',\r\n          'send_polls',\r\n          'embed_links',\r\n          'invite_users',\r\n          'pin_messages',\r\n          'change_info'\r\n        ] as ChatRights[];\r\n\r\n        const permissionsRow = new Row({\r\n          titleLangKey: 'ChannelPermissions',\r\n          clickable: () => {\r\n            const tab = this.slider.createTab(AppGroupPermissionsTab);\r\n            tab.chatId = this.chatId;\r\n            tab.open();\r\n          },\r\n          icon: 'permissions',\r\n          listenerSetter: this.listenerSetter\r\n        });\r\n\r\n        const setPermissionsLength = async() => {\r\n          const chat = await this.managers.appChatsManager.getChatTyped(this.chatId);\r\n          permissionsRow.subtitle.innerHTML = flags.reduce((acc, f) => acc + +hasRights(chat, f, (chat as Chat.chat).default_banned_rights), 0) + '/' + flags.length;\r\n        };\r\n\r\n        setPermissionsLength();        \r\n        section.content.append(permissionsRow.container);\r\n\r\n        this.listenerSetter.add(rootScope)('chat_update', (chatId) => {\r\n          if(this.chatId === chatId) {\r\n            setPermissionsLength();\r\n          }\r\n        });\r\n      }\r\n\r\n      /* const administratorsRow = new Row({\r\n        titleLangKey: 'PeerInfo.Administrators',\r\n        subtitle: '' + ((chatFull as ChatFull.channelFull).admins_count || 1),\r\n        icon: 'admin',\r\n        clickable: true\r\n      });\r\n\r\n      section.content.append(administratorsRow.container); */\r\n\r\n      this.scrollable.append(section.container);\r\n\r\n      attachClickEvent(this.editPeer.nextBtn, () => {\r\n        this.editPeer.nextBtn.disabled = true;\r\n  \r\n        let promises: Promise<any>[] = [];\r\n\r\n        const id = this.chatId;\r\n        if(this.chatNameInputField.isValidToChange()) {\r\n          promises.push(this.managers.appChatsManager.editTitle(id, this.chatNameInputField.value));\r\n        }\r\n\r\n        if(this.descriptionInputField.isValidToChange()) {\r\n          promises.push(this.managers.appChatsManager.editAbout(id, this.descriptionInputField.value));\r\n        }\r\n\r\n        if(this.editPeer.uploadAvatar) {\r\n          promises.push(this.editPeer.uploadAvatar().then((inputFile) => {\r\n            return this.managers.appChatsManager.editPhoto(id, inputFile);\r\n          }));\r\n        }\r\n  \r\n        Promise.race(promises).finally(() => {\r\n          this.editPeer.nextBtn.removeAttribute('disabled');\r\n          this.close();\r\n        });\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      \r\n      /* if(appChatsManager.hasRights(-this.peerId, 'change_info')) {\r\n        const discussionRow = new Row({\r\n          titleLangKey: 'PeerInfo.Discussion',\r\n          subtitleLangKey: 'PeerInfo.Discussion.Add',\r\n          clickable: true,\r\n          icon: 'message'\r\n        });\r\n\r\n        section.content.append(discussionRow.container);\r\n      }\r\n\r\n      const administratorsRow = new Row({\r\n        titleLangKey: 'PeerInfo.Administrators',\r\n        subtitle: '' + chatFull.admins_count,\r\n        icon: 'admin',\r\n        clickable: true\r\n      });\r\n\r\n      section.content.append(administratorsRow.container); */\r\n\r\n      if(isBroadcast && await this.managers.appChatsManager.hasRights(this.chatId, 'change_info')) {\r\n        const signMessagesCheckboxField = new CheckboxField({\r\n          text: 'PeerInfo.SignMessages',\r\n          checked: !!(chat as Chat.channel).pFlags.signatures,\r\n          withRipple: true\r\n        });\r\n\r\n        this.listenerSetter.add(signMessagesCheckboxField.input)('change', () => {\r\n          const toggle = signMessagesCheckboxField.toggleDisability(true);\r\n          this.managers.appChatsManager.toggleSignatures(this.chatId, signMessagesCheckboxField.checked).then(() => {\r\n            toggle();\r\n          });\r\n        });\r\n\r\n        addChatUpdateListener(() => {\r\n          signMessagesCheckboxField.setValueSilently(!!(chat as Chat.channel).pFlags.signatures);\r\n        });\r\n\r\n        section.content.append(signMessagesCheckboxField.label);\r\n      }\r\n    }\r\n\r\n    if(!isBroadcast) {\r\n      const section = new SettingSection({\r\n\r\n      });\r\n\r\n      /* const membersRow = new Row({\r\n        titleLangKey: isBroadcast ? 'PeerInfo.Subscribers' : 'GroupMembers',\r\n        icon: 'newgroup',\r\n        clickable: true\r\n      });\r\n\r\n      membersRow.subtitle.append(i18n('Subscribers', [numberThousandSplitter(335356)]));\r\n\r\n      section.content.append(membersRow.container); */\r\n\r\n      if(!isBroadcast && canChangeType) {\r\n        const showChatHistoryCheckboxField = new CheckboxField({\r\n          text: 'ChatHistory',\r\n          withRipple: true\r\n        });\r\n\r\n        this.listenerSetter.add(showChatHistoryCheckboxField.input)('change', () => {\r\n          const toggle = showChatHistoryCheckboxField.toggleDisability(true);\r\n          this.managers.appChatsManager.togglePreHistoryHidden(this.chatId, !showChatHistoryCheckboxField.checked).then(() => {\r\n            toggle();\r\n          });\r\n        });\r\n\r\n        // ! it won't be updated because chatFull will be old\r\n        const onChatUpdate = () => {\r\n          showChatHistoryCheckboxField.setValueSilently(isChannel && !(chatFull as ChatFull.channelFull).pFlags.hidden_prehistory);\r\n        };\r\n\r\n        onChatUpdate();\r\n        addChatUpdateListener(onChatUpdate);\r\n  \r\n        section.content.append(showChatHistoryCheckboxField.label);\r\n      }\r\n\r\n      if(section.content.childElementCount) {\r\n        this.scrollable.append(section.container);\r\n      }\r\n    }\r\n\r\n    if(await this.managers.appChatsManager.hasRights(this.chatId, 'delete_chat')) {\r\n      const section = new SettingSection({});\r\n\r\n      const btnDelete = Button('btn-primary btn-transparent danger', {icon: 'delete', text: isBroadcast ? 'PeerInfo.DeleteChannel' : 'DeleteAndExitButton'});\r\n\r\n      attachClickEvent(btnDelete, () => {\r\n        new PopupDeleteDialog(peerId/* , 'delete' */, undefined, (promise) => {\r\n          const toggle = toggleDisability([btnDelete], true);\r\n          promise.then(() => {\r\n            this.close();\r\n          }, () => {\r\n            toggle();\r\n          });\r\n        });\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      section.content.append(btnDelete);\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    if(!isChannel) {\r\n      // ! this one will fire earlier than tab's closeAfterTimeout (destroy) event and listeners will be erased, so destroy won't fire\r\n      this.listenerSetter.add(rootScope)('dialog_migrate', ({migrateFrom, migrateTo}) => {\r\n        if(peerId === migrateFrom) {\r\n          this.chatId = migrateTo.toChatId();\r\n          this._init();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  protected init() {\r\n    return this._init();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { formatPhoneNumber } from \"../../helpers/formatPhoneNumber\";\r\n\r\nexport default function formatUserPhone(phone: string) {\r\n  return '+' + formatPhoneNumber(phone).formatted;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\"\r\nimport InputField from \"../../inputField\";\r\nimport EditPeer from \"../../editPeer\";\r\nimport { SettingSection } from \"../../sidebarLeft\";\r\nimport Row from \"../../row\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport Button from \"../../button\";\r\nimport PeerTitle from \"../../peerTitle\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport PopupPeer from \"../../popups/peer\";\r\nimport { addCancelButton } from \"../../popups\";\r\nimport { i18n } from \"../../../lib/langPack\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport getPeerId from \"../../../lib/appManagers/utils/peers/getPeerId\";\r\nimport formatUserPhone from \"../../wrappers/formatUserPhone\";\r\n\r\nexport default class AppEditContactTab extends SliderSuperTab {\r\n  private nameInputField: InputField;\r\n  private lastNameInputField: InputField;\r\n  private editPeer: EditPeer;\r\n  public peerId: PeerId;\r\n\r\n  protected async init() {\r\n    this.container.classList.add('edit-peer-container', 'edit-contact-container');\r\n    const isNew = !(await this.managers.appUsersManager.isContact(this.peerId.toUserId()));\r\n    this.setTitle(isNew ? 'AddContactTitle' : 'Edit');\r\n\r\n    {\r\n      const section = new SettingSection({noDelimiter: true});\r\n      const inputFields: InputField[] = [];\r\n\r\n      const inputWrapper = document.createElement('div');\r\n      inputWrapper.classList.add('input-wrapper');\r\n  \r\n      this.nameInputField = new InputField({\r\n        label: 'FirstName',\r\n        name: 'contact-name',\r\n        maxLength: 70,\r\n        required: true\r\n      });\r\n      this.lastNameInputField = new InputField({\r\n        label: 'LastName',\r\n        name: 'contact-lastname',\r\n        maxLength: 70\r\n      });\r\n\r\n      if(this.peerId) {\r\n        const user = await this.managers.appUsersManager.getUser(this.peerId);\r\n\r\n        if(isNew) {\r\n          this.nameInputField.setDraftValue(user.first_name);\r\n          this.lastNameInputField.setDraftValue(user.last_name);\r\n        } else {\r\n          this.nameInputField.setOriginalValue(user.first_name);\r\n          this.lastNameInputField.setOriginalValue(user.last_name);\r\n        }\r\n      }\r\n      \r\n      inputWrapper.append(this.nameInputField.container, this.lastNameInputField.container);\r\n      inputFields.push(this.nameInputField, this.lastNameInputField);\r\n\r\n      this.editPeer = new EditPeer({\r\n        peerId: this.peerId,\r\n        inputFields,\r\n        listenerSetter: this.listenerSetter,\r\n        doNotEditAvatar: true\r\n      });\r\n      this.content.append(this.editPeer.nextBtn);\r\n\r\n      if(this.peerId) {\r\n        const div = document.createElement('div');\r\n        div.classList.add('avatar-edit');\r\n        div.append(this.editPeer.avatarElem);\r\n  \r\n        const notificationsCheckboxField = new CheckboxField({\r\n          text: 'Notifications'\r\n        });\r\n  \r\n        notificationsCheckboxField.input.addEventListener('change', (e) => {\r\n          if(!e.isTrusted) {\r\n            return;\r\n          }\r\n  \r\n          this.managers.appMessagesManager.togglePeerMute(this.peerId);\r\n        });\r\n  \r\n        this.listenerSetter.add(rootScope)('notify_settings', async(update) => {\r\n          if(update.peer._ !== 'notifyPeer') return;\r\n          const peerId = getPeerId(update.peer.peer);\r\n          if(this.peerId === peerId) {\r\n            const enabled = !(await this.managers.appNotificationsManager.isMuted(update.notify_settings));\r\n            if(enabled !== notificationsCheckboxField.checked) {\r\n              notificationsCheckboxField.checked = enabled;\r\n            }\r\n          }\r\n        });\r\n  \r\n        const profileNameDiv = document.createElement('div');\r\n        profileNameDiv.classList.add('profile-name');\r\n        profileNameDiv.append(new PeerTitle({\r\n          peerId: this.peerId\r\n        }).element);\r\n        //profileNameDiv.innerHTML = 'Karen Stanford';\r\n  \r\n        const profileSubtitleDiv = document.createElement('div');\r\n        profileSubtitleDiv.classList.add('profile-subtitle');\r\n        profileSubtitleDiv.append(i18n('EditContact.OriginalName'));\r\n\r\n        section.content.append(div, profileNameDiv, profileSubtitleDiv, inputWrapper);\r\n\r\n        if(!isNew) {\r\n          const notificationsRow = new Row({\r\n            checkboxField: notificationsCheckboxField,\r\n            listenerSetter: this.listenerSetter\r\n          });\r\n    \r\n          const enabled = !(await this.managers.appNotificationsManager.isPeerLocalMuted(this.peerId, false));\r\n          notificationsCheckboxField.checked = enabled;\r\n\r\n          section.content.append(notificationsRow.container);\r\n        } else {\r\n          const user = await this.managers.appUsersManager.getUser(this.peerId);\r\n\r\n          const phoneRow = new Row({\r\n            icon: 'phone',\r\n            titleLangKey: user.phone ? undefined : 'MobileHidden',\r\n            title: user.phone ? formatUserPhone(user.phone)  : undefined,\r\n            subtitleLangKey: user.phone ? 'Phone' : 'MobileHiddenExceptionInfo',\r\n            subtitleLangArgs: user.phone ? undefined : [new PeerTitle({peerId: this.peerId}).element]\r\n          });\r\n\r\n          section.content.append(phoneRow.container);\r\n        }\r\n      } else {\r\n        section.content.append(inputWrapper);\r\n      }\r\n\r\n      this.scrollable.append(section.container);\r\n\r\n      attachClickEvent(this.editPeer.nextBtn, async() => {\r\n        this.editPeer.nextBtn.disabled = true;\r\n\r\n        this.managers.appUsersManager.addContact(\r\n          this.peerId, \r\n          this.nameInputField.value, \r\n          this.lastNameInputField.value, \r\n          (await this.managers.appUsersManager.getUser(this.peerId)).phone\r\n        ).finally(() => {\r\n          this.editPeer.nextBtn.removeAttribute('disabled');\r\n          this.close();\r\n        });\r\n      }, {listenerSetter: this.listenerSetter});\r\n    }\r\n\r\n    if(!isNew) {\r\n      const section = new SettingSection({\r\n        \r\n      });\r\n\r\n      const btnDelete = Button('btn-primary btn-transparent danger', {icon: 'delete', text: 'PeerInfo.DeleteContact'});\r\n\r\n      attachClickEvent(btnDelete, () => {\r\n        new PopupPeer('popup-delete-contact', {\r\n          peerId: this.peerId,\r\n          titleLangKey: 'DeleteContact',\r\n          descriptionLangKey: 'AreYouSureDeleteContact',\r\n          buttons: addCancelButton([{\r\n            langKey: 'Delete',\r\n            callback: () => {\r\n              const toggle = toggleDisability([btnDelete], true);\r\n\r\n              this.managers.appUsersManager.deleteContacts([this.peerId]).then(() => {\r\n                this.close();\r\n              }, () => {\r\n                toggle();\r\n              });\r\n            },\r\n            isDanger: true\r\n          }])\r\n        }).show();\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      section.content.append(btnDelete);\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport AppSelectPeers from \"../../appSelectPeers\";\r\nimport { setButtonLoader } from \"../../putPreloader\";\r\nimport { LangPackKey, _i18n } from \"../../../lib/langPack\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\n\r\nexport default class AppAddMembersTab extends SliderSuperTab {\r\n  private nextBtn: HTMLButtonElement;\r\n  private selector: AppSelectPeers;\r\n  private peerType: 'channel' | 'chat' | 'privacy';\r\n  private takeOut: (peerIds: PeerId[]) => Promise<any> | false | void;\r\n  private skippable: boolean;\r\n\r\n  protected init() {\r\n    this.container.classList.add('add-members-container');\r\n    this.nextBtn = ButtonCorner({icon: 'arrow_next'});\r\n    this.content.append(this.nextBtn);\r\n    this.scrollable.container.remove();\r\n    \r\n    this.nextBtn.addEventListener('click', () => {\r\n      const peerIds = this.selector.getSelected().map((sel) => sel.toPeerId());\r\n\r\n      if(this.skippable) {\r\n        this.takeOut(peerIds);\r\n        this.close();\r\n      } else {\r\n        const promise = this.takeOut(peerIds);\r\n\r\n        if(promise instanceof Promise) {\r\n          this.attachToPromise(promise);\r\n        } else if(promise === undefined) {\r\n          this.close();\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  public attachToPromise(promise: Promise<any>) {\r\n    const removeLoader = setButtonLoader(this.nextBtn, 'arrow_next');\r\n\r\n    promise.then(() => {\r\n      this.close();\r\n    }, () => {\r\n      removeLoader();\r\n    });\r\n  }\r\n\r\n  public open(options: {\r\n    title: LangPackKey,\r\n    placeholder: LangPackKey,\r\n    type: AppAddMembersTab['peerType'], \r\n    takeOut?: AppAddMembersTab['takeOut'],\r\n    skippable: boolean,\r\n    selectedPeerIds?: PeerId[]\r\n  }) {\r\n    const ret = super.open();\r\n\r\n    this.setTitle(options.title);\r\n    this.peerType = options.type;\r\n    this.takeOut = options.takeOut;\r\n    this.skippable = options.skippable;\r\n\r\n    const isPrivacy = this.peerType === 'privacy';\r\n    this.selector = new AppSelectPeers({\r\n      appendTo: this.content, \r\n      onChange: this.skippable ? null : (length) => {\r\n        this.nextBtn.classList.toggle('is-visible', !!length);\r\n      }, \r\n      peerType: [isPrivacy ? 'dialogs' : 'contacts'],\r\n      placeholder: options.placeholder,\r\n      exceptSelf: isPrivacy,\r\n      filterPeerTypeBy: isPrivacy ? ['isAnyGroup', 'isUser'] : undefined,\r\n      managers: this.managers\r\n    });\r\n\r\n    if(options.selectedPeerIds) {\r\n      this.selector.addInitial(options.selectedPeerIds);\r\n    }\r\n\r\n    this.nextBtn.classList.add('tgico-arrow_next');\r\n    this.nextBtn.innerHTML = '';\r\n    this.nextBtn.disabled = false;\r\n    this.nextBtn.classList.toggle('is-visible', this.skippable);\r\n\r\n    return ret;\r\n  }\r\n}","import { _i18n } from \"../lib/langPack\";\r\n\r\nexport default function generateFakeIcon(isScam?: boolean) {\r\n  const span = document.createElement('span');\r\n  span.classList.add('badge-fake');\r\n  _i18n(span, isScam ? 'ScamMessage' : 'FakeMessage');\r\n  return span;\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Chat, User } from \"../layer\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport generateFakeIcon from \"./generateFakeIcon\";\r\n// import generatePremiumIcon from \"./generatePremiumIcon\";\r\nimport generateVerifiedIcon from \"./generateVerifiedIcon\";\r\n\r\nexport default async function generateTitleIcons(peerId: PeerId) {\r\n  const elements: Element[] = [];\r\n  const peer: Chat | User = await rootScope.managers.appPeersManager.getPeer(peerId);\r\n  if((peer as Chat.channel)?.pFlags?.verified) {\r\n    elements.push(generateVerifiedIcon());\r\n  }\r\n\r\n  if((peer as Chat.channel).pFlags.fake || (peer as User.user).pFlags.scam) {\r\n    elements.push(generateFakeIcon((peer as User.user).pFlags.scam));\r\n  }\r\n\r\n  // if((peer as User.user).pFlags.premium) {\r\n  //   elements.push(generatePremiumIcon());\r\n  // }\r\n\r\n  return elements;\r\n}\r\n","export default function generateVerifiedIcon() {\r\n  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\r\n  svg.setAttributeNS(null, 'viewBox', '0 0 24 24');\r\n  svg.setAttributeNS(null, 'width', '24');\r\n  svg.setAttributeNS(null, 'height', '24');\r\n  svg.classList.add('verified-icon');\r\n\r\n  const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');\r\n  use.setAttributeNS(null, 'href', '#verified-background');\r\n  use.classList.add('verified-background');\r\n\r\n  const use2 = document.createElementNS('http://www.w3.org/2000/svg', 'use');\r\n  use2.setAttributeNS(null, 'href', '#verified-check');\r\n  use2.classList.add('verified-check');\r\n\r\n  svg.append(use, use2);\r\n\r\n  return svg;\r\n}\r\n","// https://github.com/eelcohn/Telegram-API/wiki/Calculating-color-for-a-Telegram-user-on-IRC\r\n/*\r\n  HTML-color  IRC-color  Description\r\n  #c03d33     4          red\r\n  #4fad2d     3          green\r\n  #d09306     7          yellow\r\n  #168acd     10         blue\r\n  #8544d6     6          purple\r\n  #cd4073     13         pink\r\n  #2996ad     11         sea\r\n  #ce671b     5          orange\r\n*/\r\nconst DialogColorsFg = ['#fc5c51', '#0fb297', '#d09306', '#3d72ed', '#895dd5', '#cd4073', '#00c1a6', '#fa790f'];\r\nconst DialogColors = ['red', 'green', 'yellow', 'blue', 'violet', 'pink', 'cyan', 'orange'];\r\nconst DialogColorsMap = [0, 7, 4, 1, 6, 3, 5];\r\n\r\nexport default function getPeerColorById(peerId: PeerId, pic = true) {\r\n  if(!peerId) return '';\r\n\r\n  const idx = DialogColorsMap[Math.abs(+peerId) % 7];\r\n  const color = (pic ? DialogColors : DialogColorsFg)[idx];\r\n  return color;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport wrapEmojiText from \"./wrapEmojiText\";\r\n\r\nexport default function getAbbreviation(str: string, onlyFirst = false) {\r\n  if(!str) return '';\r\n  const splitted = str.trim().split(' ');\r\n  if(!splitted[0]) return '';\r\n\r\n  const first = [...splitted[0]][0];\r\n\r\n  if(onlyFirst || splitted.length === 1) return wrapEmojiText(first);\r\n\r\n  const last = [...splitted[splitted.length - 1]][0];\r\n\r\n  return wrapEmojiText(first + last);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getPreviewURLFromBytes from \"../helpers/bytes/getPreviewURLFromBytes\";\r\nimport { renderImageFromUrlPromise } from \"../helpers/dom/renderImageFromUrl\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport { recordPromise } from \"../helpers/recordPromise\";\r\nimport sequentialDom from \"../helpers/sequentialDom\";\r\nimport { UserProfilePhoto, ChatPhoto } from \"../layer\";\r\nimport type { PeerPhotoSize } from \"../lib/appManagers/appAvatarsManager\";\r\nimport getPeerColorById from \"../lib/appManagers/utils/peers/getPeerColorById\";\r\nimport { NULL_PEER_ID, REPLIES_PEER_ID } from \"../lib/mtproto/mtproto_config\";\r\nimport getAbbreviation from \"../lib/richTextProcessor/getAbbreviation\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport getPeerInitials from \"./wrappers/getPeerInitials\";\r\n\r\nexport async function putAvatar(\r\n  div: HTMLElement, \r\n  peerId: PeerId, \r\n  photo: UserProfilePhoto.userProfilePhoto | ChatPhoto.chatPhoto, \r\n  size: PeerPhotoSize, \r\n  img = new Image(), \r\n  onlyThumb = false\r\n) {\r\n  const r = await rootScope.managers.acknowledged.appAvatarsManager.loadAvatar(peerId, photo, size);\r\n  const loadPromise = r.result;\r\n  const cached = r.cached;\r\n\r\n  img.classList.add('avatar-photo');\r\n\r\n  let renderThumbPromise: Promise<void>;\r\n  let callback: () => void;\r\n  let thumbImage: HTMLImageElement;\r\n  if(cached) {\r\n    //   misc.ts: renderImageFromUrl\r\n    callback = () => {\r\n      replaceContent(div, img);\r\n      div.dataset.color = '';\r\n    };\r\n  } else {\r\n    const animate = rootScope.settings.animationsEnabled;\r\n    if(animate) {\r\n      img.classList.add('fade-in');\r\n    }\r\n\r\n    let isFullLoaded = false;\r\n    if(size === 'photo_big') { // let's load small photo first\r\n      const res = await putAvatar(div, peerId, photo, 'photo_small');\r\n      renderThumbPromise = res.loadPromise;\r\n      thumbImage = res.thumbImage;\r\n    } else if(photo.stripped_thumb) {\r\n      thumbImage = new Image();\r\n      div.classList.add('avatar-relative');\r\n      thumbImage.classList.add('avatar-photo', 'avatar-photo-thumbnail');\r\n      const url = getPreviewURLFromBytes(photo.stripped_thumb);\r\n      renderThumbPromise = renderImageFromUrlPromise(thumbImage, url).then(() => {\r\n        if(isFullLoaded) {\r\n          return;\r\n        }\r\n\r\n        replaceContent(div, thumbImage);\r\n      });\r\n    }\r\n\r\n    callback = () => {\r\n      isFullLoaded = true;\r\n\r\n      if(thumbImage) {\r\n        div.append(img);\r\n      } else {\r\n        replaceContent(div, img);\r\n      }\r\n\r\n      setTimeout(() => {\r\n        if(div.childElementCount) {\r\n          sequentialDom.mutateElement(img, () => {\r\n            div.dataset.color = '';\r\n            \r\n            if(animate) {\r\n              img.classList.remove('fade-in');\r\n            }\r\n\r\n            if(thumbImage) {\r\n              thumbImage.remove();\r\n            }\r\n          });\r\n        }\r\n      }, animate ? 200 : 0);\r\n    };\r\n  }\r\n\r\n  const renderPromise = loadPromise\r\n  .then((url) => renderImageFromUrlPromise(img, url/* , !cached */))\r\n  .then(callback);\r\n\r\n  await (renderThumbPromise || renderPromise);\r\n\r\n  return {\r\n    cached, \r\n    loadPromise: renderThumbPromise || renderPromise,\r\n    thumbImage\r\n  };\r\n}\r\n\r\nfunction set(\r\n  div: HTMLElement, \r\n  innerHTML: Parameters<typeof setInnerHTML>[1], \r\n  color: string, \r\n  icon: string\r\n) {\r\n  setInnerHTML(div, innerHTML);\r\n  div.dataset.color = color;\r\n  div.classList.remove('tgico-saved', 'tgico-deletedaccount', 'tgico-reply_filled');\r\n  icon && div.classList.add(icon);\r\n}\r\n\r\n// peerId === peerId || title\r\nexport default async function putPhoto(\r\n  div: HTMLElement, \r\n  peerId: PeerId, \r\n  isDialog = false, \r\n  title = '', \r\n  onlyThumb = false, \r\n  isBig?: boolean\r\n) {\r\n  const myId = rootScope.myId;\r\n  \r\n  if(peerId === myId && isDialog) {\r\n    set(div, '', '', 'tgico-saved');\r\n    return;\r\n  }\r\n\r\n  const managers = rootScope.managers;\r\n  \r\n  if(peerId !== NULL_PEER_ID && peerId.isUser()) {\r\n    const user = await managers.appUsersManager.getUser(peerId);\r\n    if(user && user.pFlags && user.pFlags.deleted) {\r\n      set(div, '', getPeerColorById(peerId), 'tgico-deletedaccount');\r\n      return;\r\n    }\r\n  }\r\n  \r\n  const size: PeerPhotoSize = isBig ? 'photo_big' : 'photo_small';\r\n  const photo = await managers.appPeersManager.getPeerPhoto(peerId);\r\n  const avatarAvailable = !!photo;\r\n  const avatarRendered = !!div.firstElementChild && !(div.firstElementChild as HTMLElement).classList.contains('emoji');\r\n  if(!avatarAvailable || !avatarRendered || !(await managers.appAvatarsManager.isAvatarCached(peerId, size))) {\r\n    let color = '';\r\n    if(peerId && (peerId !== myId || !isDialog)) {\r\n      color = getPeerColorById(peerId);\r\n    }\r\n\r\n    if(peerId === REPLIES_PEER_ID) {\r\n      set(div, '', color, 'tgico-reply_filled');\r\n      return;\r\n    }\r\n\r\n    const abbr = await (title ? getAbbreviation(title) : getPeerInitials(peerId, managers));\r\n    set(div, abbr, color, '');\r\n    //return Promise.resolve(true);\r\n  }\r\n\r\n  if(avatarAvailable/*  && false */) {\r\n    const promise = putAvatar(div, peerId, photo, size, undefined, onlyThumb);\r\n    // recordPromise(promise, 'putAvatar-' + peerId);\r\n    return promise;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Chat, User } from \"../../layer\";\r\nimport getAbbreviation from \"../../lib/richTextProcessor/getAbbreviation\";\r\nimport rootScope from \"../../lib/rootScope\";\r\n\r\nexport default async function getPeerInitials(peerId: PeerId, managers = rootScope.managers) {\r\n  const peer: Chat | User = await managers.appPeersManager.getPeer(peerId);\r\n  return getAbbreviation(\r\n    (peer as Chat.chat).title ?? [(peer as User.user).first_name, (peer as User.user).last_name].filter(Boolean).join(' ')\r\n  );\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appNavigationController from \"../components/appNavigationController\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport { IS_MOBILE_SAFARI } from \"../environment/userAgent\";\r\nimport cancelEvent from \"./dom/cancelEvent\";\r\nimport { CLICK_EVENT_NAME } from \"./dom/clickEvent\";\r\nimport EventListenerBase from \"./eventListenerBase\";\r\nimport mediaSizes from \"./mediaSizes\";\r\n\r\nclass ContextMenuController extends EventListenerBase<{\r\n  toggle: (open: boolean) => void\r\n}> {\r\n  private openedMenu: HTMLElement;\r\n  private menuOverlay: HTMLElement;\r\n  private openedMenuOnClose: () => void;\r\n\r\n  constructor() {\r\n    super();\r\n    \r\n    mediaSizes.addEventListener('resize', () => {\r\n      if(this.openedMenu) {\r\n        this.closeBtnMenu();\r\n      }\r\n      \r\n      /* if(openedMenu && (openedMenu.style.top || openedMenu.style.left)) {\r\n        const rect = openedMenu.getBoundingClientRect();\r\n        const {innerWidth, innerHeight} = window;\r\n    \r\n        console.log(innerWidth, innerHeight, rect);\r\n      } */\r\n    })\r\n  }\r\n\r\n  public isOpened() {\r\n    return !!this.openedMenu;\r\n  }\r\n\r\n  private onMouseMove = (e: MouseEvent) => {\r\n    let rect = this.openedMenu.getBoundingClientRect();\r\n    let {clientX, clientY} = e;\r\n\r\n    let diffX = clientX >= rect.right ? clientX - rect.right : rect.left - clientX;\r\n    let diffY = clientY >= rect.bottom ? clientY - rect.bottom : rect.top - clientY;\r\n\r\n    if(diffX >= 100 || diffY >= 100) {\r\n      this.closeBtnMenu();\r\n      //openedMenu.parentElement.click();\r\n    }\r\n    //console.log('mousemove', diffX, diffY);\r\n  };\r\n\r\n  private onClick = (e: MouseEvent | TouchEvent) => {\r\n    //cancelEvent(e);\r\n    this.closeBtnMenu();\r\n  };\r\n\r\n  // ! no need in this due to the same handler in appNavigationController\r\n  /* const onKeyDown = (e: KeyboardEvent) => {\r\n    if(e.key === 'Escape') {\r\n      closeBtnMenu();\r\n      cancelEvent(e);\r\n    }\r\n  }; */\r\n\r\n  public closeBtnMenu = () => {\r\n    if(this.openedMenu) {\r\n      this.openedMenu.classList.remove('active');\r\n      this.openedMenu.parentElement.classList.remove('menu-open');\r\n      //openedMenu.previousElementSibling.remove(); // remove overlay\r\n      if(this.menuOverlay) this.menuOverlay.remove();\r\n      this.openedMenu = undefined;\r\n  \r\n      this.dispatchEvent('toggle', false);\r\n    }\r\n    \r\n    if(this.openedMenuOnClose) {\r\n      this.openedMenuOnClose();\r\n      this.openedMenuOnClose = undefined;\r\n    }\r\n  \r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      window.removeEventListener('mousemove', this.onMouseMove);\r\n      //window.removeEventListener('keydown', onKeyDown, {capture: true});\r\n      window.removeEventListener('contextmenu', this.onClick);\r\n    }\r\n  \r\n    document.removeEventListener(CLICK_EVENT_NAME, this.onClick);\r\n  \r\n    if(!IS_MOBILE_SAFARI) {\r\n      appNavigationController.removeByType('menu');\r\n    }\r\n  };\r\n\r\n  public openBtnMenu(menuElement: HTMLElement, onClose?: () => void) {\r\n    this.closeBtnMenu();\r\n  \r\n    if(!IS_MOBILE_SAFARI) {\r\n      appNavigationController.pushItem({\r\n        type: 'menu',\r\n        onPop: (canAnimate) => {\r\n          this.closeBtnMenu();\r\n        }\r\n      });\r\n    }\r\n    \r\n    this.openedMenu = menuElement;\r\n    this.openedMenu.classList.add('active');\r\n    this.openedMenu.parentElement.classList.add('menu-open');\r\n  \r\n    if(!this.menuOverlay) {\r\n      this.menuOverlay = document.createElement('div');\r\n      this.menuOverlay.classList.add('btn-menu-overlay');\r\n  \r\n      // ! because this event must be canceled, and can't cancel on menu click (below)\r\n      this.menuOverlay.addEventListener(CLICK_EVENT_NAME, (e) => {\r\n        cancelEvent(e);\r\n        this.onClick(e);\r\n      });\r\n    }\r\n  \r\n    this.openedMenu.parentElement.insertBefore(this.menuOverlay, this.openedMenu);\r\n  \r\n    //document.body.classList.add('disable-hover');\r\n    \r\n    this.openedMenuOnClose = onClose;\r\n  \r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      window.addEventListener('mousemove', this.onMouseMove);\r\n      //window.addEventListener('keydown', onKeyDown, {capture: true});\r\n      window.addEventListener('contextmenu', this.onClick, {once: true});\r\n    }\r\n  \r\n    /* // ! because this event must be canceled, and can't cancel on menu click (below)\r\n    overlay.addEventListener(CLICK_EVENT_NAME, (e) => {\r\n      cancelEvent(e);\r\n      onClick(e);\r\n    }); */\r\n    \r\n    // ! safari iOS doesn't handle window click event on overlay, idk why\r\n    document.addEventListener(CLICK_EVENT_NAME, this.onClick);\r\n  \r\n    this.dispatchEvent('toggle', true);\r\n  }\r\n}\r\n\r\nconst contextMenuController = new ContextMenuController();\r\nexport default contextMenuController;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport contextMenuController from \"../helpers/contextMenuController\";\r\n\r\nconst getEvent = (e: TouchEvent | MouseEvent) => {\r\n  return (e as TouchEvent).touches ? (e as TouchEvent).touches[0] : e as MouseEvent;\r\n};\r\n\r\nconst attachGlobalListenerTo = window;\r\n\r\nlet RESET_GLOBAL = false;\r\ncontextMenuController.addEventListener('toggle', (visible) => {\r\n  RESET_GLOBAL = visible;\r\n});\r\n\r\nexport type SwipeHandlerOptions = {\r\n  element: SwipeHandler['element'],\r\n  onSwipe: SwipeHandler['onSwipe'],\r\n  verifyTouchTarget?: SwipeHandler['verifyTouchTarget'],\r\n  onFirstSwipe?: SwipeHandler['onFirstSwipe'],\r\n  onReset?: SwipeHandler['onReset'],\r\n  cursor?: SwipeHandler['cursor'],\r\n  cancelEvent?: SwipeHandler['cancelEvent'],\r\n  listenerOptions?: SwipeHandler['listenerOptions']\r\n};\r\n\r\nexport default class SwipeHandler {\r\n  private element: HTMLElement;\r\n  private onSwipe: (xDiff: number, yDiff: number, e: TouchEvent | MouseEvent) => boolean | void;\r\n  private verifyTouchTarget: (evt: TouchEvent | MouseEvent) => boolean | Promise<boolean>;\r\n  private onFirstSwipe: () => void;\r\n  private onReset: () => void;\r\n  private cursor: 'grabbing' | 'move' | 'row-resize' | 'col-resize' | 'nesw-resize' | 'nwse-resize' | 'ne-resize' | 'se-resize' | 'sw-resize' | 'nw-resize' | 'n-resize' | 'e-resize' | 's-resize' | 'w-resize' | '' = 'grabbing';\r\n  private cancelEvent = true;\r\n  private listenerOptions: boolean | AddEventListenerOptions = false;\r\n  private setCursorTo: HTMLElement;\r\n\r\n  private hadMove = false;\r\n  private xDown: number = null;\r\n  private yDown: number = null;\r\n\r\n  constructor(options: SwipeHandlerOptions) {\r\n    safeAssign(this, options);\r\n    \r\n    this.setCursorTo = this.element;\r\n\r\n    this.setListeners();\r\n  }\r\n\r\n  public setListeners() {\r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      this.element.addEventListener('mousedown', this.handleStart, this.listenerOptions);\r\n      attachGlobalListenerTo.addEventListener('mouseup', this.reset);\r\n    } else {\r\n      this.element.addEventListener('touchstart', this.handleStart, this.listenerOptions);\r\n      attachGlobalListenerTo.addEventListener('touchend', this.reset);\r\n    }\r\n  }\r\n\r\n  public removeListeners() {\r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      this.element.removeEventListener('mousedown', this.handleStart, this.listenerOptions);\r\n      attachGlobalListenerTo.removeEventListener('mouseup', this.reset);\r\n    } else {\r\n      this.element.removeEventListener('touchstart', this.handleStart, this.listenerOptions);\r\n      attachGlobalListenerTo.removeEventListener('touchend', this.reset);\r\n    }\r\n  }\r\n\r\n  public setCursor(cursor: SwipeHandler['cursor']) {\r\n    this.cursor = cursor;\r\n    \r\n    if(!IS_TOUCH_SUPPORTED && this.hadMove) {\r\n      this.setCursorTo.style.setProperty('cursor', this.cursor, 'important');\r\n    }\r\n  }\r\n\r\n  reset = (e?: Event) => {\r\n    /* if(e) {\r\n      cancelEvent(e);\r\n    } */\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      attachGlobalListenerTo.removeEventListener('touchmove', this.handleMove, {capture: true});\r\n    } else {\r\n      attachGlobalListenerTo.removeEventListener('mousemove', this.handleMove);\r\n      this.setCursorTo.style.cursor = '';\r\n    }\r\n\r\n    if(this.onReset && this.hadMove) {\r\n      this.onReset();\r\n    }\r\n\r\n    this.xDown = this.yDown = null;\r\n    this.hadMove = false;\r\n  };\r\n\r\n  handleStart = async(_e: TouchEvent | MouseEvent) => {\r\n    const e = getEvent(_e);\r\n    if(this.verifyTouchTarget && !(await this.verifyTouchTarget(_e))) {\r\n      return this.reset();\r\n    }\r\n\r\n    this.xDown = e.clientX;\r\n    this.yDown = e.clientY;\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      attachGlobalListenerTo.addEventListener('touchmove', this.handleMove, {passive: false, capture: true});\r\n    } else {\r\n      attachGlobalListenerTo.addEventListener('mousemove', this.handleMove, false);\r\n    }\r\n  };\r\n\r\n  handleMove = (_e: TouchEvent | MouseEvent) => {\r\n    if(this.xDown === null || this.yDown === null || RESET_GLOBAL) {\r\n      this.reset();\r\n      return;\r\n    }\r\n\r\n    if(this.cancelEvent) {\r\n      cancelEvent(_e);\r\n    }\r\n\r\n    const e = getEvent(_e);\r\n    const xUp = e.clientX;\r\n    const yUp = e.clientY;\r\n\r\n    const xDiff = this.xDown - xUp;\r\n    const yDiff = this.yDown - yUp;\r\n\r\n    if(!this.hadMove) {\r\n      if(!xDiff && !yDiff) {\r\n        return;\r\n      }\r\n\r\n      this.hadMove = true;\r\n\r\n      if(!IS_TOUCH_SUPPORTED) {\r\n        this.setCursorTo.style.setProperty('cursor', this.cursor, 'important');\r\n      }\r\n\r\n      if(this.onFirstSwipe) {\r\n        this.onFirstSwipe();\r\n      }\r\n    }\r\n\r\n    // if(Math.abs(xDiff) > Math.abs(yDiff)) { /*most significant*/\r\n    //   if(xDiff > 0) { /* left swipe */ \r\n\r\n    //   } else { /* right swipe */\r\n\r\n    //   }                       \r\n    // } else {\r\n    //   if(yDiff > 0) { /* up swipe */ \r\n        \r\n    //   } else { /* down swipe */\r\n        \r\n    //   }\r\n    // }\r\n\r\n    /* reset values */\r\n    const onSwipeResult = this.onSwipe(xDiff, yDiff, _e);\r\n    if(onSwipeResult !== undefined && onSwipeResult) {\r\n      this.reset();\r\n    }\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_PARALLAX_SUPPORTED from \"../environment/parallaxSupport\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport findAndSplice from \"../helpers/array/findAndSplice\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport filterChatPhotosMessages from \"../helpers/filterChatPhotosMessages\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport ListLoader from \"../helpers/listLoader\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\nimport { Message, ChatFull, MessageAction, Photo } from \"../layer\";\r\nimport type { AppMessagesManager } from \"../lib/appManagers/appMessagesManager\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport choosePhotoSize from \"../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport { openAvatarViewer } from \"./avatar\";\r\nimport { putAvatar } from \"./putPhoto\";\r\nimport Scrollable from \"./scrollable\";\r\nimport SwipeHandler from \"./swipeHandler\";\r\nimport { wrapPhoto } from \"./wrappers\";\r\n\r\nconst LOAD_NEAREST = 3;\r\n\r\nexport default class PeerProfileAvatars {\r\n  private static BASE_CLASS = 'profile-avatars';\r\n  private static SCALE = IS_PARALLAX_SUPPORTED ? 2 : 1;\r\n  private static TRANSLATE_TEMPLATE = IS_PARALLAX_SUPPORTED ? `translate3d({x}, 0, -1px) scale(${PeerProfileAvatars.SCALE})` : 'translate({x}, 0)';\r\n  public container: HTMLElement;\r\n  public avatars: HTMLElement;\r\n  public gradient: HTMLElement;\r\n  public info: HTMLElement;\r\n  public arrowPrevious: HTMLElement;\r\n  public arrowNext: HTMLElement;\r\n  private tabs: HTMLDivElement;\r\n  private listLoader: ListLoader<Photo.photo['id'] | Message.messageService, Photo.photo['id'] | Message.messageService>;\r\n  private peerId: PeerId;\r\n  private intersectionObserver: IntersectionObserver;\r\n  private loadCallbacks: Map<Element, () => void>;\r\n  private listenerSetter: ListenerSetter;\r\n  private swipeHandler: SwipeHandler;\r\n\r\n  constructor(\r\n    public scrollable: Scrollable,\r\n    private managers: AppManagers\r\n  ) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add(PeerProfileAvatars.BASE_CLASS + '-container');\r\n\r\n    this.avatars = document.createElement('div');\r\n    this.avatars.classList.add(PeerProfileAvatars.BASE_CLASS + '-avatars');\r\n\r\n    this.gradient = document.createElement('div');\r\n    this.gradient.classList.add(PeerProfileAvatars.BASE_CLASS + '-gradient');\r\n\r\n    this.info = document.createElement('div');\r\n    this.info.classList.add(PeerProfileAvatars.BASE_CLASS + '-info');\r\n\r\n    this.tabs = document.createElement('div');\r\n    this.tabs.classList.add(PeerProfileAvatars.BASE_CLASS + '-tabs');\r\n\r\n    this.arrowPrevious = document.createElement('div');\r\n    this.arrowPrevious.classList.add(PeerProfileAvatars.BASE_CLASS + '-arrow', 'tgico-avatarprevious');\r\n\r\n    /* const previousIcon = document.createElement('i');\r\n    previousIcon.classList.add(PeerProfileAvatars.BASE_CLASS + '-arrow-icon', 'tgico-previous');\r\n    this.arrowBack.append(previousIcon); */\r\n    \r\n    this.arrowNext = document.createElement('div');\r\n    this.arrowNext.classList.add(PeerProfileAvatars.BASE_CLASS + '-arrow', PeerProfileAvatars.BASE_CLASS + '-arrow-next', 'tgico-avatarnext');\r\n\r\n    /* const nextIcon = document.createElement('i');\r\n    nextIcon.classList.add(PeerProfileAvatars.BASE_CLASS + '-arrow-icon', 'tgico-next');\r\n    this.arrowNext.append(nextIcon); */\r\n\r\n    this.container.append(this.avatars, this.gradient, this.info, this.tabs, this.arrowPrevious, this.arrowNext);\r\n\r\n    this.loadCallbacks = new Map();\r\n    this.listenerSetter = new ListenerSetter();\r\n\r\n    const checkScrollTop = () => {\r\n      if(this.scrollable.scrollTop !== 0) {\r\n        this.scrollable.scrollIntoViewNew({\r\n          element: this.scrollable.container.firstElementChild as HTMLElement, \r\n          position: 'start'\r\n        });\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    };\r\n\r\n    const SWITCH_ZONE = 1 / 3;\r\n    let cancel = false;\r\n    let freeze = false;\r\n    attachClickEvent(this.container, async(_e) => {\r\n      if(freeze) {\r\n        cancelEvent(_e);\r\n        return;\r\n      }\r\n\r\n      if(cancel) {\r\n        cancel = false;\r\n        return;\r\n      }\r\n\r\n      if(!checkScrollTop()) {\r\n        return;\r\n      }\r\n\r\n      const rect = this.container.getBoundingClientRect();\r\n\r\n      // const e = (_e as TouchEvent).touches ? (_e as TouchEvent).touches[0] : _e as MouseEvent;\r\n      const e = _e;\r\n      const x = e.pageX;\r\n\r\n      const clickX = x - rect.left;\r\n      if((!this.listLoader.previous.length && !this.listLoader.next.length) \r\n        || (clickX > (rect.width * SWITCH_ZONE) && clickX < (rect.width - rect.width * SWITCH_ZONE))) {\r\n        const peerId = this.peerId;\r\n\r\n        const targets: {element: HTMLElement, item: Photo.photo['id'] | Message.messageService}[] = [];\r\n        this.listLoader.previous.concat(this.listLoader.current, this.listLoader.next).forEach((item, idx) => {\r\n          targets.push({\r\n            element: /* null */this.avatars.children[idx] as HTMLElement,\r\n            item\r\n          });\r\n        });\r\n\r\n        const prevTargets = targets.slice(0, this.listLoader.previous.length);\r\n        const nextTargets = targets.slice(this.listLoader.previous.length + 1);\r\n\r\n        const target = this.avatars.children[this.listLoader.previous.length] as HTMLElement;\r\n        freeze = true;\r\n        openAvatarViewer(target, peerId, () => peerId === this.peerId, this.listLoader.current, prevTargets, nextTargets);\r\n        freeze = false;\r\n      } else {\r\n        const centerX = rect.right - (rect.width / 2);\r\n        const toRight = x > centerX;\r\n  \r\n        // this.avatars.classList.remove('no-transition');\r\n        // fastRaf(() => {\r\n          this.avatars.classList.add('no-transition');\r\n          void this.avatars.offsetLeft; // reflow\r\n\r\n          let distance: number;\r\n          if(this.listLoader.index === 0 && !toRight) distance = this.listLoader.count - 1;\r\n          else if(this.listLoader.index === (this.listLoader.count - 1) && toRight) distance = -(this.listLoader.count - 1);\r\n          else distance = toRight ? 1 : -1;\r\n          this.listLoader.go(distance);\r\n\r\n          fastRaf(() => {\r\n            this.avatars.classList.remove('no-transition');\r\n          });\r\n        // });\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const cancelNextClick = () => {\r\n      cancel = true;\r\n      document.body.addEventListener(IS_TOUCH_SUPPORTED ? 'touchend' : 'click', (e) => {\r\n        cancel = false;\r\n      }, {once: true});\r\n    };\r\n\r\n    let width = 0, x = 0, lastDiffX = 0, lastIndex = 0, minX = 0;\r\n    const swipeHandler = this.swipeHandler = new SwipeHandler({\r\n      element: this.avatars, \r\n      onSwipe: (xDiff, yDiff) => {\r\n        lastDiffX = xDiff;\r\n        let lastX = x + xDiff * -PeerProfileAvatars.SCALE;\r\n        if(lastX > 0) lastX = 0;\r\n        else if(lastX < minX) lastX = minX;\r\n\r\n        this.avatars.style.transform = PeerProfileAvatars.TRANSLATE_TEMPLATE.replace('{x}', lastX + 'px');\r\n        //console.log(xDiff, yDiff);\r\n        return false;\r\n      }, \r\n      verifyTouchTarget: (e) => {\r\n        if(!checkScrollTop()) {\r\n          cancelNextClick();\r\n          cancelEvent(e);\r\n          return false;\r\n        } else if(this.container.classList.contains('is-single') || freeze) {\r\n          return false;\r\n        }\r\n\r\n        return true;\r\n      }, \r\n      onFirstSwipe: () => {\r\n        const rect = this.avatars.getBoundingClientRect();\r\n        width = rect.width;\r\n        minX = -width * (this.tabs.childElementCount - 1);\r\n\r\n        /* lastIndex = whichChild(this.tabs.querySelector('.active'));\r\n        x = -width * lastIndex; */\r\n        x = rect.left - this.container.getBoundingClientRect().left;\r\n        \r\n        this.avatars.style.transform = PeerProfileAvatars.TRANSLATE_TEMPLATE.replace('{x}', x + 'px');\r\n\r\n        this.container.classList.add('is-swiping');\r\n        this.avatars.classList.add('no-transition');\r\n        void this.avatars.offsetLeft; // reflow\r\n      },\r\n      onReset: () => {\r\n        const addIndex = Math.ceil(Math.abs(lastDiffX) / (width / PeerProfileAvatars.SCALE)) * (lastDiffX >= 0 ? 1 : -1);\r\n        cancelNextClick();\r\n        \r\n        //console.log(addIndex);\r\n\r\n        this.avatars.classList.remove('no-transition');\r\n        fastRaf(() => {\r\n          this.listLoader.go(addIndex);\r\n          this.container.classList.remove('is-swiping');\r\n        });\r\n      }\r\n    });\r\n\r\n    this.intersectionObserver = new IntersectionObserver((entries) => {\r\n      entries.forEach((entry) => {\r\n        if(!entry.isIntersecting) {\r\n          return;\r\n        }\r\n\r\n        this.loadNearestToTarget(entry.target);\r\n      });\r\n    });\r\n\r\n    /* this.listenerSetter.add(rootScope)('avatar_update', (peerId) => {\r\n      if(this.peerId === peerId) {\r\n        const photo = appPeersManager.getPeerPhoto(peerId);\r\n        if(photo) {\r\n          const id = photo.photo_id;\r\n          const previous = this.listLoader.previous;\r\n          for(let i = 0; i < previous.length; ++i) {\r\n            if(previous[i] === id)\r\n          }\r\n          this.listLoader.previous.forEach((_id, idx, arr) => {});\r\n        }\r\n      }\r\n    }); */\r\n  }\r\n\r\n  public async setPeer(peerId: PeerId) {\r\n    this.peerId = peerId;\r\n\r\n    const photo = await this.managers.appPeersManager.getPeerPhoto(peerId);\r\n    if(!photo) {\r\n      return;\r\n    }\r\n\r\n    const listLoader: PeerProfileAvatars['listLoader'] = this.listLoader = new ListLoader({\r\n      loadCount: 50,\r\n      loadMore: (anchor, older, loadCount) => {\r\n        if(!older) return Promise.resolve({count: undefined, items: []});\r\n\r\n        if(peerId.isUser()) {\r\n          const maxId: Photo.photo['id'] = anchor as any;\r\n          return this.managers.appPhotosManager.getUserPhotos(peerId, maxId, loadCount).then((value) => {\r\n            return {\r\n              count: value.count,\r\n              items: value.photos\r\n            };\r\n          });\r\n        } else {\r\n          const promises: [Promise<ChatFull> | ChatFull, ReturnType<AppMessagesManager['getSearch']>] = [] as any;\r\n          if(!listLoader.current) {\r\n            promises.push(this.managers.appProfileManager.getChatFull(peerId.toChatId()));\r\n          }\r\n          \r\n          promises.push(this.managers.appMessagesManager.getSearch({\r\n            peerId,\r\n            maxId: Number.MAX_SAFE_INTEGER,\r\n            inputFilter: {\r\n              _: 'inputMessagesFilterChatPhotos'\r\n            },\r\n            limit: loadCount,\r\n            backLimit: 0\r\n          }));\r\n\r\n          return Promise.all(promises).then(async(result) => {\r\n            const value = result.pop() as typeof result[1];\r\n\r\n            filterChatPhotosMessages(value);\r\n\r\n            if(!listLoader.current) {\r\n              const chatFull = result[0];\r\n              const message = findAndSplice(value.history, (message) => {\r\n                return ((message as Message.messageService).action as MessageAction.messageActionChannelEditPhoto).photo.id === chatFull.chat_photo.id;\r\n              }) as Message.messageService;\r\n              \r\n              listLoader.current = message || await this.managers.appMessagesManager.generateFakeAvatarMessage(this.peerId, chatFull.chat_photo);\r\n            }\r\n\r\n            //console.log('avatars loaded:', value);\r\n            return {\r\n              count: value.count,\r\n              items: value.history\r\n            };\r\n          });\r\n        }\r\n      },\r\n      processItem: this.processItem,\r\n      onJump: (item, older) => {\r\n        const id = this.listLoader.index;\r\n        //const nextId = Math.max(0, id);\r\n        const x = 100 * PeerProfileAvatars.SCALE * id;\r\n        this.avatars.style.transform = PeerProfileAvatars.TRANSLATE_TEMPLATE.replace('{x}', `-${x}%`);\r\n\r\n        const activeTab = this.tabs.querySelector('.active');\r\n        if(activeTab) activeTab.classList.remove('active');\r\n\r\n        const tab = this.tabs.children[id] as HTMLElement;\r\n        tab.classList.add('active');\r\n\r\n        this.loadNearestToTarget(this.avatars.children[id]);\r\n      }\r\n    });\r\n\r\n    if(photo._ === 'userProfilePhoto') {\r\n      listLoader.current = photo.photo_id;\r\n    }\r\n\r\n    await this.processItem(listLoader.current);\r\n\r\n    // listLoader.loaded\r\n    listLoader.load(true);\r\n  }\r\n\r\n  public addTab() {\r\n    const tab = document.createElement('div');\r\n    tab.classList.add(PeerProfileAvatars.BASE_CLASS + '-tab');\r\n    this.tabs.append(tab);\r\n\r\n    if(this.tabs.childElementCount === 1) {\r\n      tab.classList.add('active');\r\n    }\r\n\r\n    this.container.classList.toggle('is-single', this.tabs.childElementCount <= 1);\r\n  }\r\n\r\n  public processItem = async(photoId: Photo.photo['id'] | Message.messageService) => {\r\n    const avatar = document.createElement('div');\r\n    avatar.classList.add(PeerProfileAvatars.BASE_CLASS + '-avatar', 'media-container', 'hide');\r\n\r\n    this.avatars.append(avatar);\r\n\r\n    let photo: Photo.photo;\r\n    if(photoId) {\r\n      photo = typeof(photoId) !== 'object' ? \r\n        await this.managers.appPhotosManager.getPhoto(photoId) : \r\n        (photoId.action as MessageAction.messageActionChannelEditPhoto).photo as Photo.photo;\r\n    }\r\n\r\n    const img = new Image();\r\n    img.classList.add('avatar-photo');\r\n    img.draggable = false;\r\n\r\n    const loadCallback = async() => {\r\n      if(photo) {\r\n        const res = await wrapPhoto({\r\n          container: avatar,\r\n          photo,\r\n          size: choosePhotoSize(photo, 420, 420, false),\r\n          withoutPreloader: true\r\n        });\r\n  \r\n        [res.images.thumb, res.images.full].filter(Boolean).forEach((img) => {\r\n          img.classList.add('avatar-photo');\r\n        });\r\n      } else {\r\n        const photo = await this.managers.appPeersManager.getPeerPhoto(this.peerId);\r\n        await putAvatar(avatar, this.peerId, photo, 'photo_big', img);\r\n      }\r\n\r\n      avatar.classList.remove('hide');\r\n    };\r\n\r\n    if(this.avatars.childElementCount <= LOAD_NEAREST) {\r\n      await loadCallback();\r\n    } else {\r\n      this.intersectionObserver.observe(avatar);\r\n      this.loadCallbacks.set(avatar, loadCallback);\r\n    }\r\n\r\n    this.addTab();\r\n\r\n    return photoId;\r\n  };\r\n\r\n  private loadNearestToTarget(target: Element) {\r\n    const children = Array.from(target.parentElement.children);\r\n    const idx = children.indexOf(target);\r\n    const slice = children.slice(Math.max(0, idx - LOAD_NEAREST), Math.min(children.length, idx + LOAD_NEAREST));\r\n\r\n    slice.forEach((target) => {\r\n      const callback = this.loadCallbacks.get(target);\r\n      if(callback) {\r\n        callback();\r\n        this.loadCallbacks.delete(target);\r\n        this.intersectionObserver.unobserve(target);\r\n      }\r\n    });\r\n  }\r\n\r\n  public cleanup() {\r\n    this.listenerSetter.removeAll();\r\n    this.swipeHandler.removeListeners();\r\n    this.intersectionObserver?.disconnect();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PeerTitle, { PeerTitleOptions } from \"../peerTitle\";\r\n\r\nexport default async function wrapPeerTitle(options: PeerTitleOptions) {\r\n  const peerTitle = new PeerTitle();\r\n  await peerTitle.update(options);\r\n  return peerTitle.element;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_PARALLAX_SUPPORTED from \"../environment/parallaxSupport\";\r\nimport { copyTextToClipboard } from \"../helpers/clipboard\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\nimport { Chat, ChatFull, User, UserFull } from \"../layer\";\r\nimport type { Channel } from \"../lib/appManagers/appChatsManager\";\r\nimport appImManager from \"../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport I18n from \"../lib/langPack\";\r\nimport wrapRichText from \"../lib/richTextProcessor/wrapRichText\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport AvatarElement from \"./avatar\";\r\nimport CheckboxField from \"./checkboxField\";\r\nimport generateTitleIcons from \"./generateTitleIcons\";\r\nimport PeerProfileAvatars from \"./peerProfileAvatars\";\r\nimport Row from \"./row\";\r\nimport Scrollable from \"./scrollable\";\r\nimport { SettingSection, generateDelimiter } from \"./sidebarLeft\";\r\nimport { toast } from \"./toast\";\r\nimport formatUserPhone from \"./wrappers/formatUserPhone\";\r\nimport wrapPeerTitle from \"./wrappers/peerTitle\";\r\n\r\nlet setText = (text: Parameters<typeof setInnerHTML>[1], row: Row) => {\r\n  //fastRaf(() => {\r\n    setInnerHTML(row.title, text || '');\r\n    row.container.style.display = text ? '' : 'none';\r\n  //});\r\n};\r\n\r\nexport default class PeerProfile {\r\n  public element: HTMLElement;\r\n  private avatars: PeerProfileAvatars;\r\n  private avatar: AvatarElement;\r\n  private section: SettingSection;\r\n  private name: HTMLDivElement;\r\n  private subtitle: HTMLDivElement;\r\n  private bio: Row;\r\n  private username: Row;\r\n  private phone: Row;\r\n  private notifications: Row;\r\n  private location: Row;\r\n  private link: Row;\r\n  \r\n  private cleaned: boolean;\r\n  private setMoreDetailsTimeout: number;\r\n  private setPeerStatusInterval: number;\r\n\r\n  private peerId: PeerId;\r\n  private threadId: number;\r\n\r\n  constructor(\r\n    private managers: AppManagers,\r\n    public scrollable: Scrollable, \r\n    private listenerSetter?: ListenerSetter,\r\n    private isDialog = true\r\n  ) {\r\n    if(!IS_PARALLAX_SUPPORTED) {\r\n      this.scrollable.container.classList.add('no-parallax');\r\n    }\r\n\r\n    if(!listenerSetter) {\r\n      this.listenerSetter = new ListenerSetter();\r\n    }\r\n  }\r\n\r\n  public init() {\r\n    this.init = null;\r\n\r\n\r\n    this.element = document.createElement('div');\r\n    this.element.classList.add('profile-content');\r\n\r\n    this.section = new SettingSection({\r\n      noDelimiter: true\r\n    });\r\n\r\n    this.avatar = new AvatarElement();\r\n    this.avatar.classList.add('profile-avatar', 'avatar-120');\r\n    this.avatar.isDialog = this.isDialog;\r\n    this.avatar.attachClickEvent();\r\n\r\n    this.name = document.createElement('div');\r\n    this.name.classList.add('profile-name');\r\n\r\n    this.subtitle = document.createElement('div');\r\n    this.subtitle.classList.add('profile-subtitle');\r\n\r\n    this.bio = new Row({\r\n      title: ' ',\r\n      subtitleLangKey: 'UserBio',\r\n      icon: 'info',\r\n      clickable: async(e) => {\r\n        if((e.target as HTMLElement).tagName === 'A') {\r\n          return;\r\n        }\r\n        \r\n        const full = await this.managers.appProfileManager.getProfileByPeerId(this.peerId);\r\n        copyTextToClipboard(full.about);\r\n        toast(I18n.format('BioCopied', true));\r\n      },\r\n      listenerSetter: this.listenerSetter\r\n    });\r\n\r\n    this.bio.title.classList.add('pre-wrap');\r\n\r\n    this.username = new Row({\r\n      title: ' ',\r\n      subtitleLangKey: 'Username',\r\n      icon: 'username',\r\n      clickable: async() => {\r\n        const peer: Channel | User.user = await this.managers.appPeersManager.getPeer(this.peerId);\r\n        copyTextToClipboard('@' + peer.username);\r\n        toast(I18n.format('UsernameCopied', true));\r\n      },\r\n      listenerSetter: this.listenerSetter\r\n    });\r\n\r\n    this.phone = new Row({\r\n      title: ' ',\r\n      subtitleLangKey: 'Phone',\r\n      icon: 'phone',\r\n      clickable: async() => {\r\n        const peer: User = await this.managers.appUsersManager.getUser(this.peerId);\r\n        copyTextToClipboard('+' + peer.phone);\r\n        toast(I18n.format('PhoneCopied', true));\r\n      },\r\n      listenerSetter: this.listenerSetter\r\n    });\r\n\r\n    this.link = new Row({\r\n      title: ' ',\r\n      subtitleLangKey: 'SetUrlPlaceholder',\r\n      icon: 'link',\r\n      clickable: () => {\r\n        copyTextToClipboard(this.link.title.textContent);\r\n        // Promise.resolve(appProfileManager.getChatFull(this.peerId.toChatId())).then((chatFull) => {\r\n          // copyTextToClipboard(chatFull.exported_invite.link);\r\n          toast(I18n.format('LinkCopied', true));\r\n        // });\r\n      },\r\n      listenerSetter: this.listenerSetter\r\n    });\r\n\r\n    this.location = new Row({\r\n      title: ' ',\r\n      subtitleLangKey: 'ChatLocation',\r\n      icon: 'location'\r\n    });\r\n\r\n    this.section.content.append(\r\n      this.phone.container,\r\n      this.username.container,\r\n      this.location.container,\r\n      this.bio.container,\r\n      this.link.container\r\n    );\r\n\r\n    const {listenerSetter} = this;\r\n    if(this.isDialog) {\r\n      this.notifications = new Row({\r\n        checkboxField: new CheckboxField({toggle: true}),\r\n        titleLangKey: 'Notifications',\r\n        icon: 'unmute',\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      listenerSetter.add(this.notifications.checkboxField.input)('change', (e) => {\r\n        if(!e.isTrusted) {\r\n          return;\r\n        }\r\n  \r\n        //let checked = this.notificationsCheckbox.checked;\r\n        this.managers.appMessagesManager.togglePeerMute(this.peerId);\r\n      });\r\n\r\n      listenerSetter.add(rootScope)('dialog_notify_settings', async(dialog) => {\r\n        if(this.peerId === dialog.peerId) {\r\n          const muted = await this.managers.appNotificationsManager.isPeerLocalMuted(this.peerId, false);\r\n          this.notifications.checkboxField.checked = !muted;\r\n        }\r\n      });\r\n\r\n      this.section.content.append(this.notifications.container);\r\n    }\r\n\r\n    this.element.append(this.section.container);\r\n\r\n    if(IS_PARALLAX_SUPPORTED) {\r\n      this.element.append(generateDelimiter());\r\n    }\r\n\r\n    listenerSetter.add(rootScope)('peer_typings', ({peerId}) => {\r\n      if(this.peerId === peerId) {\r\n        this.setPeerStatus();\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(rootScope)('peer_bio_edit', (peerId) => {\r\n      if(peerId === this.peerId) {\r\n        this.setMoreDetails(true);\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(rootScope)('peer_title_edit', (peerId) => {\r\n      if(peerId === this.peerId) {\r\n        this.fillUsername();\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(rootScope)('user_update', (userId) => {\r\n      if(this.peerId === userId.toPeerId()) {\r\n        this.setPeerStatus();\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(rootScope)('contacts_update', async(userId) => {\r\n      if(this.peerId === userId.toPeerId()) {\r\n        const user = await this.managers.appUsersManager.getUser(userId);\r\n        if(!user.pFlags.self || !this.isDialog) {\r\n          this.fillUserPhone();\r\n        }\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(rootScope)('avatar_update', (peerId) => {\r\n      if(this.peerId === peerId) {\r\n        // const photo = appPeersManager.getPeerPhoto(peerId);\r\n        // if(!photo && this.avatars) {\r\n          this.setAvatar();\r\n        // }\r\n      }\r\n    });\r\n\r\n    this.setPeerStatusInterval = window.setInterval(this.setPeerStatus, 60e3);\r\n  }\r\n\r\n  private setPeerStatus = (needClear = false) => {\r\n    const peerId = this.peerId;\r\n    this.element.classList.toggle('is-me', peerId === rootScope.myId);\r\n    if(!peerId || (rootScope.myId === peerId && this.isDialog)) return;\r\n\r\n    return appImManager.setPeerStatus(\r\n      peerId, \r\n      this.subtitle, \r\n      needClear, \r\n      true, \r\n      () => peerId === this.peerId, \r\n      !this.isDialog\r\n    ).then((callback) => {\r\n      if(callback) {\r\n        callback();\r\n      }\r\n    });\r\n  };\r\n\r\n  public cleanupHTML() {\r\n    [\r\n      this.bio,\r\n      this.phone,\r\n      this.username,\r\n      this.location,\r\n      this.link\r\n    ].forEach((row) => {\r\n      row.container.style.display = 'none';\r\n    });\r\n\r\n    if(this.notifications) {\r\n      this.notifications.container.style.display = '';\r\n      this.notifications.checkboxField.checked = true;\r\n    }\r\n\r\n    this.clearSetMoreDetailsTimeout();\r\n  }\r\n\r\n  private canBeDetailed() {\r\n    return this.peerId !== rootScope.myId || !this.isDialog;\r\n  }\r\n\r\n  private async setAvatar() {\r\n    if(this.canBeDetailed()) {\r\n      const photo = await this.managers.appPeersManager.getPeerPhoto(this.peerId);\r\n\r\n      if(photo) {\r\n        const oldAvatars = this.avatars;\r\n        this.avatars = new PeerProfileAvatars(this.scrollable, this.managers);\r\n        await this.avatars.setPeer(this.peerId);\r\n        this.avatars.info.append(this.name, this.subtitle);\r\n  \r\n        this.avatar.remove();\r\n    \r\n        if(oldAvatars) oldAvatars.container.replaceWith(this.avatars.container);\r\n        else this.element.prepend(this.avatars.container);\r\n\r\n        if(IS_PARALLAX_SUPPORTED) {\r\n          this.scrollable.container.classList.add('parallax');\r\n        }\r\n\r\n        return;\r\n      }\r\n    }\r\n\r\n    if(IS_PARALLAX_SUPPORTED) {\r\n      this.scrollable.container.classList.remove('parallax');\r\n    }\r\n\r\n    if(this.avatars) {\r\n      this.avatars.container.remove();\r\n      this.avatars.cleanup();\r\n      this.avatars = undefined;\r\n    }\r\n\r\n    await this.avatar.updateWithOptions({peerId: this.peerId});\r\n\r\n    this.section.content.prepend(this.avatar, this.name, this.subtitle);\r\n  }\r\n\r\n  private async fillUsername() {\r\n    const {peerId} = this;\r\n    if(peerId.isUser() && this.canBeDetailed()) {\r\n      const username = await this.managers.appPeersManager.getPeerUsername(peerId);\r\n      return setText(username, this.username);\r\n    }\r\n  }\r\n\r\n  private async fillUserPhone() {\r\n    const {peerId} = this;\r\n    if(peerId.isUser() && this.canBeDetailed()) {\r\n      const user = await this.managers.appUsersManager.getUser(peerId);\r\n      return setText(user.phone ? formatUserPhone(user.phone) : undefined, this.phone);\r\n    }\r\n  }\r\n\r\n  private async fillNotifications() {\r\n    const notificationsRow = this.notifications;\r\n    if(!notificationsRow) {\r\n      return;\r\n    }\r\n\r\n    if(this.canBeDetailed()) {\r\n      const muted = await this.managers.appNotificationsManager.isPeerLocalMuted(this.peerId, false);\r\n      notificationsRow.checkboxField.checked = !muted;\r\n    } else {\r\n      fastRaf(() => {\r\n        notificationsRow.container.style.display = 'none';\r\n      });\r\n    }\r\n  }\r\n\r\n  private async fillRows() {\r\n    const peerId = this.peerId;\r\n\r\n    await Promise.all([\r\n      this.fillUsername(),\r\n      this.fillUserPhone(),\r\n      this.fillNotifications(),\r\n      this.setMoreDetails(),\r\n      (async() => {\r\n        const [element, icons] = await Promise.all([\r\n          wrapPeerTitle({\r\n            peerId,\r\n            dialog: this.isDialog,\r\n          }),\r\n\r\n          generateTitleIcons(peerId)\r\n        ]);\r\n        replaceContent(this.name, element);\r\n        this.name.append(...icons);\r\n      })(),\r\n      this.setPeerStatus(true)\r\n    ]);\r\n  }\r\n\r\n  public async fillProfileElements() {\r\n    if(!this.cleaned) return;\r\n    this.cleaned = false;\r\n    \r\n    this.cleanupHTML();\r\n    await Promise.all([\r\n      this.setAvatar(),\r\n      this.fillRows(),\r\n    ]);\r\n  }\r\n\r\n  private async _setMoreDetails(peerId: PeerId, peerFull: ChatFull | UserFull) {\r\n    // if(peerFull.about) {\r\n    setText(peerFull.about ? wrapRichText(peerFull.about) : undefined, this.bio);\r\n    // }\r\n\r\n    if(!peerId.isUser()) {\r\n      const chat: Chat.channel = await this.managers.appChatsManager.getChat(peerId.toChatId());\r\n      if(chat.username) {\r\n        setText('https://t.me/' + chat.username, this.link);\r\n      } else {\r\n        const exportedInvite = (peerFull as ChatFull.channelFull).exported_invite;\r\n        if(exportedInvite?._ === 'chatInviteExported') {\r\n          setText(exportedInvite.link, this.link);\r\n        }\r\n      }\r\n    }\r\n\r\n    const location = (peerFull as ChatFull.channelFull).location;\r\n    if(location?._ == 'channelLocation') {\r\n      setText(location.address, this.location);\r\n    }\r\n\r\n    this.setMoreDetailsTimeout = window.setTimeout(() => this.setMoreDetails(true), 60e3);\r\n  }\r\n\r\n  private async setMoreDetails(override?: true) {\r\n    this.clearSetMoreDetailsTimeout();\r\n\r\n    const peerId = this.peerId;\r\n    const threadId = this.threadId;\r\n\r\n    if(!peerId || await this.managers.appPeersManager.isRestricted(peerId) || !this.canBeDetailed()) {\r\n      return;\r\n    }\r\n\r\n    const result = await this.managers.acknowledged.appProfileManager.getProfileByPeerId(peerId, override);\r\n    const setPromise = result.result.then(async(peerFull) => {\r\n      if(this.peerId !== peerId || this.threadId !== threadId || await this.managers.appPeersManager.isRestricted(peerId)) {\r\n        //this.log.warn('peer changed');\r\n        return;\r\n      }\r\n      \r\n      await this._setMoreDetails(peerId, peerFull);\r\n    });\r\n\r\n    if(result.cached) {\r\n      await setPromise;\r\n    }\r\n  }\r\n\r\n  public setPeer(peerId: PeerId, threadId = 0) {\r\n    if(this.peerId === peerId && this.threadId === threadId) return;\r\n\r\n    if(this.init) {\r\n      this.init();\r\n    }\r\n\r\n    this.peerId = peerId;\r\n    this.threadId = threadId;\r\n    \r\n    this.cleaned = true;\r\n  }\r\n\r\n  public clearSetMoreDetailsTimeout() {\r\n    if(this.setMoreDetailsTimeout !== undefined) {\r\n      clearTimeout(this.setMoreDetailsTimeout);\r\n      this.setMoreDetailsTimeout = undefined;\r\n    }\r\n  }\r\n\r\n  public destroy() {\r\n    this.clearSetMoreDetailsTimeout();\r\n    clearInterval(this.setPeerStatusInterval);\r\n    this.avatars?.cleanup();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport AppSearchSuper, { SearchSuperType } from \"../../appSearchSuper.\";\r\nimport SidebarSlider, { SliderSuperTab } from \"../../slider\";\r\nimport { TransitionSlider } from \"../../transition\";\r\nimport AppEditChatTab from \"./editChat\";\r\nimport PeerTitle from \"../../peerTitle\";\r\nimport AppEditContactTab from \"./editContact\";\r\nimport Button from \"../../button\";\r\nimport ButtonIcon from \"../../buttonIcon\";\r\nimport { i18n, LangPackKey } from \"../../../lib/langPack\";\r\nimport { toastNew } from \"../../toast\";\r\nimport AppAddMembersTab from \"../../sidebarLeft/tabs/addMembers\";\r\nimport PopupPickUser from \"../../popups/pickUser\";\r\nimport PopupPeer, { PopupPeerButtonCallbackCheckboxes, PopupPeerCheckboxOptions } from \"../../popups/peer\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport PeerProfile from \"../../peerProfile\";\r\nimport { Message } from \"../../../layer\";\r\n\r\nconst historiesStorage: {\r\n  [peerId: PeerId]: Partial<{\r\n    [type in SearchSuperType]: {mid: number, peerId: PeerId}[]\r\n  }>\r\n} = {};\r\n\r\n// TODO:    \r\nexport default class AppSharedMediaTab extends SliderSuperTab {\r\n  private editBtn: HTMLElement;\r\n\r\n  private peerId: PeerId;\r\n  private threadId = 0;\r\n\r\n  private searchSuper: AppSearchSuper;\r\n\r\n  private profile: PeerProfile;\r\n  private peerChanged: boolean;\r\n\r\n  constructor(slider: SidebarSlider) {\r\n    super(slider, false);\r\n  }\r\n\r\n  public init() {\r\n    //const perf = performance.now();\r\n\r\n    this.container.classList.add('shared-media-container', 'profile-container');\r\n\r\n    // * header\r\n    const newCloseBtn = Button('btn-icon sidebar-close-button', {noRipple: true});\r\n    this.closeBtn.replaceWith(newCloseBtn);\r\n    this.closeBtn = newCloseBtn;\r\n\r\n    const animatedCloseIcon = document.createElement('div');\r\n    animatedCloseIcon.classList.add('animated-close-icon');\r\n    newCloseBtn.append(animatedCloseIcon);\r\n\r\n    const transitionContainer = document.createElement('div');\r\n    transitionContainer.className = 'transition slide-fade';\r\n    \r\n    const transitionFirstItem = document.createElement('div');\r\n    transitionFirstItem.classList.add('transition-item');\r\n\r\n    this.title.append(i18n('Profile'));\r\n    this.editBtn = ButtonIcon('edit');\r\n    //const moreBtn = ButtonIcon('more');\r\n\r\n    transitionFirstItem.append(this.title, this.editBtn/* , moreBtn */);\r\n\r\n    const transitionLastItem = document.createElement('div');\r\n    transitionLastItem.classList.add('transition-item');\r\n\r\n    const secondTitle: HTMLElement = this.title.cloneNode() as any;\r\n    secondTitle.append(i18n('PeerInfo.SharedMedia'));\r\n\r\n    transitionLastItem.append(secondTitle);\r\n\r\n    transitionContainer.append(transitionFirstItem, transitionLastItem);\r\n\r\n    this.header.append(transitionContainer);\r\n\r\n    // * body\r\n\r\n    this.profile = new PeerProfile(this.managers, this.scrollable, this.listenerSetter);\r\n    this.profile.init();\r\n    \r\n    this.scrollable.append(this.profile.element);\r\n\r\n    const HEADER_HEIGHT = 56;\r\n    this.scrollable.onAdditionalScroll = () => {\r\n      const rect = this.searchSuper.nav.getBoundingClientRect(); \r\n      if(!rect.width) return;\r\n\r\n      const top = rect.top - 1;\r\n      setIsSharedMedia(top <= HEADER_HEIGHT);\r\n    };\r\n\r\n    const setIsSharedMedia = (isSharedMedia: boolean) => {\r\n      animatedCloseIcon.classList.toggle('state-back', isSharedMedia);\r\n      this.searchSuper.container.classList.toggle('is-full-viewport', isSharedMedia);\r\n      transition(+isSharedMedia);\r\n\r\n      if(!isSharedMedia) {\r\n        this.searchSuper.cleanScrollPositions();\r\n      }\r\n    };\r\n\r\n    const transition = TransitionSlider(transitionContainer, 'slide-fade', 400, null, false);\r\n\r\n    transition(0);\r\n\r\n    attachClickEvent(this.closeBtn, (e) => {\r\n      if(this.closeBtn.firstElementChild.classList.contains('state-back')) {\r\n        this.scrollable.scrollIntoViewNew({\r\n          element: this.scrollable.container.firstElementChild as HTMLElement, \r\n          position: 'start'\r\n        });\r\n        transition(0);\r\n        animatedCloseIcon.classList.remove('state-back');\r\n      } else if(!this.scrollable.isHeavyAnimationInProgress) {\r\n        this.slider.onCloseBtnClick();\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    attachClickEvent(this.editBtn, (e) => {\r\n      let tab: AppEditChatTab | AppEditContactTab;\r\n      if(this.peerId.isAnyChat()) {\r\n        tab = this.slider.createTab(AppEditChatTab);\r\n      } else {\r\n        tab = this.slider.createTab(AppEditContactTab);\r\n      }\r\n\r\n      if(tab) {\r\n        if(tab instanceof AppEditChatTab) {\r\n          tab.chatId = this.peerId.toChatId();\r\n        } else {\r\n          tab.peerId = this.peerId;\r\n        }\r\n        \r\n        tab.open();\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    this.listenerSetter.add(rootScope)('contacts_update', (userId) => {\r\n      if(this.peerId === userId) {\r\n        this.toggleEditBtn();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('chat_update', (chatId) => {\r\n      if(this.peerId === chatId.toPeerId(true)) {\r\n        this.toggleEditBtn();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('history_multiappend', (message) => {\r\n      this.renderNewMessages(message);\r\n    });\r\n    \r\n    this.listenerSetter.add(rootScope)('history_delete', ({peerId, msgs}) => {\r\n      this.deleteDeletedMessages(peerId, Array.from(msgs));\r\n    });\r\n\r\n    // Calls when message successfully sent and we have an id\r\n    this.listenerSetter.add(rootScope)('message_sent', ({message}) => {\r\n      this.renderNewMessages(message);\r\n    });\r\n\r\n    //this.container.prepend(this.closeBtn.parentElement);\r\n\r\n    this.searchSuper = new AppSearchSuper({\r\n      mediaTabs: [{\r\n        inputFilter: 'inputMessagesFilterEmpty',\r\n        name: 'PeerMedia.Members',\r\n        type: 'members'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterPhotoVideo',\r\n        name: 'SharedMediaTab2',\r\n        type: 'media'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterDocument',\r\n        name: 'SharedFilesTab2',\r\n        type: 'files'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterUrl',\r\n        name: 'SharedLinksTab2',\r\n        type: 'links'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterMusic',\r\n        name: 'SharedMusicTab2',\r\n        type: 'music'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterRoundVoice',\r\n        name: 'SharedVoiceTab2',\r\n        type: 'voice'\r\n      }], \r\n      scrollable: this.scrollable,\r\n      onChangeTab: (mediaTab) => {\r\n        let timeout = mediaTab.type === 'members' && rootScope.settings.animationsEnabled ? 250 : 0;\r\n        setTimeout(() => {\r\n          btnAddMembers.classList.toggle('is-hidden', mediaTab.type !== 'members');\r\n        }, timeout);\r\n      },\r\n      managers: this.managers\r\n    });\r\n\r\n    this.searchSuper.scrollStartCallback = () => {\r\n      setIsSharedMedia(true);\r\n    };\r\n\r\n    this.profile.element.append(this.searchSuper.container);\r\n\r\n    const btnAddMembers = ButtonCorner({icon: 'addmember_filled'});\r\n    this.content.append(btnAddMembers);\r\n\r\n    attachClickEvent(btnAddMembers, async() => {\r\n      const peerId = this.peerId;\r\n      const id = this.peerId.toChatId();\r\n      const isChannel = await this.managers.appChatsManager.isChannel(id);\r\n\r\n      const showConfirmation = (peerIds: PeerId[], callback: (checked: PopupPeerButtonCallbackCheckboxes) => void) => {\r\n        let titleLangKey: LangPackKey, titleLangArgs: any[],\r\n          descriptionLangKey: LangPackKey, descriptionLangArgs: any[],\r\n          checkboxes: PopupPeerCheckboxOptions[];\r\n\r\n        if(peerIds.length > 1) {\r\n          titleLangKey = 'AddMembersAlertTitle';\r\n          titleLangArgs = [i18n('Members', [peerIds.length])];\r\n          descriptionLangKey = 'AddMembersAlertCountText';\r\n          descriptionLangArgs = peerIds.map((peerId) => {\r\n            const b = document.createElement('b');\r\n            b.append(new PeerTitle({peerId}).element);\r\n            return b;\r\n          });\r\n\r\n          if(!isChannel) {\r\n            checkboxes = [{\r\n              text: 'AddMembersForwardMessages',\r\n              checked: true\r\n            }];\r\n          }\r\n        } else {\r\n          titleLangKey = 'AddOneMemberAlertTitle';\r\n          descriptionLangKey = 'AddMembersAlertNamesText';\r\n          const b = document.createElement('b');\r\n          b.append(new PeerTitle({\r\n            peerId: peerIds[0]\r\n          }).element);\r\n          descriptionLangArgs = [b];\r\n\r\n          if(!isChannel) {\r\n            checkboxes = [{\r\n              text: 'AddOneMemberForwardMessages',\r\n              textArgs: [new PeerTitle({peerId: peerIds[0]}).element],\r\n              checked: true\r\n            }];\r\n          }\r\n        }\r\n\r\n        descriptionLangArgs.push(new PeerTitle({\r\n          peerId\r\n        }).element);\r\n\r\n        new PopupPeer('popup-add-members', {\r\n          peerId,\r\n          titleLangKey,\r\n          descriptionLangKey,\r\n          descriptionLangArgs,\r\n          buttons: [{\r\n            langKey: 'Add',\r\n            callback\r\n          }],\r\n          checkboxes\r\n        }).show();\r\n      };\r\n\r\n      const onError = (err: any) => {\r\n        if(err.type === 'USER_PRIVACY_RESTRICTED') {\r\n          toastNew({langPackKey: 'InviteToGroupError'});\r\n        }\r\n      };\r\n      \r\n      if(isChannel) {\r\n        const tab = this.slider.createTab(AppAddMembersTab);\r\n        tab.open({\r\n          type: 'channel',\r\n          skippable: false,\r\n          takeOut: (peerIds) => {\r\n            showConfirmation(peerIds, () => {\r\n              const promise = this.managers.appChatsManager.inviteToChannel(id, peerIds);\r\n              promise.catch(onError);\r\n              tab.attachToPromise(promise);\r\n            });\r\n\r\n            return false;\r\n          },\r\n          title: 'GroupAddMembers',\r\n          placeholder: 'SendMessageTo'\r\n        });\r\n      } else {\r\n        new PopupPickUser({\r\n          peerTypes: ['contacts'],\r\n          placeholder: 'Search',\r\n          onSelect: (peerId) => {\r\n            setTimeout(() => {\r\n              showConfirmation([peerId], (checked) => {\r\n                this.managers.appChatsManager.addChatUser(id, peerId, checked.size ? undefined : 0)\r\n                .catch(onError);\r\n              });\r\n            }, 0);\r\n          },\r\n        });\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    //console.log('construct shared media time:', performance.now() - perf);\r\n  }\r\n\r\n  public async renderNewMessages(message: Message.message | Message.messageService) {\r\n    if(this.init) return; // * not inited yet\r\n\r\n    const {peerId} = message;\r\n    if(!historiesStorage[peerId]) return;\r\n\r\n    for(const mediaTab of this.searchSuper.mediaTabs) {\r\n      const inputFilter = mediaTab.inputFilter;\r\n      const history = historiesStorage[peerId][inputFilter];\r\n      if(!history) {\r\n        continue;\r\n      }\r\n\r\n      const filtered = this.searchSuper.filterMessagesByType([message], inputFilter).filter((message) => !history.find((m) => m.mid === message.mid && m.peerId === message.peerId));\r\n      if(filtered.length) {\r\n        history.unshift(...filtered.map((message) => ({mid: message.mid, peerId: message.peerId})));\r\n\r\n        if(this.peerId === peerId && this.searchSuper.usedFromHistory[inputFilter] !== -1) {\r\n          this.searchSuper.usedFromHistory[inputFilter] += filtered.length;\r\n          this.searchSuper.performSearchResult(filtered, mediaTab, false);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public deleteDeletedMessages(peerId: PeerId, mids: number[]) {\r\n    if(this.init) return; // * not inited yet\r\n\r\n    if(!historiesStorage[peerId]) return;\r\n\r\n    for(const mid of mids) {\r\n      for(const type of this.searchSuper.mediaTabs) {\r\n        const inputFilter = type.inputFilter;\r\n\r\n        const history = historiesStorage[peerId][inputFilter];\r\n        if(!history) continue;\r\n\r\n        const idx = history.findIndex((m) => m.mid === mid);\r\n        if(idx === -1) {\r\n          continue;\r\n        }\r\n\r\n        history.splice(idx, 1);\r\n\r\n        if(this.peerId === peerId) {\r\n          const container = this.searchSuper.tabs[inputFilter];\r\n          const div = container.querySelector(`[data-mid=\"${mid}\"][data-peer-id=\"${peerId}\"]`) as HTMLElement;\r\n          if(div) {\r\n            if(this.searchSuper.selection.isSelecting) {\r\n              this.searchSuper.selection.toggleByElement(div);\r\n            }\r\n\r\n            div.remove();\r\n          }\r\n\r\n          if(this.searchSuper.usedFromHistory[inputFilter] >= (idx + 1)) {\r\n            --this.searchSuper.usedFromHistory[inputFilter];\r\n          }\r\n        }\r\n\r\n        // can have element in different tabs somehow\r\n        // break;\r\n      }\r\n    }\r\n\r\n    this.scrollable.onScroll();\r\n  }\r\n\r\n  public async cleanupHTML() {\r\n    // const perf = performance.now();\r\n    this.profile.cleanupHTML();\r\n    this.editBtn.classList.add('hide');\r\n    this.searchSuper.cleanupHTML(true);\r\n    this.container.classList.toggle('can-add-members', await this.searchSuper.canViewMembers() && await this.managers.appChatsManager.hasRights(this.peerId.toChatId(), 'invite_users'));\r\n    // console.log('cleanupHTML shared media time:', performance.now() - perf);\r\n  }\r\n\r\n  public setLoadMutex(promise: Promise<any>) {\r\n    this.searchSuper.loadMutex = promise;\r\n  }\r\n\r\n  public setPeer(peerId: PeerId, threadId = 0) {\r\n    if(this.peerId === peerId && this.threadId === threadId) return false;\r\n\r\n    this.peerId = peerId;\r\n    this.threadId = threadId;\r\n    this.peerChanged = true;\r\n\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    this.searchSuper.setQuery({\r\n      peerId, \r\n      //threadId, \r\n      historyStorage: historiesStorage[peerId] ??= {}\r\n    });\r\n\r\n    this.profile.setPeer(peerId, threadId);\r\n    \r\n    return true;\r\n  }\r\n\r\n  public async fillProfileElements() {\r\n    if(!this.peerChanged) {\r\n      return;\r\n    }\r\n\r\n    this.peerChanged = false;\r\n    await this.cleanupHTML();\r\n    await this.toggleEditBtn();\r\n    await this.profile.fillProfileElements();\r\n  }\r\n\r\n  private async toggleEditBtn() {\r\n    let show: boolean;\r\n    if(this.peerId.isUser()) {\r\n      show = this.peerId !== rootScope.myId && await this.managers.appUsersManager.isContact(this.peerId.toUserId());\r\n    } else {\r\n      show = await this.managers.appChatsManager.hasRights(this.peerId.toChatId(), 'change_info');\r\n    }\r\n\r\n    this.editBtn.classList.toggle('hide', !show);\r\n  }\r\n\r\n  public loadSidebarMedia(single: boolean, justLoad?: boolean) {\r\n    this.searchSuper.load(single, justLoad);\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    this.scrollable.onScroll();\r\n  }\r\n\r\n  public destroy() {\r\n    this.destroyable = true;\r\n    this.onCloseAfterTimeout();\r\n    this.profile.destroy();\r\n    this.searchSuper.destroy();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport SidebarSlider from \"../slider\";\r\nimport mediaSizes, { ScreenSize } from \"../../helpers/mediaSizes\";\r\nimport AppSharedMediaTab from \"./tabs/sharedMedia\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nexport const RIGHT_COLUMN_ACTIVE_CLASSNAME = 'is-right-column-shown';\r\n\r\nexport class AppSidebarRight extends SidebarSlider {\r\n  private isColumnProportionSet = false;\r\n  private sharedMediaTab: AppSharedMediaTab;\r\n\r\n  constructor() {\r\n    super({\r\n      sidebarEl: document.getElementById('column-right') as HTMLElement,\r\n      canHideFirst: true,\r\n      navigationType: 'right'\r\n    });\r\n  }\r\n\r\n  construct(managers: AppManagers) {\r\n    this.managers = managers;\r\n\r\n    mediaSizes.addEventListener('changeScreen', (from, to) => {\r\n      if(to === ScreenSize.medium && from !== ScreenSize.mobile) {\r\n        this.toggleSidebar(false);\r\n      }\r\n    });\r\n\r\n    mediaSizes.addEventListener('resize', () => {\r\n      this.setColumnProportion();\r\n    });\r\n  }\r\n\r\n  public createSharedMediaTab() {\r\n    const tab = this.createTab(AppSharedMediaTab, true);\r\n    tab.slider = this;\r\n    // this.tabsContainer.prepend(tab.container);\r\n    return tab;\r\n  }\r\n\r\n  public replaceSharedMediaTab(tab?: AppSharedMediaTab) {\r\n    let previousTab = this.sharedMediaTab;\r\n    if(previousTab) {\r\n      if(tab) {\r\n        const wasActive = previousTab.container.classList.contains('active');\r\n        if(wasActive) {\r\n          tab.container.classList.add('active');\r\n        }\r\n        \r\n        previousTab.container.replaceWith(tab.container);\r\n      } else {\r\n        previousTab.container.remove();\r\n      }\r\n    } else {\r\n      this.tabsContainer.prepend(tab.container);\r\n    }\r\n\r\n    this.sharedMediaTab = tab;\r\n  }\r\n\r\n  public onCloseTab(id: number, animate: boolean, isNavigation?: boolean) {\r\n    if(!this.historyTabIds.length) {\r\n      this.toggleSidebar(false, animate);\r\n    }\r\n\r\n    super.onCloseTab(id, animate, isNavigation);\r\n  }\r\n\r\n  private setColumnProportion() {\r\n    const proportion = this.sidebarEl.scrollWidth / this.sidebarEl.previousElementSibling.scrollWidth;\r\n    document.documentElement.style.setProperty('--right-column-proportion', '' + proportion);\r\n  }\r\n\r\n  public toggleSidebar(enable?: boolean, animate?: boolean) {\r\n    const active = document.body.classList.contains(RIGHT_COLUMN_ACTIVE_CLASSNAME);\r\n    let willChange: boolean;\r\n    if(enable !== undefined) {\r\n      if(enable) {\r\n        if(!active) {\r\n          willChange = true;\r\n        }\r\n      } else if(active) {\r\n        willChange = true;\r\n      }\r\n    } else {\r\n      willChange = true;\r\n    }\r\n\r\n    if(!willChange) return Promise.resolve();\r\n\r\n    if(!active && !this.historyTabIds.length) {\r\n      this.sharedMediaTab.open();\r\n    }\r\n\r\n    if(!this.isColumnProportionSet) {\r\n      this.setColumnProportion();\r\n      this.isColumnProportionSet = true;\r\n    }\r\n\r\n    const animationPromise = appImManager.selectTab(active ? 1 : 2, animate);\r\n    document.body.classList.toggle(RIGHT_COLUMN_ACTIVE_CLASSNAME, enable);\r\n    return animationPromise;\r\n\r\n    /* return new Promise((resolve, reject) => {\r\n      const hidden: {element: HTMLDivElement, height: number}[] = [];\r\n      const observer = new IntersectionObserver((entries) => {\r\n        for(const entry of entries) {\r\n          const bubble = entry.target as HTMLDivElement;\r\n          if(!entry.isIntersecting) {\r\n            hidden.push({element: bubble, height: bubble.scrollHeight});\r\n          }\r\n        }\r\n  \r\n        for(const item of hidden) {\r\n          item.element.style.minHeight = item.height + 'px';\r\n          (item.element.firstElementChild as HTMLElement).style.display = 'none';\r\n          item.element.style.width = '1px';\r\n        }\r\n  \r\n        //console.log('hidden', hidden);\r\n        observer.disconnect();\r\n  \r\n        set();\r\n  \r\n        setTimeout(() => {\r\n          for(const item of hidden) {\r\n            item.element.style.minHeight = '';\r\n            item.element.style.width = '';\r\n            (item.element.firstElementChild as HTMLElement).style.display = '';\r\n          }\r\n\r\n          resolve();\r\n        }, 200);\r\n      });\r\n  \r\n      const length = Object.keys(appImManager.bubbles).length;\r\n      if(length) {\r\n        for(const i in appImManager.bubbles) {\r\n          observer.observe(appImManager.bubbles[i]);\r\n        }\r\n      } else {\r\n        set();\r\n        setTimeout(resolve, 200);\r\n      }\r\n    }); */\r\n  }\r\n}\r\n\r\nconst appSidebarRight = new AppSidebarRight();\r\nMOUNT_CLASS_TO.appSidebarRight = appSidebarRight;\r\nexport default appSidebarRight;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport appSidebarRight from \"..\";\r\nimport { roundPercents } from \"../../poll\";\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport ripple from \"../../ripple\";\r\nimport { i18n } from \"../../../lib/langPack\";\r\nimport setInnerHTML from \"../../../helpers/dom/setInnerHTML\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\n\r\nexport default class AppPollResultsTab extends SliderSuperTab {\r\n  private resultsDiv: HTMLElement;\r\n\r\n  protected init() {\r\n    this.container.id = 'poll-results-container';\r\n    this.container.classList.add('chatlist-container');\r\n\r\n    this.resultsDiv = document.createElement('div');\r\n    this.resultsDiv.classList.add('poll-results');\r\n    this.scrollable.append(this.resultsDiv);\r\n  }\r\n\r\n  public async open(message: any) {\r\n    const ret = super.open();\r\n    const poll = await this.managers.appPollsManager.getPoll(message.media.poll.id);\r\n\r\n    this.setTitle(poll.poll.pFlags.quiz ? 'PollResults.Title.Quiz' : 'PollResults.Title.Poll');\r\n\r\n    const title = document.createElement('h3');\r\n    setInnerHTML(title, wrapEmojiText(poll.poll.question));\r\n\r\n    const percents = poll.results.results.map((v) => v.voters / poll.results.total_voters * 100);\r\n    roundPercents(percents);\r\n\r\n    const fragment = document.createDocumentFragment();\r\n    poll.results.results.forEach((result, idx) => {\r\n      if(!result.voters) return;\r\n\r\n      const hr = document.createElement('hr');\r\n\r\n      const answer = poll.poll.answers[idx];\r\n\r\n      // Head\r\n      const answerEl = document.createElement('div');\r\n      answerEl.classList.add('poll-results-answer');\r\n\r\n      const answerTitle = document.createElement('div');\r\n      setInnerHTML(answerTitle, wrapEmojiText(answer.text));\r\n\r\n      const answerPercents = document.createElement('div');\r\n      answerPercents.innerText = Math.round(percents[idx]) + '%';\r\n\r\n      answerEl.append(answerTitle, answerPercents);\r\n\r\n      // Humans\r\n      const list = appDialogsManager.createChatList();\r\n      list.classList.add('poll-results-voters');\r\n\r\n      appDialogsManager.setListClickListener(list, () => {\r\n        appSidebarRight.onCloseBtnClick();\r\n      }, undefined, true);\r\n\r\n      list.style.minHeight = Math.min(result.voters, 4) * 50 + 'px';\r\n\r\n      fragment.append(hr, answerEl, list);\r\n\r\n      let offset: string, limit = 4, loading = false, left = result.voters - 4;\r\n      const load = () => {\r\n        if(loading) return;\r\n        loading = true;\r\n\r\n        this.managers.appPollsManager.getVotes(message, answer.option, offset, limit).then((votesList) => {\r\n          votesList.votes.forEach((vote) => {\r\n            const {dom} = appDialogsManager.addDialogNew({\r\n              peerId: vote.user_id.toPeerId(false),\r\n              container: list,\r\n              rippleEnabled: false, \r\n              meAsSaved: false,\r\n              avatarSize: 32\r\n            });\r\n            dom.lastMessageSpan.parentElement.remove();\r\n          });\r\n\r\n          if(offset) {\r\n            left -= votesList.votes.length;\r\n            (showMore.lastElementChild as HTMLElement).replaceWith(i18n('PollResults.LoadMore', [Math.min(20, left)]));\r\n          }\r\n          \r\n          offset = votesList.next_offset;\r\n          limit = 20;\r\n\r\n          if(!left || !votesList.votes.length) {\r\n            showMore.remove();\r\n          }\r\n        }).finally(() => {\r\n          loading = false;\r\n        });\r\n      };\r\n\r\n      load();\r\n\r\n      if(left <= 0) return;\r\n\r\n      const showMore = document.createElement('div');\r\n      showMore.classList.add('poll-results-more', 'show-more', 'rp-overflow');\r\n      showMore.addEventListener('click', load);\r\n      ripple(showMore);\r\n      const down = document.createElement('div');\r\n      down.classList.add('tgico-down');\r\n      showMore.append(down, i18n('PollResults.LoadMore', [Math.min(20, left)]));\r\n\r\n      fragment.append(showMore);\r\n    });\r\n\r\n    this.resultsDiv.append(title, fragment);\r\n\r\n    appSidebarRight.toggleSidebar(true).then(() => {\r\n      /* appPollsManager.getVotes(mid).then((votes) => {\r\n        console.log('gOt VotEs', votes);\r\n      }); */\r\n    });\r\n\r\n    return ret;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport AvatarElement from \"./avatar\";\r\nimport type LazyLoadQueue from \"./lazyLoadQueue\";\r\n\r\nconst CLASS_NAME = 'stacked-avatars';\r\nconst AVATAR_CLASS_NAME = CLASS_NAME + '-avatar';\r\nconst AVATAR_CONTAINER_CLASS_NAME = AVATAR_CLASS_NAME + '-container';\r\n\r\nexport default class StackedAvatars {\r\n  public container: HTMLElement;\r\n  private lazyLoadQueue: LazyLoadQueue;\r\n  private avatarSize: number;\r\n\r\n  constructor(options: {\r\n    lazyLoadQueue?: StackedAvatars['lazyLoadQueue'],\r\n    avatarSize: StackedAvatars['avatarSize']\r\n  }) {\r\n    this.lazyLoadQueue = options.lazyLoadQueue;\r\n    this.avatarSize = options.avatarSize;\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add(CLASS_NAME);\r\n\r\n    this.container.style.setProperty('--avatar-size', options.avatarSize + 'px');\r\n  }\r\n  /**\r\n   * MACOS, ANDROID -  \r\n   * WINDOWS DESKTOP - \r\n   *       ,       , !\r\n   */\r\n  public render(peerIds: PeerId[], loadPromises?: Promise<any>[]) {\r\n    const children = this.container.children;\r\n    peerIds = peerIds.slice().reverse();\r\n    if(peerIds.length > 3) {\r\n      peerIds = peerIds.slice(-3);\r\n    }\r\n\r\n    peerIds.forEach((peerId, idx) => {\r\n      let avatarContainer = children[idx] as HTMLElement;\r\n      if(!avatarContainer) {\r\n        avatarContainer = document.createElement('div');\r\n        avatarContainer.classList.add(AVATAR_CONTAINER_CLASS_NAME);\r\n      }\r\n\r\n      let avatarElem = avatarContainer.firstElementChild as AvatarElement;\r\n      if(!avatarElem) {\r\n        avatarElem = new AvatarElement();\r\n        avatarElem.classList.add('avatar-' + this.avatarSize, AVATAR_CLASS_NAME);\r\n        avatarElem.updateOptions({\r\n          isDialog: false,\r\n          loadPromises\r\n        });\r\n      }\r\n\r\n      avatarElem.updateWithOptions({\r\n        lazyLoadQueue: this.lazyLoadQueue,\r\n        peerId: peerId\r\n      });\r\n      \r\n      if(!avatarElem.parentNode) {\r\n        avatarContainer.append(avatarElem);\r\n      }\r\n\r\n      if(!avatarContainer.parentNode) {\r\n        this.container.append(avatarContainer);\r\n      }\r\n    });\r\n\r\n    // if were 3 and became 2\r\n    (Array.from(children) as HTMLElement[]).slice(peerIds.length).forEach((el) => el.remove());\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport appImManager from \"../lib/appManagers/appImManager\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport ripple from \"./ripple\";\r\nimport appSidebarRight from \"./sidebarRight\";\r\nimport AppPollResultsTab from \"./sidebarRight/tabs/pollResults\";\r\nimport { i18n, LangPackKey } from \"../lib/langPack\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\nimport SetTransition from \"./singleTransition\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent, detachClickEvent, simulateClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport windowSize from \"../helpers/windowSize\";\r\nimport { Message, MessageMedia, Poll, PollResults } from \"../layer\";\r\nimport toHHMMSS from \"../helpers/string/toHHMMSS\";\r\nimport StackedAvatars from \"./stackedAvatars\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport wrapEmojiText from \"../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapRichText from \"../lib/richTextProcessor/wrapRichText\";\r\n\r\nlet lineTotalLength = 0;\r\nconst tailLength = 9;\r\nconst times = 10;\r\nconst fullTime = 340;\r\nconst oneTime = fullTime / times;\r\n\r\nexport const roundPercents = (percents: number[]) => {\r\n  //console.log('roundPercents before percents:', percents);\r\n\r\n  const sum = percents.reduce((acc, p) => acc + Math.round(p), 0);\r\n  if(sum > 100) {\r\n    const diff = sum - 100;\r\n    const length = percents.length;\r\n    for(let i = 0; i < diff; ++i) {\r\n      let minIndex = -1, minRemainder = 1;\r\n      for(let k = 0; k < length; ++k) {\r\n        let remainder = percents[k] % 1;\r\n        if(remainder >= 0.5 && remainder < minRemainder) {\r\n          minRemainder = remainder;\r\n          minIndex = k;\r\n        }\r\n      }\r\n\r\n      if(minIndex === -1) {\r\n        //throw new Error('lol chto');\r\n        return;\r\n      }\r\n\r\n      percents[minIndex] -= minRemainder;\r\n    }\r\n  } else if(sum < 100) {\r\n    const diff = 100 - sum;\r\n    const length = percents.length;\r\n    for(let i = 0; i < diff; ++i) {\r\n      let minIndex = -1, maxRemainder = 0;\r\n      for(let k = 0; k < length; ++k) {\r\n        let remainder = percents[k] % 1;\r\n        if(remainder < 0.5 && remainder > maxRemainder) {\r\n          maxRemainder = remainder;\r\n          minIndex = k;\r\n        }\r\n      }\r\n\r\n      if(minIndex === -1) {\r\n        //throw new Error('lol chto');\r\n        return;\r\n      }\r\n\r\n      percents[minIndex] += 1 - maxRemainder;\r\n    }\r\n  }\r\n\r\n  //console.log('roundPercents after percents:', percents);\r\n};\r\n\r\n/* const connectedPolls: {id: string, element: PollElement}[] = [];\r\nrootScope.on('poll_update', (e) => {\r\n  const {poll, results} = e as {poll: Poll, results: PollResults};\r\n\r\n  //console.log('poll_update', poll, results);\r\n  for(const connected of connectedPolls) {\r\n    if(connected.id === poll.id) {\r\n      const pollElement = connected.element;\r\n      pollElement.isClosed = !!poll.pFlags.closed;\r\n      pollElement.performResults(results, poll.chosenIndexes);\r\n    }\r\n  }\r\n}); */\r\n\r\nrootScope.addEventListener('poll_update', ({poll, results}) => {\r\n  const pollElements = Array.from(document.querySelectorAll(`poll-element[poll-id=\"${poll.id}\"]`)) as PollElement[];\r\n  pollElements.forEach((pollElement) => {\r\n    //console.log('poll_update', poll, results);\r\n    pollElement.isClosed = !!poll.pFlags.closed;\r\n    pollElement.performResults(results, poll.chosenIndexes);\r\n  });\r\n});\r\n\r\nmediaSizes.addEventListener('resize', () => {\r\n  PollElement.setMaxLength();\r\n  PollElement.resizePolls();\r\n});\r\n\r\nmediaSizes.addEventListener('changeScreen', () => {\r\n  PollElement.setMaxLength();\r\n});\r\n\r\nconst hideQuizHint = (element: HTMLElement, onHide: () => void, timeout: number) => {\r\n  element.classList.remove('active');\r\n\r\n  clearTimeout(timeout);\r\n  setTimeout(() => {\r\n    onHide();\r\n    element.remove();\r\n\r\n    if(prevQuizHint === element && prevQuizHintOnHide === onHide && prevQuizHintTimeout === timeout) {\r\n      prevQuizHint = prevQuizHintOnHide = null;\r\n      prevQuizHintTimeout = 0;\r\n    }\r\n  }, 200);\r\n};\r\n\r\nlet prevQuizHint: HTMLElement, prevQuizHintOnHide: () => void, prevQuizHintTimeout: number;\r\nlet isListenerSet = false;\r\nconst setQuizHint = (solution: string, solution_entities: any[], onHide: () => void) => {\r\n  if(prevQuizHint) {\r\n    hideQuizHint(prevQuizHint, prevQuizHintOnHide, prevQuizHintTimeout);\r\n  }\r\n\r\n  const element = document.createElement('div');\r\n  element.classList.add('quiz-hint');\r\n\r\n  const container = document.createElement('div');\r\n  container.classList.add('container', 'tgico');\r\n\r\n  const textEl = document.createElement('div');\r\n  textEl.classList.add('text');\r\n\r\n  container.append(textEl);\r\n  element.append(container);\r\n\r\n  setInnerHTML(textEl, wrapRichText(solution, {entities: solution_entities}));\r\n  appImManager.chat.bubbles.container.append(element);\r\n\r\n  void element.offsetLeft; // reflow\r\n  element.classList.add('active');\r\n\r\n  prevQuizHint = element;\r\n  prevQuizHintOnHide = onHide;\r\n  prevQuizHintTimeout = window.setTimeout(() => {\r\n    hideQuizHint(element, onHide, prevQuizHintTimeout);\r\n  }, IS_TOUCH_SUPPORTED ? 5000 : 7000);\r\n\r\n  if(!isListenerSet) {\r\n    isListenerSet = true;\r\n    appImManager.addEventListener('peer_changed', () => {\r\n      if(prevQuizHint) {\r\n        hideQuizHint(prevQuizHint, prevQuizHintOnHide, prevQuizHintTimeout);\r\n      }\r\n    });\r\n  }\r\n};\r\n\r\nexport default class PollElement extends HTMLElement {\r\n  public static MAX_OFFSET = -46.5;\r\n  public static MAX_LENGTH = 0;\r\n  public svgLines: SVGSVGElement[];\r\n  private numberDivs: HTMLDivElement[];\r\n  private answerDivs: HTMLDivElement[];\r\n  private descDiv: HTMLElement;\r\n  private typeDiv: HTMLElement;\r\n  private avatarsDiv: HTMLElement;\r\n  private viewResults: HTMLElement;\r\n  private votersCountDiv: HTMLDivElement;\r\n\r\n  // private maxLength: number;\r\n  // private maxLengths: number[];\r\n  private maxPercents: number[];\r\n\r\n  public isClosed = false;\r\n  private isQuiz = false;\r\n  private isRetracted = false;\r\n  private isPublic = false;\r\n  private isMultiple = false;\r\n  private chosenIndexes: number[] = [];\r\n  private percents: number[];\r\n\r\n  public message: Message.message;\r\n  public managers: AppManagers;\r\n\r\n  private quizInterval: number;\r\n  private quizTimer: SVGSVGElement;\r\n\r\n  private sendVoteBtn: HTMLElement;\r\n  private chosingIndexes: number[] = [];\r\n\r\n  private sendVotePromise: Promise<void>;\r\n  private sentVote = false;\r\n\r\n  public static setMaxLength() {\r\n    const width = windowSize.width <= 360 ? windowSize.width - 120 : mediaSizes.active.poll.width;\r\n    this.MAX_LENGTH = width + tailLength + this.MAX_OFFSET + -13.7; // 13 - position left\r\n  }\r\n\r\n  public static resizePolls() {\r\n    if(!this.MAX_LENGTH) return;\r\n    const pollElements = Array.from(document.querySelectorAll('poll-element.is-voted')) as PollElement[];\r\n    pollElements.forEach((pollElement) => {\r\n      pollElement.svgLines.forEach((svg, idx) => {\r\n        //void svg.getBoundingClientRect(); // reflow\r\n        pollElement.setLineProgress(idx, 1);\r\n      });\r\n    });\r\n  }\r\n\r\n  public async render() {\r\n    //         \r\n    // (   ,    /)\r\n\r\n    if(!lineTotalLength) {\r\n      lineTotalLength = (document.getElementById('poll-line') as any as SVGPathElement).getTotalLength();\r\n      //console.log('line total length:', lineTotalLength);\r\n      PollElement.setMaxLength();\r\n    }\r\n\r\n    // const {poll, results} = this.managers.appPollsManager.getPoll(pollId);\r\n    const {poll, results} = this.message.media as MessageMedia.messageMediaPoll;\r\n\r\n    /* const timestamp = Date.now() / 1000 | 0;\r\n    if(timestamp < this.message.date) { */\r\n    if(this.message.pFlags.is_scheduled) {\r\n      this.classList.add('disable-hover');\r\n    }\r\n\r\n    //console.log('pollElement poll:', poll, results);\r\n\r\n    let descKey: LangPackKey;\r\n    if(poll.pFlags) {\r\n      this.isPublic = !!poll.pFlags.public_voters;\r\n      this.isQuiz = !!poll.pFlags.quiz;\r\n      this.isClosed = !!poll.pFlags.closed;\r\n      this.isMultiple = !!poll.pFlags.multiple_choice;\r\n\r\n      if(this.isClosed) {\r\n        descKey = 'Chat.Poll.Type.Closed';\r\n        this.classList.add('is-closed');\r\n      } else if(this.isQuiz) {\r\n        descKey = this.isPublic ? 'Chat.Poll.Type.Quiz' : 'Chat.Poll.Type.AnonymousQuiz';\r\n      } else {\r\n        descKey = this.isPublic ? 'Chat.Poll.Type.Public' : 'Chat.Poll.Type.Anonymous';\r\n      }\r\n    }\r\n\r\n    this.classList.toggle('is-multiple', this.isMultiple);\r\n\r\n    const multipleSelect = this.isMultiple ? '<span class=\"poll-answer-selected tgico-check\"></span>' : '';\r\n    const votes = poll.answers.map((answer, idx) => {\r\n      return `\r\n        <div class=\"poll-answer\" data-index=\"${idx}\">\r\n          <div class=\"circle-hover\">\r\n            <div class=\"animation-ring\"></div>\r\n            <svg class=\"progress-ring\">\r\n              <circle class=\"progress-ring__circle\" cx=\"13\" cy=\"13\" r=\"9\"></circle>\r\n            </svg>\r\n            ${multipleSelect}\r\n          </div>\r\n          <div class=\"poll-answer-percents\"></div>\r\n          <div class=\"poll-answer-text\"></div>\r\n          <svg version=\"1.1\" class=\"poll-line\" style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 485.9 35\" xml:space=\"preserve\">\r\n            <use href=\"#poll-line\"></use>\r\n          </svg>\r\n          <span class=\"poll-answer-selected tgico\"></span>\r\n        </div>\r\n      `;\r\n    }).join('');\r\n\r\n    this.innerHTML = `\r\n      <div class=\"poll-title\"></div>\r\n      <div class=\"poll-desc\">\r\n        <div class=\"poll-type\"></div>\r\n        <div class=\"poll-avatars\"></div>\r\n      </div>\r\n      ${votes}`;\r\n    \r\n    setInnerHTML(this.firstElementChild, wrapEmojiText(poll.question));\r\n\r\n    Array.from(this.querySelectorAll('.poll-answer-text')).forEach((el, idx) => {\r\n      setInnerHTML(el, wrapEmojiText(poll.answers[idx].text));\r\n    });\r\n\r\n    this.descDiv = this.firstElementChild.nextElementSibling as HTMLElement;\r\n    this.typeDiv = this.descDiv.firstElementChild as HTMLElement;\r\n    this.avatarsDiv = this.descDiv.lastElementChild as HTMLElement;\r\n\r\n    if(descKey) {\r\n      this.typeDiv.append(i18n(descKey));\r\n    }\r\n\r\n    if(this.isQuiz) {\r\n      this.classList.add('is-quiz');\r\n\r\n      if(poll.close_period && poll.close_date) {\r\n        const timeLeftDiv = document.createElement('div');\r\n        timeLeftDiv.classList.add('poll-time');\r\n        this.descDiv.append(timeLeftDiv);\r\n\r\n        const svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\r\n        //svg.setAttributeNS(null, 'viewBox', '0 0 15 15');\r\n        svg.classList.add('poll-quiz-timer');\r\n\r\n        this.quizTimer = svg;\r\n\r\n        const strokeWidth = 2;\r\n        const radius = 7;\r\n        const circumference = 2 * Math.PI * radius;\r\n\r\n        const circle = document.createElementNS(\"http://www.w3.org/2000/svg\", \"circle\");\r\n        circle.classList.add('poll-quiz-timer-circle');\r\n        circle.setAttributeNS(null, 'cx', '16');\r\n        circle.setAttributeNS(null, 'cy', '16');\r\n        circle.setAttributeNS(null, 'r', '' + radius);\r\n        circle.setAttributeNS(null, 'stroke-width', '' + strokeWidth);\r\n\r\n        svg.append(circle);\r\n        this.descDiv.append(svg);\r\n        \r\n        const period = poll.close_period * 1000;\r\n        const closeTime = (poll.close_date - await rootScope.managers.timeManager.getServerTimeOffset()) * 1000;\r\n\r\n        //console.log('closeTime:', poll.close_date, serverTimeManager.serverTimeOffset, Date.now() / 1000 | 0);\r\n\r\n        // let time = Date.now();\r\n        // let percents = (closeTime - time) / period;\r\n\r\n        // timeLeftDiv.innerHTML = String((closeTime - time) / 1000 + 1 | 0).toHHMMSS();\r\n\r\n        // // @ts-ignore\r\n        // circle.style.strokeDashoffset = circumference + percents * circumference;\r\n        // circle.style.strokeDasharray = ${circumference} ${circumference};\r\n\r\n        this.quizInterval = window.setInterval(() => {\r\n          const time = Date.now();\r\n          const percents = (closeTime - time) / period;\r\n          const timeLeft = (closeTime - time) / 1000 + 1 | 0;\r\n          timeLeftDiv.innerHTML = toHHMMSS(timeLeft);\r\n          \r\n          if (timeLeft <= 5) {\r\n            timeLeftDiv.style.color = '#ee545c';\r\n            circle.style.stroke = '#ee545c';\r\n          }\r\n          //timeLeftDiv.style.visibility = 'visible';\r\n\r\n          // @ts-ignore\r\n          circle.style.strokeDashoffset = circumference + percents * circumference;\r\n          circle.style.strokeDasharray = `${circumference} ${circumference}`;\r\n\r\n          if(time >= closeTime) {\r\n            clearInterval(this.quizInterval);\r\n            timeLeftDiv.innerHTML = '';\r\n            // @ts-ignore\r\n            circle.style.strokeDashoffset = circumference;\r\n            this.quizInterval = 0;\r\n\r\n            setTimeout(() => {\r\n              //      \r\n              this.managers.appPollsManager.getResults(this.message);\r\n            }, 3e3);\r\n          }\r\n        }, 1e3);\r\n      }\r\n    }\r\n    \r\n    this.answerDivs = Array.from(this.querySelectorAll('.poll-answer')) as HTMLDivElement[];\r\n    this.svgLines = Array.from(this.querySelectorAll('.poll-line')) as SVGSVGElement[];\r\n    this.numberDivs = Array.from(this.querySelectorAll('.poll-answer-percents')) as HTMLDivElement[];\r\n\r\n    const footerDiv = document.createElement('div');\r\n    footerDiv.classList.add('poll-footer');\r\n\r\n    this.viewResults = document.createElement('div');\r\n    this.viewResults.className = 'poll-footer-button poll-view-results hide';\r\n    this.viewResults.append(i18n('Chat.Poll.ViewResults'));\r\n\r\n    this.votersCountDiv = document.createElement('div');\r\n    this.votersCountDiv.className = 'poll-votes-count';\r\n\r\n    footerDiv.append(this.viewResults, this.votersCountDiv);\r\n    this.append(footerDiv);\r\n\r\n    this.viewResults.addEventListener('click', (e) => {\r\n      cancelEvent(e);\r\n\r\n      if(!appSidebarRight.isTabExists(AppPollResultsTab)) {\r\n        appSidebarRight.createTab(AppPollResultsTab).open(this.message);\r\n      }\r\n    });\r\n    ripple(this.viewResults);\r\n\r\n    if(this.isMultiple) {\r\n      this.sendVoteBtn = document.createElement('div');\r\n      this.sendVoteBtn.classList.add('poll-footer-button', 'poll-send-vote');\r\n      this.sendVoteBtn.append(i18n('Chat.Poll.SubmitVote'));\r\n      ripple(this.sendVoteBtn);\r\n\r\n      if(!poll.chosenIndexes.length) {\r\n        this.votersCountDiv.classList.add('hide');\r\n      }\r\n\r\n      attachClickEvent(this.sendVoteBtn, (e) => {\r\n        cancelEvent(e);\r\n        /* const indexes = this.answerDivs.filter((el) => el.classList.contains('is-chosing')).map((el) => +el.dataset.index);\r\n        if(indexes.length) {\r\n          \r\n        } */\r\n        if(this.chosingIndexes.length) {\r\n          this.sendVotes(this.chosingIndexes).then(() => {\r\n            this.chosingIndexes.length = 0;\r\n            this.answerDivs.forEach((el) => {\r\n              el.classList.remove('is-chosing');\r\n            });\r\n          });\r\n        }\r\n      });\r\n\r\n      footerDiv.append(this.sendVoteBtn);\r\n    }\r\n\r\n    // const width = this.getBoundingClientRect().width;\r\n    // const width = mediaSizes.active.poll.width;\r\n    // this.maxLength = width + tailLength + this.maxOffset + -13.7; // 13 - position left\r\n\r\n    const canVote = !(poll.chosenIndexes.length || this.isClosed);\r\n    if(!canVote || this.isPublic) {\r\n      this.performResults(results, poll.chosenIndexes, false);\r\n    }\r\n\r\n    if(canVote) {\r\n      this.setVotersCount(results);\r\n      attachClickEvent(this, this.clickHandler);\r\n    }\r\n  }\r\n\r\n  initQuizHint(results: PollResults) {\r\n    if(results.solution && results.solution_entities) {\r\n      const toggleHint = document.createElement('div');\r\n      toggleHint.classList.add('tgico-tip', 'poll-hint');\r\n      this.descDiv.append(toggleHint);\r\n\r\n      //let active = false;\r\n      attachClickEvent(toggleHint, (e) => {\r\n        cancelEvent(e);\r\n\r\n        //active = true;\r\n        toggleHint.classList.add('active');\r\n        setQuizHint(results.solution, results.solution_entities, () => {\r\n          //active = false;\r\n          toggleHint.classList.remove('active');\r\n        });\r\n      });\r\n\r\n      if(this.sentVote) {\r\n        const correctResult = results.results.find((r) => r.pFlags.correct);\r\n        if(correctResult && !correctResult.pFlags.chosen) {\r\n          simulateClickEvent(toggleHint);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  clickHandler(e: Event) {\r\n    const target = findUpClassName(e.target, 'poll-answer') as HTMLElement;\r\n    if(!target) {\r\n      return;\r\n    }\r\n    \r\n    cancelEvent(e);\r\n    const answerIndex = +target.dataset.index;\r\n    if(this.isMultiple) {\r\n      target.classList.toggle('is-chosing');\r\n\r\n      const foundIndex = this.chosingIndexes.indexOf(answerIndex);\r\n      if(foundIndex !== -1) {\r\n        this.chosingIndexes.splice(foundIndex, 1);\r\n      } else {\r\n        this.chosingIndexes.push(answerIndex);\r\n      }\r\n    } else {\r\n      this.sendVotes([answerIndex]);\r\n    }\r\n    \r\n    /* target.classList.add('is-voting');\r\n    setTimeout(() => { // simulate\r\n      this.setResults([100, 0], answerIndex);\r\n      target.classList.remove('is-voting');\r\n    }, 1000); */\r\n  }\r\n\r\n  sendVotes(indexes: number[]) {\r\n    if(this.sendVotePromise) return this.sendVotePromise;\r\n\r\n    const targets = this.answerDivs.filter((_, idx) => indexes.includes(idx));\r\n    targets.forEach((target) => {\r\n      target.classList.add('is-voting');\r\n    });\r\n    \r\n    this.classList.add('disable-hover');\r\n    this.sentVote = true;\r\n    return this.sendVotePromise = this.managers.appPollsManager.sendVote(this.message, indexes).then(() => {\r\n      targets.forEach((target) => {\r\n        target.classList.remove('is-voting');\r\n      });\r\n\r\n      this.classList.remove('disable-hover');\r\n    }).catch(() => {\r\n      this.sentVote = false;\r\n    }).finally(() => {\r\n      this.sendVotePromise = null;\r\n    });\r\n  }\r\n\r\n  performResults(results: PollResults, chosenIndexes: number[], animate = true) {\r\n    if(!rootScope.settings.animationsEnabled) {\r\n      animate = false;\r\n    }\r\n\r\n    if(this.isQuiz && (results.results?.length || this.isClosed)) {\r\n      this.answerDivs.forEach((el, idx) => {\r\n        el.classList.toggle('is-correct', !!results.results[idx].pFlags.correct);\r\n      });\r\n\r\n      if(this.initQuizHint) {\r\n        this.initQuizHint(results);\r\n        this.initQuizHint = null;\r\n      }\r\n\r\n      if(this.quizInterval) {\r\n        clearInterval(this.quizInterval);\r\n        this.quizInterval = 0;\r\n      }\r\n\r\n      if(this.quizTimer?.parentElement) {\r\n        this.quizTimer.remove();\r\n      }\r\n\r\n      const timeEl = this.descDiv.querySelector('.poll-time');\r\n      if(timeEl) {\r\n        timeEl.remove();\r\n      }\r\n    }\r\n\r\n    if(this.isClosed) {\r\n      this.classList.add('is-closed');\r\n      replaceContent(this.typeDiv, i18n('Chat.Poll.Type.Closed'));\r\n    }\r\n\r\n    // set chosen\r\n    if(this.chosenIndexes.length !== chosenIndexes.length || this.isClosed) { // if we voted\r\n      this.isRetracted = this.chosenIndexes.length && !chosenIndexes.length;\r\n      this.chosenIndexes = chosenIndexes.slice();\r\n\r\n      if(this.isRetracted) {\r\n        attachClickEvent(this, this.clickHandler);\r\n      } else {\r\n        detachClickEvent(this, this.clickHandler);\r\n      }\r\n    }\r\n    \r\n    // is need update\r\n    if(this.chosenIndexes.length || this.isRetracted || this.isClosed) {\r\n      const percents = results.results.map((v) => results.total_voters ? v.voters / results.total_voters * 100 : 0);\r\n\r\n      this.classList.toggle('no-transition', !animate);\r\n      if(animate) {\r\n        SetTransition(this, '', !this.isRetracted, 340);\r\n      }\r\n\r\n      fastRaf(() => {\r\n        this.setResults(this.isRetracted ? this.percents : percents, this.chosenIndexes, animate);\r\n        this.percents = percents;\r\n        this.isRetracted = false;\r\n      });\r\n    }\r\n    \r\n    this.setVotersCount(results);\r\n\r\n    if(this.isPublic) {\r\n      if(!this.isMultiple) {\r\n        this.viewResults.classList.toggle('hide', !results.total_voters || !this.chosenIndexes.length);\r\n        this.votersCountDiv.classList.toggle('hide', !!this.chosenIndexes.length);\r\n      }\r\n\r\n      const peerIds = (results.recent_voters || []).map((userId) => userId.toPeerId());\r\n      const stackedAvatars = new StackedAvatars({avatarSize: 16});\r\n      stackedAvatars.render(peerIds);\r\n      replaceContent(this.avatarsDiv, stackedAvatars.container);\r\n    }\r\n\r\n    if(this.isMultiple) {\r\n      const isVoted = !!this.chosenIndexes.length;\r\n\r\n      const hideSendVoteBtn = this.isClosed || isVoted;\r\n      const hideViewResultsBtn = !this.isPublic || !results.total_voters || (!isVoted && !this.isClosed);\r\n      this.sendVoteBtn.classList.toggle('hide', hideSendVoteBtn);\r\n      this.viewResults.classList.toggle('hide', hideViewResultsBtn);\r\n      this.votersCountDiv.classList.toggle('hide', !hideSendVoteBtn || !hideViewResultsBtn);\r\n    }\r\n  }\r\n\r\n  setResults(percents: number[], chosenIndexes: number[], animate: boolean) {\r\n    this.svgLines.forEach((svg) => svg.style.display = '');\r\n\r\n    this.answerDivs.forEach((el, idx) => {\r\n      el.classList.toggle('is-chosen', chosenIndexes.includes(idx));\r\n    });\r\n\r\n    const maxValue = Math.max(...percents);\r\n    // this.maxLengths = percents.map((p) => p / maxValue * this.maxLength);\r\n    this.maxPercents = percents.map((p) => p / maxValue);\r\n\r\n    // line\r\n    if(this.isRetracted) {\r\n      this.svgLines.forEach((svg, idx) => {\r\n        this.setLineProgress(idx, -1);\r\n      });\r\n    } else {\r\n      const cb = () => {\r\n        this.svgLines.forEach((svg, idx) => {\r\n          //void svg.getBoundingClientRect(); // reflow\r\n          this.setLineProgress(idx, 1);\r\n        });\r\n      };\r\n      \r\n      animate ? fastRaf(cb) : cb();\r\n    }\r\n\r\n    percents = percents.slice();\r\n    roundPercents(percents);\r\n    let getPercentValue: (percents: number, index: number) => number;\r\n    const iterate = (i: number) => {\r\n      percents.forEach((percents, idx) => {\r\n        const value = getPercentValue(percents, i);\r\n        this.numberDivs[idx].innerText = value + '%';\r\n      });\r\n    };\r\n    // numbers\r\n    if(this.isRetracted) {\r\n      getPercentValue = (percents, index) => Math.round(percents / times * index);\r\n\r\n      if(animate) {\r\n        for(let i = (times - 1), k = 0; i >= 0; --i, ++k) {\r\n          setTimeout(() => {\r\n            iterate(i);\r\n          }, oneTime * k);\r\n        }\r\n      } else {\r\n        iterate(0);\r\n      }\r\n    } else {\r\n      getPercentValue = (percents, index) => Math.round(percents / times * (index + 1));\r\n\r\n      if(animate) {\r\n        for(let i = 0; i < times; ++i) {\r\n          setTimeout(() => {\r\n            iterate(i);\r\n          }, oneTime * i);\r\n        }\r\n      } else {\r\n        iterate(times - 1);\r\n      }\r\n    }\r\n\r\n    if(this.isRetracted) {\r\n      if(animate) {\r\n        this.classList.add('is-retracting');\r\n      }\r\n\r\n      this.classList.remove('is-voted');\r\n      const cb = () => {\r\n        this.svgLines.forEach((svg) => svg.style.display = 'none');\r\n      };\r\n\r\n      if(animate) {\r\n        setTimeout(() => {\r\n          this.classList.remove('is-retracting');\r\n          cb();\r\n        }, fullTime);\r\n      } else {\r\n        cb();\r\n      }\r\n    } else {\r\n      this.classList.add('is-voted');\r\n    }\r\n  }\r\n\r\n  setVotersCount(results: PollResults) {\r\n    const votersCount = results.total_voters || 0;\r\n    let key: LangPackKey, args = [votersCount];\r\n    if(this.isClosed) {\r\n      if(this.isQuiz) key = votersCount ? 'Chat.Quiz.TotalVotes' : 'Chat.Quiz.TotalVotesResultEmpty';\r\n      else key = votersCount ? 'Chat.Poll.TotalVotes1' : 'Chat.Poll.TotalVotesResultEmpty';\r\n    } else {\r\n      if(this.isQuiz) key = votersCount ? 'Chat.Quiz.TotalVotes' : 'Chat.Quiz.TotalVotesEmpty';\r\n      else key = votersCount ? 'Chat.Poll.TotalVotes1' : 'Chat.Poll.TotalVotesEmpty';\r\n    }\r\n    \r\n    replaceContent(this.votersCountDiv, i18n(key, args));\r\n  }\r\n\r\n  setLineProgress(index: number, multiplier: number) {\r\n    const svg = this.svgLines[index];\r\n\r\n    if(multiplier === -1) {\r\n      svg.style.strokeDasharray = '';\r\n      svg.style.strokeDashoffset = '';\r\n    } else {\r\n      // svg.style.strokeDasharray = (multiplier * this.maxLengths[index]) + ', 485.9';\r\n      svg.style.strokeDasharray = (multiplier * this.maxPercents[index] * PollElement.MAX_LENGTH) + ', 485.9';\r\n      // svg.style.strokeDasharray = (multiplier * this.maxPercents[index] * 100) + '%, 485.9';\r\n      svg.style.strokeDashoffset = '' + multiplier * PollElement.MAX_OFFSET;\r\n    }\r\n  }\r\n\r\n  //         \r\n}\r\n\r\ncustomElements.define(\"poll-element\", PollElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default class DivAndCaption<T> {\r\n  public container: HTMLElement;\r\n  public border: HTMLElement;\r\n  public content: HTMLElement;\r\n  public title: HTMLElement;\r\n  public subtitle: HTMLElement;\r\n\r\n  constructor(protected className: string, public fill?: T) {\r\n    this.container = document.createElement('div');\r\n    this.container.className = className;\r\n\r\n    this.border = document.createElement('div');\r\n    this.border.classList.add(className + '-border');\r\n    \r\n    this.content = document.createElement('div');\r\n    this.content.classList.add(className + '-content');\r\n\r\n    this.title = document.createElement('div');\r\n    this.title.classList.add(className + '-title');\r\n    this.title.setAttribute('dir', 'auto');\r\n\r\n    this.subtitle = document.createElement('div');\r\n    this.subtitle.classList.add(className + '-subtitle');\r\n    this.subtitle.setAttribute('dir', 'auto');\r\n\r\n    this.content.append(this.title, this.subtitle);\r\n    this.container.append(this.border, this.content);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function htmlToDocumentFragment(html: string | DocumentFragment) {\r\n  if(html instanceof DocumentFragment) return html;\r\n  const template = document.createElement('template');\r\n  html = html.trim(); // Never return a text node of whitespace as the result\r\n  template.innerHTML = html;\r\n  return template.content;\r\n}\r\n","import { RestrictionReason } from \"../layer\";\r\n\r\nconst platforms = new Set([\r\n  'all',\r\n  'web',\r\n  'webk'\r\n]);\r\n\r\nconst ignore = new Set();\r\n\r\nexport function getRestrictionReason(reasons: RestrictionReason[]) {\r\n  // return reasons[0];\r\n  return reasons.find((reason) => platforms.has(reason.platform) && !ignore.has(reason.reason));\r\n}\r\n\r\nexport function isRestricted(reasons: RestrictionReason[]) {\r\n  return !!getRestrictionReason(reasons);\r\n}\r\n\r\nexport function ignoreRestrictionReasons(reasons: string[]) {\r\n  ignore.clear();\r\n  reasons.forEach((reason) => {\r\n    ignore.add(reason);\r\n  });\r\n}\r\n","// credits to https://github.com/sindresorhus/escape-string-regexp/blob/master/index.js\r\nexport default function escapeRegExp(str: string) {\r\n  return str\r\n    .replace(/[|\\\\{}()[\\]^$+*?.]/g, '\\\\$&')\r\n    .replace(/-/g, '\\\\x2d');\r\n}\r\n","import { isRestricted } from \"../../../../helpers/restrictions\";\r\nimport { Message } from \"../../../../layer\";\r\n\r\nexport default function isMessageRestricted(message: Message.message) {\r\n  return !!(message.restriction_reason && isRestricted(message.restriction_reason));\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport I18n, { i18n, join, LangPackKey } from \"../lib/langPack\";\r\nimport formatDuration, { DurationType } from \"./formatDuration\";\r\n\r\nconst CALL_DURATION_LANG_KEYS: {[type in DurationType]: LangPackKey} = {\r\n  s: 'Seconds',\r\n  m: 'Minutes',\r\n  h: 'Hours',\r\n  d: 'Days',\r\n  w: 'Weeks'\r\n};\r\nexport default function formatCallDuration(duration: number, plain?: boolean) {\r\n  const a = formatDuration(duration, 2);\r\n  if(plain) {\r\n    const strings = a.map((d) => I18n.format(CALL_DURATION_LANG_KEYS[d.type], true, [d.duration]));\r\n    return join(strings, false, plain);\r\n  }\r\n\r\n  const elements = a.map((d) => i18n(CALL_DURATION_LANG_KEYS[d.type], [d.duration]));\r\n\r\n  const fragment = document.createElement('span');\r\n  fragment.append(...join(elements, false));\r\n\r\n  return fragment;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport type DurationType = 's' | 'm' | 'h' | 'd' | 'w';\r\nexport default function formatDuration(duration: number, showLast = 2) {\r\n  if(!duration) {\r\n    duration = 1;\r\n  }\r\n\r\n  let d: {duration: number, type: DurationType}[] = [];\r\n  const p = [\r\n    {m: 1, t: 's'},\r\n    {m: 60, t: 'm'}, \r\n    {m: 60, t: 'h'}, \r\n    {m: 24, t: 'd'}, \r\n    {m: 7, t: 'w'}\r\n  ] as Array<{m?: number, t: DurationType}>\r\n  const s = 1;\r\n  let t = s;\r\n  p.forEach((o, idx) => {\r\n    t *= o.m;\r\n\r\n    if(duration < t) {\r\n      return;\r\n    }\r\n\r\n    const modulus = p[idx === (p.length - 1) ? idx : idx + 1].m;\r\n    d.push({\r\n      duration: (duration / t % modulus | 0),\r\n      type: o.t\r\n    });\r\n  });\r\n\r\n  const out = d.slice(-showLast).reverse();\r\n  for(let i = out.length - 1; i >= 0; --i) {\r\n    if(out[i].duration === 0) {\r\n      out.splice(i, 1);\r\n    }\r\n  }\r\n  \r\n  return out;\r\n}\r\n","// Taken from https://core.telegram.org/bots/payments/currencies.json\r\nexport type Currency = {\r\n  code: string,\r\n  title: string,\r\n  symbol: string,\r\n  native: string,\r\n  thousands_sep: string,\r\n  decimal_sep: string,\r\n  symbol_left: boolean,\r\n  space_between: boolean,\r\n  exp: number,\r\n  min_amount: string | number,\r\n  max_amount: string | number\r\n};\r\n\r\nconst Currencies: {[currency: string]: Currency} = {\"AED\":{\"code\":\"AED\",\"title\":\"United Arab Emirates Dirham\",\"symbol\":\"AED\",\"native\":\"..\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"367\",\"max_amount\":\"3672990\"},\"AFN\":{\"code\":\"AFN\",\"title\":\"Afghan Afghani\",\"symbol\":\"AFN\",\"native\":\"\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"8893\",\"max_amount\":\"88930176\"},\"ALL\":{\"code\":\"ALL\",\"title\":\"Albanian Lek\",\"symbol\":\"ALL\",\"native\":\"Lek\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":false,\"exp\":2,\"min_amount\":\"11408\",\"max_amount\":\"114088432\"},\"AMD\":{\"code\":\"AMD\",\"title\":\"Armenian Dram\",\"symbol\":\"AMD\",\"native\":\".\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"41129\",\"max_amount\":\"411293180\"},\"ARS\":{\"code\":\"ARS\",\"title\":\"Argentine Peso\",\"symbol\":\"ARS\",\"native\":\"$\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"12503\",\"max_amount\":\"125036607\"},\"AUD\":{\"code\":\"AUD\",\"title\":\"Australian Dollar\",\"symbol\":\"AU$\",\"native\":\"$\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"145\",\"max_amount\":\"1451625\"},\"AZN\":{\"code\":\"AZN\",\"title\":\"Azerbaijani Manat\",\"symbol\":\"AZN\",\"native\":\".\",\"thousands_sep\":\" \",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"171\",\"max_amount\":\"1711164\"},\"BAM\":{\"code\":\"BAM\",\"title\":\"Bosnia & Herzegovina Convertible Mark\",\"symbol\":\"BAM\",\"native\":\"KM\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"187\",\"max_amount\":\"1873042\"},\"BDT\":{\"code\":\"BDT\",\"title\":\"Bangladeshi Taka\",\"symbol\":\"BDT\",\"native\":\"\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"9415\",\"max_amount\":\"94154281\"},\"BGN\":{\"code\":\"BGN\",\"title\":\"Bulgarian Lev\",\"symbol\":\"BGN\",\"native\":\".\",\"thousands_sep\":\" \",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"186\",\"max_amount\":\"1869710\"},\"BND\":{\"code\":\"BND\",\"title\":\"Brunei Dollar\",\"symbol\":\"BND\",\"native\":\"$\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"139\",\"max_amount\":\"1399458\"},\"BOB\":{\"code\":\"BOB\",\"title\":\"Bolivian Boliviano\",\"symbol\":\"BOB\",\"native\":\"Bs\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"692\",\"max_amount\":\"6926834\"},\"BRL\":{\"code\":\"BRL\",\"title\":\"Brazilian Real\",\"symbol\":\"R$\",\"native\":\"R$\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"518\",\"max_amount\":\"5182986\"},\"CAD\":{\"code\":\"CAD\",\"title\":\"Canadian Dollar\",\"symbol\":\"CA$\",\"native\":\"$\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"129\",\"max_amount\":\"1290450\"},\"CHF\":{\"code\":\"CHF\",\"title\":\"Swiss Franc\",\"symbol\":\"CHF\",\"native\":\"CHF\",\"thousands_sep\":\"'\",\"decimal_sep\":\".\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"95\",\"max_amount\":\"954630\"},\"CLP\":{\"code\":\"CLP\",\"title\":\"Chilean Peso\",\"symbol\":\"CLP\",\"native\":\"$\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":true,\"space_between\":true,\"exp\":0,\"min_amount\":\"926\",\"max_amount\":\"9268013\"},\"CNY\":{\"code\":\"CNY\",\"title\":\"Chinese Renminbi Yuan\",\"symbol\":\"CN\",\"native\":\"CN\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"669\",\"max_amount\":\"6692902\"},\"COP\":{\"code\":\"COP\",\"title\":\"Colombian Peso\",\"symbol\":\"COP\",\"native\":\"$\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"410927\",\"max_amount\":\"4109270000\"},\"CRC\":{\"code\":\"CRC\",\"title\":\"Costa Rican Coln\",\"symbol\":\"CRC\",\"native\":\"\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"69166\",\"max_amount\":\"691668622\"},\"CZK\":{\"code\":\"CZK\",\"title\":\"Czech Koruna\",\"symbol\":\"CZK\",\"native\":\"K\",\"thousands_sep\":\" \",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"2367\",\"max_amount\":\"23674601\"},\"DKK\":{\"code\":\"DKK\",\"title\":\"Danish Krone\",\"symbol\":\"DKK\",\"native\":\"kr\",\"thousands_sep\":\"\",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"712\",\"max_amount\":\"7120540\"},\"DOP\":{\"code\":\"DOP\",\"title\":\"Dominican Peso\",\"symbol\":\"DOP\",\"native\":\"$\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"5497\",\"max_amount\":\"54971796\"},\"DZD\":{\"code\":\"DZD\",\"title\":\"Algerian Dinar\",\"symbol\":\"DZD\",\"native\":\"..\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"14655\",\"max_amount\":\"146557782\"},\"EGP\":{\"code\":\"EGP\",\"title\":\"Egyptian Pound\",\"symbol\":\"EGP\",\"native\":\"..\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"1879\",\"max_amount\":\"18794601\"},\"EUR\":{\"code\":\"EUR\",\"title\":\"Euro\",\"symbol\":\"\",\"native\":\"\",\"thousands_sep\":\" \",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"95\",\"max_amount\":\"957150\"},\"GBP\":{\"code\":\"GBP\",\"title\":\"British Pound\",\"symbol\":\"\",\"native\":\"\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"82\",\"max_amount\":\"822531\"},\"GEL\":{\"code\":\"GEL\",\"title\":\"Georgian Lari\",\"symbol\":\"GEL\",\"native\":\"GEL\",\"thousands_sep\":\" \",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"293\",\"max_amount\":\"2939866\"},\"GTQ\":{\"code\":\"GTQ\",\"title\":\"Guatemalan Quetzal\",\"symbol\":\"GTQ\",\"native\":\"Q\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"781\",\"max_amount\":\"7811180\"},\"HKD\":{\"code\":\"HKD\",\"title\":\"Hong Kong Dollar\",\"symbol\":\"HK$\",\"native\":\"$\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"784\",\"max_amount\":\"7845675\"},\"HNL\":{\"code\":\"HNL\",\"title\":\"Honduran Lempira\",\"symbol\":\"HNL\",\"native\":\"L\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"2476\",\"max_amount\":\"24763692\"},\"HRK\":{\"code\":\"HRK\",\"title\":\"Croatian Kuna\",\"symbol\":\"HRK\",\"native\":\"kn\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"721\",\"max_amount\":\"7210988\"},\"HUF\":{\"code\":\"HUF\",\"title\":\"Hungarian Forint\",\"symbol\":\"HUF\",\"native\":\"Ft\",\"thousands_sep\":\" \",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"37819\",\"max_amount\":\"378197939\"},\"IDR\":{\"code\":\"IDR\",\"title\":\"Indonesian Rupiah\",\"symbol\":\"IDR\",\"native\":\"Rp\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"1490695\",\"max_amount\":\"14906950000\"},\"ILS\":{\"code\":\"ILS\",\"title\":\"Israeli New Sheqel\",\"symbol\":\"\",\"native\":\"\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"348\",\"max_amount\":\"3480155\"},\"INR\":{\"code\":\"INR\",\"title\":\"Indian Rupee\",\"symbol\":\"\",\"native\":\"\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"7894\",\"max_amount\":\"78945050\"},\"ISK\":{\"code\":\"ISK\",\"title\":\"Icelandic Krna\",\"symbol\":\"ISK\",\"native\":\"kr\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":0,\"min_amount\":\"133\",\"max_amount\":\"1336303\"},\"JMD\":{\"code\":\"JMD\",\"title\":\"Jamaican Dollar\",\"symbol\":\"JMD\",\"native\":\"$\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"15175\",\"max_amount\":\"151753529\"},\"JPY\":{\"code\":\"JPY\",\"title\":\"Japanese Yen\",\"symbol\":\"\",\"native\":\"\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":0,\"min_amount\":\"136\",\"max_amount\":\"1362010\"},\"KES\":{\"code\":\"KES\",\"title\":\"Kenyan Shilling\",\"symbol\":\"KES\",\"native\":\"Ksh\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"11787\",\"max_amount\":\"117879251\"},\"KGS\":{\"code\":\"KGS\",\"title\":\"Kyrgyzstani Som\",\"symbol\":\"KGS\",\"native\":\"KGS\",\"thousands_sep\":\" \",\"decimal_sep\":\"-\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"7950\",\"max_amount\":\"79509472\"},\"KRW\":{\"code\":\"KRW\",\"title\":\"South Korean Won\",\"symbol\":\"\",\"native\":\"\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":0,\"min_amount\":\"1297\",\"max_amount\":\"12971249\"},\"KZT\":{\"code\":\"KZT\",\"title\":\"Kazakhstani Tenge\",\"symbol\":\"KZT\",\"native\":\"\",\"thousands_sep\":\" \",\"decimal_sep\":\"-\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"47177\",\"max_amount\":\"471777437\"},\"LBP\":{\"code\":\"LBP\",\"title\":\"Lebanese Pound\",\"symbol\":\"LBP\",\"native\":\"..\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"152338\",\"max_amount\":\"1523381760\"},\"LKR\":{\"code\":\"LKR\",\"title\":\"Sri Lankan Rupee\",\"symbol\":\"LKR\",\"native\":\".\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"36271\",\"max_amount\":\"362713465\"},\"MAD\":{\"code\":\"MAD\",\"title\":\"Moroccan Dirham\",\"symbol\":\"MAD\",\"native\":\"..\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"1018\",\"max_amount\":\"10188182\"},\"MDL\":{\"code\":\"MDL\",\"title\":\"Moldovan Leu\",\"symbol\":\"MDL\",\"native\":\"MDL\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"1928\",\"max_amount\":\"19284237\"},\"MNT\":{\"code\":\"MNT\",\"title\":\"Mongolian Tgrg\",\"symbol\":\"MNT\",\"native\":\"MNT\",\"thousands_sep\":\" \",\"decimal_sep\":\",\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"312408\",\"max_amount\":\"3124087599\"},\"MUR\":{\"code\":\"MUR\",\"title\":\"Mauritian Rupee\",\"symbol\":\"MUR\",\"native\":\"MUR\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"4614\",\"max_amount\":\"46144273\"},\"MVR\":{\"code\":\"MVR\",\"title\":\"Maldivian Rufiyaa\",\"symbol\":\"MVR\",\"native\":\"MVR\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"1534\",\"max_amount\":\"15349670\"},\"MXN\":{\"code\":\"MXN\",\"title\":\"Mexican Peso\",\"symbol\":\"MX$\",\"native\":\"$\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"2015\",\"max_amount\":\"20158770\"},\"MYR\":{\"code\":\"MYR\",\"title\":\"Malaysian Ringgit\",\"symbol\":\"MYR\",\"native\":\"RM\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"440\",\"max_amount\":\"4406499\"},\"MZN\":{\"code\":\"MZN\",\"title\":\"Mozambican Metical\",\"symbol\":\"MZN\",\"native\":\"MTn\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"6383\",\"max_amount\":\"63830365\"},\"NGN\":{\"code\":\"NGN\",\"title\":\"Nigerian Naira\",\"symbol\":\"NGN\",\"native\":\"\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"41513\",\"max_amount\":\"415132815\"},\"NIO\":{\"code\":\"NIO\",\"title\":\"Nicaraguan Crdoba\",\"symbol\":\"NIO\",\"native\":\"C$\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"3612\",\"max_amount\":\"36125609\"},\"NOK\":{\"code\":\"NOK\",\"title\":\"Norwegian Krone\",\"symbol\":\"NOK\",\"native\":\"kr\",\"thousands_sep\":\" \",\"decimal_sep\":\",\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"990\",\"max_amount\":\"9902585\"},\"NPR\":{\"code\":\"NPR\",\"title\":\"Nepalese Rupee\",\"symbol\":\"NPR\",\"native\":\"\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"12731\",\"max_amount\":\"127318435\"},\"NZD\":{\"code\":\"NZD\",\"title\":\"New Zealand Dollar\",\"symbol\":\"NZ$\",\"native\":\"$\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"160\",\"max_amount\":\"1603695\"},\"PAB\":{\"code\":\"PAB\",\"title\":\"Panamanian Balboa\",\"symbol\":\"PAB\",\"native\":\"B\\/.\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"100\",\"max_amount\":\"1007566\"},\"PEN\":{\"code\":\"PEN\",\"title\":\"Peruvian Nuevo Sol\",\"symbol\":\"PEN\",\"native\":\"S\\/.\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"381\",\"max_amount\":\"3818809\"},\"PHP\":{\"code\":\"PHP\",\"title\":\"Philippine Peso\",\"symbol\":\"PHP\",\"native\":\"\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"5499\",\"max_amount\":\"54994501\"},\"PKR\":{\"code\":\"PKR\",\"title\":\"Pakistani Rupee\",\"symbol\":\"PKR\",\"native\":\"\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"20651\",\"max_amount\":\"206515440\"},\"PLN\":{\"code\":\"PLN\",\"title\":\"Polish Zoty\",\"symbol\":\"PLN\",\"native\":\"z\",\"thousands_sep\":\" \",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"446\",\"max_amount\":\"4466920\"},\"PYG\":{\"code\":\"PYG\",\"title\":\"Paraguayan Guaran\",\"symbol\":\"PYG\",\"native\":\"\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":true,\"space_between\":true,\"exp\":0,\"min_amount\":\"6909\",\"max_amount\":\"69095662\"},\"QAR\":{\"code\":\"QAR\",\"title\":\"Qatari Riyal\",\"symbol\":\"QAR\",\"native\":\"..\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"364\",\"max_amount\":\"3640988\"},\"RON\":{\"code\":\"RON\",\"title\":\"Romanian Leu\",\"symbol\":\"RON\",\"native\":\"RON\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"473\",\"max_amount\":\"4736501\"},\"RSD\":{\"code\":\"RSD\",\"title\":\"Serbian Dinar\",\"symbol\":\"RSD\",\"native\":\".\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"11252\",\"max_amount\":\"112520089\"},\"RUB\":{\"code\":\"RUB\",\"title\":\"Russian Ruble\",\"symbol\":\"RUB\",\"native\":\".\",\"thousands_sep\":\" \",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"5282\",\"max_amount\":\"52825030\"},\"SAR\":{\"code\":\"SAR\",\"title\":\"Saudi Riyal\",\"symbol\":\"SAR\",\"native\":\"..\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"375\",\"max_amount\":\"3752099\"},\"SEK\":{\"code\":\"SEK\",\"title\":\"Swedish Krona\",\"symbol\":\"SEK\",\"native\":\"kr\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"1022\",\"max_amount\":\"10224070\"},\"SGD\":{\"code\":\"SGD\",\"title\":\"Singapore Dollar\",\"symbol\":\"SGD\",\"native\":\"$\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"139\",\"max_amount\":\"1390698\"},\"THB\":{\"code\":\"THB\",\"title\":\"Thai Baht\",\"symbol\":\"\",\"native\":\"\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"3529\",\"max_amount\":\"35290499\"},\"TJS\":{\"code\":\"TJS\",\"title\":\"Tajikistani Somoni\",\"symbol\":\"TJS\",\"native\":\"TJS\",\"thousands_sep\":\" \",\"decimal_sep\":\";\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"977\",\"max_amount\":\"9773409\"},\"TRY\":{\"code\":\"TRY\",\"title\":\"Turkish Lira\",\"symbol\":\"TRY\",\"native\":\"TL\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"1667\",\"max_amount\":\"16673549\"},\"TTD\":{\"code\":\"TTD\",\"title\":\"Trinidad and Tobago Dollar\",\"symbol\":\"TTD\",\"native\":\"$\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"684\",\"max_amount\":\"6847347\"},\"TWD\":{\"code\":\"TWD\",\"title\":\"New Taiwan Dollar\",\"symbol\":\"NT$\",\"native\":\"NT$\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"2973\",\"max_amount\":\"29735499\"},\"TZS\":{\"code\":\"TZS\",\"title\":\"Tanzanian Shilling\",\"symbol\":\"TZS\",\"native\":\"TSh\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"233200\",\"max_amount\":\"2332000087\"},\"UAH\":{\"code\":\"UAH\",\"title\":\"Ukrainian Hryvnia\",\"symbol\":\"UAH\",\"native\":\"\",\"thousands_sep\":\" \",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":false,\"exp\":2,\"min_amount\":\"2974\",\"max_amount\":\"29741945\"},\"UGX\":{\"code\":\"UGX\",\"title\":\"Ugandan Shilling\",\"symbol\":\"UGX\",\"native\":\"USh\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":0,\"min_amount\":\"3788\",\"max_amount\":\"37883728\"},\"USD\":{\"code\":\"USD\",\"title\":\"United States Dollar\",\"symbol\":\"$\",\"native\":\"$\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":false,\"exp\":2,\"min_amount\":\"100\",\"max_amount\":1000000},\"UYU\":{\"code\":\"UYU\",\"title\":\"Uruguayan Peso\",\"symbol\":\"UYU\",\"native\":\"$\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"3979\",\"max_amount\":\"39794286\"},\"UZS\":{\"code\":\"UZS\",\"title\":\"Uzbekistani Som\",\"symbol\":\"UZS\",\"native\":\"UZS\",\"thousands_sep\":\" \",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":2,\"min_amount\":\"1094209\",\"max_amount\":\"10942099215\"},\"VND\":{\"code\":\"VND\",\"title\":\"Vietnamese ng\",\"symbol\":\"\",\"native\":\"\",\"thousands_sep\":\".\",\"decimal_sep\":\",\",\"symbol_left\":false,\"space_between\":true,\"exp\":0,\"min_amount\":\"23270\",\"max_amount\":\"232700000\"},\"YER\":{\"code\":\"YER\",\"title\":\"Yemeni Rial\",\"symbol\":\"YER\",\"native\":\"..\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"25024\",\"max_amount\":\"250249914\"},\"ZAR\":{\"code\":\"ZAR\",\"title\":\"South African Rand\",\"symbol\":\"ZAR\",\"native\":\"R\",\"thousands_sep\":\",\",\"decimal_sep\":\".\",\"symbol_left\":true,\"space_between\":true,\"exp\":2,\"min_amount\":\"1624\",\"max_amount\":\"16246189\"}};\r\n\r\nexport default Currencies;\r\n","import Currencies from \"../config/currencies\";\r\n\r\n// https://stackoverflow.com/a/34141813\r\nfunction number_format(number: any, decimals: any, dec_point: any, thousands_sep: any): string {\r\n  // Strip all characters but numerical ones.\r\n  number = (number + '').replace(/[^0-9+\\-Ee.]/g, '');\r\n  var n = !isFinite(+number) ? 0 : +number,\r\n      prec = !isFinite(+decimals) ? 0 : Math.abs(decimals),\r\n      sep = (typeof thousands_sep === 'undefined') ? ',' : thousands_sep,\r\n      dec = (typeof dec_point === 'undefined') ? '.' : dec_point,\r\n      s: any = '',\r\n      toFixedFix = function(n: number, prec: number) {\r\n          var k = Math.pow(10, prec);\r\n          return '' + Math.round(n * k) / k;\r\n      };\r\n  // Fix for IE parseFloat(0.55).toFixed(0) = 0;\r\n  s = (prec ? toFixedFix(n, prec) : '' + Math.round(n)).split('.');\r\n  if (s[0].length > 3) {\r\n      s[0] = s[0].replace(/\\B(?=(?:\\d{3})+(?!\\d))/g, sep);\r\n  }\r\n  if ((s[1] || '').length < prec) {\r\n      s[1] = s[1] || '';\r\n      s[1] += new Array(prec - s[1].length + 1).join('0');\r\n  }\r\n  return s.join(dec);\r\n}\r\n\r\nexport default function paymentsWrapCurrencyAmount(amount: number | string, currency: string, skipSymbol?: boolean) {\r\n  amount = +amount;\r\n\r\n  const isNegative = amount < 0;\r\n\r\n  const currencyData = Currencies[currency];\r\n  if(!currencyData) {\r\n    throw new Error('CURRENCY_WRAP_INVALID');\r\n  }\r\n\r\n  const amountExp = amount / Math.pow(10, currencyData.exp);\r\n\r\n  let decimals = currencyData.exp;\r\n  if(currency == 'IRR' && Math.floor(amountExp) == amountExp) {\r\n    decimals = 0; //      = 0     UI\r\n  }\r\n\r\n  let formatted = number_format(amountExp, decimals, currencyData.decimal_sep, currencyData.thousands_sep);\r\n  if(skipSymbol) {\r\n    return formatted;\r\n  }\r\n  \r\n  let symbol = currencyData.symbol;\r\n  if(isNegative && !currencyData.space_between && currencyData.symbol_left) {\r\n    symbol = '-' + symbol;\r\n    formatted = formatted.replace('-', '');\r\n  }\r\n  \r\n  let out: string;\r\n  const splitter = currencyData.space_between ? \" \" : '';\r\n  if(currencyData.symbol_left) {\r\n    out = symbol + splitter + formatted;\r\n  } else {\r\n    out = formatted + splitter + symbol;\r\n  }\r\n  return out;\r\n}\r\n\r\n(window as any).p = paymentsWrapCurrencyAmount;\r\n\r\n// function paymentsGetCurrencyExp($currency: string) {\r\n//   if($currency == 'CLF') {\r\n//     return 4;\r\n//   }\r\n//   if(['BHD','IQD','JOD','KWD','LYD','OMR','TND'].includes($currency)) {\r\n//     return 3;\r\n//   }\r\n//   if(['BIF','BYR','CLP','CVE','DJF','GNF','ISK','JPY','KMF','KRW','MGA', 'PYG','RWF','UGX','UYI','VND','VUV','XAF','XOF','XPF'].includes($currency)) {\r\n//     return 0;\r\n//   }\r\n//   if($currency == 'MRO') {\r\n//     return 1;\r\n//   }\r\n//   return 2;\r\n// }\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Message, MessageAction } from \"../../layer\";\r\nimport wrapUrl from \"../../lib/richTextProcessor/wrapUrl\";\r\n\r\nexport default function wrapJoinVoiceChatAnchor(message: Message.messageService) {\r\n  const action = message.action as MessageAction.messageActionInviteToGroupCall;\r\n  const {onclick, url} = wrapUrl(`tg://voicechat?chat_id=${message.peerId.toChatId()}&id=${action.call.id}&access_hash=${action.call.access_hash}`);\r\n  if(!onclick) {\r\n    return document.createElement('span');\r\n  }\r\n  \r\n  const a = document.createElement('a');\r\n  a.href = url;\r\n  a.setAttribute('onclick', onclick + '(this)');\r\n\r\n  return a;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport { formatTime } from \"../../helpers/date\";\r\nimport htmlToSpan from \"../../helpers/dom/htmlToSpan\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport formatCallDuration from \"../../helpers/formatCallDuration\";\r\nimport paymentsWrapCurrencyAmount from \"../../helpers/paymentsWrapCurrencyAmount\";\r\nimport { Message, MessageAction } from \"../../layer\";\r\nimport { MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport I18n, { FormatterArgument, FormatterArguments, i18n, join, langPack, LangPackKey, _i18n } from \"../../lib/langPack\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapPlainText from \"../../lib/richTextProcessor/wrapPlainText\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport getPeerTitle from \"./getPeerTitle\";\r\nimport wrapJoinVoiceChatAnchor from \"./joinVoiceChatAnchor\";\r\nimport wrapMessageForReply from \"./messageForReply\";\r\n\r\nasync function wrapLinkToMessage(message: Message.message | Message.messageService, plain?: boolean) {\r\n  const a = document.createElement('i');\r\n  a.dataset.savedFrom = message.peerId + '_' + message.mid;\r\n  a.dir = 'auto';\r\n  a.append(await wrapMessageForReply(message, undefined, undefined, plain as any));\r\n  return a;\r\n}\r\n\r\nexport default async function wrapMessageActionTextNewUnsafe(message: MyMessage, plain?: boolean) {\r\n  const element: HTMLElement = plain ? undefined : document.createElement('span');\r\n  const action = 'action' in message && message.action;\r\n\r\n  // this.log('message action:', action);\r\n\r\n  if((action as MessageAction.messageActionCustomAction).message) {\r\n    const unsafeMessage = (action as MessageAction.messageActionCustomAction).message;\r\n    if(plain) {\r\n      return wrapPlainText(unsafeMessage);\r\n    } else {\r\n      setInnerHTML(element, wrapRichText(unsafeMessage, {noLinebreaks: true}));\r\n      return element;\r\n    }\r\n  } else {\r\n    let _ = action._;\r\n    //let suffix = '';\r\n    let langPackKey: LangPackKey;\r\n    let args: Array<FormatterArgument | Promise<FormatterArgument>>;\r\n\r\n    const managers = rootScope.managers;\r\n\r\n    const getNameDivHTML = async(peerId: PeerId, plain: boolean) => {\r\n      return plain ? getPeerTitle(peerId, plain) : (new PeerTitle({peerId})).element;\r\n    };\r\n\r\n    switch(action._) {\r\n      case 'messageActionPhoneCall': {\r\n        _ += '.' + (action as any).type;\r\n\r\n        args = [formatCallDuration(action.duration, plain)];\r\n        break;\r\n      }\r\n\r\n      case 'messageActionGroupCall': {\r\n        _ += '.' + (action as any).type;\r\n\r\n        args = [];\r\n        if(!_.endsWith('You') && !message.pFlags.post) {\r\n          args.push(getNameDivHTML(message.fromId, plain));\r\n        }\r\n\r\n        if(action.duration !== undefined) {\r\n          args.push(formatCallDuration(action.duration, plain));\r\n        } else {\r\n          args.push(wrapJoinVoiceChatAnchor(message as any));\r\n        }\r\n\r\n        break;\r\n      }\r\n\r\n      case 'messageActionInviteToGroupCall': {\r\n        const peerIds = [message.fromId, action.users[0].toPeerId()];\r\n        let a = 'Chat.Service.VoiceChatInvitation';\r\n        const myId = rootScope.myId;\r\n        if(peerIds[0] === myId) a += 'ByYou';\r\n        else if(peerIds[1] === myId) a += 'ForYou';\r\n        indexOfAndSplice(peerIds, myId);\r\n\r\n        langPackKey = a as LangPackKey;\r\n        args = peerIds.map((peerId) => getNameDivHTML(peerId, plain));\r\n        args.push(wrapJoinVoiceChatAnchor(message as any));\r\n        break;\r\n      }\r\n\r\n      case 'messageActionGroupCallScheduled': {\r\n        const today = new Date();\r\n        const date = new Date(action.schedule_date * 1000);\r\n        const daysToStart = (date.getTime() - today.getTime()) / 86400e3;\r\n        const tomorrowDate = new Date(today);\r\n        tomorrowDate.setDate(tomorrowDate.getDate() + 1);\r\n\r\n        const isBroadcast = await managers.appPeersManager.isBroadcast(message.peerId);\r\n        langPackKey = isBroadcast ? 'ChatList.Service.VoiceChatScheduled.Channel' : 'ChatList.Service.VoiceChatScheduled';\r\n        args = [];\r\n        const myId = rootScope.myId;\r\n        if(message.fromId === myId) {\r\n          langPackKey += 'You';\r\n        } else if(!isBroadcast) {\r\n          args.push(getNameDivHTML(message.fromId, plain));\r\n        }\r\n\r\n        let k: LangPackKey, _args: FormatterArguments = [];\r\n        if(daysToStart < 1 && date.getDate() === today.getDate()) {\r\n          k = 'TodayAtFormattedWithToday';\r\n        } else if(daysToStart < 2 && date.getDate() === tomorrowDate.getDate()) {\r\n          k = 'Time.TomorrowAt';\r\n        } else {\r\n          k = 'formatDateAtTime';\r\n          _args.push(new I18n.IntlDateElement({\r\n            date, \r\n            options: {\r\n              day: '2-digit',\r\n              month: '2-digit',\r\n              year: '2-digit'\r\n            }\r\n          }).element);\r\n        }\r\n\r\n        _args.push(formatTime(date));\r\n        const t = i18n(k, _args);\r\n        args.push(t);\r\n\r\n        break;\r\n      }\r\n\r\n      case 'messageActionChatCreate': {\r\n        const myId = rootScope.myId;\r\n        if(message.fromId === myId) {\r\n          _ += 'You';\r\n        } else {\r\n          args = [getNameDivHTML(message.fromId, plain)];\r\n        }\r\n        \r\n        break;\r\n      }\r\n\r\n      case 'messageActionPinMessage': {\r\n        const peerId = message.peerId;\r\n        const pinnedMessage = await managers.appMessagesManager.getMessageByPeer(peerId, message.reply_to_mid);\r\n\r\n        args = [\r\n          getNameDivHTML(message.fromId, plain),\r\n        ];\r\n        \r\n        if(!pinnedMessage/*  || true */) {\r\n          langPackKey = 'ActionPinnedNoText';\r\n\r\n          if(message.reply_to_mid) { // refresh original message\r\n            managers.appMessagesManager.fetchMessageReplyTo(message);\r\n          }\r\n        } else {\r\n          args.push(wrapLinkToMessage(pinnedMessage, plain));\r\n        }\r\n\r\n        break;\r\n      }\r\n\r\n      case 'messageActionChatJoinedByRequest': {\r\n        const isBroadcast = await managers.appPeersManager.isBroadcast(message.peerId);\r\n        if(message.pFlags.out) {\r\n          langPackKey = isBroadcast ? 'RequestToJoinChannelApproved' : 'RequestToJoinGroupApproved';\r\n        } else {\r\n          langPackKey = isBroadcast ? 'ChatService.UserJoinedChannelByRequest' : 'ChatService.UserJoinedGroupByRequest';\r\n          args = [getNameDivHTML(message.fromId, plain)];\r\n        }\r\n        break;\r\n      }\r\n\r\n      case 'messageActionContactSignUp':\r\n      case 'messageActionChatReturn':\r\n      case 'messageActionChatLeave':\r\n      case 'messageActionChatJoined':\r\n      case 'messageActionChatEditPhoto':\r\n      case 'messageActionChatDeletePhoto':\r\n      case 'messageActionChatEditVideo':\r\n      case 'messageActionChatJoinedByLink':\r\n      case 'messageActionChannelEditVideo':\r\n      case 'messageActionChannelDeletePhoto': {\r\n        args = [getNameDivHTML(message.fromId, plain)];\r\n        break;\r\n      }\r\n\r\n      case 'messageActionChannelEditTitle':\r\n      case 'messageActionChatEditTitle': {\r\n        args = [];\r\n        if(action._ === 'messageActionChatEditTitle') {\r\n          args.push(getNameDivHTML(message.fromId, plain));\r\n        }\r\n\r\n        args.push(plain ? action.title : htmlToSpan(wrapEmojiText(action.title)));\r\n        break;\r\n      }\r\n\r\n      case 'messageActionChatDeleteUser':\r\n      case 'messageActionChatAddUsers':\r\n      case 'messageActionChatAddUser': {\r\n        const users = (action as MessageAction.messageActionChatAddUser).users \r\n          || [(action as MessageAction.messageActionChatDeleteUser).user_id];\r\n\r\n        args = [getNameDivHTML(message.fromId, plain)];\r\n\r\n        if(users.length > 1) {\r\n          const joined = join(\r\n            await Promise.all(users.map((userId: UserId) => getNameDivHTML(userId.toPeerId(), plain))),\r\n            false,\r\n            plain\r\n          );\r\n          \r\n          if(plain) {\r\n            args.push(...joined);\r\n          } else {\r\n            const fragment = document.createElement('span');\r\n            fragment.append(...joined);\r\n            args.push(fragment);\r\n          }\r\n        } else {\r\n          args.push(getNameDivHTML(users[0].toPeerId(), plain));\r\n        }\r\n\r\n        break;\r\n      }\r\n\r\n      case 'messageActionBotAllowed': {\r\n        const anchorHTML = wrapRichText(action.domain, {\r\n          entities: [{\r\n            _: 'messageEntityUrl',\r\n            length: action.domain.length,\r\n            offset: 0\r\n          }]\r\n        });\r\n\r\n        const node = htmlToSpan(anchorHTML);\r\n\r\n        args = [node];\r\n        break;\r\n      }\r\n\r\n      case 'messageActionPaymentSent': {\r\n        langPackKey = 'PaymentSuccessfullyPaidNoItem';\r\n        const price = paymentsWrapCurrencyAmount(action.total_amount, action.currency);\r\n        args = [price, getNameDivHTML(message.peerId, plain)];\r\n\r\n        if(message.reply_to_mid) {\r\n          const invoiceMessage = await managers.appMessagesManager.getMessageByPeer(\r\n            message.reply_to?.reply_to_peer_id ? getPeerId(message.reply_to.reply_to_peer_id) : message.peerId, \r\n            message.reply_to_mid\r\n          );\r\n          \r\n          if(!invoiceMessage) {\r\n            managers.appMessagesManager.fetchMessageReplyTo(message);\r\n          } else {\r\n            langPackKey = 'PaymentSuccessfullyPaid';\r\n            args.push(wrapLinkToMessage(invoiceMessage, plain).then((el) => {\r\n              el.classList.add('is-receipt-link');\r\n              return el;\r\n            }));\r\n          }\r\n        }\r\n\r\n        break;\r\n      }\r\n\r\n      default:\r\n        langPackKey = (langPack[_] || `[${action._}]`) as any;\r\n        break;\r\n    }\r\n\r\n    if(!langPackKey) {\r\n      langPackKey = langPack[_];\r\n      if(langPackKey === undefined) {\r\n        langPackKey = '[' + _ + ']' as any;\r\n      }\r\n    }\r\n\r\n    const waited = args && await Promise.all(args);\r\n\r\n    if(plain) {\r\n      return I18n.format(langPackKey, true, waited);\r\n    } else {\r\n      return _i18n(element, langPackKey, waited);\r\n    }\r\n\r\n    //str = !langPackKey || langPackKey[0].toUpperCase() === langPackKey[0] ? langPackKey : getNameDivHTML(message.fromId) + langPackKey + (suffix ? ' ' : '');\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\nimport wrapMessageActionTextNewUnsafe from \"./messageActionTextNewUnsafe\";\r\n\r\nexport default async function wrapMessageActionTextNew(message: MyMessage, plain: true): Promise<string>;\r\nexport default async function wrapMessageActionTextNew(message: MyMessage, plain?: false): Promise<HTMLElement>;\r\nexport default async function wrapMessageActionTextNew(message: MyMessage, plain: boolean): Promise<HTMLElement | string>;\r\nexport default async function wrapMessageActionTextNew(message: MyMessage, plain?: boolean): Promise<HTMLElement | string> {\r\n  try {\r\n    return await wrapMessageActionTextNewUnsafe(message, plain);\r\n  } catch(err) {\r\n    console.error('wrapMessageActionTextNewUnsafe error:', err);\r\n    return plain ? '' : document.createElement('span');\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport htmlToDocumentFragment from \"../../helpers/dom/htmlToDocumentFragment\";\r\nimport { getRestrictionReason } from \"../../helpers/restrictions\";\r\nimport escapeRegExp from \"../../helpers/string/escapeRegExp\";\r\nimport limitSymbols from \"../../helpers/string/limitSymbols\";\r\nimport { Message, DocumentAttribute } from \"../../layer\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport { MyDraftMessage } from \"../../lib/appManagers/appDraftsManager\";\r\nimport { MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\nimport isMessageRestricted from \"../../lib/appManagers/utils/messages/isMessageRestricted\";\r\nimport I18n, { LangPackKey, i18n, UNSUPPORTED_LANG_PACK_KEY } from \"../../lib/langPack\";\r\nimport sortEntities from \"../../lib/richTextProcessor/sortEntities\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapPlainText from \"../../lib/richTextProcessor/wrapPlainText\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport wrapMessageActionTextNew from \"./messageActionTextNew\";\r\n\r\nexport default async function wrapMessageForReply(message: MyMessage | MyDraftMessage, text: string, usingMids: number[], plain: true, highlightWord?: string, withoutMediaType?: boolean): Promise<string>;\r\nexport default async function wrapMessageForReply(message: MyMessage | MyDraftMessage, text?: string, usingMids?: number[], plain?: false, highlightWord?: string, withoutMediaType?: boolean): Promise<DocumentFragment>;\r\nexport default async function wrapMessageForReply(message: MyMessage | MyDraftMessage, text: string = (message as Message.message).message, usingMids?: number[], plain?: boolean, highlightWord?: string, withoutMediaType?: boolean): Promise<DocumentFragment | string> {\r\n  const parts: (Node | string)[] = [];\r\n\r\n  let hasAlbumKey = false;\r\n  const addPart = (langKey: LangPackKey, part?: string | HTMLElement | DocumentFragment) => {\r\n    if(langKey) {\r\n      if(part === undefined && hasAlbumKey) {\r\n        return;\r\n      }\r\n      \r\n      part = plain ? I18n.format(langKey, true) : i18n(langKey);\r\n    }\r\n    \r\n    if(plain) {\r\n      parts.push(part);\r\n    } else {\r\n      const el = document.createElement('i');\r\n      if(typeof(part) === 'string') el.innerHTML = part;\r\n      else el.append(part);\r\n      parts.push(el);\r\n    }\r\n  };\r\n\r\n  const managers = rootScope.managers;\r\n  const appMessagesManager = managers.appMessagesManager;\r\n\r\n  const isRestricted = isMessageRestricted(message as any);\r\n\r\n  let entities = (message as Message.message).totalEntities;\r\n  if((message as Message.message).media && !isRestricted) {\r\n    assumeType<Message.message>(message);\r\n    let usingFullAlbum = true;\r\n    if(message.grouped_id) {\r\n      if(usingMids) {\r\n        const mids = await appMessagesManager.getMidsByMessage(message);\r\n        if(usingMids.length === mids.length) {\r\n          for(const mid of mids) {\r\n            if(!usingMids.includes(mid)) {\r\n              usingFullAlbum = false;\r\n              break;\r\n            }\r\n          }\r\n        } else {\r\n          usingFullAlbum = false;\r\n        }\r\n      }\r\n\r\n      if(usingFullAlbum) {\r\n        const albumText = await appMessagesManager.getAlbumText(message.grouped_id);\r\n        text = albumText.message;\r\n        entities = albumText.totalEntities;\r\n\r\n        if(!withoutMediaType) {\r\n          addPart('AttachAlbum');\r\n          hasAlbumKey = true;\r\n        }\r\n      }\r\n    } else {\r\n      usingFullAlbum = false;\r\n    }\r\n\r\n    if((!usingFullAlbum && !withoutMediaType) || !text) {\r\n      const media = message.media;\r\n      switch(media._) {\r\n        case 'messageMediaPhoto':\r\n          addPart('AttachPhoto');\r\n          break;\r\n        case 'messageMediaDice':\r\n          addPart(undefined, plain ? media.emoticon : wrapEmojiText(media.emoticon));\r\n          break;\r\n        case 'messageMediaVenue': {\r\n          text = media.title;\r\n          addPart('AttachLocation');\r\n          break;\r\n        }\r\n        case 'messageMediaGeo':\r\n          addPart('AttachLocation');\r\n          break;\r\n        case 'messageMediaGeoLive':\r\n          addPart('AttachLiveLocation');\r\n          break;\r\n        case 'messageMediaPoll':\r\n          const f = '' + ' ' + (media.poll.question || 'poll');\r\n          addPart(undefined, plain ? f : wrapEmojiText(f));\r\n          break;\r\n        case 'messageMediaContact':\r\n          addPart('AttachContact');\r\n          break;\r\n        case 'messageMediaGame': {\r\n          const f = '' + ' ' + media.game.title;\r\n          addPart(undefined, plain ? f : wrapEmojiText(f));\r\n          break;\r\n        }\r\n        case 'messageMediaDocument': {\r\n          const document = media.document as MyDocument;\r\n\r\n          if(document.type === 'video') {\r\n            addPart('AttachVideo');\r\n          } else if(document.type === 'voice') {\r\n            addPart('AttachAudio');\r\n          } else if(document.type === 'gif') {\r\n            addPart('AttachGif');\r\n          } else if(document.type === 'round') {\r\n            addPart('AttachRound');\r\n          } else if(document.type === 'sticker') {\r\n            const i = parts.length;\r\n            if(document.stickerEmojiRaw) {\r\n              const f = document.stickerEmojiRaw + ' ';\r\n              addPart(undefined, plain ? f : wrapEmojiText(f));\r\n            }\r\n            \r\n            addPart('AttachSticker');\r\n\r\n            // will combine two parts into one\r\n            const p = parts.splice(i, 2);\r\n            if(plain) parts.push((p[0] as string) + (p[1] as string));\r\n            else {\r\n              const span = window.document.createElement('span');\r\n              span.append(...p);\r\n              parts.push(span);\r\n            }\r\n\r\n            text = '';\r\n          } else if(document.type === 'audio') {\r\n            const attribute = document.attributes.find((attribute) => attribute._ === 'documentAttributeAudio' && (attribute.title || attribute.performer)) as DocumentAttribute.documentAttributeAudio;\r\n            const f = '' + ' ' + (attribute ? [attribute.title, attribute.performer].filter(Boolean).join(' - ') : document.file_name);\r\n            addPart(undefined, plain ? f : wrapEmojiText(f));\r\n          } else {\r\n            addPart(undefined, plain ? document.file_name : wrapEmojiText(document.file_name));\r\n          }\r\n\r\n          break;\r\n        }\r\n\r\n        case 'messageMediaInvoice': {\r\n          addPart(undefined, plain ? media.title : wrapEmojiText(media.title));\r\n          break;\r\n        }\r\n\r\n        case 'messageMediaUnsupported': {\r\n          addPart(UNSUPPORTED_LANG_PACK_KEY);\r\n          break;\r\n        }\r\n\r\n        default:\r\n          //messageText += media._;\r\n          ///////appMessagesManager.log.warn('Got unknown media type!', message);\r\n          break;\r\n      }\r\n    }\r\n\r\n    const length = parts.length;\r\n    for(let i = 1; i < length; i += 2) {\r\n      parts.splice(i, 0, ', ');\r\n    }\r\n\r\n    if(text && length) {\r\n      parts.push(', ');\r\n    }\r\n  }\r\n\r\n  if((message as Message.messageService).action) {\r\n    const actionWrapped = await wrapMessageActionTextNew((message as Message.messageService), plain);\r\n    if(actionWrapped) {\r\n      addPart(undefined, actionWrapped);\r\n    }\r\n  }\r\n\r\n  if(isRestricted) {\r\n    text = getRestrictionReason((message as Message.message).restriction_reason).text;\r\n    entities = [];\r\n  }\r\n\r\n  if(text) {\r\n    text = limitSymbols(text, 100);\r\n\r\n    if(!entities) {\r\n      entities = [];\r\n    }\r\n\r\n    if(plain) {\r\n      parts.push(wrapPlainText(text, entities));\r\n    } else {\r\n      // let entities = parseEntities(text.replace(/\\n/g, ' '));\r\n\r\n      if(highlightWord) {\r\n        highlightWord = highlightWord.trim();\r\n        let found = false;\r\n        let match: any;\r\n        let regExp = new RegExp(escapeRegExp(highlightWord), 'gi');\r\n        entities = entities.slice(); // fix leaving highlight entity\r\n        while((match = regExp.exec(text)) !== null) {\r\n          entities.push({_: 'messageEntityHighlight', length: highlightWord.length, offset: match.index});\r\n          found = true;\r\n        }\r\n    \r\n        if(found) {\r\n          sortEntities(entities);\r\n        }\r\n      }\r\n\r\n      const messageWrapped = wrapRichText(text, {\r\n        noLinebreaks: true, \r\n        entities, \r\n        noLinks: true,\r\n        noTextFormat: true\r\n      });\r\n\r\n      parts.push(htmlToDocumentFragment(messageWrapped));\r\n    }\r\n  }\r\n\r\n  if(plain) {\r\n    return parts.join('');\r\n  } else {\r\n    const fragment = document.createDocumentFragment();\r\n    fragment.append(...parts);\r\n    return fragment;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport limitSymbols from \"../../helpers/string/limitSymbols\";\r\nimport appImManager, { CHAT_ANIMATION_GROUP } from \"../../lib/appManagers/appImManager\";\r\nimport choosePhotoSize from \"../../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport DivAndCaption from \"../divAndCaption\";\r\nimport { wrapPhoto, wrapSticker } from \"../wrappers\";\r\nimport wrapMessageForReply from \"../wrappers/messageForReply\";\r\n\r\nconst MEDIA_SIZE = 32;\r\n\r\nexport async function wrapReplyDivAndCaption(options: {\r\n  title: string | HTMLElement | DocumentFragment,\r\n  titleEl: HTMLElement,\r\n  subtitle: string | HTMLElement | DocumentFragment,\r\n  subtitleEl: HTMLElement,\r\n  message: any,\r\n  mediaEl: HTMLElement,\r\n  loadPromises?: Promise<any>[]\r\n}) {\r\n  let {title, titleEl, subtitle, subtitleEl, mediaEl, message, loadPromises} = options;\r\n  if(title !== undefined) {\r\n    if(typeof(title) === 'string') {\r\n      title = limitSymbols(title, 140);\r\n      title = wrapEmojiText(title);\r\n    }\r\n\r\n    replaceContent(titleEl, title);\r\n  }\r\n\r\n  if(!loadPromises) {\r\n    loadPromises = [];\r\n  }\r\n\r\n  let media = message && message.media;\r\n  let setMedia = false, isRound = false;\r\n  const mediaChildren = mediaEl ? Array.from(mediaEl.children).slice() : [];\r\n  let middleware: () => boolean;\r\n  if(media && mediaEl) {\r\n    subtitleEl.textContent = '';\r\n    subtitleEl.append(await wrapMessageForReply(message, undefined, undefined, undefined, undefined, true));\r\n\r\n    //console.log('wrap reply', media);\r\n\r\n    if(media.webpage) {\r\n      media = media.webpage;\r\n    }\r\n    \r\n    if(media.photo || (media.document && media.document.thumbs?.length)/* ['video', 'sticker', 'gif', 'round', 'photo', 'audio'].indexOf(media.document.type) !== -1) */) {\r\n      middleware = appImManager.chat.bubbles.getMiddleware();\r\n      const lazyLoadQueue = appImManager.chat.bubbles.lazyLoadQueue;\r\n\r\n      if(media.document?.type === 'sticker') {\r\n        setMedia = true;\r\n        await wrapSticker({\r\n          doc: media.document,\r\n          div: mediaEl,\r\n          lazyLoadQueue,\r\n          group: CHAT_ANIMATION_GROUP,\r\n          //onlyThumb: media.document.sticker === 2,\r\n          width: MEDIA_SIZE,\r\n          height: MEDIA_SIZE,\r\n          middleware,\r\n          loadPromises\r\n        });\r\n      } else {\r\n        const photo = media.photo || media.document;\r\n\r\n        isRound = photo.type === 'round';\r\n\r\n        try {\r\n          await wrapPhoto({\r\n            photo,\r\n            container: mediaEl,\r\n            boxWidth: MEDIA_SIZE,\r\n            boxHeight: MEDIA_SIZE,\r\n            size: choosePhotoSize(photo, MEDIA_SIZE, MEDIA_SIZE),\r\n            middleware,\r\n            lazyLoadQueue,\r\n            noBlur: true,\r\n            withoutPreloader: true,\r\n            loadPromises\r\n          });\r\n          setMedia = true;\r\n        } catch(err) {\r\n\r\n        }\r\n      }\r\n    }\r\n  } else {\r\n    if(message) {\r\n      subtitleEl.textContent = '';\r\n      subtitleEl.append(await wrapMessageForReply(message));\r\n    } else {\r\n      if(typeof(subtitle) === 'string') {\r\n        subtitle = limitSymbols(subtitle, 140);\r\n        subtitle = wrapEmojiText(subtitle);\r\n      }\r\n\r\n      replaceContent(subtitleEl, subtitle || '');\r\n    }\r\n  }\r\n\r\n  Promise.all(loadPromises).then(() => {\r\n    if(middleware && !middleware()) return;\r\n    mediaChildren.forEach((child) => child.remove());\r\n\r\n    if(mediaEl) {\r\n      mediaEl.classList.toggle('is-round', isRound);\r\n    }\r\n  });\r\n\r\n  return setMedia;\r\n}\r\n\r\nexport default class ReplyContainer extends DivAndCaption<(title: string | HTMLElement | DocumentFragment, subtitle: string | HTMLElement | DocumentFragment, message?: any) => Promise<void>> {\r\n  private mediaEl: HTMLElement;\r\n\r\n  constructor(protected className: string) {\r\n    super(className, async(title, subtitle = '', message?) => {\r\n      if(!this.mediaEl) {\r\n        this.mediaEl = document.createElement('div');\r\n        this.mediaEl.classList.add(this.className + '-media');\r\n      }\r\n\r\n      const isMediaSet = await wrapReplyDivAndCaption({\r\n        title,\r\n        titleEl: this.title,\r\n        subtitle,\r\n        subtitleEl: this.subtitle,\r\n        mediaEl: this.mediaEl,\r\n        message\r\n      });\r\n      \r\n      this.container.classList.toggle('is-media', isMediaSet);\r\n      if(isMediaSet) {\r\n        this.content.prepend(this.mediaEl);\r\n      } else {\r\n        this.mediaEl.remove();\r\n      }\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { hexToRgb } from \"../../helpers/color\";\r\nimport { Message } from \"../../layer\";\r\nimport getPeerColorById from \"../../lib/appManagers/utils/peers/getPeerColorById\";\r\nimport ReplyContainer from \"../chat/replyContainer\";\r\n\r\nexport default function wrapReply(\r\n  title: Parameters<ReplyContainer['fill']>[0], \r\n  subtitle: Parameters<ReplyContainer['fill']>[1], \r\n  message?: Message.message | Message.messageService,\r\n  setColorPeerId?: PeerId\r\n) {\r\n  const replyContainer = new ReplyContainer('reply');\r\n  const fillPromise = replyContainer.fill(title, subtitle, message);\r\n\r\n  if(setColorPeerId) {\r\n    const hex = getPeerColorById(setColorPeerId, false);\r\n    const [r, g, b] = hexToRgb(hex);\r\n    replyContainer.container.style.setProperty('--override-color', `${r}, ${g}, ${b}`);\r\n    replyContainer.container.classList.add('is-overriding-color');\r\n    // replyContainer.border.style.backgroundColor = hex;\r\n    // replyContainer.title.style.color = hex;\r\n  }\r\n\r\n  return {container: replyContainer.container, fillPromise};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport createVideo from \"../../helpers/dom/createVideo\";\r\nimport renderImageFromUrl from \"../../helpers/dom/renderImageFromUrl\";\r\nimport { StickerSet } from \"../../layer\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport lottieLoader from \"../../lib/rlottie/lottieLoader\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport wrapSticker from \"./sticker\";\r\n\r\nexport default async function wrapStickerSetThumb({set, lazyLoadQueue, container, group, autoplay, width, height, managers = rootScope.managers}: {\r\n  set: StickerSet.stickerSet,\r\n  lazyLoadQueue: LazyLoadQueue,\r\n  container: HTMLElement,\r\n  group: string,\r\n  autoplay: boolean,\r\n  width: number,\r\n  height: number,\r\n  managers?: AppManagers\r\n}) {\r\n  if(set.thumbs?.length) {\r\n    container.classList.add('media-sticker-wrapper');\r\n    lazyLoadQueue.push({\r\n      div: container,\r\n      load: async() => {\r\n        const downloadOptions = await managers.appStickersManager.getStickerSetThumbDownloadOptions(set);\r\n        const promise = appDownloadManager.download(downloadOptions);\r\n\r\n        if(set.pFlags.animated && !set.pFlags.videos) {\r\n          return promise\r\n          .then((blob) => {\r\n            lottieLoader.loadAnimationWorker({\r\n              container,\r\n              loop: true,\r\n              autoplay,\r\n              animationData: blob,\r\n              width,\r\n              height,\r\n              needUpscale: true,\r\n              name: 'setThumb' + set.id\r\n            }, group);\r\n          });\r\n        } else {\r\n          let media: HTMLElement;\r\n          if(set.pFlags.videos) {\r\n            media = createVideo();\r\n            (media as HTMLVideoElement).autoplay = true;\r\n            (media as HTMLVideoElement).muted = true;\r\n            (media as HTMLVideoElement).loop = true;\r\n          } else {\r\n            media = new Image();\r\n          }\r\n\r\n          media.classList.add('media-sticker');\r\n  \r\n          return promise.then((blob) => {\r\n            renderImageFromUrl(media, URL.createObjectURL(blob), () => {\r\n              container.append(media);\r\n\r\n              if(set.pFlags.videos) {\r\n                animationIntersector.addAnimation(media as HTMLVideoElement, group);\r\n              }\r\n            });\r\n          });\r\n        }\r\n      }\r\n    });\r\n\r\n    return;\r\n  }\r\n\r\n  const promise = managers.appStickersManager.getStickerSet(set);\r\n  const stickerSet = await promise;\r\n  if(stickerSet.documents[0]._ !== 'documentEmpty') { // as thumb will be used first sticker\r\n    wrapSticker({\r\n      doc: stickerSet.documents[0],\r\n      div: container, \r\n      group: group,\r\n      lazyLoadQueue,\r\n      managers,\r\n      width,\r\n      height\r\n    }); // kostil\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport Row from \"../row\";\r\nimport wrapSticker from \"./sticker\";\r\n\r\nexport default function wrapStickerToRow({doc, row, size, managers}: {\r\n  doc: MyDocument,\r\n  row: Row,\r\n  size?: 'small' | 'large',\r\n  managers?: AppManagers\r\n}) {\r\n  const previousMedia = row.media;\r\n  const media = row.createMedia('small');\r\n\r\n  if(previousMedia) {\r\n    media.classList.add('hide');\r\n  }\r\n\r\n  const loadPromises: Promise<any>[] = previousMedia ? [] : undefined;\r\n\r\n  const _size = size === 'small' ? 32 : 48;\r\n  const result = wrapSticker({\r\n    div: media,\r\n    doc: doc,\r\n    width: _size,\r\n    height: _size,\r\n    loadPromises,\r\n    managers\r\n  }).then(({render}) => render);\r\n\r\n  loadPromises && Promise.all(loadPromises).then(() => {\r\n    media.classList.remove('hide');\r\n    previousMedia.remove();\r\n  });\r\n\r\n  return result;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport whichChild from \"./whichChild\";\r\n\r\nexport default function positionElementByIndex(element: HTMLElement, container: HTMLElement, pos: number, prevPos?: number) {\r\n  if(prevPos === undefined) {\r\n    prevPos = element.parentElement === container ? whichChild(element) : -1;\r\n  }\r\n\r\n  if(prevPos === pos) {\r\n    return false;\r\n  } else if(prevPos !== -1 && prevPos < pos) { // was higher\r\n    pos += 1;\r\n  }\r\n\r\n  if(!pos) {\r\n    container.prepend(element);\r\n  } else if(container.childElementCount > pos) {\r\n    container.insertBefore(element, container.children[pos]);\r\n  } else {\r\n    container.append(element);\r\n  }\r\n\r\n  return true;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport insertInDescendSortedArray from \"./array/insertInDescendSortedArray\";\r\nimport { getMiddleware } from \"./middleware\";\r\nimport safeAssign from \"./object/safeAssign\";\r\n\r\nexport type SortedElementId = PeerId;\r\nexport type SortedElementBase = {\r\n  id: SortedElementId, \r\n  index: number\r\n};\r\n\r\nexport default class SortedList<SortedElement extends SortedElementBase> {\r\n  protected elements: Map<SortedElementId, SortedElement>;\r\n  protected sorted: Array<SortedElement>;\r\n\r\n  protected getIndex: (element: SortedElement) => PromiseLike<number> | number;\r\n  protected onDelete: (element: SortedElement) => void;\r\n  protected onUpdate: (element: SortedElement) => void;\r\n  protected onSort: (element: SortedElement, idx: number) => void;\r\n  protected onElementCreate: (base: SortedElementBase, batch: boolean) => SortedElement;\r\n\r\n  protected updateElementWith = (callback: () => void) => callback();\r\n  protected updateListWith = (callback: (canUpdate: boolean | undefined) => void) => callback(true);\r\n\r\n  protected middleware = getMiddleware();\r\n\r\n  constructor(options: {\r\n    getIndex: SortedList<SortedElement>['getIndex'],\r\n    onDelete?: SortedList<SortedElement>['onDelete'],\r\n    onUpdate?: SortedList<SortedElement>['onUpdate'],\r\n    onSort?: SortedList<SortedElement>['onSort'],\r\n    onElementCreate: SortedList<SortedElement>['onElementCreate'],\r\n\r\n    updateElementWith?: SortedList<SortedElement>['updateElementWith'],\r\n    updateListWith?: SortedList<SortedElement>['updateListWith']\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    this.elements = new Map();\r\n    this.sorted = [];\r\n  }\r\n\r\n  public clear() {\r\n    this.middleware.clean();\r\n    this.elements.clear();\r\n    this.sorted.length = 0;\r\n  }\r\n\r\n  protected _updateList() {\r\n    this.elements.forEach((element) => {\r\n      this.update(element.id, true);\r\n    });\r\n\r\n    if(this.onSort) {\r\n      this.sorted.forEach((element, idx) => {\r\n        this.onSort(element, idx);\r\n      });\r\n    }\r\n  }\r\n\r\n  public updateList(callback: (updated: boolean) => void) {\r\n    const middleware = this.middleware.get();\r\n    this.updateListWith((canUpdate) => {\r\n      if(!middleware() || (canUpdate !== undefined && !canUpdate)) {\r\n        return callback(false);\r\n      }\r\n\r\n      this._updateList();\r\n  \r\n      callback(true);\r\n    });\r\n  }\r\n\r\n  public has(id: SortedElementId) {\r\n    return this.elements.has(id);\r\n  }\r\n\r\n  public get(id: SortedElementId) {\r\n    return this.elements.get(id);\r\n  }\r\n\r\n  public getAll() {\r\n    return this.elements;\r\n  }\r\n\r\n  public add(\r\n    id: SortedElementId, \r\n    batch = false, \r\n    updateElementWith?: SortedList<SortedElement>['updateElementWith'], \r\n    updateBatch = batch\r\n  ) {\r\n    let element = this.get(id);\r\n    if(element) {\r\n      return element;\r\n    }\r\n\r\n    const base: SortedElementBase = {\r\n      id,\r\n      index: 0\r\n    };\r\n\r\n    element = this.onElementCreate(base, batch);\r\n    this.elements.set(id, element);\r\n    this.update(id, updateBatch, element, updateElementWith);\r\n\r\n    return element;\r\n  }\r\n\r\n  public delete(id: SortedElementId, noScheduler?: boolean) {\r\n    const element = this.elements.get(id);\r\n    if(!element) {\r\n      return false;\r\n    }\r\n    \r\n    this.elements.delete(id);\r\n    \r\n    const idx = this.sorted.indexOf(element);\r\n    if(idx !== -1) {\r\n      this.sorted.splice(idx, 1);\r\n    }\r\n\r\n    if(this.onDelete) {\r\n      if(noScheduler) {\r\n        this.onDelete(element);\r\n      } else {\r\n        const middleware = this.middleware.get();\r\n        this.updateElementWith(() => {\r\n          if(!middleware()) {\r\n            return;\r\n          }\r\n\r\n          this.onDelete(element);\r\n        });\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public async update(\r\n    id: SortedElementId, \r\n    batch = false, \r\n    element = this.get(id), \r\n    updateElementWith?: SortedList<SortedElement>['updateElementWith']\r\n  ) {\r\n    if(!element) {\r\n      return;\r\n    }\r\n\r\n    element.index = await this.getIndex(element);\r\n    this.onUpdate && this.onUpdate(element);\r\n\r\n    const idx = insertInDescendSortedArray(this.sorted, element, 'index');\r\n    if(!batch && this.onSort) {\r\n      const middleware = this.middleware.get();\r\n      (updateElementWith || this.updateElementWith)(() => {\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n\r\n        // *             .    \r\n        this.onSort(element, idx);\r\n        /* if(this.get(id) === element) {\r\n          this.onSort(element, this.sorted.indexOf(element));\r\n        } */\r\n      });\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDialogsManager, { AppDialogsManager, DialogDom } from \"../lib/appManagers/appDialogsManager\";\r\nimport { getHeavyAnimationPromise } from \"../hooks/useHeavyAnimationCheck\";\r\nimport isInDOM from \"../helpers/dom/isInDOM\";\r\nimport positionElementByIndex from \"../helpers/dom/positionElementByIndex\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport { fastRaf } from \"../helpers/schedulers\";\r\nimport SortedList, { SortedElementBase } from \"../helpers/sortedList\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport getUserStatusString from \"./wrappers/getUserStatusString\";\r\nimport type LazyLoadQueue from \"./lazyLoadQueue\";\r\n\r\ninterface SortedUser extends SortedElementBase {\r\n  dom: DialogDom\r\n}\r\n\r\nexport default class SortedUserList extends SortedList<SortedUser> {\r\n  protected static SORT_INTERVAL = 30e3;\r\n  public list: HTMLUListElement;\r\n  \r\n  protected lazyLoadQueue: LazyLoadQueue;\r\n  protected avatarSize = 48;\r\n  protected rippleEnabled = true;\r\n  protected autonomous = true;\r\n  protected createChatListOptions: Parameters<AppDialogsManager['createChatList']>[0];\r\n  protected onListLengthChange: () => void;\r\n  protected getIndex: (element: SortedUser) => number;\r\n  protected onUpdate: (element: SortedUser) => void;\r\n  protected managers: AppManagers;\r\n\r\n  constructor(options: Partial<{\r\n    lazyLoadQueue: SortedUserList['lazyLoadQueue'],\r\n    avatarSize: SortedUserList['avatarSize'],\r\n    rippleEnabled: SortedUserList['rippleEnabled'],\r\n    createChatListOptions: SortedUserList['createChatListOptions'],\r\n    autonomous: SortedUserList['autonomous'],\r\n    onListLengthChange: SortedUserList['onListLengthChange'],\r\n    getIndex: SortedUserList['getIndex'],\r\n    onUpdate: SortedUserList['onUpdate']\r\n  }> & {\r\n    managers: SortedUserList['managers']\r\n  }) {\r\n    super({\r\n      getIndex: options.getIndex || ((element) => this.managers.appUsersManager.getUserStatusForSort(element.id)),\r\n      onDelete: (element) => {\r\n        element.dom.listEl.remove();\r\n        this.onListLengthChange && this.onListLengthChange();\r\n      },\r\n      onUpdate: options.onUpdate || (async(element) => {\r\n        const status = getUserStatusString(await this.managers.appUsersManager.getUser(element.id));\r\n        replaceContent(element.dom.lastMessageSpan, status);\r\n      }),\r\n      onSort: (element, idx) => {\r\n        const willChangeLength = element.dom.listEl.parentElement !== this.list;\r\n        positionElementByIndex(element.dom.listEl, this.list, idx);\r\n\r\n        if(willChangeLength && this.onListLengthChange) {\r\n          this.onListLengthChange();\r\n        }\r\n      },\r\n      onElementCreate: (base) => {\r\n        const {dom} = appDialogsManager.addDialogNew({\r\n          peerId: base.id,\r\n          container: false,\r\n          avatarSize: this.avatarSize,\r\n          autonomous: this.autonomous,\r\n          meAsSaved: false,\r\n          rippleEnabled: this.rippleEnabled,\r\n          lazyLoadQueue: this.lazyLoadQueue\r\n        });\r\n\r\n        (base as SortedUser).dom = dom;\r\n        return base as SortedUser;\r\n      },\r\n      updateElementWith: fastRaf,\r\n      updateListWith: async(callback) => {\r\n        if(!isInDOM(this.list)) {\r\n          return callback(false);\r\n        }\r\n    \r\n        await getHeavyAnimationPromise();\r\n    \r\n        if(!isInDOM(this.list)) {\r\n          return callback(false);\r\n        }\r\n\r\n        callback(true);\r\n      }\r\n    });\r\n\r\n    safeAssign(this, options);\r\n\r\n    this.list = appDialogsManager.createChatList(this.createChatListOptions);\r\n\r\n    let timeout: number;\r\n    const doTimeout = () => {\r\n      timeout = window.setTimeout(() => {\r\n        this.updateList((good) => {\r\n          if(good) {\r\n            doTimeout();\r\n          }\r\n        });\r\n      }, SortedUserList.SORT_INTERVAL);\r\n    };\r\n\r\n    doTimeout();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport { IS_APPLE } from \"../../environment/userAgent\";\r\nimport contextMenuController from \"../contextMenuController\";\r\nimport ListenerSetter from \"../listenerSetter\";\r\nimport cancelEvent from \"./cancelEvent\";\r\n\r\nlet _cancelContextMenuOpening = false, _cancelContextMenuOpeningTimeout = 0;\r\nexport function cancelContextMenuOpening() {\r\n  if(_cancelContextMenuOpeningTimeout) {\r\n    clearTimeout(_cancelContextMenuOpeningTimeout);\r\n  }\r\n    \r\n  _cancelContextMenuOpeningTimeout = window.setTimeout(() => {\r\n    _cancelContextMenuOpeningTimeout = 0;\r\n    _cancelContextMenuOpening = false;\r\n  }, .4e3);\r\n\r\n  _cancelContextMenuOpening = true;\r\n}\r\n\r\nexport function attachContextMenuListener(element: HTMLElement, callback: (e: Touch | MouseEvent) => void, listenerSetter?: ListenerSetter) {\r\n  const add = listenerSetter ? listenerSetter.add(element) : element.addEventListener.bind(element);\r\n  const remove = listenerSetter ? listenerSetter.removeManual.bind(listenerSetter, element) : element.removeEventListener.bind(element);\r\n\r\n  if(IS_APPLE && IS_TOUCH_SUPPORTED) {\r\n    let timeout: number;\r\n\r\n    const options: EventListenerOptions = {capture: true};\r\n\r\n    const onCancel = () => {\r\n      clearTimeout(timeout);\r\n      // @ts-ignore\r\n      remove('touchmove', onCancel, options);\r\n      // @ts-ignore\r\n      remove('touchend', onCancel, options);\r\n      // @ts-ignore\r\n      remove('touchcancel', onCancel, options);\r\n    };\r\n\r\n    add('touchstart', (e: TouchEvent) => {\r\n      if(e.touches.length > 1) {\r\n        onCancel();\r\n        return;\r\n      }\r\n  \r\n      add('touchmove', onCancel, options);\r\n      add('touchend', onCancel, options);\r\n      add('touchcancel', onCancel, options);\r\n\r\n      timeout = window.setTimeout(() => {\r\n        if(_cancelContextMenuOpening) {\r\n          onCancel();\r\n          return;\r\n        }\r\n\r\n        callback(e.touches[0]);\r\n        onCancel();\r\n\r\n        if(contextMenuController.isOpened()) {\r\n          element.addEventListener('touchend', cancelEvent, {once: true}); // * fix instant closing\r\n        }\r\n      }, .4e3);\r\n    });\r\n\r\n    /* if(!isSafari) {\r\n      add('contextmenu', (e: any) => {\r\n        cancelEvent(e);\r\n      }, {passive: false, capture: true});\r\n    } */\r\n  } else {\r\n    add('contextmenu', IS_TOUCH_SUPPORTED ? (e: any) => {\r\n      callback(e);\r\n\r\n      if(contextMenuController.isOpened()) {\r\n        element.addEventListener('touchend', cancelEvent, {once: true}); // * fix instant closing\r\n      }\r\n    } : callback);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SwipeHandler, { SwipeHandlerOptions } from \"../../components/swipeHandler\";\r\nimport cancelEvent from \"./cancelEvent\";\r\nimport findUpClassName from \"./findUpClassName\";\r\nimport isSwipingBackSafari from \"./isSwipingBackSafari\";\r\n\r\nexport type SwipeHandlerHorizontalOptions = SwipeHandlerOptions & {\r\n  // xThreshold?: number\r\n};\r\n\r\nexport default function handleHorizontalSwipe(options: SwipeHandlerHorizontalOptions) {\r\n  let cancelY = false;\r\n  return new SwipeHandler({\r\n    ...options,\r\n    verifyTouchTarget: (e) => {\r\n      return !findUpClassName(e.target, 'progress-line') && \r\n        !isSwipingBackSafari(e) && \r\n        (options.verifyTouchTarget ? options.verifyTouchTarget(e) : true);\r\n    },\r\n    onSwipe: (xDiff, yDiff, e) => {\r\n      if(!cancelY && Math.abs(yDiff) > 20) {\r\n        return true;\r\n      }\r\n\r\n      if(Math.abs(xDiff) > Math.abs(yDiff)) {\r\n        cancelEvent(e);\r\n        cancelY = true;\r\n      } else if(!cancelY && Math.abs(yDiff) > Math.abs(xDiff)/*  || Math.abs(yDiff) > 20 */) {\r\n        return true;\r\n      }\r\n\r\n      /* if(!cancelY && options.xThreshold !== undefined && xDiff >= options.xThreshold) {\r\n        cancelY = true;\r\n      } */\r\n\r\n      return options.onSwipe(xDiff, yDiff, e);\r\n    },\r\n    onReset: () => {\r\n      cancelY = false;\r\n      options.onReset && options.onReset();\r\n    },\r\n    cancelEvent: false // cannot use cancelEvent on Safari iOS because scroll will be canceled too\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { cancelContextMenuOpening } from \"./attachContextMenuListener\";\r\nimport handleHorizontalSwipe, { SwipeHandlerHorizontalOptions } from \"./handleHorizontalSwipe\";\r\n\r\nexport default function handleTabSwipe(options: SwipeHandlerHorizontalOptions) {\r\n  return handleHorizontalSwipe({\r\n    ...options,\r\n    onSwipe: (xDiff, yDiff, e) => {\r\n      if(Math.abs(xDiff) > 50) {\r\n        options.onSwipe(xDiff, yDiff, e);\r\n        cancelContextMenuOpening();\r\n\r\n        return true;\r\n      }\r\n    }\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport contextMenuController from \"../helpers/contextMenuController\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { AttachClickOptions, attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport { FormatterArguments, i18n, LangPackKey } from \"../lib/langPack\";\r\nimport CheckboxField from \"./checkboxField\";\r\n\r\nexport type ButtonMenuItemOptions = {\r\n  icon?: string, \r\n  text?: LangPackKey, \r\n  textArgs?: FormatterArguments,\r\n  regularText?: string, \r\n  onClick: (e: MouseEvent | TouchEvent) => void | boolean | any, \r\n  element?: HTMLElement,\r\n  textElement?: HTMLElement,\r\n  options?: AttachClickOptions,\r\n  checkboxField?: CheckboxField,\r\n  noCheckboxClickListener?: boolean,\r\n  keepOpen?: boolean\r\n  /* , cancelEvent?: true */\r\n};\r\n\r\nconst ButtonMenuItem = (options: ButtonMenuItemOptions) => {\r\n  if(options.element) return options.element;\r\n\r\n  const {icon, text, onClick, checkboxField, noCheckboxClickListener} = options;\r\n  const el = document.createElement('div');\r\n  el.className = 'btn-menu-item rp-overflow' + (icon ? ' tgico-' + icon : '');\r\n  // ripple(el);\r\n\r\n  let textElement = options.textElement;\r\n  if(!textElement) {\r\n    textElement = options.textElement = text ? i18n(text, options.textArgs) : document.createElement('span');\r\n    if(options.regularText) textElement.innerHTML = options.regularText;\r\n  }\r\n  \r\n  textElement.classList.add('btn-menu-item-text');\r\n  el.append(textElement);\r\n\r\n  const keepOpen = !!checkboxField || !!options.keepOpen;\r\n\r\n  // * cancel mobile keyboard close\r\n  onClick && attachClickEvent(el, /* CLICK_EVENT_NAME !== 'click' || keepOpen ? */ (e) => {\r\n    cancelEvent(e);\r\n\r\n    const menu = findUpClassName(e.target, 'btn-menu');\r\n    if(menu && !menu.classList.contains('active')) {\r\n      return;\r\n    }\r\n    \r\n    const result = onClick(e);\r\n\r\n    if(result === false) {\r\n      return;\r\n    }\r\n\r\n    if(!keepOpen) {\r\n      contextMenuController.closeBtnMenu();\r\n    }\r\n\r\n    if(checkboxField && !noCheckboxClickListener/*  && result !== false */) {\r\n      checkboxField.checked = checkboxField.input.type === 'radio' ? true : !checkboxField.checked;\r\n    }\r\n  }/*  : onClick */, options.options);\r\n\r\n  if(checkboxField) {\r\n    el.append(checkboxField.label);\r\n  }\r\n\r\n  return options.element = el;\r\n};\r\n\r\nconst ButtonMenu = (buttons: ButtonMenuItemOptions[], listenerSetter?: ListenerSetter) => {\r\n  const el = document.createElement('div');\r\n  el.classList.add('btn-menu');\r\n\r\n  if(listenerSetter) {\r\n    buttons.forEach((b) => {\r\n      if(b.options) {\r\n        b.options.listenerSetter = listenerSetter;\r\n      } else {\r\n        b.options = {listenerSetter};\r\n      }\r\n    });\r\n  }\r\n\r\n  const items = buttons.map(ButtonMenuItem);\r\n\r\n  el.append(...items);\r\n\r\n  return el;\r\n};\r\n\r\nexport default ButtonMenu;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport PopupPickUser from \"./pickUser\";\r\n\r\nexport default class PopupForward extends PopupPickUser {\r\n  constructor(\r\n    peerIdMids: {[fromPeerId: PeerId]: number[]}, \r\n    onSelect?: (peerId: PeerId) => Promise<void> | void, \r\n    overrideOnSelect = false\r\n  ) {\r\n    super({\r\n      peerTypes: ['dialogs', 'contacts'],\r\n      onSelect: overrideOnSelect ? onSelect : async(peerId) => {\r\n        if(onSelect) {\r\n          const res = onSelect(peerId);\r\n          if(res instanceof Promise) {\r\n            await res;\r\n          }\r\n        }\r\n\r\n        appImManager.setInnerPeer({peerId});\r\n        appImManager.chat.input.initMessagesForward(peerIdMids);\r\n      },\r\n      placeholder: 'ShareModal.Search.ForwardPlaceholder',\r\n      chatRightsAction: 'send_messages',\r\n      selfPresence: 'ChatYourSelf'\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport PopupElement, { addCancelButton } from \".\";\r\nimport PopupPeer, { PopupPeerButtonCallbackCheckboxes, PopupPeerOptions } from \"./peer\";\r\nimport { ChatType } from \"../chat/chat\";\r\nimport { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport hasRights from \"../../lib/appManagers/utils/chats/hasRights\";\r\nimport filterAsync from \"../../helpers/array/filterAsync\";\r\n\r\nexport default class PopupDeleteMessages {\r\n  constructor(private peerId: PeerId, private mids: number[], private type: ChatType, private onConfirm?: () => void) {\r\n    this.construct();\r\n  }\r\n\r\n  private async construct() {\r\n    let {peerId, mids, type, onConfirm} = this;\r\n\r\n    const peerTitleElement = new PeerTitle({peerId}).element;\r\n\r\n    const managers = PopupElement.MANAGERS;\r\n\r\n    mids = mids.slice();\r\n    const callback = (checked: PopupPeerButtonCallbackCheckboxes, revoke?: boolean) => {\r\n      onConfirm && onConfirm();\r\n      if(type === 'scheduled') {\r\n        managers.appMessagesManager.deleteScheduledMessages(peerId, mids);\r\n      } else {\r\n        managers.appMessagesManager.deleteMessages(peerId, mids, !!checked.size || revoke);\r\n      }\r\n    };\r\n\r\n    let title: LangPackKey, titleArgs: any[], description: LangPackKey, descriptionArgs: any[], buttons: PopupPeerOptions['buttons'], checkboxes: PopupPeerOptions['checkboxes'] = [];\r\n    if(mids.length === 1) {\r\n      title = 'DeleteSingleMessagesTitle';\r\n    } else {\r\n      title = 'DeleteMessagesTitle';\r\n      titleArgs = [i18n('messages', [mids.length])];\r\n    }\r\n    \r\n    if(await managers.appPeersManager.isMegagroup(peerId)) {\r\n      description = mids.length === 1 ? 'AreYouSureDeleteSingleMessageMega' : 'AreYouSureDeleteFewMessagesMega';\r\n    } else {\r\n      description = mids.length === 1 ? 'AreYouSureDeleteSingleMessage' : 'AreYouSureDeleteFewMessages';\r\n    }\r\n\r\n    buttons = [{\r\n      langKey: 'Delete',\r\n      isDanger: true,\r\n      callback\r\n    }];\r\n\r\n    if(peerId === rootScope.myId || type === 'scheduled') {\r\n      \r\n    } else {\r\n      if(peerId.isUser()) {\r\n        checkboxes.push({\r\n          text: 'DeleteMessagesOptionAlso',\r\n          textArgs: [peerTitleElement]\r\n        });\r\n      } else {\r\n        const chat = await managers.appChatsManager.getChat(peerId.toChatId());\r\n\r\n        const _hasRights = hasRights(chat, 'delete_messages');\r\n        if(chat._ === 'chat') {\r\n          const canRevoke = _hasRights ? mids.slice() : await filterAsync(mids, async(mid) => {\r\n            const message = await managers.appMessagesManager.getMessageByPeer(peerId, mid);\r\n            return message.fromId === rootScope.myId;\r\n          });\r\n\r\n          if(canRevoke.length) {\r\n            if(canRevoke.length === mids.length) {\r\n              checkboxes.push({\r\n                text: 'DeleteForAll'\r\n              });\r\n            } else {\r\n              checkboxes.push({\r\n                text: 'DeleteMessagesOption'\r\n              });\r\n\r\n              description = 'DeleteMessagesTextGroup';\r\n              descriptionArgs = [i18n('messages', [canRevoke.length])];\r\n              //description = `You can also delete the ${canRevoke.length} message${canRevoke.length > 1 ? 's' : ''} you sent from the inboxes of other group members by pressing \"${buttonText}\".`;\r\n            }\r\n          }\r\n        } else {\r\n          buttons[0].callback = (checked) => callback(checked, true);\r\n        }\r\n      }\r\n    }\r\n\r\n    addCancelButton(buttons);\r\n\r\n    const popup = new PopupPeer('popup-delete-chat', {\r\n      peerId,\r\n      titleLangKey: title,\r\n      titleLangArgs: titleArgs,\r\n      descriptionLangKey: description,\r\n      descriptionLangArgs: descriptionArgs,\r\n      buttons,\r\n      checkboxes\r\n    });\r\n\r\n    popup.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupPeer from \"./peer\";\r\n\r\nexport default class PopupSendNow extends PopupPeer {\r\n  constructor(peerId: PeerId, mids: number[], onConfirm?: () => void) {\r\n    super('popup-delete-chat', {\r\n      title: `Send Message${mids.length > 1 ? 's' : ''} Now`,\r\n      description: mids.length > 1 ? 'Send ' + mids.length + ' messages now?' : 'Send message now?',\r\n      buttons: [{\r\n        langKey: 'Send',\r\n        callback: () => {\r\n          onConfirm && onConfirm();\r\n          this.managers.appMessagesManager.sendScheduledMessages(peerId, mids);\r\n        }\r\n      }]\r\n    });\r\n    \r\n    this.show();\r\n  }\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function cancelSelection() {\r\n  if(window.getSelection) {\r\n    if(window.getSelection().empty) {  // Chrome\r\n      window.getSelection().empty();\r\n    } else if(window.getSelection().removeAllRanges) {  // Firefox\r\n      window.getSelection().removeAllRanges();\r\n    }\r\n    // @ts-ignore\r\n  } else if(document.selection) {  // IE?\r\n    // @ts-ignore\r\n    document.selection.empty();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { AppMessagesManager, MessagesStorageKey } from \"../../lib/appManagers/appMessagesManager\";\r\nimport type ChatBubbles from \"./bubbles\";\r\nimport type ChatInput from \"./input\";\r\nimport type Chat from \"./chat\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport Button from \"../button\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport CheckboxField from \"../checkboxField\";\r\nimport PopupDeleteMessages from \"../popups/deleteMessages\";\r\nimport PopupForward from \"../popups/forward\";\r\nimport { toast } from \"../toast\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport PopupSendNow from \"../popups/sendNow\";\r\nimport appNavigationController, { NavigationItem } from \"../appNavigationController\";\r\nimport { IS_MOBILE_SAFARI } from \"../../environment/userAgent\";\r\nimport I18n, { i18n, _i18n } from \"../../lib/langPack\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport blurActiveElement from \"../../helpers/dom/blurActiveElement\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport cancelSelection from \"../../helpers/dom/cancelSelection\";\r\nimport getSelectedText from \"../../helpers/dom/getSelectedText\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport AppSearchSuper from \"../appSearchSuper.\";\r\nimport isInDOM from \"../../helpers/dom/isInDOM\";\r\nimport { randomLong } from \"../../helpers/random\";\r\nimport { attachClickEvent, AttachClickOptions } from \"../../helpers/dom/clickEvent\";\r\nimport findUpAsChild from \"../../helpers/dom/findUpAsChild\";\r\nimport EventListenerBase from \"../../helpers/eventListenerBase\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport { attachContextMenuListener } from \"../../helpers/dom/attachContextMenuListener\";\r\nimport filterUnique from \"../../helpers/array/filterUnique\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\n\r\nconst accumulateMapSet = (map: Map<any, Set<number>>) => {\r\n  return [...map.values()].reduce((acc, v) => acc + v.size, 0);\r\n};\r\n\r\n//const MIN_CLICK_MOVE = 32; // minimum bubble height\r\n\r\nclass AppSelection extends EventListenerBase<{\r\n  toggle: (isSelecting: boolean) => void\r\n}> {\r\n  public selectedMids: Map<PeerId, Set<number>> = new Map();\r\n  public isSelecting = false;\r\n\r\n  public selectedText: string;\r\n\r\n  protected listenerSetter: ListenerSetter;\r\n  protected isScheduled: boolean;\r\n  protected listenElement: HTMLElement;\r\n\r\n  protected onToggleSelection: (forwards: boolean, animate: boolean) => void;\r\n  protected onUpdateContainer: (cantForward: boolean, cantDelete: boolean, cantSend: boolean) => void;\r\n  protected onCancelSelection: () => void;\r\n  protected toggleByMid: (peerId: PeerId, mid: number) => void;\r\n  protected toggleByElement: (bubble: HTMLElement) => void;\r\n\r\n  protected navigationType: NavigationItem['type'];\r\n\r\n  protected getElementFromTarget: (target: HTMLElement) => HTMLElement;\r\n  protected verifyTarget: (e: MouseEvent, target: HTMLElement) => boolean;\r\n  protected verifyMouseMoveTarget: (e: MouseEvent, element: HTMLElement, selecting: boolean) => boolean;\r\n  protected verifyTouchLongPress: () => boolean;\r\n  protected targetLookupClassName: string;\r\n  protected lookupBetweenParentClassName: string;\r\n  protected lookupBetweenElementsQuery: string;\r\n\r\n  protected doNotAnimate: boolean;\r\n  protected managers: AppManagers;\r\n\r\n  constructor(options: {\r\n    managers: AppManagers,\r\n    getElementFromTarget: AppSelection['getElementFromTarget'],\r\n    verifyTarget?: AppSelection['verifyTarget'],\r\n    verifyMouseMoveTarget?: AppSelection['verifyMouseMoveTarget'],\r\n    verifyTouchLongPress?: AppSelection['verifyTouchLongPress'],\r\n    targetLookupClassName: string,\r\n    lookupBetweenParentClassName: string,\r\n    lookupBetweenElementsQuery: string,\r\n    isScheduled?: AppSelection['isScheduled']\r\n  }) {\r\n    super(false);\r\n\r\n    safeAssign(this, options);\r\n\r\n    this.navigationType = 'multiselect-' + randomLong() as any;\r\n  }\r\n\r\n  public attachListeners(listenElement: HTMLElement, listenerSetter: ListenerSetter) {\r\n    if(this.listenElement) {\r\n      this.listenerSetter.removeAll();\r\n    }\r\n\r\n    this.listenElement = listenElement;\r\n    this.listenerSetter = listenerSetter;\r\n\r\n    if(!listenElement) {\r\n      return;\r\n    }\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      listenerSetter.add(listenElement)('touchend', () => {\r\n        if(!this.isSelecting) return;\r\n        this.selectedText = getSelectedText();\r\n      });\r\n\r\n      attachContextMenuListener(listenElement, (e) => {\r\n        if(this.isSelecting || (this.verifyTouchLongPress && !this.verifyTouchLongPress())) return;\r\n\r\n        // * these two lines will fix instant text selection on iOS Safari\r\n        document.body.classList.add('no-select'); // * need no-select on body because chat-input transforms in channels\r\n        listenElement.addEventListener('touchend', (e) => {\r\n          cancelEvent(e); // ! this one will fix propagation to document loader button, etc\r\n          document.body.classList.remove('no-select');\r\n\r\n          //this.chat.bubbles.onBubblesClick(e);\r\n        }, {once: true, capture: true});\r\n\r\n        cancelSelection();\r\n        //cancelEvent(e as any);\r\n        const element = this.getElementFromTarget(e.target as HTMLElement);\r\n        if(element) {\r\n          this.toggleByElement(element);\r\n        }\r\n      }, listenerSetter);\r\n\r\n      return;\r\n    }\r\n\r\n    listenerSetter.add(listenElement)('mousedown', this.onMouseDown);\r\n  }\r\n\r\n  private onMouseDown = (e: MouseEvent) => {\r\n    //console.log('selection mousedown', e);\r\n    const element = findUpClassName(e.target, this.targetLookupClassName);\r\n    if(e.button !== 0) {\r\n      return;\r\n    }\r\n\r\n    if(this.verifyTarget && !this.verifyTarget(e, element)) {\r\n      return;\r\n    }\r\n\r\n    const seen: AppSelection['selectedMids'] = new Map();\r\n    let selecting: boolean;\r\n\r\n    /* let good = false;\r\n    const {x, y} = e; */\r\n\r\n    /* const bubbles = appImManager.bubbles;\r\n    for(const mid in bubbles) {\r\n      const bubble = bubbles[mid];\r\n      bubble.addEventListener('mouseover', () => {\r\n        console.log('mouseover');\r\n      }, {once: true});\r\n    } */\r\n\r\n    let firstTarget = element;\r\n\r\n    const processElement = (element: HTMLElement, checkBetween = true) => {\r\n      const mid = +element.dataset.mid;\r\n      if(!mid || !element.dataset.peerId) return;\r\n      const peerId = element.dataset.peerId.toPeerId();\r\n\r\n      if(!isInDOM(firstTarget)) {\r\n        firstTarget = element;\r\n      }\r\n\r\n      let seenSet = seen.get(peerId);\r\n      if(!seenSet) {\r\n        seen.set(peerId, seenSet = new Set());\r\n      }\r\n\r\n      if(seenSet.has(mid)) {\r\n        return;\r\n      }\r\n\r\n      const isSelected = this.isMidSelected(peerId, mid);\r\n      if(selecting === undefined) {\r\n        //bubblesContainer.classList.add('no-select');\r\n        selecting = !isSelected;\r\n      }\r\n\r\n      seenSet.add(mid);\r\n\r\n      if((selecting && !isSelected) || (!selecting && isSelected)) {\r\n        const seenLength = accumulateMapSet(seen);\r\n        if(this.toggleByElement && checkBetween) {\r\n          if(seenLength < 2) {\r\n            if(findUpAsChild(element, firstTarget)) {\r\n              firstTarget = element;\r\n            }\r\n          }\r\n\r\n          const elementsBetween = this.getElementsBetween(firstTarget, element);\r\n          // console.log(elementsBetween);\r\n          if(elementsBetween.length) {\r\n            elementsBetween.forEach((element) => {\r\n              processElement(element, false);\r\n            });\r\n          }\r\n        }\r\n\r\n        if(!this.selectedMids.size) {\r\n          if(seenLength === 2 && this.toggleByMid) {\r\n            for(const [peerId, mids] of seen) {\r\n              for(const mid of mids) {\r\n                this.toggleByMid(peerId, mid);\r\n              }\r\n            }\r\n          }\r\n        } else if(this.toggleByElement) {\r\n          this.toggleByElement(element);\r\n        }\r\n      }\r\n    };\r\n\r\n    //const foundTargets: Map<HTMLElement, true> = new Map();\r\n    let canceledSelection = false;\r\n    const onMouseMove = (e: MouseEvent) => {\r\n      if(!canceledSelection) {\r\n        cancelSelection();\r\n        canceledSelection = true;\r\n      }\r\n      /* if(!good) {\r\n        if(Math.abs(e.x - x) > MIN_CLICK_MOVE || Math.abs(e.y - y) > MIN_CLICK_MOVE) {\r\n          good = true;\r\n        } else {\r\n          return;\r\n        }\r\n      } */\r\n\r\n      /* if(foundTargets.has(e.target as HTMLElement)) return;\r\n      foundTargets.set(e.target as HTMLElement, true); */\r\n      const element = this.getElementFromTarget(e.target as HTMLElement);\r\n      if(!element) {\r\n        //console.error('found no bubble', e);\r\n        return;\r\n      }\r\n\r\n      if(this.verifyMouseMoveTarget && !this.verifyMouseMoveTarget(e, element, selecting)) {\r\n        this.listenerSetter.removeManual(this.listenElement, 'mousemove', onMouseMove);\r\n        this.listenerSetter.removeManual(document, 'mouseup', onMouseUp, documentListenerOptions);\r\n        return;\r\n      }\r\n\r\n      processElement(element);\r\n    };\r\n\r\n    const onMouseUp = (e: MouseEvent) => {\r\n      if(seen.size) {\r\n        attachClickEvent(window, cancelEvent, {capture: true, once: true, passive: false});\r\n      }\r\n\r\n      this.listenerSetter.removeManual(this.listenElement, 'mousemove', onMouseMove);\r\n      //bubblesContainer.classList.remove('no-select');\r\n\r\n      // ! CANCEL USER SELECTION !\r\n      cancelSelection();\r\n    };\r\n\r\n    const documentListenerOptions = {once: true};\r\n    this.listenerSetter.add(this.listenElement)('mousemove', onMouseMove);\r\n    this.listenerSetter.add(document)('mouseup', onMouseUp, documentListenerOptions);\r\n  };\r\n\r\n  private getElementsBetween = (first: HTMLElement, last: HTMLElement) => { \r\n    if(first === last) {\r\n      return [];\r\n    }\r\n\r\n    const firstRect = first.getBoundingClientRect();\r\n    const lastRect = last.getBoundingClientRect();\r\n    const difference = (firstRect.top - lastRect.top) || (firstRect.left - lastRect.left);\r\n    const isHigher = difference < 0;\r\n\r\n    const parent = findUpClassName(first, this.lookupBetweenParentClassName);\r\n    if(!parent) {\r\n      return [];\r\n    }\r\n\r\n    const elements = Array.from(parent.querySelectorAll(this.lookupBetweenElementsQuery)) as HTMLElement[];\r\n    let firstIndex = elements.indexOf(first);\r\n    let lastIndex = elements.indexOf(last);\r\n\r\n    if(!isHigher) {\r\n      [lastIndex, firstIndex] = [firstIndex, lastIndex];\r\n    }\r\n\r\n    const slice = elements.slice(firstIndex + 1, lastIndex);\r\n\r\n    // console.log('getElementsBetween', first, last, slice, firstIndex, lastIndex, isHigher);\r\n\r\n    return slice;\r\n  };\r\n\r\n  protected isElementShouldBeSelected(element: HTMLElement) {\r\n    return this.isMidSelected(element.dataset.peerId.toPeerId(), +element.dataset.mid);\r\n  }\r\n\r\n  protected appendCheckbox(element: HTMLElement, checkboxField: CheckboxField) {\r\n    element.prepend(checkboxField.label);\r\n  }\r\n\r\n  public toggleElementCheckbox(element: HTMLElement, show: boolean) {\r\n    const hasCheckbox = !!this.getCheckboxInputFromElement(element);\r\n    if(show) {\r\n      if(hasCheckbox) {\r\n        return false;\r\n      }\r\n      \r\n      const checkboxField = new CheckboxField({\r\n        name: element.dataset.mid, \r\n        round: true\r\n      });\r\n      \r\n      // * if it is a render of new message\r\n      if(this.isSelecting) { // ! avoid breaking animation on start\r\n        if(this.isElementShouldBeSelected(element)) {\r\n          checkboxField.input.checked = true;\r\n          element.classList.add('is-selected');\r\n        }\r\n      }\r\n      \r\n      this.appendCheckbox(element, checkboxField);\r\n    } else if(hasCheckbox) {\r\n      this.getCheckboxInputFromElement(element).parentElement.remove();\r\n      SetTransition(element, 'is-selected', false, 200);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  protected getCheckboxInputFromElement(element: HTMLElement): HTMLInputElement {\r\n    return element.firstElementChild?.tagName === 'LABEL' && \r\n      element.firstElementChild.firstElementChild as HTMLInputElement;\r\n  }\r\n\r\n  protected async updateContainer(forceSelection = false) {\r\n    const size = this.selectedMids.size;\r\n    if(!size && !forceSelection) return;\r\n    \r\n    let cantForward = !size, \r\n      cantDelete = !size, \r\n      cantSend = !size;\r\n    for(const [peerId, mids] of this.selectedMids) {\r\n      const storageKey: MessagesStorageKey = `${peerId}_${this.isScheduled ? 'scheduled' : 'history'}`;\r\n      const r = await this.managers.appMessagesManager.cantForwardDeleteMids(storageKey, Array.from(mids));\r\n      cantForward = r.cantForward;\r\n      cantDelete = r.cantDelete;\r\n\r\n      if(cantForward && cantDelete) break;\r\n    }\r\n    \r\n    this.onUpdateContainer && this.onUpdateContainer(cantForward, cantDelete, cantSend);\r\n  }\r\n\r\n  public toggleSelection(toggleCheckboxes = true, forceSelection = false) {\r\n    const wasSelecting = this.isSelecting;\r\n    const size = this.selectedMids.size;\r\n    this.isSelecting = !!size || forceSelection;\r\n\r\n    if(wasSelecting === this.isSelecting) return false;\r\n\r\n    this.dispatchEvent('toggle', this.isSelecting);\r\n    \r\n    // const bubblesContainer = this.bubbles.bubblesContainer;\r\n    //bubblesContainer.classList.toggle('is-selecting', !!size);\r\n\r\n    /* if(bubblesContainer.classList.contains('is-chat-input-hidden')) {\r\n      const scrollable = this.appImManager.scrollable;\r\n      if(scrollable.isScrolledDown) {\r\n        scrollable.scrollTo(scrollable.scrollHeight, 'top', true, true, 200);\r\n      }\r\n    } */\r\n\r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      this.listenElement.classList.toggle('no-select', this.isSelecting);\r\n\r\n      if(wasSelecting) {\r\n        // ! CANCEL USER SELECTION !\r\n        cancelSelection();\r\n      }\r\n    }/*  else {\r\n      if(!wasSelecting) {\r\n        bubblesContainer.classList.add('no-select');\r\n        setTimeout(() => {\r\n          cancelSelection();\r\n          bubblesContainer.classList.remove('no-select');\r\n          cancelSelection();\r\n        }, 100);\r\n      }\r\n    } */\r\n\r\n    blurActiveElement();\r\n\r\n    const forwards = !!size || forceSelection;\r\n    this.onToggleSelection && this.onToggleSelection(forwards, !this.doNotAnimate);\r\n\r\n    if(!IS_MOBILE_SAFARI) {\r\n      if(forwards) {\r\n        appNavigationController.pushItem({\r\n          type: this.navigationType,\r\n          onPop: () => {\r\n            this.cancelSelection();\r\n          }\r\n        });\r\n      } else {\r\n        appNavigationController.removeByType(this.navigationType);\r\n      }\r\n    }\r\n\r\n    if(forceSelection) {\r\n      this.updateContainer(forceSelection);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public cancelSelection = async(doNotAnimate?: boolean) => {\r\n    if(doNotAnimate) this.doNotAnimate = true;\r\n    this.onCancelSelection && await this.onCancelSelection();\r\n    this.selectedMids.clear();\r\n    this.toggleSelection();\r\n    cancelSelection();\r\n    if(doNotAnimate) this.doNotAnimate = undefined;\r\n  };\r\n\r\n  public cleanup() {\r\n    this.doNotAnimate = true;\r\n    this.selectedMids.clear();\r\n    this.toggleSelection(false);\r\n    this.doNotAnimate = undefined;\r\n  }\r\n\r\n  protected updateElementSelection(element: HTMLElement, isSelected: boolean) {\r\n    this.toggleElementCheckbox(element, true);\r\n    const input = this.getCheckboxInputFromElement(element);\r\n    input.checked = isSelected;\r\n\r\n    this.toggleSelection();\r\n    this.updateContainer();\r\n    SetTransition(element, 'is-selected', isSelected, 200);\r\n  }\r\n\r\n  public isMidSelected(peerId: PeerId, mid: number) {\r\n    const set = this.selectedMids.get(peerId);\r\n    return set?.has(mid);\r\n  }\r\n\r\n  public length() {\r\n    return accumulateMapSet(this.selectedMids);\r\n  }\r\n\r\n  protected toggleMid(peerId: PeerId, mid: number, unselect?: boolean) {\r\n    let set = this.selectedMids.get(peerId);\r\n    if(unselect || (unselect === undefined && set?.has(mid))) {\r\n      if(set) {\r\n        set.delete(mid);\r\n\r\n        if(!set.size) {\r\n          this.selectedMids.delete(peerId);\r\n        }\r\n      }\r\n    } else {\r\n      // const diff = rootScope.config.forwarded_count_max - this.length() - 1;\r\n      // if(diff < 0) {\r\n      //   toast(I18n.format('Chat.Selection.LimitToast', true));\r\n      //   return false;\r\n      //   /* const it = this.selectedMids.values();\r\n      //   do {\r\n      //     const mid = it.next().value;\r\n      //     const mounted = this.appImManager.getMountedBubble(mid);\r\n      //     if(mounted) {\r\n      //       this.toggleByBubble(mounted.bubble);\r\n      //     } else {\r\n      //       const mids = this.appMessagesManager.getMidsByMid(mid);\r\n      //       for(const mid of mids) {\r\n      //         this.selectedMids.delete(mid);\r\n      //       }\r\n      //     }\r\n      //   } while(this.selectedMids.size > MAX_SELECTION_LENGTH); */\r\n      // }\r\n\r\n      if(!set) {\r\n        set = new Set();\r\n        this.selectedMids.set(peerId, set);\r\n      }\r\n\r\n      set.add(mid);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * ! Call this method only to handle deleted messages\r\n   */\r\n  public deleteSelectedMids(peerId: PeerId, mids: number[]) {\r\n    const set = this.selectedMids.get(peerId);\r\n    if(!set) {\r\n      return;\r\n    }\r\n\r\n    mids.forEach((mid) => {\r\n      set.delete(mid);\r\n    });\r\n\r\n    if(!set.size) {\r\n      this.selectedMids.delete(peerId);\r\n    }\r\n\r\n    this.updateContainer();\r\n    this.toggleSelection();\r\n  }\r\n}\r\n\r\nexport class SearchSelection extends AppSelection {\r\n  protected selectionContainer: HTMLElement;\r\n  protected selectionCountEl: HTMLElement;\r\n  public selectionForwardBtn: HTMLElement;\r\n  public selectionDeleteBtn: HTMLElement;\r\n  public selectionGotoBtn: HTMLElement;\r\n\r\n  private isPrivate: boolean;\r\n\r\n  constructor(private searchSuper: AppSearchSuper, managers: AppManagers, listenerSetter: ListenerSetter) {\r\n    super({\r\n      managers,\r\n      verifyTarget: (e, target) => !!target && this.isSelecting,\r\n      getElementFromTarget: (target) => findUpClassName(target, 'search-super-item'),\r\n      targetLookupClassName: 'search-super-item',\r\n      lookupBetweenParentClassName: 'tabs-tab',\r\n      lookupBetweenElementsQuery: '.search-super-item'\r\n    });\r\n\r\n    this.isPrivate = !searchSuper.showSender;\r\n    this.attachListeners(searchSuper.container, listenerSetter);\r\n  }\r\n\r\n  /* public appendCheckbox(element: HTMLElement, checkboxField: CheckboxField) {\r\n    checkboxField.label.classList.add('bubble-select-checkbox');\r\n\r\n    if(element.classList.contains('document') || element.tagName === 'AUDIO-ELEMENT') {\r\n      element.querySelector('.document, audio-element').append(checkboxField.label);\r\n    } else {\r\n      super.appendCheckbox(bubble, checkboxField);\r\n    }\r\n  } */\r\n\r\n  public toggleSelection(toggleCheckboxes = true, forceSelection = false) {\r\n    const ret = super.toggleSelection(toggleCheckboxes, forceSelection);\r\n\r\n    if(ret && toggleCheckboxes) {\r\n      const elements = Array.from(this.searchSuper.tabsContainer.querySelectorAll('.search-super-item')) as HTMLElement[];\r\n      elements.forEach((element) => {\r\n        this.toggleElementCheckbox(element, this.isSelecting);\r\n      });\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  public toggleByElement = (element: HTMLElement) => {\r\n    const mid = +element.dataset.mid;\r\n    const peerId = element.dataset.peerId.toPeerId();\r\n\r\n    if(!this.toggleMid(peerId, mid)) {\r\n      return;\r\n    }\r\n\r\n    this.updateElementSelection(element, this.isMidSelected(peerId, mid));\r\n  };\r\n\r\n  public toggleByMid = (peerId: PeerId, mid: number) => {\r\n    const element = this.searchSuper.mediaTab.contentTab.querySelector(`.search-super-item[data-peer-id=\"${peerId}\"][data-mid=\"${mid}\"]`) as HTMLElement;\r\n    this.toggleByElement(element);\r\n  };\r\n\r\n  protected onUpdateContainer = (cantForward: boolean, cantDelete: boolean, cantSend: boolean) => {\r\n    const length = this.length();\r\n    replaceContent(this.selectionCountEl, i18n('messages', [length]));\r\n    this.selectionGotoBtn.classList.toggle('hide', length !== 1);\r\n    this.selectionForwardBtn.classList.toggle('hide', cantForward);\r\n    this.selectionDeleteBtn && this.selectionDeleteBtn.classList.toggle('hide', cantDelete);\r\n  };\r\n\r\n  protected onToggleSelection = (forwards: boolean, animate: boolean) => {\r\n    SetTransition(this.searchSuper.navScrollableContainer, 'is-selecting', forwards, animate ? 200 : 0, () => {\r\n      if(!this.isSelecting) {\r\n        this.selectionContainer.remove();\r\n        this.selectionContainer = \r\n          this.selectionForwardBtn = \r\n          this.selectionDeleteBtn = \r\n          null;\r\n        this.selectedText = undefined;\r\n      }\r\n    });\r\n\r\n    SetTransition(this.searchSuper.container, 'is-selecting', forwards, 200);\r\n\r\n    if(this.isSelecting) {\r\n      if(!this.selectionContainer) {\r\n        const BASE_CLASS = 'search-super-selection';\r\n        this.selectionContainer = document.createElement('div');\r\n        this.selectionContainer.classList.add(BASE_CLASS + '-container');\r\n\r\n        const btnCancel = ButtonIcon(`close ${BASE_CLASS}-cancel`, {noRipple: true});\r\n        attachClickEvent(btnCancel, () => this.cancelSelection(), {listenerSetter: this.listenerSetter, once: true});\r\n\r\n        this.selectionCountEl = document.createElement('div');\r\n        this.selectionCountEl.classList.add(BASE_CLASS + '-count');\r\n\r\n        this.selectionGotoBtn = ButtonIcon(`message ${BASE_CLASS}-goto`);\r\n\r\n        const attachClickOptions: AttachClickOptions = {listenerSetter: this.listenerSetter};\r\n        attachClickEvent(this.selectionGotoBtn, () => {\r\n          const peerId = [...this.selectedMids.keys()][0];\r\n          const mid = [...this.selectedMids.get(peerId)][0];\r\n          this.cancelSelection();\r\n\r\n          appImManager.setInnerPeer({peerId, lastMsgId: mid});\r\n        }, attachClickOptions);\r\n\r\n        this.selectionForwardBtn = ButtonIcon(`forward ${BASE_CLASS}-forward`);\r\n        attachClickEvent(this.selectionForwardBtn, () => {\r\n          const obj: {[fromPeerId: PeerId]: number[]} = {};\r\n          for(const [fromPeerId, mids] of this.selectedMids) {\r\n            obj[fromPeerId] = Array.from(mids).sort((a, b) => a - b);\r\n          }\r\n\r\n          new PopupForward(obj, () => {\r\n            this.cancelSelection();\r\n          });\r\n        }, attachClickOptions);\r\n\r\n        if(this.isPrivate) {\r\n          this.selectionDeleteBtn = ButtonIcon(`delete danger ${BASE_CLASS}-delete`);\r\n          attachClickEvent(this.selectionDeleteBtn, () => {\r\n            const peerId = [...this.selectedMids.keys()][0];\r\n            new PopupDeleteMessages(peerId, [...this.selectedMids.get(peerId)], 'chat', () => {\r\n              this.cancelSelection();\r\n            });\r\n          }, attachClickOptions);\r\n        }\r\n\r\n        this.selectionContainer.append(...[\r\n          btnCancel, \r\n          this.selectionCountEl, \r\n          this.selectionGotoBtn, \r\n          this.selectionForwardBtn, \r\n          this.selectionDeleteBtn\r\n        ].filter(Boolean));\r\n\r\n        const transitionElement = this.selectionContainer;\r\n        transitionElement.style.opacity = '0';\r\n        this.searchSuper.navScrollableContainer.append(transitionElement);\r\n\r\n        void transitionElement.offsetLeft; // reflow\r\n        transitionElement.style.opacity = '';\r\n      }\r\n    }\r\n  };\r\n}\r\n\r\nexport default class ChatSelection extends AppSelection {\r\n  protected selectionInputWrapper: HTMLElement;\r\n  protected selectionContainer: HTMLElement;\r\n  protected selectionCountEl: HTMLElement;\r\n  public selectionSendNowBtn: HTMLElement;\r\n  public selectionForwardBtn: HTMLElement;\r\n  public selectionDeleteBtn: HTMLElement;\r\n  private selectionLeft: HTMLDivElement;\r\n  private selectionRight: HTMLDivElement;\r\n\r\n  constructor(\r\n    private chat: Chat, \r\n    private bubbles: ChatBubbles, \r\n    private input: ChatInput, \r\n    managers: AppManagers\r\n  ) {\r\n    super({\r\n      managers,\r\n      getElementFromTarget: (target) => findUpClassName(target, 'grouped-item') || findUpClassName(target, 'bubble'),\r\n      verifyTarget: (e, target) => {\r\n        // LEFT BUTTON\r\n        //     ,      target  .bubble\r\n        const bad = !this.selectedMids.size \r\n          && !(e.target as HTMLElement).classList.contains('bubble')\r\n          && !(e.target as HTMLElement).classList.contains('document-selection')\r\n          && target;\r\n\r\n        return !bad;\r\n      },\r\n      verifyMouseMoveTarget: (e, element, selecting) => {\r\n        const bad = e.target !== element && \r\n          !(e.target as HTMLElement).classList.contains('document-selection') && \r\n          selecting === undefined && \r\n          !this.selectedMids.size;\r\n        return !bad;\r\n      },\r\n      verifyTouchLongPress: () => !this.chat.input.recording,\r\n      targetLookupClassName: 'bubble',\r\n      lookupBetweenParentClassName: 'bubbles-inner',\r\n      lookupBetweenElementsQuery: '.bubble:not(.is-multiple-documents), .grouped-item',\r\n      isScheduled: chat.type === 'scheduled'\r\n    });\r\n  }\r\n\r\n  public appendCheckbox(bubble: HTMLElement, checkboxField: CheckboxField) {\r\n    checkboxField.label.classList.add('bubble-select-checkbox');\r\n\r\n    if(bubble.classList.contains('document-container')) {\r\n      bubble.querySelector('.document, audio-element').append(checkboxField.label);\r\n    } else {\r\n      super.appendCheckbox(bubble, checkboxField);\r\n    }\r\n  }\r\n\r\n  public toggleSelection(toggleCheckboxes = true, forceSelection = false) {\r\n    const ret = super.toggleSelection(toggleCheckboxes, forceSelection);\r\n\r\n    if(ret && toggleCheckboxes) {\r\n      for(const mid in this.bubbles.bubbles) {\r\n        if(this.bubbles.skippedMids.has(+mid)) {\r\n          continue;\r\n        }\r\n        \r\n        const bubble = this.bubbles.bubbles[mid];\r\n        this.toggleElementCheckbox(bubble, this.isSelecting);\r\n      }\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  public toggleElementCheckbox(bubble: HTMLElement, show: boolean) {\r\n    if(!this.canSelectBubble(bubble)) return;\r\n\r\n    const ret = super.toggleElementCheckbox(bubble, show);\r\n    if(ret) {\r\n      const isGrouped = bubble.classList.contains('is-grouped');\r\n      if(isGrouped) {\r\n        this.bubbles.getBubbleGroupedItems(bubble).forEach((item) => this.toggleElementCheckbox(item, show));\r\n      }\r\n    }\r\n    \r\n    return ret;\r\n  }\r\n\r\n  public toggleByElement = (bubble: HTMLElement): Promise<void> => {\r\n    if(!this.canSelectBubble(bubble)) return;\r\n\r\n    const mid = +bubble.dataset.mid;\r\n\r\n    const isGrouped = bubble.classList.contains('is-grouped');\r\n    if(isGrouped) {\r\n      if(!this.isGroupedBubbleSelected(bubble)) {\r\n        const set = this.selectedMids.get(this.chat.peerId);\r\n        if(set) {\r\n          // const mids = await this.chat.getMidsByMid(mid);\r\n          const mids = this.getMidsFromGroupContainer(bubble);\r\n          mids.forEach((mid) => set.delete(mid));\r\n        }\r\n      }\r\n\r\n      /* const promises =  */this.bubbles.getBubbleGroupedItems(bubble).map(this.toggleByElement);\r\n      // await Promise.all(promises);\r\n      return;\r\n    }\r\n\r\n    if(!this.toggleMid(this.chat.peerId, mid)) {\r\n      return;\r\n    }\r\n\r\n    const isGroupedItem = bubble.classList.contains('grouped-item');\r\n    if(isGroupedItem) {\r\n      const groupContainer = findUpClassName(bubble, 'bubble');\r\n      const isGroupedSelected = this.isGroupedBubbleSelected(groupContainer);\r\n      const isGroupedMidsSelected = this.isGroupedMidsSelected(groupContainer);\r\n\r\n      const willChange = isGroupedMidsSelected || isGroupedSelected;\r\n      if(willChange) {\r\n        this.updateElementSelection(groupContainer, isGroupedMidsSelected);\r\n      }\r\n    }\r\n\r\n    this.updateElementSelection(bubble, this.isMidSelected(this.chat.peerId, mid));\r\n  };\r\n\r\n  protected toggleByMid = async(peerId: PeerId, mid: number) => {\r\n    const mounted = await this.bubbles.getMountedBubble(mid);\r\n    if(mounted) {\r\n      this.toggleByElement(mounted.bubble);\r\n    }\r\n  };\r\n\r\n  public isElementShouldBeSelected(element: HTMLElement) {\r\n    const isGrouped = element.classList.contains('is-grouped');\r\n    return super.isElementShouldBeSelected(element) && (!isGrouped || this.isGroupedMidsSelected(element));\r\n  }\r\n\r\n  protected isGroupedBubbleSelected(bubble: HTMLElement) {\r\n    const groupedCheckboxInput = this.getCheckboxInputFromElement(bubble);\r\n    return groupedCheckboxInput?.checked;\r\n  }\r\n\r\n  protected getMidsFromGroupContainer(groupContainer: HTMLElement) {\r\n    const elements = this.chat.bubbles.getBubbleGroupedItems(groupContainer);\r\n    if(!elements.length) {\r\n      elements.push(groupContainer);\r\n    }\r\n\r\n    return elements.map((element) => +element.dataset.mid);\r\n  }\r\n\r\n  protected isGroupedMidsSelected(groupContainer: HTMLElement) {\r\n    const mids = this.getMidsFromGroupContainer(groupContainer);\r\n    const selectedMids = mids.filter((mid) => this.isMidSelected(this.chat.peerId, mid));\r\n    return mids.length === selectedMids.length;\r\n  }\r\n\r\n  protected getCheckboxInputFromElement(bubble: HTMLElement) {\r\n    /* let perf = performance.now();\r\n    let checkbox = bubble.firstElementChild.tagName === 'LABEL' && bubble.firstElementChild.firstElementChild as HTMLInputElement;\r\n    console.log('getCheckboxInputFromBubble firstElementChild time:', performance.now() - perf);\r\n  \r\n    perf = performance.now();\r\n    checkbox = bubble.querySelector('label input');\r\n    console.log('getCheckboxInputFromBubble querySelector time:', performance.now() - perf); */\r\n    /* let perf = performance.now();\r\n    let contains = bubble.classList.contains('document-container');\r\n    console.log('getCheckboxInputFromBubble classList time:', performance.now() - perf);\r\n  \r\n    perf = performance.now();\r\n    contains = bubble.className.includes('document-container');\r\n    console.log('getCheckboxInputFromBubble className time:', performance.now() - perf); */\r\n  \r\n    return bubble.classList.contains('document-container') ? \r\n      bubble.querySelector('label input') as HTMLInputElement : \r\n      super.getCheckboxInputFromElement(bubble);\r\n  }\r\n\r\n  public canSelectBubble(bubble: HTMLElement) {\r\n    return !bubble.classList.contains('service') && \r\n      !bubble.classList.contains('is-outgoing') && \r\n      !bubble.classList.contains('bubble-first') && \r\n      !bubble.classList.contains('avoid-selection');\r\n  }\r\n\r\n  protected onToggleSelection = async(forwards: boolean, animate: boolean) => {\r\n    const {needTranslateX, widthFrom, widthTo} = await this.chat.input.center(animate);\r\n\r\n    SetTransition(this.listenElement, 'is-selecting', forwards, animate ? 200 : 0, () => {\r\n      if(!this.isSelecting) {\r\n        this.selectionInputWrapper.remove();\r\n        this.selectionInputWrapper = \r\n          this.selectionContainer = \r\n          this.selectionSendNowBtn = \r\n          this.selectionForwardBtn = \r\n          this.selectionDeleteBtn = \r\n          this.selectionLeft = \r\n          this.selectionRight = \r\n          null;\r\n        this.selectedText = undefined;\r\n      }\r\n      \r\n      /* fastRaf(() => {\r\n        this.bubbles.onScroll();\r\n      }); */\r\n    });\r\n\r\n    //const chatInput = this.appImManager.chatInput;\r\n\r\n    const translateButtonsX = widthFrom < widthTo ? undefined : needTranslateX * 2;\r\n    if(this.isSelecting) {\r\n      if(!this.selectionContainer) {\r\n        this.selectionInputWrapper = document.createElement('div');\r\n        this.selectionInputWrapper.classList.add('chat-input-wrapper', 'selection-wrapper');\r\n\r\n        // const background = document.createElement('div');\r\n        // background.classList.add('chat-input-wrapper-background');\r\n\r\n        this.selectionContainer = document.createElement('div');\r\n        this.selectionContainer.classList.add('selection-container');\r\n\r\n        const attachClickOptions: AttachClickOptions = {listenerSetter: this.listenerSetter};\r\n        const btnCancel = ButtonIcon('close', {noRipple: true});\r\n        attachClickEvent(btnCancel, () => this.cancelSelection(), {once: true, listenerSetter: this.listenerSetter});\r\n\r\n        this.selectionCountEl = document.createElement('div');\r\n        this.selectionCountEl.classList.add('selection-container-count');\r\n\r\n        if(this.chat.type === 'scheduled') {\r\n          this.selectionSendNowBtn = Button('btn-primary btn-transparent btn-short text-bold selection-container-send', {icon: 'send2'});\r\n          this.selectionSendNowBtn.append(i18n('MessageScheduleSend'));\r\n          attachClickEvent(this.selectionSendNowBtn, () => {\r\n            new PopupSendNow(this.chat.peerId, [...this.selectedMids.get(this.chat.peerId)], () => {\r\n              this.cancelSelection();\r\n            });\r\n          }, attachClickOptions);\r\n        } else {\r\n          this.selectionForwardBtn = Button('btn-primary btn-transparent text-bold selection-container-forward', {icon: 'forward'});\r\n          this.selectionForwardBtn.append(i18n('Forward'));\r\n          attachClickEvent(this.selectionForwardBtn, () => {\r\n            const obj: {[fromPeerId: PeerId]: number[]} = {};\r\n            for(const [fromPeerId, mids] of this.selectedMids) {\r\n              obj[fromPeerId] = Array.from(mids).sort((a, b) => a - b);\r\n            }\r\n\r\n            new PopupForward(obj, () => {\r\n              this.cancelSelection();\r\n            });\r\n          }, attachClickOptions);\r\n        }\r\n\r\n        this.selectionDeleteBtn = Button('btn-primary btn-transparent danger text-bold selection-container-delete', {icon: 'delete'});\r\n        this.selectionDeleteBtn.append(i18n('Delete'));\r\n        attachClickEvent(this.selectionDeleteBtn, () => {\r\n          new PopupDeleteMessages(this.chat.peerId, [...this.selectedMids.get(this.chat.peerId)], this.chat.type, () => {\r\n            this.cancelSelection();\r\n          });\r\n        }, attachClickOptions);\r\n\r\n        const left = this.selectionLeft = document.createElement('div');\r\n        left.classList.add('selection-container-left');\r\n        left.append(btnCancel, this.selectionCountEl);\r\n\r\n        const right = this.selectionRight = document.createElement('div');\r\n        right.classList.add('selection-container-right');\r\n        right.append(...[\r\n          this.selectionSendNowBtn, \r\n          this.selectionForwardBtn, \r\n          this.selectionDeleteBtn\r\n        ].filter(Boolean))\r\n\r\n        if(translateButtonsX !== undefined) {\r\n          left.style.transform = `translateX(${-translateButtonsX}px)`;\r\n          right.style.transform = `translateX(${translateButtonsX}px)`;\r\n        }\r\n\r\n        this.selectionContainer.append(left, right);\r\n\r\n        // background.style.opacity = '0';\r\n        this.selectionInputWrapper.style.opacity = '0';\r\n        this.selectionInputWrapper.append(/* background,  */this.selectionContainer);\r\n        this.input.inputContainer.append(this.selectionInputWrapper);\r\n        \r\n        void this.selectionInputWrapper.offsetLeft; // reflow\r\n        // background.style.opacity = '';\r\n        this.selectionInputWrapper.style.opacity = '';\r\n        left.style.transform = '';\r\n        right.style.transform = '';\r\n      }\r\n    } else if(this.selectionLeft && translateButtonsX !== undefined) {\r\n      this.selectionLeft.style.transform = `translateX(-${translateButtonsX}px)`;\r\n      this.selectionRight.style.transform = `translateX(${translateButtonsX}px)`;\r\n    }\r\n  };\r\n\r\n  protected onUpdateContainer = (cantForward: boolean, cantDelete: boolean, cantSend: boolean) => {\r\n    replaceContent(this.selectionCountEl, i18n('messages', [this.length()]));\r\n    this.selectionSendNowBtn && this.selectionSendNowBtn.toggleAttribute('disabled', cantSend);\r\n    this.selectionForwardBtn && this.selectionForwardBtn.toggleAttribute('disabled', cantForward);\r\n    this.selectionDeleteBtn.toggleAttribute('disabled', cantDelete);\r\n  };\r\n\r\n  protected onCancelSelection = async() => {\r\n    return;\r\n    const promises: Promise<HTMLElement>[] = [];\r\n    for(const [peerId, mids] of this.selectedMids) {\r\n      for(const mid of mids) {\r\n        promises.push(this.bubbles.getMountedBubble(mid).then((m) => m?.bubble));\r\n      }\r\n    }\r\n\r\n    const bubbles = filterUnique((await Promise.all(promises)).filter(Boolean));\r\n    bubbles.forEach((bubble) => {\r\n      this.toggleByElement(bubble);\r\n    });\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function getSelectedText(): string {\r\n  if(window.getSelection) {\r\n    return window.getSelection().toString();\r\n    // @ts-ignore\r\n  } else if(document.selection) {\r\n    // @ts-ignore\r\n    return document.selection.createRange().text;\r\n  }\r\n  \r\n  return '';\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport limitSymbols from \"../../helpers/string/limitSymbols\";\r\nimport { WebPage } from \"../../layer\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\n\r\nexport default function wrapWebPageDescription(webPage: WebPage.webPage) {\r\n  const shortDescriptionText = limitSymbols(webPage.description || '', 150, 180);\r\n  // const siteName = webPage.site_name;\r\n  // let contextHashtag = '';\r\n  // if(siteName === 'GitHub') {\r\n  //   const matches = apiWebPage.url.match(/(https?:\\/\\/github\\.com\\/[^\\/]+\\/[^\\/]+)/);\r\n  //   if(matches) {\r\n  //     contextHashtag = matches[0] + '/issues/{1}';\r\n  //   }\r\n  // }\r\n  return wrapRichText(shortDescriptionText/* , {\r\n    contextSite: siteName || 'external',\r\n    contextHashtag: contextHashtag\r\n  } */);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport limitSymbols from \"../../helpers/string/limitSymbols\";\r\nimport { WebPage } from \"../../layer\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\n\r\nexport default function wrapWebPageTitle(webPage: WebPage.webPage) {\r\n  let shortTitle = webPage.title || webPage.author || webPage.site_name || '';\r\n  shortTitle = limitSymbols(shortTitle, 80, 100);\r\n  return wrapRichText(shortTitle, {noLinks: true, noLinebreaks: true});\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport mediaSizes from \"./mediaSizes\";\r\n\r\nexport type MenuPositionPadding = {\r\n  top?: number, \r\n  right?: number, \r\n  bottom?: number, \r\n  left?: number\r\n};\r\n\r\nconst PADDING_TOP = 8;\r\nconst PADDING_BOTTOM = PADDING_TOP;\r\nconst PADDING_LEFT = 8;\r\nconst PADDING_RIGHT = PADDING_LEFT;\r\nexport default function positionMenu({pageX, pageY}: MouseEvent | Touch, elem: HTMLElement, side?: 'left' | 'right' | 'center', additionalPadding?: MenuPositionPadding) {\r\n  //let {clientX, clientY} = e;\r\n\r\n  // * side mean the OPEN side\r\n\r\n  const getScrollWidthFromElement = (Array.from(elem.children) as HTMLElement[]).find((element) => element.classList.contains('btn-menu-item') && !element.classList.contains('hide')) || elem;\r\n\r\n  let {scrollWidth: menuWidth} = getScrollWidthFromElement;\r\n  let {scrollHeight: menuHeight} = elem;\r\n  //let {innerWidth: windowWidth, innerHeight: windowHeight} = window;\r\n  const rect = document.body.getBoundingClientRect();\r\n  const windowWidth = rect.width;\r\n  const windowHeight = rect.height;\r\n\r\n  let paddingTop = PADDING_TOP, paddingRight = PADDING_RIGHT, paddingBottom = PADDING_BOTTOM, paddingLeft = PADDING_LEFT;\r\n  if(additionalPadding) {\r\n    if(additionalPadding.top) paddingTop += additionalPadding.top;\r\n    if(additionalPadding.right) paddingRight += additionalPadding.right;\r\n    if(additionalPadding.bottom) paddingBottom += additionalPadding.bottom;\r\n    if(additionalPadding.left) paddingLeft += additionalPadding.left;\r\n  }\r\n\r\n  side = mediaSizes.isMobile ? 'right' : 'left';\r\n  let verticalSide: 'top' /* | 'bottom' */ | 'center' = 'top';\r\n\r\n  const maxTop = windowHeight - menuHeight - paddingBottom;\r\n  const maxLeft = windowWidth - menuWidth - paddingRight;\r\n  const minTop = paddingTop;\r\n  const minLeft = paddingLeft;\r\n\r\n  const getSides = () => {\r\n    return {\r\n      x: {\r\n        left: pageX,\r\n        right: Math.min(maxLeft, pageX - menuWidth)\r\n      },\r\n      intermediateX: side === 'right' ? minLeft : maxLeft,\r\n      //intermediateX: clientX < windowWidth / 2 ? PADDING_LEFT : windowWidth - menuWidth - PADDING_LEFT,\r\n      y: {\r\n        top: pageY,\r\n        bottom: pageY - menuHeight\r\n      },\r\n      //intermediateY: verticalSide === 'top' ? paddingTop : windowHeight - menuHeight - paddingTop,\r\n      // intermediateY: pageY < (windowHeight / 2) ? paddingTop : windowHeight - menuHeight - paddingBottom,\r\n      intermediateY: maxTop,\r\n    };\r\n  };\r\n\r\n  const sides = getSides();\r\n\r\n  const possibleSides = {\r\n    x: {\r\n      left: (sides.x.left + menuWidth + paddingRight) <= windowWidth,\r\n      right: sides.x.right >= paddingLeft\r\n    },\r\n    y: {\r\n      top: (sides.y.top + menuHeight + paddingBottom) <= windowHeight,\r\n      bottom: (sides.y.bottom - paddingBottom) >= paddingBottom\r\n    }\r\n  };\r\n\r\n  /* if(side === undefined) {\r\n    if((clientX + menuWidth + PADDING_LEFT) > windowWidth) {\r\n      side = 'right';\r\n    }\r\n  } */\r\n\r\n  {\r\n    /* const x = sides.x;\r\n\r\n    const s = Object.keys(x) as (keyof typeof possibleSides.x)[];\r\n    if(side) {\r\n      s.findAndSplice((s) => s === side);\r\n      s.unshift(side);\r\n    }\r\n\r\n    const possibleSide = s.find((s) => possibleSides.x[s]); */\r\n    let left: number;\r\n    /* if(possibleSide) {\r\n      left = x[possibleSide];\r\n      side = possibleSide;\r\n    } else {\r\n      left = sides.intermediateX;\r\n      side = undefined;\r\n    } */\r\n    left = possibleSides.x[side] ? sides.x[side] : (side = 'center', sides.intermediateX);\r\n  \r\n    elem.style.left = left + 'px';\r\n  }\r\n\r\n  /* if((clientY + menuHeight + PADDING_TOP) > windowHeight) {\r\n    elem.style.top = clamp(clientY - menuHeight, PADDING_TOP, windowHeight - menuHeight - PADDING_TOP) + 'px';\r\n    // elem.style.top = (innerHeight - scrollHeight - PADDING_TOP) + 'px';\r\n    verticalSide = 'bottom';\r\n  } else {\r\n    elem.style.top = Math.max(PADDING_TOP, clientY) + 'px';\r\n    verticalSide = 'top';\r\n  } */\r\n\r\n  {\r\n    let top: number;\r\n\r\n    top = possibleSides.y[verticalSide] ? sides.y[verticalSide] : (verticalSide = 'center', sides.intermediateY);\r\n  \r\n    elem.style.top = top + 'px';\r\n  }\r\n  \r\n  elem.className = elem.className.replace(/(top|center|bottom)-(left|center|right)/g, '');\r\n  elem.classList.add(\r\n    //(verticalSide === 'center' ? verticalSide : (verticalSide === 'bottom' ? 'top' : 'bottom')) +\r\n    (verticalSide === 'center' ? verticalSide : 'bottom') +\r\n    '-' +\r\n    (side === 'center' ? side : (side === 'left' ? 'right' : 'left')));\r\n\r\n  return {\r\n    width: menuWidth,\r\n    height: menuHeight\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDialogsManager, { DIALOG_LIST_ELEMENT_TAG } from \"../lib/appManagers/appDialogsManager\";\r\nimport type { MyInputMessagesFilter, MyMessage } from \"../lib/appManagers/appMessagesManager\";\r\nimport { logger } from \"../lib/logger\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { SearchGroup, SearchGroupType } from \"./appSearch\";\r\nimport { horizontalMenu } from \"./horizontalMenu\";\r\nimport LazyLoadQueue from \"./lazyLoadQueue\";\r\nimport { putPreloader } from \"./putPreloader\";\r\nimport ripple from \"./ripple\";\r\nimport Scrollable, { ScrollableX } from \"./scrollable\";\r\nimport { wrapDocument, wrapPhoto, wrapVideo } from \"./wrappers\";\r\nimport useHeavyAnimationCheck, { getHeavyAnimationPromise } from \"../hooks/useHeavyAnimationCheck\";\r\nimport I18n, { LangPackKey, i18n } from \"../lib/langPack\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport { getMiddleware } from \"../helpers/middleware\";\r\nimport { ChannelParticipant, ChatFull, ChatParticipant, ChatParticipants, Document, Message, MessageMedia, Photo, WebPage } from \"../layer\";\r\nimport SortedUserList from \"./sortedUserList\";\r\nimport findUpTag from \"../helpers/dom/findUpTag\";\r\nimport appSidebarRight from \"./sidebarRight\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport appImManager from \"../lib/appManagers/appImManager\";\r\nimport positionElementByIndex from \"../helpers/dom/positionElementByIndex\";\r\nimport cleanSearchText from \"../helpers/cleanSearchText\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport handleTabSwipe from \"../helpers/dom/handleTabSwipe\";\r\nimport windowSize from \"../helpers/windowSize\";\r\nimport { formatPhoneNumber } from \"../helpers/formatPhoneNumber\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"./buttonMenu\";\r\nimport PopupForward from \"./popups/forward\";\r\nimport PopupDeleteMessages from \"./popups/deleteMessages\";\r\nimport Row from \"./row\";\r\nimport htmlToDocumentFragment from \"../helpers/dom/htmlToDocumentFragment\";\r\nimport { SearchSelection } from \"./chat/selection\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent, simulateClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport AppMediaViewer from \"./appMediaViewer\";\r\nimport lockTouchScroll from \"../helpers/dom/lockTouchScroll\";\r\nimport copy from \"../helpers/object/copy\";\r\nimport getObjectKeysAndSort from \"../helpers/object/getObjectKeysAndSort\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport escapeRegExp from \"../helpers/string/escapeRegExp\";\r\nimport findAndSplice from \"../helpers/array/findAndSplice\";\r\nimport { ScrollStartCallbackDimensions } from \"../helpers/fastSmoothScroll\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport choosePhotoSize from \"../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport wrapWebPageDescription from \"./wrappers/webPageDescription\";\r\nimport wrapWebPageTitle from \"./wrappers/webPageTitle\";\r\nimport getAbbreviation from \"../lib/richTextProcessor/getAbbreviation\";\r\nimport matchUrl from \"../lib/richTextProcessor/matchUrl\";\r\nimport wrapPlainText from \"../lib/richTextProcessor/wrapPlainText\";\r\nimport wrapRichText from \"../lib/richTextProcessor/wrapRichText\";\r\nimport wrapSenderToPeer from \"./wrappers/senderToPeer\";\r\nimport wrapSentTime from \"./wrappers/sentTime\";\r\nimport getMediaFromMessage from \"../lib/appManagers/utils/messages/getMediaFromMessage\";\r\nimport filterMessagesByInputFilter from \"../lib/appManagers/utils/messages/filterMessagesByInputFilter\";\r\nimport getChatMembersString from \"./wrappers/getChatMembersString\";\r\nimport getUserStatusString from \"./wrappers/getUserStatusString\";\r\nimport getParticipantPeerId from \"../lib/appManagers/utils/chats/getParticipantPeerId\";\r\nimport { Awaited } from \"../types\";\r\nimport { attachContextMenuListener } from \"../helpers/dom/attachContextMenuListener\";\r\nimport contextMenuController from \"../helpers/contextMenuController\";\r\nimport positionMenu from \"../helpers/positionMenu\";\r\nimport apiManagerProxy from \"../lib/mtproto/mtprotoworker\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport SwipeHandler from \"./swipeHandler\";\r\n\r\n//const testScroll = false;\r\n\r\nexport type SearchSuperType = MyInputMessagesFilter/*  | 'members' */;\r\nexport type SearchSuperContext = {\r\n  peerId: PeerId,\r\n  inputFilter: {_: MyInputMessagesFilter},\r\n  query?: string,\r\n  maxId?: number,\r\n  folderId?: number,\r\n  threadId?: number,\r\n  date?: number,\r\n  nextRate?: number,\r\n  minDate?: number,\r\n  maxDate?: number\r\n};\r\n\r\nexport type SearchSuperMediaType = 'members' | 'media' | 'files' | 'links' | 'music' | 'chats' | 'voice';\r\nexport type SearchSuperMediaTab = {\r\n  inputFilter: SearchSuperType,\r\n  name: LangPackKey,\r\n  type: SearchSuperMediaType,\r\n  contentTab?: HTMLElement,\r\n  menuTab?: HTMLElement,\r\n  scroll?: {scrollTop: number, scrollHeight: number}\r\n};\r\n\r\nclass SearchContextMenu {\r\n  private buttons: (ButtonMenuItemOptions & {verify?: () => boolean | Promise<boolean>, withSelection?: true})[];\r\n  private element: HTMLElement;\r\n  private target: HTMLElement;\r\n  private peerId: PeerId;\r\n  private mid: number;\r\n  private isSelected: boolean;\r\n  private managers: AppManagers;\r\n\r\n  constructor(\r\n    private attachTo: HTMLElement,\r\n    private searchSuper: AppSearchSuper,\r\n    private listenerSetter: ListenerSetter\r\n  ) {\r\n    this.managers = searchSuper.managers;\r\n\r\n    const onContextMenu = (e: MouseEvent) => {\r\n      if(this.init) {\r\n        this.init();\r\n        this.init = null;\r\n      }\r\n\r\n      let item: HTMLElement;\r\n      try {\r\n        item = findUpClassName(e.target, 'search-super-item');\r\n      } catch(e) {}\r\n\r\n      if(!item) return;\r\n\r\n      if(e instanceof MouseEvent) e.preventDefault();\r\n      if(this.element.classList.contains('active')) {\r\n        return false;\r\n      }\r\n      if(e instanceof MouseEvent) e.cancelBubble = true;\r\n\r\n      const r = async() => {\r\n        this.target = item;\r\n        this.peerId = item.dataset.peerId.toPeerId();\r\n        this.mid = +item.dataset.mid;\r\n        this.isSelected = searchSuper.selection.isMidSelected(this.peerId, this.mid);\r\n  \r\n        await Promise.all(this.buttons.map(async(button) => {\r\n          let good: boolean;\r\n  \r\n          if(this.isSelected && !button.withSelection) {\r\n            good = false;\r\n          } else {\r\n            good = button.verify ? await button.verify() : true;\r\n          }\r\n  \r\n          button.element.classList.toggle('hide', !good);\r\n        }));\r\n  \r\n        item.classList.add('menu-open');\r\n  \r\n        positionMenu(e, this.element);\r\n        contextMenuController.openBtnMenu(this.element, () => {\r\n          item.classList.remove('menu-open');\r\n        });\r\n      };\r\n\r\n      r();\r\n    };\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n\r\n    } else {\r\n      attachContextMenuListener(attachTo, onContextMenu as any, listenerSetter);\r\n    }\r\n  }\r\n\r\n  private init() {\r\n    this.buttons = [{\r\n      icon: 'forward',\r\n      text: 'Forward',\r\n      onClick: this.onForwardClick,\r\n      verify: async() => this.managers.appMessagesManager.canForward(await this.managers.appMessagesManager.getMessageByPeer(this.peerId, this.mid))\r\n    }, {\r\n      icon: 'forward',\r\n      text: 'Message.Context.Selection.Forward',\r\n      onClick: this.onForwardClick,\r\n      verify: () => this.isSelected && \r\n        !this.searchSuper.selection.selectionForwardBtn.classList.contains('hide'),\r\n      withSelection: true\r\n    }, {\r\n      icon: 'message',\r\n      text: 'Message.Context.Goto',\r\n      onClick: this.onGotoClick,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'select',\r\n      text: 'Message.Context.Select',\r\n      onClick: this.onSelectClick\r\n    }, {\r\n      icon: 'select',\r\n      text: 'Message.Context.Selection.Clear',\r\n      onClick: this.onClearSelectionClick,\r\n      verify: () => this.isSelected,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'delete danger',\r\n      text: 'Delete',\r\n      onClick: this.onDeleteClick,\r\n      verify: async() => this.managers.appMessagesManager.canDeleteMessage(await this.managers.appMessagesManager.getMessageByPeer(this.peerId, this.mid))\r\n    }, {\r\n      icon: 'delete danger',\r\n      text: 'Message.Context.Selection.Delete',\r\n      onClick: this.onDeleteClick,\r\n      verify: () => this.isSelected && !this.searchSuper.selection.selectionDeleteBtn.classList.contains('hide'),\r\n      withSelection: true\r\n    }];\r\n\r\n    this.element = ButtonMenu(this.buttons);\r\n    this.element.classList.add('search-contextmenu', 'contextmenu');\r\n    document.getElementById('page-chats').append(this.element);\r\n  }\r\n\r\n  private onGotoClick = () => {\r\n    appImManager.setInnerPeer({\r\n      peerId: this.peerId,\r\n      lastMsgId: this.mid,\r\n      threadId: this.searchSuper.searchContext.threadId\r\n    });\r\n  };\r\n\r\n  private onForwardClick = () => {\r\n    if(this.searchSuper.selection.isSelecting) {\r\n      simulateClickEvent(this.searchSuper.selection.selectionForwardBtn);\r\n    } else {\r\n      new PopupForward({\r\n        [this.peerId]: [this.mid]\r\n      });\r\n    }\r\n  };\r\n\r\n  private onSelectClick = () => {\r\n    this.searchSuper.selection.toggleByElement(this.target);\r\n  };\r\n\r\n  private onClearSelectionClick = () => {\r\n    this.searchSuper.selection.cancelSelection();\r\n  };\r\n\r\n  private onDeleteClick = () => {\r\n    if(this.searchSuper.selection.isSelecting) {\r\n      simulateClickEvent(this.searchSuper.selection.selectionDeleteBtn);\r\n    } else {\r\n      new PopupDeleteMessages(this.peerId, [this.mid], 'chat');\r\n    }\r\n  };\r\n}\r\n\r\nexport type ProcessSearchSuperResult = {\r\n  message: Message.message, \r\n  middleware: () => boolean, \r\n  promises: Promise<any>[], \r\n  elemsToAppend: {element: HTMLElement, message: any}[],\r\n  inputFilter: MyInputMessagesFilter,\r\n  searchGroup?: SearchGroup\r\n};\r\n\r\nexport default class AppSearchSuper {\r\n  public tabs: {[t in SearchSuperType]: HTMLDivElement} = {} as any;\r\n\r\n  public mediaTab: SearchSuperMediaTab;\r\n\r\n  public container: HTMLElement;\r\n  public nav: HTMLElement;\r\n  public navScrollableContainer: HTMLDivElement;\r\n  public tabsContainer: HTMLElement;\r\n  public navScrollable: ScrollableX;\r\n  private tabsMenu: HTMLElement;\r\n  private prevTabId = -1;\r\n  \r\n  private lazyLoadQueue = new LazyLoadQueue();\r\n  public middleware = getMiddleware();\r\n\r\n  public historyStorage: Partial<{[type in SearchSuperType]: {mid: number, peerId: PeerId}[]}> = {};\r\n  public usedFromHistory: Partial<{[type in SearchSuperType]: number}> = {};\r\n  public urlsToRevoke: string[] = [];\r\n\r\n  public searchContext: SearchSuperContext;\r\n  public loadMutex: Promise<any> = Promise.resolve();\r\n\r\n  private nextRates: Partial<{[type in SearchSuperType]: number}> = {};\r\n  private loadPromises: Partial<{[type in SearchSuperType]: Promise<void>}> = {};\r\n  private loaded: Partial<{[type in SearchSuperType]: boolean}> = {};\r\n  private loadedChats = false;\r\n  private firstLoad = true;\r\n\r\n  private log = logger('SEARCH-SUPER');\r\n  public selectTab: ReturnType<typeof horizontalMenu>;\r\n  \r\n  private monthContainers: Partial<{\r\n    [type in SearchSuperType]: {\r\n      [timestamp: number]: {\r\n        container: HTMLElement,\r\n        items: HTMLElement\r\n      }\r\n    }\r\n  }> = {};\r\n\r\n  private searchGroupMedia: SearchGroup;\r\n\r\n  public mediaTabsMap: Map<SearchSuperMediaType, SearchSuperMediaTab> = new Map();\r\n\r\n  private membersList: SortedUserList;\r\n\r\n  private skipScroll: boolean;\r\n\r\n  // * arguments\r\n  public mediaTabs: SearchSuperMediaTab[];\r\n  public scrollable: Scrollable;\r\n  public searchGroups?: {[group in SearchGroupType]: SearchGroup};\r\n  public asChatList? = false;\r\n  public groupByMonth? = true;\r\n  public hideEmptyTabs? = true;\r\n  public onChangeTab?: (mediaTab: SearchSuperMediaTab) => void;\r\n  public showSender? = false;\r\n\r\n  private searchContextMenu: SearchContextMenu;\r\n  public selection: SearchSelection;\r\n\r\n  public scrollStartCallback: (dimensions: ScrollStartCallbackDimensions) => void;\r\n\r\n  public managers: AppManagers;\r\n  private loadFirstTimePromise: Promise<void>;\r\n\r\n  private listenerSetter: ListenerSetter;\r\n  private swipeHandler: SwipeHandler;\r\n\r\n  constructor(options: Pick<AppSearchSuper, 'mediaTabs' | 'scrollable' | 'searchGroups' | 'asChatList' | 'groupByMonth' | 'hideEmptyTabs' | 'onChangeTab' | 'showSender' | 'managers'>) {\r\n    safeAssign(this, options);\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('search-super');\r\n\r\n    this.listenerSetter = new ListenerSetter();\r\n    this.searchContextMenu = new SearchContextMenu(this.container, this, this.listenerSetter);\r\n    this.selection = new SearchSelection(this, this.managers, this.listenerSetter);\r\n\r\n    const navScrollableContainer = this.navScrollableContainer = document.createElement('div');\r\n    navScrollableContainer.classList.add('search-super-tabs-scrollable', 'menu-horizontal-scrollable', 'sticky');\r\n\r\n    const navScrollable = this.navScrollable = new ScrollableX(navScrollableContainer);\r\n    navScrollable.container.classList.add('search-super-nav-scrollable');\r\n\r\n    const nav = this.nav = document.createElement('nav');\r\n    nav.classList.add('search-super-tabs', 'menu-horizontal-div');\r\n    this.tabsMenu = nav;\r\n\r\n    navScrollable.container.append(nav);\r\n\r\n    for(const mediaTab of this.mediaTabs) {\r\n      const menuTab = document.createElement('div');\r\n      menuTab.classList.add('menu-horizontal-div-item');\r\n      const span = document.createElement('span');\r\n      const i = document.createElement('i');\r\n\r\n      span.append(i18n(mediaTab.name));\r\n      span.append(i);\r\n\r\n      menuTab.append(span);\r\n\r\n      ripple(menuTab);\r\n\r\n      this.tabsMenu.append(menuTab);\r\n\r\n      this.mediaTabsMap.set(mediaTab.type, mediaTab);\r\n\r\n      mediaTab.menuTab = menuTab;\r\n    }\r\n\r\n    this.tabsContainer = document.createElement('div');\r\n    this.tabsContainer.classList.add('search-super-tabs-container', 'tabs-container');\r\n\r\n    let unlockScroll: ReturnType<typeof lockTouchScroll>;\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      this.swipeHandler = handleTabSwipe({\r\n        element: this.tabsContainer, \r\n        onSwipe: (xDiff, yDiff, e) => {\r\n          const prevId = this.selectTab.prevId();\r\n          const children = Array.from(this.tabsMenu.children) as HTMLElement[];\r\n          let idx: number;\r\n          if(xDiff > 0) {\r\n            for(let i = prevId + 1; i < children.length; ++i) {\r\n              if(!children[i].classList.contains('hide')) {\r\n                idx = i;\r\n                break;\r\n              }\r\n            }\r\n          } else {\r\n            for(let i = prevId - 1; i >= 0; --i) {\r\n              if(!children[i].classList.contains('hide')) {\r\n                idx = i;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n\r\n          if(idx !== undefined) {\r\n            unlockScroll = lockTouchScroll(this.tabsContainer);\r\n            this.selectTab(idx);\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    for(const mediaTab of this.mediaTabs) {\r\n      const container = document.createElement('div');\r\n      container.classList.add('search-super-container-' + mediaTab.type, 'tabs-tab');\r\n\r\n      const content = document.createElement('div');\r\n      content.classList.add('search-super-content-' + mediaTab.type);\r\n\r\n      container.append(content);\r\n\r\n      this.tabsContainer.append(container);\r\n\r\n      this.tabs[mediaTab.inputFilter] = content;\r\n\r\n      mediaTab.contentTab = content;\r\n    }\r\n\r\n    this.container.append(navScrollableContainer, this.tabsContainer);\r\n\r\n    // * construct end\r\n\r\n    this.searchGroupMedia = new SearchGroup(false, 'messages', true);\r\n\r\n    this.scrollable.onScrolledBottom = () => {\r\n      if(this.mediaTab.contentTab && this.canLoadMediaTab(this.mediaTab)/* && false */) {\r\n        //this.log('onScrolledBottom will load media');\r\n        this.load(true);\r\n      }\r\n    };\r\n    //this.scroll.attachSentinels(undefined, 400);\r\n\r\n    this.selectTab = horizontalMenu(this.tabsMenu, this.tabsContainer, (id, tabContent, animate) => {\r\n      if(this.prevTabId === id && !this.skipScroll) {\r\n        this.scrollable.scrollIntoViewNew({\r\n          element: this.container, \r\n          position: 'start',\r\n          startCallback: this.scrollStartCallback\r\n        });\r\n        return;\r\n      }\r\n      \r\n      const newMediaTab = this.mediaTabs[id];\r\n      if(this.onChangeTab) {\r\n        this.onChangeTab(newMediaTab);\r\n      }\r\n      \r\n      const fromMediaTab = this.mediaTab;\r\n      this.mediaTab = newMediaTab;\r\n\r\n      if(this.prevTabId !== -1 && animate) {\r\n        this.onTransitionStart();\r\n      }\r\n\r\n      if(this.skipScroll) {\r\n        this.skipScroll = false;\r\n      } else {\r\n        const offsetTop = this.container.offsetTop;\r\n        let scrollTop = this.scrollable.scrollTop;\r\n        if(scrollTop < offsetTop) {\r\n          this.scrollable.scrollIntoViewNew({\r\n            element: this.container, \r\n            position: 'start',\r\n            startCallback: this.scrollStartCallback\r\n          });\r\n          scrollTop = offsetTop;\r\n        }\r\n        \r\n        fromMediaTab.scroll = {scrollTop: scrollTop, scrollHeight: this.scrollable.scrollHeight};\r\n  \r\n        if(newMediaTab.scroll === undefined) {\r\n          const rect = this.container.getBoundingClientRect();\r\n          const rect2 = this.container.parentElement.getBoundingClientRect();\r\n          const diff = rect.y - rect2.y;\r\n  \r\n          if(scrollTop > diff) {\r\n            newMediaTab.scroll = {scrollTop: diff, scrollHeight: 0};\r\n          }\r\n        }\r\n  \r\n        if(newMediaTab.scroll) {\r\n          const diff = fromMediaTab.scroll.scrollTop - newMediaTab.scroll.scrollTop;\r\n          //console.log('what you gonna do', this.goingHard, diff);\r\n  \r\n          //this.scrollable.scrollTop = scrollTop;\r\n          if(diff/*  && diff < 0 */) {\r\n            /* if(diff > -(fromMediaTab.contentTab.scrollHeight + this.nav.scrollHeight)) {\r\n              fromMediaTab.contentTab.style.transform = `translateY(${diff}px)`;\r\n              this.scrollable.scrollTop = scrollTop - diff;\r\n            } else { */\r\n              newMediaTab.contentTab.style.transform = `translateY(${diff}px)`;\r\n            //}\r\n          }\r\n        }\r\n      }\r\n      \r\n      /* if(this.prevTabId !== -1 && nav.offsetTop) {\r\n        this.scrollable.scrollTop -= nav.offsetTop;\r\n      } */\r\n\r\n      /* this.log('setVirtualContainer', id, this.sharedMediaSelected, this.sharedMediaSelected.childElementCount);\r\n      this.scroll.setVirtualContainer(this.sharedMediaSelected); */\r\n\r\n      if(this.prevTabId !== -1 && !newMediaTab.contentTab.childElementCount) { // quick brown fix\r\n        //this.contentContainer.classList.remove('loaded');\r\n        this.load(true);\r\n      }\r\n\r\n      this.prevTabId = id;\r\n    }, () => {\r\n      this.scrollable.onScroll();\r\n      \r\n      //console.log('what y', this.tabSelected.style.transform);\r\n      if(this.mediaTab.scroll !== undefined) {\r\n        this.mediaTab.contentTab.style.transform = '';\r\n        this.scrollable.scrollTop = this.mediaTab.scroll.scrollTop;\r\n      }\r\n\r\n      if(unlockScroll) {\r\n        unlockScroll();\r\n        unlockScroll = undefined;\r\n      }\r\n\r\n      this.onTransitionEnd();\r\n    }, undefined, navScrollable, this.listenerSetter);\r\n\r\n    attachClickEvent(this.tabsContainer, (e) => {\r\n      if(this.selection.isSelecting) {\r\n        cancelEvent(e);\r\n        this.selection.toggleByElement(findUpClassName(e.target, 'search-super-item'));\r\n      }\r\n    }, {capture: true, passive: false, listenerSetter: this.listenerSetter});\r\n    \r\n    const onMediaClick = async(className: string, targetClassName: string, inputFilter: MyInputMessagesFilter, e: MouseEvent) => {\r\n      const target = findUpClassName(e.target as HTMLDivElement, className);\r\n      if(!target) return;\r\n      \r\n      const mid = +target.dataset.mid;\r\n      if(!mid) {\r\n        this.log.warn('no messageId by click on target:', target);\r\n        return;\r\n      }\r\n\r\n      const peerId = target.dataset.peerId.toPeerId();\r\n\r\n      const targets = (Array.from(this.tabs[inputFilter].querySelectorAll('.' + targetClassName)) as HTMLElement[]).map((el) => {\r\n        const containerEl = findUpClassName(el, className);\r\n        return {\r\n          element: el, \r\n          mid: +containerEl.dataset.mid, \r\n          peerId: containerEl.dataset.peerId.toPeerId()\r\n        };\r\n      });\r\n\r\n      //const ids = Object.keys(this.mediaDivsByIds).map((k) => +k).sort((a, b) => a - b);\r\n      const idx = targets.findIndex((item) => item.mid === mid && item.peerId === peerId);\r\n      \r\n      const message = await this.managers.appMessagesManager.getMessageByPeer(peerId, mid);\r\n      new AppMediaViewer()\r\n      .setSearchContext(this.copySearchContext(inputFilter))\r\n      .openMedia(message, targets[idx].element, 0, false, targets.slice(0, idx), targets.slice(idx + 1));\r\n    };\r\n\r\n    attachClickEvent(this.tabs.inputMessagesFilterPhotoVideo, onMediaClick.bind(null, 'grid-item', 'grid-item', 'inputMessagesFilterPhotoVideo'), {listenerSetter: this.listenerSetter});\r\n    attachClickEvent(this.tabs.inputMessagesFilterDocument, onMediaClick.bind(null, 'document-with-thumb', 'media-container', 'inputMessagesFilterDocument'), {listenerSetter: this.listenerSetter});\r\n\r\n    /* attachClickEvent(this.tabs.inputMessagesFilterUrl, (e) => {\r\n      const target = e.target as HTMLElement;\r\n      if(target.tagName === 'A') {\r\n        return;\r\n      }\r\n\r\n      try {\r\n        const a = findUpClassName(target, 'row').querySelector('.anchor-url:last-child') as HTMLAnchorElement;\r\n        a.click();\r\n      } catch(err) {}\r\n    }); */\r\n\r\n    this.mediaTab = this.mediaTabs[0];\r\n\r\n    useHeavyAnimationCheck(() => {\r\n      this.lazyLoadQueue.lock();\r\n    }, () => {\r\n      this.lazyLoadQueue.unlockAndRefresh(); // ! maybe not so efficient\r\n    }, this.listenerSetter);\r\n  }\r\n\r\n  private onTransitionStart = () => {\r\n    this.container.classList.add('sliding');\r\n  };\r\n\r\n  private onTransitionEnd = () => {\r\n    this.container.classList.remove('sliding');\r\n  };\r\n\r\n  public filterMessagesByType(messages: any[], type: SearchSuperType): MyMessage[] {\r\n    return filterMessagesByInputFilter(type, messages, messages.length);\r\n  }\r\n\r\n  private processEmptyFilter({message, searchGroup}: ProcessSearchSuperResult) {\r\n    const loadPromises: Promise<any>[] = [];\r\n    const {dom} = appDialogsManager.addDialogNew({\r\n      peerId: message.peerId, \r\n      container: searchGroup.list, \r\n      avatarSize: 54,\r\n      loadPromises\r\n    });\r\n\r\n    const setLastMessagePromise = appDialogsManager.setLastMessageN({\r\n      dialog: {\r\n        _: 'dialog',\r\n        peerId: message.peerId\r\n      } as any,  \r\n      lastMessage: message, \r\n      dom, \r\n      highlightWord: this.searchContext.query\r\n    });\r\n\r\n    loadPromises.push(setLastMessagePromise);\r\n    return Promise.all(loadPromises);\r\n  }\r\n\r\n  private async processPhotoVideoFilter({message, promises, middleware}: ProcessSearchSuperResult) {\r\n    const media = getMediaFromMessage(message);\r\n\r\n    const div = document.createElement('div');\r\n    div.classList.add('grid-item');\r\n    //this.log(message, photo);\r\n\r\n    let wrapped: Awaited<ReturnType<typeof wrapPhoto>>;\r\n    const size = choosePhotoSize(media, 200, 200);\r\n    if(media._ !== 'photo') {\r\n      wrapped = await (await wrapVideo({\r\n        doc: media,\r\n        message,\r\n        container: div,\r\n        boxWidth: 0,\r\n        boxHeight: 0,\r\n        lazyLoadQueue: this.lazyLoadQueue,\r\n        middleware,\r\n        onlyPreview: true,\r\n        withoutPreloader: true,\r\n        noPlayButton: true,\r\n        size\r\n      })).thumb;\r\n    } else {\r\n      wrapped = await wrapPhoto({\r\n        photo: media,\r\n        message,\r\n        container: div,\r\n        boxWidth: 0,\r\n        boxHeight: 0,\r\n        lazyLoadQueue: this.lazyLoadQueue,\r\n        middleware,\r\n        withoutPreloader: true,\r\n        noBlur: true,\r\n        size\r\n      });\r\n    }\r\n\r\n    [wrapped.images.thumb, wrapped.images.full].filter(Boolean).forEach((image) => {\r\n      image.classList.add('grid-item-media');\r\n    });\r\n\r\n    promises.push(wrapped.loadPromises.thumb);\r\n\r\n    return {element: div, message};\r\n  }\r\n\r\n  private async processDocumentFilter({message, inputFilter}: ProcessSearchSuperResult) {\r\n    const document = getMediaFromMessage(message) as Document.document;\r\n    const showSender = this.showSender || (['voice', 'round'] as MyDocument['type'][]).includes(document.type);\r\n\r\n    const div = await wrapDocument({\r\n      message,\r\n      withTime: !showSender,\r\n      fontWeight: 400,\r\n      voiceAsMusic: true,\r\n      showSender,\r\n      searchContext: this.copySearchContext(inputFilter),\r\n      lazyLoadQueue: this.lazyLoadQueue,\r\n      autoDownloadSize: 0\r\n    });\r\n\r\n    if((['audio', 'voice', 'round'] as MyDocument['type'][]).includes(document.type)) {\r\n      div.classList.add('audio-48');\r\n    }\r\n\r\n    return {message, element: div};\r\n  }\r\n\r\n  private async processUrlFilter({message, promises, middleware}: ProcessSearchSuperResult) {\r\n    let webpage = (message.media as MessageMedia.messageMediaWebPage)?.webpage as WebPage.webPage;\r\n\r\n    if(!webpage) {\r\n      const entity = message.totalEntities ? message.totalEntities.find((e: any) => e._ === 'messageEntityUrl' || e._ === 'messageEntityTextUrl') : null;\r\n      let url: string, display_url: string, sliced: string;\r\n\r\n      if(!entity) {\r\n        //this.log.error('NO ENTITY:', message);\r\n        const match = matchUrl(message.message);\r\n        if(!match) {\r\n          //this.log.error('NO ENTITY AND NO MATCH:', message);\r\n          return;\r\n        }\r\n\r\n        url = match[0];\r\n      } else {\r\n        sliced = message.message.slice(entity.offset, entity.offset + entity.length);\r\n      }\r\n\r\n      if(entity?._ === 'messageEntityTextUrl') {\r\n        url = entity.url;\r\n        //display_url = sliced;\r\n      } else {\r\n        url = url || sliced;\r\n      }\r\n\r\n      display_url = url;\r\n\r\n      const same = message.message === url;\r\n      if(!url.match(/^(ftp|http|https):\\/\\//)) {\r\n        display_url = 'https://' + url;\r\n        url = url.includes('@') ? url : 'https://' + url;\r\n      }\r\n\r\n      display_url = new URL(display_url).hostname;\r\n\r\n      webpage = {\r\n        _: 'webPage',\r\n        url,\r\n        display_url,\r\n        id: '',\r\n        hash: 0\r\n      };\r\n\r\n      if(!same) {\r\n        webpage.description = message.message;\r\n      }\r\n    }\r\n\r\n    let previewDiv = document.createElement('div');\r\n    previewDiv.classList.add('preview', 'row-media');\r\n    \r\n    //this.log('wrapping webpage', webpage);\r\n    \r\n    if(webpage.photo) {\r\n      const res = wrapPhoto({\r\n        container: previewDiv,\r\n        message: null,\r\n        photo: webpage.photo as Photo.photo,\r\n        boxWidth: 0,\r\n        boxHeight: 0,\r\n        withoutPreloader: true,\r\n        lazyLoadQueue: this.lazyLoadQueue,\r\n        middleware,\r\n        size: choosePhotoSize(webpage.photo as Photo.photo, 60, 60, false),\r\n        loadPromises: promises,\r\n        noBlur: true\r\n      });\r\n    } else {\r\n      previewDiv.classList.add('empty');\r\n      setInnerHTML(previewDiv, getAbbreviation(webpage.title || webpage.display_url || webpage.description || webpage.url, true));\r\n    }\r\n    \r\n    let title = wrapWebPageTitle(webpage);\r\n\r\n    const subtitleFragment = wrapWebPageDescription(webpage);\r\n    const aFragment = htmlToDocumentFragment(wrapRichText(webpage.url || ''));\r\n    const a = aFragment.firstElementChild;\r\n    if(a instanceof HTMLAnchorElement) {\r\n      try { // can have 'URIError: URI malformed'\r\n        a.innerText = decodeURIComponent(a.href);\r\n      } catch(err) {\r\n\r\n      }\r\n    }\r\n\r\n    if(subtitleFragment.firstChild) {\r\n      subtitleFragment.append('\\n');\r\n    }\r\n\r\n    subtitleFragment.append(a);\r\n\r\n    if(this.showSender) {\r\n      subtitleFragment.append('\\n', await wrapSenderToPeer(message));\r\n    }\r\n    \r\n    if(!title.textContent) {\r\n      //title = new URL(webpage.url).hostname;\r\n      title.append(wrapPlainText(webpage.display_url.split('/', 1)[0]));\r\n    }\r\n\r\n    const row = new Row({\r\n      title,\r\n      titleRight: wrapSentTime(message),\r\n      subtitle: subtitleFragment,\r\n      havePadding: true,\r\n      clickable: true,\r\n      noRipple: true\r\n    });\r\n\r\n    /* const mediaDiv = document.createElement('div');\r\n    mediaDiv.classList.add('row-media'); */\r\n\r\n    row.container.append(previewDiv);\r\n    \r\n    /* ripple(div);\r\n    div.append(previewDiv);\r\n    div.insertAdjacentHTML('beforeend', `\r\n    <div class=\"title\">${title}${titleAdditionHTML}</div>\r\n    <div class=\"subtitle\">${subtitle}</div>\r\n    <div class=\"url\">${url}</div>\r\n    ${sender}\r\n    `); */\r\n    \r\n    if(row.container.innerText.trim().length) {\r\n      return {message, element: row.container};\r\n    }\r\n  }\r\n  \r\n  public async performSearchResult(messages: any[], mediaTab: SearchSuperMediaTab, append = true) {\r\n    const elemsToAppend: {element: HTMLElement, message: any}[] = [];\r\n    const sharedMediaDiv: HTMLElement = mediaTab.contentTab;\r\n    const promises: Promise<any>[] = [];\r\n    const middleware = this.middleware.get();\r\n    let inputFilter = mediaTab.inputFilter;\r\n\r\n    await getHeavyAnimationPromise();\r\n    \r\n    let searchGroup: SearchGroup;\r\n    if(inputFilter === 'inputMessagesFilterPhotoVideo' && !!this.searchContext.query.trim()) {\r\n      inputFilter = 'inputMessagesFilterEmpty';\r\n      searchGroup = this.searchGroupMedia;\r\n      sharedMediaDiv.append(searchGroup.container);\r\n    } else if(inputFilter === 'inputMessagesFilterEmpty') {\r\n      searchGroup = this.searchGroups.messages;\r\n    }\r\n\r\n    const options: ProcessSearchSuperResult = {\r\n      elemsToAppend,\r\n      inputFilter,\r\n      message: undefined,\r\n      middleware,\r\n      promises,\r\n      searchGroup\r\n    };\r\n\r\n    let processCallback: (options: ProcessSearchSuperResult) => any;\r\n\r\n    // https://core.telegram.org/type/MessagesFilter\r\n    switch(inputFilter) {\r\n      case 'inputMessagesFilterEmpty': {\r\n        processCallback = this.processEmptyFilter;\r\n        break;\r\n      }\r\n\r\n      case 'inputMessagesFilterPhotoVideo': {\r\n        processCallback = this.processPhotoVideoFilter;\r\n        break;\r\n      }\r\n      \r\n      case 'inputMessagesFilterVoice':\r\n      case 'inputMessagesFilterRoundVoice':\r\n      case 'inputMessagesFilterMusic':\r\n      case 'inputMessagesFilterDocument': {\r\n        processCallback = this.processDocumentFilter;\r\n        break;\r\n      }\r\n      \r\n      case 'inputMessagesFilterUrl': {\r\n        processCallback = this.processUrlFilter;\r\n        break;\r\n      }\r\n\r\n      default:\r\n        //this.log.warn('death is my friend', messages);\r\n        break;\r\n    }\r\n\r\n    if(processCallback) {\r\n      processCallback = processCallback.bind(this);\r\n\r\n      type K = {element: HTMLElement, message: Message.message | Message.messageService};\r\n      const results: (Promise<K> | K)[] = messages.map(async(message) => {\r\n        try {\r\n          options.message = message;\r\n          return await processCallback(options);\r\n        } catch(err) {\r\n          this.log.error('error rendering filter', inputFilter, options, message, err);\r\n        }\r\n      });\r\n\r\n      const awaited = (await Promise.all(results)).filter(Boolean);\r\n      elemsToAppend.push(...awaited.filter(Boolean));\r\n    }\r\n    \r\n    if(searchGroup && searchGroup.list.childElementCount) {\r\n      searchGroup.setActive();\r\n    }\r\n\r\n    if(this.loadMutex) {\r\n      promises.push(this.loadMutex);\r\n    }\r\n\r\n    if(promises.length) {\r\n      await Promise.all(promises);\r\n      if(!middleware()) {\r\n        //this.log.warn('peer changed');\r\n        return;\r\n      }\r\n    }\r\n    \r\n    if(elemsToAppend.length) {\r\n      const method = append ? 'append' : 'prepend';\r\n      elemsToAppend.forEach((details) => {\r\n        const {element, message} = details;\r\n        const monthContainer = this.getMonthContainerByTimestamp(this.groupByMonth ? message.date : 0, inputFilter);\r\n        element.classList.add('search-super-item');\r\n        element.dataset.mid = '' + message.mid;\r\n        element.dataset.peerId = '' + message.peerId;\r\n        monthContainer.items[method](element);\r\n\r\n        if(this.selection?.isSelecting) {\r\n          this.selection.toggleElementCheckbox(element, true);\r\n        }\r\n      });\r\n    }\r\n    \r\n    //if(type !== 'inputMessagesFilterEmpty') {\r\n      this.afterPerforming(inputFilter === 'inputMessagesFilterEmpty' ? 1 : messages.length, sharedMediaDiv);\r\n    //}\r\n  }\r\n\r\n  private afterPerforming(length: number, contentTab: HTMLElement) {\r\n    if(contentTab) {\r\n      const parent = contentTab.parentElement;\r\n      Array.from(parent.children).slice(1).forEach((child) => {\r\n        child.remove();\r\n      });\r\n\r\n      //this.contentContainer.classList.add('loaded');\r\n\r\n      if(!length && !contentTab.childElementCount) {\r\n        const div = document.createElement('div');\r\n        div.innerText = 'Nothing interesting here yet...';\r\n        div.classList.add('position-center', 'text-center', 'content-empty', 'no-select');\r\n\r\n        parent.append(div);\r\n      }\r\n    }\r\n  }\r\n\r\n  private loadChats() {\r\n    const renderedPeerIds: Set<PeerId> = new Set();\r\n    const middleware = this.middleware.get();\r\n\r\n    for(let i in this.searchGroups) {\r\n      const group = this.searchGroups[i as SearchGroupType];\r\n      this.tabs.inputMessagesFilterEmpty.append(group.container);\r\n      group.clear();\r\n    }\r\n\r\n    const query = this.searchContext.query;\r\n    if(query) {\r\n      const setResults = (results: PeerId[], group: SearchGroup, showMembersCount = false) => {\r\n        results.map((peerId) => {\r\n          if(renderedPeerIds.has(peerId)) {\r\n            return;\r\n          }\r\n  \r\n          renderedPeerIds.add(peerId);\r\n  \r\n          const {dom} = appDialogsManager.addDialogNew({\r\n            peerId: peerId, \r\n            container: group.list, \r\n            avatarSize: 48,\r\n            autonomous: group.autonomous\r\n          });\r\n\r\n          return {dom, peerId};\r\n        }).forEach(async({dom, peerId}) => {\r\n          const peer = await this.managers.appPeersManager.getPeer(peerId);\r\n          if(showMembersCount && (peer.participants_count || peer.participants)) {\r\n            const regExp = new RegExp(`(${escapeRegExp(query)}|${escapeRegExp(cleanSearchText(query))})`, 'gi');\r\n            dom.titleSpan.innerHTML = dom.titleSpan.innerHTML.replace(regExp, '<i>$1</i>');\r\n            dom.lastMessageSpan.append(await getChatMembersString(peerId.toChatId()));\r\n          } else if(peerId === rootScope.myId) {\r\n            dom.lastMessageSpan.append(i18n('Presence.YourChat'));\r\n          } else {\r\n            let username = await this.managers.appPeersManager.getPeerUsername(peerId);\r\n            if(!username) {\r\n              const user = await this.managers.appUsersManager.getUser(peerId);\r\n              if(user && user.phone) {\r\n                username = '+' + formatPhoneNumber(user.phone).formatted;\r\n              }\r\n            } else {\r\n              username = '@' + username;\r\n            }\r\n  \r\n            dom.lastMessageSpan.innerHTML = '<i>' + username + '</i>';\r\n          }\r\n        });\r\n  \r\n        group.toggle();\r\n      };\r\n  \r\n      const onLoad = <T>(arg: T) => {\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n  \r\n        //this.loadedContacts = true;\r\n  \r\n        return arg;\r\n      };\r\n  \r\n      return Promise.all([\r\n        this.managers.appUsersManager.getContactsPeerIds(query, true)\r\n        .then(onLoad)\r\n        .then((contacts) => {\r\n          if(contacts) {\r\n            setResults(contacts, this.searchGroups.contacts, true);\r\n          }\r\n        }),\r\n  \r\n        this.managers.appUsersManager.searchContacts(query, 20)\r\n        .then(onLoad)\r\n        .then((contacts) => {\r\n          if(contacts) {\r\n            setResults(contacts.my_results, this.searchGroups.contacts, true);\r\n            setResults(contacts.results/* .concat(contacts.results, contacts.results, contacts.results) */, this.searchGroups.globalContacts);\r\n\r\n            this.searchGroups.globalContacts.container.classList.add('is-short');\r\n\r\n            if(this.searchGroups.globalContacts.nameEl.lastElementChild !== this.searchGroups.globalContacts.nameEl.firstElementChild) {\r\n              this.searchGroups.globalContacts.nameEl.lastElementChild.remove();\r\n            }\r\n            \r\n            if(this.searchGroups.globalContacts.list.childElementCount > 3) {\r\n              const showMore = document.createElement('div');\r\n              showMore.classList.add('search-group__show-more');\r\n              const intlElement = new I18n.IntlElement({\r\n                key: 'Separator.ShowMore'\r\n              });\r\n              showMore.append(intlElement.element);\r\n              this.searchGroups.globalContacts.nameEl.append(showMore);\r\n              attachClickEvent(showMore, () => {\r\n                const isShort = this.searchGroups.globalContacts.container.classList.toggle('is-short');\r\n                intlElement.key = isShort ? 'Separator.ShowMore' : 'Separator.ShowLess';\r\n                intlElement.update();\r\n              });\r\n            }\r\n          }\r\n        }),\r\n  \r\n        this.managers.appMessagesManager.getConversations(query, 0, 20, 0)\r\n        .then(onLoad)\r\n        .then((value) => {\r\n          if(value) {\r\n            setResults(value.dialogs.map((d) => d.peerId), this.searchGroups.contacts, true);\r\n          }\r\n        })\r\n      ]);\r\n    } else if(!this.searchContext.peerId && !this.searchContext.minDate) {\r\n      const renderRecentSearch = (setActive = true) => {\r\n        return apiManagerProxy.getState().then((state) => {\r\n          if(!middleware()) {\r\n            return;\r\n          }\r\n    \r\n          this.searchGroups.recent.list.innerHTML = '';\r\n    \r\n          state.recentSearch.slice(0, 20).forEach(async(peerId) => {\r\n            let {dom} = appDialogsManager.addDialogNew({\r\n              peerId: peerId,\r\n              container: this.searchGroups.recent.list,\r\n              meAsSaved: true,\r\n              avatarSize: 48,\r\n              autonomous: true\r\n            });\r\n    \r\n            dom.lastMessageSpan.append(await (peerId.isUser() ? \r\n              getUserStatusString(await this.managers.appUsersManager.getUser(peerId.toUserId())) : \r\n              getChatMembersString(peerId.toChatId())));\r\n          });\r\n    \r\n          if(!state.recentSearch.length) {\r\n            this.searchGroups.recent.clear();\r\n          } else if(setActive) {\r\n            this.searchGroups.recent.setActive();\r\n          }\r\n        });\r\n      };\r\n\r\n      return Promise.all([\r\n        this.managers.appUsersManager.getTopPeers('correspondents').then((peers) => {\r\n          if(!middleware()) return;\r\n\r\n          const idx = peers.findIndex((peer) => peer.id === rootScope.myId);\r\n          if(idx !== -1) {\r\n            peers = peers.slice();\r\n            peers.splice(idx, 1);\r\n          }\r\n          //console.log('got top categories:', categories);\r\n          if(peers.length) {\r\n            peers.forEach((peer) => {\r\n              appDialogsManager.addDialogNew({\r\n                peerId: peer.id, \r\n                container: this.searchGroups.people.list, \r\n                onlyFirstName: true,\r\n                avatarSize: 54,\r\n                autonomous: false\r\n              });\r\n            });\r\n          }\r\n    \r\n          this.searchGroups.people.setActive();\r\n        }),\r\n\r\n        renderRecentSearch()\r\n      ]);\r\n    } else return Promise.resolve();\r\n  }\r\n\r\n  private async loadMembers(mediaTab: SearchSuperMediaTab) {\r\n    const id = this.searchContext.peerId.toChatId();\r\n    const middleware = this.middleware.get();\r\n    let promise: Promise<void>;\r\n\r\n    const renderParticipants = async(participants: (ChatParticipant | ChannelParticipant)[]) => {\r\n      if(this.loadMutex) {\r\n        await this.loadMutex;\r\n\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n      }\r\n      \r\n      if(!this.membersList) {\r\n        this.membersList = new SortedUserList({\r\n          lazyLoadQueue: this.lazyLoadQueue, \r\n          rippleEnabled: false,\r\n          managers: this.managers\r\n        });\r\n        attachClickEvent(this.membersList.list, (e) => {\r\n          const li = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG);\r\n          if(!li) {\r\n            return;\r\n          }\r\n\r\n          const peerId = li.dataset.peerId.toPeerId();\r\n          let promise: Promise<any> = Promise.resolve();\r\n          if(mediaSizes.isMobile) {\r\n            promise = appSidebarRight.toggleSidebar(false);\r\n          }\r\n          \r\n          promise.then(() => {\r\n            appImManager.setInnerPeer({peerId});\r\n          });\r\n        });\r\n        mediaTab.contentTab.append(this.membersList.list);\r\n        this.afterPerforming(1, mediaTab.contentTab);\r\n      }\r\n\r\n      for(const participant of participants) {\r\n        const peerId = getParticipantPeerId(participant);\r\n        if(peerId.isAnyChat()) {\r\n          continue;\r\n        }\r\n\r\n        const user = await this.managers.appUsersManager.getUser(peerId);\r\n        if(user.pFlags.deleted) {\r\n          continue;\r\n        }\r\n\r\n        this.membersList.add(peerId);\r\n      }\r\n    };\r\n\r\n    if(await this.managers.appChatsManager.isChannel(id)) {\r\n      const LOAD_COUNT = !this.membersList ? 50 : 200;\r\n      promise = this.managers.appProfileManager.getChannelParticipants(id, undefined, LOAD_COUNT, this.nextRates[mediaTab.inputFilter]).then((participants) => {\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n\r\n        let list = mediaTab.contentTab.firstElementChild as HTMLUListElement;\r\n        this.nextRates[mediaTab.inputFilter] = (list ? list.childElementCount : 0) + participants.participants.length;\r\n\r\n        if(participants.participants.length < LOAD_COUNT) {\r\n          this.loaded[mediaTab.inputFilter] = true;\r\n        }\r\n\r\n        return renderParticipants(participants.participants);\r\n      });\r\n    } else {\r\n      promise = this.managers.appProfileManager.getChatFull(id).then((chatFull) => {\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n\r\n        //console.log('anymore', chatFull);\r\n        this.loaded[mediaTab.inputFilter] = true;\r\n        const participants = (chatFull as ChatFull.chatFull).participants;\r\n        if(participants._ === 'chatParticipantsForbidden') {\r\n          return;\r\n        }\r\n        \r\n        return renderParticipants(participants.participants);\r\n      });\r\n    }\r\n\r\n    return this.loadPromises[mediaTab.inputFilter] = promise.finally(() => { \r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      this.loadPromises[mediaTab.inputFilter] = null;\r\n    });\r\n  }\r\n\r\n  private loadType(mediaTab: SearchSuperMediaTab, justLoad: boolean, loadCount: number, middleware: () => boolean) {\r\n    const type = mediaTab.inputFilter;\r\n\r\n    if(this.loadPromises[type]) {\r\n      return this.loadPromises[type];\r\n    }\r\n\r\n    if(mediaTab.type === 'members') {\r\n      return this.loadMembers(mediaTab);\r\n    }\r\n\r\n    const history = this.historyStorage[type] ?? (this.historyStorage[type] = []);\r\n\r\n    if(type === 'inputMessagesFilterEmpty' && !history.length) {\r\n      if(!this.loadedChats) {\r\n        this.loadChats();\r\n        this.loadedChats = true;\r\n      }\r\n\r\n      if(!this.searchContext.query.trim() && !this.searchContext.peerId && !this.searchContext.minDate) {\r\n        this.loaded[type] = true;\r\n        return Promise.resolve();\r\n      }\r\n    }\r\n\r\n    const promise = this.loadPromises[type] = Promise.resolve().then(async() => {\r\n      // render from cache\r\n      if(history.length && this.usedFromHistory[type] < history.length && !justLoad) {\r\n        let messages: any[] = [];\r\n        let used = Math.max(0, this.usedFromHistory[type]);\r\n        let slicedLength = 0;\r\n\r\n        do {\r\n          let ids = history.slice(used, used + loadCount);\r\n          used += ids.length;\r\n          slicedLength += ids.length;\r\n\r\n          const notFilteredMessages = await Promise.all(ids.map((m) => this.managers.appMessagesManager.getMessageByPeer(m.peerId, m.mid)));\r\n\r\n          messages.push(...this.filterMessagesByType(notFilteredMessages, type));\r\n        } while(slicedLength < loadCount && used < history.length);\r\n        \r\n        //  \r\n        /* if(slicedLength > loadCount) {\r\n          let diff = messages.length - loadCount;\r\n          messages = messages.slice(0, messages.length - diff);\r\n          used -= diff;\r\n        } */\r\n\r\n        this.usedFromHistory[type] = used;\r\n        //if(messages.length) {\r\n          return this.performSearchResult(messages, mediaTab).finally(() => {\r\n            setTimeout(() => {\r\n              this.scrollable.checkForTriggers();\r\n            }, 0);\r\n          });\r\n        //}\r\n      }\r\n      \r\n      let maxId = history.length ? history[history.length - 1].mid : 0;\r\n\r\n      const value = await this.managers.appMessagesManager.getSearch({\r\n        ...this.searchContext,\r\n        inputFilter: {_: type},\r\n        maxId, \r\n        limit: loadCount,\r\n        nextRate: this.nextRates[type] ??= 0\r\n      });\r\n\r\n      history.push(...value.history.map((m) => ({mid: m.mid, peerId: m.peerId})));\r\n\r\n      if(!middleware()) {\r\n        //this.log.warn('peer changed');\r\n        return;\r\n      }\r\n\r\n      // !  ,         ( - ,        getSearch)\r\n      if(value.history.length < loadCount || (this.searchContext.folderId !== undefined && !value.next_rate) || value.history.length === value.count) {\r\n      //if((value.count || history.length === value.count) && history.length >= value.count) {\r\n        //this.log(logStr + 'loaded all media', value, loadCount);\r\n        this.loaded[type] = true;\r\n      }\r\n\r\n      this.nextRates[type] = value.next_rate;\r\n\r\n      if(justLoad) {\r\n        return;\r\n      }\r\n\r\n      this.usedFromHistory[type] = history.length;\r\n\r\n      if(!this.loaded[type]) {\r\n        promise.then(() => {\r\n          setTimeout(() => {\r\n            if(!middleware()) return;\r\n            //this.log('will preload more');\r\n            if(this.mediaTab === mediaTab) {\r\n              const promise = this.load(true, true);\r\n              if(promise) {\r\n                promise.then(() => {\r\n                  if(!middleware()) return;\r\n                  //this.log('preloaded more');\r\n                  setTimeout(() => {\r\n                    this.scrollable.checkForTriggers();\r\n                  }, 0);\r\n                });\r\n              }\r\n            }\r\n          }, 0);\r\n        });\r\n      }\r\n\r\n      //if(value.history.length) {\r\n        return this.performSearchResult(this.filterMessagesByType(value.history, type), mediaTab);\r\n      //}\r\n    }).catch((err) => {\r\n      this.log.error('load error:', err);\r\n    }).finally(() => {\r\n      this.loadPromises[type] = null;\r\n    });\r\n\r\n    return promise;\r\n  }\r\n\r\n  private canLoadMediaTab(mediaTab: SearchSuperMediaTab) {\r\n    const inputFilter = mediaTab.inputFilter;\r\n    return !this.loaded[inputFilter] || (this.historyStorage[inputFilter] && this.usedFromHistory[inputFilter] < this.historyStorage[inputFilter].length);\r\n  }\r\n\r\n  private async loadFirstTime() {\r\n    const middleware = this.middleware.get();\r\n    const peerId = this.searchContext.peerId;\r\n    if(!this.hideEmptyTabs) {\r\n      return;\r\n    }\r\n\r\n    const mediaTabs = this.mediaTabs.filter((mediaTab) => mediaTab.inputFilter !== 'inputMessagesFilterEmpty');\r\n    const filters = mediaTabs.map((mediaTab) => ({_: mediaTab.inputFilter}));\r\n\r\n    const [counters, canViewMembers] = await Promise.all([\r\n      this.managers.appMessagesManager.getSearchCounters(peerId, filters),\r\n      this.canViewMembers()\r\n    ]);\r\n\r\n    if(!middleware()) {\r\n      return;\r\n    }\r\n\r\n    if(this.loadMutex) {\r\n      await this.loadMutex;\r\n\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    let firstMediaTab: SearchSuperMediaTab;\r\n    let count = 0;\r\n    mediaTabs.forEach((mediaTab) => {\r\n      const counter = counters.find((c) => c.filter._ === mediaTab.inputFilter);\r\n\r\n      mediaTab.menuTab.classList.toggle('hide', !counter.count);\r\n      mediaTab.menuTab.classList.remove('active');\r\n      //mediaTab.contentTab.classList.toggle('hide', !counter.count);\r\n\r\n      if(counter.count) {\r\n        if(firstMediaTab === undefined) {\r\n          firstMediaTab = mediaTab;\r\n        }\r\n\r\n        ++count;\r\n      }\r\n    });\r\n\r\n    const membersTab = this.mediaTabsMap.get('members');\r\n    membersTab.menuTab.classList.toggle('hide', !canViewMembers);\r\n\r\n    if(canViewMembers) {\r\n      firstMediaTab = membersTab;\r\n    }\r\n\r\n    this.container.classList.toggle('hide', !firstMediaTab);\r\n    this.container.parentElement.classList.toggle('search-empty', !firstMediaTab);\r\n    if(firstMediaTab) {\r\n      this.skipScroll = true;\r\n      this.selectTab(this.mediaTabs.indexOf(firstMediaTab), false);\r\n      // firstMediaTab.menuTab.classList.add('active');\r\n\r\n      this.navScrollableContainer.classList.toggle('hide', count <= 1);\r\n    }\r\n  }\r\n  \r\n  public async load(single = false, justLoad = false) {\r\n    const peerId = this.searchContext.peerId;\r\n    this.log('load', single, peerId, this.loadPromises);\r\n    const middleware = this.middleware.get();\r\n\r\n    if(this.firstLoad) {\r\n      await (this.loadFirstTimePromise ??= this.loadFirstTime());\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      this.loadFirstTimePromise = undefined;\r\n      this.firstLoad = false;\r\n    }\r\n    \r\n    let toLoad = single ? [this.mediaTab] : this.mediaTabs.filter((t) => t !== this.mediaTab);\r\n    toLoad = toLoad.filter((mediaTab) => {\r\n      return this.canLoadMediaTab(mediaTab);\r\n    });\r\n\r\n    if(peerId.isUser()) {\r\n      findAndSplice(toLoad, (mediaTab) => mediaTab.type === 'members');\r\n    }\r\n\r\n    if(!toLoad.length) {\r\n      return;\r\n    }\r\n\r\n    const loadCount = justLoad ? 50 : Math.round((windowSize.height / 130 | 0) * 3 * 1.25); // that's good for all types\r\n\r\n    const promises: Promise<any>[] = toLoad.map((mediaTab) => {\r\n      return this.loadType(mediaTab, justLoad, loadCount, middleware);\r\n    });\r\n\r\n    return Promise.all(promises).catch((err) => {\r\n      this.log.error('Load error all promises:', err);\r\n    });\r\n  }\r\n  \r\n  public getMonthContainerByTimestamp(timestamp: number, type: SearchSuperType) {\r\n    const date = new Date(timestamp * 1000);\r\n    date.setHours(0, 0, 0);\r\n    date.setDate(1);\r\n    const dateTimestamp = date.getTime();\r\n    const containers = this.monthContainers[type] ?? (this.monthContainers[type] = {});\r\n    if(!(dateTimestamp in containers)) {\r\n      const container = document.createElement('div');\r\n      container.className = 'search-super-month';\r\n\r\n      const name = document.createElement('div');\r\n      name.classList.add('search-super-month-name');\r\n\r\n      const options: Intl.DateTimeFormatOptions = {\r\n        month: 'long'\r\n      };\r\n\r\n      if(date.getFullYear() !== new Date().getFullYear()) {\r\n        options.year = 'numeric';\r\n      }\r\n\r\n      const dateElement = new I18n.IntlDateElement({\r\n        date,\r\n        options\r\n      }).element;\r\n      name.append(dateElement);\r\n\r\n      container.append(name);\r\n\r\n      const items = document.createElement('div');\r\n      items.classList.add('search-super-month-items');\r\n\r\n      container.append(name, items);\r\n\r\n      const haveTimestamps = getObjectKeysAndSort(containers, 'desc');\r\n      let i = 0;\r\n      for(; i < haveTimestamps.length; ++i) {\r\n        const t = haveTimestamps[i];\r\n        if(dateTimestamp > t) {\r\n          break;\r\n        }\r\n      }\r\n      \r\n      containers[dateTimestamp] = {container, items};\r\n      positionElementByIndex(container, this.tabs[type], i);\r\n    }\r\n\r\n    return containers[dateTimestamp];\r\n  }\r\n\r\n  public canViewMembers() {\r\n    return Promise.all([\r\n      this.searchContext.peerId.isAnyChat(),\r\n      this.managers.appChatsManager.isBroadcast(this.searchContext.peerId.toChatId()),\r\n      this.managers.appChatsManager.hasRights(this.searchContext.peerId.toChatId(), 'view_participants')\r\n    ]).then(([isAnyChat, isBroadcast, hasRights]) => {\r\n      return isAnyChat && !isBroadcast && hasRights;\r\n    });\r\n  }\r\n\r\n  public cleanup() {\r\n    this.loadPromises = {};\r\n    this.loaded = {};\r\n    this.loadedChats = false;\r\n    this.nextRates = {};\r\n    this.firstLoad = true;\r\n    this.prevTabId = -1;\r\n\r\n    this.lazyLoadQueue.clear();\r\n\r\n    this.mediaTabs.forEach((mediaTab) => {\r\n      this.usedFromHistory[mediaTab.inputFilter] = -1;\r\n    });\r\n\r\n    if(this.selection?.isSelecting) {\r\n      this.selection.cancelSelection();\r\n    }\r\n\r\n    // * must go to first tab ( )\r\n    /* const membersTab = this.mediaTabsMap.get('members');\r\n    if(membersTab) {\r\n      const tab = this.canViewMembers() ? membersTab : this.mediaTabs[this.mediaTabs.indexOf(membersTab) + 1];\r\n      this.mediaTab = tab;\r\n    } */\r\n\r\n    this.middleware.clean();\r\n    this.loadFirstTimePromise = undefined;\r\n    this.cleanScrollPositions();\r\n    this.membersList = undefined;\r\n  }\r\n\r\n  public cleanScrollPositions() {\r\n    this.mediaTabs.forEach((mediaTab) => {\r\n      mediaTab.scroll = undefined;\r\n    });\r\n  }\r\n\r\n  public cleanupHTML(goFirst = false) {\r\n    if(this.urlsToRevoke.length) {\r\n      this.urlsToRevoke.forEach((url) => {\r\n        URL.revokeObjectURL(url);\r\n      });\r\n      this.urlsToRevoke.length = 0;\r\n    }\r\n\r\n    this.mediaTabs.forEach((tab) => {\r\n      tab.contentTab.innerHTML = '';\r\n\r\n      if(this.hideEmptyTabs) {\r\n        //tab.menuTab.classList.add('hide');\r\n        this.container.classList.add('hide');\r\n        this.container.parentElement.classList.add('search-empty');\r\n      }\r\n\r\n      if(tab.type === 'chats') {\r\n        return;\r\n      }\r\n      \r\n      if(!this.historyStorage[tab.inputFilter]) {\r\n        const parent = tab.contentTab.parentElement;\r\n        //if(!testScroll) {\r\n          if(!parent.querySelector('.preloader')) {\r\n            putPreloader(parent, true);\r\n          }\r\n        //}\r\n\r\n        const empty = parent.querySelector('.content-empty');\r\n        if(empty) {\r\n          empty.remove();\r\n        }\r\n      }\r\n    });\r\n\r\n    /* if(goFirst) {\r\n      const membersTab = this.mediaTabsMap.get('members');\r\n      if(membersTab) {\r\n        let idx = this.canViewMembers() ? 0 : 1;\r\n        membersTab.menuTab.classList.toggle('hide', idx !== 0);\r\n\r\n        this.selectTab(idx, false);\r\n      } else {\r\n        this.selectTab(0, false);\r\n      }\r\n    } */\r\n\r\n    this.monthContainers = {};\r\n    this.searchGroupMedia.clear();\r\n    this.scrollable.scrollTop = 0;\r\n\r\n    /* if(testScroll) {\r\n      for(let i = 0; i < 1500; ++i) {\r\n        let div = document.createElement('div');\r\n        div.insertAdjacentHTML('beforeend', `<img class=\"media-image\" src=\"assets/img/camomile.jpg\">`);\r\n        div.classList.add('grid-item');\r\n        div.dataset.id = '' + (i / 3 | 0);\r\n        //div.innerText = '' + (i / 3 | 0);\r\n        this.tabs.inputMessagesFilterPhotoVideo.append(div);\r\n      }\r\n    } */\r\n  }\r\n\r\n  private copySearchContext(newInputFilter: MyInputMessagesFilter) {\r\n    const context = copy(this.searchContext);\r\n    context.inputFilter = {_: newInputFilter};\r\n    context.nextRate = this.nextRates[newInputFilter];\r\n    return context;\r\n  }\r\n\r\n  public setQuery({peerId, query, threadId, historyStorage, folderId, minDate, maxDate}: {\r\n    peerId: PeerId, \r\n    query?: string, \r\n    threadId?: number, \r\n    historyStorage?: AppSearchSuper['historyStorage'], \r\n    folderId?: number,\r\n    minDate?: number,\r\n    maxDate?: number\r\n  }) {\r\n    this.searchContext = {\r\n      peerId,\r\n      query: query || '',\r\n      inputFilter: {_: this.mediaTab.inputFilter},\r\n      threadId,\r\n      folderId,\r\n      minDate,\r\n      maxDate\r\n    };\r\n    \r\n    this.historyStorage = historyStorage ?? {};\r\n\r\n    this.cleanup();\r\n  }\r\n\r\n  public destroy() {\r\n    this.listenerSetter.removeAll();\r\n    this.scrollable.destroy();\r\n    this.swipeHandler?.removeListeners();\r\n    this.selection?.cleanup();\r\n    \r\n    this.scrollStartCallback = undefined;\r\n    this.onChangeTab = undefined;\r\n    this.selectTab = undefined;\r\n    this.searchContextMenu = undefined;\r\n    this.swipeHandler = undefined;\r\n    this.selection = undefined;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport cancelEvent from \"./cancelEvent\";\r\n\r\nexport default function lockTouchScroll(container: HTMLElement) {\r\n  const onTouchMove = (e: TouchEvent) => {\r\n    cancelEvent(e);\r\n  };\r\n\r\n  let lockers = 2;\r\n  const cb = () => {\r\n    if(!--lockers) {\r\n      container.removeEventListener('touchmove', onTouchMove, {capture: true});\r\n    }\r\n  };\r\n\r\n  container.addEventListener('touchmove', onTouchMove, {capture: true, passive: false});\r\n  container.addEventListener('touchend', cb, {once: true});\r\n\r\n  return cb;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport contextMenuController from \"../helpers/contextMenuController\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { AttachClickOptions, CLICK_EVENT_NAME } from \"../helpers/dom/clickEvent\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport ButtonIcon from \"./buttonIcon\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"./buttonMenu\";\r\n\r\nconst ButtonMenuToggle = (\r\n  options: Partial<{\r\n    noRipple: true, \r\n    onlyMobile: true, \r\n    listenerSetter: ListenerSetter, \r\n    asDiv: boolean,\r\n    container: HTMLElement\r\n  }> = {}, \r\n  direction: 'bottom-left' | 'bottom-right' | 'top-left' | 'top-right', \r\n  buttons: ButtonMenuItemOptions[], \r\n  onOpen?: (e: Event) => void,\r\n  onClose?: () => void\r\n) => {\r\n  options.asDiv = true;\r\n  const button = options.container ?? ButtonIcon('more', options);\r\n  button.classList.add('btn-menu-toggle');\r\n\r\n  const btnMenu = ButtonMenu(buttons, options.listenerSetter);\r\n  btnMenu.classList.add(direction);\r\n  ButtonMenuToggleHandler(button, onOpen, options, onClose);\r\n  button.append(btnMenu);\r\n  return button;\r\n};\r\n\r\n// TODO: refactor for attachClickEvent, because if move finger after touchstart, it will start anyway\r\nconst ButtonMenuToggleHandler = (el: HTMLElement, onOpen?: (e: Event) => void | Promise<any>, options?: AttachClickOptions, onClose?: () => void) => {\r\n  const add = options?.listenerSetter ? options.listenerSetter.add(el) : el.addEventListener.bind(el);\r\n\r\n  //console.trace('ButtonMenuToggleHandler attach', el, onOpen, options);\r\n  add(CLICK_EVENT_NAME, (e: Event) => {\r\n    //console.log('ButtonMenuToggleHandler click', e);\r\n    if(!el.classList.contains('btn-menu-toggle')) return false;\r\n\r\n    //window.removeEventListener('mousemove', onMouseMove);\r\n    const openedMenu = el.querySelector('.btn-menu') as HTMLDivElement;\r\n    cancelEvent(e);\r\n\r\n    if(el.classList.contains('menu-open')) {\r\n      contextMenuController.closeBtnMenu();\r\n    } else {\r\n      const result = onOpen && onOpen(e);\r\n      const open = () => {\r\n        contextMenuController.openBtnMenu(openedMenu, onClose);\r\n      };\r\n\r\n      if(result instanceof Promise) {\r\n        result.then(open);\r\n      } else {\r\n        open();\r\n      }\r\n    }\r\n  });\r\n};\r\n\r\nexport { ButtonMenuToggleHandler };\r\nexport default ButtonMenuToggle;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { PrivacyRule } from \"../../../../layer\";\r\nimport PrivacyType from \"./privacyType\";\r\n\r\nexport default function getPrivacyRulesDetails(rules: PrivacyRule[]) {\r\n  const types: PrivacyType[] = [];\r\n\r\n  type peers = {users: UserId[], chats: ChatId[]};\r\n  let allowPeers: peers = {users: [], chats: []}, disallowPeers: peers = {users: [], chats: []};\r\n  rules.forEach((rule) => {\r\n    switch(rule._) {\r\n      case 'privacyValueAllowAll':\r\n        types.push(2);\r\n        break;\r\n      case 'privacyValueDisallowAll':\r\n        types.push(0);\r\n        break;\r\n      case 'privacyValueAllowContacts': \r\n        types.push(1);\r\n        break;\r\n      /* case 'privacyValueDisallowContacts':\r\n        types.push('Except My Contacts');\r\n        break; */\r\n      case 'privacyValueAllowChatParticipants':\r\n        allowPeers.chats.push(...rule.chats);\r\n        break;\r\n      case 'privacyValueAllowUsers':\r\n        allowPeers.users.push(...rule.users);\r\n        break;\r\n      case 'privacyValueDisallowChatParticipants':\r\n        disallowPeers.chats.push(...rule.chats);\r\n        break;\r\n      case 'privacyValueDisallowUsers':\r\n        disallowPeers.users.push(...rule.users);\r\n        break;\r\n    }\r\n  });\r\n\r\n  return {type: types[0], disallowPeers, allowPeers};\r\n}\r\n","enum PrivacyType {\r\n  Everybody = 2,\r\n  Contacts = 1,\r\n  Nobody = 0\r\n}\r\n\r\nexport default PrivacyType;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport { randomLong } from \"../helpers/random\";\r\nimport { InputPrivacyKey, InputPrivacyRule } from \"../layer\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport getPrivacyRulesDetails from \"../lib/appManagers/utils/privacy/getPrivacyRulesDetails\";\r\nimport PrivacyType from \"../lib/appManagers/utils/privacy/privacyType\";\r\nimport { i18n, join, LangPackKey, _i18n } from \"../lib/langPack\";\r\nimport RadioField from \"./radioField\";\r\nimport Row, { RadioFormFromRows } from \"./row\";\r\nimport Scrollable from \"./scrollable\";\r\nimport { SettingSection, generateSection } from \"./sidebarLeft\";\r\nimport AppAddMembersTab from \"./sidebarLeft/tabs/addMembers\";\r\nimport { SliderSuperTabEventable } from \"./sliderTab\";\r\n\r\nexport type PrivacySectionStr = LangPackKey | '' | HTMLElement;\r\nexport default class PrivacySection {\r\n  public radioRows: Map<PrivacyType, Row>;\r\n  public radioSection: SettingSection;\r\n  public exceptions: Map<keyof PrivacySection['peerIds'], {\r\n    titleLangKey: LangPackKey,\r\n    key: keyof PrivacySection['peerIds'],\r\n    row: Row,\r\n    icon: string,\r\n    subtitleLangKey: LangPackKey,\r\n    clickable: true\r\n  }>;\r\n  public peerIds: {\r\n    disallow?: PeerId[],\r\n    allow?: PeerId[]\r\n  };\r\n  public type: PrivacyType;\r\n\r\n  constructor(public options: {\r\n    tab: SliderSuperTabEventable,\r\n    title: LangPackKey, \r\n    inputKey: InputPrivacyKey['_'], \r\n    captions?: [PrivacySectionStr, PrivacySectionStr, PrivacySectionStr],\r\n    appendTo?: Scrollable,\r\n    noExceptions?: boolean,\r\n    onRadioChange?: (value: number) => any,\r\n    skipTypes?: PrivacyType[],\r\n    exceptionTexts?: [LangPackKey, LangPackKey],\r\n    managers: AppManagers\r\n  }) {\r\n    if(options.captions) {\r\n      options.captions.reverse();\r\n    }\r\n\r\n    const managers = options.managers;\r\n\r\n    this.radioSection = new SettingSection({name: options.title, caption: true});\r\n\r\n    this.radioRows = new Map();\r\n\r\n    let r: Array<{type: PrivacyType, langKey: LangPackKey}> = [{\r\n      type: PrivacyType.Everybody,\r\n      langKey: 'PrivacySettingsController.Everbody'\r\n    }, {\r\n      type: PrivacyType.Contacts,\r\n      langKey: 'PrivacySettingsController.MyContacts'\r\n    }, {\r\n      type: PrivacyType.Nobody,\r\n      langKey: 'PrivacySettingsController.Nobody'\r\n    }];\r\n\r\n    if(options.skipTypes) {\r\n      r = r.filter((r) => !options.skipTypes.includes(r.type));\r\n    }\r\n    \r\n    const random = randomLong();\r\n    r.forEach(({type, langKey}) => {\r\n      const row = new Row({\r\n        radioField: new RadioField({\r\n          langKey, \r\n          name: random, \r\n          value: '' + type\r\n        })\r\n      });\r\n      \r\n      this.radioRows.set(type, row);\r\n    });\r\n\r\n    const form = RadioFormFromRows([...this.radioRows.values()], this.onRadioChange);\r\n\r\n    this.radioSection.content.append(form);\r\n    if(options.appendTo) {\r\n      options.appendTo.append(this.radioSection.container);\r\n    }\r\n\r\n    if(!options.noExceptions) {\r\n      const container = generateSection(options.appendTo, 'PrivacyExceptions', 'PrivacySettingsController.PeerInfo');\r\n\r\n      this.exceptions = new Map([[\r\n        'disallow', \r\n        {\r\n          titleLangKey: options.exceptionTexts[0],\r\n          key: 'disallow',\r\n          row: null,\r\n          icon: 'deleteuser',\r\n          subtitleLangKey: 'PrivacySettingsController.AddUsers',\r\n          clickable: true\r\n        }\r\n      ], [\r\n        'allow', \r\n        {\r\n          titleLangKey: options.exceptionTexts[1],\r\n          key: 'allow',\r\n          row: null,\r\n          icon: 'adduser',\r\n          subtitleLangKey: 'PrivacySettingsController.AddUsers',\r\n          clickable: true\r\n        }\r\n      ]]);\r\n\r\n      this.exceptions.forEach((exception) => {\r\n        exception.row = new Row(exception);\r\n\r\n        exception.row.container.addEventListener('click', () => {\r\n          promise.then(() => {\r\n            const _peerIds = this.peerIds[exception.key];\r\n            options.tab.slider.createTab(AppAddMembersTab).open({\r\n              type: 'privacy',\r\n              skippable: true,\r\n              title: exception.titleLangKey,\r\n              placeholder: 'PrivacyModal.Search.Placeholder',\r\n              takeOut: (newPeerIds) => {\r\n                _peerIds.length = 0;\r\n                _peerIds.push(...newPeerIds);\r\n                exception.row.subtitle.innerHTML = '';\r\n                exception.row.subtitle.append(...this.generateStr(this.splitPeersByType(newPeerIds)));\r\n              },\r\n              selectedPeerIds: _peerIds\r\n            });\r\n          });\r\n        });\r\n\r\n        container.append(exception.row.container);\r\n      });\r\n    }\r\n\r\n    /* setTimeout(() => {\r\n      this.setRadio(PrivacyType.Contacts);\r\n    }, 0); */\r\n\r\n    const promise = managers.appPrivacyManager.getPrivacy(options.inputKey).then((rules) => {\r\n      const details = getPrivacyRulesDetails(rules);\r\n      this.setRadio(details.type);\r\n\r\n      if(this.exceptions) {\r\n        this.peerIds = {};\r\n        ['allow' as const, 'disallow' as const].forEach((k) => {\r\n          const arr = [];\r\n          const from = k === 'allow' ? details.allowPeers : details.disallowPeers;\r\n          arr.push(...from.users.map((id) => id.toPeerId()));\r\n          arr.push(...from.chats.map((id) => id.toPeerId(true)));\r\n          this.peerIds[k] = arr;\r\n          const s = this.exceptions.get(k).row.subtitle;\r\n          s.innerHTML = '';\r\n          s.append(...this.generateStr(from));\r\n        });\r\n      }\r\n\r\n      options.tab.eventListener.addEventListener('destroy', async() => {\r\n        const rules: InputPrivacyRule[] = [];\r\n\r\n        switch(this.type) {\r\n          case PrivacyType.Everybody:\r\n            rules.push({_: 'inputPrivacyValueAllowAll'});\r\n            break;\r\n          case PrivacyType.Contacts:\r\n            rules.push({_: 'inputPrivacyValueAllowContacts'});\r\n            break;\r\n          case PrivacyType.Nobody:\r\n            rules.push({_: 'inputPrivacyValueDisallowAll'});\r\n            break;\r\n        }\r\n\r\n        if(this.exceptions) {\r\n          const a = ([\r\n            ['allow',     'inputPrivacyValueAllowChatParticipants',     'inputPrivacyValueAllowUsers'],\r\n            ['disallow',  'inputPrivacyValueDisallowChatParticipants',  'inputPrivacyValueDisallowUsers']\r\n          ] as Array<[\r\n            'allow' | 'disallow', \r\n            'inputPrivacyValueAllowChatParticipants' | 'inputPrivacyValueDisallowChatParticipants', \r\n            'inputPrivacyValueAllowUsers' | 'inputPrivacyValueDisallowUsers'\r\n          ]>);\r\n          for(const [k, chatKey, usersKey] of a) {\r\n            if(this.exceptions.get(k).row.container.classList.contains('hide')) {\r\n              return;\r\n            }\r\n\r\n            const _peerIds = this.peerIds[k];\r\n            if(_peerIds) {\r\n              const splitted = this.splitPeersByType(_peerIds);\r\n              if(splitted.chats.length) {\r\n                rules.push({_: chatKey, chats: splitted.chats});\r\n              }\r\n  \r\n              if(splitted.users.length) {\r\n                rules.push({\r\n                  _: usersKey, \r\n                  users: await Promise.all(splitted.users.map((id) => managers.appUsersManager.getUserInput(id)))\r\n                });\r\n              }\r\n            }\r\n          }\r\n        }\r\n        \r\n        managers.appPrivacyManager.setPrivacy(options.inputKey, rules);\r\n      }, {once: true});\r\n    });\r\n  }\r\n\r\n  private onRadioChange = (value: string | PrivacySection['type']) => {\r\n    value = +value as PrivacySection['type'];\r\n    this.type = value;\r\n\r\n    const caption = this.options.captions[this.type];\r\n    const captionElement = this.radioSection.caption;\r\n    if(!caption) {\r\n      captionElement.innerHTML = '';\r\n    } else if(caption instanceof HTMLElement) {\r\n      replaceContent(captionElement, caption);\r\n    } else {\r\n      _i18n(captionElement, caption);\r\n    }\r\n    captionElement.classList.toggle('hide', !caption);\r\n\r\n    if(this.exceptions) {\r\n      this.exceptions.get('allow').row.container.classList.toggle('hide', this.type === PrivacyType.Everybody);\r\n      this.exceptions.get('disallow').row.container.classList.toggle('hide', this.type === PrivacyType.Nobody);\r\n    }\r\n\r\n    this.options.onRadioChange && this.options.onRadioChange(value);\r\n  };\r\n\r\n  public setRadio(type: PrivacySection['type']) {\r\n    const row = this.radioRows.get(type);\r\n    this.onRadioChange(type);\r\n    row.radioField.input.checked = true;\r\n  }\r\n  \r\n  private splitPeersByType(peerIds: PeerId[]) {\r\n    const peers = {users: [] as UserId[], chats: [] as ChatId[]};\r\n    peerIds.forEach((peerId) => {\r\n      peers[peerId.isAnyChat() ? 'chats' : 'users'].push(peerId.isAnyChat() ? peerId.toChatId() : peerId);\r\n    });\r\n\r\n    return peers;\r\n  }\r\n\r\n  private generateStr(peers: {users: UserId[], chats: ChatId[]}) {\r\n    if(!peers.users.length && !peers.chats.length) {\r\n      return [i18n('PrivacySettingsController.AddUsers')];\r\n    }\r\n\r\n    return join([\r\n      peers.users.length ? i18n('Users', [peers.users.length]) : null, \r\n      peers.chats.length ? i18n('Chats', [peers.chats.length]) : null\r\n    ].filter(Boolean), false);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport PrivacySection from \"../../../privacySection\";\r\nimport { i18n, LangPackKey } from \"../../../../lib/langPack\";\r\nimport anchorCopy from \"../../../../helpers/dom/anchorCopy\";\r\nimport PrivacyType from \"../../../../lib/appManagers/utils/privacy/privacyType\";\r\n\r\nexport default class AppPrivacyPhoneNumberTab extends SliderSuperTabEventable {\r\n  protected async init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('privacy-tab', 'privacy-phone-number');\r\n    this.setTitle('PrivacyPhone');\r\n\r\n    const formatted = '+' + (await this.managers.appUsersManager.getSelf()).phone;\r\n    const captionEl = document.createElement('div');\r\n    captionEl.append(\r\n      i18n('PrivacyPhoneInfo'), \r\n      document.createElement('br'), \r\n      document.createElement('br'), \r\n      i18n('PrivacyPhoneInfo4'),\r\n      document.createElement('br'),\r\n      anchorCopy({\r\n        mePath: formatted\r\n      })\r\n    );\r\n\r\n    const phoneSection = new PrivacySection({\r\n      tab: this,\r\n      title: 'PrivacyPhoneTitle',\r\n      inputKey: 'inputPrivacyKeyPhoneNumber',\r\n      captions: [captionEl, captionEl, ''],\r\n      exceptionTexts: ['PrivacySettingsController.NeverShare', 'PrivacySettingsController.AlwaysShare'],\r\n      appendTo: this.scrollable,\r\n      onRadioChange: (type) => {\r\n        s.setRadio(PrivacyType.Everybody);\r\n        s.radioSection.container.classList.toggle('hide', type !== PrivacyType.Nobody);\r\n      },\r\n      managers: this.managers\r\n    });\r\n\r\n    const sCaption: LangPackKey = 'PrivacyPhoneInfo3';\r\n    const s = new PrivacySection({\r\n      tab: this,\r\n      title: 'PrivacyPhoneTitle2',\r\n      inputKey: 'inputPrivacyKeyAddedByPhone',\r\n      captions: [sCaption, sCaption, ''],\r\n      noExceptions: true,\r\n      skipTypes: [PrivacyType.Nobody],\r\n      managers: this.managers\r\n    });\r\n\r\n    this.scrollable.container.insertBefore(s.radioSection.container, phoneSection.radioSection.container.nextSibling);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { toastNew } from \"../../components/toast\";\r\nimport { copyTextToClipboard } from \"../clipboard\";\r\nimport cancelEvent from \"./cancelEvent\";\r\nimport { attachClickEvent } from \"./clickEvent\";\r\n\r\nexport default function anchorCopy(options: Partial<{\r\n  // href: string,\r\n  mePath: string\r\n}> = {}) {\r\n  const anchor = document.createElement('a');\r\n  anchor.classList.add('anchor-copy');\r\n\r\n  if(options.mePath) {\r\n    const href = 'https://t.me/' + options.mePath;\r\n    anchor.href = anchor.innerText = href;\r\n  }\r\n\r\n  attachClickEvent(anchor, (e) => {\r\n    cancelEvent(e);\r\n    copyTextToClipboard(anchor.href);\r\n    toastNew({langPackKey: 'LinkCopied'});\r\n  });\r\n\r\n  return anchor;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport wrapSticker from \"./sticker\"\r\n\r\nexport default async function wrapStickerEmoji({emoji, div, width, height, managers = rootScope.managers}: {\r\n  emoji: string,\r\n  div: HTMLElement,\r\n  managers?: AppManagers,\r\n  width: number,\r\n  height: number\r\n}) {\r\n  const doc = await managers.appStickersManager.getAnimatedEmojiSticker(emoji);\r\n  if(!doc) {\r\n    div.classList.add('media-sticker-wrapper');\r\n    throw new Error('no sticker');\r\n  }\r\n\r\n  return wrapSticker({\r\n    doc,\r\n    div,\r\n    emoji,\r\n    width,\r\n    height,\r\n    loop: false,\r\n    play: true\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\nimport Button from \"../../../button\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport wrapStickerEmoji from \"../../../wrappers/stickerEmoji\";\r\nimport AppSettingsTab from \"../settings\";\r\n\r\nexport default class AppTwoStepVerificationSetTab extends SliderSuperTab {\r\n  protected init() {\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-set');\r\n    this.setTitle('TwoStepVerificationPasswordSet');\r\n\r\n    const section = new SettingSection({\r\n      captionOld: 'TwoStepVerificationPasswordSetInfo',\r\n      noDelimiter: true\r\n    });\r\n\r\n    const emoji = '';\r\n    const stickerContainer = document.createElement('div');\r\n\r\n    wrapStickerEmoji({\r\n      emoji,\r\n      div: stickerContainer,\r\n      width: 160,\r\n      height: 160\r\n    });\r\n\r\n    section.content.append(stickerContainer);\r\n\r\n    const inputContent = section.generateContentElement();\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const btnReturn = Button('btn-primary btn-color-primary', {text: 'TwoStepVerificationPasswordReturnSettings'});\r\n\r\n    attachClickEvent(btnReturn, (e) => {\r\n      this.close();\r\n    });\r\n\r\n    this.slider.sliceTabsUntilTab(AppSettingsTab, this);\r\n\r\n    inputWrapper.append(btnReturn);\r\n\r\n    inputContent.append(inputWrapper);\r\n\r\n    this.scrollable.container.append(section.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { IS_MOBILE_SAFARI } from \"../../environment/userAgent\";\r\n\r\nexport function canFocus(isFirstInput: boolean) {\r\n  return !IS_MOBILE_SAFARI || !isFirstInput;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { AccountPassword } from \"../../../../layer\";\r\nimport Button from \"../../../button\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport AppTwoStepVerificationSetTab from \"./passwordSet\";\r\nimport CodeInputField from \"../../../codeInputField\";\r\nimport AppTwoStepVerificationEmailTab from \"./email\";\r\nimport { putPreloader } from \"../../../putPreloader\";\r\nimport { i18n, _i18n } from \"../../../../lib/langPack\";\r\nimport { canFocus } from \"../../../../helpers/dom/canFocus\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\nimport replaceContent from \"../../../../helpers/dom/replaceContent\";\r\nimport toggleDisability from \"../../../../helpers/dom/toggleDisability\";\r\nimport wrapStickerEmoji from \"../../../wrappers/stickerEmoji\";\r\n\r\nexport default class AppTwoStepVerificationEmailConfirmationTab extends SliderSuperTab {\r\n  public codeInputField: CodeInputField;\r\n  public state: AccountPassword;\r\n  public email: string;\r\n  public length: number;\r\n  public isFirst = false;\r\n\r\n  protected init() {\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-email-confirmation');\r\n    this.setTitle('TwoStepAuth.RecoveryTitle');\r\n\r\n    const section = new SettingSection({\r\n      captionOld: true,\r\n      noDelimiter: true\r\n    });\r\n\r\n    _i18n(section.caption, 'TwoStepAuth.ConfirmEmailCodeDesc', [this.email]);\r\n\r\n    const emoji = '';\r\n    const stickerContainer = document.createElement('div');\r\n\r\n    wrapStickerEmoji({\r\n      div: stickerContainer,\r\n      width: 160,\r\n      height: 160,\r\n      emoji\r\n    });\r\n\r\n    section.content.append(stickerContainer);\r\n\r\n    const inputContent = section.generateContentElement();\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const inputField = this.codeInputField = new CodeInputField({\r\n      name: 'recovery-email-code',\r\n      label: 'TwoStepAuth.RecoveryCode',\r\n      length: this.length,\r\n      onFill: (code) => {\r\n        freeze(true);\r\n        \r\n        this.managers.passwordManager.confirmPasswordEmail('' + code)\r\n        .then((value) => {\r\n          if(!value) {\r\n\r\n          }\r\n\r\n          goNext();\r\n        })\r\n        .catch((err) => {\r\n          switch(err.type) {\r\n            case 'CODE_INVALID':\r\n              inputField.input.classList.add('error');\r\n              replaceContent(inputField.label, i18n('TwoStepAuth.RecoveryCodeInvalid'));\r\n              break;\r\n\r\n            case 'EMAIL_HASH_EXPIRED':\r\n              inputField.input.classList.add('error');\r\n              replaceContent(inputField.label, i18n('TwoStepAuth.RecoveryCodeExpired'));\r\n              break;\r\n            \r\n            default:\r\n              console.error('confirm error', err);\r\n              break;\r\n          }\r\n\r\n          freeze(false);\r\n        });\r\n      }\r\n    });\r\n\r\n    const btnChange = Button('btn-primary btn-primary-transparent primary', {text: 'TwoStepAuth.EmailCodeChangeEmail'});\r\n    const btnResend = Button('btn-primary btn-secondary btn-primary-transparent primary', {text: 'ResendCode'});\r\n\r\n    const goNext = () => {\r\n      this.slider.createTab(AppTwoStepVerificationSetTab).open();\r\n    };\r\n\r\n    const freeze = (disable: boolean) => {\r\n      toggleDisability([inputField.input, btnChange, btnResend], disable);\r\n    };\r\n\r\n    attachClickEvent(btnChange, (e) => {\r\n      freeze(true);\r\n      this.managers.passwordManager.cancelPasswordEmail().then((value) => {\r\n        this.slider.sliceTabsUntilTab(AppTwoStepVerificationEmailTab, this);\r\n        this.close();\r\n      }, () => {\r\n        freeze(false);\r\n      });\r\n    });\r\n\r\n    attachClickEvent(btnResend, (e) => {\r\n      freeze(true);\r\n      const d = putPreloader(btnResend);\r\n      this.managers.passwordManager.resendPasswordEmail().then((value) => {\r\n        d.remove();\r\n        freeze(false);\r\n      });\r\n    });\r\n\r\n    inputWrapper.append(inputField.container, btnChange, btnResend);\r\n\r\n    inputContent.append(inputWrapper);\r\n\r\n    this.scrollable.container.append(section.container);\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    if(!canFocus(this.isFirst)) return;\r\n    this.codeInputField.input.focus();\r\n  }\r\n}\r\n","import { EMAIL_REG_EXP } from \".\";\r\n\r\nexport default function matchEmail(text: string) {\r\n  return !text ? null : text.match(EMAIL_REG_EXP);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { AccountPassword } from \"../../../../layer\";\r\nimport Button from \"../../../button\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport InputField from \"../../../inputField\";\r\nimport { putPreloader } from \"../../../putPreloader\";\r\nimport AppTwoStepVerificationSetTab from \"./passwordSet\";\r\nimport AppTwoStepVerificationEmailConfirmationTab from \"./emailConfirmation\";\r\nimport PopupPeer from \"../../../popups/peer\";\r\nimport cancelEvent from \"../../../../helpers/dom/cancelEvent\";\r\nimport { canFocus } from \"../../../../helpers/dom/canFocus\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\nimport matchEmail from \"../../../../lib/richTextProcessor/matchEmail\";\r\nimport wrapStickerEmoji from \"../../../wrappers/stickerEmoji\";\r\n\r\nexport default class AppTwoStepVerificationEmailTab extends SliderSuperTab {\r\n  public inputField: InputField;\r\n  public state: AccountPassword;\r\n  public plainPassword: string;\r\n  public newPassword: string;\r\n  public hint: string;\r\n  public isFirst = false;\r\n\r\n  protected init() {\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-email');\r\n    this.setTitle('RecoveryEmailTitle');\r\n\r\n    const section = new SettingSection({\r\n      captionOld: true,\r\n      noDelimiter: true\r\n    });\r\n\r\n    const emoji = '';\r\n    const stickerContainer = document.createElement('div');\r\n\r\n    wrapStickerEmoji({\r\n      div: stickerContainer,\r\n      width: 160,\r\n      height: 160,\r\n      emoji\r\n    });\r\n\r\n    section.content.append(stickerContainer);\r\n\r\n    const inputContent = section.generateContentElement();\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const inputField = this.inputField = new InputField({\r\n      name: 'recovery-email',\r\n      label: 'RecoveryEmail',\r\n      plainText: true\r\n    });\r\n\r\n    inputField.input.addEventListener('keypress', (e) => {\r\n      if(e.key === 'Enter') {\r\n        cancelEvent(e);\r\n        return onContinueClick();\r\n      }\r\n    });\r\n\r\n    inputField.input.addEventListener('input', (e) => {\r\n      inputField.input.classList.remove('error');\r\n    });\r\n\r\n    const btnContinue = Button('btn-primary btn-color-primary', {text: 'Continue'});\r\n    const btnSkip = Button('btn-primary btn-secondary btn-primary-transparent primary', {text: 'YourEmailSkip'});\r\n\r\n    const goNext = () => {\r\n      this.slider.createTab(AppTwoStepVerificationSetTab).open();\r\n    };\r\n\r\n    const onContinueClick = () => {\r\n      const email = inputField.value.trim();\r\n      const match = matchEmail(email);\r\n      if(!match || match[0].length !== email.length) {\r\n        inputField.input.classList.add('error');\r\n        return;\r\n      }\r\n\r\n      toggleButtons(true);\r\n      const d = putPreloader(btnContinue);\r\n\r\n      this.managers.passwordManager.updateSettings({\r\n        hint: this.hint,\r\n        currentPassword: this.plainPassword,\r\n        newPassword: this.newPassword,\r\n        email\r\n      }).then((value) => {\r\n        goNext();\r\n      }, (err) => {\r\n        if(err.type.includes('EMAIL_UNCONFIRMED')) {\r\n          const symbols = +err.type.match(/^EMAIL_UNCONFIRMED_(\\d+)/)[1];\r\n\r\n          const tab = this.slider.createTab(AppTwoStepVerificationEmailConfirmationTab);\r\n          tab.state = this.state;\r\n          tab.email = email;\r\n          tab.length = symbols;\r\n          tab.open();\r\n        } else {\r\n          console.log('password set error', err);\r\n        }\r\n\r\n        toggleButtons(false);\r\n        d.remove();\r\n      });\r\n    };\r\n    attachClickEvent(btnContinue, onContinueClick);\r\n\r\n    const toggleButtons = (freeze: boolean) => {\r\n      if(freeze) {\r\n        btnContinue.setAttribute('disabled', 'true');\r\n        btnSkip.setAttribute('disabled', 'true');\r\n      } else {\r\n        btnContinue.removeAttribute('disabled');\r\n        btnSkip.removeAttribute('disabled');\r\n      }\r\n    };\r\n\r\n    attachClickEvent(btnSkip, (e) => {\r\n      const popup = new PopupPeer('popup-skip-email', {\r\n        buttons: [{\r\n          langKey: 'Cancel',\r\n          isCancel: true\r\n        }, {\r\n          langKey: 'YourEmailSkip',\r\n          callback: () => {\r\n            //inputContent.classList.add('sidebar-left-section-disabled');\r\n            toggleButtons(true);\r\n            putPreloader(btnSkip);\r\n            this.managers.passwordManager.updateSettings({\r\n              hint: this.hint, \r\n              currentPassword: this.plainPassword,\r\n              newPassword: this.newPassword,\r\n              email: ''\r\n            }).then(() => {\r\n              goNext();\r\n            }, (err) => {\r\n              toggleButtons(false);\r\n            });\r\n          },\r\n          isDanger: true,\r\n        }], \r\n        titleLangKey: 'YourEmailSkipWarning',\r\n        descriptionLangKey: 'YourEmailSkipWarningText'\r\n      });\r\n\r\n      popup.show();\r\n    });\r\n\r\n    inputWrapper.append(inputField.container, btnContinue, btnSkip);\r\n\r\n    inputContent.append(inputWrapper);\r\n\r\n    this.scrollable.container.append(section.container);\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    if(!canFocus(this.isFirst)) return;\r\n    this.inputField.input.focus();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { AccountPassword } from \"../../../../layer\";\r\nimport Button from \"../../../button\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport InputField from \"../../../inputField\";\r\nimport AppTwoStepVerificationEmailTab from \"./email\";\r\nimport { toast } from \"../../../toast\";\r\nimport I18n from \"../../../../lib/langPack\";\r\nimport cancelEvent from \"../../../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\nimport wrapStickerEmoji from \"../../../wrappers/stickerEmoji\";\r\n\r\nexport default class AppTwoStepVerificationHintTab extends SliderSuperTab {\r\n  public inputField: InputField;\r\n  public state: AccountPassword;\r\n  public plainPassword: string;\r\n  public newPassword: string;\r\n\r\n  protected init() {\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-hint');\r\n    this.setTitle('TwoStepAuth.SetupHintTitle');\r\n\r\n    const section = new SettingSection({\r\n      noDelimiter: true\r\n    });\r\n\r\n    const emoji = '';\r\n    const stickerContainer = document.createElement('div');\r\n    wrapStickerEmoji({\r\n      div: stickerContainer,\r\n      width: 160,\r\n      height: 160,\r\n      emoji\r\n    });\r\n\r\n    section.content.append(stickerContainer);\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const inputField = this.inputField = new InputField({\r\n      name: 'hint',\r\n      label: 'TwoStepAuth.SetupHintPlaceholder'\r\n    });\r\n\r\n    inputField.input.addEventListener('keypress', (e) => {\r\n      if(e.key === 'Enter') {\r\n        cancelEvent(e);\r\n        return inputField.value ? onContinueClick() : onSkipClick();\r\n      }\r\n    });\r\n\r\n    const goNext = (e?: Event, saveHint?: boolean) => {\r\n      if(e) {\r\n        cancelEvent(e);\r\n      }\r\n      \r\n      const hint = saveHint ? inputField.value : undefined;\r\n      if(hint && this.newPassword === hint) {\r\n        toast(I18n.format('PasswordAsHintError', true));\r\n        return;\r\n      }\r\n\r\n      const tab = this.slider.createTab(AppTwoStepVerificationEmailTab);\r\n      tab.state = this.state;\r\n      tab.plainPassword = this.plainPassword;\r\n      tab.newPassword = this.newPassword;\r\n      tab.hint = hint;\r\n\r\n      tab.open();\r\n    };\r\n\r\n    const btnContinue = Button('btn-primary btn-color-primary', {text: 'Continue'});\r\n    const btnSkip = Button('btn-primary btn-secondary btn-primary-transparent primary', {text: 'YourEmailSkip'});\r\n\r\n    const onContinueClick = (e?: Event) => goNext(e, true);\r\n    const onSkipClick = (e?: Event) => goNext(e, false);\r\n    attachClickEvent(btnContinue, onContinueClick);\r\n    attachClickEvent(btnSkip, onSkipClick);\r\n\r\n    inputWrapper.append(inputField.container, btnContinue, btnSkip);\r\n\r\n    section.content.append(inputWrapper);\r\n\r\n    this.scrollable.container.append(section.container);\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    this.inputField.input.focus();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { AccountPassword } from \"../../../../layer\";\r\nimport Button from \"../../../button\";\r\nimport PasswordInputField from \"../../../passwordInputField\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport TrackingMonkey from \"../../../monkeys/tracking\";\r\nimport AppTwoStepVerificationHintTab from \"./hint\";\r\nimport { InputState } from \"../../../inputField\";\r\nimport cancelEvent from \"../../../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\n\r\nexport default class AppTwoStepVerificationReEnterPasswordTab extends SliderSuperTab {\r\n  public state: AccountPassword;\r\n  public passwordInputField: PasswordInputField;\r\n  public plainPassword: string;\r\n  public newPassword: string;\r\n\r\n  protected init() {\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-enter-password', 'two-step-verification-re-enter-password');\r\n    this.setTitle('PleaseReEnterPassword');\r\n\r\n    const section = new SettingSection({\r\n      noDelimiter: true\r\n    });\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const passwordInputField = this.passwordInputField = new PasswordInputField({\r\n      name: 're-enter-password',\r\n      label: 'PleaseReEnterPassword'\r\n    });\r\n\r\n    const monkey = new TrackingMonkey(passwordInputField, 157);\r\n\r\n    const btnContinue = Button('btn-primary btn-color-primary', {text: 'Continue'});\r\n\r\n    inputWrapper.append(passwordInputField.container, btnContinue);\r\n    section.content.append(monkey.container, inputWrapper);\r\n\r\n    this.scrollable.container.append(section.container);\r\n\r\n    passwordInputField.input.addEventListener('keypress', (e) => {\r\n      if(passwordInputField.input.classList.contains('error')) {\r\n        passwordInputField.setState(InputState.Neutral);\r\n      }\r\n  \r\n      if(e.key === 'Enter') {\r\n        return onContinueClick();\r\n      }\r\n    });\r\n\r\n    const verifyInput = () => {\r\n      if(this.newPassword !== passwordInputField.value) {\r\n        passwordInputField.setError();\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    };\r\n\r\n    const onContinueClick = (e?: Event) => {\r\n      if(e) {\r\n        cancelEvent(e);\r\n      }\r\n\r\n      if(!verifyInput()) return;\r\n\r\n      const tab = this.slider.createTab(AppTwoStepVerificationHintTab);\r\n      tab.state = this.state;\r\n      tab.plainPassword = this.plainPassword;\r\n      tab.newPassword = this.newPassword;\r\n      tab.open();\r\n    };\r\n    attachClickEvent(btnContinue, onContinueClick);\r\n\r\n    return monkey.load();\r\n  }\r\n  \r\n  onOpenAfterTimeout() {\r\n    this.passwordInputField.input.focus();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport AppTwoStepVerificationTab from \".\";\r\nimport { SettingSection } from \"../..\";\r\nimport cancelEvent from \"../../../../helpers/dom/cancelEvent\";\r\nimport { canFocus } from \"../../../../helpers/dom/canFocus\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\nimport replaceContent from \"../../../../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../../../../helpers/dom/setInnerHTML\";\r\nimport { AccountPassword } from \"../../../../layer\";\r\nimport I18n, { i18n } from \"../../../../lib/langPack\";\r\nimport wrapEmojiText from \"../../../../lib/richTextProcessor/wrapEmojiText\";\r\nimport Button from \"../../../button\";\r\nimport { putPreloader } from \"../../../putPreloader\";\r\nimport PasswordMonkey from \"../../../monkeys/password\";\r\nimport PasswordInputField from \"../../../passwordInputField\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport AppTwoStepVerificationReEnterPasswordTab from \"./reEnterPassword\";\r\n\r\nexport default class AppTwoStepVerificationEnterPasswordTab extends SliderSuperTab {\r\n  public state: AccountPassword;\r\n  public passwordInputField: PasswordInputField;\r\n  public plainPassword: string;\r\n  public isFirst = true;\r\n  \r\n  protected init() {\r\n    const isNew = !this.state.pFlags.has_password || this.plainPassword;\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-enter-password');\r\n    this.setTitle(isNew ? 'PleaseEnterFirstPassword' : 'PleaseEnterCurrentPassword');\r\n\r\n    const section = new SettingSection({\r\n      noDelimiter: true\r\n    });\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    const passwordInputField = this.passwordInputField = new PasswordInputField({\r\n      name: 'enter-password',\r\n      label: isNew ? 'PleaseEnterFirstPassword' : (this.state.hint ? undefined : 'LoginPassword'),\r\n      labelText: !isNew && this.state.hint ? wrapEmojiText(this.state.hint) : undefined\r\n    });\r\n\r\n    const monkey = new PasswordMonkey(passwordInputField, 157);\r\n\r\n    const btnContinue = Button('btn-primary btn-color-primary');\r\n    const textEl = new I18n.IntlElement({key: 'Continue'});\r\n\r\n    btnContinue.append(textEl.element);\r\n\r\n    inputWrapper.append(passwordInputField.container, btnContinue);\r\n    section.content.append(monkey.container, inputWrapper);\r\n\r\n    this.scrollable.container.append(section.container);\r\n\r\n    passwordInputField.input.addEventListener('keypress', (e) => {\r\n      if(passwordInputField.input.classList.contains('error')) {\r\n        passwordInputField.input.classList.remove('error');\r\n        textEl.key = 'Continue';\r\n        textEl.update();\r\n      }\r\n  \r\n      if(e.key === 'Enter') {\r\n        return onContinueClick();\r\n      }\r\n    });\r\n\r\n    const verifyInput = () => {\r\n      if(!passwordInputField.value.length) {\r\n        passwordInputField.input.classList.add('error');\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    };\r\n\r\n    let onContinueClick: (e?: Event) => void;\r\n    if(!isNew) {\r\n      let getStateInterval: number;\r\n\r\n      let getState = () => {\r\n        // * just to check session relevance\r\n        if(!getStateInterval) {\r\n          getStateInterval = window.setInterval(getState, 10e3);\r\n        }\r\n  \r\n        return this.managers.passwordManager.getState().then((_state) => {\r\n          this.state = _state;\r\n  \r\n          if(this.state.hint) {\r\n            setInnerHTML(passwordInputField.label, wrapEmojiText(this.state.hint));\r\n          } else {\r\n            replaceContent(passwordInputField.label, i18n('LoginPassword'));\r\n          }\r\n        });\r\n      };\r\n  \r\n      const submit = (e?: Event) => {\r\n        if(!verifyInput()) {\r\n          cancelEvent(e);\r\n          return;\r\n        }\r\n\r\n        btnContinue.setAttribute('disabled', 'true');\r\n        textEl.key = 'PleaseWait';\r\n        textEl.update();\r\n        const preloader = putPreloader(btnContinue);\r\n  \r\n        const plainPassword = passwordInputField.value;\r\n        this.managers.passwordManager.check(passwordInputField.value, this.state).then((auth) => {\r\n          console.log(auth);\r\n  \r\n          if(auth._ === 'auth.authorization') {\r\n            clearInterval(getStateInterval);\r\n            if(monkey) monkey.remove();\r\n            const tab = this.slider.createTab(AppTwoStepVerificationTab);\r\n            tab.state = this.state;\r\n            tab.plainPassword = plainPassword;\r\n            tab.open();\r\n            this.slider.removeTabFromHistory(this);\r\n          }\r\n        }, (err) => {\r\n          btnContinue.removeAttribute('disabled');\r\n          passwordInputField.input.classList.add('error');\r\n          \r\n          switch(err.type) {\r\n            default:\r\n              //btnContinue.innerText = err.type;\r\n              textEl.key = 'PASSWORD_HASH_INVALID';\r\n              textEl.update();\r\n              preloader.remove();\r\n              passwordInputField.select();\r\n              break;\r\n          }\r\n  \r\n          getState();\r\n        });\r\n      };\r\n  \r\n      onContinueClick = submit;\r\n\r\n      getState();\r\n    } else {\r\n      onContinueClick = (e) => {\r\n        if(e) {\r\n          cancelEvent(e);\r\n        }\r\n\r\n        if(!verifyInput()) return;\r\n\r\n        const tab = this.slider.createTab(AppTwoStepVerificationReEnterPasswordTab);\r\n        tab.state = this.state;\r\n        tab.newPassword = passwordInputField.value;\r\n        tab.plainPassword = this.plainPassword;\r\n        tab.open();\r\n      };\r\n    }\r\n\r\n    attachClickEvent(btnContinue, onContinueClick);\r\n\r\n    return monkey.load();\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    if(!canFocus(this.isFirst)) return;\r\n    this.passwordInputField.input.focus();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport { attachClickEvent } from \"../../../../helpers/dom/clickEvent\";\r\nimport { AccountPassword } from \"../../../../layer\";\r\nimport { _i18n } from \"../../../../lib/langPack\";\r\nimport Button from \"../../../button\";\r\nimport PopupPeer from \"../../../popups/peer\";\r\nimport { SliderSuperTab } from \"../../../slider\";\r\nimport wrapStickerEmoji from \"../../../wrappers/stickerEmoji\";\r\nimport AppSettingsTab from \"../settings\";\r\nimport AppTwoStepVerificationEmailTab from \"./email\";\r\nimport AppTwoStepVerificationEnterPasswordTab from \"./enterPassword\";\r\n\r\nexport default class AppTwoStepVerificationTab extends SliderSuperTab {\r\n  public state: AccountPassword;\r\n  public plainPassword: string;\r\n\r\n  protected init() {\r\n    this.container.classList.add('two-step-verification', 'two-step-verification-main');\r\n    this.setTitle('TwoStepVerificationTitle');\r\n\r\n    const section = new SettingSection({\r\n      captionOld: true,\r\n      noDelimiter: true\r\n    });\r\n\r\n    const emoji = '';\r\n    const stickerContainer = document.createElement('div');\r\n\r\n    wrapStickerEmoji({\r\n      div: stickerContainer,\r\n      width: 168,\r\n      height: 168,\r\n      emoji\r\n    });\r\n\r\n    section.content.append(stickerContainer);\r\n\r\n    const c = section.generateContentElement();\r\n    if(this.state.pFlags.has_password) {\r\n      _i18n(section.caption, 'TwoStepAuth.GenericHelp');\r\n\r\n      const btnChangePassword = Button('btn-primary btn-transparent', {icon: 'edit', text: 'TwoStepAuth.ChangePassword'});\r\n      const btnDisablePassword = Button('btn-primary btn-transparent', {icon: 'passwordoff', text: 'TwoStepAuth.RemovePassword'});\r\n      const btnSetRecoveryEmail = Button('btn-primary btn-transparent', {icon: 'email', text: this.state.pFlags.has_recovery ? 'TwoStepAuth.ChangeEmail' : 'TwoStepAuth.SetupEmail'});\r\n\r\n      attachClickEvent(btnChangePassword, () => {\r\n        const tab = this.slider.createTab(AppTwoStepVerificationEnterPasswordTab);\r\n        tab.state = this.state;\r\n        tab.plainPassword = this.plainPassword;\r\n        tab.open();\r\n      });\r\n\r\n      attachClickEvent(btnDisablePassword, () => {\r\n        const popup = new PopupPeer('popup-disable-password', {\r\n          buttons: [{\r\n            langKey: 'Disable',\r\n            callback: () => {\r\n              this.managers.passwordManager.updateSettings({currentPassword: this.plainPassword}).then(() => {\r\n                this.slider.sliceTabsUntilTab(AppSettingsTab, this);\r\n                this.close();\r\n              });\r\n            },\r\n            isDanger: true,\r\n          }], \r\n          titleLangKey: 'TurnPasswordOffQuestionTitle',\r\n          descriptionLangKey: 'TurnPasswordOffQuestion'\r\n        });\r\n\r\n        popup.show();\r\n      });\r\n\r\n      attachClickEvent(btnSetRecoveryEmail, () => {\r\n        const tab = this.slider.createTab(AppTwoStepVerificationEmailTab);\r\n        tab.state = this.state;\r\n        tab.hint = this.state.hint;\r\n        tab.plainPassword = this.plainPassword;\r\n        tab.newPassword = this.plainPassword;\r\n        tab.isFirst = true;\r\n        tab.open();\r\n      });\r\n\r\n      c.append(btnChangePassword, btnDisablePassword, btnSetRecoveryEmail);\r\n    } else {\r\n      _i18n(section.caption, 'TwoStepAuth.SetPasswordHelp');\r\n\r\n      const inputWrapper = document.createElement('div');\r\n      inputWrapper.classList.add('input-wrapper');\r\n\r\n      const btnSetPassword = Button('btn-primary btn-color-primary', {text: 'TwoStepVerificationSetPassword'});\r\n      \r\n      inputWrapper.append(btnSetPassword);\r\n      c.append(inputWrapper);\r\n\r\n      attachClickEvent(btnSetPassword, (e) => {\r\n        const tab = this.slider.createTab(AppTwoStepVerificationEnterPasswordTab);\r\n        tab.state = this.state;\r\n        tab.open();\r\n      });\r\n    }\r\n\r\n    this.scrollable.container.append(section.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport PrivacySection from \"../../../privacySection\";\r\nimport { LangPackKey } from \"../../../../lib/langPack\";\r\n\r\nexport default class AppPrivacyLastSeenTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('privacy-tab', 'privacy-last-seen');\r\n    this.setTitle('PrivacyLastSeen');\r\n\r\n    const caption: LangPackKey = 'PrivacySettingsController.LastSeenDescription';\r\n    new PrivacySection({\r\n      tab: this,\r\n      title: 'LastSeenTitle',\r\n      inputKey: 'inputPrivacyKeyStatusTimestamp',\r\n      captions: [caption, caption, caption],\r\n      exceptionTexts: ['PrivacySettingsController.NeverShare', 'PrivacySettingsController.AlwaysShare'],\r\n      appendTo: this.scrollable,\r\n      managers: this.managers\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport PrivacySection from \"../../../privacySection\";\r\nimport { LangPackKey } from \"../../../../lib/langPack\";\r\nimport PrivacyType from \"../../../../lib/appManagers/utils/privacy/privacyType\";\r\n\r\nexport default class AppPrivacyProfilePhotoTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('privacy-tab', 'privacy-profile-photo');\r\n    this.setTitle('PrivacyProfilePhoto');\r\n\r\n    const caption: LangPackKey = 'PrivacySettingsController.ProfilePhoto.CustomHelp';\r\n    new PrivacySection({\r\n      tab: this,\r\n      title: 'PrivacyProfilePhotoTitle',\r\n      inputKey: 'inputPrivacyKeyProfilePhoto',\r\n      captions: [caption, caption, caption],\r\n      exceptionTexts: ['PrivacySettingsController.NeverShare', 'PrivacySettingsController.AlwaysShare'],\r\n      appendTo: this.scrollable,\r\n      skipTypes: [PrivacyType.Nobody],\r\n      managers: this.managers\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport PrivacySection from \"../../../privacySection\";\r\nimport { LangPackKey } from \"../../../../lib/langPack\";\r\n\r\nexport default class AppPrivacyForwardMessagesTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('privacy-tab', 'privacy-forward-messages');\r\n    this.setTitle('PrivacySettings.Forwards');\r\n\r\n    const caption: LangPackKey = 'PrivacySettingsController.Forwards.CustomHelp';\r\n    new PrivacySection({\r\n      tab: this,\r\n      title: 'PrivacyForwardsTitle',\r\n      inputKey: 'inputPrivacyKeyForwards',\r\n      captions: [caption, caption, caption],\r\n      exceptionTexts: ['PrivacySettingsController.NeverAllow', 'PrivacySettingsController.AlwaysAllow'],\r\n      appendTo: this.scrollable,\r\n      managers: this.managers\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport PrivacySection from \"../../../privacySection\";\r\nimport { LangPackKey } from \"../../../../lib/langPack\";\r\nimport PrivacyType from \"../../../../lib/appManagers/utils/privacy/privacyType\";\r\n\r\nexport default class AppPrivacyAddToGroupsTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('privacy-tab', 'privacy-add-to-groups');\r\n    this.setTitle('PrivacySettings.Groups');\r\n\r\n    const caption: LangPackKey = 'PrivacySettingsController.GroupDescription';\r\n    new PrivacySection({\r\n      tab: this,\r\n      title: 'WhoCanAddMe',\r\n      inputKey: 'inputPrivacyKeyChatInvite',\r\n      captions: [caption, caption, caption],\r\n      exceptionTexts: ['PrivacySettingsController.NeverAllow', 'PrivacySettingsController.AlwaysAllow'],\r\n      appendTo: this.scrollable,\r\n      skipTypes: [PrivacyType.Nobody],\r\n      managers: this.managers\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport PrivacySection from \"../../../privacySection\";\r\nimport { LangPackKey } from \"../../../../lib/langPack\";\r\n\r\nexport default class AppPrivacyCallsTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('privacy-tab', 'privacy-calls');\r\n    this.setTitle('PrivacySettings.VoiceCalls');\r\n\r\n    const caption: LangPackKey = 'PrivacySettingsController.PhoneCallDescription';\r\n    new PrivacySection({\r\n      tab: this,\r\n      title: 'WhoCanCallMe',\r\n      inputKey: 'inputPrivacyKeyPhoneCall',\r\n      captions: [caption, caption, caption],\r\n      exceptionTexts: ['PrivacySettingsController.NeverAllow', 'PrivacySettingsController.AlwaysAllow'],\r\n      appendTo: this.scrollable,\r\n      managers: this.managers\r\n    });\r\n\r\n    {\r\n      const caption: LangPackKey = 'PrivacySettingsController.P2p.Desc';\r\n      new PrivacySection({\r\n        tab: this,\r\n        title: 'PrivacyP2PHeader',\r\n        inputKey: 'inputPrivacyKeyPhoneP2P',\r\n        captions: [caption, caption, caption],\r\n        exceptionTexts: ['PrivacySettingsController.NeverAllow', 'PrivacySettingsController.AlwaysAllow'],\r\n        appendTo: this.scrollable,\r\n        managers: this.managers\r\n      });\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"..\";\r\nimport Button from \"../../button\";\r\nimport Row from \"../../row\";\r\nimport { Authorization } from \"../../../layer\";\r\nimport { formatDateAccordingToTodayNew } from \"../../../helpers/date\";\r\nimport ButtonMenu from \"../../buttonMenu\";\r\nimport { toast } from \"../../toast\";\r\nimport I18n from \"../../../lib/langPack\";\r\nimport PopupPeer from \"../../popups/peer\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport findAndSplice from \"../../../helpers/array/findAndSplice\";\r\nimport { attachContextMenuListener } from \"../../../helpers/dom/attachContextMenuListener\";\r\nimport positionMenu from \"../../../helpers/positionMenu\";\r\nimport contextMenuController from \"../../../helpers/contextMenuController\";\r\n\r\nexport default class AppActiveSessionsTab extends SliderSuperTabEventable {\r\n  public authorizations: Authorization.authorization[];\r\n  private menuElement: HTMLElement;\r\n  \r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('active-sessions-container');\r\n    this.setTitle('SessionsTitle');\r\n\r\n    const Session = (auth: Authorization.authorization) => {\r\n      const row = new Row({\r\n        title: [auth.app_name, auth.app_version].join(' '),\r\n        subtitle: [auth.ip, auth.country].join(' - '),\r\n        clickable: true,\r\n        titleRight: auth.pFlags.current ? undefined : formatDateAccordingToTodayNew(new Date(Math.max(auth.date_active, auth.date_created) * 1000))\r\n      });\r\n\r\n      row.container.dataset.hash = '' + auth.hash;\r\n\r\n      const midtitle = document.createElement('div');\r\n      midtitle.classList.add('row-midtitle');\r\n      midtitle.innerHTML = [auth.device_model, auth.system_version || auth.platform].filter(Boolean).join(', ');\r\n\r\n      row.subtitle.parentElement.insertBefore(midtitle, row.subtitle);\r\n\r\n      return row;\r\n    };\r\n\r\n    const authorizations = this.authorizations.slice();\r\n\r\n    {\r\n      const section = new SettingSection({\r\n        name: 'CurrentSession',\r\n        caption: 'ClearOtherSessionsHelp'\r\n      });\r\n\r\n      const auth = findAndSplice(authorizations, auth => auth.pFlags.current);\r\n      const session = Session(auth);\r\n\r\n      section.content.append(session.container);\r\n\r\n      if(authorizations.length) {\r\n        const btnTerminate = Button('btn-primary btn-transparent danger', {icon: 'stop', text: 'TerminateAllSessions'});\r\n        attachClickEvent(btnTerminate, (e) => {\r\n          new PopupPeer('revoke-session', {\r\n            buttons: [{\r\n              langKey: 'Terminate',\r\n              isDanger: true,\r\n              callback: () => {\r\n                const toggle = toggleDisability([btnTerminate], true);\r\n                this.managers.apiManager.invokeApi('auth.resetAuthorizations').then((value) => {\r\n                  //toggleDisability([btnTerminate], false);\r\n                  btnTerminate.remove();\r\n                  otherSection.container.remove();\r\n                }, onError).finally(() => {\r\n                  toggle();\r\n                });\r\n              }\r\n            }],\r\n            titleLangKey: 'AreYouSureSessionsTitle',\r\n            descriptionLangKey: 'AreYouSureSessions'\r\n          }).show();\r\n        });\r\n  \r\n        section.content.append(btnTerminate);\r\n      }\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    if(!authorizations.length) {\r\n      return;\r\n    }\r\n\r\n    const otherSection = new SettingSection({\r\n      name: 'OtherSessions',\r\n      caption: 'SessionsListInfo'\r\n    });\r\n\r\n    authorizations.forEach((auth) => {\r\n      otherSection.content.append(Session(auth).container);\r\n    });\r\n\r\n    this.scrollable.append(otherSection.container);\r\n\r\n    const onError = (err: any) => {\r\n      if(err.type === 'FRESH_RESET_AUTHORISATION_FORBIDDEN') {\r\n        toast(I18n.format('RecentSessions.Error.FreshReset', true));\r\n      }\r\n    };\r\n\r\n    let target: HTMLElement;\r\n    const onTerminateClick = () => {\r\n      const hash = target.dataset.hash;\r\n      \r\n      new PopupPeer('revoke-session', {\r\n        buttons: [{\r\n          langKey: 'Terminate',\r\n          isDanger: true,\r\n          callback: () => {\r\n            this.managers.apiManager.invokeApi('account.resetAuthorization', {hash})\r\n            .then((value) => {\r\n              if(value) {\r\n                target.remove();\r\n              }\r\n            }, onError);\r\n          }\r\n        }],\r\n        titleLangKey: 'AreYouSureSessionTitle',\r\n        descriptionLangKey: 'TerminateSessionText'\r\n      }).show();\r\n    };\r\n\r\n    const element = this.menuElement = ButtonMenu([{\r\n      icon: 'stop',\r\n      text: 'Terminate',\r\n      onClick: onTerminateClick\r\n    }]);\r\n    element.id = 'active-sessions-contextmenu';\r\n    element.classList.add('contextmenu');\r\n\r\n    document.getElementById('page-chats').append(element);\r\n\r\n    attachContextMenuListener(this.scrollable.container, (e) => {\r\n      target = findUpClassName(e.target, 'row');\r\n      if(!target || target.dataset.hash === '0') {\r\n        return;\r\n      }\r\n\r\n      if(e instanceof MouseEvent) e.preventDefault();\r\n      // smth\r\n      if(e instanceof MouseEvent) e.cancelBubble = true;\r\n\r\n      positionMenu(e, element);\r\n      contextMenuController.openBtnMenu(element);\r\n    });\r\n\r\n    attachClickEvent(this.scrollable.container, (e) => {\r\n      target = findUpClassName(e.target, 'row');\r\n      if(!target || target.dataset.hash === '0') {\r\n        return;\r\n      }\r\n\r\n      onTerminateClick();\r\n    });\r\n  }\r\n\r\n  onCloseAfterTimeout() {\r\n    if(this.menuElement) {\r\n      this.menuElement.remove();\r\n    }\r\n\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport { SettingSection } from \"..\";\r\nimport ButtonMenu from \"../../buttonMenu\";\r\nimport appDialogsManager, { DIALOG_LIST_ELEMENT_TAG } from \"../../../lib/appManagers/appDialogsManager\";\r\nimport PopupPickUser from \"../../popups/pickUser\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport findUpTag from \"../../../helpers/dom/findUpTag\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport formatUserPhone from \"../../wrappers/formatUserPhone\";\r\nimport getUserStatusString from \"../../wrappers/getUserStatusString\";\r\nimport { attachContextMenuListener } from \"../../../helpers/dom/attachContextMenuListener\";\r\nimport positionMenu from \"../../../helpers/positionMenu\";\r\nimport contextMenuController from \"../../../helpers/contextMenuController\";\r\n\r\nexport default class AppBlockedUsersTab extends SliderSuperTab {\r\n  public peerIds: PeerId[];\r\n  private menuElement: HTMLElement;\r\n  \r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('blocked-users-container');\r\n    this.setTitle('BlockedUsers');\r\n\r\n    const section = new SettingSection({\r\n      caption: 'BlockedUsersInfo'\r\n    });\r\n\r\n    section.caption.parentElement.prepend(section.caption);\r\n\r\n    this.scrollable.append(section.container);\r\n\r\n    const btnAdd = ButtonCorner({icon: 'add', className: 'is-visible'});\r\n    this.content.append(btnAdd);\r\n\r\n    attachClickEvent(btnAdd, (e) => {\r\n      new PopupPickUser({\r\n        peerTypes: ['contacts'],\r\n        placeholder: 'BlockModal.Search.Placeholder',\r\n        onSelect: (peerId) => {\r\n          //console.log('block', peerId);\r\n          this.managers.appUsersManager.toggleBlock(peerId, true);\r\n        },\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const list = appDialogsManager.createChatList();\r\n    this.scrollable.container.classList.add('chatlist-container');\r\n    section.content.append(list);\r\n\r\n    const add = async(peerId: PeerId, append: boolean) => {\r\n      const {dom} = appDialogsManager.addDialogNew({\r\n        peerId: peerId,\r\n        container: list,\r\n        rippleEnabled: true,\r\n        avatarSize: 48,\r\n        append\r\n      });\r\n\r\n      const user = await this.managers.appUsersManager.getUser(peerId);\r\n      if(user.pFlags.bot) {\r\n        dom.lastMessageSpan.append('@' + user.username);\r\n      } else {\r\n        if(user.phone) dom.lastMessageSpan.innerHTML = formatUserPhone(user.phone);\r\n        else dom.lastMessageSpan.append(user.username ? '@' + user.username : getUserStatusString(user));\r\n      }\r\n\r\n      //dom.titleSpan.innerHTML = 'Raaid El Syed';\r\n      //dom.lastMessageSpan.innerHTML = '+1 234 567891';\r\n    };\r\n\r\n    for(const peerId of this.peerIds) {\r\n      add(peerId, true);\r\n    }\r\n\r\n    let target: HTMLElement;\r\n    const onUnblock = () => {\r\n      const peerId = target.dataset.peerId.toPeerId();\r\n      this.managers.appUsersManager.toggleBlock(peerId, false);\r\n    };\r\n\r\n    const element = this.menuElement = ButtonMenu([{\r\n      icon: 'lockoff',\r\n      text: 'Unblock',\r\n      onClick: onUnblock,\r\n      options: {listenerSetter: this.listenerSetter}\r\n    }]);\r\n    element.id = 'blocked-users-contextmenu';\r\n    element.classList.add('contextmenu');\r\n\r\n    document.getElementById('page-chats').append(element);\r\n\r\n    attachContextMenuListener(this.scrollable.container, (e) => {\r\n      target = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG);\r\n      if(!target) {\r\n        return;\r\n      }\r\n\r\n      if(e instanceof MouseEvent) e.preventDefault();\r\n      // smth\r\n      if(e instanceof MouseEvent) e.cancelBubble = true;\r\n\r\n      positionMenu(e, element);\r\n      contextMenuController.openBtnMenu(element);\r\n    }, this.listenerSetter);\r\n\r\n    this.listenerSetter.add(rootScope)('peer_block', (update) => {\r\n      const {peerId, blocked} = update;\r\n      const li = list.querySelector(`[data-peer-id=\"${peerId}\"]`);\r\n      if(blocked) {\r\n        if(!li) {\r\n          add(peerId, false);\r\n        }\r\n      } else {\r\n        if(li) {\r\n          li.remove();\r\n        }\r\n      }\r\n    });\r\n\r\n    const LOAD_COUNT = 50;\r\n    let loading = false;\r\n    this.scrollable.onScrolledBottom = () => {\r\n      if(loading) {\r\n        return;\r\n      }\r\n\r\n      loading = true;\r\n      this.managers.appUsersManager.getBlocked(list.childElementCount, LOAD_COUNT).then((res) => {\r\n        for(const peerId of res.peerIds) {\r\n          add(peerId, true);\r\n        }\r\n\r\n        if(res.peerIds.length < LOAD_COUNT || list.childElementCount === res.count) {\r\n          this.scrollable.onScrolledBottom = null;\r\n        }\r\n\r\n        this.scrollable.checkForTriggers();\r\n      }).finally(() => {\r\n        loading = false;\r\n      });\r\n    };\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    this.scrollable.onScroll();\r\n  }\r\n\r\n  onCloseAfterTimeout() {\r\n    if(this.menuElement) {\r\n      this.menuElement.remove();\r\n    }\r\n\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n","export default function convertKeyToInputKey(key: string) {\r\n  key = key[0].toUpperCase() + key.slice(1);\r\n  key = 'input' + key;\r\n  return key;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { addCancelButton } from \"./popups\";\r\nimport PopupPeer, { PopupPeerOptions } from \"./popups/peer\";\r\n\r\n// type PopupConfirmationOptions = Pick<PopupPeerOptions, 'titleLangKey'>;\r\nexport type PopupConfirmationOptions = PopupPeerOptions & {\r\n  button: PopupPeerOptions['buttons'][0],\r\n  checkbox?: PopupPeerOptions['checkboxes'][0]\r\n};\r\n\r\nexport default function confirmationPopup(options: PopupConfirmationOptions) {\r\n  return new Promise<boolean | void>((resolve, reject) => {\r\n    const {button, checkbox} = options;\r\n    button.callback = (set) => {\r\n      resolve(set ? !!set.size : undefined);\r\n    };\r\n\r\n    const buttons = addCancelButton(options.buttons || [button]);\r\n    const cancelButton = buttons.find((button) => button.isCancel);\r\n    cancelButton.callback = () => {\r\n      reject();\r\n    };\r\n\r\n    options.buttons = buttons;\r\n    options.checkboxes ??= checkbox && [checkbox];\r\n\r\n    new PopupPeer('popup-confirmation', options).show();\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport { SettingSection } from \"..\";\r\nimport Row from \"../../row\";\r\nimport { AccountPassword, Authorization, InputPrivacyKey, Updates } from \"../../../layer\";\r\nimport AppPrivacyPhoneNumberTab from \"./privacy/phoneNumber\";\r\nimport AppTwoStepVerificationTab from \"./2fa\";\r\nimport AppTwoStepVerificationEnterPasswordTab from \"./2fa/enterPassword\";\r\nimport AppTwoStepVerificationEmailConfirmationTab from \"./2fa/emailConfirmation\";\r\nimport AppPrivacyLastSeenTab from \"./privacy/lastSeen\";\r\nimport AppPrivacyProfilePhotoTab from \"./privacy/profilePhoto\";\r\nimport AppPrivacyForwardMessagesTab from \"./privacy/forwardMessages\";\r\nimport AppPrivacyAddToGroupsTab from \"./privacy/addToGroups\";\r\nimport AppPrivacyCallsTab from \"./privacy/calls\";\r\nimport AppActiveSessionsTab from \"./activeSessions\";\r\nimport AppBlockedUsersTab from \"./blockedUsers\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport { i18n, LangPackKey, _i18n } from \"../../../lib/langPack\";\r\nimport replaceContent from \"../../../helpers/dom/replaceContent\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport PopupPeer from \"../../popups/peer\";\r\nimport Button from \"../../button\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport convertKeyToInputKey from \"../../../helpers/string/convertKeyToInputKey\";\r\nimport getPrivacyRulesDetails from \"../../../lib/appManagers/utils/privacy/getPrivacyRulesDetails\";\r\nimport PrivacyType from \"../../../lib/appManagers/utils/privacy/privacyType\";\r\nimport confirmationPopup, { PopupConfirmationOptions } from \"../../confirmationPopup\";\r\nimport noop from \"../../../helpers/noop\";\r\nimport { toastNew } from \"../../toast\";\r\n\r\nexport default class AppPrivacyAndSecurityTab extends SliderSuperTabEventable {\r\n  private activeSessionsRow: Row;\r\n  private authorizations: Authorization.authorization[];\r\n\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('dont-u-dare-block-me');\r\n    this.setTitle('PrivacySettings');\r\n\r\n    const SUBTITLE: LangPackKey = 'Loading';\r\n\r\n    {\r\n      const section = new SettingSection({noDelimiter: true, caption: 'SessionsInfo'});\r\n\r\n      let blockedPeerIds: PeerId[];\r\n      const blockedUsersRow = new Row({\r\n        icon: 'deleteuser',\r\n        titleLangKey: 'BlockedUsers',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          const tab = this.slider.createTab(AppBlockedUsersTab);\r\n          tab.peerIds = blockedPeerIds;\r\n          tab.open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n      blockedUsersRow.freezed = true;\r\n\r\n      let passwordState: AccountPassword;\r\n      const twoFactorRowOptions = {\r\n        icon: 'lock',\r\n        titleLangKey: 'TwoStepVerification' as LangPackKey,\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: (e: Event) => {\r\n          let tab: AppTwoStepVerificationTab | AppTwoStepVerificationEnterPasswordTab | AppTwoStepVerificationEmailConfirmationTab;\r\n          if(passwordState.pFlags.has_password) {\r\n            tab = this.slider.createTab(AppTwoStepVerificationEnterPasswordTab);\r\n          } else if(passwordState.email_unconfirmed_pattern) {\r\n            tab = this.slider.createTab(AppTwoStepVerificationEmailConfirmationTab);\r\n            tab.email = passwordState.email_unconfirmed_pattern;\r\n            tab.length = 6;\r\n            tab.isFirst = true;\r\n            this.managers.passwordManager.resendPasswordEmail();\r\n          } else {\r\n            tab = this.slider.createTab(AppTwoStepVerificationTab);\r\n          }\r\n          \r\n          tab.state = passwordState;\r\n          tab.open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      };\r\n      \r\n      const twoFactorRow = new Row(twoFactorRowOptions);\r\n      twoFactorRow.freezed = true;\r\n\r\n      const activeSessionsRow = this.activeSessionsRow = new Row({\r\n        icon: 'activesessions',\r\n        titleLangKey: 'SessionsTitle',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          const tab = this.slider.createTab(AppActiveSessionsTab);\r\n          tab.authorizations = this.authorizations;\r\n          tab.eventListener.addEventListener('destroy', () => {\r\n            this.updateActiveSessions();\r\n          }, {once: true});\r\n          tab.open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n      activeSessionsRow.freezed = true;\r\n\r\n      section.content.append(blockedUsersRow.container, twoFactorRow.container, activeSessionsRow.container);\r\n      this.scrollable.append(section.container);\r\n\r\n      const setBlockedCount = (count: number) => {\r\n        if(count) {\r\n          replaceContent(blockedUsersRow.subtitle, i18n('PrivacySettingsController.UserCount', [count]));\r\n        } else {\r\n          replaceContent(blockedUsersRow.subtitle, i18n('BlockedEmpty', [count]));\r\n        }\r\n      };\r\n\r\n      this.listenerSetter.add(rootScope)('peer_block', () => {\r\n        /* const {blocked, peerId} = update;\r\n        if(!blocked) blockedPeerIds.findAndSplice((p) => p === peerId);\r\n        else blockedPeerIds.unshift(peerId);\r\n        blockedCount += blocked ? 1 : -1;\r\n        setBlockedCount(blockedCount); */\r\n        updateBlocked();\r\n      });\r\n\r\n      const updateBlocked = () => {\r\n        this.managers.appUsersManager.getBlocked().then((res) => {\r\n          blockedUsersRow.freezed = false;\r\n          setBlockedCount(res.count);\r\n          blockedPeerIds = res.peerIds;\r\n        });\r\n      };\r\n\r\n      updateBlocked();\r\n\r\n      this.managers.passwordManager.getState().then((state) => {\r\n        passwordState = state;\r\n        replaceContent(twoFactorRow.subtitle, i18n(state.pFlags.has_password ? 'PrivacyAndSecurity.Item.On' : 'PrivacyAndSecurity.Item.Off'));\r\n        twoFactorRow.freezed = false;\r\n        \r\n        //console.log('password state', state);\r\n      });\r\n\r\n      this.updateActiveSessions();\r\n    }\r\n\r\n    {\r\n      const section = new SettingSection({name: 'PrivacyTitle', caption: 'GroupsAndChannelsHelp'});\r\n\r\n      section.content.classList.add('privacy-navigation-container');\r\n\r\n      const rowsByKeys: Partial<{\r\n        [key in InputPrivacyKey['_']]: Row\r\n      }> = {};\r\n\r\n      const numberVisibilityRow = rowsByKeys['inputPrivacyKeyPhoneNumber'] = new Row({\r\n        titleLangKey: 'PrivacyPhoneTitle',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          this.slider.createTab(AppPrivacyPhoneNumberTab).open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      const lastSeenTimeRow = rowsByKeys['inputPrivacyKeyStatusTimestamp'] = new Row({\r\n        titleLangKey: 'LastSeenTitle',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          this.slider.createTab(AppPrivacyLastSeenTab).open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      const photoVisibilityRow = rowsByKeys['inputPrivacyKeyProfilePhoto'] = new Row({\r\n        titleLangKey: 'PrivacyProfilePhotoTitle',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          this.slider.createTab(AppPrivacyProfilePhotoTab).open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      const callRow = rowsByKeys['inputPrivacyKeyPhoneCall'] = new Row({\r\n        titleLangKey: 'WhoCanCallMe',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          this.slider.createTab(AppPrivacyCallsTab).open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      const linkAccountRow = rowsByKeys['inputPrivacyKeyForwards'] = new Row({\r\n        titleLangKey: 'PrivacyForwardsTitle',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          this.slider.createTab(AppPrivacyForwardMessagesTab).open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      const groupChatsAddRow = rowsByKeys['inputPrivacyKeyChatInvite'] = new Row({\r\n        titleLangKey: 'WhoCanAddMe',\r\n        subtitleLangKey: SUBTITLE,\r\n        clickable: () => {\r\n          this.slider.createTab(AppPrivacyAddToGroupsTab).open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      const updatePrivacyRow = (key: InputPrivacyKey['_']) => {\r\n        const row = rowsByKeys[key];\r\n        if(!row) {\r\n          return;\r\n        }\r\n\r\n        this.managers.appPrivacyManager.getPrivacy(key).then((rules) => {\r\n          const details = getPrivacyRulesDetails(rules);\r\n          const langKey = details.type === PrivacyType.Everybody ? 'PrivacySettingsController.Everbody' : (details.type === PrivacyType.Contacts ? 'PrivacySettingsController.MyContacts' : 'PrivacySettingsController.Nobody');\r\n          const disallowLength = details.disallowPeers.users.length + details.disallowPeers.chats.length;\r\n          const allowLength = details.allowPeers.users.length + details.allowPeers.chats.length;\r\n\r\n          row.subtitle.innerHTML = '';\r\n          const s = i18n(langKey);\r\n          row.subtitle.append(s);\r\n          if(disallowLength || allowLength) {\r\n            row.subtitle.append(` (${[-disallowLength, allowLength ? '+' + allowLength : 0].filter(Boolean).join(', ')})`);\r\n          }\r\n        });\r\n      };\r\n\r\n      section.content.append(\r\n        numberVisibilityRow.container, \r\n        lastSeenTimeRow.container, \r\n        photoVisibilityRow.container, \r\n        callRow.container, \r\n        linkAccountRow.container, \r\n        groupChatsAddRow.container\r\n      );\r\n      this.scrollable.append(section.container);\r\n\r\n      for(const key in rowsByKeys) {\r\n        updatePrivacyRow(key as keyof typeof rowsByKeys);\r\n      }\r\n\r\n      rootScope.addEventListener('privacy_update', (update) => {\r\n        updatePrivacyRow(convertKeyToInputKey(update.key._) as any);\r\n      });\r\n    }\r\n\r\n    const promises: Promise<any>[] = [];\r\n    {\r\n      const section = new SettingSection({name: 'Privacy.SensitiveContent'});\r\n      section.container.classList.add('hide');\r\n\r\n      promises.push(this.managers.apiManager.invokeApi('account.getContentSettings').then((settings) => {\r\n        if(!settings.pFlags.sensitive_can_change) {\r\n          return;\r\n        }\r\n        \r\n        const enabled = settings.pFlags.sensitive_enabled;\r\n\r\n        const sensitiveRow = new Row({\r\n          checkboxField: new CheckboxField({text: 'PrivacyAndSecurity.SensitiveText', checked: enabled}),\r\n          subtitleLangKey: 'PrivacyAndSecurity.SensitiveDesc',\r\n          noCheckboxSubtitle: true\r\n        });\r\n        \r\n        section.content.append(sensitiveRow.container);\r\n        section.container.classList.remove('hide');\r\n        \r\n        this.eventListener.addEventListener('destroy', () => {\r\n          const _enabled = sensitiveRow.checkboxField.checked;\r\n          const isChanged = _enabled !== enabled;\r\n          if(!isChanged) {\r\n            return;\r\n          }\r\n          \r\n          this.managers.apiManager.invokeApi('account.setContentSettings', {\r\n            sensitive_enabled: _enabled\r\n          });\r\n        }, {once: true});\r\n      }));\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    {\r\n      const section = new SettingSection({name: 'FilterChats'});\r\n\r\n      const onDeleteClick = () => {\r\n        const popup = new PopupPeer('popup-delete-drafts', {\r\n          buttons: [{\r\n            langKey: 'Delete',\r\n            callback: () => {\r\n              const toggle = toggleDisability([deleteButton], true);\r\n              this.managers.appDraftsManager.clearAllDrafts().then(() => {\r\n                toggle();\r\n              });\r\n            },\r\n            isDanger: true,\r\n          }], \r\n          titleLangKey: 'AreYouSureClearDraftsTitle',\r\n          descriptionLangKey: 'AreYouSureClearDrafts'\r\n        });\r\n  \r\n        popup.show();\r\n      };\r\n\r\n      const deleteButton = Button('btn-primary btn-transparent', {icon: 'delete', text: 'PrivacyDeleteCloudDrafts'});\r\n      this.listenerSetter.add(deleteButton)('click', onDeleteClick);\r\n      section.content.append(deleteButton);\r\n\r\n      /* promises.push(apiManager.invokeApi('messages.getAllDrafts').then((drafts) => {\r\n        const draftsRow = new Row({\r\n          titleLangKey: 'PrivacyDeleteCloudDrafts',\r\n          subtitleLangKey: 'Drafts',\r\n          subtitleLangArgs: [(drafts as Updates.updates).updates.length],\r\n          icon: 'delete',\r\n          clickable: onDeleteClick\r\n        });\r\n        \r\n        section.content.append(draftsRow.container);\r\n      })); */\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    {\r\n      const section = new SettingSection({name: 'PrivacyPayments', caption: 'PrivacyPaymentsClearInfo'});\r\n\r\n      const onClearClick = () => {\r\n        const options: PopupConfirmationOptions = {\r\n          titleLangKey: 'PrivacyPaymentsClearAlertTitle',\r\n          descriptionLangKey: 'PrivacyPaymentsClearAlertText',\r\n          button: {\r\n            langKey: 'Clear'\r\n          },\r\n          checkboxes: [{\r\n            text: 'PrivacyClearShipping', \r\n            checked: true\r\n          }, {\r\n            text: 'PrivacyClearPayment', \r\n            checked: true\r\n          }]\r\n        };\r\n\r\n        confirmationPopup(options).then(() => {\r\n          const [info, payment] = options.checkboxes.map((c) => c.checkboxField.checked);\r\n          const toggle = toggleDisability([clearButton], true);\r\n          this.managers.appPaymentsManager.clearSavedInfo(info, payment).then(() => {\r\n            if(!info && !payment) {\r\n              return;\r\n            }\r\n\r\n            toggle();\r\n            toastNew({\r\n              langPackKey: info && payment ? 'PrivacyPaymentsPaymentShippingCleared' : (info ? 'PrivacyPaymentsShippingInfoCleared' : 'PrivacyPaymentsPaymentInfoCleared')\r\n            });\r\n          });\r\n        }, noop);\r\n      };\r\n\r\n      const clearButton = Button('btn-primary btn-transparent', {icon: 'delete', text: 'PrivacyPaymentsClear'});\r\n      this.listenerSetter.add(clearButton)('click', onClearClick);\r\n      section.content.append(clearButton);\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    return Promise.all(promises);\r\n  }\r\n\r\n  public updateActiveSessions() {\r\n    this.managers.apiManager.invokeApi('account.getAuthorizations').then((auths) => {\r\n      this.activeSessionsRow.freezed = false;\r\n      this.authorizations = auths.authorizations;\r\n      _i18n(this.activeSessionsRow.subtitle, 'Privacy.Devices', [this.authorizations.length]);\r\n      //console.log('auths', auths);\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport renderImageFromUrl from \"./dom/renderImageFromUrl\";\r\n\r\nexport function averageColorFromCanvas(canvas: HTMLCanvasElement) {\r\n  const context = canvas.getContext('2d');\r\n\r\n  const pixel = new Array(4).fill(0);\r\n  const pixels = context.getImageData(0, 0, canvas.width, canvas.height).data;\r\n  for(let i = 0; i < pixels.length; i += 4) {\r\n    pixel[0] += pixels[i];\r\n    pixel[1] += pixels[i + 1];\r\n    pixel[2] += pixels[i + 2];\r\n    pixel[3] += pixels[i + 3];\r\n  }\r\n\r\n  const pixelsLength = pixels.length / 4;\r\n  const outPixel = new Uint8ClampedArray(4);\r\n  outPixel[0] = pixel[0] / pixelsLength;\r\n  outPixel[1] = pixel[1] / pixelsLength;\r\n  outPixel[2] = pixel[2] / pixelsLength;\r\n  outPixel[3] = pixel[3] / pixelsLength;\r\n  return outPixel;\r\n}\r\n\r\nexport function averageColor(imageUrl: string) {\r\n  const img = document.createElement('img');\r\n  return new Promise<Uint8ClampedArray>((resolve) => {\r\n    renderImageFromUrl(img, imageUrl, () => {\r\n      const canvas = document.createElement('canvas');\r\n      const ratio = img.naturalWidth / img.naturalHeight;\r\n      const DIMENSIONS = 50;\r\n      if(ratio === 1) {\r\n        canvas.width = DIMENSIONS;\r\n        canvas.height = canvas.width / ratio;\r\n      } else if(ratio > 1) {\r\n        canvas.height = DIMENSIONS;\r\n        canvas.width = canvas.height / ratio;\r\n      } else {\r\n        canvas.width = canvas.height = DIMENSIONS;\r\n      }\r\n      \r\n      const context = canvas.getContext('2d');\r\n      context.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, 0, 0, canvas.width, canvas.height);\r\n      resolve(averageColorFromCanvas(canvas));\r\n    });\r\n  });\r\n};\r\n","import { rgbaToHsla } from \"./color\";\r\n\r\n// * https://github.com/TelegramMessenger/Telegram-iOS/blob/3d062fff78cc6b287c74e6171f855a3500c0156d/submodules/TelegramPresentationData/Sources/PresentationData.swift#L453\r\nexport default function highlightningColor(rgba: [number, number, number, number?]) {\r\n  let {h, s, l} = rgbaToHsla(rgba[0], rgba[1], rgba[2]);\r\n  if(s > 0) {\r\n    s = Math.min(100, s + 5 + 0.1 * (100 - s));\r\n  }\r\n  l = Math.max(0, l * .65);\r\n  \r\n  const hsla = `hsla(${h}, ${s}%, ${l}%, .4)`;\r\n  return hsla;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko, Artem Kolnogorov and unknown creator of the script taken from http://useless.altervista.org/gradient.html\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { animate } from \"../../helpers/animation\";\r\nimport { hexToRgb } from \"../../helpers/color\";\r\n\r\nconst WIDTH = 50;\r\nconst HEIGHT = WIDTH;\r\n\r\nexport default class ChatBackgroundGradientRenderer {\r\n  private readonly _width = WIDTH;\r\n  private readonly _height = HEIGHT;\r\n  private _phase: number;\r\n  private _tail: number;\r\n  private readonly _tails = 90;\r\n  private readonly _scrollTails = 50;\r\n  private _frames: ImageData[];\r\n  private _colors: {r: number, g: number, b: number}[];\r\n  /* private readonly _curve = [ \r\n    0, 25, 50, 75, 100, 150, 200, 250, 300, 350, 400, 500, 600, 700, 800, 900, \r\n    1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1830, 1860, 1890, 1920, \r\n    1950, 1980, 2010, 2040, 2070, 2100, 2130, 2160, 2190, 2220, 2250, 2280, 2310, \r\n    2340, 2370, 2400, 2430, 2460, 2490, 2520, 2550, 2580, 2610, 2630, 2640, 2650, \r\n    2660, 2670, 2680, 2690, 2700\r\n  ]; */\r\n  private readonly _curve = [\r\n    0 , 0.25 , 0.50 , 0.75 , 1 , 1.5 , 2 , 2.5 , 3 , 3.5 , 4 , 5 , 6 , 7 , 8 , 9 , 10 , 11 , 12 ,\r\n    13 , 14 , 15 , 16 , 17 , 18 , 18.3 , 18.6 , 18.9 , 19.2 , 19.5 , 19.8 , 20.1 , 20.4 , 20.7 ,\r\n    21.0 , 21.3 , 21.6 , 21.9 , 22.2 , 22.5 , 22.8 , 23.1 , 23.4 , 23.7 , 24.0 , 24.3 , 24.6 ,\r\n    24.9 , 25.2 , 25.5 , 25.8 , 26.1 , 26.3 , 26.4 , 26.5 , 26.6 , 26.7 , 26.8 , 26.9 , 27 ,\r\n  ];\r\n  private readonly _incrementalCurve: number[];\r\n  private readonly _positions = [\r\n    { x: 0.80, y: 0.10 },\r\n    { x: 0.60, y: 0.20 },\r\n    { x: 0.35, y: 0.25 },\r\n    { x: 0.25, y: 0.60 },\r\n    { x: 0.20, y: 0.90 },\r\n    { x: 0.40, y: 0.80 },\r\n    { x: 0.65, y: 0.75 },\r\n    { x: 0.75, y: 0.40 }\r\n  ];\r\n  private readonly _phases = this._positions.length;\r\n  private _onWheelRAF: number;\r\n  private _scrollDelta: number;\r\n\r\n  // private _ts = 0;\r\n  // private _fps = 15;\r\n  // private _frametime = 1000 / this._fps;\r\n  // private _raf: number;\r\n\r\n  private _canvas: HTMLCanvasElement;\r\n  private _ctx: CanvasRenderingContext2D;\r\n  private _hc: HTMLCanvasElement;\r\n  private _hctx: CanvasRenderingContext2D;\r\n\r\n  private _addedScrollListener: boolean;\r\n  private _animatingToNextPosition: boolean;\r\n\r\n  constructor() {\r\n    const diff = this._tails / this._curve[this._curve.length - 1];\r\n\r\n    for(let i = 0, length = this._curve.length; i < length; ++i) {\r\n      this._curve[i] = this._curve[i] * diff;\r\n    }\r\n\r\n    this._incrementalCurve = this._curve.map((v, i, arr) => {\r\n      return v - (arr[i - 1] ?? 0);\r\n    });\r\n  }\r\n\r\n  private hexToRgb(hex: string) {\r\n    const result = hexToRgb(hex);\r\n    return {r: result[0], g: result[1], b: result[2]};\r\n  }\r\n\r\n  private getPositions(shift: number) {\r\n    const positions = this._positions.slice();\r\n    while(shift > 0) {\r\n      positions.push(positions.shift());\r\n      --shift;\r\n    }\r\n\r\n    const result: typeof positions = [];\r\n    for(let i = 0; i < positions.length; i += 2) {\r\n      result.push(positions[i]);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  private getNextPositions(phase: number, curveMax: number, curve: number[]) {\r\n    const pos = this.getPositions(phase);\r\n    if(!curve[0] && curve.length === 1) {\r\n      return [pos];\r\n    }\r\n    \r\n    const nextPos = this.getPositions(++phase % this._phases);\r\n    const distances = nextPos.map((nextPos, idx) => {\r\n      return {\r\n        x: (nextPos.x - pos[idx].x) / curveMax,\r\n        y: (nextPos.y - pos[idx].y) / curveMax,\r\n      };\r\n    });\r\n\r\n    const positions = curve.map((value) => {\r\n      return distances.map((distance, idx) => {\r\n        return {\r\n          x: pos[idx].x + distance.x * value,\r\n          y: pos[idx].y + distance.y * value\r\n        };\r\n      });\r\n    });\r\n\r\n    return positions;\r\n  }\r\n \r\n  private curPosition(phase: number, tail: number) {\r\n    const positions = this.getNextPositions(phase, this._tails, [tail]);\r\n    return positions[0];\r\n  }\r\n\r\n  private changeTail(diff: number) {\r\n    this._tail += diff;\r\n\r\n    while(this._tail >= this._tails) {\r\n      this._tail -= this._tails;\r\n      if(++this._phase >= this._phases) {\r\n        this._phase -= this._phases;\r\n      }\r\n    }\r\n\r\n    while(this._tail < 0) {\r\n      this._tail += this._tails;\r\n      if(--this._phase < 0) {\r\n        this._phase += this._phases;\r\n      }\r\n    }\r\n  }\r\n  \r\n  private onWheel = (e: {deltaY: number}) => {\r\n    if(this._animatingToNextPosition) {\r\n      return;\r\n    }\r\n\r\n    this._scrollDelta += e.deltaY;\r\n    if(this._onWheelRAF === undefined) {\r\n      this._onWheelRAF = requestAnimationFrame(this.drawOnWheel);\r\n    }\r\n  };\r\n\r\n  private drawOnWheel = () => {\r\n    let diff = this._scrollDelta / this._scrollTails;\r\n    this._scrollDelta %= this._scrollTails;\r\n    diff = diff > 0 ? Math.floor(diff) : Math.ceil(diff);\r\n    if(diff) {\r\n      this.changeTail(diff);\r\n      const curPos = this.curPosition(this._phase, this._tail);\r\n      this.drawGradient(curPos);\r\n    }\r\n    this._onWheelRAF = undefined;\r\n  };\r\n\r\n  private drawNextPositionAnimated = () => {\r\n    const frames = this._frames;\r\n    const id = frames.shift();\r\n    if(id) {\r\n      this.drawImageData(id);\r\n    }\r\n    \r\n    const leftLength = frames.length;\r\n    if(!leftLength) {\r\n      this._animatingToNextPosition = undefined;\r\n    }\r\n\r\n    return !!leftLength;\r\n  };\r\n\r\n  private getGradientImageData(positions: {x: number, y: number}[]) {\r\n    const id = this._hctx.createImageData(this._width, this._height);\r\n    const pixels = id.data;\r\n\r\n    let offset = 0;\r\n    for(let y = 0; y < this._height; ++y) {\r\n      const directPixelY = y / this._height;\r\n      const centerDistanceY = directPixelY - 0.5;\r\n      const centerDistanceY2 = centerDistanceY * centerDistanceY;\r\n\r\n      for(let x = 0; x < this._width; ++x) {\r\n        const directPixelX = x / this._width;\r\n\r\n        const centerDistanceX = directPixelX - 0.5;\r\n        const centerDistance = Math.sqrt(centerDistanceX * centerDistanceX + centerDistanceY2);\r\n\r\n        const swirlFactor = 0.35 * centerDistance;\r\n        const theta = swirlFactor * swirlFactor * 0.8 * 8.0;\r\n        const sinTheta = Math.sin(theta);\r\n        const cosTheta = Math.cos(theta);\r\n\r\n        const pixelX = Math.max(0.0, Math.min(1.0, 0.5 + centerDistanceX * cosTheta - centerDistanceY * sinTheta));\r\n        const pixelY = Math.max(0.0, Math.min(1.0, 0.5 + centerDistanceX * sinTheta + centerDistanceY * cosTheta));\r\n\r\n        let distanceSum = 0.0;\r\n\r\n        let r = 0.0;\r\n        let g = 0.0;\r\n        let b = 0.0;\r\n\r\n        for(let i = 0; i < this._colors.length; i++) {\r\n          const colorX = positions[i].x;\r\n          const colorY = positions[i].y;\r\n\r\n          const distanceX = pixelX - colorX;\r\n          const distanceY = pixelY - colorY;\r\n\r\n          let distance = Math.max(0.0, 0.9 - Math.sqrt(distanceX * distanceX + distanceY * distanceY));\r\n          distance = distance * distance * distance * distance;\r\n          distanceSum += distance;\r\n\r\n          r += distance * this._colors[i].r / 255;\r\n          g += distance * this._colors[i].g / 255;\r\n          b += distance * this._colors[i].b / 255;\r\n        }\r\n\r\n        pixels[offset++] = r / distanceSum * 255.0;\r\n        pixels[offset++] = g / distanceSum * 255.0;\r\n        pixels[offset++] = b / distanceSum * 255.0;\r\n        pixels[offset++] = 0xFF;\r\n      }\r\n    }\r\n    return id;\r\n  }\r\n\r\n  private drawImageData(id: ImageData) {\r\n    this._hctx.putImageData(id, 0, 0);\r\n    this._ctx.drawImage(this._hc, 0, 0, this._width, this._height);\r\n  }\r\n\r\n  private drawGradient(positions: {x: number, y: number}[]) {\r\n    this.drawImageData(this.getGradientImageData(positions));\r\n  }\r\n\r\n  // private doAnimate = () => {\r\n  //   const now = +Date.now();\r\n  //   if(!document.hasFocus() || (now - this._ts) < this._frametime) {\r\n  //     this._raf = requestAnimationFrame(this.doAnimate);\r\n  //     return;\r\n  //   }\r\n\r\n  //   this._ts = now;\r\n  //   this.changeTail(1);\r\n  //   const cur_pos = this.curPosition(this._phase, this._tail);\r\n  //   this.drawGradient(cur_pos);\r\n  //   this._raf = requestAnimationFrame(this.doAnimate);\r\n  // };\r\n\r\n  // public animate(start?: boolean) {\r\n  //   if(!start) {\r\n  //     cancelAnimationFrame(this._raf);\r\n  //     return;\r\n  //   }\r\n  //   this.doAnimate();\r\n  // }\r\n\r\n  public init(el: HTMLCanvasElement) {\r\n    this._frames = [];\r\n    this._phase = 0;\r\n    this._tail = 0;\r\n    this._scrollDelta = 0;\r\n    if(this._onWheelRAF !== undefined) {\r\n      cancelAnimationFrame(this._onWheelRAF);\r\n      this._onWheelRAF = undefined;\r\n    }\r\n\r\n    const colors = el.getAttribute('data-colors').split(',').reverse();\r\n    this._colors = colors.map((color) => {\r\n      return this.hexToRgb(color);\r\n    });\r\n\r\n    if(!this._hc) {\r\n      this._hc = document.createElement('canvas');\r\n      this._hc.width = this._width;\r\n      this._hc.height = this._height;\r\n      this._hctx = this._hc.getContext('2d', {alpha: false});\r\n    }\r\n\r\n    this._canvas = el;\r\n    this._ctx = this._canvas.getContext('2d', {alpha: false});\r\n    this.update();\r\n  }\r\n\r\n  public update() {\r\n    if(this._colors.length < 2) {\r\n      const color = this._colors[0];\r\n      this._ctx.fillStyle = `rgb(${color.r}, ${color.g}, ${color.b})`;\r\n      this._ctx.fillRect(0, 0, this._width, this._height);\r\n      return;\r\n    }\r\n    \r\n    const pos = this.curPosition(this._phase, this._tail);\r\n    this.drawGradient(pos);\r\n  }\r\n\r\n  public toNextPosition() {\r\n    if(this._colors.length < 2) {\r\n      return;\r\n    }\r\n\r\n    const tail = this._tail;\r\n    const tails = this._tails;\r\n\r\n    let nextPhaseOnIdx: number;\r\n\r\n    const curve: number[] = [];\r\n    for(let i = 0, length = this._incrementalCurve.length; i < length; ++i) {\r\n      const inc = this._incrementalCurve[i];\r\n      let value = (curve[i - 1] ?? tail) + inc;\r\n\r\n      if(+value.toFixed(2) > tails && nextPhaseOnIdx === undefined) {\r\n        nextPhaseOnIdx = i;\r\n        value %= tails;\r\n      }\r\n      \r\n      curve.push(value);\r\n    }\r\n\r\n    const currentPhaseCurve = curve.slice(0, nextPhaseOnIdx);\r\n    const nextPhaseCurve = nextPhaseOnIdx !== undefined ? curve.slice(nextPhaseOnIdx) : [];\r\n\r\n    [currentPhaseCurve, nextPhaseCurve].forEach((curve, idx, curves) => {\r\n      const last = curve[curve.length - 1];\r\n      if(last !== undefined && last > tails) {\r\n        curve[curve.length - 1] = +last.toFixed(2);\r\n      }\r\n      \r\n      this._tail = last ?? 0;\r\n\r\n      if(!curve.length) {\r\n        return;\r\n      }\r\n\r\n      const positions = this.getNextPositions(this._phase, tails, curve);\r\n      if(idx !== (curves.length - 1)) {\r\n        if(++this._phase >= this._phases) {\r\n          this._phase -= this._phases;\r\n        }\r\n      }\r\n\r\n      const ids = positions.map((pos) => {\r\n        return this.getGradientImageData(pos);\r\n      });\r\n  \r\n      this._frames.push(...ids);\r\n    });\r\n\r\n    this._animatingToNextPosition = true;\r\n    animate(this.drawNextPositionAnimated);\r\n  }\r\n\r\n  public scrollAnimate(start?: boolean) {\r\n    if(this._colors.length < 2 && start) {\r\n      return;\r\n    }\r\n\r\n    if(start && !this._addedScrollListener) {\r\n      document.addEventListener('wheel', this.onWheel);\r\n      this._addedScrollListener = true;\r\n    } else if(!start && this._addedScrollListener) {\r\n      document.removeEventListener('wheel', this.onWheel);\r\n      this._addedScrollListener = false;\r\n    }\r\n  }\r\n\r\n  public cleanup() {\r\n    this.scrollAnimate(false);\r\n    // this.animate(false);\r\n  }\r\n\r\n  public static createCanvas(colors?: string) {\r\n    const canvas = document.createElement('canvas');\r\n    canvas.width = WIDTH;\r\n    canvas.height = HEIGHT;\r\n    if(colors !== undefined) {\r\n      canvas.dataset.colors = colors;\r\n    }\r\n\r\n    return canvas;\r\n  }\r\n\r\n  public static create(colors?: string) {\r\n    const canvas = this.createCanvas(colors);\r\n    const gradientRenderer = new ChatBackgroundGradientRenderer();\r\n    gradientRenderer.init(canvas);\r\n\r\n    return {gradientRenderer, canvas};\r\n  }\r\n}\r\n","import { ColorHsla, ColorRgba, hexaToHsla, hslaToRgba, rgbaToHexa as rgbaToHexa, rgbaToHsla } from \"../helpers/color\";\r\nimport attachGrabListeners from \"../helpers/dom/attachGrabListeners\";\r\nimport clamp from \"../helpers/number/clamp\";\r\nimport InputField, { InputState } from \"./inputField\";\r\n\r\nexport type ColorPickerColor = { \r\n  hsl: string; \r\n  rgb: string; \r\n  hex: string; \r\n  hsla: string; \r\n  rgba: string; \r\n  hexa: string; \r\n  rgbaArray: ColorRgba; \r\n};\r\n\r\nexport default class ColorPicker {\r\n  private static BASE_CLASS = 'color-picker';\r\n  public container: HTMLElement;\r\n\r\n  private boxRect: DOMRect;\r\n  //private boxDraggerRect: DOMRect;\r\n  private hueRect: DOMRect;\r\n  //private hueDraggerRect: DOMRect;\r\n\r\n\tprivate hue = 0;\r\n\tprivate saturation = 100;\r\n\tprivate lightness = 50;\r\n\tprivate alpha = 1;\r\n  private elements: {\r\n    box: SVGSVGElement,\r\n    boxDragger: SVGSVGElement,\r\n    sliders: HTMLElement,\r\n    hue: SVGSVGElement,\r\n    hueDragger: SVGSVGElement,\r\n    saturation: SVGLinearGradientElement,\r\n  } = {} as any;\r\n  private hexInputField: InputField;\r\n  private rgbInputField: InputField;\r\n  public onChange: (color: ReturnType<ColorPicker['getCurrentColor']>) => void;\r\n\r\n  constructor() {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add(ColorPicker.BASE_CLASS);\r\n\r\n    const html = `\r\n      <svg class=\"${ColorPicker.BASE_CLASS + '-box'}\" viewBox=\"0 0 380 198\">\r\n        <defs>\r\n          <linearGradient id=\"color-picker-saturation\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\r\n            <stop offset=\"0%\" stop-color=\"#fff\"></stop>\r\n            <stop offset=\"100%\" stop-color=\"hsl(0,100%,50%)\"></stop>\r\n          </linearGradient>\r\n          <linearGradient id=\"color-picker-brightness\" x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\r\n            <stop offset=\"0%\" stop-color=\"rgba(0,0,0,0)\"></stop>\r\n            <stop offset=\"100%\" stop-color=\"#000\"></stop>\r\n          </linearGradient>\r\n          <pattern id=\"color-picker-pattern\" width=\"100%\" height=\"100%\">\r\n            <rect x=\"0\" y=\"0\" width=\"100%\" height=\"100%\" fill=\"url(#color-picker-saturation)\"></rect>\r\n            <rect x=\"0\" y=\"0\" width=\"100%\" height=\"100%\" fill=\"url(#color-picker-brightness)\"></rect>\r\n          </pattern>\r\n        </defs>\r\n        <rect rx=\"10\" ry=\"10\" x=\"0\" y=\"0\" width=\"380\" height=\"198\" fill=\"url(#color-picker-pattern)\"></rect>\r\n        <svg class=\"${ColorPicker.BASE_CLASS + '-dragger'} ${ColorPicker.BASE_CLASS + '-box-dragger'}\" x=\"0\" y=\"0\">\r\n          <circle r=\"11\" fill=\"inherit\" stroke=\"#fff\" stroke-width=\"2\"></circle>\r\n        </svg>\r\n      </svg>\r\n      <div class=\"${ColorPicker.BASE_CLASS + '-sliders'}\">\r\n        <svg class=\"${ColorPicker.BASE_CLASS + '-color-slider'}\" viewBox=\"0 0 380 24\">\r\n          <defs>\r\n            <linearGradient id=\"hue\" x1=\"100%\" y1=\"0%\" x2=\"0%\" y2=\"0%\">\r\n              <stop offset=\"0%\" stop-color=\"#f00\"></stop>\r\n              <stop offset=\"16.666%\" stop-color=\"#f0f\"></stop>\r\n              <stop offset=\"33.333%\" stop-color=\"#00f\"></stop>\r\n              <stop offset=\"50%\" stop-color=\"#0ff\"></stop>\r\n              <stop offset=\"66.666%\" stop-color=\"#0f0\"></stop>\r\n              <stop offset=\"83.333%\" stop-color=\"#ff0\"></stop>\r\n              <stop offset=\"100%\" stop-color=\"#f00\"></stop>\r\n            </linearGradient>\r\n          </defs>\r\n          <rect rx=\"4\" ry=\"4\" x=\"0\" y=\"9\" width=\"380\" height=\"8\" fill=\"url(#hue)\"></rect>\r\n          <svg class=\"${ColorPicker.BASE_CLASS + '-dragger'} ${ColorPicker.BASE_CLASS + '-color-slider-dragger'}\" x=\"0\" y=\"13\">\r\n            <circle r=\"11\" fill=\"inherit\" stroke=\"#fff\" stroke-width=\"2\"></circle>\r\n          </svg>\r\n        </svg>\r\n      </div>\r\n    `;\r\n\r\n    this.container.innerHTML = html;\r\n\r\n    this.elements.box = this.container.firstElementChild as any;\r\n    this.elements.boxDragger = this.elements.box.lastElementChild as any;\r\n    this.elements.saturation = this.elements.box.firstElementChild.firstElementChild as any;\r\n\r\n    this.elements.sliders = this.elements.box.nextElementSibling as any;\r\n\r\n    this.elements.hue = this.elements.sliders.firstElementChild as any;\r\n    this.elements.hueDragger = this.elements.hue.lastElementChild as any;\r\n\r\n    this.hexInputField = new InputField({plainText: true, label: 'Appearance.Color.Hex'});\r\n    this.rgbInputField = new InputField({plainText: true, label: 'Appearance.Color.RGB'});\r\n\r\n    const inputs = document.createElement('div');\r\n    inputs.className = ColorPicker.BASE_CLASS + '-inputs';\r\n    inputs.append(this.hexInputField.container, this.rgbInputField.container);\r\n    this.container.append(inputs);\r\n\r\n    this.hexInputField.input.addEventListener('input', () => {\r\n      let value = this.hexInputField.value.replace(/#/g, '').slice(0, 6);\r\n\r\n      const match = value.match(/([a-fA-F\\d]+)/);\r\n      const valid = match && match[0].length === value.length && [/* 3, 4,  */6].includes(value.length);\r\n      this.hexInputField.setState(valid ? InputState.Neutral : InputState.Error);\r\n\r\n      value = '#' + value;\r\n      this.hexInputField.setValueSilently(value);\r\n      \r\n      if(valid) {\r\n        this.setColor(value, false, true);\r\n      }\r\n    });\r\n\r\n    // patched https://stackoverflow.com/a/34029238/6758968\r\n    const rgbRegExp = /^(?:rgb)?\\(?([01]?\\d\\d?|2[0-4]\\d|25[0-5])(?:\\W+)([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\W+(?:([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\)?)$/;\r\n    this.rgbInputField.input.addEventListener('input', () => {\r\n      const match = this.rgbInputField.value.match(rgbRegExp);\r\n      this.rgbInputField.setState(match ? InputState.Neutral : InputState.Error);\r\n\r\n      if(match) {\r\n        this.setColor(rgbaToHsla(+match[1], +match[2], +match[3]), true, false);\r\n      }\r\n    });\r\n\r\n    this.attachBoxListeners();\r\n    this.attachHueListeners();\r\n  }\r\n\r\n  private onGrabStart = () => {\r\n    document.documentElement.style.cursor = this.elements.boxDragger.style.cursor = 'grabbing';\r\n  };\r\n\r\n  private onGrabEnd = () => {\r\n    document.documentElement.style.cursor = this.elements.boxDragger.style.cursor = '';\r\n  };\r\n\r\n  private attachBoxListeners() {\r\n    attachGrabListeners(this.elements.box as any, () => {\r\n      this.onGrabStart();\r\n      this.boxRect = this.elements.box.getBoundingClientRect();\r\n      //this.boxDraggerRect = this.elements.boxDragger.getBoundingClientRect();\r\n    }, (pos) => {\r\n      this.saturationHandler(pos.x, pos.y);\r\n    }, () => {\r\n      this.onGrabEnd();\r\n    });\r\n  }\r\n\r\n  private attachHueListeners() {\r\n    attachGrabListeners(this.elements.hue as any, () => {\r\n      this.onGrabStart();\r\n      this.hueRect = this.elements.hue.getBoundingClientRect();\r\n      //this.hueDraggerRect = this.elements.hueDragger.getBoundingClientRect();\r\n    }, (pos) => {\r\n      this.hueHandler(pos.x);\r\n    }, () => {\r\n      this.onGrabEnd();\r\n    });\r\n  }\r\n\r\n  public setColor(color: ColorHsla | string, updateHexInput = true, updateRgbInput = true) {\r\n    if(color === undefined) { // * set to red\r\n      color = {\r\n        h: 0,\r\n        s: 100,\r\n        l: 50,\r\n        a: 1\r\n      };\r\n    } else if(typeof(color) === 'string') {\r\n      if(color[0] === '#') {\r\n        color = hexaToHsla(color);\r\n      } else {\r\n        const rgb = color.match(/[.?\\d]+/g);\r\n        color = rgbaToHsla(+rgb[0], +rgb[1], +rgb[2], rgb[3] === undefined ? 1 : +rgb[3]);\r\n      }\r\n    }\r\n\r\n    // Set box\r\n    this.boxRect = this.elements.box.getBoundingClientRect();\r\n\r\n    const boxX = this.boxRect.width / 100 * color.s;\r\n    const percentY = 100 - (color.l / (100 - color.s / 2)) * 100;\r\n    const boxY = this.boxRect.height / 100 * percentY;\r\n\r\n    this.saturationHandler(this.boxRect.left + boxX, this.boxRect.top + boxY, false);\r\n\r\n    // Set hue\r\n    this.hueRect = this.elements.hue.getBoundingClientRect();\r\n\r\n    const percentHue = color.h / 360;\r\n    const hueX = this.hueRect.left + this.hueRect.width * percentHue;\r\n\r\n    this.hueHandler(hueX, false);\r\n\r\n    // Set values\r\n    this.hue = color.h;\r\n    this.saturation = color.s;\r\n    this.lightness = color.l;\r\n    this.alpha = color.a;\r\n\r\n    this.updatePicker(updateHexInput, updateRgbInput);\r\n  };\r\n\r\n  public getCurrentColor(): ColorPickerColor {\r\n    const rgbaArray = hslaToRgba(this.hue, this.saturation, this.lightness, this.alpha);\r\n    const hexa = rgbaToHexa(rgbaArray);\r\n    const hex = hexa.slice(0, -2);\r\n\r\n    return {\r\n      hsl: `hsl(${this.hue}, ${this.saturation}%, ${this.lightness}%)`,\r\n      rgb: `rgb(${rgbaArray[0]}, ${rgbaArray[1]}, ${rgbaArray[2]})`,\r\n      hex: hex,\r\n      hsla: `hsla(${this.hue}, ${this.saturation}%, ${this.lightness}%, ${this.alpha})`,\r\n      rgba: `rgba(${rgbaArray[0]}, ${rgbaArray[1]}, ${rgbaArray[2]}, ${rgbaArray[3]})`,\r\n      hexa: hexa,\r\n      rgbaArray: rgbaArray\r\n    };\r\n  }\r\n\r\n  public updatePicker(updateHexInput = true, updateRgbInput = true) {\r\n    const color = this.getCurrentColor();\r\n    this.elements.boxDragger.setAttributeNS(null, 'fill', color.hex);\r\n\r\n    if(updateHexInput) {\r\n      this.hexInputField.setValueSilently(color.hex);\r\n      this.hexInputField.setState(InputState.Neutral);\r\n    }\r\n\r\n    if(updateRgbInput) {\r\n      this.rgbInputField.setValueSilently(color.rgbaArray.slice(0, -1).join(', '));\r\n      this.rgbInputField.setState(InputState.Neutral);\r\n    }\r\n\r\n    if(this.onChange) {\r\n      this.onChange(color);\r\n    }\r\n  }\r\n\r\n  private hueHandler(pageX: number, update = true) {\r\n    const eventX = clamp(pageX - this.hueRect.left, 0, this.hueRect.width);\r\n\r\n    const percents = eventX / this.hueRect.width;\r\n    this.hue = Math.round(360 * percents);\r\n    \r\n    const hsla = `hsla(${this.hue}, 100%, 50%, ${this.alpha})`;\r\n\r\n    this.elements.hueDragger.setAttributeNS(null, 'x', (percents * 100) + '%');\r\n    this.elements.hueDragger.setAttributeNS(null, 'fill', hsla);\r\n    \r\n    this.elements.saturation.lastElementChild.setAttributeNS(null, 'stop-color', hsla);\r\n\r\n    if(update) {\r\n      this.updatePicker();\r\n    }\r\n  }\r\n\r\n  private saturationHandler(pageX: number, pageY: number, update = true) {\r\n    const maxX = this.boxRect.width;\r\n    const maxY = this.boxRect.height;\r\n\r\n    const eventX = clamp(pageX - this.boxRect.left, 0, maxX);\r\n    const eventY = clamp(pageY - this.boxRect.top, 0, maxY);\r\n\r\n    const posX = eventX / maxX * 100;\r\n    const posY = eventY / maxY * 100;\r\n    \r\n    const boxDragger = this.elements.boxDragger;\r\n    boxDragger.setAttributeNS(null, 'x', posX + '%');\r\n    boxDragger.setAttributeNS(null, 'y', posY + '%');\r\n\r\n    const saturation = clamp(posX, 0, 100);\r\n\r\n    const lightnessX = 100 - saturation / 2;\r\n    const lightnessY = 100 - clamp(posY, 0, 100);\r\n\r\n    const lightness = clamp(lightnessY / 100 * lightnessX, 0, 100);\r\n\r\n    this.saturation = saturation;\r\n    this.lightness = lightness;\r\n\r\n    if(update) {\r\n      this.updatePicker();\r\n    }\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"..\";\r\nimport { Theme } from \"../../../config/state\";\r\nimport { hexaToRgba } from \"../../../helpers/color\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport highlightningColor from \"../../../helpers/highlightningColor\";\r\nimport throttle from \"../../../helpers/schedulers/throttle\";\r\nimport themeController from \"../../../helpers/themeController\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport ColorPicker, { ColorPickerColor } from \"../../colorPicker\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\n\r\nexport default class AppBackgroundColorTab extends SliderSuperTab {\r\n  private colorPicker: ColorPicker;\r\n  private grid: HTMLElement;\r\n  private applyColor: (hex: string, updateColorPicker?: boolean) => void;\r\n  private theme: Theme;\r\n\r\n  init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('background-container', 'background-color-container');\r\n    this.setTitle('SetColor');\r\n\r\n    this.theme = themeController.getTheme();\r\n\r\n    const section = new SettingSection({});\r\n    this.colorPicker = new ColorPicker();\r\n\r\n    section.content.append(this.colorPicker.container);\r\n\r\n    this.scrollable.append(section.container);\r\n\r\n    const gridSection = new SettingSection({});\r\n\r\n    const grid = this.grid = document.createElement('div');\r\n    grid.classList.add('grid');\r\n\r\n    const colors = [\r\n      '#E6EBEE',\r\n      '#B2CEE1',\r\n      '#008DD0',\r\n      '#C6E7CB',\r\n      '#C4E1A6',\r\n      '#60B16E',\r\n      '#CCD0AF',\r\n      '#A6A997',\r\n      '#7A7072',\r\n      '#FDD7AF',\r\n      '#FDB76E',\r\n      '#DD8851'\r\n    ];\r\n\r\n    colors.forEach((color) => {\r\n      const item = document.createElement('div');\r\n      item.classList.add('grid-item');\r\n      item.dataset.color = color.toLowerCase();\r\n\r\n      // * need for transform scale\r\n      const media = document.createElement('div');\r\n      media.classList.add('grid-item-media');\r\n      media.style.backgroundColor = color;\r\n\r\n      item.append(media);\r\n      grid.append(item);\r\n    });\r\n\r\n    attachClickEvent(grid, (e) => {\r\n      const target = findUpClassName(e.target, 'grid-item');\r\n      if(!target || target.classList.contains('active')) {\r\n        return;\r\n      }\r\n\r\n      const color = target.dataset.color;\r\n      if(!color) {\r\n        return;\r\n      }\r\n\r\n      this.applyColor(color);\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    gridSection.content.append(grid);\r\n    this.scrollable.append(gridSection.container);\r\n\r\n    this.applyColor = throttle(this._applyColor, 16, true);\r\n  }\r\n\r\n  private setActive() {\r\n    const active = this.grid.querySelector('.active');\r\n    const background = this.theme.background;\r\n    const target = background.color ? this.grid.querySelector(`.grid-item[data-color=\"${background.color}\"]`) : null;\r\n    if(active === target) {\r\n      return;\r\n    }\r\n\r\n    if(active) {\r\n      active.classList.remove('active');\r\n    }\r\n\r\n    if(target) {\r\n      target.classList.add('active');\r\n    }\r\n  }\r\n\r\n  private _applyColor = (hex: string, updateColorPicker = true) => {\r\n    if(updateColorPicker) {\r\n      this.colorPicker.setColor(hex);\r\n    } else {\r\n      const rgba = hexaToRgba(hex);\r\n      const background = this.theme.background;\r\n      const hsla = highlightningColor(rgba);\r\n    \r\n      background.id = '2';\r\n      background.intensity = 0;\r\n      background.slug = '';\r\n      background.color = hex.toLowerCase();\r\n      background.highlightningColor = hsla;\r\n      this.managers.appStateManager.pushToState('settings', rootScope.settings);\r\n    \r\n      appImManager.applyCurrentTheme(undefined, undefined, true);\r\n      this.setActive();\r\n    }\r\n  };\r\n\r\n  private onColorChange = (color: ColorPickerColor) => {\r\n    this.applyColor(color.hex, false);\r\n  };\r\n\r\n  onOpen() {\r\n    setTimeout(() => {\r\n      const background = this.theme.background;\r\n\r\n      const color = (background.color || '').split(',')[0];\r\n      const isColored = !!color && !background.slug;\r\n      \r\n      // * set active if type is color\r\n      if(isColored) {\r\n        this.colorPicker.onChange = this.onColorChange;\r\n      }\r\n\r\n      this.colorPicker.setColor(color || '#cccccc');\r\n      \r\n      if(!isColored) {\r\n        this.colorPicker.onChange = this.onColorChange;\r\n      }\r\n    }, 0);\r\n  }\r\n\r\n  onCloseAfterTimeout() {\r\n    this.colorPicker.onChange = undefined;\r\n    this.colorPicker = undefined;\r\n\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n","import type { MediaSize } from \"../mediaSize\";\r\n\r\nexport default function scaleMediaElement(options: {\r\n  media: CanvasImageSource, \r\n  mediaSize?: MediaSize, \r\n  boxSize?: MediaSize, \r\n  quality?: number,\r\n  mimeType?: 'image/jpeg' | 'image/png',\r\n  size?: MediaSize\r\n}): Promise<{blob: Blob, size: MediaSize}> {\r\n  return new Promise((resolve) => {\r\n    const canvas = document.createElement('canvas');\r\n    const size = options.size ?? options.mediaSize.aspectFitted(options.boxSize);\r\n    canvas.width = size.width * window.devicePixelRatio;\r\n    canvas.height = size.height * window.devicePixelRatio;\r\n    const ctx = canvas.getContext('2d');\r\n    ctx.drawImage(options.media, 0, 0, canvas.width, canvas.height);\r\n    canvas.toBlob((blob) => {\r\n      resolve({blob, size});\r\n    }, options.mimeType ?? 'image/jpeg', options.quality ?? 1);\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { generateSection } from \"..\";\r\nimport { averageColor, averageColorFromCanvas } from \"../../../helpers/averageColor\";\r\nimport blur from \"../../../helpers/blur\";\r\nimport deferredPromise, { CancellablePromise } from \"../../../helpers/cancellablePromise\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport highlightningColor from \"../../../helpers/highlightningColor\";\r\nimport copy from \"../../../helpers/object/copy\";\r\nimport sequentialDom from \"../../../helpers/sequentialDom\";\r\nimport ChatBackgroundGradientRenderer from \"../../chat/gradientRenderer\";\r\nimport { Document, PhotoSize, WallPaper } from \"../../../layer\";\r\nimport { MyDocument } from \"../../../lib/appManagers/appDocsManager\";\r\nimport appDownloadManager, { AppDownloadManager, DownloadBlob } from \"../../../lib/appManagers/appDownloadManager\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport Button from \"../../button\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport ProgressivePreloader from \"../../preloader\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport { wrapPhoto } from \"../../wrappers\";\r\nimport AppBackgroundColorTab from \"./backgroundColor\";\r\nimport choosePhotoSize from \"../../../lib/appManagers/utils/photos/choosePhotoSize\";\r\nimport { STATE_INIT, Theme } from \"../../../config/state\";\r\nimport themeController from \"../../../helpers/themeController\";\r\nimport requestFile from \"../../../helpers/files/requestFile\";\r\nimport { renderImageFromUrlPromise } from \"../../../helpers/dom/renderImageFromUrl\";\r\nimport scaleMediaElement from \"../../../helpers/canvas/scaleMediaElement\";\r\nimport { MediaSize } from \"../../../helpers/mediaSize\";\r\n\r\nexport default class AppBackgroundTab extends SliderSuperTab {\r\n  private grid: HTMLElement;\r\n  private tempId = 0;\r\n  private clicked: Set<DocId> = new Set();\r\n  private blurCheckboxField: CheckboxField;\r\n\r\n  private wallPapersByElement: Map<HTMLElement, WallPaper> = new Map();\r\n  private elementsByKey: Map<string, HTMLElement> = new Map();\r\n\r\n  private get theme() {\r\n    return themeController.getTheme();\r\n  }\r\n\r\n  init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('background-container', 'background-image-container');\r\n    this.setTitle('ChatBackground');\r\n\r\n    {\r\n      const container = generateSection(this.scrollable);\r\n\r\n      const uploadButton = Button('btn-primary btn-transparent', {icon: 'cameraadd', text: 'ChatBackground.UploadWallpaper'});\r\n      const colorButton = Button('btn-primary btn-transparent', {icon: 'colorize', text: 'SetColor'});\r\n      const resetButton = Button('btn-primary btn-transparent', {icon: 'favourites', text: 'Appearance.Reset'});\r\n\r\n      attachClickEvent(uploadButton, this.onUploadClick, {listenerSetter: this.listenerSetter});\r\n\r\n      attachClickEvent(colorButton, () => {\r\n        this.slider.createTab(AppBackgroundColorTab).open();\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      attachClickEvent(resetButton, this.onResetClick, {listenerSetter: this.listenerSetter});\r\n\r\n      const blurCheckboxField = this.blurCheckboxField = new CheckboxField({\r\n        text: 'ChatBackground.Blur', \r\n        name: 'blur', \r\n        checked: this.theme.background.blur,\r\n        withRipple: true\r\n      });\r\n\r\n      this.listenerSetter.add(blurCheckboxField.input)('change', async() => {\r\n        this.theme.background.blur = blurCheckboxField.input.checked;\r\n        await this.managers.appStateManager.pushToState('settings', rootScope.settings);\r\n\r\n        // * wait for animation end\r\n        setTimeout(() => {\r\n          const active = grid.querySelector('.active') as HTMLElement;\r\n          if(!active) return;\r\n\r\n          const wallpaper = this.wallPapersByElement.get(active);\r\n          if((wallpaper as WallPaper.wallPaper).pFlags.pattern || wallpaper._ === 'wallPaperNoFile') {\r\n            return;\r\n          }\r\n          \r\n          this.setBackgroundDocument(wallpaper);\r\n        }, 100);\r\n      });\r\n\r\n      container.append(uploadButton, colorButton, resetButton, blurCheckboxField.label);\r\n    }\r\n\r\n    rootScope.addEventListener('background_change', this.setActive);\r\n\r\n    this.managers.appDocsManager.getWallPapers().then((wallPapers) => {\r\n      wallPapers.forEach((wallPaper) => {\r\n        this.addWallPaper(wallPaper);\r\n      });\r\n    });\r\n\r\n    const gridContainer = generateSection(this.scrollable);\r\n    const grid = this.grid = document.createElement('div');\r\n    grid.classList.add('grid');\r\n    attachClickEvent(grid, this.onGridClick, {listenerSetter: this.listenerSetter});\r\n    gridContainer.append(grid);\r\n  }\r\n\r\n  private onUploadClick = () => {\r\n    requestFile('image/x-png,image/png,image/jpeg').then(async(file) => {\r\n      if(file.name.endsWith('.png')) {\r\n        const img = document.createElement('img');\r\n        const url = URL.createObjectURL(file);\r\n        await renderImageFromUrlPromise(img, url, false);\r\n        const mimeType = 'image/jpeg';\r\n        const {blob} = await scaleMediaElement({media: img, size: new MediaSize(img.naturalWidth, img.naturalHeight), mimeType});\r\n        file = new File([blob], file.name.replace(/\\.png$/, '.jpg'), {type: mimeType});\r\n      }\r\n\r\n      const wallPaper = await this.managers.appDocsManager.prepareWallPaperUpload(file);\r\n      const uploadPromise = this.managers.appDocsManager.uploadWallPaper(wallPaper.id);\r\n      const uploadDeferred: CancellablePromise<any> = appDownloadManager.getNewDeferredForUpload(file.name, uploadPromise);\r\n\r\n      const deferred = deferredPromise<void>();\r\n      deferred.addNotifyListener = uploadDeferred.addNotifyListener;\r\n      deferred.cancel = uploadDeferred.cancel;\r\n\r\n      uploadDeferred.then((wallPaper) => {\r\n        this.clicked.delete(key);\r\n        this.elementsByKey.delete(key);\r\n        this.wallPapersByElement.set(container, wallPaper);\r\n        const newKey = this.getWallPaperKey(wallPaper);\r\n        this.elementsByKey.set(newKey, container);\r\n\r\n        this.setBackgroundDocument(wallPaper).then(deferred.resolve, deferred.reject);\r\n      }, deferred.reject);\r\n\r\n      const key = this.getWallPaperKey(wallPaper);\r\n      deferred.catch(() => {\r\n        container.remove();\r\n      });\r\n\r\n      const preloader = new ProgressivePreloader({\r\n        isUpload: true,\r\n        cancelable: true,\r\n        tryAgainOnFail: false\r\n      });\r\n\r\n      const container = this.addWallPaper(wallPaper, false);\r\n      this.clicked.add(key);\r\n\r\n      preloader.attach(container, false, deferred);\r\n    });\r\n  };\r\n\r\n  private onResetClick = () => {\r\n    const defaultTheme = STATE_INIT.settings.themes.find((t) => t.name === this.theme.name);\r\n    if(defaultTheme) {\r\n      ++this.tempId;\r\n      this.theme.background = copy(defaultTheme.background);\r\n      this.managers.appStateManager.pushToState('settings', rootScope.settings);\r\n      appImManager.applyCurrentTheme(undefined, undefined, true);\r\n      this.blurCheckboxField.setValueSilently(this.theme.background.blur);\r\n    }\r\n  };\r\n\r\n  private getColorsFromWallPaper(wallPaper: WallPaper) {\r\n    return wallPaper.settings ? [\r\n      wallPaper.settings.background_color,\r\n      wallPaper.settings.second_background_color,\r\n      wallPaper.settings.third_background_color,\r\n      wallPaper.settings.fourth_background_color\r\n    ].filter(Boolean).map((color) => '#' + color.toString(16)).join(',') : '';\r\n  }\r\n\r\n  private getWallPaperKey(wallPaper: WallPaper) {\r\n    return '' + wallPaper.id;\r\n  }\r\n\r\n  private getWallPaperKeyFromTheme(theme: Theme) {\r\n    return '' + theme.background.id;\r\n  }\r\n\r\n  private addWallPaper(wallPaper: WallPaper, append = true) {\r\n    const colors = this.getColorsFromWallPaper(wallPaper);\r\n    const hasFile = wallPaper._ === 'wallPaper';\r\n    if((hasFile && wallPaper.pFlags.pattern && !colors)/*  || \r\n      (wallpaper.document as MyDocument).mime_type.indexOf('application/') === 0 */) {\r\n      return;\r\n    }\r\n\r\n    const isDark = !!wallPaper.pFlags.dark;\r\n\r\n    const doc = hasFile ? wallPaper.document as Document.document : undefined;\r\n\r\n    const container = document.createElement('div');\r\n    container.classList.add('grid-item');\r\n\r\n    container.dataset.id = '' + wallPaper.id;\r\n\r\n    const key = this.getWallPaperKey(wallPaper);\r\n    this.wallPapersByElement.set(container, wallPaper);\r\n    this.elementsByKey.set(key, container);\r\n\r\n    const media = document.createElement('div');\r\n    media.classList.add('grid-item-media');\r\n\r\n    let wrapped: ReturnType<typeof wrapPhoto>, size: PhotoSize;\r\n    if(hasFile) {\r\n      size = choosePhotoSize(doc, 200, 200);\r\n      wrapped = wrapPhoto({\r\n        photo: doc,\r\n        message: null,\r\n        container: media,\r\n        withoutPreloader: true,\r\n        size: size,\r\n        noFadeIn: wallPaper.pFlags.pattern\r\n      });\r\n\r\n      if(wallPaper.pFlags.pattern) {\r\n        media.classList.add('is-pattern');\r\n      }\r\n\r\n      wrapped.then(async({loadPromises, images}) => {\r\n        await loadPromises.thumb || loadPromises.full;\r\n        return images;\r\n      }).then((images) => {\r\n        if(wallPaper.pFlags.pattern) {\r\n          if(isDark) {\r\n            images.full.style.display = 'none';\r\n            if(images.thumb) {\r\n              images.thumb.style.display = 'none';\r\n            }\r\n          } else if(wallPaper.settings?.intensity) {\r\n            images.full.style.opacity = '' + Math.abs(wallPaper.settings.intensity) / 100;\r\n          }\r\n        }\r\n\r\n        sequentialDom.mutate(() => {\r\n          container.append(media);\r\n        });\r\n      });\r\n    } else {\r\n      container.append(media);\r\n    }\r\n\r\n    if(wallPaper.settings && wallPaper.settings.background_color !== undefined) {\r\n      const {canvas} = ChatBackgroundGradientRenderer.create(colors);\r\n      canvas.classList.add('background-colors-canvas');\r\n      \r\n      if(isDark && hasFile) {\r\n        wrapped.then(({loadPromises}) => {\r\n          loadPromises.full.then(async() => {\r\n            const cacheContext = await this.managers.thumbsStorage.getCacheContext(doc, size.type);\r\n            canvas.style.webkitMaskImage = `url(${cacheContext.url})`;\r\n            canvas.style.opacity = '' + Math.abs(wallPaper.settings.intensity) / 100;\r\n            media.append(canvas);\r\n          });\r\n        });\r\n      } else {\r\n        media.append(canvas);\r\n      }\r\n    }\r\n\r\n    if(this.getWallPaperKeyFromTheme(this.theme) === key) {\r\n      container.classList.add('active');\r\n    }\r\n\r\n    this.grid[append ? 'append' : 'prepend'](container);\r\n\r\n    return container;\r\n  }\r\n\r\n  private onGridClick = (e: MouseEvent | TouchEvent) => {\r\n    const target = findUpClassName(e.target, 'grid-item') as HTMLElement;\r\n    if(!target) return;\r\n\r\n    const wallpaper = this.wallPapersByElement.get(target);\r\n    if(wallpaper._ === 'wallPaperNoFile') {\r\n      this.setBackgroundDocument(wallpaper);\r\n      return;\r\n    }\r\n    \r\n    const key = this.getWallPaperKey(wallpaper);\r\n    if(this.clicked.has(key)) return;\r\n    this.clicked.add(key);\r\n    \r\n    const doc = wallpaper.document as MyDocument;\r\n    const preloader = new ProgressivePreloader({\r\n      cancelable: true,\r\n      tryAgainOnFail: false\r\n    });\r\n\r\n    const load = async() => {\r\n      const promise = this.setBackgroundDocument(wallpaper);\r\n      const cacheContext = await this.managers.thumbsStorage.getCacheContext(doc);\r\n      if(!cacheContext.url || this.theme.background.blur) {\r\n        preloader.attach(target, true, promise);\r\n      }\r\n    };\r\n\r\n    preloader.construct();\r\n\r\n    attachClickEvent(target, (e) => {\r\n      if(preloader.preloader.parentElement) {\r\n        preloader.onClick(e);\r\n        preloader.detach();\r\n      } else {\r\n        load();\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    load();\r\n\r\n    //console.log(doc);\r\n  };\r\n\r\n  private saveToCache = (slug: string, url: string) => {\r\n    fetch(url).then((response) => {\r\n      appImManager.cacheStorage.save('backgrounds/' + slug, response);\r\n    });\r\n  };\r\n\r\n  private setBackgroundDocument = (wallPaper: WallPaper) => {\r\n    let _tempId = ++this.tempId;\r\n    const middleware = () => _tempId === this.tempId;\r\n\r\n    const doc = (wallPaper as WallPaper.wallPaper).document as MyDocument;\r\n    const deferred = deferredPromise<void>();\r\n    let download: Promise<void> | ReturnType<AppDownloadManager['downloadMediaURL']>;\r\n    if(doc) {\r\n      download = appDownloadManager.downloadMediaURL({media: doc, queueId: appImManager.chat.bubbles ? appImManager.chat.bubbles.lazyLoadQueue.queueId : 0});\r\n      deferred.addNotifyListener = download.addNotifyListener;\r\n      deferred.cancel = download.cancel;\r\n    } else {\r\n      download = Promise.resolve();\r\n    }\r\n\r\n    download.then(async() => {\r\n      if(!middleware()) {\r\n        deferred.resolve();\r\n        return;\r\n      }\r\n\r\n      const background = this.theme.background;\r\n      const onReady = (url?: string) => {\r\n        //const perf = performance.now();\r\n        let getPixelPromise: Promise<Uint8ClampedArray>;\r\n        if(url && !this.theme.background.color) {\r\n          getPixelPromise = averageColor(url);\r\n        } else {\r\n          const {canvas} = ChatBackgroundGradientRenderer.create(this.getColorsFromWallPaper(wallPaper));\r\n          getPixelPromise = Promise.resolve(averageColorFromCanvas(canvas));\r\n        }\r\n\r\n        getPixelPromise.then((pixel) => {\r\n          if(!middleware()) {\r\n            deferred.resolve();\r\n            return;\r\n          }\r\n          \r\n          const hsla = highlightningColor(Array.from(pixel) as any);\r\n          // const hsla = 'rgba(0, 0, 0, 0.3)';\r\n          //console.log(doc, hsla, performance.now() - perf);\r\n\r\n          const slug = (wallPaper as WallPaper.wallPaper).slug ?? '';\r\n          background.id = wallPaper.id;\r\n          background.intensity = wallPaper.settings?.intensity ?? 0;\r\n          background.color = this.getColorsFromWallPaper(wallPaper);\r\n          background.slug = slug;\r\n          background.highlightningColor = hsla;\r\n          this.managers.appStateManager.pushToState('settings', rootScope.settings);\r\n\r\n          if(slug) {\r\n            this.saveToCache(slug, url);\r\n          }\r\n\r\n          appImManager.applyCurrentTheme(slug, url, true).then(deferred.resolve);\r\n        });\r\n      };\r\n\r\n      if(!doc) {\r\n        onReady();\r\n        return;\r\n      }\r\n\r\n      const cacheContext = await this.managers.thumbsStorage.getCacheContext(doc);\r\n      if(background.blur) {\r\n        setTimeout(() => {\r\n          const {canvas, promise} = blur(cacheContext.url, 12, 4)\r\n          promise.then(() => {\r\n            if(!middleware()) {\r\n              deferred.resolve();\r\n              return;\r\n            }\r\n\r\n            onReady(canvas.toDataURL());\r\n          });\r\n        }, 200);\r\n      } else {\r\n        onReady(cacheContext.url);\r\n      }\r\n    });\r\n\r\n    return deferred;\r\n  };\r\n\r\n  private setActive = () => {\r\n    const active = this.grid.querySelector('.active');\r\n    const target = this.elementsByKey.get(this.getWallPaperKeyFromTheme(this.theme));\r\n    if(active === target) {\r\n      return;\r\n    }\r\n\r\n    if(active) {\r\n      active.classList.remove('active');\r\n    }\r\n\r\n    if(target) {\r\n      target.classList.add('active');\r\n    }\r\n  };\r\n}\r\n","export default function requestFile(accept?: string) {\r\n  const input = document.createElement('input');\r\n  input.type = 'file';\r\n  input.style.display = 'none';\r\n\r\n  if(accept) {\r\n    input.accept = accept;\r\n  }\r\n\r\n  document.body.append(input);\r\n\r\n  const promise = new Promise<File>((resolve, reject) => {\r\n    input.addEventListener('change', (e: any) => {\r\n      const file: File = e.target.files[0];\r\n      if(!file) {\r\n        reject('NO_FILE_SELECTED');\r\n        return;\r\n      }\r\n  \r\n      resolve(file);\r\n    }, {once: true});\r\n  }).finally(() => {\r\n    input.remove();\r\n  });\r\n\r\n  input.click();\r\n\r\n  return promise;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \".\";\r\nimport type { AppStickersManager } from \"../../lib/appManagers/appStickersManager\";\r\nimport { wrapSticker } from \"../wrappers\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport { putPreloader } from \"../putPreloader\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport Button from \"../button\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport toggleDisability from \"../../helpers/dom/toggleDisability\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport { toastNew } from \"../toast\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\n\r\nconst ANIMATION_GROUP = 'STICKERS-POPUP';\r\n\r\nexport default class PopupStickers extends PopupElement {\r\n  private stickersFooter: HTMLElement;\r\n  private stickersDiv: HTMLElement;\r\n\r\n  constructor(private stickerSetInput: Parameters<AppStickersManager['getStickerSet']>[0]) {\r\n    super('popup-stickers', {closable: true, overlayClosable: true, body: true, scrollable: true, title: true});\r\n\r\n    this.title.append(i18n('Loading'));\r\n\r\n    this.addEventListener('close', () => {\r\n      animationIntersector.setOnlyOnePlayableGroup('');\r\n    });\r\n\r\n    const div = document.createElement('div');\r\n    div.classList.add('sticker-set');\r\n\r\n    this.stickersDiv = document.createElement('div');\r\n    this.stickersDiv.classList.add('sticker-set-stickers', 'is-loading');\r\n\r\n    attachClickEvent(this.stickersDiv, this.onStickersClick, {listenerSetter: this.listenerSetter});\r\n\r\n    putPreloader(this.stickersDiv, true);\r\n\r\n    this.stickersFooter = document.createElement('div');\r\n    this.stickersFooter.classList.add('sticker-set-footer');\r\n\r\n    div.append(this.stickersDiv);\r\n\r\n    const btn = Button('btn-primary btn-primary-transparent disable-hover', {noRipple: true, text: 'Loading'});\r\n    this.stickersFooter.append(btn);\r\n\r\n    this.scrollable.append(div);\r\n    this.body.append(this.stickersFooter);\r\n    \r\n    // const editButton = document.createElement('button');\r\n    // editButton.classList.add('btn-primary');\r\n\r\n    // this.stickersFooter.append(editButton);\r\n\r\n    this.loadStickerSet();\r\n  }\r\n\r\n  private onStickersClick = (e: MouseEvent) => {\r\n    const target = findUpClassName(e.target, 'sticker-set-sticker');\r\n    if(!target) return;\r\n\r\n    const fileId = target.dataset.docId;\r\n    if(appImManager.chat.input.sendMessageWithDocument(fileId)) {\r\n      this.hide();\r\n    } else {\r\n      console.warn('got no doc by id:', fileId);\r\n    }\r\n  };\r\n\r\n  private loadStickerSet() {\r\n    return this.managers.appStickersManager.getStickerSet(this.stickerSetInput).then(async(set) => {\r\n      if(!set) {\r\n        toastNew({langPackKey: 'StickerSet.DontExist'});\r\n        this.hide();\r\n        return;\r\n      }\r\n\r\n      animationIntersector.setOnlyOnePlayableGroup(ANIMATION_GROUP);\r\n\r\n      let button: HTMLElement;\r\n      const s = i18n('Stickers', [set.set.count]);\r\n      if(set.set.installed_date) {\r\n        button = Button('btn-primary btn-primary-transparent danger', {noRipple: true});\r\n        button.append(i18n('RemoveStickersCount', [s]));\r\n      } else {\r\n        button = Button('btn-primary btn-color-primary', {noRipple: true});\r\n        button.append(i18n('AddStickersCount', [s]));\r\n      }\r\n\r\n      attachClickEvent(button, () => {\r\n        const toggle = toggleDisability([button], true);\r\n\r\n        this.managers.appStickersManager.toggleStickerSet(set.set).then(() => {\r\n          this.hide();\r\n        }).catch(() => {\r\n          toggle();\r\n        });\r\n      });\r\n\r\n      const lazyLoadQueue = new LazyLoadQueue();\r\n      const divs = await Promise.all(set.documents.map(async(doc) => {\r\n        if(doc._ === 'documentEmpty') {\r\n          return;\r\n        }\r\n        \r\n        const div = document.createElement('div');\r\n        div.classList.add('sticker-set-sticker');\r\n\r\n        const size = mediaSizes.active.esgSticker.width;\r\n        \r\n        await wrapSticker({\r\n          doc, \r\n          div, \r\n          lazyLoadQueue, \r\n          group: ANIMATION_GROUP, \r\n          play: true,\r\n          loop: true,\r\n          width: size,\r\n          height: size\r\n        });\r\n\r\n        return div;\r\n      }));\r\n\r\n      setInnerHTML(this.title, wrapEmojiText(set.set.title));\r\n      this.stickersFooter.classList.toggle('add', !set.set.installed_date);\r\n      this.stickersFooter.textContent = '';\r\n      this.stickersFooter.append(button);\r\n\r\n      this.stickersDiv.classList.remove('is-loading');\r\n      this.stickersDiv.innerHTML = '';\r\n      this.stickersDiv.append(...divs.filter(Boolean));\r\n\r\n      this.scrollable.onAdditionalScroll();\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"..\";\r\nimport RadioField from \"../../radioField\";\r\nimport Row, { RadioFormFromRows } from \"../../row\";\r\nimport SliderSuperTab from \"../../sliderTab\";\r\nimport { wrapStickerToRow } from \"../../wrappers\";\r\n\r\nexport default class AppQuickReactionTab extends SliderSuperTab {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.setTitle('DoubleTapSetting');\r\n    this.container.classList.add('quick-reaction-container');\r\n\r\n    return Promise.all([\r\n      this.managers.appReactionsManager.getQuickReaction(),\r\n      this.managers.appReactionsManager.getAvailableReactions()\r\n    ]).then(([quickReaction, availableReactions]) => {\r\n      availableReactions = availableReactions.filter((reaction) => !reaction.pFlags.inactive);\r\n\r\n      const section = new SettingSection();\r\n\r\n      const name = 'quick-reaction';\r\n      const rows = availableReactions.map((availableReaction) => {\r\n        const radioField = new RadioField({\r\n          name,\r\n          text: availableReaction.title,\r\n          value: availableReaction.reaction,\r\n          alignRight: true\r\n        });\r\n\r\n        const row = new Row({\r\n          radioField,\r\n          havePadding: true\r\n        });\r\n\r\n        radioField.main.classList.add('quick-reaction-title');\r\n\r\n        wrapStickerToRow({\r\n          row,\r\n          doc: availableReaction.static_icon,\r\n          size: 'small'\r\n        });\r\n\r\n        if(availableReaction.reaction === quickReaction.reaction) {\r\n          radioField.setValueSilently(true);\r\n        }\r\n\r\n        return row;\r\n      });\r\n\r\n      const form = RadioFormFromRows(rows, (value) => {\r\n        this.managers.appReactionsManager.setDefaultReaction(value);\r\n      });\r\n\r\n      section.content.append(form);\r\n      this.scrollable.append(section.container);\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { generateSection, SettingSection } from \"..\";\r\nimport RangeSelector from \"../../rangeSelector\";\r\nimport Button from \"../../button\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport RadioField from \"../../radioField\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport { IS_APPLE } from \"../../../environment/userAgent\";\r\nimport Row from \"../../row\";\r\nimport AppBackgroundTab from \"./background\";\r\nimport { LangPackKey, _i18n } from \"../../../lib/langPack\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport assumeType from \"../../../helpers/assumeType\";\r\nimport { MessagesAllStickers, StickerSet } from \"../../../layer\";\r\nimport { wrapStickerSetThumb, wrapStickerToRow } from \"../../wrappers\";\r\nimport LazyLoadQueue from \"../../lazyLoadQueue\";\r\nimport PopupStickers from \"../../popups/stickers\";\r\nimport eachMinute from \"../../../helpers/eachMinute\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport IS_GEOLOCATION_SUPPORTED from \"../../../environment/geolocationSupport\";\r\nimport AppQuickReactionTab from \"./quickReaction\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\nimport { State } from \"../../../config/state\";\r\n\r\nexport class RangeSettingSelector {\r\n  public container: HTMLDivElement;\r\n  public valueContainer: HTMLElement;\r\n  private range: RangeSelector;\r\n\r\n  public onChange: (value: number) => void;\r\n\r\n  constructor(\r\n    name: LangPackKey, \r\n    step: number, \r\n    initialValue: number, \r\n    minValue: number, \r\n    maxValue: number,\r\n    writeValue = true\r\n  ) {\r\n    const BASE_CLASS = 'range-setting-selector';\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add(BASE_CLASS);\r\n\r\n    const details = document.createElement('div');\r\n    details.classList.add(BASE_CLASS + '-details');\r\n\r\n    const nameDiv = document.createElement('div');\r\n    nameDiv.classList.add(BASE_CLASS + '-name');\r\n    _i18n(nameDiv, name);\r\n\r\n    const valueDiv = this.valueContainer = document.createElement('div');\r\n    valueDiv.classList.add(BASE_CLASS + '-value');\r\n\r\n    if(writeValue) {\r\n      valueDiv.innerHTML = '' + initialValue;\r\n    }\r\n\r\n    details.append(nameDiv, valueDiv);\r\n\r\n    this.range = new RangeSelector({\r\n      step, \r\n      min: minValue, \r\n      max: maxValue\r\n    }, initialValue);\r\n    this.range.setListeners();\r\n    this.range.setHandlers({\r\n      onScrub: value => {\r\n        if(this.onChange) {\r\n          this.onChange(value);\r\n        }\r\n\r\n        if(writeValue) {\r\n          //console.log('font size scrub:', value);\r\n          valueDiv.innerText = '' + value;\r\n        }\r\n      }\r\n    });\r\n\r\n    this.container.append(details, this.range.container);\r\n  }\r\n}\r\n\r\nexport default class AppGeneralSettingsTab extends SliderSuperTabEventable {\r\n  init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('general-settings-container');\r\n    this.setTitle('General');\r\n\r\n    const section = generateSection.bind(null, this.scrollable);\r\n\r\n    {\r\n      const container = section('Settings');\r\n      \r\n      const range = new RangeSettingSelector('TextSize', 1, rootScope.settings.messagesTextSize, 12, 20);\r\n      range.onChange = (value) => {\r\n        rootScope.managers.appStateManager.setByKey('settings.messagesTextSize', value);\r\n      };\r\n\r\n      const chatBackgroundButton = Button('btn-primary btn-transparent', {icon: 'image', text: 'ChatBackground'});\r\n\r\n      attachClickEvent(chatBackgroundButton, () => {\r\n        this.slider.createTab(AppBackgroundTab).open();\r\n      });\r\n\r\n      const animationsCheckboxField = new CheckboxField({\r\n        text: 'EnableAnimations', \r\n        name: 'animations', \r\n        stateKey: 'settings.animationsEnabled',\r\n        withRipple: true,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n      \r\n      container.append(range.container, chatBackgroundButton, animationsCheckboxField.label);\r\n    }\r\n\r\n    {\r\n      const container = section('General.Keyboard');\r\n\r\n      const form = document.createElement('form');\r\n\r\n      const name = 'send-shortcut';\r\n      const stateKey = 'settings.sendShortcut';\r\n\r\n      const enterRow = new Row({\r\n        radioField: new RadioField({\r\n          langKey: 'General.SendShortcut.Enter', \r\n          name, \r\n          value: 'enter', \r\n          stateKey\r\n        }),\r\n        subtitleLangKey: 'General.SendShortcut.NewLine.ShiftEnter'\r\n      });\r\n\r\n      const ctrlEnterRow = new Row({\r\n        radioField: new RadioField({\r\n          name,\r\n          value: 'ctrlEnter', \r\n          stateKey\r\n        }),\r\n        subtitleLangKey: 'General.SendShortcut.NewLine.Enter'\r\n      });\r\n      _i18n(ctrlEnterRow.radioField.main, 'General.SendShortcut.CtrlEnter', [IS_APPLE ? '' : 'Ctrl']);\r\n      \r\n      form.append(enterRow.container, ctrlEnterRow.container);\r\n      container.append(form);\r\n    }\r\n\r\n    if(IS_GEOLOCATION_SUPPORTED) {\r\n      const container = section('DistanceUnitsTitle');\r\n\r\n      const form = document.createElement('form');\r\n\r\n      const name = 'distance-unit';\r\n      const stateKey = 'settings.distanceUnit';\r\n\r\n      const kilometersRow = new Row({\r\n        radioField: new RadioField({\r\n          langKey: 'DistanceUnitsKilometers', \r\n          name, \r\n          value: 'kilometers', \r\n          stateKey\r\n        })\r\n      });\r\n\r\n      const milesRow = new Row({\r\n        radioField: new RadioField({\r\n          langKey: 'DistanceUnitsMiles',\r\n          name,\r\n          value: 'miles', \r\n          stateKey\r\n        })\r\n      });\r\n      \r\n      form.append(kilometersRow.container, milesRow.container);\r\n      container.append(form);\r\n    }\r\n\r\n    {\r\n      const container = section('General.TimeFormat');\r\n\r\n      const form = document.createElement('form');\r\n\r\n      const name = 'time-format';\r\n      const stateKey = 'settings.timeFormat';\r\n\r\n      const formats: [State['settings']['timeFormat'], LangPackKey][] = [\r\n        ['h12', 'General.TimeFormat.h12'], \r\n        ['h23', 'General.TimeFormat.h23']\r\n      ];\r\n\r\n      const rows = formats.map(([format, langPackKey]) => {\r\n        const row = new Row({\r\n          radioField: new RadioField({\r\n            langKey: langPackKey, \r\n            name, \r\n            value: format, \r\n            stateKey\r\n          })\r\n        });\r\n\r\n        return row;\r\n      });\r\n\r\n      const cancel = eachMinute(() => {\r\n        const date = new Date();\r\n\r\n        formats.forEach(([format], idx) => {\r\n          const str = date.toLocaleTimeString(\"en-us-u-hc-\" + format, {\r\n            hour: '2-digit', \r\n            minute: '2-digit'\r\n          });\r\n\r\n          rows[idx].subtitle.textContent = str;\r\n        });\r\n      });\r\n\r\n      this.eventListener.addEventListener('destroy', cancel);\r\n\r\n      form.append(...rows.map((row) => row.container));\r\n      container.append(form);\r\n    }\r\n\r\n    {\r\n      const container = section('Emoji');\r\n\r\n      const suggestCheckboxField = new CheckboxField({\r\n        text: 'GeneralSettings.EmojiPrediction', \r\n        name: 'suggest-emoji', \r\n        stateKey: 'settings.emoji.suggest',\r\n        withRipple: true,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n      const bigCheckboxField = new CheckboxField({\r\n        text: 'GeneralSettings.BigEmoji', \r\n        name: 'emoji-big', \r\n        stateKey: 'settings.emoji.big',\r\n        withRipple: true,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      container.append(suggestCheckboxField.label, bigCheckboxField.label);\r\n    }\r\n    \r\n    {\r\n      const section = new SettingSection({name: 'Telegram.InstalledStickerPacksController', caption: 'StickersBotInfo'});\r\n\r\n      const reactionsRow = new Row({\r\n        titleLangKey: 'DoubleTapSetting',\r\n        havePadding: true,\r\n        clickable: () => {\r\n          this.slider.createTab(AppQuickReactionTab).open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      const renderQuickReaction = () => {\r\n        Promise.resolve(this.managers.appReactionsManager.getQuickReaction()).then((reaction) => {\r\n          wrapStickerToRow({\r\n            row: reactionsRow,\r\n            doc: reaction.static_icon,\r\n            size: 'small'\r\n          });\r\n        });\r\n      };\r\n\r\n      renderQuickReaction();\r\n\r\n      this.listenerSetter.add(rootScope)('quick_reaction', renderQuickReaction);\r\n\r\n      const suggestCheckboxField = new CheckboxField({\r\n        text: 'Stickers.SuggestStickers', \r\n        name: 'suggest', \r\n        stateKey: 'settings.stickers.suggest',\r\n        withRipple: true,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n      const loopCheckboxField = new CheckboxField({\r\n        text: 'InstalledStickers.LoopAnimated', \r\n        name: 'loop', \r\n        stateKey: 'settings.stickers.loop',\r\n        withRipple: true,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      const stickerSets: {[id: string]: Row} = {};\r\n\r\n      const stickersContent = section.generateContentElement();\r\n\r\n      const lazyLoadQueue = new LazyLoadQueue();\r\n      const renderStickerSet = (stickerSet: StickerSet.stickerSet, method: 'append' | 'prepend' = 'append') => {\r\n        const row = new Row({\r\n          title: wrapEmojiText(stickerSet.title),\r\n          subtitleLangKey: 'Stickers',\r\n          subtitleLangArgs: [stickerSet.count],\r\n          havePadding: true,\r\n          clickable: () => {\r\n            new PopupStickers({id: stickerSet.id, access_hash: stickerSet.access_hash}).show();\r\n          },\r\n          listenerSetter: this.listenerSetter\r\n        });\r\n\r\n        stickerSets[stickerSet.id] = row;\r\n\r\n        const div = document.createElement('div');\r\n        div.classList.add('row-media');\r\n\r\n        wrapStickerSetThumb({\r\n          set: stickerSet,\r\n          container: div,\r\n          group: 'GENERAL-SETTINGS',\r\n          lazyLoadQueue,\r\n          width: 48,\r\n          height: 48,\r\n          autoplay: true\r\n        });\r\n\r\n        row.container.append(div);\r\n\r\n        stickersContent[method](row.container);\r\n      };\r\n\r\n      this.managers.appStickersManager.getAllStickers().then((allStickers) => {\r\n        assumeType<MessagesAllStickers.messagesAllStickers>(allStickers);\r\n        for(const stickerSet of allStickers.sets) {\r\n          renderStickerSet(stickerSet);\r\n        }\r\n      });\r\n\r\n      this.listenerSetter.add(rootScope)('stickers_installed', (e) => {\r\n        const set: StickerSet.stickerSet = e;\r\n        \r\n        if(!stickerSets[set.id]) {\r\n          renderStickerSet(set, 'prepend');\r\n        }\r\n      });\r\n  \r\n      this.listenerSetter.add(rootScope)('stickers_deleted', (e) => {\r\n        const set: StickerSet.stickerSet = e;\r\n        \r\n        if(stickerSets[set.id]) {\r\n          stickerSets[set.id].container.remove();\r\n          delete stickerSets[set.id];\r\n        }\r\n      });\r\n\r\n      section.content.append(reactionsRow.container, suggestCheckboxField.label, loopCheckboxField.label);\r\n      this.scrollable.append(section.container);\r\n    }\r\n  }\r\n\r\n  onOpen() {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport eachTimeout from \"./eachTimeout\";\r\n\r\n// It's better to use timeout instead of interval, because interval can be corrupted\r\nexport default function eachMinute(callback: () => any, runFirst = true) {\r\n  return eachTimeout(callback, () => (60 - new Date().getSeconds()) * 1000, runFirst);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport ctx from \"../environment/ctx\";\r\nimport noop from \"./noop\";\r\n\r\n// It's better to use timeout instead of interval, because interval can be corrupted\r\nexport default function eachTimeout(callback: () => any, getNextTimeout: () => number, runFirst = true) {\r\n  const cancel = () => {\r\n    clearTimeout(timeout);\r\n  };\r\n\r\n  // replace callback to run noop and restore after\r\n  const _callback = callback;\r\n  if(!runFirst) {\r\n    callback = noop;\r\n  }\r\n\r\n  let timeout: number;\r\n  (function run() {\r\n    callback();\r\n    timeout = ctx.setTimeout(run, getNextTimeout());\r\n  })();\r\n\r\n  callback = _callback;\r\n\r\n  return cancel;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport InputField from \"../../inputField\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport EditPeer from \"../../editPeer\";\r\nimport { UsernameInputField } from \"../../usernameInputField\";\r\nimport { i18n, i18n_ } from \"../../../lib/langPack\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport { generateSection, SettingSection } from \"..\";\r\n\r\n// TODO:         - (    ,    ,      )\r\n\r\nexport default class AppEditProfileTab extends SliderSuperTab {\r\n  private firstNameInputField: InputField;\r\n  private lastNameInputField: InputField;\r\n  private bioInputField: InputField;\r\n  private usernameInputField: InputField;\r\n  \r\n  private profileUrlContainer: HTMLDivElement;\r\n  private profileUrlAnchor: HTMLAnchorElement;\r\n\r\n  private editPeer: EditPeer;\r\n\r\n  protected async init() {\r\n    this.container.classList.add('edit-profile-container');\r\n    this.setTitle('EditAccount.Title');\r\n\r\n    const inputFields: InputField[] = [];\r\n\r\n    {\r\n      const section = generateSection(this.scrollable, undefined, 'Bio.Description');\r\n      const inputWrapper = document.createElement('div');\r\n      inputWrapper.classList.add('input-wrapper');\r\n  \r\n      const appConfig = await this.managers.apiManager.getAppConfig();\r\n      this.firstNameInputField = new InputField({\r\n        label: 'EditProfile.FirstNameLabel',\r\n        name: 'first-name',\r\n        maxLength: 70\r\n      });\r\n      this.lastNameInputField = new InputField({\r\n        label: 'Login.Register.LastName.Placeholder',\r\n        name: 'last-name',\r\n        maxLength: 64\r\n      });\r\n      this.bioInputField = new InputField({\r\n        label: 'EditProfile.BioLabel',\r\n        name: 'bio',\r\n        maxLength: rootScope.premium ? appConfig.about_length_limit_premium : appConfig.about_length_limit_default\r\n      });\r\n  \r\n      inputWrapper.append(this.firstNameInputField.container, this.lastNameInputField.container, this.bioInputField.container);\r\n      \r\n      const caption = document.createElement('div');\r\n      caption.classList.add('caption');\r\n      i18n_({element: caption, key: 'Bio.Description'});\r\n\r\n      inputFields.push(this.firstNameInputField, this.lastNameInputField, this.bioInputField);\r\n\r\n      this.editPeer = new EditPeer({\r\n        peerId: rootScope.myId,\r\n        inputFields,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      this.content.append(this.editPeer.nextBtn);\r\n\r\n      section.append(this.editPeer.avatarEdit.container, inputWrapper);\r\n    }\r\n\r\n    {\r\n      const section = new SettingSection({\r\n        name: 'EditAccount.Username',\r\n        caption: true\r\n      });\r\n\r\n      const inputWrapper = document.createElement('div');\r\n      inputWrapper.classList.add('input-wrapper');\r\n\r\n      this.usernameInputField = new UsernameInputField({\r\n        label: 'EditProfile.Username.Label',\r\n        name: 'username',\r\n        plainText: true,\r\n        listenerSetter: this.listenerSetter,\r\n        onChange: () => {\r\n          this.editPeer.handleChange();\r\n          this.setProfileUrl();\r\n        },\r\n        availableText: 'EditProfile.Username.Available',\r\n        takenText: 'EditProfile.Username.Taken',\r\n        invalidText: 'EditProfile.Username.Invalid'\r\n      }, this.managers);\r\n\r\n      inputWrapper.append(this.usernameInputField.container);\r\n\r\n      const caption = section.caption;\r\n      caption.append(i18n('UsernameSettings.ChangeDescription'));\r\n      caption.append(document.createElement('br'), document.createElement('br'));\r\n\r\n      const profileUrlContainer = this.profileUrlContainer = document.createElement('div');\r\n      profileUrlContainer.classList.add('profile-url-container');\r\n      \r\n      const profileUrlAnchor = this.profileUrlAnchor = document.createElement('a');\r\n      profileUrlAnchor.classList.add('profile-url');\r\n      profileUrlAnchor.href = '#';\r\n      profileUrlAnchor.target = '_blank';\r\n\r\n      profileUrlContainer.append(i18n('UsernameHelpLink', [profileUrlAnchor]));\r\n\r\n      caption.append(profileUrlContainer);\r\n\r\n      inputFields.push(this.usernameInputField);\r\n      section.content.append(inputWrapper);\r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    attachClickEvent(this.editPeer.nextBtn, () => {\r\n      this.editPeer.nextBtn.disabled = true;\r\n\r\n      let promises: Promise<any>[] = [];\r\n      \r\n      promises.push(this.managers.appProfileManager.updateProfile(this.firstNameInputField.value, this.lastNameInputField.value, this.bioInputField.value).then(() => {\r\n        this.close();\r\n      }, (err) => {\r\n        console.error('updateProfile error:', err);\r\n      }));\r\n\r\n      if(this.editPeer.uploadAvatar) {\r\n        promises.push(this.editPeer.uploadAvatar().then((inputFile) => {\r\n          return this.managers.appProfileManager.uploadProfilePhoto(inputFile);\r\n        }));\r\n      }\r\n\r\n      if(this.usernameInputField.isValidToChange()) {\r\n        promises.push(this.managers.appUsersManager.updateUsername(this.usernameInputField.value));\r\n      }\r\n\r\n      Promise.race(promises).finally(() => {\r\n        this.editPeer.nextBtn.removeAttribute('disabled');\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const user = await this.managers.appUsersManager.getSelf();\r\n\r\n    const userFull = await this.managers.appProfileManager.getProfile(user.id, true);\r\n\r\n    this.firstNameInputField.setOriginalValue(user.first_name, true);\r\n    this.lastNameInputField.setOriginalValue(user.last_name, true);\r\n    this.bioInputField.setOriginalValue(userFull.about, true);\r\n    this.usernameInputField.setOriginalValue(user.username, true);\r\n\r\n    this.setProfileUrl();\r\n    this.editPeer.handleChange();\r\n  }\r\n\r\n  private setProfileUrl() {\r\n    if(this.usernameInputField.input.classList.contains('error') || !this.usernameInputField.value.length) {\r\n      this.profileUrlContainer.style.display = 'none';\r\n    } else {\r\n      this.profileUrlContainer.style.display = '';\r\n      let url = 'https://t.me/' + this.usernameInputField.value;\r\n      this.profileUrlAnchor.innerText = url;\r\n      this.profileUrlAnchor.href = url;\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport AppSelectPeers from \"../../appSelectPeers\";\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport { MyDialogFilter as DialogFilter } from \"../../../lib/storages/filters\";\r\nimport ButtonIcon from \"../../buttonIcon\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport Button from \"../../button\";\r\nimport AppEditFolderTab from \"./editFolder\";\r\nimport I18n, { i18n, LangPackKey, _i18n, join } from \"../../../lib/langPack\";\r\nimport { SettingSection } from \"..\";\r\nimport { toast } from \"../../toast\";\r\nimport copy from \"../../../helpers/object/copy\";\r\nimport forEachReverse from \"../../../helpers/array/forEachReverse\";\r\nimport setInnerHTML from \"../../../helpers/dom/setInnerHTML\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\nimport { attachClickEvent, simulateClickEvent } from \"../../../helpers/dom/clickEvent\";\r\n\r\nexport default class AppIncludedChatsTab extends SliderSuperTab {\r\n  private editFolderTab: AppEditFolderTab;\r\n  private confirmBtn: HTMLElement;\r\n\r\n  private selector: AppSelectPeers;\r\n  private type: 'included' | 'excluded';\r\n  private filter: DialogFilter;\r\n  private originalFilter: DialogFilter;\r\n\r\n  private dialogsByFilters: Map<DialogFilter, Set<PeerId>>;\r\n\r\n  protected init() {\r\n    this.content.remove();\r\n    this.container.classList.add('included-chatlist-container');\r\n    this.confirmBtn = ButtonIcon('check btn-confirm blue', {noRipple: true});\r\n    this.confirmBtn.style.display = 'none';\r\n\r\n    this.header.append(this.confirmBtn);\r\n\r\n    attachClickEvent(this.confirmBtn, async() => {\r\n      const selected = this.selector.getSelected();\r\n\r\n      //this.filter.pFlags = {};\r\n\r\n      if(this.type === 'included') {\r\n        for(const key in this.filter.pFlags) {\r\n          if(key.indexOf('exclude_') === 0) {\r\n            continue;\r\n          }\r\n\r\n          // @ts-ignore\r\n          delete this.filter.pFlags[key];\r\n        }\r\n      } else {\r\n        for(const key in this.filter.pFlags) {\r\n          if(key.indexOf('exclude_') !== 0) {\r\n            continue;\r\n          }\r\n\r\n          // @ts-ignore\r\n          delete this.filter.pFlags[key];\r\n        }\r\n      }\r\n\r\n      const peerIds: PeerId[] = [];\r\n      for(const key of selected) {\r\n        if(key.isPeerId()) {\r\n          peerIds.push(key.toPeerId());\r\n        } else {\r\n          // @ts-ignore\r\n          this.filter.pFlags[key] = true;\r\n        }\r\n      }\r\n\r\n      let cmp: (peerId: PeerId) => boolean;\r\n      if(this.type === 'included') {\r\n        cmp = (peerId) => peerIds.includes(peerId);\r\n      } else {\r\n        cmp = (peerId) => !peerIds.includes(peerId);\r\n      }\r\n\r\n      forEachReverse(this.filter.pinnedPeerIds, (peerId, idx) => {\r\n        if(!cmp(peerId)) {\r\n          this.filter.pinnedPeerIds.splice(idx, 1);\r\n          this.filter.pinned_peers.splice(idx, 1);\r\n        }\r\n      });\r\n\r\n      const other = this.type === 'included' ? 'excludePeerIds' : 'includePeerIds';\r\n      const otherLegacy = this.type === 'included' ? 'exclude_peers' : 'include_peers';\r\n      forEachReverse(this.filter[other], (peerId, idx) => {\r\n        if(peerIds.includes(peerId)) {\r\n          this.filter[other].splice(idx, 1);\r\n          this.filter[otherLegacy].splice(idx, 1);\r\n        }\r\n      });\r\n      \r\n      this.filter[this.type === 'included' ? 'includePeerIds' : 'excludePeerIds'] = peerIds;\r\n      this.filter[this.type === 'included' ? 'include_peers' : 'exclude_peers'] = await Promise.all(peerIds.map((peerId) => this.managers.appPeersManager.getInputPeerById(peerId)));\r\n      //this.filter.pinned_peers = this.filter.pinned_peers.filter((peerId) => this.filter.include_peers.includes(peerId));\r\n\r\n      this.editFolderTab.setFilter(this.filter, false);\r\n      this.close();\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    this.dialogsByFilters = new Map();\r\n    return this.managers.filtersStorage.getDialogFilters().then(async(filters) => {\r\n      await Promise.all(filters.map(async(filter) => {\r\n        const dialogs = await this.managers.dialogsStorage.getFolderDialogs(filter.id);\r\n        const peerIds = dialogs.map((d) => d.peerId);\r\n        this.dialogsByFilters.set(filter, new Set(peerIds));\r\n      }));\r\n    });\r\n  }\r\n\r\n  checkbox(selected?: boolean) {\r\n    const checkboxField = new CheckboxField({\r\n      round: true\r\n    });\r\n    if(selected) {\r\n      checkboxField.input.checked = selected;\r\n    }\r\n\r\n    return checkboxField.label;\r\n  }\r\n\r\n  renderResults = async(peerIds: PeerId[]) => {\r\n    //const other = this.type === 'included' ? this.filter.exclude_peers : this.filter.include_peers;\r\n\r\n    await this.managers.appUsersManager.getContacts();\r\n    peerIds.forEach((peerId) => {\r\n      //if(other.includes(peerId)) return;\r\n\r\n      const {dom} = appDialogsManager.addDialogNew({\r\n        peerId: peerId,\r\n        container: this.selector.scrollable,\r\n        rippleEnabled: true,\r\n        avatarSize: 46\r\n      });\r\n\r\n      const selected = this.selector.selected.has(peerId);\r\n      dom.containerEl.append(this.checkbox(selected));\r\n      //if(selected) dom.listEl.classList.add('active');\r\n\r\n      const foundInFilters: HTMLElement[] = [];\r\n      this.dialogsByFilters.forEach((dialogs, filter) => {\r\n        if(dialogs.has(peerId)) {\r\n          const span = document.createElement('span');\r\n          setInnerHTML(span, wrapEmojiText(filter.title));\r\n          foundInFilters.push(span);\r\n        }\r\n      });\r\n\r\n      const joined = join(foundInFilters, false);\r\n      joined.forEach((el) => {\r\n        dom.lastMessageSpan.append(el);\r\n      });\r\n    });\r\n  };\r\n\r\n  onOpen() {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    this.confirmBtn.style.display = this.type === 'excluded' ? '' : 'none';\r\n    this.setTitle(this.type === 'included' ? 'FilterAlwaysShow' : 'FilterNeverShow');\r\n\r\n    const filter = this.filter;\r\n\r\n    const categoriesSection = new SettingSection({\r\n      noDelimiter: true,\r\n      name: 'FilterChatTypes'\r\n    });\r\n\r\n    categoriesSection.container.classList.add('folder-categories');\r\n\r\n    let details: {[flag: string]: {ico: string, text: LangPackKey}};\r\n    if(this.type === 'excluded') {\r\n      details = {\r\n        exclude_muted: {ico: 'mute', text: 'ChatList.Filter.MutedChats'},\r\n        exclude_archived: {ico: 'archive', text: 'ChatList.Filter.Archive'},\r\n        exclude_read: {ico: 'readchats', text: 'ChatList.Filter.ReadChats'}\r\n      };\r\n    } else {\r\n      details = {\r\n        contacts: {ico: 'newprivate', text: 'ChatList.Filter.Contacts'},\r\n        non_contacts: {ico: 'noncontacts', text: 'ChatList.Filter.NonContacts'},\r\n        groups: {ico: 'group', text: 'ChatList.Filter.Groups'},\r\n        broadcasts: {ico: 'newchannel', text: 'ChatList.Filter.Channels'},\r\n        bots: {ico: 'bots', text: 'ChatList.Filter.Bots'}\r\n      };\r\n    }\r\n\r\n    const f = document.createDocumentFragment();\r\n    for(const key in details) {\r\n      const button = Button('btn-primary btn-transparent folder-category-button', {icon: details[key].ico, text: details[key].text});\r\n      button.dataset.peerId = key;\r\n      button.append(this.checkbox());\r\n      f.append(button);\r\n    }\r\n    categoriesSection.content.append(f);\r\n\r\n    /////////////////\r\n\r\n    const selectedPeers = (this.type === 'included' ? filter.includePeerIds : filter.excludePeerIds).slice();\r\n\r\n    this.selector = new AppSelectPeers({\r\n      appendTo: this.container, \r\n      onChange: this.onSelectChange, \r\n      peerType: ['dialogs'], \r\n      renderResultsFunc: this.renderResults,\r\n      placeholder: 'Search',\r\n      sectionNameLangPackKey: 'FilterChats',\r\n      managers: this.managers\r\n    });\r\n    this.selector.selected = new Set(selectedPeers);\r\n\r\n    let addedInitial = false;\r\n    const _add = this.selector.add.bind(this.selector);\r\n    this.selector.add = (peerId, title, scroll) => {\r\n      if(this.selector.selected.size >= 100 && addedInitial && !details[peerId]) {\r\n        const el: HTMLInputElement = this.selector.list.querySelector(`[data-peer-id=\"${peerId}\"] [type=\"checkbox\"]`);\r\n        if(el) {\r\n          setTimeout(() => {\r\n            el.checked = false;\r\n          }, 0);\r\n        }\r\n\r\n        const str = I18n.format(this.type === 'excluded' ? 'ChatList.Filter.Exclude.LimitReached': 'ChatList.Filter.Include.LimitReached', true);\r\n        toast(str);\r\n        return;\r\n      }\r\n\r\n      const div = _add(peerId, details[peerId] ? i18n(details[peerId].text) : undefined, scroll);\r\n      if(details[peerId]) {\r\n        div.querySelector('avatar-element').classList.add('tgico-' + details[peerId].ico);\r\n      }\r\n      return div;\r\n    };\r\n\r\n    this.selector.scrollable.container.append(categoriesSection.container, this.selector.scrollable.container.lastElementChild);\r\n\r\n    this.selector.addInitial(selectedPeers);\r\n    addedInitial = true;\r\n\r\n    for(const flag in filter.pFlags) {\r\n      // @ts-ignore\r\n      if(details.hasOwnProperty(flag) && !!filter.pFlags[flag]) {\r\n        simulateClickEvent(categoriesSection.content.querySelector(`[data-peer-id=\"${flag}\"]`) as HTMLElement);\r\n      }\r\n    }\r\n  }\r\n\r\n  onSelectChange = (length: number) => {\r\n    //const changed = !deepEqual(this.filter, this.originalFilter);\r\n    if(this.type === 'included') {\r\n      this.confirmBtn.style.display = length ? '' : 'none';\r\n    }\r\n  };\r\n\r\n  onCloseAfterTimeout() {\r\n    if(this.selector) {\r\n      this.selector.container.remove();\r\n      this.selector = null;\r\n    }\r\n\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n\r\n  /**\r\n   * Do not ignore arguments!\r\n   */\r\n  public open(filter?: DialogFilter, type?: 'included' | 'excluded', editFolderTab?: AppIncludedChatsTab['editFolderTab']) {\r\n    this.originalFilter = filter;\r\n    this.filter = copy(this.originalFilter);\r\n    this.type = type;\r\n    this.editFolderTab = editFolderTab;\r\n    \r\n    return super.open();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport { MyDialogFilter as DialogFilter } from \"../../../lib/storages/filters\";\r\nimport lottieLoader, { LottieLoader } from \"../../../lib/rlottie/lottieLoader\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport { toast } from \"../../toast\";\r\nimport InputField from \"../../inputField\";\r\nimport ButtonIcon from \"../../buttonIcon\";\r\nimport ButtonMenuToggle from \"../../buttonMenuToggle\";\r\nimport { ButtonMenuItemOptions } from \"../../buttonMenu\";\r\nimport Button from \"../../button\";\r\nimport AppIncludedChatsTab from \"./includedChats\";\r\nimport { i18n, LangPackKey } from \"../../../lib/langPack\";\r\nimport { SettingSection } from \"..\";\r\nimport PopupPeer from \"../../popups/peer\";\r\nimport RLottiePlayer from \"../../../lib/rlottie/rlottiePlayer\";\r\nimport copy from \"../../../helpers/object/copy\";\r\nimport deepEqual from \"../../../helpers/object/deepEqual\";\r\nimport documentFragmentToHTML from \"../../../helpers/dom/documentFragmentToHTML\";\r\nimport wrapDraftText from \"../../../lib/richTextProcessor/wrapDraftText\";\r\nimport filterAsync from \"../../../helpers/array/filterAsync\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\n\r\nconst MAX_FOLDER_NAME_LENGTH = 12;\r\n\r\nexport default class AppEditFolderTab extends SliderSuperTab {\r\n  private caption: HTMLElement;\r\n  private stickerContainer: HTMLElement;\r\n\r\n  private confirmBtn: HTMLElement;\r\n  private menuBtn: HTMLElement;\r\n  private nameInputField: InputField;\r\n\r\n  private includePeerIds: SettingSection;\r\n  private excludePeerIds: SettingSection;\r\n  private flags: {[k in 'contacts' | 'non_contacts' | 'groups' | 'broadcasts' | 'bots' | 'exclude_muted' | 'exclude_archived' | 'exclude_read']: HTMLElement} = {} as any;\r\n\r\n  private animation: RLottiePlayer;\r\n  private filter: DialogFilter;\r\n  private originalFilter: DialogFilter;\r\n\r\n  private type: 'edit' | 'create';\r\n  private loadAnimationPromise: ReturnType<LottieLoader['waitForFirstFrame']>;\r\n\r\n  protected init() {\r\n    this.container.classList.add('edit-folder-container');\r\n    this.caption = document.createElement('div');\r\n    this.caption.classList.add('caption');\r\n    this.caption.append(i18n('FilterIncludeExcludeInfo'));\r\n    this.stickerContainer = document.createElement('div');\r\n    this.stickerContainer.classList.add('sticker-container');\r\n\r\n    this.confirmBtn = ButtonIcon('check btn-confirm hide blue');\r\n    const deleteFolderButton: ButtonMenuItemOptions = {\r\n      icon: 'delete danger',\r\n      text: 'FilterMenuDelete',\r\n      onClick: () => {\r\n        new PopupPeer('filter-delete', {\r\n          titleLangKey: 'ChatList.Filter.Confirm.Remove.Header',\r\n          descriptionLangKey: 'ChatList.Filter.Confirm.Remove.Text',\r\n          buttons: [{\r\n            langKey: 'Delete',\r\n            callback: () => {\r\n              deleteFolderButton.element.setAttribute('disabled', 'true');\r\n              this.managers.filtersStorage.updateDialogFilter(this.filter, true).then((bool) => {\r\n                if(bool) {\r\n                  this.close();\r\n                }\r\n              }).finally(() => {\r\n                deleteFolderButton.element.removeAttribute('disabled');\r\n              });\r\n            },\r\n            isDanger: true\r\n          }]\r\n        }).show();\r\n      }\r\n    };\r\n    this.menuBtn = ButtonMenuToggle({listenerSetter: this.listenerSetter}, 'bottom-left', [deleteFolderButton]);\r\n    this.menuBtn.classList.add('hide');\r\n\r\n    this.header.append(this.confirmBtn, this.menuBtn);\r\n\r\n    const inputSection = new SettingSection({});\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n    \r\n    this.nameInputField = new InputField({\r\n      label: 'FilterNameHint',\r\n      maxLength: MAX_FOLDER_NAME_LENGTH\r\n    });\r\n\r\n    inputWrapper.append(this.nameInputField.container);\r\n    inputSection.content.append(inputWrapper);\r\n\r\n    const generateList = (className: string, h2Text: LangPackKey, buttons: {icon: string, name?: string, withRipple?: true, text: LangPackKey}[], to: any) => {\r\n      const section = new SettingSection({\r\n        name: h2Text,\r\n        noDelimiter: true\r\n      });\r\n\r\n      section.container.classList.add('folder-list', className);\r\n\r\n      const categories = section.generateContentElement();\r\n      categories.classList.add('folder-categories');\r\n\r\n      buttons.forEach((o) => {\r\n        const button = Button('folder-category-button btn btn-primary btn-transparent', {\r\n          icon: o.icon,\r\n          text: o.text,\r\n          noRipple: o.withRipple ? undefined : true\r\n        });\r\n\r\n        if(o.name) {\r\n          to[o.name] = button;\r\n        }\r\n\r\n        categories.append(button);\r\n      });\r\n\r\n      return section;\r\n    };\r\n\r\n    this.includePeerIds = generateList('folder-list-included', 'FilterInclude', [{\r\n      icon: 'add primary',\r\n      text: 'ChatList.Filter.Include.AddChat',\r\n      withRipple: true\r\n    }, {\r\n      text: 'ChatList.Filter.Contacts',\r\n      icon: 'newprivate',\r\n      name: 'contacts'\r\n    }, {\r\n      text: 'ChatList.Filter.NonContacts',\r\n      icon: 'noncontacts',\r\n      name: 'non_contacts'\r\n    }, {\r\n      text: 'ChatList.Filter.Groups',\r\n      icon: 'group',\r\n      name: 'groups'\r\n    }, {\r\n      text: 'ChatList.Filter.Channels',\r\n      icon: 'channel',\r\n      name: 'broadcasts'\r\n    }, {\r\n      text: 'ChatList.Filter.Bots',\r\n      icon: 'bots',\r\n      name: 'bots'\r\n    }], this.flags);\r\n\r\n    this.excludePeerIds = generateList('folder-list-excluded', 'FilterExclude', [{\r\n      icon: 'minus primary',\r\n      text: 'ChatList.Filter.Exclude.AddChat',\r\n      withRipple: true\r\n    }, {\r\n      text: 'ChatList.Filter.MutedChats',\r\n      icon: 'mute',\r\n      name: 'exclude_muted'\r\n    }, {\r\n      text: 'ChatList.Filter.Archive',\r\n      icon: 'archive',\r\n      name: 'exclude_archived'\r\n    }, {\r\n      text: 'ChatList.Filter.ReadChats',\r\n      icon: 'readchats',\r\n      name: 'exclude_read'\r\n    }], this.flags);\r\n\r\n    this.scrollable.append(this.stickerContainer, this.caption, inputSection.container, this.includePeerIds.container, this.excludePeerIds.container);\r\n\r\n    const includedFlagsContainer = this.includePeerIds.container.querySelector('.folder-categories');\r\n    const excludedFlagsContainer = this.excludePeerIds.container.querySelector('.folder-categories');\r\n\r\n    attachClickEvent(includedFlagsContainer.querySelector('.btn') as HTMLElement, () => {\r\n      this.slider.createTab(AppIncludedChatsTab).open(this.filter, 'included', this);\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    attachClickEvent(excludedFlagsContainer.querySelector('.btn') as HTMLElement, () => {\r\n      this.slider.createTab(AppIncludedChatsTab).open(this.filter, 'excluded', this);\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    attachClickEvent(this.confirmBtn, () => {\r\n      if(this.nameInputField.input.classList.contains('error')) {\r\n        return;\r\n      }\r\n\r\n      if(!this.nameInputField.value.trim()) {\r\n        this.nameInputField.input.classList.add('error');\r\n        return;\r\n      }\r\n\r\n      let include = (Array.from(includedFlagsContainer.children) as HTMLElement[]).slice(1).reduce((acc, el) => acc + +!el.style.display, 0);\r\n      include += this.filter.include_peers.length;\r\n      \r\n      if(!include) {\r\n        toast('Please choose at least one chat for this folder.');\r\n        return;\r\n      }\r\n\r\n      this.confirmBtn.setAttribute('disabled', 'true');\r\n\r\n      let promise: Promise<boolean>;\r\n      if(!this.filter.id) {\r\n        promise = this.managers.filtersStorage.createDialogFilter(this.filter);\r\n      } else {\r\n        promise = this.managers.filtersStorage.updateDialogFilter(this.filter);\r\n      }\r\n\r\n      promise.then((bool) => {\r\n        if(bool) {\r\n          this.close();\r\n        }\r\n      }).catch((err) => {\r\n        if(err.type === 'DIALOG_FILTERS_TOO_MUCH') {\r\n          toast('Sorry, you can\\'t create more folders.');\r\n        } else {\r\n          console.error('updateDialogFilter error:', err);\r\n        }\r\n      }).finally(() => {\r\n        this.confirmBtn.removeAttribute('disabled');\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n    \r\n    this.listenerSetter.add(this.nameInputField.input)('input', () => {\r\n      this.filter.title = this.nameInputField.value;\r\n      this.editCheckForChange();\r\n    });\r\n\r\n    const reloadMissingPromises: Promise<any>[] = this.type === 'edit' ? [\r\n      this.managers.filtersStorage.reloadMissingPeerIds(this.filter.id, 'pinned_peers'),\r\n      this.managers.filtersStorage.reloadMissingPeerIds(this.filter.id, 'include_peers'),\r\n      this.managers.filtersStorage.reloadMissingPeerIds(this.filter.id, 'exclude_peers')\r\n    ] : [];\r\n\r\n    return Promise.all([\r\n      this.loadAnimationPromise = lottieLoader.loadAnimationAsAsset({\r\n        container: this.stickerContainer,\r\n        loop: false,\r\n        autoplay: false,\r\n        width: 86,\r\n        height: 86\r\n      }, 'Folders_2').then((player) => {\r\n        this.animation = player;\r\n\r\n        return lottieLoader.waitForFirstFrame(player);\r\n      }),\r\n\r\n      ...reloadMissingPromises\r\n    ]);\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    this.loadAnimationPromise.then(() => {\r\n      this.animation.autoplay = true;\r\n      this.animation.play();\r\n    });\r\n  }\r\n\r\n  private onCreateOpen() {\r\n    // this.caption.style.display = '';\r\n    this.setTitle('FilterNew');\r\n    this.menuBtn.classList.add('hide');\r\n    this.confirmBtn.classList.remove('hide');\r\n    this.nameInputField.value = '';\r\n\r\n    for(const flag in this.flags) {\r\n      // @ts-ignore\r\n      this.flags[flag].style.display = 'none';\r\n    }\r\n  }\r\n\r\n  private onEditOpen() {\r\n    // this.caption.style.display = 'none';\r\n    this.setTitle(this.type === 'create' ? 'FilterNew' : 'FilterHeaderEdit');\r\n\r\n    if(this.type === 'edit') {\r\n      this.menuBtn.classList.remove('hide');\r\n      this.confirmBtn.classList.add('hide');\r\n    }\r\n    \r\n    const filter = this.filter;\r\n    this.nameInputField.value = documentFragmentToHTML(wrapDraftText(filter.title));\r\n\r\n    for(const flag in this.flags) {\r\n      this.flags[flag as keyof AppEditFolderTab['flags']].style.display = !!filter.pFlags[flag as keyof AppEditFolderTab['flags']] ? '' : 'none';\r\n    }\r\n\r\n    (['includePeerIds' as const, 'excludePeerIds' as const]).forEach(async(key) => {\r\n      const section = this[key];\r\n      const ul = appDialogsManager.createChatList({ignoreClick: true});\r\n\r\n      let peers = filter[key];\r\n\r\n      // filter peers where we're kicked\r\n      const hasPeer = async(peerId: PeerId) => {\r\n        return !!(await this.managers.appMessagesManager.getDialogOnly(peerId)) || (peerId.isUser() ? (await this.managers.appUsersManager.getUser(peerId.toUserId()))._ === 'user' : false);\r\n      };\r\n      \r\n      const filtered = await filterAsync(peers, (peerId) => hasPeer(peerId));\r\n      peers.length = 0;\r\n      peers.push(...filtered);\r\n\r\n      peers = peers.slice();\r\n\r\n      const renderMore = async(_length: number) => {\r\n        for(let i = 0, length = Math.min(peers.length, _length); i < length; ++i) {\r\n          const peerId = peers.shift();\r\n          if(peerId.isUser() ? false : !(await this.managers.appMessagesManager.getDialogOnly(peerId))) {\r\n            continue;\r\n          }\r\n\r\n          const {dom} = appDialogsManager.addDialogNew({\r\n            peerId: peerId,\r\n            container: ul,\r\n            rippleEnabled: false,\r\n            meAsSaved: true,\r\n            avatarSize: 32\r\n          });\r\n          dom.lastMessageSpan.parentElement.remove();\r\n        }\r\n\r\n        if(peers.length) {\r\n          showMore.lastElementChild.replaceWith(i18n('FilterShowMoreChats', [peers.length]));\r\n        } else if(showMore) {\r\n          showMore.remove();\r\n        }\r\n      };\r\n      \r\n      section.generateContentElement().append(ul);\r\n\r\n      let showMore: HTMLElement;\r\n      if(peers.length) {\r\n        const content = section.generateContentElement();\r\n        showMore = Button('folder-category-button btn btn-primary btn-transparent', {icon: 'down'});\r\n        showMore.classList.add('load-more', 'rp-overflow');\r\n        attachClickEvent(showMore, () => renderMore(20), {listenerSetter: this.listenerSetter});\r\n        showMore.append(i18n('FilterShowMoreChats', [peers.length]));\r\n\r\n        content.append(showMore);\r\n      }\r\n\r\n      renderMore(4);\r\n    });\r\n  }\r\n\r\n  editCheckForChange() {\r\n    if(this.type === 'edit') {\r\n      const changed = !deepEqual(this.originalFilter, this.filter);\r\n      this.confirmBtn.classList.toggle('hide', !changed);\r\n      this.menuBtn.classList.toggle('hide', changed);\r\n    }\r\n  };\r\n\r\n  setFilter(filter: DialogFilter, firstTime: boolean) {\r\n    if(this.container) {\r\n      // cleanup\r\n      Array.from(this.container.querySelectorAll('ul, .load-more')).forEach((el) => el.remove());\r\n    }\r\n\r\n    if(firstTime) {\r\n      this.originalFilter = filter;\r\n      this.filter = copy(filter);\r\n    } else {\r\n      this.filter = filter;\r\n      this.onEditOpen();\r\n      this.editCheckForChange();\r\n    }\r\n  }\r\n\r\n  public open(filter?: DialogFilter) {\r\n    if(filter === undefined) {\r\n      this.setFilter({\r\n        _: 'dialogFilter',\r\n        id: 0,\r\n        title: '',\r\n        pFlags: {},\r\n        pinned_peers: [],\r\n        include_peers: [],\r\n        exclude_peers: [],\r\n        pinnedPeerIds: [],\r\n        includePeerIds: [],\r\n        excludePeerIds: []\r\n      }, true);\r\n      this.type = 'create';\r\n    } else {\r\n      this.setFilter(filter, true);\r\n      this.type = 'edit';\r\n    }\r\n\r\n    return super.open().then(() => {\r\n      if(this.type === 'edit') {\r\n        this.setFilter(this.originalFilter, true);\r\n        this.onEditOpen();\r\n      } else {\r\n        this.onCreateOpen();\r\n      }\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport lottieLoader, { LottieLoader } from \"../../../lib/rlottie/lottieLoader\";\r\nimport { toast } from \"../../toast\";\r\nimport type { MyDialogFilter } from \"../../../lib/storages/filters\";\r\nimport type { DialogFilterSuggested, DialogFilter } from \"../../../layer\";\r\nimport type _rootScope from \"../../../lib/rootScope\";\r\nimport Button from \"../../button\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport AppEditFolderTab from \"./editFolder\";\r\nimport Row from \"../../row\";\r\nimport { SettingSection } from \"..\";\r\nimport { i18n, i18n_, LangPackKey, join } from \"../../../lib/langPack\";\r\nimport cancelEvent from \"../../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport positionElementByIndex from \"../../../helpers/dom/positionElementByIndex\";\r\nimport RLottiePlayer from \"../../../lib/rlottie/rlottiePlayer\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\n\r\nexport default class AppChatFoldersTab extends SliderSuperTab {\r\n  private createFolderBtn: HTMLElement;\r\n  private foldersSection: SettingSection;\r\n  private suggestedSection: SettingSection;\r\n  private stickerContainer: HTMLElement;\r\n  private animation: RLottiePlayer;\r\n\r\n  private filtersRendered: {[filterId: number]: Row} = {};\r\n  private loadAnimationPromise: ReturnType<LottieLoader['waitForFirstFrame']>;\r\n\r\n  private async renderFolder(dialogFilter: DialogFilterSuggested | MyDialogFilter, container?: HTMLElement, row?: Row) {\r\n    let filter: MyDialogFilter;\r\n    let description = '';\r\n    let d: HTMLElement[] = [];\r\n    if(dialogFilter._ === 'dialogFilterSuggested') {\r\n      filter = dialogFilter.filter as MyDialogFilter;\r\n      description = dialogFilter.description;\r\n    } else {\r\n      filter = dialogFilter;\r\n\r\n      let enabledFilters = Object.keys(filter.pFlags).length;\r\n      /* (['include_peers', 'exclude_peers'] as ['include_peers', 'exclude_peers']).forEach((key) => {\r\n        enabledFilters += +!!filter[key].length;\r\n      }); */\r\n      \r\n      if(enabledFilters === 1) {\r\n        const pFlags = filter.pFlags;\r\n        let k: LangPackKey;\r\n        if(pFlags.contacts) k = 'FilterAllContacts';\r\n        else if(pFlags.non_contacts) k = 'FilterAllNonContacts';\r\n        else if(pFlags.groups) k = 'FilterAllGroups';\r\n        else if(pFlags.broadcasts) k = 'FilterAllChannels';\r\n        else if(pFlags.bots) k = 'FilterAllBots';\r\n\r\n        if(k) {\r\n          d.push(i18n(k));\r\n        }\r\n      }\r\n      \r\n      if(!d.length) {\r\n        const folder = await this.managers.dialogsStorage.getFolderDialogs(filter.id);\r\n        let chats = 0, channels = 0, groups = 0;\r\n        await Promise.all(folder.map(async(dialog) => {\r\n          if(await this.managers.appPeersManager.isAnyGroup(dialog.peerId)) groups++;\r\n          else if(await this.managers.appPeersManager.isBroadcast(dialog.peerId)) channels++;\r\n          else chats++;\r\n        }));\r\n\r\n        if(chats) d.push(i18n('Chats', [chats]));\r\n        if(channels) d.push(i18n('Channels', [channels]));\r\n        if(groups) d.push(i18n('Groups', [groups]));\r\n      }\r\n    }\r\n\r\n    let div: HTMLElement;\r\n    if(!row) {\r\n      row = new Row({\r\n        title: wrapEmojiText(filter.title),\r\n        subtitle: description,\r\n        clickable: true\r\n      });\r\n\r\n      if(d.length) {\r\n        join(d).forEach((el) => {\r\n          row.subtitle.append(el);\r\n        });\r\n      }\r\n  \r\n      if(dialogFilter._ === 'dialogFilter') {\r\n        const filterId = filter.id;\r\n        if(!this.filtersRendered.hasOwnProperty(filter.id)) {\r\n          attachClickEvent(row.container, async() => {\r\n            this.slider.createTab(AppEditFolderTab).open(await this.managers.filtersStorage.getFilter(filterId));\r\n          }, {listenerSetter: this.listenerSetter});\r\n        }\r\n\r\n        this.filtersRendered[filter.id] = row;\r\n      }\r\n    } else {\r\n      row.subtitle.textContent = '';\r\n      join(d).forEach((el) => {\r\n        row.subtitle.append(el);\r\n      });\r\n    }\r\n\r\n    div = row.container;\r\n\r\n    if((filter as MyDialogFilter).hasOwnProperty('orderIndex')) {\r\n       // ! header will be at 0 index\r\n      positionElementByIndex(div, div.parentElement || container, (filter as MyDialogFilter).orderIndex);\r\n    } else if(container) container.append(div);\r\n    \r\n    return div;\r\n  }\r\n\r\n  protected async init() {\r\n    this.container.classList.add('chat-folders-container');\r\n    this.setTitle('ChatList.Filter.List.Title');\r\n\r\n    this.scrollable.container.classList.add('chat-folders');\r\n\r\n    this.stickerContainer = document.createElement('div');\r\n    this.stickerContainer.classList.add('sticker-container');\r\n    \r\n    const caption = document.createElement('div');\r\n    caption.classList.add('caption');\r\n    i18n_({element: caption, key: 'ChatList.Filter.Header'});\r\n    \r\n    this.createFolderBtn = Button('btn-primary btn-color-primary btn-control tgico', {\r\n      text: 'ChatList.Filter.NewTitle',\r\n      icon: 'add'\r\n    });\r\n\r\n    this.foldersSection = new SettingSection({\r\n      name: 'Filters'\r\n    });\r\n    this.foldersSection.container.style.display = 'none';\r\n\r\n    this.suggestedSection = new SettingSection({\r\n      name: 'FilterRecommended'\r\n    });\r\n    this.suggestedSection.container.style.display = 'none';\r\n\r\n    this.scrollable.append(this.stickerContainer, caption, this.createFolderBtn, this.foldersSection.container, this.suggestedSection.container);\r\n\r\n    attachClickEvent(this.createFolderBtn, async() => {\r\n      const appConfig = await this.managers.apiManager.getAppConfig();\r\n      if(Object.keys(this.filtersRendered).length >= (rootScope.premium ? appConfig.dialog_filters_limit_premium : appConfig.dialog_filters_limit_default)) {\r\n        toast('Sorry, you can\\'t create more folders.');\r\n      } else {\r\n        this.slider.createTab(AppEditFolderTab).open();\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const onFiltersContainerUpdate = () => {\r\n      this.foldersSection.container.style.display = Object.keys(this.filtersRendered).length ? '' : 'none';\r\n    };\r\n\r\n    this.managers.filtersStorage.getDialogFilters().then(async(filters) => {\r\n      for(const filter of filters) {\r\n        await this.renderFolder(filter, this.foldersSection.content);\r\n      }\r\n\r\n      onFiltersContainerUpdate();\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('filter_update', async(filter) => {\r\n      if(this.filtersRendered.hasOwnProperty(filter.id)) {\r\n        await this.renderFolder(filter, null, this.filtersRendered[filter.id]);\r\n      } else {\r\n        await this.renderFolder(filter, this.foldersSection.content);\r\n      }\r\n\r\n      onFiltersContainerUpdate();\r\n\r\n      this.getSuggestedFilters();\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('filter_delete', (filter) => {\r\n      if(this.filtersRendered.hasOwnProperty(filter.id)) {\r\n        /* for(const suggested of this.suggestedFilters) {\r\n          if(deepEqual(suggested.filter, filter)) {\r\n            \r\n          }\r\n        } */\r\n        this.getSuggestedFilters();\r\n\r\n        this.filtersRendered[filter.id].container.remove();\r\n        delete this.filtersRendered[filter.id];\r\n      }\r\n\r\n      onFiltersContainerUpdate();\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('filter_order', (order) => {\r\n      order.forEach((filterId, idx) => {\r\n        const container = this.filtersRendered[filterId].container;\r\n        positionElementByIndex(container, container.parentElement, idx + 1); // ! + 1 due to header \r\n      });\r\n    });\r\n\r\n    this.loadAnimationPromise = lottieLoader.loadAnimationAsAsset({\r\n      container: this.stickerContainer,\r\n      loop: false,\r\n      autoplay: false,\r\n      width: 86,\r\n      height: 86\r\n    }, 'Folders_1').then((player) => {\r\n      this.animation = player;\r\n\r\n      return lottieLoader.waitForFirstFrame(player);\r\n    });\r\n\r\n    this.getSuggestedFilters()\r\n\r\n    /* return Promise.all([\r\n      this.loadAnimationPromise\r\n    ]); */\r\n    return this.loadAnimationPromise;\r\n  }\r\n\r\n  onOpenAfterTimeout() {\r\n    this.loadAnimationPromise.then(() => {\r\n      this.animation.autoplay = true;\r\n      this.animation.play();\r\n    });\r\n  }\r\n\r\n  private getSuggestedFilters() {\r\n    return this.managers.filtersStorage.getSuggestedDialogsFilters().then(async(suggestedFilters) => {\r\n      this.suggestedSection.container.style.display = suggestedFilters.length ? '' : 'none';\r\n      Array.from(this.suggestedSection.content.children).slice(1).forEach((el) => el.remove());\r\n\r\n      for(const filter of suggestedFilters) {\r\n        const div = await this.renderFolder(filter);\r\n        const button = Button('btn-primary btn-color-primary', {text: 'Add'});\r\n        div.append(button);\r\n        this.suggestedSection.content.append(div);\r\n\r\n        attachClickEvent(button, (e) => {\r\n          cancelEvent(e);\r\n\r\n          if(Object.keys(this.filtersRendered).length >= 10) {\r\n            toast('Sorry, you can\\'t create more folders.');\r\n            return;\r\n          }\r\n\r\n          button.setAttribute('disabled', 'true');\r\n\r\n          const f = filter.filter as MyDialogFilter;\r\n          f.includePeerIds = [];\r\n          f.excludePeerIds = [];\r\n          f.pinnedPeerIds = [];\r\n\r\n          this.managers.filtersStorage.createDialogFilter(f, true).then((bool) => {\r\n            if(bool) {\r\n              div.remove();\r\n            }\r\n          }).finally(() => {\r\n            button.removeAttribute('disabled');\r\n          });\r\n        }, {listenerSetter: this.listenerSetter});\r\n      }\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"..\";\r\nimport Row from \"../../row\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport { InputNotifyPeer, Update } from \"../../../layer\";\r\nimport { SliderSuperTabEventable } from \"../../sliderTab\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport { LangPackKey } from \"../../../lib/langPack\";\r\nimport copy from \"../../../helpers/object/copy\";\r\nimport convertKeyToInputKey from \"../../../helpers/string/convertKeyToInputKey\";\r\nimport { MUTE_UNTIL } from \"../../../lib/mtproto/mtproto_config\";\r\nimport apiManagerProxy from \"../../../lib/mtproto/mtprotoworker\";\r\n\r\ntype InputNotifyKey = Exclude<InputNotifyPeer['_'], 'inputNotifyPeer'>;\r\n\r\nexport default class AppNotificationsTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('notifications-container', 'with-border');\r\n    this.setTitle('Telegram.NotificationSettingsViewController');\r\n\r\n    const NotifySection = (options: {\r\n      name: LangPackKey,\r\n      typeText: LangPackKey,\r\n      inputKey: InputNotifyKey,\r\n    }) => {\r\n      const section = new SettingSection({\r\n        name: options.name\r\n      });\r\n\r\n      const enabledRow = new Row({\r\n        checkboxField: new CheckboxField({text: options.typeText, checked: true}),\r\n        subtitleLangKey: 'Loading',\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n      \r\n      const previewEnabledRow = new Row({\r\n        checkboxField: new CheckboxField({text: 'MessagePreview', checked: true}),\r\n        subtitleLangKey: 'Loading',\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      section.content.append(enabledRow.container, previewEnabledRow.container);\r\n\r\n      this.scrollable.append(section.container);\r\n\r\n      const inputNotifyPeer = {_: options.inputKey};\r\n      const ret = this.managers.appNotificationsManager.getNotifySettings(inputNotifyPeer);\r\n      (ret instanceof Promise ? ret : Promise.resolve(ret)).then((notifySettings) => {\r\n        const applySettings = async() => {\r\n          const muted = await this.managers.appNotificationsManager.isMuted(notifySettings);\r\n          enabledRow.checkboxField.checked = !muted;\r\n          previewEnabledRow.checkboxField.checked = notifySettings.show_previews;\r\n  \r\n          return muted;\r\n        };\r\n        \r\n        applySettings();\r\n\r\n        this.eventListener.addEventListener('destroy', async() => {\r\n          const mute = !enabledRow.checkboxField.checked;\r\n          const showPreviews = previewEnabledRow.checkboxField.checked;\r\n\r\n          if(mute === (await this.managers.appNotificationsManager.isMuted(notifySettings)) && showPreviews === notifySettings.show_previews) {\r\n            return;\r\n          }\r\n\r\n          const inputSettings: any = copy(notifySettings);\r\n          inputSettings._ = 'inputPeerNotifySettings';\r\n          inputSettings.mute_until = mute ? MUTE_UNTIL : 0;\r\n          inputSettings.show_previews = showPreviews;\r\n\r\n          this.managers.appNotificationsManager.updateNotifySettings(inputNotifyPeer, inputSettings);\r\n        }, {once: true});\r\n\r\n        this.listenerSetter.add(rootScope)('notify_settings', (update: Update.updateNotifySettings) => {\r\n          const inputKey = convertKeyToInputKey(update.peer._) as any;\r\n          if(options.inputKey === inputKey) {\r\n            notifySettings = update.notify_settings;\r\n            applySettings();\r\n          }\r\n        });\r\n      });\r\n    };\r\n\r\n    NotifySection({\r\n      name: 'NotificationsPrivateChats',\r\n      typeText: 'NotificationsForPrivateChats',\r\n      inputKey: 'inputNotifyUsers'\r\n    });\r\n\r\n    NotifySection({\r\n      name: 'NotificationsGroups',\r\n      typeText: 'NotificationsForGroups',\r\n      inputKey: 'inputNotifyChats'\r\n    });\r\n\r\n    NotifySection({\r\n      name: 'NotificationsChannels',\r\n      typeText: 'NotificationsForChannels',\r\n      inputKey: 'inputNotifyBroadcasts'\r\n    });\r\n\r\n    {\r\n      const section = new SettingSection({\r\n        name: 'NotificationsOther'\r\n      });\r\n\r\n      const contactsSignUpRow = new Row({\r\n        checkboxField: new CheckboxField({text: 'ContactJoined', checked: true}),\r\n        subtitleLangKey: 'Loading',\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n      \r\n      const soundRow = new Row({\r\n        checkboxField: new CheckboxField({text: 'Notifications.Sound', checked: true, stateKey: 'settings.notifications.sound', listenerSetter: this.listenerSetter}),\r\n        subtitleLangKey: 'Loading',\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      apiManagerProxy.getState().then((state) => {\r\n        soundRow.checkboxField.checked = state.settings.notifications.sound;\r\n      });\r\n\r\n      section.content.append(contactsSignUpRow.container, soundRow.container);\r\n\r\n      this.scrollable.append(section.container);\r\n\r\n      this.managers.appNotificationsManager.getContactSignUpNotification().then((enabled) => {\r\n        contactsSignUpRow.checkboxField.checked = enabled;\r\n\r\n        this.eventListener.addEventListener('destroy', () => {\r\n          const _enabled = contactsSignUpRow.checkboxField.checked;\r\n          if(enabled !== _enabled) {\r\n            this.managers.appNotificationsManager.setContactSignUpNotification(!_enabled);\r\n          }\r\n        }, {once: true});\r\n      });\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"..\";\r\nimport { randomLong } from \"../../../helpers/random\";\r\nimport I18n from \"../../../lib/langPack\";\r\nimport RadioField from \"../../radioField\";\r\nimport Row, { RadioFormFromRows } from \"../../row\";\r\nimport { SliderSuperTab } from \"../../slider\"\r\n\r\nexport default class AppLanguageTab extends SliderSuperTab {\r\n  protected async init() {\r\n    this.header.classList.add('with-border');\r\n    this.container.classList.add('language-container');\r\n    this.setTitle('Telegram.LanguageViewController');\r\n\r\n    const section = new SettingSection({});\r\n\r\n    const radioRows: Map<string, Row> = new Map();\r\n\r\n    const promise = Promise.all([\r\n      this.managers.apiManager.invokeApiCacheable('langpack.getLanguages', {\r\n        lang_pack: 'web'\r\n      }),\r\n      this.managers.apiManager.invokeApiCacheable('langpack.getLanguages', {\r\n        lang_pack: 'macos'\r\n      }),\r\n    ]).then(([languages1, languages2]) => {\r\n      const rendered: Set<string> = new Set();\r\n      const webLangCodes = languages1.map((language) => language.lang_code);\r\n\r\n      const random = randomLong();\r\n      languages1.concat(languages2).forEach((language) => {\r\n        if(rendered.has(language.lang_code)) return;\r\n        rendered.add(language.lang_code);\r\n\r\n        const row = new Row({\r\n          radioField: new RadioField({\r\n            text: language.name, \r\n            name: random, \r\n            value: language.lang_code\r\n          }),\r\n          subtitle: language.native_name\r\n        });\r\n        \r\n        radioRows.set(language.lang_code, row);\r\n      });\r\n\r\n      const form = RadioFormFromRows([...radioRows.values()], (value) => {\r\n        I18n.getLangPack(value, webLangCodes.includes(value));\r\n      });\r\n  \r\n      I18n.getCacheLangPack().then((langPack) => {\r\n        const row = radioRows.get(langPack.lang_code);\r\n        if(!row) {\r\n          console.error('no row', row, langPack);\r\n          return;\r\n        }\r\n  \r\n        row.radioField.setValueSilently(true);\r\n      });\r\n  \r\n      section.content.append(form);\r\n    });\r\n\r\n    this.scrollable.append(section.container);\r\n\r\n    return promise;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SettingSection } from \"../..\";\r\nimport ListenerSetter from \"../../../../helpers/listenerSetter\";\r\nimport { LangPackKey } from \"../../../../lib/langPack\";\r\nimport CheckboxField from \"../../../checkboxField\";\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\n\r\nexport function autoDownloadPeerTypeSection(type: 'photo' | 'video' | 'file', title: LangPackKey, listenerSetter: ListenerSetter) {\r\n  const section = new SettingSection({name: title});\r\n\r\n  const key = 'settings.autoDownload.' + type + '.';\r\n  const contactsCheckboxField = new CheckboxField({\r\n    text: 'AutodownloadContacts', \r\n    name: 'contacts',\r\n    stateKey: key + 'contacts',\r\n    withRipple: true,\r\n    listenerSetter\r\n  });\r\n  const privateCheckboxField = new CheckboxField({\r\n    text: 'AutodownloadPrivateChats', \r\n    name: 'private',\r\n    stateKey: key + 'private',\r\n    withRipple: true,\r\n    listenerSetter\r\n  });\r\n  const groupsCheckboxField = new CheckboxField({\r\n    text: 'AutodownloadGroupChats', \r\n    name: 'groups',\r\n    stateKey: key + 'groups',\r\n    withRipple: true,\r\n    listenerSetter\r\n  });\r\n  const channelsCheckboxField = new CheckboxField({\r\n    text: 'AutodownloadChannels', \r\n    name: 'channels',\r\n    stateKey: key + 'channels',\r\n    withRipple: true,\r\n    listenerSetter\r\n  });\r\n\r\n  section.content.append(\r\n    contactsCheckboxField.label, \r\n    privateCheckboxField.label, \r\n    groupsCheckboxField.label, \r\n    channelsCheckboxField.label\r\n  );\r\n\r\n  return section;\r\n}\r\n\r\nexport default class AppAutoDownloadPhotoTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.setTitle('AutoDownloadPhotos');\r\n\r\n    const section = autoDownloadPeerTypeSection('photo', 'AutoDownloadPhotosTitle', this.listenerSetter);\r\n    this.scrollable.append(section.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport formatBytes from \"../../../../helpers/formatBytes\";\r\nimport debounce from \"../../../../helpers/schedulers/debounce\";\r\nimport I18n from \"../../../../lib/langPack\";\r\nimport rootScope from \"../../../../lib/rootScope\";\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport { RangeSettingSelector } from \"../generalSettings\";\r\nimport { autoDownloadPeerTypeSection } from \"./photo\";\r\n\r\nexport default class AppAutoDownloadFileTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.setTitle('AutoDownloadFiles');\r\n\r\n    const debouncedSave = debounce((sizeMax: number) => {\r\n      this.managers.appStateManager.setByKey('settings.autoDownloadNew.file_size_max', sizeMax);\r\n    }, 200, false, true);\r\n\r\n    const section = autoDownloadPeerTypeSection('file', 'AutoDownloadFilesTitle', this.listenerSetter);\r\n\r\n    const MIN = 512 * 1024;\r\n    // const MAX = 2 * 1024 * 1024 * 1024;\r\n    const MAX = 20 * 1024 * 1024;\r\n    const MAX_RANGE = MAX - MIN;\r\n\r\n    const sizeMax = rootScope.settings.autoDownloadNew.file_size_max;\r\n    const value = Math.sqrt(Math.sqrt((sizeMax - MIN) / MAX_RANGE));\r\n    const upTo = new I18n.IntlElement({\r\n      key: 'AutodownloadSizeLimitUpTo',\r\n      args: [formatBytes(sizeMax)]\r\n    });\r\n    const range = new RangeSettingSelector('AutoDownloadMaxFileSize', 0.01, value, 0, 1, false);\r\n    range.onChange = (value) => {\r\n      const sizeMax = (value ** 4 * MAX_RANGE + MIN) | 0;\r\n\r\n      upTo.compareAndUpdate({args: [formatBytes(sizeMax)]});\r\n\r\n      debouncedSave(sizeMax);\r\n    };\r\n\r\n    range.valueContainer.append(upTo.element);\r\n\r\n    section.content.append(range.container);\r\n\r\n    this.scrollable.append(section.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTabEventable } from \"../../../sliderTab\";\r\nimport { autoDownloadPeerTypeSection } from \"./photo\";\r\n\r\nexport default class AppAutoDownloadVideoTab extends SliderSuperTabEventable {\r\n  protected init() {\r\n    this.header.classList.add('with-border');\r\n    this.setTitle('AutoDownloadVideos');\r\n\r\n    const section = autoDownloadPeerTypeSection('video', 'AutoDownloadVideosTitle', this.listenerSetter);\r\n    this.scrollable.append(section.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { AutoDownloadPeerTypeSettings, STATE_INIT } from \"../../../config/state\";\r\nimport { SettingSection } from \"..\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport replaceContent from \"../../../helpers/dom/replaceContent\";\r\nimport toggleDisability from \"../../../helpers/dom/toggleDisability\";\r\nimport formatBytes from \"../../../helpers/formatBytes\";\r\nimport copy from \"../../../helpers/object/copy\";\r\nimport deepEqual from \"../../../helpers/object/deepEqual\";\r\nimport { FormatterArguments, i18n, join, LangPackKey } from \"../../../lib/langPack\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport Button from \"../../button\";\r\nimport CheckboxField from \"../../checkboxField\";\r\nimport confirmationPopup from \"../../confirmationPopup\";\r\nimport Row from \"../../row\";\r\nimport { SliderSuperTabEventable, SliderSuperTabEventableConstructable } from \"../../sliderTab\";\r\nimport AppAutoDownloadFileTab from \"./autoDownload/file\";\r\nimport AppAutoDownloadPhotoTab from \"./autoDownload/photo\";\r\nimport AppAutoDownloadVideoTab from \"./autoDownload/video\";\r\nimport apiManagerProxy from \"../../../lib/mtproto/mtprotoworker\";\r\n\r\nconst AUTO_DOWNLOAD_FOR_KEYS: {[k in keyof AutoDownloadPeerTypeSettings]: LangPackKey} = {\r\n  contacts: 'AutoDownloadContacts',\r\n  private: 'AutoDownloadPm',\r\n  groups: 'AutoDownloadGroups',\r\n  channels: 'AutoDownloadChannels'\r\n};\r\n\r\nexport default class AppDataAndStorageTab extends SliderSuperTabEventable {\r\n  protected async init() {\r\n    this.header.classList.add('with-border');\r\n    this.setTitle('DataSettings');\r\n\r\n    {\r\n      const section = new SettingSection({name: 'AutomaticMediaDownload', caption: 'AutoDownloadAudioInfo'});\r\n\r\n      const state = await apiManagerProxy.getState();\r\n\r\n      const autoCheckboxField = new CheckboxField({\r\n        text: 'AutoDownloadMedia', \r\n        name: 'auto',\r\n        checked: !state.settings.autoDownloadNew.pFlags.disabled,\r\n        withRipple: true\r\n      });\r\n\r\n      const onChange = () => {\r\n        toggleDisability([resetButton], \r\n          deepEqual(state.settings.autoDownload, STATE_INIT.settings.autoDownload) && \r\n          deepEqual(state.settings.autoDownloadNew, STATE_INIT.settings.autoDownloadNew));\r\n      };\r\n\r\n      const setSubtitles = () => {\r\n        this.setAutoDownloadSubtitle(photoRow, state.settings.autoDownload.photo, /* state.settings.autoDownloadNew.photo_size_max */);\r\n        this.setAutoDownloadSubtitle(videoRow, state.settings.autoDownload.video/* , state.settings.autoDownloadNew.video_size_max */);\r\n        this.setAutoDownloadSubtitle(fileRow, state.settings.autoDownload.file, state.settings.autoDownloadNew.file_size_max);\r\n      };\r\n\r\n      const openTab = (tabConstructor: SliderSuperTabEventableConstructable) => {\r\n        const tab = new tabConstructor(this.slider, true);\r\n        tab.open();\r\n\r\n        this.listenerSetter.add(tab.eventListener)('destroy', () => {\r\n          setSubtitles();\r\n          onChange();\r\n        }, {once: true});\r\n      };\r\n      \r\n      const photoRow = new Row({\r\n        titleLangKey: 'AutoDownloadPhotos',\r\n        subtitle: '',\r\n        clickable: () => {\r\n          openTab(AppAutoDownloadPhotoTab);\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      const videoRow = new Row({\r\n        titleLangKey: 'AutoDownloadVideos',\r\n        subtitle: '',\r\n        clickable: () => {\r\n          openTab(AppAutoDownloadVideoTab);\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      const fileRow = new Row({\r\n        titleLangKey: 'AutoDownloadFiles',\r\n        subtitle: '',\r\n        clickable: () => {\r\n          openTab(AppAutoDownloadFileTab);\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      const resetButton = Button('btn-primary btn-transparent primary', {icon: 'delete', text: 'ResetAutomaticMediaDownload'});\r\n      attachClickEvent(resetButton, () => {\r\n        confirmationPopup({\r\n          titleLangKey: 'ResetAutomaticMediaDownloadAlertTitle',\r\n          descriptionLangKey: 'ResetAutomaticMediaDownloadAlert',\r\n          button: {\r\n            langKey: 'Reset'\r\n          }\r\n        }).then(() => {\r\n          const settings = rootScope.settings;\r\n          settings.autoDownloadNew = copy(STATE_INIT.settings.autoDownloadNew);\r\n          settings.autoDownload = copy(STATE_INIT.settings.autoDownload);\r\n          this.managers.appStateManager.setByKey('settings', settings);\r\n\r\n          setSubtitles();\r\n          autoCheckboxField.checked = !state.settings.autoDownloadNew.pFlags.disabled;\r\n        });\r\n      });\r\n\r\n      const onDisabledChange = () => {\r\n        const disabled = !autoCheckboxField.checked;\r\n\r\n        const settings = rootScope.settings;\r\n        if(disabled) {\r\n          settings.autoDownloadNew.pFlags.disabled = true;\r\n        } else {\r\n          delete settings.autoDownloadNew.pFlags.disabled;\r\n        }\r\n\r\n        [photoRow, videoRow, fileRow].forEach((row) => {\r\n          row.container.classList.toggle('is-disabled', disabled);\r\n        });\r\n        \r\n        this.managers.appStateManager.setByKey('settings', settings);\r\n\r\n        onChange();\r\n      };\r\n\r\n      autoCheckboxField.input.addEventListener('change', onDisabledChange);\r\n      onDisabledChange();\r\n      setSubtitles();\r\n\r\n      section.content.append(\r\n        autoCheckboxField.label,\r\n        photoRow.container,\r\n        videoRow.container,\r\n        fileRow.container,\r\n        resetButton\r\n      );\r\n      \r\n      this.scrollable.append(section.container);\r\n    }\r\n\r\n    {\r\n      const section = new SettingSection({name: 'AutoplayMedia'});\r\n\r\n      const gifsCheckboxField = new CheckboxField({\r\n        text: 'AutoplayGIF', \r\n        name: 'gifs', \r\n        stateKey: 'settings.autoPlay.gifs',\r\n        withRipple: true,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n      const videosCheckboxField = new CheckboxField({\r\n        text: 'AutoplayVideo', \r\n        name: 'videos', \r\n        stateKey: 'settings.autoPlay.videos',\r\n        withRipple: true,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      section.content.append(gifsCheckboxField.label, videosCheckboxField.label);\r\n\r\n      this.scrollable.append(section.container);\r\n    }\r\n  }\r\n\r\n  private setAutoDownloadSubtitle(row: Row, settings: AutoDownloadPeerTypeSettings, sizeMax?: number) {\r\n    let key: LangPackKey, args: FormatterArguments = [];\r\n    \r\n    const peerKeys = Object.keys(settings) as (keyof typeof AUTO_DOWNLOAD_FOR_KEYS)[];\r\n    const enabledKeys = peerKeys.map((key) => settings[key] ? AUTO_DOWNLOAD_FOR_KEYS[key] : undefined).filter(Boolean);\r\n    if(!enabledKeys.length || sizeMax === 0) {\r\n      key = 'AutoDownloadOff';\r\n    } else {\r\n      const isAll = enabledKeys.length === peerKeys.length;\r\n      if(sizeMax !== undefined) {\r\n        key = isAll ? 'AutoDownloadUpToOnAllChats' : 'AutoDownloadOnUpToFor';\r\n        args.push(formatBytes(sizeMax));\r\n      } else {\r\n        key = isAll ? 'AutoDownloadOnAllChats' : 'AutoDownloadOnFor';\r\n      }\r\n  \r\n      if(!isAll) {\r\n        const fragment = document.createElement('span');\r\n        fragment.append(...join(enabledKeys.map((key) => i18n(key)), true, false));\r\n        args.push(fragment);\r\n      }\r\n    }\r\n    \r\n    replaceContent(row.subtitle, i18n(key, args));\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport ButtonMenuToggle from \"../../buttonMenuToggle\";\r\nimport Button from \"../../button\";\r\nimport AppPrivacyAndSecurityTab from \"./privacyAndSecurity\";\r\nimport AppGeneralSettingsTab from \"./generalSettings\";\r\nimport AppEditProfileTab from \"./editProfile\";\r\nimport AppChatFoldersTab from \"./chatFolders\";\r\nimport AppNotificationsTab from \"./notifications\";\r\nimport AppLanguageTab from \"./language\";\r\nimport lottieLoader from \"../../../lib/rlottie/lottieLoader\";\r\nimport PopupPeer from \"../../popups/peer\";\r\nimport AppDataAndStorageTab from \"./dataAndStorage\";\r\nimport ButtonIcon from \"../../buttonIcon\";\r\nimport PeerProfile from \"../../peerProfile\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport { SettingSection } from \"..\";\r\nimport Row from \"../../row\";\r\nimport AppActiveSessionsTab from \"./activeSessions\";\r\nimport { i18n, LangPackKey } from \"../../../lib/langPack\";\r\nimport { SliderSuperTabConstructable } from \"../../sliderTab\";\r\nimport PopupAvatar from \"../../popups/avatar\";\r\nimport { AccountAuthorizations, Authorization } from \"../../../layer\";\r\nimport PopupElement from \"../../popups\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\n//import AppMediaViewer from \"../../appMediaViewerNew\";\r\n\r\nexport default class AppSettingsTab extends SliderSuperTab {\r\n  private buttons: {\r\n    edit: HTMLButtonElement,\r\n    folders: HTMLButtonElement,\r\n    general: HTMLButtonElement,\r\n    notifications: HTMLButtonElement,\r\n    storage: HTMLButtonElement,\r\n    privacy: HTMLButtonElement,\r\n  } = {} as any;\r\n  private profile: PeerProfile;\r\n\r\n  private languageRow: Row;\r\n  private devicesRow: Row;\r\n\r\n  private authorizations: Authorization.authorization[];\r\n  private getAuthorizationsPromise: Promise<AccountAuthorizations.accountAuthorizations>;\r\n\r\n  protected async init() {\r\n    this.container.classList.add('settings-container');\r\n    this.setTitle('Settings');\r\n    \r\n    const btnMenu = ButtonMenuToggle({listenerSetter: this.listenerSetter}, 'bottom-left', [{\r\n      icon: 'logout',\r\n      text: 'EditAccount.Logout',\r\n      onClick: () => {\r\n        new PopupPeer('logout', {\r\n          titleLangKey: 'LogOut',\r\n          descriptionLangKey: 'LogOut.Description',\r\n          buttons: [{\r\n            langKey: 'LogOut',\r\n            callback: () => {\r\n              this.managers.apiManager.logOut();\r\n            },\r\n            isDanger: true\r\n          }]\r\n        }).show();\r\n      }\r\n    }]);\r\n\r\n    this.buttons.edit = ButtonIcon('edit');\r\n\r\n    this.header.append(this.buttons.edit, btnMenu);\r\n\r\n    this.profile = new PeerProfile(this.managers, this.scrollable, this.listenerSetter, false);\r\n    this.profile.init();\r\n    this.profile.setPeer(rootScope.myId);\r\n    const fillPromise = this.profile.fillProfileElements();\r\n\r\n    const changeAvatarBtn = Button('btn-circle btn-corner z-depth-1 profile-change-avatar', {icon: 'cameraadd'});\r\n    attachClickEvent(changeAvatarBtn, () => {\r\n      const canvas = document.createElement('canvas');\r\n      PopupElement.createPopup(PopupAvatar).open(canvas, (upload) => {\r\n        upload().then((inputFile) => {\r\n          return this.managers.appProfileManager.uploadProfilePhoto(inputFile);\r\n        });\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n    this.profile.element.lastElementChild.firstElementChild.append(changeAvatarBtn);\r\n    \r\n    const updateChangeAvatarBtn = async() => {\r\n      const user = await this.managers.appUsersManager.getSelf();\r\n      changeAvatarBtn.classList.toggle('hide', user.photo?._ !== 'userProfilePhoto');\r\n    };\r\n    \r\n    updateChangeAvatarBtn();\r\n    this.listenerSetter.add(rootScope)('avatar_update', (peerId) => {\r\n      if(rootScope.myId === peerId) {\r\n        updateChangeAvatarBtn();\r\n      }\r\n    });\r\n\r\n    /* const div = document.createElement('div');\r\n    //div.style.cssText = 'border-radius: 8px; overflow: hidden; width: 396px; height: 264px; flex: 0 0 auto; position: relative; margin: 10rem 0 10rem auto;';\r\n    //div.style.width = '135px';\r\n    //div.style.height = '100px';\r\n    div.style.cssText = 'border-radius: 8px; overflow: hidden; width: 396px; height: 264px; flex: 0 0 auto; position: relative; margin: 10rem auto 10rem 0;';\r\n    div.style.width = '135px';\r\n    div.style.height = '100px';\r\n    \r\n    const img = document.createElement('img');\r\n    img.src = 'assets/img/pepe.jpg';\r\n    img.classList.add('media-photo');\r\n    img.style.cssText = 'max-width: 100%;max-height: 100%;';\r\n\r\n    div.append(img);\r\n\r\n    div.addEventListener('click', () => {\r\n      new AppMediaViewer().setSearchContext({peerId: 61004386, inputFilter: 'inputMessagesFilterPhotos'}).openMedia({\r\n        _: 'message',\r\n        mid: 1,\r\n        peerId: 61004386,\r\n        fromId: 61004386,\r\n        message: '',\r\n        media: {\r\n          _: 'messageMediaPhoto',\r\n          photo: {\r\n            _: 'photo',\r\n            url: img.src,\r\n            downloaded: 111,\r\n            sizes: [{\r\n              _: 'photoSize',\r\n              type: 'x',\r\n              w: 618,\r\n              h: 412\r\n            }]\r\n          }\r\n        },\r\n        date: Date.now() / 1000 | 0\r\n      }, img);\r\n    });\r\n\r\n    this.scrollable.append(div); */\r\n    \r\n    const buttonsDiv = document.createElement('div');\r\n    buttonsDiv.classList.add('profile-buttons');\r\n\r\n    const b: [string, LangPackKey, SliderSuperTabConstructable][] = [\r\n      ['unmute', 'AccountSettings.Notifications', AppNotificationsTab],\r\n      ['data', 'DataSettings', AppDataAndStorageTab],\r\n      ['lock', 'AccountSettings.PrivacyAndSecurity', AppPrivacyAndSecurityTab],\r\n      ['settings', 'Telegram.GeneralSettingsViewController', AppGeneralSettingsTab],\r\n      ['folder', 'AccountSettings.Filters', AppChatFoldersTab],\r\n    ];\r\n\r\n    const rows = b.map(([icon, langPackKey, tabConstructor]) => {\r\n      return new Row({\r\n        titleLangKey: langPackKey,\r\n        icon,\r\n        clickable: () => {\r\n          this.slider.createTab(tabConstructor).open();\r\n          // new tabConstructor(this.slider, true).open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n    });\r\n\r\n    rows.push(\r\n      this.devicesRow = new Row({\r\n        titleLangKey: 'Devices',\r\n        titleRightSecondary: ' ',\r\n        icon: 'activesessions',\r\n        clickable: async() => {\r\n          if(!this.authorizations) {\r\n            await this.updateActiveSessions();\r\n          }\r\n\r\n          const tab = this.slider.createTab(AppActiveSessionsTab);\r\n          tab.authorizations = this.authorizations;\r\n          tab.eventListener.addEventListener('destroy', () => {\r\n            this.authorizations = undefined;\r\n            this.updateActiveSessions(true);\r\n          }, {once: true});\r\n          tab.open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      }),\r\n\r\n      this.languageRow = new Row({\r\n        titleLangKey: 'AccountSettings.Language',\r\n        titleRightSecondary: i18n('LanguageName'),\r\n        icon: 'language',\r\n        clickable: () => {\r\n          this.slider.createTab(AppLanguageTab).open();\r\n        },\r\n        listenerSetter: this.listenerSetter\r\n      })\r\n    );\r\n\r\n    buttonsDiv.append(...rows.map((row) => row.container));\r\n\r\n    // const profileSection = new SettingSection({fullWidth: true, noPaddingTop: true});\r\n    // profileSection.content.append(this.profile.element);\r\n\r\n    const buttonsSection = new SettingSection();\r\n    buttonsSection.content.append(buttonsDiv);\r\n\r\n    this.scrollable.append(this.profile.element/* profileSection.container */, buttonsSection.container);\r\n\r\n    attachClickEvent(this.buttons.edit, () => {\r\n      const tab = this.slider.createTab(AppEditProfileTab);\r\n      tab.open();\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    lottieLoader.loadLottieWorkers();\r\n\r\n    this.updateActiveSessions();\r\n\r\n    await fillPromise;\r\n  }\r\n\r\n  private getAuthorizations(overwrite?: boolean) {\r\n    if(this.getAuthorizationsPromise && !overwrite) return this.getAuthorizationsPromise;\r\n\r\n    const promise = this.getAuthorizationsPromise = this.managers.apiManager.invokeApi('account.getAuthorizations')\r\n    .finally(() => {\r\n      if(this.getAuthorizationsPromise === promise) {\r\n        this.getAuthorizationsPromise = undefined;\r\n      }\r\n    });\r\n\r\n    return promise;\r\n  }\r\n\r\n  public updateActiveSessions(overwrite?: boolean) {\r\n    return this.getAuthorizations(overwrite).then((auths) => {\r\n      this.authorizations = auths.authorizations;\r\n      this.devicesRow.titleRight.textContent = '' + this.authorizations.length;\r\n    });\r\n  }\r\n\r\n  public onCloseAfterTimeout() {\r\n    this.profile.destroy();\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appSidebarLeft, { SettingSection } from \"..\";\r\nimport { InputFile } from \"../../../layer\";\r\nimport InputField from \"../../inputField\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport AvatarEdit from \"../../avatarEdit\";\r\nimport AppAddMembersTab from \"./addMembers\";\r\nimport { _i18n } from \"../../../lib/langPack\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\n\r\nexport default class AppNewChannelTab extends SliderSuperTab {\r\n  private uploadAvatar: () => Promise<InputFile> = null;\r\n\r\n  private channelNameInputField: InputField;\r\n  private channelDescriptionInputField: InputField;\r\n  private nextBtn: HTMLButtonElement;\r\n  private avatarEdit: AvatarEdit;\r\n\r\n  protected init() {\r\n    this.container.classList.add('new-channel-container');\r\n    this.setTitle('NewChannel');\r\n\r\n    this.avatarEdit = new AvatarEdit((_upload) => {\r\n      this.uploadAvatar = _upload;\r\n    });\r\n\r\n    const section = new SettingSection({\r\n      caption: 'Channel.DescriptionHolderDescrpiton'\r\n    });\r\n\r\n    const inputWrapper = document.createElement('div');\r\n    inputWrapper.classList.add('input-wrapper');\r\n\r\n    this.channelNameInputField = new InputField({\r\n      label: 'EnterChannelName',\r\n      maxLength: 128\r\n    });\r\n\r\n    this.channelDescriptionInputField = new InputField({\r\n      label: 'DescriptionOptionalPlaceholder',\r\n      maxLength: 255\r\n    });\r\n\r\n    inputWrapper.append(this.channelNameInputField.container, this.channelDescriptionInputField.container);\r\n\r\n    const onLengthChange = () => {\r\n      this.nextBtn.classList.toggle('is-visible', !!this.channelNameInputField.value.length && \r\n        !this.channelNameInputField.input.classList.contains('error') && \r\n        !this.channelDescriptionInputField.input.classList.contains('error'));\r\n    };\r\n\r\n    this.channelNameInputField.input.addEventListener('input', onLengthChange);\r\n    this.channelDescriptionInputField.input.addEventListener('input', onLengthChange);\r\n\r\n    this.nextBtn = ButtonCorner({icon: 'arrow_next'});\r\n\r\n    attachClickEvent(this.nextBtn, () => {\r\n      const title = this.channelNameInputField.value;\r\n      const about = this.channelDescriptionInputField.value;\r\n\r\n      this.nextBtn.disabled = true;\r\n      this.managers.appChatsManager.createChannel({\r\n        title, \r\n        about,\r\n        broadcast: true\r\n      }).then((channelId) => {\r\n        if(this.uploadAvatar) {\r\n          this.uploadAvatar().then((inputFile) => {\r\n            this.managers.appChatsManager.editPhoto(channelId, inputFile);\r\n          });\r\n        }\r\n\r\n        appImManager.setInnerPeer({peerId: channelId.toPeerId(true)});\r\n        \r\n        appSidebarLeft.removeTabFromHistory(this);\r\n        this.slider.createTab(AppAddMembersTab).open({\r\n          type: 'channel',\r\n          skippable: true,\r\n          title: 'GroupAddMembers',\r\n          placeholder: 'SendMessageTo',\r\n          takeOut: (peerIds) => {\r\n            return this.managers.appChatsManager.inviteToChannel(channelId, peerIds);\r\n          }\r\n        });\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    this.content.append(this.nextBtn);\r\n    section.content.append(this.avatarEdit.container, inputWrapper);\r\n    this.scrollable.append(section.container);\r\n  }\r\n\r\n  public onCloseAfterTimeout() {\r\n    this.avatarEdit.clear();\r\n    this.uploadAvatar = null;\r\n    this.channelNameInputField.value = '';\r\n    this.channelDescriptionInputField.value = '';\r\n    this.nextBtn.disabled = false;\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport InputField from \"../inputField\";\r\nimport PopupElement from \".\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport EditPeer from \"../editPeer\";\r\nimport { _i18n } from \"../../lib/langPack\";\r\nimport TelInputField from \"../telInputField\";\r\nimport { formatPhoneNumber } from \"../../helpers/formatPhoneNumber\";\r\nimport { toastNew } from \"../toast\";\r\n\r\nexport default class PopupCreateContact extends PopupElement {\r\n  constructor() {\r\n    super('popup-create-contact popup-send-photo popup-new-media', {closable: true, withConfirm: 'Add', title: 'AddContactTitle'});\r\n    this.construct();\r\n  }\r\n\r\n  private async construct() {\r\n    attachClickEvent(this.btnConfirm, () => {\r\n      const promise = this.managers.appUsersManager.importContact(nameInputField.value, lastNameInputField.value, telInputField.value);\r\n\r\n      promise.then(() => {\r\n        this.hide();\r\n      }, (err) => {\r\n        if(err.type === 'NO_USER') {\r\n          toastNew({langPackKey: 'Contacts.PhoneNumber.NotRegistred'});\r\n          editPeer.disabled = false;\r\n        }\r\n      });\r\n\r\n      editPeer.lockWithPromise(promise);\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const inputFields: InputField[] = [];\r\n    const div = document.createElement('div');\r\n    div.classList.add('name-fields');\r\n    const nameInputField = new InputField({\r\n      label: 'FirstName',\r\n      name: 'create-contact-name',\r\n      maxLength: 70,\r\n      required: true\r\n    });\r\n    const lastNameInputField = new InputField({\r\n      label: 'LastName',\r\n      name: 'create-contact-lastname',\r\n      maxLength: 70\r\n    });\r\n    const telInputField = new TelInputField({required: true});\r\n    inputFields.push(nameInputField, lastNameInputField, telInputField);\r\n\r\n    const onInput = () => {\r\n      const name = nameInputField.value + ' ' + lastNameInputField.value;\r\n      // const abbr = getAbbreviation(name);\r\n      editPeer.avatarElem.peerTitle = name;\r\n      editPeer.avatarElem.update();\r\n    };\r\n\r\n    this.listenerSetter.add(nameInputField.input)('input', onInput);\r\n    this.listenerSetter.add(lastNameInputField.input)('input', onInput);\r\n\r\n    telInputField.validate = () => {\r\n      return !!telInputField.value.match(/\\d/);\r\n    };\r\n\r\n    const user = await this.managers.appUsersManager.getSelf();\r\n    const formatted = formatPhoneNumber(user.phone);\r\n    if(formatted.code) {\r\n      telInputField.value = '+' + formatted.code.country_code;\r\n    }\r\n\r\n    const editPeer = new EditPeer({\r\n      inputFields,\r\n      listenerSetter: this.listenerSetter,\r\n      doNotEditAvatar: true,\r\n      nextBtn: this.btnConfirm,\r\n      avatarSize: 100\r\n    });\r\n\r\n    div.append(nameInputField.container, lastNameInputField.container, editPeer.avatarElem);\r\n    this.container.append(div, telInputField.container);\r\n\r\n    this.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport InputSearch from \"../../inputSearch\";\r\nimport { IS_MOBILE } from \"../../../environment/userAgent\";\r\nimport { canFocus } from \"../../../helpers/dom/canFocus\";\r\nimport windowSize from \"../../../helpers/windowSize\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport PopupCreateContact from \"../../popups/createContact\";\r\nimport SortedUserList from \"../../sortedUserList\";\r\nimport { getMiddleware } from \"../../../helpers/middleware\";\r\nimport replaceContent from \"../../../helpers/dom/replaceContent\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport PopupElement from \"../../popups\";\r\n\r\n// TODO:    ,      \r\n\r\nexport default class AppContactsTab extends SliderSuperTab {\r\n  private inputSearch: InputSearch;\r\n  private middleware: ReturnType<typeof getMiddleware>;\r\n  private sortedUserList: SortedUserList;\r\n  \r\n  protected init() {\r\n    this.container.id = 'contacts-container';\r\n\r\n    // this.list = appDialogsManager.createChatList(/* {avatarSize: 48, handheldsSize: 66} */);\r\n\r\n    const btnAdd = ButtonCorner({icon: 'add', className: 'is-visible'});\r\n    this.content.append(btnAdd);\r\n\r\n    attachClickEvent(btnAdd, () => {\r\n      PopupElement.createPopup(PopupCreateContact);\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    this.inputSearch = new InputSearch('Search', (value) => {\r\n      this.openContacts(value);\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('contacts_update', async(userId) => {\r\n      const isContact = await this.managers.appUsersManager.isContact(userId);\r\n      const peerId = userId.toPeerId();\r\n      if(isContact) this.sortedUserList.add(peerId);\r\n      else this.sortedUserList.delete(peerId);\r\n    });\r\n\r\n    this.title.replaceWith(this.inputSearch.container);\r\n\r\n    this.middleware = getMiddleware();\r\n\r\n    // preload contacts\r\n    // appUsersManager.getContacts();\r\n  }\r\n\r\n  protected createList() {\r\n    const sortedUserList = new SortedUserList({\r\n      managers: this.managers\r\n    });\r\n    const list = sortedUserList.list;\r\n    list.id = 'contacts';\r\n    list.classList.add('contacts-container');\r\n    appDialogsManager.setListClickListener(list, () => {\r\n      this.close();\r\n    }, undefined, true);\r\n    return sortedUserList;\r\n  }\r\n\r\n  protected onClose() {\r\n    this.middleware.clean();\r\n    /* // need to clear, and left 1 page for smooth slide\r\n    let pageCount = appPhotosManager.windowH / 72 * 1.25 | 0;\r\n    (Array.from(this.list.children) as HTMLElement[]).slice(pageCount).forEach((el) => el.remove()); */\r\n  }\r\n\r\n  protected onOpenAfterTimeout() {\r\n    if(IS_MOBILE || !canFocus(true)) return;\r\n    this.inputSearch.input.focus();\r\n  }\r\n\r\n  public openContacts(query?: string) {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    this.middleware.clean();\r\n    const middleware = this.middleware.get();\r\n    this.scrollable.onScrolledBottom = null;\r\n    this.scrollable.container.textContent = '';\r\n\r\n    this.managers.appUsersManager.getContactsPeerIds(query, undefined, 'online').then((contacts) => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      const sortedUserList = this.sortedUserList = this.createList();\r\n\r\n      let renderPage = () => {\r\n        const pageCount = windowSize.height / 72 * 1.25 | 0;\r\n        const arr = contacts.splice(0, pageCount); //  splice!\r\n\r\n        arr.forEach((peerId) => {\r\n          sortedUserList.add(peerId);\r\n        });\r\n\r\n        if(!contacts.length) {\r\n          renderPage = undefined;\r\n          this.scrollable.onScrolledBottom = null;\r\n        }\r\n      };\r\n\r\n      renderPage();\r\n      this.scrollable.onScrolledBottom = () => {\r\n        if(renderPage) {\r\n          renderPage();\r\n        } else {\r\n          this.scrollable.onScrolledBottom = null;\r\n        }\r\n      };\r\n\r\n      replaceContent(this.scrollable.container, sortedUserList.list);\r\n    });\r\n  }\r\n\r\n  public open() {\r\n    this.openContacts();\r\n    return super.open();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport type { LOCAL_FOLDER_ID } from \"../../../lib/storages/dialogs\";\r\nimport type { MyDialogFilter } from \"../../../lib/storages/filters\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\n\r\nexport default class AppArchivedTab extends SliderSuperTab {\r\n  private static filterId: LOCAL_FOLDER_ID = 1;\r\n  private wasFilterId: number;\r\n\r\n  protected init() {\r\n    this.wasFilterId = appDialogsManager.filterId;\r\n\r\n    this.container.id = 'chats-archived-container';\r\n    this.setTitle('ArchivedChats');\r\n\r\n    if(!appDialogsManager.sortedLists[AppArchivedTab.filterId]) {\r\n      const chatList = appDialogsManager.createChatList();\r\n      appDialogsManager.generateScrollable(chatList, {id: AppArchivedTab.filterId, orderIndex: 1} as any as MyDialogFilter).container.append(chatList);\r\n      appDialogsManager.setListClickListener(chatList, null, true);\r\n      //appDialogsManager.setListClickListener(archivedChatList, null, true); // * to test peer changing\r\n    }\r\n\r\n    const scrollable = appDialogsManager.scrollables[AppArchivedTab.filterId];\r\n    this.scrollable.container.replaceWith(scrollable.container);\r\n    this.scrollable = scrollable;\r\n\r\n    return appDialogsManager.setFilterIdAndChangeTab(AppArchivedTab.filterId).then(({cached, renderPromise}) => {\r\n      if(cached) {\r\n        return renderPromise;\r\n      }\r\n    });\r\n  }\r\n\r\n  // ,   ,         ...\r\n  onOpenAfterTimeout() {\r\n    appDialogsManager.sortedLists[this.wasFilterId].clear();\r\n  }\r\n\r\n  onClose() {\r\n    appDialogsManager.setFilterIdAndChangeTab(this.wasFilterId);\r\n  }\r\n\r\n  onCloseAfterTimeout() {\r\n    appDialogsManager.sortedLists[AppArchivedTab.filterId].clear();\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport ButtonCorner from \"../../buttonCorner\";\r\nimport AppNewGroupTab from \"./newGroup\";\r\nimport { toast } from \"../../toast\";\r\nimport { ButtonMenuItemOptions } from \"../../buttonMenu\";\r\nimport { i18n, join, _i18n } from \"../../../lib/langPack\";\r\nimport rootScope from '../../../lib/rootScope';\r\nimport { wrapSticker } from \"../../wrappers\";\r\nimport SortedUserList from \"../../sortedUserList\";\r\nimport { PeerLocated, Update, Updates } from \"../../../layer\";\r\nimport { SettingChatListSection } from \"..\";\r\nimport appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport confirmationPopup from \"../../confirmationPopup\";\r\nimport getPeerId from \"../../../lib/appManagers/utils/peers/getPeerId\";\r\nimport type LazyLoadQueue from \"../../lazyLoadQueue\";\r\n\r\nexport default class AppPeopleNearbyTab extends SliderSuperTab {\r\n  private latestLocationSaved: {latitude: number, longitude: number, accuracy: number};\r\n  private isLocationWatched: boolean = false;\r\n  private errorCategory: HTMLElement;\r\n  private retryBtn: HTMLButtonElement;\r\n  private btnOptions: HTMLButtonElement;\r\n  private menuButtons: (ButtonMenuItemOptions & {verify?: () => boolean})[];\r\n\r\n  protected lazyLoadQueue: LazyLoadQueue;\r\n  protected peopleSection: SettingChatListSection;\r\n  protected chatsSection: SettingChatListSection;\r\n\r\n  protected locatedPeers: Map<PeerId, PeerLocated.peerLocated>;\r\n\r\n  // protected async init() {\r\n  //   this.container.classList.add('people-nearby-container');\r\n  //   this.setTitle('PeopleNearby');\r\n\r\n  //   this.errorCategory = document.createElement('div');\r\n  //   this.errorCategory.classList.add('text', 'hide', 'nearby-error');\r\n\r\n  //   this.retryBtn = ButtonCorner({icon: 'check'});\r\n\r\n  //   const emoji = '';\r\n  //   const doc = await this.managers.appStickersManager.getAnimatedEmojiSticker(emoji);\r\n  //   const stickerContainer = document.createElement('div');\r\n  //   stickerContainer.classList.add('sticker-container');\r\n\r\n  //   if(doc) {\r\n  //     wrapSticker({\r\n  //       doc,\r\n  //       div: stickerContainer,\r\n  //       loop: false,\r\n  //       play: true,\r\n  //       width: 86,\r\n  //       height: 86,\r\n  //       emoji,\r\n  //       needUpscale: true\r\n  //     }).then(() => {\r\n  //       // this.animation = player;\r\n  //     });\r\n  //   } else {\r\n  //     stickerContainer.classList.add('media-sticker-wrapper');\r\n  //   }\r\n\r\n  //   const caption = document.createElement('div');\r\n  //   caption.classList.add('caption');\r\n  //   _i18n(caption, 'PeopleNearbyInfo2');\r\n\r\n  //   this.locatedPeers = new Map();\r\n\r\n  //   const m = () => {\r\n  //     const sortedUserList = new SortedUserList({\r\n  //       avatarSize: 42, \r\n  //       createChatListOptions: {\r\n  //         dialogSize: 48,\r\n  //         new: true\r\n  //       },\r\n  //       autonomous: false,\r\n  //       onUpdate: (element) => {\r\n  //         const peer = this.locatedPeers.get(element.id);\r\n  //         const elements: HTMLElement[] = [\r\n  //           this.parseDistance(peer.distance)\r\n  //         ];\r\n\r\n  //         if(!element.id.isUser()) {\r\n  //           elements.push(this.managers.appProfileManager.getChatMembersString(element.id.toChatId()));\r\n  //         }\r\n\r\n  //         element.dom.lastMessageSpan.textContent = '';\r\n  //         element.dom.lastMessageSpan.append(...join(elements, false));\r\n  //       },\r\n  //       getIndex: (element) => {\r\n  //         const peer = this.locatedPeers.get(element.id);\r\n  //         return 0x7FFFFFFF - peer.distance;\r\n  //       },\r\n  //       appUsersManager: this.managers.appUsersManager\r\n  //     });\r\n\r\n  //     appDialogsManager.setListClickListener(sortedUserList.list, undefined, undefined, false);\r\n      \r\n  //     return sortedUserList;\r\n  //   };\r\n    \r\n  //   const peopleSection = this.peopleSection = new SettingChatListSection({\r\n  //     name: 'PeopleNearbyHeader',\r\n  //     sortedList: m()\r\n  //   });\r\n\r\n  //   const chatsSection = this.chatsSection = new SettingChatListSection({\r\n  //     name: 'ChatsNearbyHeader',\r\n  //     sortedList: m()\r\n  //   });\r\n\r\n  //   const btnMakeVisible = peopleSection.makeButton({\r\n  //     text: 'MakeMyselfVisible',\r\n  //     icon: 'location'\r\n  //   });\r\n\r\n  //   const btnMakeInvisible = peopleSection.makeButton({\r\n  //     text: 'StopShowingMe',\r\n  //     icon: 'location'\r\n  //   });\r\n\r\n  //   const btnCreateGroup = chatsSection.makeButton({\r\n  //     text: 'NearbyCreateGroup',\r\n  //     icon: 'newgroup'\r\n  //   });\r\n\r\n  //   attachClickEvent(btnMakeVisible, () => {\r\n  //     confirmationPopup({\r\n  //       titleLangKey: 'MakeMyselfVisibleTitle',\r\n  //       descriptionLangKey: 'MakeMyselfVisibleInfo',\r\n  //       button: {\r\n  //         langKey: 'OK'\r\n  //       }\r\n  //     }).then(() => {\r\n  //       this.startWatching();\r\n  //     });\r\n  //   }, {listenerSetter: this.listenerSetter});\r\n\r\n  //   attachClickEvent(btnMakeInvisible, () => {\r\n  //     this.stopWatching();\r\n  //   }, {listenerSetter: this.listenerSetter});\r\n\r\n  //   attachClickEvent(btnCreateGroup, () => {\r\n  //     this.slider.createTab(AppNewGroupTab).open([], true);\r\n  //   }, {listenerSetter: this.listenerSetter});\r\n\r\n  //   btnMakeVisible.classList.add('primary');\r\n  //   btnMakeInvisible.classList.add('danger');\r\n  //   btnCreateGroup.classList.add('primary');\r\n\r\n  //   this.content.append(this.retryBtn);\r\n  //   this.scrollable.append(\r\n  //     stickerContainer,\r\n  //     caption,\r\n  //     peopleSection.container,\r\n  //     chatsSection.container,\r\n  //     this.errorCategory\r\n  //   );\r\n  // }\r\n\r\n  private parseDistance(distance: number) {\r\n    if(rootScope.settings.distanceUnit === 'miles') {\r\n      if(distance > 1609.34) {\r\n        return i18n('MilesAway', [Math.round(distance / 1609)]);\r\n      } else {\r\n        return i18n('FootsAway', [Math.round(distance * 3.281)]);\r\n      }\r\n    } else {\r\n      if(distance >= 1000) {\r\n        return i18n('KMetersAway2', [distance / 1000]);\r\n      } else {\r\n        return i18n('MetersAway2', [distance]);\r\n      }\r\n    }\r\n  }\r\n\r\n  public open() {\r\n    const result = super.open();\r\n    result.then(() => {\r\n      this.retryBtn.classList.remove('is-visible');\r\n      navigator.geolocation.getCurrentPosition((location) => {\r\n        this.latestLocationSaved = {\r\n          latitude: location.coords.latitude,\r\n          longitude: location.coords.longitude,\r\n          accuracy: location.coords.accuracy\r\n        };\r\n\r\n        console.log(this.latestLocationSaved);\r\n\r\n        this.managers.appUsersManager.getLocated(\r\n          location.coords.latitude,\r\n          location.coords.longitude,\r\n          location.coords.accuracy\r\n        ).then((response) => {\r\n          const update = (response as Updates.updates).updates[0] as Update.updatePeerLocated;\r\n          const peers = update.peers as PeerLocated.peerLocated[];\r\n          const orderedPeers = peers.sort((a, b) => a.distance - b.distance);\r\n          const groupsCounter = peers.filter((e) => e.peer._ == 'peerChannel').length;\r\n          const usersCounter = peers.filter((e) => e.peer._ != 'peerChannel').length;\r\n          orderedPeers?.forEach((peer) => {\r\n            const peerId = getPeerId(peer.peer);\r\n            const section = peerId.isUser() ? this.peopleSection : this.chatsSection;\r\n            this.locatedPeers.set(peerId, peer);\r\n            section.sortedList.add(peerId);\r\n          });\r\n\r\n          this.errorCategory.classList.toggle('hide', !!(usersCounter || groupsCounter));\r\n          this.errorCategory.innerHTML = \"No groups or channels found around you.\";\r\n        });\r\n      }, (error) => {\r\n        this.errorCategory.classList.remove('hide');\r\n        this.retryBtn.classList.add('is-visible');\r\n        this.retryBtn.addEventListener('click', this.open);\r\n        if(error instanceof GeolocationPositionError) {\r\n          this.errorCategory.innerHTML = \"Location permission denied. Click below to retry.\";\r\n        } else {\r\n          this.errorCategory.innerHTML = \"An error has occurred. Please retry later clicking the button below.\";\r\n        }\r\n      });\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  private startWatching() {\r\n    if(!this.latestLocationSaved || this.isLocationWatched) return;\r\n    this.isLocationWatched = true;\r\n\r\n    toast('Your position is now being shared. Do not close the page or it will be suspended.');\r\n\r\n    this.managers.appUsersManager.getLocated(\r\n      this.latestLocationSaved.latitude,\r\n      this.latestLocationSaved.longitude,\r\n      this.latestLocationSaved.accuracy,\r\n      true, // background parameter\r\n      0x7fffffff // self_expires parameter\r\n    );\r\n\r\n    navigator.geolocation.watchPosition((result) => {\r\n      const isLongitudeDifferent = result.coords.longitude !== this.latestLocationSaved.longitude;\r\n      const isLatitudeDifferent = result.coords.latitude !== this.latestLocationSaved.latitude;\r\n      const distanceCheck = this.calculateDistance(\r\n        result.coords.latitude, result.coords.longitude,\r\n        this.latestLocationSaved.latitude, this.latestLocationSaved.longitude\r\n      ) > 100;\r\n\r\n      if((isLatitudeDifferent || isLongitudeDifferent) && distanceCheck) {\r\n        this.managers.appUsersManager.getLocated(\r\n          result.coords.latitude,\r\n          result.coords.longitude,\r\n          result.coords.accuracy,\r\n          true, // background parameter\r\n          0x7fffffff // self_expires parameter\r\n        );\r\n        this.latestLocationSaved = {\r\n          latitude: result.coords.latitude,\r\n          longitude: result.coords.longitude,\r\n          accuracy: result.coords.accuracy\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private stopWatching() {\r\n    if(!this.isLocationWatched) return;\r\n    this.isLocationWatched = false;\r\n    toast('The sharing of your position has been stopped. You will no longer be visible to other users.');\r\n    this.managers.appUsersManager.getLocated(\r\n      0, // latitude parameter\r\n      0, // longitude parameter\r\n      0, // accuracy parameter\r\n      false, // background parameter\r\n      0 // self_expires parameter\r\n    );\r\n  }\r\n\r\n  private calculateDistance(lat1: number, long1: number, lat2: number, long2: number) {\r\n    const p = 0.017453292519943295; // Math.PI/180\r\n    return (\r\n      12742 * Math.asin(\r\n        Math.sqrt(\r\n          (0.5 - Math.cos((lat2 - lat1) * p)) +\r\n          (\r\n            Math.cos(lat1 * p) * Math.cos(lat2 * p)\r\n            * (1 - Math.cos((long2 - long1) * p)/2)\r\n          )\r\n        )\r\n      )\r\n    );\r\n  }\r\n}\r\n","export default function formatNumber(bytes: number, decimals = 2) {\r\n  if(bytes === 0) return '0';\r\n\r\n  const k = 1000;\r\n  const dm = decimals < 0 ? 0 : decimals;\r\n  const sizes = ['', 'K', 'M', 'B', 'T'];\r\n\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n\r\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + sizes[i];\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport { SearchGroup } from \"../appSearch\";\r\nimport \"../avatar\";\r\nimport Scrollable, { ScrollableX } from \"../scrollable\";\r\nimport InputSearch from \"../inputSearch\";\r\nimport SidebarSlider from \"../slider\";\r\nimport { TransitionSlider } from \"../transition\";\r\nimport AppNewGroupTab from \"./tabs/newGroup\";\r\nimport AppSearchSuper from \"../appSearchSuper.\";\r\nimport { DateData, fillTipDates } from \"../../helpers/date\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport AppSettingsTab from \"./tabs/settings\";\r\nimport AppNewChannelTab from \"./tabs/newChannel\";\r\nimport AppContactsTab from \"./tabs/contacts\";\r\nimport AppArchivedTab from \"./tabs/archivedTab\";\r\nimport AppAddMembersTab from \"./tabs/addMembers\";\r\nimport I18n, { FormatterArguments, i18n, i18n_, LangPackKey } from \"../../lib/langPack\";\r\nimport AppPeopleNearbyTab from \"./tabs/peopleNearby\";\r\nimport { ButtonMenuItemOptions } from \"../buttonMenu\";\r\nimport CheckboxField from \"../checkboxField\";\r\nimport { IS_MOBILE_SAFARI } from \"../../environment/userAgent\";\r\nimport appNavigationController, { NavigationItem } from \"../appNavigationController\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport App from \"../../config/app\";\r\nimport ButtonMenuToggle from \"../buttonMenuToggle\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport sessionStorage from \"../../lib/sessionStorage\";\r\nimport { attachClickEvent, CLICK_EVENT_NAME, simulateClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport confirmationPopup from \"../confirmationPopup\";\r\nimport IS_GEOLOCATION_SUPPORTED from \"../../environment/geolocationSupport\";\r\nimport type SortedUserList from \"../sortedUserList\";\r\nimport Button, { ButtonOptions } from \"../button\";\r\nimport noop from \"../../helpers/noop\";\r\nimport ripple from \"../ripple\";\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport formatNumber from \"../../helpers/number/formatNumber\";\r\nimport AvatarElement from \"../avatar\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport themeController from \"../../helpers/themeController\";\r\nimport contextMenuController from \"../../helpers/contextMenuController\";\r\nimport { DIALOG_LIST_ELEMENT_TAG } from \"../../lib/appManagers/appDialogsManager\";\r\nimport apiManagerProxy from \"../../lib/mtproto/mtprotoworker\";\r\n\r\nexport const LEFT_COLUMN_ACTIVE_CLASSNAME = 'is-left-column-shown';\r\n\r\nexport class AppSidebarLeft extends SidebarSlider {\r\n  private toolsBtn: HTMLElement;\r\n  private backBtn: HTMLButtonElement;\r\n  //private searchInput = document.getElementById('global-search') as HTMLInputElement;\r\n  private inputSearch: InputSearch;\r\n  \r\n  public archivedCount: HTMLSpanElement;\r\n\r\n  private newBtnMenu: HTMLElement;\r\n\r\n  //private log = logger('SL');\r\n\r\n  private searchGroups: {[k in 'contacts' | 'globalContacts' | 'messages' | 'people' | 'recent']: SearchGroup} = {} as any;\r\n  private searchSuper: AppSearchSuper;\r\n\r\n  private updateBtn: HTMLElement;\r\n  private hasUpdate: boolean;\r\n\r\n  constructor() {\r\n    super({\r\n      sidebarEl: document.getElementById('column-left') as HTMLDivElement,\r\n      navigationType: 'left'\r\n    });\r\n  }\r\n\r\n  construct(managers: AppManagers) {\r\n    this.managers = managers;\r\n    //this._selectTab(0); // make first tab as default\r\n\r\n    this.inputSearch = new InputSearch('Search');\r\n    const sidebarHeader = this.sidebarEl.querySelector('.item-main .sidebar-header');\r\n    sidebarHeader.append(this.inputSearch.container);\r\n\r\n    const onNewGroupClick = () => {\r\n      this.createTab(AppAddMembersTab).open({\r\n        type: 'chat',\r\n        skippable: false,\r\n        takeOut: (peerIds) => {\r\n          this.createTab(AppNewGroupTab).open(peerIds);\r\n        },\r\n        title: 'GroupAddMembers',\r\n        placeholder: 'SendMessageTo'\r\n      });\r\n    };\r\n\r\n    const onContactsClick = () => {\r\n      this.createTab(AppContactsTab).open();\r\n    };\r\n\r\n    //this.toolsBtn = this.sidebarEl.querySelector('.sidebar-tools-button') as HTMLButtonElement;\r\n    this.backBtn = this.sidebarEl.querySelector('.sidebar-back-button') as HTMLButtonElement;\r\n\r\n    const btnArchive: typeof menuButtons[0] = {\r\n      icon: 'archive',\r\n      text: 'ArchivedChats',\r\n      onClick: () => {\r\n        this.createTab(AppArchivedTab).open();\r\n      },\r\n      verify: async() => {\r\n        const folder = await this.managers.dialogsStorage.getFolderDialogs(1, false);\r\n        return !!folder.length || !(await this.managers.dialogsStorage.isDialogsLoaded(1));\r\n      }\r\n    };\r\n\r\n    const themeCheckboxField = new CheckboxField({\r\n      toggle: true,\r\n      checked: themeController.getTheme().name === 'night'\r\n    });\r\n    themeCheckboxField.input.addEventListener('change', async() => {\r\n      await this.managers.appStateManager.setByKey('settings.theme', themeCheckboxField.input.checked ? 'night' : 'day');\r\n      rootScope.dispatchEvent('theme_change');\r\n    });\r\n\r\n    rootScope.addEventListener('theme_change', () => {\r\n      themeCheckboxField.setValueSilently(themeController.getTheme().name === 'night');\r\n    });\r\n\r\n    const menuButtons: (ButtonMenuItemOptions & {verify?: () => boolean | Promise<boolean>})[] = [{\r\n      icon: 'saved',\r\n      text: 'SavedMessages',\r\n      onClick: () => {\r\n        setTimeout(() => { // menu doesn't close if no timeout (lol)\r\n          appImManager.setPeer({\r\n            peerId: appImManager.myId\r\n          });\r\n        }, 0);\r\n      }\r\n    }, btnArchive, {\r\n      icon: 'user',\r\n      text: 'Contacts',\r\n      onClick: onContactsClick\r\n    }, IS_GEOLOCATION_SUPPORTED ? {\r\n      icon: 'group',\r\n      text: 'PeopleNearby',\r\n      onClick: () => {\r\n        this.createTab(AppPeopleNearbyTab).open();\r\n      }\r\n    } : undefined, {\r\n      icon: 'settings',\r\n      text: 'Settings',\r\n      onClick: () => {\r\n        this.createTab(AppSettingsTab).open();\r\n      }\r\n    }, {\r\n      icon: 'darkmode',\r\n      text: 'DarkMode',\r\n      onClick: () => {\r\n        \r\n      },\r\n      checkboxField: themeCheckboxField\r\n    }, {\r\n      icon: 'animations',\r\n      text: 'Animations',\r\n      onClick: () => {\r\n        \r\n      },\r\n      checkboxField: new CheckboxField({\r\n        toggle: true, \r\n        checked: true,\r\n        stateKey: 'settings.animationsEnabled',\r\n      })\r\n    }, {\r\n      icon: 'help',\r\n      text: 'TelegramFeatures',\r\n      onClick: () => {\r\n        const url = I18n.format('TelegramFeaturesUrl', true);\r\n        appImManager.openUrl(url);\r\n      }\r\n    }, {\r\n      icon: 'bug',\r\n      text: 'ReportBug',\r\n      onClick: () => {\r\n        const a = document.createElement('a');\r\n        a.target = '_blank';\r\n        a.href = 'https://bugs.telegram.org/?tag_ids=40&sort=time';\r\n        document.body.append(a);\r\n        a.click();\r\n        setTimeout(() => {\r\n          a.remove();\r\n        }, 0);\r\n      }\r\n    }, {\r\n      icon: 'char z',\r\n      text: 'ChatList.Menu.SwitchTo.Z',\r\n      onClick: () => {\r\n        Promise.all([\r\n          sessionStorage.set({kz_version: 'Z'}),\r\n          sessionStorage.delete('tgme_sync')\r\n        ]).then(() => {\r\n          location.href = 'https://web.telegram.org/z/';\r\n        });\r\n      },\r\n      verify: () => App.isMainDomain\r\n    }, {\r\n      icon: 'char w',\r\n      text: 'ChatList.Menu.SwitchTo.Webogram',\r\n      onClick: () => {\r\n        sessionStorage.delete('tgme_sync').then(() => {\r\n          location.href = 'https://web.telegram.org/?legacy=1';\r\n        });\r\n      },\r\n      verify: () => App.isMainDomain\r\n    }];\r\n\r\n    const filteredButtons = menuButtons.filter(Boolean);\r\n\r\n    this.toolsBtn = ButtonMenuToggle({}, 'bottom-right', filteredButtons, async(e) => {\r\n      await Promise.all(filteredButtons.map(async(button) => {\r\n        if(button.verify) {\r\n          button.element.classList.toggle('hide', !(await button.verify()));\r\n        }\r\n      }));\r\n    });\r\n    this.toolsBtn.classList.remove('tgico-more');\r\n    this.toolsBtn.classList.add('sidebar-tools-button', 'is-visible');\r\n\r\n    this.backBtn.parentElement.insertBefore(this.toolsBtn, this.backBtn);\r\n\r\n    const btnMenu = this.toolsBtn.querySelector('.btn-menu') as HTMLElement;\r\n\r\n    const btnMenuFooter = document.createElement('a');\r\n    btnMenuFooter.href = 'https://github.com/morethanwords/tweb/blob/master/CHANGELOG.md';\r\n    btnMenuFooter.target = '_blank';\r\n    btnMenuFooter.rel = 'noopener noreferrer';\r\n    btnMenuFooter.classList.add('btn-menu-footer');\r\n    btnMenuFooter.addEventListener(CLICK_EVENT_NAME, (e) => {\r\n      e.stopPropagation();\r\n      contextMenuController.closeBtnMenu();\r\n    });\r\n    const t = document.createElement('span');\r\n    t.classList.add('btn-menu-footer-text');\r\n    t.innerHTML = 'Telegram Web' + App.suffix + ' '/* ' alpha ' */ + App.versionFull;\r\n    btnMenuFooter.append(t); \r\n    btnMenu.classList.add('has-footer');\r\n    btnMenu.append(btnMenuFooter);\r\n\r\n    this.newBtnMenu = ButtonMenuToggle({}, 'top-left', [{\r\n      icon: 'newchannel',\r\n      text: 'NewChannel',\r\n      onClick: () => {\r\n        this.createTab(AppNewChannelTab).open();\r\n      }\r\n    }, {\r\n      icon: 'newgroup',\r\n      text: 'NewGroup',\r\n      onClick: onNewGroupClick\r\n    }, {\r\n      icon: 'newprivate',\r\n      text: 'NewPrivateChat',\r\n      onClick: onContactsClick\r\n    }]);\r\n    this.newBtnMenu.className = 'btn-circle rp btn-corner z-depth-1 btn-menu-toggle animated-button-icon';\r\n    this.newBtnMenu.insertAdjacentHTML('afterbegin', `\r\n    <span class=\"tgico tgico-newchat_filled\"></span>\r\n    <span class=\"tgico tgico-close\"></span>\r\n    `);\r\n    this.newBtnMenu.id = 'new-menu';\r\n    sidebarHeader.nextElementSibling.append(this.newBtnMenu);\r\n\r\n    this.updateBtn = document.createElement('div');\r\n    // this.updateBtn.classList.add('btn-update');\r\n    this.updateBtn.className = 'btn-circle rp btn-corner z-depth-1 btn-update is-hidden';\r\n    ripple(this.updateBtn);\r\n    this.updateBtn.append(i18n('Update'));\r\n    // const weave = new TopbarWeave();\r\n    // const weaveContainer = weave.render('btn-update-weave');\r\n    // this.updateBtn.prepend(weaveContainer);\r\n\r\n    attachClickEvent(this.updateBtn, () => {\r\n      if(this.updateBtn.classList.contains('is-hidden')) {\r\n        return;\r\n      }\r\n      \r\n      location.reload();\r\n    });\r\n    \r\n    sidebarHeader.nextElementSibling.append(this.updateBtn);\r\n\r\n    // setTimeout(() => {\r\n    //   weave.componentDidMount();\r\n    //   weave.setCurrentState(GROUP_CALL_STATE.MUTED, true);\r\n    //   weave.setAmplitude(0);\r\n    //   weave.handleBlur();\r\n    // }, 1e3);\r\n\r\n    this.inputSearch.input.addEventListener('focus', () => this.initSearch(), {once: true});\r\n\r\n    //parseMenuButtonsTo(this.newButtons, this.newBtnMenu.firstElementChild.children);\r\n\r\n    this.archivedCount = document.createElement('span');\r\n    this.archivedCount.className = 'archived-count badge badge-24 badge-gray';\r\n\r\n    btnArchive.element.append(this.archivedCount);\r\n\r\n    rootScope.addEventListener('folder_unread', (folder) => {\r\n      if(folder.id === 1) {\r\n        // const count = folder.unreadMessagesCount;\r\n        const count = folder.unreadPeerIds.size;\r\n        this.archivedCount.innerText = '' + formatNumber(count, 1);\r\n        this.archivedCount.classList.toggle('hide', !count);\r\n      }\r\n    });\r\n\r\n    this.managers.appUsersManager.getTopPeers('correspondents');\r\n\r\n    // Focus search input by pressing Escape\r\n    const navigationItem: NavigationItem = {\r\n      type: 'global-search-focus',\r\n      onPop: () => {\r\n        setTimeout(() => {\r\n          this.inputSearch.input.focus();\r\n        }, 0);\r\n\r\n        return false;\r\n      },\r\n      noHistory: true\r\n    };\r\n    appNavigationController.pushItem(navigationItem);\r\n\r\n    apiManagerProxy.getState().then((state) => {\r\n      const CHECK_UPDATE_INTERVAL = 1800e3;\r\n      const checkUpdateInterval = setInterval(() => {\r\n        fetch('version', {cache: 'no-cache'})\r\n        .then((res) => (res.status === 200 && res.ok && res.text()) || Promise.reject())\r\n        .then((text) => {\r\n          if(text !== App.versionFull) {\r\n            this.hasUpdate = true;\r\n            clearInterval(checkUpdateInterval);\r\n\r\n            if(!this.newBtnMenu.classList.contains('is-hidden')) {\r\n              this.updateBtn.classList.remove('is-hidden');\r\n            }\r\n          }\r\n        })\r\n        .catch(noop);\r\n      }, CHECK_UPDATE_INTERVAL);\r\n    });\r\n  }\r\n\r\n  private initSearch() {\r\n    const searchContainer = this.sidebarEl.querySelector('#search-container') as HTMLDivElement;\r\n\r\n    const scrollable = new Scrollable(searchContainer);\r\n\r\n    const close = () => {\r\n      //setTimeout(() => {\r\n        simulateClickEvent(this.backBtn);\r\n      //}, 0);\r\n    };\r\n\r\n    this.searchGroups = {\r\n      contacts: new SearchGroup('SearchAllChatsShort', 'contacts', undefined, undefined, undefined, undefined, close),\r\n      globalContacts: new SearchGroup('GlobalSearch', 'contacts', undefined, undefined, undefined, undefined, close),\r\n      messages: new SearchGroup('SearchMessages', 'messages'),\r\n      people: new SearchGroup(false, 'contacts', true, 'search-group-people', true, false, close),\r\n      recent: new SearchGroup('Recent', 'contacts', true, 'search-group-recent', true, true, close)\r\n    };\r\n\r\n    const searchSuper = this.searchSuper = new AppSearchSuper({\r\n      mediaTabs: [{\r\n        inputFilter: 'inputMessagesFilterEmpty',\r\n        name: 'FilterChats',\r\n        type: 'chats'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterPhotoVideo',\r\n        name: 'SharedMediaTab2',\r\n        type: 'media'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterUrl',\r\n        name: 'SharedLinksTab2',\r\n        type: 'links'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterDocument',\r\n        name: 'SharedFilesTab2',\r\n        type: 'files'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterMusic',\r\n        name: 'SharedMusicTab2',\r\n        type: 'music'\r\n      }, {\r\n        inputFilter: 'inputMessagesFilterRoundVoice',\r\n        name: 'SharedVoiceTab2',\r\n        type: 'voice'\r\n      }], \r\n      scrollable, \r\n      searchGroups: this.searchGroups, \r\n      asChatList: true,\r\n      hideEmptyTabs: false,\r\n      showSender: true,\r\n      managers: this.managers\r\n    });\r\n\r\n    searchContainer.prepend(searchSuper.nav.parentElement.parentElement);\r\n    scrollable.container.append(searchSuper.container);\r\n\r\n    const resetSearch = () => {\r\n      searchSuper.setQuery({\r\n        peerId: ''.toPeerId(), \r\n        folderId: 0\r\n      });\r\n      searchSuper.selectTab(0);\r\n      searchSuper.load(true); \r\n    };\r\n\r\n    resetSearch();\r\n\r\n    let pickedElements: HTMLElement[] = [];\r\n    let selectedPeerId: PeerId = ''.toPeerId();\r\n    let selectedMinDate = 0;\r\n    let selectedMaxDate = 0;\r\n    const updatePicked = () => {\r\n      //(this.inputSearch.input as HTMLInputElement).placeholder = pickedElements.length ? 'Search' : 'Telegram Search';\r\n      this.inputSearch.container.classList.toggle('is-picked-twice', pickedElements.length === 2);\r\n      this.inputSearch.container.classList.toggle('is-picked', !!pickedElements.length);\r\n\r\n      if(pickedElements.length) {\r\n        this.inputSearch.input.style.setProperty('--paddingLeft', (pickedElements[pickedElements.length - 1].getBoundingClientRect().right - this.inputSearch.input.getBoundingClientRect().left) + 'px');\r\n      } else {\r\n        this.inputSearch.input.style.removeProperty('--paddingLeft');\r\n      }\r\n    };\r\n\r\n    const helper = document.createElement('div');\r\n    helper.classList.add('search-helper');\r\n    helper.addEventListener('click', (e) => {\r\n      const target = findUpClassName(e.target, 'selector-user');\r\n      if(!target) {\r\n        return;\r\n      }\r\n\r\n      const key = target.dataset.key;\r\n      if(key.indexOf('date_') === 0) {\r\n        const [_, minDate, maxDate] = key.split('_');\r\n        selectedMinDate = +minDate;\r\n        selectedMaxDate = +maxDate;\r\n      } else {\r\n        selectedPeerId = key.toPeerId();\r\n      }\r\n\r\n      target.addEventListener('click', () => {\r\n        unselectEntity(target);\r\n      });\r\n\r\n      this.inputSearch.container.append(target);\r\n      this.inputSearch.onChange(this.inputSearch.value = '');\r\n      pickedElements.push(target);\r\n      updatePicked();\r\n    });\r\n\r\n    searchSuper.nav.parentElement.append(helper);\r\n\r\n    const renderEntity = (key: PeerId | string, title?: string | HTMLElement) => {\r\n      const div = document.createElement('div');\r\n      div.classList.add('selector-user'/* , 'scale-in' */);\r\n\r\n      const avatarEl = new AvatarElement();\r\n      avatarEl.classList.add('selector-user-avatar', 'tgico', 'avatar-30');\r\n      avatarEl.isDialog = true;\r\n\r\n      div.dataset.key = '' + key;\r\n      if(key.isPeerId()) {\r\n        if(title === undefined) {\r\n          title = new PeerTitle({peerId: key.toPeerId()}).element;\r\n        }\r\n\r\n        avatarEl.updateWithOptions({peerId: key as PeerId});\r\n      } else {\r\n        avatarEl.classList.add('tgico-calendarfilter');\r\n      }\r\n\r\n      if(title) {\r\n        if(typeof(title) === 'string') {\r\n          div.innerHTML = title;\r\n        } else {\r\n          replaceContent(div, title);\r\n          div.append(title);\r\n        }\r\n      }\r\n\r\n      div.insertAdjacentElement('afterbegin', avatarEl);\r\n\r\n      return div;\r\n    };\r\n\r\n    const unselectEntity = (target: HTMLElement) => {\r\n      const key = target.dataset.key;\r\n      if(key.indexOf('date_') === 0) {\r\n        selectedMinDate = selectedMaxDate = 0;\r\n      } else {\r\n        selectedPeerId = ''.toPeerId();\r\n      }\r\n      \r\n      target.remove();\r\n      indexOfAndSplice(pickedElements, target);\r\n\r\n      setTimeout(() => {\r\n        updatePicked();\r\n        this.inputSearch.onChange(this.inputSearch.value);\r\n      }, 0);\r\n    };\r\n\r\n    this.inputSearch.onClear = () => {\r\n      pickedElements.forEach((el) => {\r\n        unselectEntity(el);\r\n      });\r\n    };\r\n\r\n    this.inputSearch.onChange = (value) => {\r\n      searchSuper.cleanupHTML();\r\n      searchSuper.setQuery({\r\n        peerId: selectedPeerId, \r\n        folderId: selectedPeerId ? undefined : 0,\r\n        query: value,\r\n        minDate: selectedMinDate,\r\n        maxDate: selectedMaxDate\r\n      });\r\n      searchSuper.load(true);\r\n\r\n      helper.innerHTML = '';\r\n      searchSuper.nav.classList.remove('hide');\r\n      if(!value) {\r\n      }\r\n      \r\n      if(!selectedPeerId && value.trim()) {\r\n        const middleware = searchSuper.middleware.get();\r\n        Promise.all([\r\n          // appMessagesManager.getConversationsAll(value).then((dialogs) => dialogs.map((d) => d.peerId)),\r\n          this.managers.appMessagesManager.getConversations(value).then(({dialogs}) => dialogs.map((d) => d.peerId)),\r\n          this.managers.appUsersManager.getContactsPeerIds(value, true)\r\n        ]).then((results) => {\r\n          if(!middleware()) return;\r\n          const peerIds = new Set(results[0].concat(results[1]));\r\n  \r\n          peerIds.forEach((peerId) => {\r\n            helper.append(renderEntity(peerId));\r\n          });\r\n  \r\n          searchSuper.nav.classList.toggle('hide', !!helper.innerHTML);\r\n          //console.log('got peerIds by value:', value, [...peerIds]);\r\n        });\r\n      }\r\n      \r\n      if(!selectedMinDate && value.trim()) {\r\n        const dates: DateData[] = [];\r\n        fillTipDates(value, dates);\r\n        dates.forEach((dateData) => {\r\n          helper.append(renderEntity('date_' + dateData.minDate + '_' + dateData.maxDate, dateData.title));\r\n        });\r\n\r\n        searchSuper.nav.classList.toggle('hide', !!helper.innerHTML);\r\n      }\r\n    };\r\n\r\n    searchSuper.tabs.inputMessagesFilterEmpty.addEventListener('mousedown', (e) => {\r\n      const target = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG) as HTMLElement;\r\n      if(!target) {\r\n        return;\r\n      }\r\n\r\n      const searchGroup = findUpClassName(target, 'search-group');\r\n      if(!searchGroup || searchGroup.classList.contains('search-group-recent') || searchGroup.classList.contains('search-group-people')) {\r\n        return;\r\n      }\r\n\r\n      const peerId = target.getAttribute('data-peer-id').toPeerId();\r\n      this.managers.appUsersManager.pushRecentSearch(peerId);\r\n    }, {capture: true});\r\n\r\n    let peopleContainer = document.createElement('div');\r\n    peopleContainer.classList.add('search-group-scrollable');\r\n    peopleContainer.append(this.searchGroups.people.list);\r\n    this.searchGroups.people.container.append(peopleContainer);\r\n    let peopleScrollable = new ScrollableX(peopleContainer);\r\n\r\n    let first = true;\r\n    let hideNewBtnMenuTimeout: number;\r\n    //const transition = Transition.bind(null, searchContainer.parentElement, 150);\r\n    const transition = TransitionSlider(searchContainer.parentElement, 'zoom-fade', 150, (id) => {\r\n      if(hideNewBtnMenuTimeout) clearTimeout(hideNewBtnMenuTimeout);\r\n\r\n      if(id === 0 && !first) {\r\n        searchSuper.selectTab(0, false);\r\n        this.inputSearch.onClearClick();\r\n        hideNewBtnMenuTimeout = window.setTimeout(() => {\r\n          hideNewBtnMenuTimeout = 0;\r\n          this.newBtnMenu.classList.remove('is-hidden');\r\n          this.hasUpdate && this.updateBtn.classList.remove('is-hidden');\r\n        }, 150);\r\n      }\r\n\r\n      first = false;\r\n    });\r\n\r\n    transition(0);\r\n\r\n    const activeClassName = 'is-visible';\r\n    const onFocus = () => {\r\n      this.toolsBtn.classList.remove(activeClassName);\r\n      this.backBtn.classList.add(activeClassName);\r\n      this.newBtnMenu.classList.add('is-hidden');\r\n      this.updateBtn.classList.add('is-hidden');\r\n      this.toolsBtn.parentElement.firstElementChild.classList.toggle('state-back', true);\r\n\r\n      const navigationType: NavigationItem['type'] = 'global-search';\r\n      if(!IS_MOBILE_SAFARI && !appNavigationController.findItemByType(navigationType)) {\r\n        appNavigationController.pushItem({\r\n          onPop: () => {\r\n            close();\r\n          },\r\n          type: navigationType\r\n        });\r\n      }\r\n\r\n      transition(1);\r\n    };\r\n\r\n    this.inputSearch.input.addEventListener('focus', onFocus);\r\n    onFocus();\r\n\r\n    attachClickEvent(this.backBtn, (e) => {\r\n      this.toolsBtn.classList.add(activeClassName);\r\n      this.backBtn.classList.remove(activeClassName);\r\n      this.toolsBtn.parentElement.firstElementChild.classList.toggle('state-back', false);\r\n\r\n      appNavigationController.removeByType('global-search');\r\n\r\n      transition(0);\r\n    });\r\n\r\n    const clearRecentSearchBtn = ButtonIcon('close');\r\n    this.searchGroups.recent.nameEl.append(clearRecentSearchBtn);\r\n    clearRecentSearchBtn.addEventListener('click', () => {\r\n      confirmationPopup({\r\n        descriptionLangKey: 'Search.Confirm.ClearHistory',\r\n        button: {\r\n          langKey: 'ClearButton',\r\n          isDanger: true\r\n        }\r\n      }).then(() => {\r\n        return this.managers.appUsersManager.clearRecentSearch().then(() => {\r\n          this.searchGroups.recent.clear();\r\n        });\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nexport type SettingSectionOptions = {\r\n  name?: LangPackKey, \r\n  nameArgs?: FormatterArguments,\r\n  caption?: LangPackKey | true,\r\n  captionArgs?: FormatterArguments,\r\n  captionOld?: SettingSectionOptions['caption'],\r\n  noDelimiter?: boolean,\r\n  fakeGradientDelimiter?: boolean,\r\n  noShadow?: boolean,\r\n  // fullWidth?: boolean,\r\n  // noPaddingTop?: boolean\r\n};\r\n\r\nconst className = 'sidebar-left-section';\r\nexport class SettingSection {\r\n  public container: HTMLElement;\r\n  public innerContainer: HTMLElement;\r\n  public content: HTMLElement;\r\n  public title: HTMLElement;\r\n  public caption: HTMLElement;\r\n\r\n  private fullWidth: boolean;\r\n\r\n  constructor(options: SettingSectionOptions = {}) {\r\n    const container = this.container = document.createElement('div');\r\n    container.classList.add(className + '-container');\r\n\r\n    const innerContainer = this.innerContainer = document.createElement('div');\r\n    innerContainer.classList.add(className);\r\n\r\n    if(options.noShadow) {\r\n      innerContainer.classList.add('no-shadow');\r\n    }\r\n\r\n    if(options.fakeGradientDelimiter) {\r\n      innerContainer.append(generateDelimiter());\r\n      innerContainer.classList.add('with-fake-delimiter');\r\n    } else if(!options.noDelimiter) {\r\n      const hr = document.createElement('hr');\r\n      innerContainer.append(hr);\r\n    } else {\r\n      innerContainer.classList.add('no-delimiter');\r\n    }\r\n\r\n    // if(options.fullWidth) {\r\n    //   this.fullWidth = true;\r\n    // }\r\n\r\n    // if(options.noPaddingTop) {\r\n    //   innerContainer.classList.add('no-padding-top');\r\n    // }\r\n\r\n    const content = this.content = this.generateContentElement();\r\n\r\n    if(options.name) {\r\n      const title = this.title = document.createElement('div');\r\n      title.classList.add('sidebar-left-h2', className + '-name');\r\n      i18n_({element: title, key: options.name, args: options.nameArgs});\r\n      content.append(title);\r\n    }\r\n\r\n    container.append(innerContainer);\r\n\r\n    const caption = options.caption ?? options.captionOld;\r\n    if(caption) {\r\n      const el = this.caption = this.generateContentElement();\r\n      el.classList.add(className + '-caption');\r\n\r\n      if(!options.captionOld) {\r\n        container.append(el);\r\n      }\r\n\r\n      if(caption !== true) {\r\n        i18n_({element: el, key: caption, args: options.captionArgs});\r\n      }\r\n    }\r\n  }\r\n\r\n  public generateContentElement() {\r\n    const content = document.createElement('div');\r\n    content.classList.add(className + '-content');\r\n\r\n    // if(this.fullWidth) {\r\n    //   content.classList.add('full-width');\r\n    // }\r\n\r\n    this.innerContainer.append(content);\r\n    return content;\r\n  }\r\n}\r\n\r\nexport const generateSection = (appendTo: Scrollable, name?: LangPackKey, caption?: LangPackKey) => {\r\n  const section = new SettingSection({name, caption});\r\n  appendTo.append(section.container);\r\n  return section.content;\r\n};\r\n\r\nexport const generateDelimiter = () => {\r\n  const delimiter = document.createElement('div');\r\n  delimiter.classList.add('gradient-delimiter');\r\n  return delimiter;\r\n};\r\n\r\nexport class SettingChatListSection extends SettingSection {\r\n  public sortedList: SortedUserList;\r\n\r\n  constructor(options: SettingSectionOptions & {sortedList: SortedUserList}) {\r\n    super(options);\r\n\r\n    this.sortedList = options.sortedList;\r\n\r\n    this.content.append(this.sortedList.list);\r\n  }\r\n\r\n  public makeButton(options: ButtonOptions) {\r\n    const button = Button('folder-category-button btn btn-primary btn-transparent', options);\r\n    if(this.title) this.content.insertBefore(button, this.title.nextSibling);\r\n    else this.content.prepend(button);\r\n    return button;\r\n  }\r\n}\r\n\r\nconst appSidebarLeft = new AppSidebarLeft();\r\nMOUNT_CLASS_TO.appSidebarLeft = appSidebarLeft;\r\nexport default appSidebarLeft;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../../lib/rootScope\";\r\n//import { generatePathData } from \"../../helpers/dom\";\r\nimport { MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\nimport type Chat from \"./chat\";\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport insertInDescendSortedArray from \"../../helpers/array/insertInDescendSortedArray\";\r\nimport positionElementByIndex from \"../../helpers/dom/positionElementByIndex\";\r\nimport AvatarElement from \"../avatar\";\r\nimport { Message } from \"../../layer\";\r\nimport { NULL_PEER_ID, REPLIES_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\nimport { SERVICE_AS_REGULAR, STICKY_OFFSET } from \"./bubbles\";\r\nimport forEachReverse from \"../../helpers/array/forEachReverse\";\r\nimport partition from \"../../helpers/array/partition\";\r\n\r\ntype GroupItem = {\r\n  bubble: HTMLElement, \r\n  fromId: PeerId, \r\n  mid: number, \r\n  groupMid?: number, \r\n  timestamp: number, \r\n  dateTimestamp: number, \r\n  mounted: boolean, \r\n  single: boolean, \r\n  group?: BubbleGroup,\r\n  message: Message.message | Message.messageService // use it only to set avatar\r\n};\r\n\r\nclass BubbleGroup {\r\n  container: HTMLElement;\r\n  chat: Chat;\r\n  groups: BubbleGroups;\r\n  items: GroupItem[]; // descend sorted\r\n  avatarContainer: HTMLElement;\r\n  avatarLoadPromise: ReturnType<AvatarElement['updateWithOptions']>;\r\n  avatar: AvatarElement;\r\n  mounted: boolean;\r\n  dateTimestamp: number;\r\n  offset: number;\r\n\r\n  constructor(chat: Chat, groups: BubbleGroups, dateTimestamp: number) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('bubbles-group');\r\n    this.chat = chat;\r\n    this.groups = groups;\r\n    this.items = [];\r\n    this.dateTimestamp = dateTimestamp;\r\n    this.offset = 0;\r\n  }\r\n\r\n  createAvatar(message: Message.message | Message.messageService) {\r\n    if(this.avatarLoadPromise) {\r\n      return this.avatarLoadPromise;\r\n    } else if(message._ === 'messageService') {\r\n      return;\r\n    }\r\n\r\n    this.avatarContainer = document.createElement('div');\r\n    this.avatarContainer.classList.add('bubbles-group-avatar-container');\r\n    ++this.offset;\r\n\r\n    const fwdFrom = message.fwd_from;\r\n    const fwdFromId = message.fwdFromId;\r\n    const isForwardFromChannel = message.from_id && message.from_id._ === 'peerChannel' && message.fromId === fwdFromId;\r\n    const currentPeerId = this.chat.peerId;\r\n    this.avatar = new AvatarElement();\r\n    this.avatar.classList.add('bubbles-group-avatar', 'user-avatar', 'avatar-40'/* , 'can-zoom-fade' */);\r\n    this.avatarLoadPromise = this.avatar.updateWithOptions({\r\n      lazyLoadQueue: this.chat.bubbles.lazyLoadQueue,\r\n      peerId: ((fwdFrom && (currentPeerId === rootScope.myId || currentPeerId === REPLIES_PEER_ID)) || isForwardFromChannel ? fwdFromId : message.fromId) || NULL_PEER_ID,\r\n      peerTitle: !fwdFromId && fwdFrom && fwdFrom.from_name ? /* ' FF ' */fwdFrom.from_name : undefined,\r\n    });\r\n\r\n    this.avatarContainer.append(this.avatar);\r\n    this.container.append(this.avatarContainer);\r\n\r\n    return this.avatarLoadPromise;\r\n  }\r\n\r\n  get firstTimestamp() {\r\n    return this.firstItem.timestamp;\r\n  }\r\n\r\n  get firstMid() {\r\n    return this.firstItem.mid;\r\n  }\r\n\r\n  get firstItem() {\r\n    return this.items[this.items.length - 1];\r\n  }\r\n\r\n  get lastTimestamp() {\r\n    return this.lastItem.timestamp;\r\n  }\r\n\r\n  get lastMid() {\r\n    return this.lastItem.mid;\r\n  }\r\n\r\n  get lastItem() {\r\n    return this.items[0];\r\n  }\r\n\r\n  updateClassNames() {\r\n    const items = this.items;\r\n    const length = items.length;\r\n    if(!length) {\r\n      return;\r\n    }\r\n    \r\n    // const elements = Array.from(this.container.children);\r\n    // if(this.offset) elements.splice(0, this.offset);\r\n\r\n    // const length = elements.length;\r\n    // if(!length) {\r\n    //   return;\r\n    // }\r\n\r\n    const first = items[length - 1].bubble;\r\n\r\n    if(items.length === 1) {\r\n      first.classList.add('is-group-first', 'is-group-last');\r\n      //this.setClipIfNeeded(first);\r\n      return;\r\n    } else {\r\n      first.classList.remove('is-group-last');\r\n      first.classList.add('is-group-first');\r\n      //this.setClipIfNeeded(first, true);\r\n    }\r\n    \r\n    for(let i = 1, _length = length - 1; i < _length; ++i) {\r\n      const bubble = items[i].bubble;\r\n      bubble.classList.remove('is-group-last', 'is-group-first');\r\n      //this.setClipIfNeeded(bubble, true);\r\n    }\r\n    \r\n    const last = items[0].bubble;\r\n    last.classList.remove('is-group-first');\r\n    last.classList.add('is-group-last');\r\n    //this.setClipIfNeeded(last);\r\n  }\r\n\r\n  insertItem(item: GroupItem) {\r\n    const {items} = this;\r\n    insertInDescendSortedArray(items, item, this.groups.sortGroupItemsKey);\r\n\r\n    item.group = this;\r\n    if(items.length === 1) {\r\n      this.groups.insertGroup(this);\r\n    }\r\n  }\r\n\r\n  removeItem(item: GroupItem) {\r\n    indexOfAndSplice(this.items, item);\r\n\r\n    if(!this.items.length) {\r\n      indexOfAndSplice(this.groups.groups, this);\r\n    }\r\n\r\n    item.group = undefined;\r\n  }\r\n\r\n  mount(updateClassNames?: boolean) {\r\n    if(!this.groups.groups.includes(this) || !this.items.length) { // group can be already removed\r\n      debugger;\r\n\r\n      if(this.mounted) {\r\n        this.onItemUnmount();\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    const {offset, items} = this;\r\n    const {length} = items;\r\n    forEachReverse(items, (item, idx) => {\r\n      this.mountItem(item, length - 1 - idx, offset);\r\n    });\r\n    \r\n    if(updateClassNames) {\r\n      this.updateClassNames();\r\n    }\r\n\r\n    this.onItemMount();\r\n  }\r\n\r\n  mountItem(item: GroupItem, idx = this.items.indexOf(item), offset = this.offset) {\r\n    if(item.mounted) {\r\n      return;\r\n    }\r\n\r\n    positionElementByIndex(item.bubble, this.container, offset + idx);\r\n    item.mounted = true;\r\n  }\r\n\r\n  unmountItem(item: GroupItem) {\r\n    if(!item.mounted) {\r\n      return;\r\n    }\r\n\r\n    item.bubble.remove();\r\n    item.mounted = false;\r\n    this.onItemUnmount();\r\n  }\r\n\r\n  onItemMount() {\r\n    if(this.mounted) {\r\n      return;\r\n    }\r\n\r\n    const dateContainer = this.chat.bubbles.getDateContainerByTimestamp(this.dateTimestamp / 1000);\r\n    // const idx = this.groups.indexOf(group);\r\n    const dateGroups = this.groups.groups.filter((_group) => _group.dateTimestamp === this.dateTimestamp);\r\n    const dateGroupsLength = dateGroups.length;\r\n    const idx = dateGroups.indexOf(this);\r\n    const unmountedLength = dateGroups.slice(idx + 1).reduce((acc, v) => acc + (v.mounted ? 0 : 1), 0);\r\n    positionElementByIndex(this.container, dateContainer.container, STICKY_OFFSET + dateGroupsLength - 1 - idx - unmountedLength);\r\n    this.mounted = true;\r\n  }\r\n\r\n  onItemUnmount() {\r\n    if(!this.mounted) {\r\n      return;\r\n    }\r\n\r\n    if(!this.items.length) {\r\n      this.container.remove();\r\n      this.chat.bubbles.deleteEmptyDateGroups();\r\n      this.mounted = false;\r\n    } else {\r\n      this.updateClassNames();\r\n    }\r\n  }\r\n}\r\n\r\n// class BubbleGroupItem implements GroupItem {\r\n//   bubble: HTMLElement;\r\n//   fromId: PeerId;\r\n//   mid: number;\r\n//   timestamp: number;\r\n//   dateTimestamp: number;\r\n//   mounted: boolean;\r\n//   single: boolean;\r\n//   group: BubbleGroup;\r\n\r\n//   constructor(details: GroupItem) {\r\n//     Object.assign(this, details);\r\n//   }\r\n// }\r\n\r\nexport default class BubbleGroups {\r\n  public itemsArr: Array<GroupItem> = []; // descend sorted\r\n  private itemsMap: Map<HTMLElement, GroupItem> = new Map();\r\n  public groups: Array<BubbleGroup> = []; // descend sorted\r\n  private newGroupDiff = 121; // * 121 in scheduled messages\r\n  private sortItemsKey: Extract<keyof GroupItem, 'timestamp' | 'mid'>;\r\n  private sortGroupsKey: Extract<keyof BubbleGroup, 'lastMid' | 'lastTimestamp'>;\r\n  public sortGroupItemsKey: Extract<keyof GroupItem, 'groupMid' | 'timestamp'>;\r\n\r\n  constructor(private chat: Chat) {\r\n    this.sortItemsKey = chat.type === 'scheduled' ? 'timestamp' : 'mid';\r\n    this.sortGroupsKey = chat.type === 'scheduled' ? 'lastTimestamp' : 'lastMid';\r\n    this.sortGroupItemsKey = /* chat.type === 'scheduled' ? 'timestamp' :  */'groupMid';\r\n  }\r\n\r\n  removeItem(item: GroupItem) {\r\n    item.group.removeItem(item);\r\n    this.removeItemFromCache(item);\r\n  }\r\n\r\n  removeAndUnmountBubble(bubble: HTMLElement) {\r\n    const item = this.getItemByBubble(bubble);\r\n    if(!item) {\r\n      return;\r\n    }\r\n\r\n    const items = this.itemsArr;\r\n    const index = items.indexOf(item);\r\n    const siblings = this.getSiblingsAtIndex(index, items);\r\n    \r\n    const group = item.group;\r\n    this.removeItem(item);\r\n    group.unmountItem(item);\r\n\r\n    const modifiedGroups: Set<BubbleGroup> = new Set();\r\n    modifiedGroups.add(group);\r\n\r\n    const [previousSibling, nextSibling] = siblings;\r\n    if(\r\n      previousSibling \r\n      && nextSibling \r\n      && this.canItemsBeGrouped(previousSibling, nextSibling) \r\n      && previousSibling.group !== nextSibling.group\r\n    ) {\r\n      const group = nextSibling.group;\r\n      this.f(nextSibling.group.items);\r\n      group.onItemUnmount();\r\n      modifiedGroups.add(previousSibling.group);\r\n      this.groupUngrouped();\r\n    }\r\n\r\n    this.mountUnmountGroups(Array.from(modifiedGroups));\r\n  }\r\n\r\n  mountUnmountGroups(groups: BubbleGroup[]) {\r\n    // groups.sort((a, b) => (b.lastItem?.mid ?? 0) - (a.lastItem?.mid ?? 0));\r\n\r\n    const [toMount, toUnmount] = partition(groups, (group) => !!group.items.length);\r\n    toUnmount.forEach((group) => {\r\n      group.onItemUnmount();\r\n    })\r\n\r\n    toMount.forEach((group) => {\r\n      group.mount(true);\r\n    });\r\n\r\n    // toMount.forEach((group) => {\r\n    //   group.updateClassNames();\r\n    // });\r\n  }\r\n\r\n  f(items: GroupItem[], index: number = 0, length = items.length) {\r\n    for(; index < length; ++index) {\r\n      const item = items[index];\r\n      item.mounted = false;\r\n      item.group.removeItem(item);\r\n      --length;\r\n      --index;\r\n    }\r\n  }\r\n\r\n  getItemByBubble(bubble: HTMLElement) {\r\n    return this.itemsMap.get(bubble);\r\n  }\r\n\r\n  getLastGroup() {\r\n    return this.groups[0];\r\n  }\r\n\r\n  changeBubbleMid(bubble: HTMLElement, mid: number) {\r\n    const item = this.getItemByBubble(bubble);\r\n    if(!item) {\r\n      return;\r\n    }\r\n\r\n    item.mid = mid;\r\n    \r\n    // indexOfAndSplice(item.group.items, item);\r\n    // // const canChangeGroupMid = !item.group.items.length || item.group.items.every((item) => item.groupMid === item.mid);\r\n    // // if(canChangeGroupMid) item.groupMid = mid;\r\n    // item.group.insertItem(item);\r\n    \r\n    indexOfAndSplice(this.itemsArr, item);\r\n    this.insertItemToArray(item, this.itemsArr);\r\n  }\r\n\r\n  changeItemBubble(item: GroupItem, bubble: HTMLElement) {\r\n    this.itemsMap.delete(item.bubble);\r\n    item.bubble = bubble;\r\n    this.itemsMap.set(bubble, item);\r\n  }\r\n  \r\n  changeBubbleByBubble(from: HTMLElement, to: HTMLElement) {\r\n    const item = this.getItemByBubble(from);\r\n    if(!item) {\r\n      return;\r\n    }\r\n    \r\n    this.changeItemBubble(item, to);\r\n  }\r\n\r\n  canItemsBeGrouped(item1: GroupItem, item2: GroupItem) { \r\n    return item2.fromId === item1.fromId \r\n      && Math.abs(item2.timestamp - item1.timestamp) <= this.newGroupDiff \r\n      && item1.dateTimestamp === item2.dateTimestamp \r\n      && !item1.single \r\n      && !item2.single;\r\n  }\r\n\r\n  getSiblingsAtIndex(itemIndex: number, items: GroupItem[]) {\r\n    return [items[itemIndex - 1], items[itemIndex + 1]] as const;\r\n  }\r\n\r\n  // findGroupSiblingInSiblings(item: GroupItem, siblings: ReturnType<BubbleGroups['getSiblingsAtIndex']>) {\r\n  //   return siblings.find((sibling) => sibling && this.canItemsBeGrouped(item, sibling));\r\n  // }\r\n\r\n  findGroupSiblingByItem(item: GroupItem, items: GroupItem[]) {\r\n    items = items.slice();\r\n    const idx = this.insertItemToArray(item, items);\r\n    // return this.findGroupSiblingInSiblings(item, this.getSiblingsAtIndex(idx, items));\r\n    return this.findGroupSiblingInItems(item, items, idx);\r\n  }\r\n\r\n  findGroupSiblingInItems(item: GroupItem, items: GroupItem[], index = items.indexOf(item), length = items.length) {\r\n    const previousItem = items[index - 1];\r\n    let siblingGroupedItem: GroupItem;\r\n    if(previousItem?.group && this.canItemsBeGrouped(item, previousItem)) {\r\n      siblingGroupedItem = previousItem;\r\n    } else {\r\n      for(let k = index + 1; k < length; ++k) {\r\n        const nextItem = items[k];\r\n        if(this.canItemsBeGrouped(item, nextItem)) {\r\n          if(nextItem.group) {\r\n            siblingGroupedItem = nextItem;\r\n          }\r\n        } else {\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    return siblingGroupedItem;\r\n  }\r\n\r\n  addItemToGroup(item: GroupItem, group: BubbleGroup) {\r\n    group.insertItem(item);\r\n    this.addItemToCache(item);\r\n  }\r\n\r\n  insertItemToArray(item: GroupItem, array: GroupItem[]) {\r\n    return insertInDescendSortedArray(array, item, this.sortItemsKey);\r\n  }\r\n\r\n  insertGroup(group: BubbleGroup) {\r\n    return insertInDescendSortedArray(this.groups, group, this.sortGroupsKey);\r\n  }\r\n\r\n  addItemToCache(item: GroupItem) {\r\n    this.insertItemToArray(item, this.itemsArr);\r\n    this.itemsMap.set(item.bubble, item);\r\n  }\r\n\r\n  removeItemFromCache(item: GroupItem) {\r\n    indexOfAndSplice(this.itemsArr, item);\r\n    this.itemsMap.delete(item.bubble);\r\n  }\r\n\r\n  getMessageFromId(message: MyMessage) {\r\n    let fromId = message.viaBotId || message.fromId;\r\n\r\n    // fix for saved messages forward to self\r\n    if(fromId === rootScope.myId && message.peerId === rootScope.myId && (message as Message.message).fwdFromId === fromId) {\r\n      fromId = fromId.toPeerId(true);\r\n    }\r\n\r\n    return fromId;\r\n  }\r\n\r\n  createItem(bubble: HTMLElement, message: MyMessage) {\r\n    const single = !(message._ === 'message' || (message.action && SERVICE_AS_REGULAR.has(message.action._)));\r\n    const {mid, date: timestamp} = message;\r\n    const {dateTimestamp} = this.chat.bubbles.getDateForDateContainer(timestamp);\r\n    const item: GroupItem = {\r\n      mid, \r\n      groupMid: this.chat.type === 'scheduled' ? +`${(timestamp * 1000 - dateTimestamp) / 1000}.${mid}` : mid, \r\n      fromId: this.getMessageFromId(message), \r\n      bubble, \r\n      // timestamp: this.chat.type === 'scheduled' ? +`${(timestamp * 1000 - dateTimestamp) / 1000}.${mid}` : timestamp, \r\n      timestamp,\r\n      dateTimestamp, \r\n      mounted: false, \r\n      single,\r\n      message\r\n    };\r\n\r\n    return item;\r\n  }\r\n\r\n  splitSiblingsOnGrouping(siblings: ReturnType<BubbleGroups['getSiblingsAtIndex']>) {\r\n    const [previousSibling, nextSibling] = siblings;\r\n    const previousGroup = previousSibling?.group;\r\n    const nextGroup = nextSibling?.group;\r\n\r\n    if(!previousGroup) {\r\n      return;\r\n    }\r\n\r\n    // will refresh group\r\n    // if(previousGroup === nextGroup) {\r\n      const items = previousGroup.items;\r\n      const index = items.indexOf(previousSibling) + 1;\r\n      const length = items.length;\r\n      if(index === length) {\r\n        return;\r\n      }\r\n\r\n      const modifiedGroups: BubbleGroup[] = [previousGroup];\r\n      // if(previousGroup !== nextGroup && nextGroup) {\r\n      //   modifiedGroups.push(nextGroup);\r\n      // }\r\n\r\n      this.f(items, index, length);\r\n      return modifiedGroups;\r\n    // }\r\n  }\r\n\r\n  prepareForGrouping(bubble: HTMLElement, message: MyMessage) {\r\n    const foundItem = this.getItemByBubble(bubble);\r\n    if(foundItem) { // should happen only on edit\r\n      // debugger;\r\n      return;\r\n    }\r\n\r\n    const item = this.createItem(bubble, message);\r\n    this.addItemToCache(item);\r\n  }\r\n\r\n  groupUngrouped() {\r\n    const items = this.itemsArr;\r\n    const length = items.length;\r\n    const modifiedGroups: Set<BubbleGroup> = new Set();\r\n    // for(let i = length - 1; i >= 0; --i) {\r\n    for(let i = 0; i < length; ++i) {\r\n      const item = items[i];\r\n      if(item.group) {\r\n        continue;\r\n      }\r\n\r\n      let hadGroup = true;\r\n      const siblings = this.getSiblingsAtIndex(i, items);\r\n      const siblingGroupedItem = this.findGroupSiblingInItems(item, items, i, length);\r\n\r\n      // const foundItem = this.findGroupSiblingInSiblings(item, siblings);\r\n      const foundItem = siblingGroupedItem;\r\n      const group = foundItem?.group ?? (hadGroup = false, new BubbleGroup(this.chat, this, item.dateTimestamp));\r\n\r\n      modifiedGroups.add(group);\r\n      group.insertItem(item);\r\n\r\n      if(!hadGroup) {\r\n        const splittedGroups = this.splitSiblingsOnGrouping(siblings);\r\n        if(splittedGroups) {\r\n          splittedGroups.forEach((group) => modifiedGroups.add(group));\r\n        }\r\n      }\r\n    }\r\n\r\n    return modifiedGroups;\r\n  }\r\n\r\n  // addBubble(bubble: HTMLElement, message: MyMessage, unmountIfFound?: boolean) {\r\n  //   const oldItem = this.getItemByBubble(bubble);\r\n  //   if(unmountIfFound) { // updating position\r\n  //     this.removeAndUnmountBubble(bubble);\r\n  //   } else if(oldItem) { // editing\r\n  //     const group = oldItem.group;\r\n  //     this.changeItemBubble(oldItem, bubble);\r\n  //     oldItem.mounted = false;\r\n\r\n  //     return {item: oldItem, group};\r\n  //   }\r\n\r\n  //   const item = this.createItem(bubble, message);\r\n\r\n  //   const foundItem = this.findSameGroupItem(item, this.itemsArr);\r\n\r\n  //   const group = foundItem?.group ?? new BubbleGroup(this.chat, this, item.dateTimestamp);\r\n  //   this.addItemToGroup(item, group);\r\n    \r\n  //   return {item, group};\r\n  // }\r\n\r\n  /* setClipIfNeeded(bubble: HTMLDivElement, remove = false) {\r\n    //console.log('setClipIfNeeded', bubble, remove);\r\n    const className = bubble.className;\r\n    if(className.includes('is-message-empty') && (className.includes('photo') || className.includes('video'))) {\r\n      let container = bubble.querySelector('.bubble__media-container') as SVGSVGElement;\r\n      //console.log('setClipIfNeeded', bubble, remove, container);\r\n      if(!container) return;\r\n\r\n      try {\r\n        Array.from(container.children).forEach((object) => {\r\n          if(object instanceof SVGDefsElement) return;\r\n  \r\n          if(remove) {\r\n            object.removeAttributeNS(null, 'clip-path');\r\n          } else {\r\n            let clipId = container.dataset.clipId;\r\n            let path = container.firstElementChild.firstElementChild.lastElementChild as SVGPathElement;\r\n            let width = +object.getAttributeNS(null, 'width');\r\n            let height = +object.getAttributeNS(null, 'height');\r\n            let isOut = className.includes('is-out');\r\n            let isReply = className.includes('is-reply');\r\n            let d = '';\r\n    \r\n            //console.log('setClipIfNeeded', object, width, height, isOut);\r\n    \r\n            let tr: number, tl: number;\r\n            if(className.includes('forwarded') || isReply) {\r\n              tr = tl = 0;\r\n            } else if(isOut) {\r\n              tr = className.includes('is-group-first') ? 12 : 6;\r\n              tl = 12;\r\n            } else {\r\n              tr = 12;\r\n              tl = className.includes('is-group-first') ? 12 : 6;\r\n            }\r\n    \r\n            if(isOut) {\r\n              d = generatePathData(0, 0, width - 9, height, tl, tr, 0, 12);\r\n            } else {\r\n              d = generatePathData(9, 0, width - 9, height, tl, tr, 12, 0);\r\n            }\r\n            \r\n            path.setAttributeNS(null, 'd', d);\r\n            object.setAttributeNS(null, 'clip-path', 'url(#' + clipId + ')');\r\n          }\r\n        });\r\n      } catch(err) {}\r\n    }\r\n  } */\r\n  \r\n  // updateGroupByMessageId(mid: number) {\r\n  //   const item = this.itemsArr.find((g) => g.mid === mid);\r\n  //   if(item) {\r\n  //     item.group.updateGroup();\r\n  //   }\r\n  // }\r\n  \r\n  cleanup() {\r\n    this.itemsArr = [];\r\n    this.groups = [];\r\n    this.itemsMap.clear();\r\n  }\r\n\r\n  // findIncorrentPositions() {\r\n  //   var bubbles = Array.from(this.chat.bubbles.chatInner.querySelectorAll('.bubbles-group .bubble')).reverse();\r\n  //   var items = this.itemsArr;\r\n  //   for(var i = 0, length = items.length; i < length; ++i) {\r\n  //     const item = items[i];\r\n  //     const foundBubble = bubbles[i];\r\n  //     if(item.bubble !== foundBubble) {\r\n  //       console.log('incorrect position', i, item, foundBubble);\r\n  //       // debugger;\r\n  //       // break;\r\n  //     }\r\n  //   }\r\n  // }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function partition<T>(arr: T[], callback: (item: T, idx: number, arr: T[]) => boolean) {\r\n  const good: T[] = [], bad: T[] = [];\r\n  for(let i = 0, length = arr.length; i < length; ++i) {\r\n    const item = arr[i];\r\n    (callback(item, i, arr) ? good : bad).push(item);\r\n  }\r\n\r\n  return [good, bad];\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement, { PopupOptions } from \".\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport I18n, { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport InputField from \"../inputField\";\r\n\r\nexport default class PopupDatePicker extends PopupElement {\r\n  protected controlsDiv: HTMLElement;\r\n  protected monthTitle: HTMLElement;\r\n  protected prevBtn: HTMLElement;\r\n  protected nextBtn: HTMLElement;\r\n\r\n  protected monthsContainer: HTMLElement;\r\n  protected month: HTMLElement;\r\n\r\n  protected minMonth: Date;\r\n  protected maxMonth: Date;\r\n  protected minDate: Date;\r\n  protected maxDate: Date;\r\n  protected selectedDate: Date;\r\n  protected selectedMonth: Date;\r\n  protected selectedEl: HTMLElement;\r\n\r\n  protected timeDiv: HTMLDivElement;\r\n  protected hoursInputField: InputField;\r\n  protected minutesInputField: InputField;\r\n\r\n  constructor(initDate: Date, public onPick: (timestamp: number) => void, protected options: Partial<{\r\n    noButtons: true, \r\n    noTitle: true, \r\n    minDate: Date,\r\n    maxDate: Date\r\n    withTime: true,\r\n    showOverflowMonths: true\r\n  }> & PopupOptions = {}) {\r\n    super('popup-date-picker', {\r\n      body: true, \r\n      overlayClosable: true, \r\n      buttons: options.noButtons ? [] : [{\r\n        langKey: 'JumpToDate',\r\n        callback: () => {\r\n          if(this.onPick) {\r\n            this.onPick(this.selectedDate.getTime() / 1000 | 0);\r\n          }\r\n        }\r\n      }, {\r\n        langKey: 'Cancel',\r\n        isCancel: true\r\n      }],\r\n      title: true,\r\n      ...options\r\n    });\r\n\r\n    this.minDate = options.minDate || new Date('2013-08-01T00:00:00');\r\n\r\n    if(initDate < this.minDate) {\r\n      initDate.setFullYear(this.minDate.getFullYear(), this.minDate.getMonth(), this.minDate.getDate());\r\n    }\r\n\r\n    // Controls\r\n    this.controlsDiv = document.createElement('div');\r\n    this.controlsDiv.classList.add('date-picker-controls');\r\n\r\n    this.prevBtn = document.createElement('button');\r\n    this.prevBtn.classList.add('btn-icon', 'tgico-down', 'date-picker-prev');\r\n    attachClickEvent(this.prevBtn, this.onPrevClick, {listenerSetter: this.listenerSetter});\r\n\r\n    this.nextBtn = document.createElement('button');\r\n    this.nextBtn.classList.add('btn-icon', 'tgico-down', 'date-picker-next');\r\n    attachClickEvent(this.nextBtn, this.onNextClick, {listenerSetter: this.listenerSetter});\r\n    \r\n    this.monthTitle = document.createElement('div');\r\n    this.monthTitle.classList.add('date-picker-month-title');\r\n\r\n    this.controlsDiv.append(this.prevBtn, this.monthTitle, this.nextBtn);\r\n\r\n    // Month\r\n    this.monthsContainer = document.createElement('div');\r\n    this.monthsContainer.classList.add('date-picker-months');\r\n    attachClickEvent(this.monthsContainer, this.onDateClick, {listenerSetter: this.listenerSetter});\r\n\r\n    this.body.append(this.controlsDiv, this.monthsContainer);\r\n\r\n    // Time inputs\r\n    if(options.withTime) {\r\n      this.timeDiv = document.createElement('div');\r\n      this.timeDiv.classList.add('date-picker-time');\r\n\r\n      const delimiter = document.createElement('div');\r\n      delimiter.classList.add('date-picker-time-delimiter');\r\n      delimiter.append(':');\r\n\r\n      const handleTimeInput = (max: number, inputField: InputField, onInput: (length: number) => void, onOverflow?: (number: number) => void) => {\r\n        const maxString = '' + max;\r\n        this.listenerSetter.add(inputField.input)('input', (e) => {\r\n          let value = inputField.value.replace(/\\D/g, '');\r\n          if(value.length > 2) {\r\n            value = value.slice(0, 2);\r\n          } else {\r\n            if((value.length === 1 && +value[0] > +maxString[0]) || (value.length === 2 && +value > max)) {\r\n              if(value.length === 2 && onOverflow) {\r\n                onOverflow(+value[1]);\r\n              }\r\n\r\n              value = '0' + value[0];\r\n            }\r\n          }\r\n\r\n          inputField.setValueSilently(value);\r\n          onInput(value.length);\r\n        });\r\n      };\r\n\r\n      this.hoursInputField = new InputField({plainText: true});\r\n      this.minutesInputField = new InputField({plainText: true});\r\n\r\n      handleTimeInput(23, this.hoursInputField, (length) => {\r\n        if(length === 2) {\r\n          this.minutesInputField.input.focus();\r\n        }\r\n\r\n        this.setTimeTitle();\r\n      }, (number) => {\r\n        this.minutesInputField.value = (number + this.minutesInputField.value).slice(0, 2);\r\n      });\r\n      handleTimeInput(59, this.minutesInputField, (length) => {\r\n        if(!length) {\r\n          this.hoursInputField.input.focus();\r\n        }\r\n\r\n        this.setTimeTitle();\r\n      });\r\n\r\n      this.selectedDate = initDate;\r\n\r\n      initDate.setMinutes(initDate.getMinutes() + 10);\r\n      \r\n      this.hoursInputField.setValueSilently(('0' + initDate.getHours()).slice(-2));\r\n      this.minutesInputField.setValueSilently(('0' + initDate.getMinutes()).slice(-2));\r\n\r\n      initDate.setHours(0, 0, 0, 0);\r\n      \r\n      this.timeDiv.append(this.hoursInputField.container, delimiter, this.minutesInputField.container);\r\n\r\n      attachClickEvent(this.btnConfirm, () => {\r\n        if(this.onPick) {\r\n          this.selectedDate.setHours(+this.hoursInputField.value || 0, +this.minutesInputField.value || 0, 0, 0);\r\n          this.onPick(this.selectedDate.getTime() / 1000 | 0);\r\n        }\r\n\r\n        this.hide();\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      this.body.append(this.timeDiv);\r\n\r\n      this.prevBtn.classList.add('primary');\r\n      this.nextBtn.classList.add('primary');\r\n    }\r\n\r\n    const popupCenterer = document.createElement('div');\r\n    popupCenterer.classList.add('popup-centerer');\r\n    popupCenterer.append(this.container);\r\n    this.element.append(popupCenterer);\r\n\r\n    //const passed = (initDate.getTime() - (initDate.getTimezoneOffset() * 60000)) % 86400000;\r\n    //this.selectedDate = this.maxDate = new Date(initDate.getTime() - passed);\r\n    initDate.setHours(0, 0, 0, 0);\r\n    this.selectedDate = initDate;\r\n\r\n    this.maxDate = options.maxDate || new Date();\r\n    this.maxDate.setHours(0, 0, 0, 0);\r\n\r\n    this.selectedMonth = new Date(this.selectedDate);\r\n    this.selectedMonth.setDate(1);\r\n\r\n    this.maxMonth = new Date(this.maxDate);\r\n    this.maxMonth.setDate(1);\r\n\r\n    this.minMonth = new Date(this.minDate);\r\n    this.minMonth.setHours(0, 0, 0, 0);\r\n    this.minMonth.setDate(1);\r\n\r\n    if(this.selectedMonth.getTime() === this.minMonth.getTime()) {\r\n      this.prevBtn.setAttribute('disabled', 'true');\r\n    }\r\n\r\n    if(this.selectedMonth.getTime() === this.maxMonth.getTime()) {\r\n      this.nextBtn.setAttribute('disabled', 'true');\r\n    }\r\n\r\n    if(options.noTitle) {\r\n      this.setTitle = () => {};\r\n    }\r\n\r\n    this.setTimeTitle();\r\n    this.setTitle();\r\n    this.setMonth();\r\n  }\r\n\r\n  onPrevClick = (e: MouseEvent) => {\r\n    this.selectedMonth.setMonth(this.selectedMonth.getMonth() - 1);\r\n    this.setMonth();\r\n\r\n    if(this.selectedMonth.getTime() === this.minMonth.getTime()) {\r\n      this.prevBtn.setAttribute('disabled', 'true');\r\n    }\r\n    \r\n    this.nextBtn.removeAttribute('disabled');\r\n  };\r\n\r\n  onNextClick = (e: MouseEvent) => {\r\n    this.selectedMonth.setMonth(this.selectedMonth.getMonth() + 1);\r\n    this.setMonth();\r\n\r\n    if(this.selectedMonth.getTime() === this.maxMonth.getTime()) {\r\n      this.nextBtn.setAttribute('disabled', 'true');\r\n    }\r\n\r\n    this.prevBtn.removeAttribute('disabled');\r\n  };\r\n\r\n  onDateClick = (e: MouseEvent) => {\r\n    //cancelEvent(e);\r\n    const target = e.target as HTMLElement;\r\n\r\n    if(!target.dataset.timestamp) return;\r\n\r\n    if(this.selectedEl) {\r\n      if(this.selectedEl === target) return;\r\n      this.selectedEl.classList.remove('active');\r\n    }\r\n\r\n    this.selectedEl = target;\r\n    \r\n    target.classList.add('active');\r\n    const timestamp = +target.dataset.timestamp;\r\n\r\n    this.selectedDate = new Date(timestamp);\r\n\r\n    this.setTitle();\r\n    this.setTimeTitle();\r\n  };\r\n\r\n  public setTimeTitle() {\r\n    if(this.btnConfirm && this.selectedDate) {\r\n      let key: LangPackKey, args: any[] = [];\r\n      const date = new Date();\r\n      date.setHours(0, 0, 0, 0);\r\n\r\n      const timeOptions: Intl.DateTimeFormatOptions = {\r\n        minute: '2-digit',\r\n        hour: '2-digit'\r\n      };\r\n      \r\n      const sendDate = new Date(this.selectedDate.getTime());\r\n      sendDate.setHours(+this.hoursInputField.value, +this.minutesInputField.value);\r\n\r\n      if(this.selectedDate.getTime() === date.getTime()) {\r\n        key = 'Schedule.SendToday';\r\n      }/*  else if(this.selectedDate.getTime() === (date.getTime() + 86400e3)) {\r\n        dayStr = 'Tomorrow';\r\n      } */ else {\r\n        key = 'Schedule.SendDate';\r\n\r\n        const dateOptions: Intl.DateTimeFormatOptions = {\r\n          month: 'short',\r\n          day: 'numeric'\r\n        };\r\n\r\n        if(sendDate.getFullYear() !== date.getFullYear()) {\r\n          dateOptions.year = 'numeric';\r\n        }\r\n\r\n        args.push(new I18n.IntlDateElement({\r\n          date: sendDate,\r\n          options: dateOptions\r\n        }).element);\r\n      }\r\n\r\n      args.push(new I18n.IntlDateElement({\r\n        date: sendDate,\r\n        options: timeOptions\r\n      }).element);\r\n\r\n      this.btnConfirm.firstChild.replaceWith(i18n(key, args));\r\n    }\r\n  }\r\n\r\n  public setTitle() {\r\n    //const splitted = this.selectedDate.toString().split(' ', 3);\r\n    //this.title.innerText = splitted[0] + ', ' + splitted[1] + ' ' + splitted[2];\r\n    this.title.textContent = '';\r\n    this.title.append(new I18n.IntlDateElement({\r\n      date: this.selectedDate,\r\n      options: {\r\n        day: 'numeric',\r\n        month: 'long',\r\n        weekday: 'short'\r\n      }\r\n    }).element);\r\n  }\r\n\r\n  private renderElement(disabled: boolean, innerText: string | HTMLElement = '') {\r\n    const el = document.createElement('button');\r\n    el.classList.add('btn-icon', 'date-picker-month-date');\r\n\r\n    if(disabled) {\r\n      el.setAttribute('disabled', 'true');\r\n    }\r\n\r\n    if(innerText) {\r\n      el.append(innerText);\r\n    }\r\n\r\n    return el;\r\n  }\r\n\r\n  public setMonth() {\r\n    const firstDate = new Date(this.selectedMonth);\r\n\r\n    const options: Intl.DateTimeFormatOptions = {\r\n      year: 'numeric',\r\n      month: this.timeDiv && mediaSizes.isMobile ? 'short' : 'long'\r\n    };\r\n\r\n    this.monthTitle.textContent = '';\r\n    this.monthTitle.append(new I18n.IntlDateElement({date: firstDate, options}).element);\r\n    //this.monthTitle.innerText = (this.timeDiv && mediaSizes.isMobile ? monthName.slice(0, 3) : monthName) + ' ' + this.selectedMonth.getFullYear();\r\n\r\n    if(this.month) {\r\n      this.month.remove();\r\n    }\r\n\r\n    this.month = document.createElement('div');\r\n    this.month.classList.add('date-picker-month');\r\n\r\n    const weekStartDate = new Date();\r\n    const day = weekStartDate.getDay();\r\n    if(day !== 1) {\r\n      weekStartDate.setHours(-24 * (day - 1)); \r\n    }\r\n\r\n    for(let i = 0; i < 7; ++i) {\r\n      const el = this.renderElement(true, new I18n.IntlDateElement({date: weekStartDate, options: {weekday: 'narrow'}}).element);\r\n      el.classList.remove('date-picker-month-date');\r\n      el.classList.add('date-picker-month-day');\r\n      this.month.append(el);\r\n      weekStartDate.setDate(weekStartDate.getDate() + 1);\r\n    }\r\n\r\n    // 0 - sunday\r\n    let dayIndex = firstDate.getDay() - 1;\r\n    if(dayIndex === -1) dayIndex = 7 - 1;\r\n\r\n    const clonedDate = new Date(firstDate.getTime());\r\n    clonedDate.setDate(clonedDate.getDate() - dayIndex - 1);\r\n\r\n    // Padding first week\r\n    for(let i = 0; i < dayIndex; ++i) {\r\n      if(this.options.showOverflowMonths) {\r\n        clonedDate.setDate(clonedDate.getDate() + 1);\r\n        this.month.append(this.renderElement(true, '' + clonedDate.getDate()));\r\n      } else {\r\n        this.month.append(this.renderElement(true));\r\n      }\r\n    }\r\n\r\n    do {\r\n      const date = firstDate.getDate();\r\n      const el = this.renderElement(firstDate > this.maxDate || firstDate < this.minDate, '' + date);\r\n      el.dataset.timestamp = '' + firstDate.getTime();\r\n\r\n      if(firstDate.getTime() === this.selectedDate.getTime()) {\r\n        this.selectedEl = el;\r\n        el.classList.add('active');\r\n      }\r\n\r\n      this.month.append(el);\r\n\r\n      firstDate.setDate(date + 1);\r\n    } while(firstDate.getDate() !== 1);\r\n\r\n    const remainder = this.month.childElementCount % 7;\r\n    if(this.options.showOverflowMonths && remainder) {\r\n      for(let i = remainder; i < 7; ++i) {\r\n        this.month.append(this.renderElement(true, '' + firstDate.getDate()));\r\n        firstDate.setDate(firstDate.getDate() + 1);\r\n      }\r\n    }\r\n\r\n    const lines = Math.ceil(this.month.childElementCount / 7);\r\n    this.container.dataset.lines = '' + lines;\r\n\r\n    this.monthsContainer.append(this.month);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default class StickyIntersector {\r\n  private headersObserver: IntersectionObserver;\r\n  private elementsObserver: IntersectionObserver;\r\n\r\n  constructor(private container: HTMLElement, private handler: (stuck: boolean, target: HTMLElement) => void) {\r\n    this.observeHeaders();\r\n    this.observeElements();\r\n  }\r\n\r\n  /**\r\n   * Sets up an intersection observer to notify when elements with the class\r\n   * `.sticky_sentinel--top` become visible/invisible at the top of the container.\r\n   * @param {!Element} container\r\n   */\r\n  private observeHeaders() {\r\n    this.headersObserver = new IntersectionObserver((entries) => {\r\n      for(const entry of entries) {\r\n        const targetInfo = entry.boundingClientRect;\r\n        const stickyTarget = entry.target.parentElement;\r\n        const rootBoundsInfo = entry.rootBounds;\r\n  \r\n        // Started sticking.\r\n        if(targetInfo.bottom < rootBoundsInfo.top) {\r\n          this.handler(true, stickyTarget);\r\n        }\r\n  \r\n        // Stopped sticking.\r\n        if(targetInfo.bottom >= rootBoundsInfo.top &&\r\n            targetInfo.bottom < rootBoundsInfo.bottom) {\r\n          this.handler(false, stickyTarget);\r\n        }\r\n      }\r\n    }, {threshold: 0, root: this.container});\r\n  }\r\n  \r\n  private observeElements() {\r\n    this.elementsObserver = new IntersectionObserver((entries) => {\r\n      const entry = entries\r\n      .filter((entry) => entry.boundingClientRect.top < entry.rootBounds.top)\r\n      .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top)[0];\r\n      if(!entry) return;\r\n\r\n      const container = entry.isIntersecting ? entry.target : entry.target.nextElementSibling;\r\n      this.handler(true, container as HTMLElement);\r\n    }, {root: this.container});\r\n  }\r\n\r\n  /**\r\n   * @param {!Element} container\r\n   * @param {string} className\r\n   */\r\n  private addSentinel(container: HTMLElement, className: string) {\r\n    const sentinel = document.createElement('div');\r\n    sentinel.classList.add('sticky_sentinel', className);\r\n    return container.appendChild(sentinel);\r\n  }\r\n\r\n  /**\r\n   * Notifies when elements w/ the `sticky` class begin to stick or stop sticking.\r\n   * Note: the elements should be children of `container`.\r\n   * @param {!Element} container\r\n   */\r\n  public observeStickyHeaderChanges(element: HTMLElement) {\r\n    const headerSentinel = this.addSentinel(element, 'sticky_sentinel--top');\r\n    this.headersObserver.observe(headerSentinel);\r\n\r\n    this.elementsObserver.observe(element);\r\n  }\r\n\r\n  public disconnect() {\r\n    this.headersObserver.disconnect();\r\n    this.elementsObserver.disconnect();\r\n  }\r\n\r\n  public unobserve(element: HTMLElement, headerSentinel: HTMLElement) {\r\n    this.elementsObserver.unobserve(element);\r\n    this.headersObserver.unobserve(headerSentinel);\r\n  }\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport callbackify from \"../../helpers/callbackify\";\r\nimport formatNumber from \"../../helpers/number/formatNumber\";\r\nimport { fastRaf } from \"../../helpers/schedulers\";\r\nimport { MessagePeerReaction, ReactionCount } from \"../../layer\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport StackedAvatars from \"../stackedAvatars\";\r\nimport { wrapSticker, wrapStickerAnimation } from \"../wrappers\";\r\nimport { Awaited } from \"../../types\";\r\n\r\nconst CLASS_NAME = 'reaction';\r\nconst TAG_NAME = CLASS_NAME + '-element';\r\nconst REACTION_INLINE_SIZE = 14;\r\nconst REACTION_BLOCK_SIZE = 22;\r\n\r\nexport const REACTION_DISPLAY_INLINE_COUNTER_AT = 2;\r\nexport const REACTION_DISPLAY_BLOCK_COUNTER_AT = 4;\r\n\r\nexport type ReactionLayoutType = 'block' | 'inline';\r\n\r\nexport default class ReactionElement extends HTMLElement {\r\n  private type: ReactionLayoutType;\r\n  private counter: HTMLElement;\r\n  private stickerContainer: HTMLElement;\r\n  private stackedAvatars: StackedAvatars;\r\n  private canRenderAvatars: boolean;\r\n  private _reactionCount: ReactionCount;\r\n  private wrapStickerPromise: Awaited<ReturnType<typeof wrapSticker>>['render'];\r\n  private managers: AppManagers;\r\n\r\n  constructor() {\r\n    super();\r\n    this.classList.add(CLASS_NAME);\r\n    this.managers = rootScope.managers;\r\n  }\r\n\r\n  public get reactionCount() {\r\n    return this._reactionCount;\r\n  }\r\n  \r\n  public set reactionCount(reactionCount: ReactionCount) {\r\n    this._reactionCount = reactionCount;\r\n  }\r\n\r\n  public get count() {\r\n    return this.reactionCount.count;\r\n  }\r\n\r\n  public init(type: ReactionLayoutType) {\r\n    this.type = type;\r\n    this.classList.add(CLASS_NAME + '-' + type);\r\n  }\r\n\r\n  public setCanRenderAvatars(canRenderAvatars: boolean) {\r\n    this.canRenderAvatars = canRenderAvatars;\r\n  }\r\n\r\n  public render(doNotRenderSticker?: boolean) {\r\n    const hadStickerContainer = !!this.stickerContainer;\r\n    if(!hadStickerContainer) {\r\n      this.stickerContainer = document.createElement('div');\r\n      this.stickerContainer.classList.add(CLASS_NAME + '-sticker');\r\n      this.append(this.stickerContainer);\r\n    }\r\n    \r\n    const reactionCount = this.reactionCount;\r\n    if(!doNotRenderSticker && !hadStickerContainer) {\r\n      const availableReaction = this.managers.appReactionsManager.getReaction(reactionCount.reaction);\r\n      callbackify(availableReaction, (availableReaction) => {\r\n        if(!availableReaction.center_icon) {\r\n          this.stickerContainer.classList.add('is-static');\r\n        }\r\n\r\n        if(availableReaction.pFlags.inactive) {\r\n          this.classList.add('is-inactive');\r\n        }\r\n\r\n        const size = this.type === 'inline' ? REACTION_INLINE_SIZE : REACTION_BLOCK_SIZE;\r\n        const wrapPromise = this.wrapStickerPromise = wrapSticker({\r\n          div: this.stickerContainer,\r\n          doc: availableReaction.center_icon ?? availableReaction.static_icon,\r\n          width: size,\r\n          height: size,\r\n          static: true,\r\n          managers: this.managers\r\n        }).then(({render}) => render).finally(() => {\r\n          if(this.wrapStickerPromise === wrapPromise) {\r\n            this.wrapStickerPromise = undefined;\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  public renderCounter() {\r\n    const reactionCount = this.reactionCount;\r\n    const displayOn = this.type === 'inline' ? REACTION_DISPLAY_INLINE_COUNTER_AT : REACTION_DISPLAY_BLOCK_COUNTER_AT;\r\n    if(reactionCount.count >= displayOn || (this.type === 'block' && !this.canRenderAvatars)) {\r\n      if(!this.counter) {\r\n        this.counter = document.createElement(this.type === 'inline' ? 'i' : 'span');\r\n        this.counter.classList.add(CLASS_NAME + '-counter');\r\n      }\r\n\r\n      const formatted = formatNumber(reactionCount.count);\r\n      if(this.counter.textContent !== formatted) {\r\n        this.counter.textContent = formatted;\r\n      }\r\n\r\n      if(!this.counter.parentElement) {\r\n        this.append(this.counter);\r\n      }\r\n    } else if(this.counter?.parentElement) {\r\n      this.counter.remove();\r\n      this.counter = undefined;\r\n    }\r\n  }\r\n\r\n  public renderAvatars(recentReactions: MessagePeerReaction[]) {\r\n    if(this.type === 'inline') {\r\n      return;\r\n    }\r\n\r\n    if(this.reactionCount.count >= REACTION_DISPLAY_BLOCK_COUNTER_AT || !this.canRenderAvatars) {\r\n      if(this.stackedAvatars) {\r\n        this.stackedAvatars.container.remove();\r\n        this.stackedAvatars = undefined;\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    if(!this.stackedAvatars) {\r\n      this.stackedAvatars = new StackedAvatars({\r\n        avatarSize: 24\r\n      });\r\n\r\n      this.append(this.stackedAvatars.container);\r\n    }\r\n\r\n    this.stackedAvatars.render(recentReactions.map((reaction) => getPeerId(reaction.peer_id)));\r\n  }\r\n\r\n  public setIsChosen(isChosen = !!this.reactionCount.pFlags.chosen) {\r\n    if(this.type === 'inline') return;\r\n    const wasChosen = this.classList.contains('is-chosen') && !this.classList.contains('backwards');\r\n    if(wasChosen !== isChosen) {\r\n      SetTransition(this, 'is-chosen', isChosen, this.isConnected ? 300 : 0);\r\n    }\r\n  }\r\n\r\n  public fireAroundAnimation() {\r\n    callbackify(this.managers.appReactionsManager.getReaction(this.reactionCount.reaction), (availableReaction) => {\r\n      const size = this.type === 'inline' ? REACTION_INLINE_SIZE + 14 : REACTION_BLOCK_SIZE + 18;\r\n      const div = document.createElement('div');\r\n      div.classList.add(CLASS_NAME + '-sticker-activate');\r\n\r\n      Promise.all([\r\n        wrapSticker({\r\n          div: div,\r\n          doc: availableReaction.center_icon,\r\n          width: size,\r\n          height: size,\r\n          withThumb: false,\r\n          needUpscale: true,\r\n          play: false,\r\n          skipRatio: 1,\r\n          group: 'none',\r\n          needFadeIn: false,\r\n          managers: this.managers\r\n        }).then(({render}) => render as Promise<RLottiePlayer>),\r\n\r\n        wrapStickerAnimation({\r\n          doc: availableReaction.around_animation,\r\n          size: 80,\r\n          target: this.stickerContainer,\r\n          side: 'center',\r\n          skipRatio: 1,\r\n          play: false,\r\n          managers: this.managers\r\n        }).stickerPromise\r\n      ]).then(([iconPlayer, aroundPlayer]) => {\r\n        const remove = () => {\r\n          // if(!isInDOM(div)) return;\r\n          fastRaf(() => {\r\n            // if(!isInDOM(div)) return;\r\n            iconPlayer.remove();\r\n            div.remove();\r\n            this.stickerContainer.classList.remove('has-animation');\r\n          });\r\n        };\r\n\r\n        iconPlayer.addEventListener('enterFrame', (frameNo) => {\r\n          if(frameNo === iconPlayer.maxFrame) {\r\n            if(this.wrapStickerPromise) { // wait for fade in animation\r\n              this.wrapStickerPromise.then(() => {\r\n                setTimeout(remove, 1e3);\r\n              });\r\n            } else {\r\n              remove();\r\n            }\r\n          }\r\n        });\r\n\r\n        iconPlayer.addEventListener('firstFrame', () => {\r\n          this.stickerContainer.append(div);\r\n          this.stickerContainer.classList.add('has-animation');\r\n          iconPlayer.play();\r\n          aroundPlayer.play();\r\n        }, {once: true});\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\ncustomElements.define(TAG_NAME, ReactionElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport forEachReverse from \"../../helpers/array/forEachReverse\";\r\nimport positionElementByIndex from \"../../helpers/dom/positionElementByIndex\";\r\nimport { Message, ReactionCount } from \"../../layer\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport ReactionElement, { ReactionLayoutType, REACTION_DISPLAY_BLOCK_COUNTER_AT } from \"./reaction\";\r\n\r\nconst CLASS_NAME = 'reactions';\r\nconst TAG_NAME = CLASS_NAME + '-element';\r\n\r\nconst REACTIONS_ELEMENTS: Map<string, Set<ReactionsElement>> = new Map();\r\nexport { REACTIONS_ELEMENTS };\r\n\r\nexport default class ReactionsElement extends HTMLElement {\r\n  private message: Message.message;\r\n  private key: string;\r\n  private isPlaceholder: boolean;\r\n  private type: ReactionLayoutType;\r\n  private sorted: ReactionElement[];\r\n  private onConnectCallback: () => void;\r\n  private managers: AppManagers;\r\n\r\n  constructor() {\r\n    super();\r\n    this.classList.add(CLASS_NAME);\r\n    this.sorted = [];\r\n    this.managers = rootScope.managers;\r\n  }\r\n  \r\n  connectedCallback() {\r\n    let set = REACTIONS_ELEMENTS.get(this.key);\r\n    if(!set) {\r\n      REACTIONS_ELEMENTS.set(this.key, set = new Set());\r\n    }\r\n\r\n    set.add(this);\r\n\r\n    if(this.onConnectCallback && this.isConnected) {\r\n      this.onConnectCallback();\r\n      this.onConnectCallback = undefined;\r\n    }\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    const set = REACTIONS_ELEMENTS.get(this.key);\r\n    set.delete(this);\r\n    if(!set.size) {\r\n      REACTIONS_ELEMENTS.delete(this.key);\r\n    }\r\n  }\r\n\r\n  public getReactionCount(reactionElement: ReactionElement) {\r\n    return this.sorted[this.sorted.indexOf(reactionElement)].reactionCount;\r\n  }\r\n\r\n  public getMessage() {\r\n    return this.message;\r\n  }\r\n\r\n  public init(message: Message.message, type: ReactionLayoutType, isPlaceholder?: boolean) {\r\n    if(this.key !== undefined) {\r\n      this.disconnectedCallback();\r\n    }\r\n\r\n    this.message = message;\r\n    this.key = this.message.peerId + '_' + this.message.mid;\r\n    this.isPlaceholder = isPlaceholder;\r\n\r\n    if(this.type !== type) {\r\n      this.type = type;\r\n      this.classList.add(CLASS_NAME + '-' + type);\r\n    }\r\n\r\n    this.connectedCallback();\r\n  }\r\n\r\n  public changeMessage(message: Message.message) {\r\n    return this.init(message, this.type, this.isPlaceholder);\r\n  }\r\n\r\n  public update(message: Message.message, changedResults?: ReactionCount[]) {\r\n    this.message = message;\r\n    this.render(changedResults);\r\n  }\r\n\r\n  public render(changedResults?: ReactionCount[]) {\r\n    const reactions = this.message.reactions;\r\n    const hasReactions = !!(reactions && reactions.results.length);\r\n    this.classList.toggle('has-no-reactions', !hasReactions);\r\n    if(!hasReactions && !this.sorted.length) return;\r\n\r\n    const availableReactionsResult = this.managers.appReactionsManager.getAvailableReactions();\r\n    // callbackify(availableReactionsResult, () => {\r\n      const counts = hasReactions ? (\r\n        availableReactionsResult instanceof Promise ? \r\n          reactions.results : \r\n          reactions.results.filter((reactionCount) => {\r\n            return this.managers.appReactionsManager.isReactionActive(reactionCount.reaction);\r\n          })\r\n      ) : [];\r\n\r\n      forEachReverse(this.sorted, (reactionElement, idx, arr) => {\r\n        const reaction = reactionElement.reactionCount.reaction;\r\n        const found = counts.some((reactionCount) => reactionCount.reaction === reaction);\r\n        if(!found) {\r\n          arr.splice(idx, 1);\r\n          reactionElement.remove();\r\n        }\r\n      });\r\n\r\n      const totalReactions = counts.reduce((acc, c) => acc + c.count, 0);\r\n      const canRenderAvatars = reactions && !!reactions.pFlags.can_see_list && totalReactions < REACTION_DISPLAY_BLOCK_COUNTER_AT;\r\n      this.sorted = counts.map((reactionCount, idx) => {\r\n        const reactionElementIdx = this.sorted.findIndex((reactionElement) => reactionElement.reactionCount.reaction === reactionCount.reaction);\r\n        let reactionElement = reactionElementIdx !== -1 && this.sorted[reactionElementIdx];\r\n        if(!reactionElement) {\r\n          reactionElement = new ReactionElement();\r\n          reactionElement.init(this.type);\r\n        }\r\n\r\n        positionElementByIndex(reactionElement, this, idx);\r\n        \r\n        const recentReactions = reactions.recent_reactions ? reactions.recent_reactions.filter((reaction) => reaction.reaction === reactionCount.reaction) : [];\r\n        reactionElement.reactionCount = {...reactionCount};\r\n        reactionElement.setCanRenderAvatars(canRenderAvatars);\r\n        reactionElement.render(this.isPlaceholder);\r\n        reactionElement.renderCounter();\r\n        reactionElement.renderAvatars(recentReactions);\r\n        reactionElement.setIsChosen();\r\n\r\n        return reactionElement;\r\n      });\r\n\r\n      // this.sorted.forEach((reactionElement, idx) => {\r\n      //   /* if(this.type === 'block' && this.childElementCount !== this.sorted.length) { // because of appended time\r\n      //     idx += 1;\r\n      //   } */\r\n\r\n      //   positionElementByIndex(reactionElement, this, idx);\r\n      // });\r\n\r\n      if(!this.isPlaceholder && changedResults?.length) {\r\n        if(this.isConnected) {\r\n          this.handleChangedResults(changedResults);\r\n        } else {\r\n          this.onConnectCallback = () => {\r\n            this.handleChangedResults(changedResults);\r\n          };\r\n        }\r\n      }\r\n    // });\r\n\r\n    // !       ,     \r\n    if(!this.sorted.length && this.type === 'block') {\r\n      const parentElement = this.parentElement;\r\n      this.remove();\r\n\r\n      if(parentElement.classList.contains('document-message') && !parentElement.childNodes.length) {\r\n        parentElement.remove();\r\n        return;\r\n      }\r\n\r\n      const timeSpan = this.querySelector('.time');\r\n      if(timeSpan) {\r\n        parentElement.append(timeSpan);\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleChangedResults(changedResults: ReactionCount[]) {\r\n    // ! temp\r\n    if(this.message.peerId !== appImManager.chat.peerId) return;\r\n\r\n    changedResults.forEach((reactionCount) => {\r\n      const reactionElement = this.sorted.find((reactionElement) => reactionElement.reactionCount.reaction === reactionCount.reaction);\r\n      if(reactionElement) {\r\n        reactionElement.fireAroundAnimation();\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\ncustomElements.define(TAG_NAME, ReactionsElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Message } from \"../../layer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport ripple from \"../ripple\";\r\nimport I18n from \"../../lib/langPack\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport StackedAvatars from \"../stackedAvatars\";\r\nimport formatNumber from \"../../helpers/number/formatNumber\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport type LazyLoadQueue from \"../lazyLoadQueue\";\r\n\r\nconst TAG_NAME = 'replies-element';\r\n\r\nrootScope.addEventListener('replies_updated', (message) => {\r\n  (Array.from(document.querySelectorAll(TAG_NAME + `[data-post-key=\"${message.peerId}_${message.mid}\"]`)) as RepliesElement[]).forEach((element) => {\r\n    element.message = message;\r\n    element.render();\r\n  });\r\n});\r\n\r\nexport default class RepliesElement extends HTMLElement {\r\n  public message: Message.message;\r\n  public type: 'footer' | 'beside';\r\n  public loadPromises: Promise<any>[];\r\n  public lazyLoadQueue: LazyLoadQueue;\r\n  public stackedAvatars: StackedAvatars;\r\n  public text: I18n.IntlElement;\r\n  public managers: AppManagers;\r\n  \r\n  private updated = false;\r\n\r\n  constructor() {\r\n    super();\r\n    this.managers = rootScope.managers;\r\n  }\r\n\r\n  public init() {\r\n    this.render();\r\n    this.dataset.postKey = this.message.peerId + '_' + this.message.mid;\r\n    this.classList.add('replies', 'replies-' + this.type);\r\n  }\r\n\r\n  public render() {\r\n    const replies = this.message.replies;\r\n\r\n    /* if(this.firstChild) {\r\n      this.innerHTML = '';\r\n    } */\r\n\r\n    if(this.type === 'footer') {\r\n      let leftPart: HTMLElement;\r\n      if(this.firstElementChild) {\r\n        leftPart = this.firstElementChild as HTMLElement;\r\n      }\r\n\r\n      if(replies?.recent_repliers) {\r\n        if(leftPart && !leftPart.classList.contains('replies-footer-avatars')) {\r\n          this.innerHTML = '';\r\n          leftPart = null;\r\n        }\r\n\r\n        if(!this.stackedAvatars) {\r\n          this.stackedAvatars = new StackedAvatars({\r\n            lazyLoadQueue: this.lazyLoadQueue,\r\n            avatarSize: 30\r\n          });\r\n\r\n          this.stackedAvatars.container.classList.add('replies-footer-avatars');\r\n        }\r\n\r\n        leftPart = this.stackedAvatars.container;\r\n\r\n        this.stackedAvatars.render(replies.recent_repliers.map((peer) => getPeerId(peer)), this.loadPromises);\r\n      } else {\r\n        if(leftPart && !leftPart.classList.contains('tgico-comments')) {\r\n          leftPart.remove();\r\n          leftPart = null;\r\n        }\r\n\r\n        if(!leftPart) {\r\n          leftPart = document.createElement('span');\r\n          leftPart.classList.add('tgico-comments');\r\n        }\r\n      }\r\n\r\n      if(!leftPart.parentElement) {\r\n        this.prepend(leftPart);\r\n      }\r\n  \r\n      if(!this.text) {\r\n        this.text = new I18n.IntlElement();\r\n      }\r\n\r\n      const text = this.text;\r\n      if(replies) {\r\n        if(replies.replies) {\r\n          text.compareAndUpdate({key: 'Comments', args: [replies.replies]});\r\n        } else {\r\n          text.compareAndUpdate({key: 'LeaveAComment'});\r\n        }\r\n      } else {\r\n        text.compareAndUpdate({key: 'ViewInChat'});\r\n      }\r\n\r\n      if(replies) {\r\n        // const historyStorage = appMessagesManager.getHistoryStorage(replies.channel_id.toPeerId(true));\r\n        let isUnread = false;\r\n        if(replies.replies) {\r\n          if(replies.read_max_id !== undefined && replies.max_id !== undefined) {\r\n            isUnread = replies.read_max_id < replies.max_id;\r\n          }/*  else {\r\n            isUnread = !historyStorage.readMaxId || historyStorage.readMaxId < (replies.max_id || 0);\r\n          } */\r\n        }\r\n        this.classList.toggle('is-unread', isUnread);\r\n      }\r\n\r\n      let textSpan = this.children[1] as HTMLElement;\r\n      if(!textSpan) {\r\n        textSpan = document.createElement('span');\r\n        textSpan.classList.add('replies-footer-text');\r\n\r\n        const iconSpan = document.createElement('span');\r\n        iconSpan.classList.add('tgico-next');\r\n\r\n        const rippleContainer = document.createElement('div');\r\n        ripple(rippleContainer);\r\n\r\n        this.append(textSpan, iconSpan, rippleContainer);\r\n      }\r\n\r\n      replaceContent(textSpan, text.element);\r\n    } else {\r\n      this.classList.add('bubble-beside-button');\r\n      this.innerHTML = `<span class=\"tgico-commentssticker\"></span><span class=\"replies-beside-text\">${replies?.replies ? formatNumber(replies.replies, 0) : ''}</span>`;\r\n    }\r\n\r\n    if(replies && !this.updated && !this.message.pFlags.is_outgoing) {\r\n      this.managers.appMessagesManager.subscribeRepliesThread(this.message.peerId, this.message.mid);\r\n      this.managers.appMessagesManager.updateMessage(this.message.peerId, this.message.mid, 'replies_updated');\r\n      this.updated = true;\r\n    }\r\n\r\n    if(this.loadPromises) {\r\n      this.loadPromises = undefined;\r\n    }\r\n  }\r\n}\r\n\r\ncustomElements.define(TAG_NAME, RepliesElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { formatTime, getFullDate } from \"../../helpers/date\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport formatNumber from \"../../helpers/number/formatNumber\";\r\nimport { Message } from \"../../layer\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport { i18n, _i18n } from \"../../lib/langPack\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport type LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport { wrapReply } from \"../wrappers\";\r\nimport Chat, { ChatType } from \"./chat\";\r\nimport ReactionsElement from \"./reactions\";\r\nimport RepliesElement from \"./replies\";\r\n\r\nconst NBSP = '&nbsp;';\r\n\r\nconst makeEdited = () => {\r\n  const edited = document.createElement('i');\r\n  edited.classList.add('edited');\r\n  _i18n(edited, 'EditedMessage');\r\n  return edited;\r\n};\r\n\r\nconst makeSponsored = () => i18n('SponsoredMessage');\r\n\r\nexport namespace MessageRender {\r\n  /* export const setText = () => {\r\n\r\n  }; */\r\n\r\n  export const setTime = (options: {\r\n    chatType: ChatType, \r\n    message: Message.message | Message.messageService,\r\n    reactionsMessage?: Message.message\r\n  }) => {\r\n    const {chatType, message} = options;\r\n    const date = new Date(message.date * 1000);\r\n    const args: (HTMLElement | string)[] = [];\r\n    \r\n    let editedSpan: HTMLElement, sponsoredSpan: HTMLElement, reactionsElement: ReactionsElement, reactionsMessage: Message.message;\r\n    \r\n    const isSponsored = !!(message as Message.message).pFlags.sponsored;\r\n    const isMessage = !('action' in message) && !isSponsored;\r\n    let hasReactions: boolean;\r\n    \r\n    let time: HTMLElement = isSponsored ? undefined : formatTime(date);\r\n    if(isMessage) {\r\n      if(message.views) {\r\n        const postAuthor = message.post_author || message.fwd_from?.post_author;\r\n  \r\n        const postViewsSpan = document.createElement('span');\r\n        postViewsSpan.classList.add('post-views');\r\n        postViewsSpan.innerHTML = formatNumber(message.views, 1);\r\n  \r\n        const channelViews = document.createElement('i');\r\n        channelViews.classList.add('tgico-channelviews', 'time-icon');\r\n  \r\n        args.push(postViewsSpan, channelViews);\r\n        if(postAuthor) {\r\n          const span = document.createElement('span');\r\n          setInnerHTML(span, wrapEmojiText(postAuthor));\r\n          span.insertAdjacentHTML('beforeend', ',' + NBSP)\r\n          args.push(span);\r\n        }\r\n      }\r\n\r\n      if(message.edit_date && chatType !== 'scheduled' && !message.pFlags.edit_hide) {\r\n        args.unshift(editedSpan = makeEdited());\r\n      }\r\n  \r\n      if(chatType !== 'pinned' && message.pFlags.pinned) {\r\n        const i = document.createElement('i');\r\n        i.classList.add('tgico-pinnedchat', 'time-icon');\r\n        args.unshift(i);\r\n      }\r\n\r\n      if(message.peer_id._ === 'peerUser'/*  && message.reactions?.results?.length */) {\r\n        hasReactions = true;\r\n\r\n        reactionsMessage = options.reactionsMessage;\r\n        reactionsElement = new ReactionsElement();\r\n        reactionsElement.init(reactionsMessage, 'inline', true);\r\n        reactionsElement.render();\r\n        args.unshift(reactionsElement);\r\n      }\r\n    } else if(isSponsored) {\r\n      args.push(sponsoredSpan = makeSponsored());\r\n    }\r\n    \r\n    if(time) {\r\n      args.push(time);\r\n    }\r\n\r\n    let title = isSponsored ? undefined : getFullDate(date);\r\n    if(isMessage) {\r\n      title += (message.edit_date && !message.pFlags.edit_hide ? `\\nEdited: ${getFullDate(new Date(message.edit_date * 1000))}` : '')\r\n        + (message.fwd_from ? `\\nOriginal: ${getFullDate(new Date(message.fwd_from.date * 1000))}` : '');\r\n    }\r\n\r\n    const timeSpan = document.createElement('span');\r\n    timeSpan.classList.add('time', 'tgico');\r\n    // if(title) timeSpan.title = title;\r\n    timeSpan.append(...args);\r\n\r\n    const inner = document.createElement('div');\r\n    inner.classList.add('inner', 'tgico');\r\n    if(title) inner.title = title;\r\n\r\n    let clonedArgs = args;\r\n    if(editedSpan) {\r\n      clonedArgs[clonedArgs.indexOf(editedSpan)] = makeEdited();\r\n    }\r\n    if(sponsoredSpan) {\r\n      clonedArgs[clonedArgs.indexOf(sponsoredSpan)] = makeSponsored();\r\n    }\r\n    if(reactionsElement) {\r\n      const _reactionsElement = clonedArgs[clonedArgs.indexOf(reactionsElement)] = new ReactionsElement();\r\n      _reactionsElement.init(reactionsMessage, 'inline');\r\n      _reactionsElement.render();\r\n    }\r\n    clonedArgs = clonedArgs.map((a) => a instanceof HTMLElement && !a.classList.contains('i18n') && !a.classList.contains('reactions') ? a.cloneNode(true) as HTMLElement : a);\r\n    if(time) {\r\n      clonedArgs[clonedArgs.length - 1] = formatTime(date); // clone time\r\n    }\r\n    inner.append(...clonedArgs);\r\n\r\n    timeSpan.append(inner);\r\n\r\n    return timeSpan;\r\n  };\r\n\r\n  export const renderReplies = ({bubble, bubbleContainer, message, messageDiv, loadPromises, lazyLoadQueue}: {\r\n    bubble: HTMLElement,\r\n    bubbleContainer: HTMLElement,\r\n    message: Message.message,\r\n    messageDiv: HTMLElement,\r\n    loadPromises?: Promise<any>[],\r\n    lazyLoadQueue?: LazyLoadQueue\r\n  }) => {\r\n    const isFooter = !bubble.classList.contains('sticker') && !bubble.classList.contains('emoji-big') && !bubble.classList.contains('round');\r\n    const repliesFooter = new RepliesElement();\r\n    repliesFooter.message = message;\r\n    repliesFooter.type = isFooter ? 'footer' : 'beside';\r\n    repliesFooter.loadPromises = loadPromises;\r\n    repliesFooter.lazyLoadQueue = lazyLoadQueue;\r\n    repliesFooter.init();\r\n    bubbleContainer.prepend(repliesFooter);\r\n    return isFooter;\r\n  };\r\n\r\n  export const setReply = async({chat, bubble, bubbleContainer, message}: {\r\n    chat: Chat,\r\n    bubble: HTMLElement,\r\n    bubbleContainer?: HTMLElement,\r\n    message: Message.message\r\n  }) => {\r\n    const isReplacing = !bubbleContainer;\r\n    if(isReplacing) {\r\n      bubbleContainer = bubble.querySelector('.bubble-content');\r\n    }\r\n\r\n    const currentReplyDiv = isReplacing ? bubbleContainer.querySelector('.reply') : null;\r\n    if(!message.reply_to_mid) {\r\n      if(currentReplyDiv) {\r\n        currentReplyDiv.remove();\r\n      }\r\n\r\n      bubble.classList.remove('is-reply');\r\n      return;\r\n    }\r\n\r\n\r\n    const replyToPeerId = message.reply_to.reply_to_peer_id ? getPeerId(message.reply_to.reply_to_peer_id) : chat.peerId;\r\n\r\n    let originalMessage = await rootScope.managers.appMessagesManager.getMessageByPeer(replyToPeerId, message.reply_to_mid);\r\n    let originalPeerTitle: string | HTMLElement;\r\n    \r\n    /////////this.log('message to render reply', originalMessage, originalPeerTitle, bubble, message);\r\n    \r\n    let titlePeerId: PeerId;\r\n    // need to download separately\r\n    if(!originalMessage) {\r\n      //////////this.log('message to render reply empty, need download', message, message.reply_to_mid);\r\n      rootScope.managers.appMessagesManager.fetchMessageReplyTo(message);\r\n      chat.bubbles.needUpdate.push({replyToPeerId, replyMid: message.reply_to_mid, mid: message.mid});\r\n      \r\n      originalPeerTitle = i18n('Loading');\r\n    } else {\r\n      const originalMessageFwdFromId = (originalMessage as Message.message).fwdFromId;\r\n      titlePeerId = message.fwdFromId && message.fwdFromId === originalMessageFwdFromId ? message.fwdFromId : originalMessage.fromId || originalMessageFwdFromId;\r\n      originalPeerTitle = new PeerTitle({\r\n        peerId: titlePeerId,\r\n        dialog: false,\r\n        onlyFirstName: false,\r\n        plainText: false\r\n      }).element;\r\n    }\r\n\r\n    const {container, fillPromise} = wrapReply(originalPeerTitle, undefined, originalMessage, chat.isAnyGroup ? titlePeerId : undefined);\r\n    await fillPromise;\r\n    if(currentReplyDiv) {\r\n      currentReplyDiv.replaceWith(container);\r\n    } else {\r\n      bubbleContainer.append(container);\r\n    }\r\n    //bubbleContainer.insertBefore(, nameContainer);\r\n    bubble.classList.add('is-reply');\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\n\r\nexport function getElementByPoint(container: HTMLElement, verticalSide: 'top' | 'bottom', horizontalSide: 'center' | 'left'): HTMLElement {\r\n  //return null;\r\n  const rect = container.getBoundingClientRect();\r\n  const x = horizontalSide === 'center' ? Math.ceil(rect.left + ((rect.right - rect.left) / 2) + 1) : Math.ceil(rect.left + 1);\r\n  const y = verticalSide === 'bottom' ? Math.floor(rect.top + rect.height - 1) : Math.ceil(rect.top + 1);\r\n  return document.elementFromPoint(x, y) as any;\r\n};\r\n\r\nMOUNT_CLASS_TO.getElementByPoint = getElementByPoint;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function reflowScrollableElement(element: HTMLElement) {\r\n  element.style.display = 'none';\r\n  void element.offsetLeft; // reflow\r\n  element.style.display = '';\r\n}\r\n","export const SEND_WHEN_ONLINE_TIMESTAMP = 0x7FFFFFFE;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function getVisibleRect(\r\n  element: HTMLElement, \r\n  overflowElement: HTMLElement, \r\n  lookForSticky?: boolean, \r\n  rect = element.getBoundingClientRect(),\r\n  overflowRect = overflowElement.getBoundingClientRect()\r\n) {\r\n  let {top: overflowTop, right: overflowRight, bottom: overflowBottom, left: overflowLeft} = overflowRect;\r\n\r\n  // * respect sticky headers\r\n  if(lookForSticky) {\r\n    const sticky = overflowElement.querySelector('.sticky');\r\n    if(sticky) {\r\n      const stickyRect = sticky.getBoundingClientRect();\r\n      overflowTop = stickyRect.bottom;\r\n    }\r\n  }\r\n\r\n  if(rect.top >= overflowBottom\r\n    || rect.bottom <= overflowTop\r\n    || rect.right <= overflowLeft\r\n    || rect.left >= overflowRight) {\r\n    return null;\r\n  }\r\n\r\n  const overflow = {\r\n    top: false,\r\n    right: false,\r\n    bottom: false,\r\n    left: false,\r\n    vertical: 0 as 0 | 1 | 2,\r\n    horizontal: 0 as 0 | 1 | 2\r\n  };\r\n\r\n  // @ts-ignore\r\n  const w: any = 'visualViewport' in window ? window.visualViewport : window;\r\n  const windowWidth = w.width || w.innerWidth;\r\n  const windowHeight = w.height || w.innerHeight;\r\n\r\n  return {\r\n    rect: {\r\n      top: rect.top < overflowTop && overflowTop !== 0 ? (overflow.top = true, ++overflow.vertical, overflowTop) : rect.top,\r\n      right: rect.right > overflowRight && overflowRight !== windowWidth ? (overflow.right = true, ++overflow.horizontal, overflowRight) : rect.right,\r\n      bottom: rect.bottom > overflowBottom && overflowBottom !== windowHeight ? (overflow.bottom = true, ++overflow.vertical, overflowBottom) : rect.bottom,\r\n      left: rect.left < overflowLeft && overflowLeft !== 0 ? (overflow.left = true, ++overflow.horizontal, overflowLeft) : rect.left\r\n    },\r\n    overflow\r\n  };\r\n}\r\n\r\n(window as any).getVisibleRect = getVisibleRect;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport enum INTERNAL_LINK_TYPE {\r\n  MESSAGE,\r\n  PRIVATE_POST,\r\n  STICKER_SET,\r\n  JOIN_CHAT,\r\n  VOICE_CHAT,\r\n  USER_PHONE_NUMBER\r\n};\r\n\r\nexport type InternalLink = InternalLink.InternalLinkMessage | InternalLink.InternalLinkPrivatePost | InternalLink.InternalLinkStickerSet | InternalLink.InternalLinkJoinChat | InternalLink.InternalLinkVoiceChat | InternalLink.InternalLinkUserPhoneNumber;\r\n\r\nexport namespace InternalLink {\r\n  export interface InternalLinkMessage {\r\n    _: INTERNAL_LINK_TYPE.MESSAGE,\r\n    domain: string,\r\n    post?: string,\r\n    comment?: string,\r\n    start?: string\r\n  }\r\n\r\n  export interface InternalLinkPrivatePost {\r\n    _: INTERNAL_LINK_TYPE.PRIVATE_POST,\r\n    channel: string,\r\n    post: string,\r\n    thread?: string,\r\n    comment?: string\r\n  }\r\n\r\n  export interface InternalLinkStickerSet {\r\n    _: INTERNAL_LINK_TYPE.STICKER_SET,\r\n    set: string\r\n  }\r\n\r\n  export interface InternalLinkJoinChat {\r\n    _: INTERNAL_LINK_TYPE.JOIN_CHAT,\r\n    invite: string\r\n  }\r\n\r\n  /**\r\n   * LOCAL LINK\r\n   */\r\n  export interface InternalLinkVoiceChat {\r\n    _: INTERNAL_LINK_TYPE.VOICE_CHAT,\r\n    id: string,\r\n    access_hash: string,\r\n    chat_id: string\r\n  }\r\n\r\n  export interface InternalLinkUserPhoneNumber {\r\n    _: INTERNAL_LINK_TYPE.USER_PHONE_NUMBER,\r\n    phone: string\r\n  }\r\n}\r\n\r\nexport type InternalLinkTypeMap = {\r\n  [INTERNAL_LINK_TYPE.MESSAGE]: InternalLink.InternalLinkMessage,\r\n  [INTERNAL_LINK_TYPE.PRIVATE_POST]: InternalLink.InternalLinkPrivatePost,\r\n  [INTERNAL_LINK_TYPE.STICKER_SET]: InternalLink.InternalLinkStickerSet,\r\n  [INTERNAL_LINK_TYPE.JOIN_CHAT]: InternalLink.InternalLinkJoinChat,\r\n  [INTERNAL_LINK_TYPE.VOICE_CHAT]: InternalLink.InternalLinkVoiceChat,\r\n  [INTERNAL_LINK_TYPE.USER_PHONE_NUMBER]: InternalLink.InternalLinkUserPhoneNumber\r\n};\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement, { addCancelButton } from \".\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport numberThousandSplitter from \"../../helpers/number/numberThousandSplitter\";\r\nimport { ChatInvite } from \"../../layer\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { i18n, _i18n } from \"../../lib/langPack\";\r\nimport { NULL_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport AvatarElement from \"../avatar\";\r\nimport putPhoto from \"../putPhoto\";\r\nimport { toastNew } from \"../toast\";\r\nimport { wrapPhoto } from \"../wrappers\";\r\n\r\n// const FAKE_CHAT_ID = Number.MAX_SAFE_INTEGER - 0x1000;\r\n\r\nexport default class PopupJoinChatInvite extends PopupElement {\r\n  constructor(\r\n    private hash: string, \r\n    private chatInvite: ChatInvite.chatInvite, \r\n  ) {\r\n    super('popup-join-chat-invite', {\r\n      closable: true, \r\n      overlayClosable: true, \r\n      body: true,\r\n      buttons: addCancelButton([{\r\n        langKey: chatInvite.pFlags.request_needed ? 'RequestJoin.Button' : (chatInvite.pFlags.broadcast ? 'JoinByPeekChannelTitle' : 'JoinByPeekGroupTitle'),\r\n        callback: () => {\r\n          this.managers.appChatsManager.importChatInvite(hash)\r\n          .then((chatId) => {\r\n            const peerId = chatId.toPeerId(true);\r\n            appImManager.setInnerPeer({peerId});\r\n          }, (error) => {\r\n            if(error.type === 'INVITE_REQUEST_SENT') {\r\n              toastNew({langPackKey: 'RequestToJoinSent'});\r\n            }\r\n          });\r\n        }\r\n      }])\r\n    });\r\n\r\n    this.construct();\r\n  }\r\n\r\n  private async construct() {\r\n    this.header.remove();\r\n    /* const fakeChat: Chat.channel | Chat.chat = {\r\n      _: chatInvite.pFlags.channel ? 'channel' : 'chat',\r\n      id: FAKE_CHAT_ID,\r\n      title: chatInvite.title,\r\n      photo: chatInvite.photo as any,\r\n      date: Date.now() / 1000 | 0,\r\n      version: 0,\r\n      participants_count: chatInvite.participants_count,\r\n      pFlags: chatInvite.pFlags as any\r\n    };\r\n\r\n    appChatsManager.saveApiChat(fakeChat); */\r\n\r\n    const {chatInvite, managers, hash} = this;\r\n    \r\n    const avatarElem = new AvatarElement();\r\n    avatarElem.classList.add('avatar-100');\r\n    avatarElem.isDialog = false;\r\n    if(chatInvite.photo._ === 'photo') {\r\n      chatInvite.photo = await managers.appPhotosManager.savePhoto(chatInvite.photo);\r\n      wrapPhoto({\r\n        container: avatarElem,\r\n        message: null,\r\n        photo: chatInvite.photo,\r\n        boxHeight: 100,\r\n        boxWidth: 100,\r\n        withoutPreloader: true\r\n      });\r\n      avatarElem.style.width = avatarElem.style.height = '';\r\n    } else {\r\n      putPhoto(avatarElem, NULL_PEER_ID, false, chatInvite.title);\r\n    }\r\n\r\n    const title = document.createElement('div');\r\n    title.classList.add('chat-title');\r\n    setInnerHTML(title, wrapEmojiText(chatInvite.title));\r\n    //avatarElem.setAttribute('peer', '' + -fakeChat.id);\r\n    \r\n    const isBroadcast = chatInvite.pFlags.broadcast;\r\n    const peopleCount = i18n(isBroadcast ? 'Subscribers' : 'Members', [numberThousandSplitter(chatInvite.participants_count)]);\r\n    peopleCount.classList.add('chat-participants-count');\r\n\r\n    this.body.append(avatarElem, title, peopleCount);\r\n\r\n    if(chatInvite.pFlags.request_needed) {\r\n      const caption = document.createElement('div');\r\n      _i18n(caption, isBroadcast ? 'RequestToJoinChannelDescription' : 'RequestToJoinGroupDescription');\r\n      caption.classList.add('chat-participants-count', 'request-caption');\r\n\r\n      this.body.append(caption);\r\n    }\r\n\r\n    this.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Scrollable from \"../components/scrollable\";\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\nimport { IS_SAFARI } from \"../environment/userAgent\";\r\nimport getVisibleRect from \"./dom/getVisibleRect\";\r\nimport reflowScrollableElement from \"./dom/reflowScrollableElement\";\r\n\r\nexport default class ScrollSaver {\r\n  private scrollHeight: number;\r\n  private scrollHeightMinusTop: number;\r\n  private scrollTop: number;\r\n  private clientHeight: number;\r\n  private elements: {element: HTMLElement, rect: DOMRect}[];\r\n\r\n  /**\r\n   * \r\n   * @param scrollable to reset scroll position and direction\r\n   * @param reverse true means top\r\n   */\r\n  constructor(\r\n    private scrollable: Scrollable, \r\n    private query: string, \r\n    private reverse: boolean\r\n  ) {\r\n\r\n  }\r\n\r\n  private get container() {\r\n    return this.scrollable.container;\r\n  }\r\n\r\n  public getSaved() {\r\n    return {\r\n      scrollHeight: this.scrollHeight, \r\n      scrollTop: this.scrollTop,\r\n      clientHeight: this.clientHeight\r\n    };\r\n  }\r\n\r\n  public findElements() {\r\n    if(!this.query) return [];\r\n\r\n    const {container} = this;\r\n    const containerRect = container.getBoundingClientRect();\r\n    const bubbles = Array.from(container.querySelectorAll(this.query)) as HTMLElement[];\r\n    const elements: ScrollSaver['elements'] = [];\r\n    for(const bubble of bubbles) {\r\n      const elementRect = bubble.getBoundingClientRect();\r\n      const visibleRect = getVisibleRect(bubble, container, undefined, elementRect, containerRect);\r\n      if(visibleRect) {\r\n        elements.push({element: bubble, rect: elementRect});\r\n        // break; // find first\r\n      } else if(elements.length) { // find last\r\n        break;\r\n      }\r\n    }\r\n\r\n    if(!elements.length) {\r\n      const bubble = bubbles[0];\r\n      if(bubble) {\r\n        elements.push({element: bubble, rect: bubble.getBoundingClientRect()});\r\n      }\r\n    }\r\n\r\n    return elements;\r\n  }\r\n\r\n  public replaceSaved(from: HTMLElement, to: HTMLElement) {\r\n    if(!this.elements) {\r\n      return;\r\n    }\r\n\r\n    const idx = this.elements.findIndex(({element}) => from === element);\r\n    if(idx !== -1) {\r\n      this.elements[idx].element = to;\r\n    }\r\n  }\r\n\r\n  public findAndSetElements() {\r\n    this.elements = this.findElements();\r\n  }\r\n\r\n  public save() {\r\n    this.findAndSetElements();\r\n    // console.warn('scroll save', this.elements);\r\n    this._save();\r\n  }\r\n\r\n  public _save() {\r\n    const {scrollTop, scrollHeight, clientHeight} = this.container;\r\n\r\n    //previousScrollHeight = scrollHeight;\r\n    //previousScrollHeight = scrollHeight + padding;\r\n    this.scrollHeight = scrollHeight;\r\n    this.scrollTop = scrollTop;\r\n    this.clientHeight = clientHeight;\r\n    this.scrollHeightMinusTop = this.reverse ? scrollHeight - scrollTop : scrollTop;\r\n\r\n    //this.chatInner.style.paddingTop = padding + 'px';\r\n    /* if(reverse) {\r\n      previousScrollHeightMinusTop = this.scrollable.scrollHeight - scrollTop;\r\n    } else {\r\n      previousScrollHeightMinusTop = scrollTop;\r\n    } */\r\n  }\r\n\r\n  private onRestore(useReflow?: boolean) {\r\n    if(IS_SAFARI && useReflow/*  && !isAppleMobile */) { // * fix blinking and jumping\r\n      reflowScrollableElement(this.container);\r\n    }\r\n  }\r\n\r\n  private setScrollTop(newScrollTop: number, useReflow?: boolean) {\r\n    // touchSupport for safari iOS\r\n    //isTouchSupported && isApple && (container.container.style.overflow = 'hidden');\r\n    this.scrollable.setScrollTopSilently(this.scrollTop = newScrollTop);\r\n    //container.scrollTop = scrollHeight;\r\n    //isTouchSupported && isApple && (container.container.style.overflow = '');\r\n\r\n    this.onRestore(useReflow);\r\n  }\r\n\r\n  public restore(useReflow?: boolean) {\r\n    const {scrollTop, scrollHeight} = this.scrollable;\r\n    this.scrollHeight = scrollHeight;\r\n\r\n    let anchor: ScrollSaver['elements'][0];\r\n    // for(let i = this.elements.length - 1; i >= 0; --i) {\r\n    //   const _anchor = this.elements[i];\r\n    //   if(_anchor.element.parentElement) {\r\n    //     anchor = _anchor;\r\n    //     break;\r\n    //   }\r\n    // }\r\n    anchor = this.elements[this.elements.length - 1];\r\n    \r\n    if(!anchor?.element?.parentElement) { // try to find new anchor\r\n      this.findAndSetElements();\r\n      anchor = this.elements[this.elements.length - 1];\r\n\r\n      if(!anchor) { // fallback to old method if smth is really strange\r\n        this._restore(useReflow);\r\n        return;\r\n      }\r\n    }\r\n\r\n    const {element, rect} = anchor;\r\n    const newRect = element.getBoundingClientRect();\r\n    const diff = newRect.bottom - rect.bottom;\r\n    this.setScrollTop(scrollTop + diff, useReflow);\r\n    // if(diff) debugger;\r\n    // console.warn('scroll restore', rect, diff, newRect);\r\n  }\r\n\r\n  public _restore(useReflow?: boolean) {\r\n    const {scrollHeightMinusTop: previousScrollHeightMinusTop, scrollable} = this;\r\n    // if(previousScrollHeightMinusTop === undefined) {\r\n    //   throw new Error('scroll was not saved');\r\n    // }\r\n\r\n    // const scrollHeight = container.scrollHeight;\r\n    const scrollHeight = this.scrollHeight;\r\n    // if(scrollHeight === this.scrollHeight) {\r\n    //   return;\r\n    // }\r\n\r\n    // this.scrollHeight = scrollHeight;\r\n\r\n    /* const scrollHeight = container.scrollHeight;\r\n    const addedHeight = scrollHeight - previousScrollHeight;\r\n    \r\n    this.chatInner.style.paddingTop = (10000 - addedHeight) + 'px'; */\r\n    /* const scrollHeight = scrollHeight;\r\n    const addedHeight = scrollHeight - previousScrollHeight;\r\n    \r\n    this.chatInner.style.paddingTop = (padding - addedHeight) + 'px';\r\n    \r\n    //const newScrollTop = reverse ? scrollHeight - previousScrollHeightMinusTop : previousScrollHeightMinusTop;\r\n    const newScrollTop = reverse ? scrollHeight - addedHeight - previousScrollHeightMinusTop : previousScrollHeightMinusTop;\r\n    this.log('performHistoryResult: will set scrollTop', \r\n    previousScrollHeightMinusTop, scrollHeight, \r\n    newScrollTop, container.container.clientHeight); */\r\n    //const newScrollTop = reverse ? scrollHeight - previousScrollHeightMinusTop : previousScrollHeightMinusTop;\r\n    const newScrollTop = this.reverse ? scrollHeight - previousScrollHeightMinusTop : previousScrollHeightMinusTop;\r\n    \r\n    /* if(DEBUG) {\r\n      this.log('performHistoryResult: will set up scrollTop:', newScrollTop, this.isHeavyAnimationInProgress);\r\n    } */\r\n\r\n    this.setScrollTop(newScrollTop, useReflow);\r\n\r\n    /* if(DEBUG) {\r\n      this.log('performHistoryResult: have set up scrollTop:', newScrollTop, container.scrollTop, container.scrollHeight, this.isHeavyAnimationInProgress);\r\n    } */\r\n  }\r\n}\r\n\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.ScrollSaver = ScrollSaver);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport type IntersectionTarget = Element;\r\nexport type IntersectionCallback = (entry: IntersectionObserverEntry) => void;\r\n\r\nexport default class SuperIntersectionObserver {\r\n  private observing: Map<IntersectionTarget, Set<IntersectionCallback>>;\r\n  private observingQueue: SuperIntersectionObserver['observing'];\r\n  private observer: IntersectionObserver;\r\n  private freezedObservingNew: boolean;\r\n\r\n  constructor(init?: IntersectionObserverInit) {\r\n    this.observing = new Map();\r\n    this.observingQueue = new Map();\r\n    this.freezedObservingNew = false;\r\n\r\n    this.observer = new IntersectionObserver((entries) => {\r\n      const observing = this.observing;\r\n      for(let i = 0, length = entries.length; i < length; ++i) {\r\n        const entry = entries[i];\r\n        const callbacks = observing.get(entry.target);\r\n        if(!callbacks) {\r\n          debugger;\r\n        }\r\n\r\n        for(const callback of callbacks) {\r\n          try {\r\n            callback(entry);\r\n          } catch(err) {\r\n            console.error('intersection process callback error:', err);\r\n          }\r\n        }\r\n      }\r\n    }, init);\r\n  }\r\n\r\n  public disconnect() {\r\n    this.observing.clear();\r\n    this.observingQueue.clear();\r\n    this.observer.disconnect();\r\n  }\r\n\r\n  public toggleObservingNew(value: boolean) {\r\n    if(this.freezedObservingNew === value) {\r\n      return;\r\n    }\r\n\r\n    this.freezedObservingNew = value;\r\n\r\n    const queue = this.observingQueue;\r\n    if(!value && queue.size) {\r\n      for(const [target, callbacks] of queue) {\r\n        for(const callback of callbacks) {\r\n          this.observe(target, callback);\r\n        }\r\n      }\r\n\r\n      queue.clear();\r\n    }\r\n  }\r\n\r\n  public has(target: IntersectionTarget, callback: IntersectionCallback, observing = this.observing) {\r\n    const callbacks = observing.get(target);\r\n    return !!(callbacks && callbacks.has(callback));\r\n  }\r\n\r\n  public observe(target: IntersectionTarget, callback: IntersectionCallback) {\r\n    if(this.freezedObservingNew && this.has(target, callback)) {\r\n      return;\r\n    }\r\n\r\n    const observing = this.freezedObservingNew ? this.observingQueue : this.observing;\r\n    let callbacks = observing.get(target);\r\n    if(callbacks && callbacks.has(callback)) {\r\n      return;\r\n    }\r\n\r\n    if(!callbacks) {\r\n      callbacks = new Set();\r\n      observing.set(target, callbacks);\r\n\r\n      if(observing === this.observing) {\r\n        this.observer.observe(target);\r\n      }\r\n    }\r\n\r\n    callbacks.add(callback);\r\n  }\r\n\r\n  public unobserve(target: IntersectionTarget, callback: IntersectionCallback) {\r\n    const observing = this.freezedObservingNew && !this.has(target, callback) ? this.observingQueue : this.observing;\r\n    const callbacks = observing.get(target);\r\n    if(!callbacks) {\r\n      return;\r\n    }\r\n\r\n    callbacks.delete(callback);\r\n    if(!callbacks.size) {\r\n      observing.delete(target);\r\n      this.observer.unobserve(target);\r\n    }\r\n  }\r\n}\r\n","import type { MyDocument } from \"../../appDocsManager\";\r\nimport type { MyMessage } from \"../../appMessagesManager\";\r\nimport { Message, MessageMedia } from \"../../../../layer\";\r\n\r\nexport default function isMentionUnread(message: MyMessage) {\r\n  if(!message) {\r\n    return false;\r\n  }\r\n\r\n  const doc = ((message as Message.message).media as MessageMedia.messageMediaDocument)?.document as MyDocument;\r\n  return !!(\r\n    message.pFlags.media_unread && \r\n    message.pFlags.mentioned && \r\n    (\r\n      !doc || \r\n      !(['voice', 'round'] as MyDocument['type'][]).includes(doc.type)\r\n    )\r\n  );\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function middlewarePromise(middleware: () => boolean, throwWhat: any = '') {\r\n  return <T>(promise: T): T => {\r\n    if(!(promise instanceof Promise)) {\r\n      if(promise instanceof Error) {\r\n        throw promise;\r\n      } else {\r\n        return promise;\r\n      }\r\n    }\r\n\r\n    return (promise as any as Promise<any>).then((result) => {\r\n      if(!middleware()) {\r\n        throw throwWhat;\r\n      }\r\n\r\n      return result;\r\n    }) as any;\r\n  };\r\n}\r\n","import { MessageEntity } from \"../../layer\";\r\nimport { toCodePoints } from \"../../vendor/emoji\";\r\n\r\nexport default function getEmojiEntityFromEmoji(emoji: string): MessageEntity.messageEntityEmoji {\r\n  return {\r\n    _: 'messageEntityEmoji',\r\n    offset: 0,\r\n    length: emoji.length,\r\n    unicode: toCodePoints(emoji).join('-').replace(/-?fe0f/g, '')\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport emoticonsDropdown, { EmoticonsDropdown, EmoticonsTab } from \"..\";\r\nimport cancelEvent from \"../../../helpers/dom/cancelEvent\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport { fastRaf } from \"../../../helpers/schedulers\";\r\nimport pause from \"../../../helpers/schedulers/pause\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\nimport { i18n, LangPackKey } from \"../../../lib/langPack\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport { emojiFromCodePoints } from \"../../../vendor/emoji\";\r\nimport { putPreloader } from \"../../putPreloader\";\r\nimport Scrollable from \"../../scrollable\";\r\nimport StickyIntersector from \"../../stickyIntersector\";\r\nimport IS_EMOJI_SUPPORTED from \"../../../environment/emojiSupport\";\r\nimport IS_TOUCH_SUPPORTED from \"../../../environment/touchSupport\";\r\nimport blurActiveElement from \"../../../helpers/dom/blurActiveElement\";\r\nimport Emoji from \"../../../config/emoji\";\r\nimport { AppManagers } from \"../../../lib/appManagers/managers\";\r\nimport fixEmoji from \"../../../lib/richTextProcessor/fixEmoji\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapSingleEmoji from \"../../../lib/richTextProcessor/wrapSingleEmoji\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\n\r\nconst loadedURLs: Set<string> = new Set();\r\nexport function appendEmoji(emoji: string, container: HTMLElement, prepend = false, unify = false) {\r\n  //const emoji = details.unified;\r\n  //const emoji = (details.unified as string).split('-')\r\n  //.reduce((prev, curr) => prev + String.fromCodePoint(parseInt(curr, 16)), '');\r\n\r\n  const spanEmoji = document.createElement('span');\r\n  spanEmoji.classList.add('super-emoji');\r\n\r\n  let kek: DocumentFragment;\r\n  if(unify && !IS_EMOJI_SUPPORTED) {\r\n    kek = wrapSingleEmoji(emoji);\r\n  } else {\r\n    emoji = fixEmoji(emoji);\r\n    kek = wrapEmojiText(emoji);\r\n  }\r\n\r\n  /* if(!kek.includes('emoji')) {\r\n    console.log(emoji, kek, spanEmoji, emoji.length, new TextEncoder().encode(emoji), emojiUnicode(emoji));\r\n    return;\r\n  } */\r\n\r\n  //console.log(kek);\r\n\r\n  spanEmoji.append(kek);\r\n\r\n  if(spanEmoji.children.length > 1) {\r\n    const first = spanEmoji.firstElementChild;\r\n    spanEmoji.innerHTML = '';\r\n    spanEmoji.append(first);\r\n  }\r\n\r\n  if(spanEmoji.firstElementChild?.tagName === 'IMG') {\r\n    const image = spanEmoji.firstElementChild as HTMLImageElement;\r\n    \r\n    const url = image.src;\r\n    if(!loadedURLs.has(url)) {\r\n      image.setAttribute('loading', 'lazy');\r\n      const placeholder = document.createElement('span');\r\n      placeholder.classList.add('emoji-placeholder');\r\n\r\n      if(rootScope.settings.animationsEnabled) {\r\n        image.style.opacity = '0';\r\n        placeholder.style.opacity = '1';\r\n      }\r\n\r\n      image.addEventListener('load', () => {\r\n        fastRaf(() => {\r\n          if(rootScope.settings.animationsEnabled) {\r\n            image.style.opacity = '';\r\n            placeholder.style.opacity = '';\r\n          }\r\n\r\n          spanEmoji.classList.remove('empty');\r\n\r\n          loadedURLs.add(url);\r\n        });\r\n      }, {once: true});\r\n\r\n      spanEmoji.append(placeholder);\r\n    }\r\n  }\r\n\r\n  //spanEmoji = spanEmoji.firstElementChild as HTMLSpanElement;\r\n  //spanEmoji.setAttribute('emoji', emoji);\r\n  if(prepend) container.prepend(spanEmoji);\r\n  else container.appendChild(spanEmoji);\r\n}\r\n\r\nexport function getEmojiFromElement(element: HTMLElement) {\r\n  if(!findUpClassName(element, 'super-emoji')) return '';\r\n\r\n  if(element.nodeType === 3) return element.nodeValue;\r\n  if(element.tagName === 'SPAN' && !element.classList.contains('emoji') && element.firstElementChild) {\r\n    element = element.firstElementChild as HTMLElement;\r\n  }\r\n  \r\n  return element.getAttribute('alt') || element.innerText;\r\n}\r\n\r\nexport default class EmojiTab implements EmoticonsTab {\r\n  private content: HTMLElement;\r\n\r\n  private recentItemsDiv: HTMLElement;\r\n\r\n  private scroll: Scrollable;\r\n  private stickyIntersector: StickyIntersector;\r\n  private menu: HTMLElement;\r\n\r\n  private closeScrollTop = 0;\r\n  private setMenuActive: (id: number) => boolean;\r\n\r\n  constructor(private managers: AppManagers) {\r\n\r\n  }\r\n\r\n  init() {\r\n    this.content = document.getElementById('content-emoji') as HTMLDivElement;\r\n\r\n    const categories: LangPackKey[] = [\r\n      'Emoji.SmilesAndPeople', \r\n      'Emoji.AnimalsAndNature', \r\n      'Emoji.FoodAndDrink', \r\n      'Emoji.TravelAndPlaces', \r\n      'Emoji.ActivityAndSport', \r\n      'Emoji.Objects', \r\n      /* 'Emoji.Symbols',  */\r\n      'Emoji.Flags', \r\n      'Skin Tones' as any\r\n    ];\r\n    const divs: {\r\n      [category in LangPackKey]?: HTMLDivElement\r\n    } = {};\r\n\r\n    const sorted: Map<LangPackKey, string[]> = new Map([\r\n      [\r\n        'Emoji.Recent',\r\n        []\r\n      ]\r\n    ]);\r\n\r\n    for(const emoji in Emoji) {\r\n      const details = Emoji[emoji];\r\n      const i = '' + details;\r\n      const category = categories[+i[0] - 1];\r\n      if(!category) continue; // maybe it's skin tones\r\n\r\n      let s = sorted.get(category);\r\n      if(!s) {\r\n        s = [];\r\n        sorted.set(category, s);\r\n      }\r\n      \r\n      s[+i.slice(1) || 0] = emoji;\r\n    }\r\n\r\n    //console.log('emoticons sorted:', sorted);\r\n\r\n    //Object.keys(sorted).forEach((c) => sorted[c].sort((a, b) => a - b));\r\n\r\n    sorted.delete(categories.pop());\r\n\r\n    //console.time('emojiParse');\r\n    sorted.forEach((emojis, category) => {\r\n      const div = document.createElement('div');\r\n      div.classList.add('emoji-category');\r\n\r\n      const titleDiv = document.createElement('div');\r\n      titleDiv.classList.add('category-title');\r\n      titleDiv.append(i18n(category));\r\n\r\n      const itemsDiv = document.createElement('div');\r\n      itemsDiv.classList.add('super-emojis');\r\n\r\n      div.append(titleDiv, itemsDiv);\r\n\r\n      emojis.forEach((unified) => {\r\n        /* if(emojiUnicode(emoji) === '1f481-200d-2642') {\r\n          console.log('append emoji', emoji, emojiUnicode(emoji));\r\n        } */\r\n\r\n        let emoji = emojiFromCodePoints(unified);\r\n        //if(emoji.includes('')) {\r\n          //console.log('toCodePoints', toCodePoints(emoji));\r\n          //emoji = emoji.replace(/(\\u200d[\\u2640\\u2642\\u2695])(?!\\ufe0f)/, '\\ufe0f$1');\r\n          // const zwjIndex = emoji.indexOf('\\u200d');\r\n          // if(zwjIndex !== -1 && !emoji.includes('\\ufe0f')) {\r\n          //   /* if(zwjIndex !== (emoji.length - 1)) {\r\n          //     emoji = emoji.replace(/(\\u200d)/g, '\\ufe0f$1');\r\n          //   } */\r\n\r\n          //   emoji += '\\ufe0f';\r\n          //   //emoji += '\\ufe0f';\r\n          // }\r\n\r\n          //debugger;\r\n        //}\r\n\r\n        appendEmoji(emoji/* .replace(/[\\ufe0f\\u2640\\u2642\\u2695]/g, '') */, itemsDiv, false/* , false */);\r\n\r\n        /* if(category === 'Smileys & Emotion') {\r\n          console.log('appended emoji', emoji, itemsDiv.children[itemsDiv.childElementCount - 1].innerHTML, emojiUnicode(emoji));\r\n        } */\r\n      });\r\n\r\n      divs[category] = div;\r\n    });\r\n\r\n    //console.timeEnd('emojiParse');\r\n\r\n    const menu = this.menu = this.content.previousElementSibling as HTMLElement;\r\n    const emojiScroll = this.scroll = new Scrollable(this.content, 'EMOJI');\r\n\r\n    //emojiScroll.setVirtualContainer(emojiScroll.container);\r\n\r\n    const preloader = putPreloader(this.content, true);\r\n\r\n    Promise.all([\r\n      pause(200),\r\n      this.managers.appEmojiManager.getRecentEmojis().then((recent) => {\r\n        const hasRecent = !!recent.length;\r\n        const activeId = hasRecent ? 0 : 1;\r\n        this.menu.children[0].classList.toggle('hide', !hasRecent);\r\n        this.menu.children[activeId].classList.add('active');\r\n        const m = EmoticonsDropdown.menuOnClick(menu, emojiScroll, undefined, activeId);\r\n        this.stickyIntersector = m.stickyIntersector;\r\n        this.setMenuActive = m.setActive;\r\n        return recent;\r\n      })\r\n    ]).then(([_, recent]) => {\r\n      preloader.remove();\r\n\r\n      this.recentItemsDiv = divs['Emoji.Recent'].querySelector('.super-emojis');\r\n      for(const emoji of recent) {\r\n        appendEmoji(emoji, this.recentItemsDiv);\r\n      }\r\n\r\n      this.recentItemsDiv.parentElement.classList.toggle('hide', !this.recentItemsDiv.childElementCount);\r\n\r\n      categories.unshift('Emoji.Recent');\r\n      categories.map((category) => {\r\n        const div = divs[category];\r\n  \r\n        if(!div) {\r\n          console.error('no div by category:', category);\r\n        }\r\n  \r\n        emojiScroll.container.append(div);\r\n        this.stickyIntersector.observeStickyHeaderChanges(div);\r\n        return div;\r\n      });\r\n    });\r\n\r\n    attachClickEvent(this.content, this.onContentClick);\r\n    this.init = null;\r\n\r\n    rootScope.addEventListener('emoji_recent', (emoji) => {\r\n      const children = Array.from(this.recentItemsDiv.children) as HTMLElement[];\r\n      for(let i = 0, length = children.length; i < length; ++i) {\r\n        const el = children[i];\r\n        const _emoji = fixEmoji(getEmojiFromElement(el));\r\n        if(emoji === _emoji) {\r\n          if(i === 0) {\r\n            return;\r\n          }\r\n\r\n          el.remove();\r\n        }\r\n      }\r\n\r\n      appendEmoji(emoji, this.recentItemsDiv, true);\r\n      this.recentItemsDiv.parentElement.classList.remove('hide');\r\n      this.menu.children[0].classList.remove('hide');\r\n\r\n      if(!this.closeScrollTop) {\r\n        this.setMenuActive(0);\r\n      }\r\n    });\r\n\r\n    emoticonsDropdown.addEventListener('close', () => {\r\n      this.closeScrollTop = this.scroll.scrollTop;\r\n    });\r\n  }\r\n\r\n  onContentClick = (e: MouseEvent) => {\r\n    cancelEvent(e);\r\n    \r\n    const emoji = getEmojiFromElement(e.target as HTMLElement);\r\n    if(!emoji) {\r\n      return;\r\n    }\r\n\r\n    appImManager.chat.input.onEmojiSelected(emoji, false);\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      blurActiveElement();\r\n    }\r\n  };\r\n\r\n  onClose() {\r\n\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getEmojiEntityFromEmoji from \"./getEmojiEntityFromEmoji\";\r\nimport wrapRichText from \"./wrapRichText\";\r\n\r\nexport default function wrapSingleEmoji(emoji: string) {\r\n  return wrapRichText(emoji, {\r\n    entities: [getEmojiEntityFromEmoji(emoji)]\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport findAndSpliceAll from \"../helpers/array/findAndSpliceAll\";\r\nimport LazyLoadQueueIntersector from \"./lazyLoadQueueIntersector\";\r\nimport VisibilityIntersector, { OnVisibilityChange } from \"./visibilityIntersector\";\r\n\r\nexport default class LazyLoadQueueRepeat2 extends LazyLoadQueueIntersector {\r\n  constructor(parallelLimit?: number, protected onVisibilityChange?: OnVisibilityChange) {\r\n    super(parallelLimit);\r\n\r\n    this.intersector = new VisibilityIntersector((item) => {\r\n      const {target, visible} = item;\r\n      const spliced = findAndSpliceAll(this.queue, (i) => i.div === target);\r\n      if(visible && spliced.length) {\r\n        spliced.forEach((item) => {\r\n          this.queue.unshift(item);\r\n        });\r\n      }\r\n  \r\n      this.onVisibilityChange && this.onVisibilityChange(item);\r\n      this.setProcessQueueTimeout();\r\n    });\r\n  }\r\n\r\n  public observe(el: HTMLElement) {\r\n    this.intersector.observe(el);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport { wrapVideo } from \"./wrappers\";\r\nimport animationIntersector from \"./animationIntersector\";\r\nimport Scrollable from \"./scrollable\";\r\nimport deferredPromise, { CancellablePromise } from \"../helpers/cancellablePromise\";\r\nimport renderImageFromUrl from \"../helpers/dom/renderImageFromUrl\";\r\nimport calcImageInBox from \"../helpers/calcImageInBox\";\r\nimport { doubleRaf } from \"../helpers/schedulers\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport LazyLoadQueueRepeat2 from \"./lazyLoadQueueRepeat2\";\r\n\r\nconst width = 400;\r\nconst maxSingleWidth = width - 100;\r\nconst height = 100;\r\n\r\nexport default class GifsMasonry {\r\n  public lazyLoadQueue: LazyLoadQueueRepeat2;\r\n  private scrollPromise: CancellablePromise<void> = Promise.resolve();\r\n  private timeout: number = 0;\r\n  private managers: AppManagers;\r\n\r\n  constructor(\r\n    private element: HTMLElement, \r\n    private group: string, \r\n    private scrollable: Scrollable, \r\n    attach = true\r\n  ) {\r\n    this.managers = rootScope.managers;\r\n\r\n    this.lazyLoadQueue = new LazyLoadQueueRepeat2(undefined, ({target, visible}) => {\r\n      if(visible) {\r\n        this.processVisibleDiv(target);\r\n      } else {\r\n        this.processInvisibleDiv(target);\r\n      }\r\n    });\r\n\r\n    /* setInterval(() => {\r\n      // @ts-ignore\r\n      const players = animationIntersector.byGroups[group];\r\n\r\n      if(players) {\r\n        console.log(`GIFS RENDERED IN ${group}:`, players.length, players.filter((p) => !p.animation.paused).length, this.lazyLoadQueue.intersector.getVisible().length);\r\n      }\r\n    }, .25e3); */\r\n\r\n    if(attach) {\r\n      this.attach();\r\n    }\r\n  }\r\n  \r\n  private onScroll = () => {\r\n    if(this.timeout) {\r\n      clearTimeout(this.timeout);\r\n    } else {\r\n      this.scrollPromise = deferredPromise<void>();\r\n      //animationIntersector.checkAnimations(true, group);\r\n    }\r\n\r\n    this.timeout = window.setTimeout(() => {\r\n      this.timeout = 0;\r\n      this.scrollPromise.resolve();\r\n      //animationIntersector.checkAnimations(false, group);\r\n    }, 150);\r\n  };\r\n\r\n  public attach() {\r\n    this.scrollable.container.addEventListener('scroll', this.onScroll);\r\n  }\r\n\r\n  public detach() {\r\n    this.clear();\r\n    this.scrollable.container.removeEventListener('scroll', this.onScroll);\r\n  }\r\n\r\n  public clear() {\r\n    this.lazyLoadQueue.clear();\r\n  }\r\n\r\n  private processVisibleDiv(div: HTMLElement) {\r\n    const video = div.querySelector('video');\r\n    if(video) {\r\n      return;\r\n    }\r\n\r\n    //console.log('processVisibleDiv');\r\n\r\n    const load = () => {\r\n      const docId = div.dataset.docId;\r\n      const promise = Promise.all([this.managers.appDocsManager.getDoc(docId), this.scrollPromise]).then(async([doc]) => {\r\n        const res = await wrapVideo({\r\n          doc,\r\n          container: div as HTMLDivElement,\r\n          lazyLoadQueue: null,\r\n          //lazyLoadQueue: EmoticonsDropdown.lazyLoadQueue,\r\n          group: this.group,\r\n          noInfo: true,\r\n        });\r\n    \r\n        const promise = res.loadPromise;\r\n        promise.finally(() => {\r\n          const video = div.querySelector('video');\r\n\r\n          div.style.opacity = '';\r\n          const img = div.querySelector('img');\r\n          img && img.classList.add('hide');\r\n\r\n          if(video && !video.parentElement) {\r\n            setTimeout(() => {\r\n              video.src = '';\r\n              video.load();\r\n              const animations = animationIntersector.getAnimations(video);\r\n              animations.forEach((item) => {\r\n                animationIntersector.checkAnimation(item, true, true);\r\n              });\r\n            }, 0);\r\n          }\r\n\r\n          //clearTimeout(timeout);\r\n          if(!this.lazyLoadQueue.intersector.isVisible(div)) {\r\n            this.processInvisibleDiv(div);\r\n          }\r\n        });\r\n\r\n        return promise;\r\n      });\r\n\r\n      /* let timeout = window.setTimeout(() => {\r\n        console.error('processVisibleDiv timeout', div, doc);\r\n      }, 1e3); */\r\n\r\n      return promise;\r\n    };\r\n\r\n    //return load();\r\n    \r\n    this.lazyLoadQueue.push({div, load});\r\n  }\r\n\r\n  public processInvisibleDiv = (div: HTMLElement) => {\r\n    return this.scrollPromise.then(async() => {\r\n      //return;\r\n\r\n      if(this.lazyLoadQueue.intersector.isVisible(div)) {\r\n        return;\r\n      }\r\n\r\n      const video = div.querySelector('video');\r\n      const img = div.querySelector('img');\r\n  \r\n      if(img) {\r\n        img && img.classList.remove('hide');\r\n  \r\n        await doubleRaf();\r\n      }\r\n\r\n      if(this.lazyLoadQueue.intersector.isVisible(div)) {\r\n        return;\r\n      }\r\n  \r\n      if(video) {\r\n        video.remove();\r\n        video.src = '';\r\n        video.load();\r\n        const animations = animationIntersector.getAnimations(video);\r\n        animations.forEach((item) => {\r\n          animationIntersector.checkAnimation(item, true, true);\r\n        });\r\n      }\r\n    });\r\n  };\r\n\r\n  public add(doc: MyDocument, appendTo = this.element) {\r\n    let gifWidth = doc.w;\r\n    let gifHeight = doc.h;\r\n    if(gifHeight < height) {\r\n      gifWidth = height / gifHeight * gifWidth;\r\n      gifHeight = height;\r\n    }\r\n\r\n    const willUseWidth = Math.min(maxSingleWidth, width, gifWidth);\r\n    const size = calcImageInBox(gifWidth, gifHeight, willUseWidth, height);\r\n\r\n    /* wastedWidth += w;\r\n\r\n    if(wastedWidth === width || h < height) {\r\n      wastedWidth = 0;\r\n      console.log('completed line', i, line);\r\n      line = [];\r\n      continue;\r\n    }\r\n\r\n    line.push(gif); */\r\n\r\n    //console.log('gif:', gif, w, h);\r\n\r\n    const div = document.createElement('div');\r\n    div.classList.add('gif', 'fade-in-transition');\r\n    div.style.width = size.width + 'px';\r\n    div.style.opacity = '0';\r\n    //div.style.height = h + 'px';\r\n    div.dataset.docId = '' + doc.id;\r\n\r\n    appendTo.append(div);\r\n\r\n    //this.lazyLoadQueue.observe({div, load: this.processVisibleDiv});\r\n    this.lazyLoadQueue.observe(div);\r\n\r\n    //let preloader = new ProgressivePreloader(div);\r\n\r\n    // const gotThumb = this.managers.appDocsManager.getThumb(doc, false);\r\n\r\n    // const willBeAPoster = !!gotThumb;\r\n    // let img: HTMLImageElement;\r\n    // if(willBeAPoster) {\r\n    //   img = new Image();\r\n    //   img.classList.add('media-poster');\r\n\r\n    //   if(!gotThumb.cacheContext.url) {\r\n    //     gotThumb.promise.then(() => {\r\n    //       img.src = gotThumb.cacheContext.url;\r\n    //     });\r\n    //   }\r\n    // }\r\n\r\n    // const afterRender = () => {\r\n    //   if(img) {\r\n    //     div.append(img);\r\n    //     div.style.opacity = '';\r\n    //   }\r\n    // };\r\n\r\n    // (gotThumb?.cacheContext?.url ? renderImageFromUrl(img, gotThumb.cacheContext.url, afterRender) : afterRender());\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport emoticonsDropdown, { EmoticonsDropdown, EmoticonsTab, EMOTICONSSTICKERGROUP } from \"..\";\r\nimport GifsMasonry from \"../../gifsMasonry\";\r\nimport Scrollable from \"../../scrollable\";\r\nimport { putPreloader } from \"../../putPreloader\";\r\nimport { AppManagers } from \"../../../lib/appManagers/managers\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\n\r\nexport default class GifsTab implements EmoticonsTab {\r\n  private content: HTMLElement;\r\n\r\n  constructor(private managers: AppManagers) {\r\n\r\n  }\r\n\r\n  init() {\r\n    this.content = document.getElementById('content-gifs');\r\n    const gifsContainer = this.content.firstElementChild as HTMLDivElement;\r\n    attachClickEvent(gifsContainer, EmoticonsDropdown.onMediaClick);\r\n\r\n    const scroll = new Scrollable(this.content, 'GIFS');\r\n    const masonry = new GifsMasonry(gifsContainer, EMOTICONSSTICKERGROUP, scroll);\r\n    const preloader = putPreloader(this.content, true);\r\n\r\n    this.managers.appDocsManager.getGifs().then((docs) => {\r\n      docs.forEach((doc) => {\r\n        masonry.add(doc);\r\n      });\r\n\r\n      preloader.remove();\r\n    });\r\n\r\n    emoticonsDropdown.addLazyLoadQueueRepeat(masonry.lazyLoadQueue, masonry.processInvisibleDiv);\r\n\r\n    this.init = null;\r\n  }\r\n\r\n  onClose() {\r\n\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport findAndSpliceAll from \"../helpers/array/findAndSpliceAll\";\r\nimport LazyLoadQueueIntersector, { LazyLoadElement } from \"./lazyLoadQueueIntersector\";\r\nimport VisibilityIntersector, { OnVisibilityChange } from \"./visibilityIntersector\";\r\n\r\nexport default class LazyLoadQueueRepeat extends LazyLoadQueueIntersector {\r\n  private _queue: Map<HTMLElement, LazyLoadElement> = new Map();\r\n\r\n  constructor(parallelLimit?: number, protected onVisibilityChange?: OnVisibilityChange, options?: IntersectionObserverInit) {\r\n    super(parallelLimit);\r\n\r\n    this.intersector = new VisibilityIntersector((item) => {\r\n      const {target, visible} = item;\r\n      const spliced = findAndSpliceAll(this.queue, (i) => i.div === target);\r\n      if(visible) {\r\n        const items = spliced.length ? spliced : [this._queue.get(target)];\r\n        items.forEach((item) => {\r\n          this.queue.unshift(item || this._queue.get(target));\r\n        });\r\n      }\r\n  \r\n      this.onVisibilityChange && this.onVisibilityChange(item);\r\n      this.setProcessQueueTimeout();\r\n    }, options);\r\n  }\r\n\r\n  public clear() {\r\n    super.clear();\r\n    this._queue.clear();\r\n  }\r\n\r\n  /* public async processItem(item: LazyLoadElement) {\r\n    //await super.processItem(item);\r\n    await LazyLoadQueueBase.prototype.processItem.call(this, item);\r\n\r\n    if(this.lazyLoadMedia.length) {\r\n      this.processQueue();\r\n    }\r\n  } */\r\n\r\n  public observe(el: LazyLoadElement) {\r\n    this._queue.set(el.div, el);\r\n    this.intersector.observe(el.div);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport emoticonsDropdown, { EmoticonsDropdown, EMOTICONSSTICKERGROUP, EmoticonsTab } from \"..\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport mediaSizes from \"../../../helpers/mediaSizes\";\r\nimport { MessagesAllStickers, StickerSet } from \"../../../layer\";\r\nimport { MyDocument } from \"../../../lib/appManagers/appDocsManager\";\r\nimport { AppManagers } from \"../../../lib/appManagers/managers\";\r\nimport { i18n } from \"../../../lib/langPack\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\nimport rootScope from \"../../../lib/rootScope\";\r\nimport animationIntersector from \"../../animationIntersector\";\r\nimport LazyLoadQueue from \"../../lazyLoadQueue\";\r\nimport LazyLoadQueueRepeat from \"../../lazyLoadQueueRepeat\";\r\nimport { putPreloader } from \"../../putPreloader\";\r\nimport PopupStickers from \"../../popups/stickers\";\r\nimport Scrollable, { ScrollableX } from \"../../scrollable\";\r\nimport StickyIntersector from \"../../stickyIntersector\";\r\nimport { wrapSticker, wrapStickerSetThumb } from \"../../wrappers\";\r\nimport ButtonIcon from \"../../buttonIcon\";\r\nimport positionElementByIndex from \"../../../helpers/dom/positionElementByIndex\";\r\nimport VisibilityIntersector, { OnVisibilityChange } from \"../../visibilityIntersector\";\r\nimport findAndSplice from \"../../../helpers/array/findAndSplice\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport confirmationPopup from \"../../confirmationPopup\";\r\nimport noop from \"../../../helpers/noop\";\r\n\r\nexport class SuperStickerRenderer {\r\n  public lazyLoadQueue: LazyLoadQueueRepeat;\r\n  private animated: Set<HTMLElement> = new Set();\r\n\r\n  constructor(\r\n    private regularLazyLoadQueue: LazyLoadQueue, \r\n    private group: string,\r\n    private managers: AppManagers,\r\n    private options?: IntersectionObserverInit\r\n  ) {\r\n    this.lazyLoadQueue = new LazyLoadQueueRepeat(undefined, ({target, visible}) => {\r\n      if(!visible) {\r\n        this.processInvisible(target);\r\n      }\r\n    }, options);\r\n  }\r\n\r\n  public clear() {\r\n    this.lazyLoadQueue.clear();\r\n  }\r\n\r\n  public renderSticker(doc: MyDocument, element?: HTMLElement, loadPromises?: Promise<any>[]) {\r\n    if(!element) {\r\n      element = document.createElement('div');\r\n      element.classList.add('grid-item', 'super-sticker');\r\n      element.dataset.docId = '' + doc.id;\r\n\r\n      if(doc.animated) {\r\n        this.observeAnimated(element);\r\n      }\r\n    }\r\n\r\n    // * This will wrap only a thumb\r\n    /* !doc.animated &&  */wrapSticker({\r\n      doc, \r\n      div: element,\r\n      lazyLoadQueue: this.regularLazyLoadQueue, \r\n      group: this.group, \r\n      onlyThumb: doc.animated,\r\n      loadPromises\r\n    });\r\n\r\n    return element;\r\n  }\r\n\r\n  public observeAnimated(element: HTMLElement) {\r\n    this.animated.add(element);\r\n    this.lazyLoadQueue.observe({\r\n      div: element, \r\n      load: this.processVisible\r\n    });\r\n  }\r\n\r\n  public unobserveAnimated(element: HTMLElement) {\r\n    this.animated.delete(element);\r\n    this.lazyLoadQueue.unobserve(element);\r\n  }\r\n\r\n  private checkAnimationContainer = (element: HTMLElement, visible: boolean) => {\r\n    //console.error('checkAnimationContainer', div, visible);\r\n    const players = animationIntersector.getAnimations(element);\r\n    players.forEach((player) => {\r\n      if(!visible) {\r\n        animationIntersector.checkAnimation(player, true, true);\r\n      } else {\r\n        animationIntersector.checkAnimation(player, false);\r\n      }\r\n    });\r\n  };\r\n\r\n  private processVisible = async(element: HTMLElement) => {\r\n    const docId = element.dataset.docId;\r\n    const doc = await this.managers.appDocsManager.getDoc(docId);\r\n    \r\n    const size = mediaSizes.active.esgSticker.width;\r\n\r\n    //console.log('processVisibleDiv:', div);\r\n\r\n    const promise = wrapSticker({\r\n      doc, \r\n      div: element,\r\n      width: size,\r\n      height: size,\r\n      lazyLoadQueue: null, \r\n      group: this.group, \r\n      onlyThumb: false,\r\n      play: true,\r\n      loop: true\r\n    }).then(({render}) => render);\r\n\r\n    promise.then(() => {\r\n      //clearTimeout(timeout);\r\n      this.checkAnimationContainer(element, this.lazyLoadQueue.intersector.isVisible(element));\r\n    });\r\n\r\n    /* let timeout = window.setTimeout(() => {\r\n      console.error('processVisibleDiv timeout', div, doc);\r\n    }, 1e3); */\r\n\r\n    return promise;\r\n  };\r\n\r\n  public processInvisible = async(element: HTMLElement) => {\r\n    const docId = element.dataset.docId;\r\n    const doc = await this.managers.appDocsManager.getDoc(docId);\r\n\r\n    //console.log('STICKER INvisible:', /* div,  */docId);\r\n\r\n    this.checkAnimationContainer(element, false);\r\n\r\n    element.textContent = '';\r\n    this.renderSticker(doc, element as HTMLDivElement);\r\n  };\r\n}\r\n\r\ntype StickersTabCategory = {\r\n  elements: {\r\n    container: HTMLElement,\r\n    title: HTMLElement,\r\n    items: HTMLElement,\r\n    menuTab: HTMLElement,\r\n    menuTabPadding: HTMLElement\r\n  },\r\n  set: StickerSet.stickerSet,\r\n  items: {\r\n    document: MyDocument,\r\n    element: HTMLElement\r\n  }[]\r\n};\r\n\r\nconst RECENT_STICKERS_COUNT = 20;\r\n\r\nexport default class StickersTab implements EmoticonsTab {\r\n  private content: HTMLElement;\r\n\r\n  private categories: {[id: string]: StickersTabCategory};\r\n  private categoriesMap: Map<HTMLElement, StickersTabCategory>;\r\n  private categoriesIntersector: VisibilityIntersector;\r\n\r\n  private scroll: Scrollable;\r\n  private menu: HTMLElement;\r\n  private mounted = false;\r\n  private stickyIntersector: StickyIntersector;\r\n  private superStickerRenderer: SuperStickerRenderer;\r\n\r\n  constructor(private managers: AppManagers) {\r\n    this.categories = {};\r\n    this.categoriesMap = new Map();\r\n  }\r\n\r\n  private createCategory(stickerSet: StickerSet.stickerSet, _title: HTMLElement | DocumentFragment) {\r\n    const container = document.createElement('div');\r\n    container.classList.add('emoji-category', 'hide');\r\n\r\n    const items = document.createElement('div');\r\n    items.classList.add('category-items', 'super-stickers');\r\n\r\n    const title = document.createElement('div');\r\n    title.classList.add('category-title');\r\n    title.append(_title);\r\n\r\n    const menuTab = ButtonIcon(undefined, {noRipple: true});\r\n    menuTab.classList.add('menu-horizontal-div-item');\r\n\r\n    const menuTabPadding = document.createElement('div');\r\n    menuTabPadding.classList.add('menu-horizontal-div-item-padding');\r\n\r\n    menuTab.append(menuTabPadding);\r\n\r\n    const category: StickersTabCategory = {\r\n      elements: {\r\n        container,\r\n        title,\r\n        items,\r\n        menuTab,\r\n        menuTabPadding\r\n      },\r\n      set: stickerSet,\r\n      items: []\r\n    };\r\n\r\n    container.append(title, items);\r\n\r\n    this.categories[stickerSet.id] = category;\r\n    this.categoriesMap.set(container, category);\r\n\r\n    this.categoriesIntersector.observe(container);\r\n    this.stickyIntersector.observeStickyHeaderChanges(container);\r\n\r\n    return category;\r\n  }\r\n\r\n  private categoryAppendStickers(\r\n    category: StickersTabCategory, \r\n    promise: Promise<MyDocument[]>\r\n  ) {\r\n    const {container} = category.elements;\r\n\r\n    promise.then((documents) => {\r\n      const isVisible = this.isCategoryVisible(category);\r\n\r\n      documents.forEach((document) => {\r\n        const element = this.superStickerRenderer.renderSticker(document);\r\n        category.items.push({document, element});\r\n\r\n        if(isVisible) {\r\n          category.elements.items.append(element);\r\n        }\r\n      });\r\n\r\n      this.setCategoryItemsHeight(category);\r\n      container.classList.remove('hide');\r\n    });\r\n  }\r\n\r\n  private isCategoryVisible(category: StickersTabCategory) {\r\n    return this.categoriesIntersector.getVisible().includes(category.elements.container);\r\n  }\r\n\r\n  private setCategoryItemsHeight(category: StickersTabCategory) {\r\n    const containerWidth = this.content.getBoundingClientRect().width - 10;\r\n    const stickerSize = mediaSizes.active.esgSticker.width;\r\n\r\n    const itemsPerRow = Math.floor(containerWidth / stickerSize);\r\n    const rows = Math.ceil(category.items.length / itemsPerRow);\r\n    const height = rows * stickerSize;\r\n    \r\n    category.elements.items.style.minHeight = height + 'px';\r\n  }\r\n\r\n  private async renderStickerSet(set: StickerSet.stickerSet, prepend = false) {\r\n    const category = this.createCategory(set, wrapEmojiText(set.title));\r\n    const {menuTab, menuTabPadding, container} = category.elements;\r\n\r\n    positionElementByIndex(menuTab, this.menu, prepend ? 1 : 0xFFFF);\r\n\r\n    const promise = this.managers.appStickersManager.getStickerSet(set);\r\n    this.categoryAppendStickers(\r\n      category,\r\n      promise.then((stickerSet) => stickerSet.documents as MyDocument[])\r\n    );\r\n    // const stickerSet = await promise;\r\n\r\n    positionElementByIndex(container, this.scroll.container, prepend ? 1 : 0xFFFF, -1);\r\n\r\n    wrapStickerSetThumb({\r\n      set,\r\n      container: menuTabPadding,\r\n      group: EMOTICONSSTICKERGROUP,\r\n      lazyLoadQueue: EmoticonsDropdown.lazyLoadQueue,\r\n      width: 32,\r\n      height: 32,\r\n      autoplay: false\r\n    });\r\n  }\r\n\r\n  public init() {\r\n    this.content = document.getElementById('content-stickers');\r\n\r\n    const menuWrapper = this.content.previousElementSibling as HTMLDivElement;\r\n    this.menu = menuWrapper.firstElementChild as HTMLUListElement;\r\n\r\n    const menuScroll = new ScrollableX(menuWrapper);\r\n\r\n    this.scroll = new Scrollable(this.content, 'STICKERS');\r\n    this.scroll.onAdditionalScroll = () => {\r\n      setTyping();\r\n    };\r\n\r\n    /* stickersDiv.addEventListener('mouseover', (e) => {\r\n      let target = e.target as HTMLElement;\r\n\r\n      if(target.tagName === 'CANVAS') { // turn on sticker\r\n        let animation = lottieLoader.getAnimation(target.parentElement, EMOTICONSSTICKERGROUP);\r\n\r\n        if(animation) {\r\n          // @ts-ignore\r\n          if(animation.currentFrame === animation.totalFrames - 1) {\r\n            animation.goToAndPlay(0, true);\r\n          } else {\r\n            animation.play();\r\n          }\r\n        }\r\n      }\r\n    }); */\r\n\r\n    const onCategoryVisibility: OnVisibilityChange = ({target, visible, entry}) => {\r\n      const category = this.categoriesMap.get(target);\r\n      // console.log('roll the windows up', category, target, visible, entry);\r\n      if(!visible) {\r\n        category.elements.items.textContent = '';\r\n      } else {\r\n        category.elements.items.append(...category.items.map(({element}) => element));\r\n      }\r\n    };\r\n\r\n    const intersectionOptions: IntersectionObserverInit = {root: emoticonsDropdown.getElement()};\r\n    this.categoriesIntersector = new VisibilityIntersector(onCategoryVisibility, intersectionOptions);\r\n\r\n    const clearCategoryItems = (category: StickersTabCategory) => {\r\n      category.elements.items.textContent = '';\r\n      category.items.forEach(({element}) => this.superStickerRenderer.unobserveAnimated(element));\r\n      category.items.length = 0;\r\n    };\r\n\r\n    this.scroll.container.addEventListener('click', (e) => {\r\n      const target = e.target as HTMLElement;\r\n      if(findUpClassName(target, 'category-title')) {\r\n        const container = findUpClassName(target, 'emoji-category');\r\n        const category = this.categoriesMap.get(container);\r\n        if(category.set.id === 'recent') {\r\n          return;\r\n        }\r\n\r\n        new PopupStickers({id: category.set.id, access_hash: category.set.access_hash}).show();\r\n        return;\r\n      }\r\n\r\n      EmoticonsDropdown.onMediaClick(e);\r\n    });\r\n\r\n    const setTyping = (cancel = false) => {\r\n      rootScope.dispatchEvent('choosing_sticker', !cancel);\r\n    };\r\n\r\n    emoticonsDropdown.addEventListener('closed', () => {\r\n      setTyping(true);\r\n    });\r\n\r\n    emoticonsDropdown.addEventListener('opened', () => {\r\n      setTyping();\r\n    });\r\n\r\n    const {stickyIntersector, setActive} = EmoticonsDropdown.menuOnClick(this.menu, this.scroll, menuScroll);\r\n    this.stickyIntersector = stickyIntersector;\r\n\r\n    const preloader = putPreloader(this.content, true);\r\n\r\n    const recentCategory = this.createCategory({id: 'recent'} as any, i18n('Stickers.Recent'));\r\n    recentCategory.elements.title.classList.add('disable-hover');\r\n    recentCategory.elements.menuTab.classList.add('tgico-recent', 'active');\r\n    recentCategory.elements.menuTabPadding.remove();\r\n    this.toggleRecentCategory(recentCategory, false);\r\n\r\n    const clearButton = ButtonIcon('close', {noRipple: true});\r\n    recentCategory.elements.title.append(clearButton);\r\n    attachClickEvent(clearButton, () => {\r\n      confirmationPopup({\r\n        titleLangKey: 'ClearRecentStickersAlertTitle',\r\n        descriptionLangKey: 'ClearRecentStickersAlertMessage',\r\n        button: {\r\n          langKey: 'Clear'\r\n        }\r\n      }).then(() => {\r\n        this.managers.appStickersManager.clearRecentStickers();\r\n      }, noop);\r\n    });\r\n\r\n    const onRecentStickers = (stickers: MyDocument[]) => {\r\n      const sliced = stickers.slice(0, RECENT_STICKERS_COUNT) as MyDocument[];\r\n\r\n      clearCategoryItems(recentCategory);\r\n      this.toggleRecentCategory(recentCategory, !!sliced.length);\r\n      this.categoryAppendStickers(recentCategory, Promise.resolve(sliced));\r\n    };\r\n\r\n    Promise.all([\r\n      this.managers.appStickersManager.getRecentStickers().then((stickers) => {\r\n        preloader.remove();\r\n        onRecentStickers(stickers.stickers as MyDocument[]);\r\n      }),\r\n\r\n      this.managers.appStickersManager.getAllStickers().then((res) => {\r\n        preloader.remove();\r\n\r\n        for(let set of (res as MessagesAllStickers.messagesAllStickers).sets) {\r\n          this.renderStickerSet(set);\r\n        }\r\n      })\r\n    ]).finally(() => {\r\n      this.mounted = true;\r\n      setTyping();\r\n      setActive(0);\r\n    });\r\n\r\n    this.superStickerRenderer = new SuperStickerRenderer(EmoticonsDropdown.lazyLoadQueue, EMOTICONSSTICKERGROUP, this.managers, intersectionOptions);\r\n\r\n    const rendererLazyLoadQueue = this.superStickerRenderer.lazyLoadQueue;\r\n    emoticonsDropdown.addLazyLoadQueueRepeat(rendererLazyLoadQueue, this.superStickerRenderer.processInvisible);\r\n\r\n    // emoticonsDropdown.addEventListener('close', () => {\r\n    //   this.categoriesIntersector.lock();\r\n    // });\r\n\r\n    // emoticonsDropdown.addEventListener('closed', () => {\r\n    //   for(const [container] of this.categoriesMap) {\r\n    //     onCategoryVisibility(container, false);\r\n    //   }\r\n    // });\r\n\r\n    // emoticonsDropdown.addEventListener('opened', () => {\r\n    //   this.categoriesIntersector.unlockAndRefresh();\r\n    // });\r\n\r\n    // setInterval(() => {\r\n    //   // @ts-ignore\r\n    //   const players = Object.values(lottieLoader.players).filter((p) => p.width >= 80);\r\n      \r\n    //   console.log(\r\n    //     'STICKERS RENDERED IN PANEL:', \r\n    //     players.length, \r\n    //     players.filter((p) => !p.paused).length, \r\n    //     rendererLazyLoadQueue.intersector.getVisible().length\r\n    //   );\r\n    // }, .25e3);\r\n\r\n    rootScope.addEventListener('stickers_installed', (set) => {\r\n      if(!this.categories[set.id] && this.mounted) {\r\n        this.renderStickerSet(set, true);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('stickers_deleted', ({id}) => {\r\n      const category = this.categories[id];\r\n      if(category && this.mounted) {\r\n        category.elements.container.remove();\r\n        category.elements.menuTab.remove();\r\n        this.categoriesIntersector.unobserve(category.elements.container);\r\n        clearCategoryItems(category);\r\n        delete this.categories[id];\r\n        this.categoriesMap.delete(category.elements.container);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('stickers_recent', (stickers) => {\r\n      if(this.mounted) {\r\n        onRecentStickers(stickers);\r\n      }\r\n    });\r\n\r\n    const resizeCategories = () => {\r\n      for(const [container, category] of this.categoriesMap) {\r\n        this.setCategoryItemsHeight(category);\r\n      }\r\n    };\r\n\r\n    mediaSizes.addEventListener('resize', resizeCategories);\r\n\r\n    emoticonsDropdown.addEventListener('opened', resizeCategories);\r\n    \r\n    this.init = null;\r\n  }\r\n\r\n  private toggleRecentCategory(category: StickersTabCategory, visible: boolean) {\r\n    if(!visible) {\r\n      category.elements.menuTab.remove();\r\n      category.elements.container.remove();\r\n    } else {\r\n      positionElementByIndex(category.elements.menuTab, this.menu, 0);\r\n      positionElementByIndex(category.elements.container, this.scroll.container, 0);\r\n    }\r\n    \r\n    // category.elements.container.classList.toggle('hide', !visible);\r\n  }\r\n\r\n  public pushRecentSticker(doc: MyDocument) {\r\n    this.managers.appStickersManager.pushRecentSticker(doc.id);\r\n    \r\n    const category = this.categories['recent'];\r\n    if(!category) {\r\n      return;\r\n    }\r\n\r\n    const items = category.elements.items;\r\n    let item = findAndSplice(category.items, (item) => item.document.id === doc.id);\r\n    if(!item) {\r\n      item = {\r\n        element: this.superStickerRenderer.renderSticker(doc),\r\n        document: doc\r\n      };\r\n    }\r\n\r\n    category.items.unshift(item);\r\n    if(items.childElementCount) items.prepend(item.element);\r\n    if(items.childElementCount > RECENT_STICKERS_COUNT) {\r\n      (Array.from(items.children) as HTMLElement[]).slice(RECENT_STICKERS_COUNT).forEach((el) => el.remove());\r\n    }\r\n\r\n    this.setCategoryItemsHeight(category);\r\n    this.toggleRecentCategory(category, true);\r\n  }\r\n\r\n  onClose() {\r\n\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport InputSearch from \"../../inputSearch\";\r\nimport animationIntersector from \"../../animationIntersector\";\r\nimport appSidebarRight from \"..\";\r\nimport { AppInlineBotsManager } from \"../../../lib/appManagers/appInlineBotsManager\";\r\nimport GifsMasonry from \"../../gifsMasonry\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\nimport type { MyDocument } from \"../../../lib/appManagers/appDocsManager\";\r\nimport mediaSizes from \"../../../helpers/mediaSizes\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport { NULL_PEER_ID } from \"../../../lib/mtproto/mtproto_config\";\r\n\r\nconst ANIMATIONGROUP = 'GIFS-SEARCH';\r\n\r\nexport default class AppGifsTab extends SliderSuperTab {\r\n  private inputSearch: InputSearch;\r\n  private gifsDiv: HTMLDivElement;\r\n\r\n  private nextOffset = '';\r\n  private loadedAll = false;\r\n\r\n  private gifBotPeerId: PeerId;\r\n  private masonry: GifsMasonry;\r\n\r\n  private searchPromise: ReturnType<AppInlineBotsManager['getInlineResults']>;\r\n\r\n  protected init() {\r\n    this.container.id = 'search-gifs-container';\r\n    \r\n    this.inputSearch = new InputSearch('SearchGifsTitle', (value) => {\r\n      this.reset();\r\n      this.search(value);\r\n    });\r\n    \r\n    this.title.replaceWith(this.inputSearch.container);\r\n    \r\n    this.gifsDiv = document.createElement('div');\r\n    this.gifsDiv.classList.add('gifs-masonry');\r\n    attachClickEvent(this.gifsDiv, this.onGifsClick, {listenerSetter: this.listenerSetter});\r\n    \r\n    this.scrollable.append(this.gifsDiv);\r\n    \r\n    this.masonry = new GifsMasonry(this.gifsDiv, ANIMATIONGROUP, this.scrollable);\r\n    //this.backBtn.parentElement.append(this.inputSearch.container);\r\n  }\r\n\r\n  private onGifsClick = (e: MouseEvent | TouchEvent) => {\r\n    const target = findUpClassName(e.target, 'gif');\r\n    if(!target) return;\r\n\r\n    const fileId = target.dataset.docId;\r\n    if(appImManager.chat.input.sendMessageWithDocument(fileId)) {\r\n      if(mediaSizes.isMobile) {\r\n        appSidebarRight.onCloseBtnClick();\r\n      }\r\n    } else {\r\n      console.warn('got no doc by id:', fileId);\r\n    }\r\n  };\r\n\r\n  public onClose() {\r\n    this.scrollable.onScrolledBottom = () => {};\r\n  }\r\n\r\n  public onCloseAfterTimeout() {\r\n    this.reset();\r\n    this.gifsDiv.innerHTML = '';\r\n    animationIntersector.checkAnimations(undefined, ANIMATIONGROUP);\r\n    this.inputSearch.remove();\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n\r\n  private reset() {\r\n    this.searchPromise = null;\r\n    this.nextOffset = '';\r\n    this.loadedAll = false;\r\n    this.masonry.clear();\r\n  }\r\n\r\n  public open() {\r\n    const ret = super.open();\r\n    appSidebarRight.toggleSidebar(true).then(() => {\r\n      this.search('', true);\r\n\r\n      this.scrollable.onScrolledBottom = () => {\r\n        this.search(this.inputSearch.value, false);\r\n      };\r\n    });\r\n    return ret;\r\n  }\r\n\r\n  public async search(query: string, newSearch = true) {\r\n    if(this.searchPromise || this.loadedAll) return;\r\n\r\n    if(!this.gifBotPeerId) {\r\n      this.gifBotPeerId = (await this.managers.appUsersManager.resolveUsername('gif')).id.toPeerId(false);\r\n    }\r\n\r\n    try {\r\n      this.searchPromise = this.managers.appInlineBotsManager.getInlineResults(NULL_PEER_ID, this.gifBotPeerId, query, this.nextOffset);\r\n      const { results, next_offset } = await this.searchPromise;\r\n\r\n      if(this.inputSearch.value !== query) {\r\n        return;\r\n      }\r\n\r\n      this.searchPromise = null;\r\n      this.nextOffset = next_offset;\r\n      if(newSearch) {\r\n        this.gifsDiv.innerHTML = '';\r\n      }\r\n\r\n      if(results.length) {\r\n        results.forEach((result) => {\r\n          if(result._ === 'botInlineMediaResult' && result.document) {\r\n            this.masonry.add(result.document as MyDocument);\r\n          }\r\n        });\r\n      } else {\r\n        this.loadedAll = true;\r\n      }\r\n\r\n      this.scrollable.onScroll();\r\n    } catch(err) {\r\n      this.searchPromise = null;\r\n      console.error('gifs loading error:', err);\r\n      throw err;\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SliderSuperTab } from \"../../slider\";\r\nimport InputSearch from \"../../inputSearch\";\r\nimport LazyLoadQueue from \"../../lazyLoadQueue\";\r\nimport appImManager from \"../../../lib/appManagers/appImManager\";\r\nimport PopupStickers from \"../../popups/stickers\";\r\nimport animationIntersector from \"../../animationIntersector\";\r\nimport { wrapSticker } from \"../../wrappers\";\r\nimport appSidebarRight from \"..\";\r\nimport { StickerSet, StickerSetCovered } from \"../../../layer\";\r\nimport { i18n } from \"../../../lib/langPack\";\r\nimport findUpClassName from \"../../../helpers/dom/findUpClassName\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport forEachReverse from \"../../../helpers/array/forEachReverse\";\r\nimport setInnerHTML from \"../../../helpers/dom/setInnerHTML\";\r\nimport wrapEmojiText from \"../../../lib/richTextProcessor/wrapEmojiText\";\r\n\r\nexport default class AppStickersTab extends SliderSuperTab {\r\n  private inputSearch: InputSearch;\r\n  private setsDiv: HTMLDivElement;\r\n  private lazyLoadQueue: LazyLoadQueue;\r\n\r\n  protected init() {\r\n    this.container.id = 'stickers-container';\r\n    this.container.classList.add('chatlist-container');\r\n\r\n    this.lazyLoadQueue = new LazyLoadQueue();\r\n\r\n    this.inputSearch = new InputSearch('StickersTab.SearchPlaceholder', (value) => {\r\n      this.search(value);\r\n    });\r\n\r\n    this.title.replaceWith(this.inputSearch.container);\r\n\r\n    this.setsDiv = document.createElement('div');\r\n    this.setsDiv.classList.add('sticker-sets');\r\n    this.scrollable.append(this.setsDiv);\r\n\r\n    attachClickEvent(this.setsDiv, (e) => {\r\n      const sticker = findUpClassName(e.target, 'sticker-set-sticker');\r\n      if(sticker) {\r\n        const docId = sticker.dataset.docId;\r\n        appImManager.chat.input.sendMessageWithDocument(docId);\r\n        return;\r\n      }\r\n\r\n      const target = findUpClassName(e.target, 'sticker-set');\r\n      if(!target) return;\r\n\r\n      const id = target.dataset.stickerSet as string;\r\n      const access_hash = target.dataset.access_hash as string;\r\n\r\n      const button = findUpClassName(e.target, 'sticker-set-button') as HTMLElement;\r\n      if(button) {\r\n        e.preventDefault();\r\n        e.cancelBubble = true;\r\n\r\n        button.setAttribute('disabled', 'true');\r\n        \r\n        this.managers.appStickersManager.getStickerSet({id, access_hash}).then((full) => {\r\n          this.managers.appStickersManager.toggleStickerSet(full.set).then((changed) => {\r\n            if(changed) {\r\n              button.textContent = '';\r\n              button.append(i18n(full.set.installed_date ? 'Stickers.SearchAdded' : 'Stickers.SearchAdd'));\r\n              button.classList.toggle('gray', !!full.set.installed_date);\r\n            }\r\n          }).finally(() => {\r\n            //button.style.width = set.installed_date ? '68px' : '52px';\r\n            button.removeAttribute('disabled');\r\n          });\r\n        });\r\n      } else {\r\n        this.managers.appStickersManager.getStickerSet({id, access_hash}).then((full) => {\r\n          new PopupStickers(full.set).show();\r\n        });\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n  }\r\n\r\n  public onCloseAfterTimeout() {\r\n    this.setsDiv.innerHTML = '';\r\n    animationIntersector.checkAnimations(undefined, 'STICKERS-SEARCH');\r\n    return super.onCloseAfterTimeout();\r\n  }\r\n\r\n  public renderSet(set: StickerSet.stickerSet) {\r\n    //console.log('renderSet:', set);\r\n    const div = document.createElement('div');\r\n    div.classList.add('sticker-set');\r\n\r\n    const header = document.createElement('div');\r\n    header.classList.add('sticker-set-header');\r\n\r\n    const details = document.createElement('div');\r\n    details.classList.add('sticker-set-details');\r\n    details.innerHTML = `<div class=\"sticker-set-name\"></div>`;\r\n\r\n    setInnerHTML(details.firstElementChild, wrapEmojiText(set.title));\r\n\r\n    const countDiv = document.createElement('div');\r\n    countDiv.classList.add('sticker-set-count');\r\n    countDiv.append(i18n('Stickers', [set.count]));\r\n    details.append(countDiv);\r\n    \r\n    const button = document.createElement('button');\r\n    button.classList.add('btn-primary', 'btn-color-primary', 'sticker-set-button');\r\n    button.append(i18n(set.installed_date ? 'Stickers.SearchAdded' : 'Stickers.SearchAdd'));\r\n   // button.style.width = set.installed_date ? '68px' : '52px';\r\n\r\n    if(set.installed_date) {\r\n      button.classList.add('gray');\r\n    }\r\n\r\n    //ripple(button);\r\n\r\n    header.append(details, button);\r\n\r\n    const stickersDiv = document.createElement('div');\r\n    stickersDiv.classList.add('sticker-set-stickers');\r\n\r\n    const count = Math.min(5, set.count);\r\n    for(let i = 0; i < count; ++i) {\r\n      const stickerDiv = document.createElement('div');\r\n      stickerDiv.classList.add('sticker-set-sticker');\r\n\r\n      stickersDiv.append(stickerDiv);\r\n    }\r\n\r\n    this.managers.appStickersManager.getStickerSet(set).then((set) => {\r\n      //console.log('renderSet got set:', set);\r\n      \r\n      for(let i = 0; i < count; ++i) {\r\n        const div = stickersDiv.children[i] as HTMLDivElement;\r\n        const doc = set.documents[i];\r\n        if(doc._ === 'documentEmpty') {\r\n          continue;\r\n        }\r\n\r\n        wrapSticker({\r\n          doc, \r\n          div, \r\n          lazyLoadQueue: this.lazyLoadQueue, \r\n          group: 'STICKERS-SEARCH', \r\n          /* play: false,\r\n          loop: false, */\r\n          play: true,\r\n          loop: true,\r\n          width: 68,\r\n          height: 68\r\n        });\r\n      }\r\n    });\r\n\r\n    /* const onMouseOver = () => {\r\n      const animations: AnimationItem['animation'][] = [];\r\n      for(let i = 0; i < count; ++i) {\r\n        const stickerDiv = stickersDiv.children[i] as HTMLElement;\r\n        const animationItem = animationIntersector.getAnimation(stickerDiv);\r\n        if(!animationItem) continue;\r\n\r\n        const animation = animationItem.animation;\r\n\r\n        animations.push(animation);\r\n        animation.loop = true;\r\n        animation.play();\r\n      }\r\n\r\n      div.addEventListener('mouseout', () => {\r\n        animations.forEach((animation) => {\r\n          animation.loop = false;\r\n        });\r\n\r\n        div.addEventListener('mouseover', onMouseOver, {once: true});\r\n      }, {once: true});\r\n    };\r\n\r\n    div.addEventListener('mouseover', onMouseOver, {once: true}); */\r\n\r\n    div.dataset.stickerSet = '' + set.id;\r\n    div.dataset.access_hash = '' + set.access_hash;\r\n    div.dataset.title = set.title;\r\n\r\n    div.append(header, stickersDiv);\r\n\r\n    this.setsDiv.append(div);\r\n  }\r\n\r\n  public open() {\r\n    const ret = super.open();\r\n    appSidebarRight.toggleSidebar(true).then(() => {\r\n      this.renderFeatured();\r\n    });\r\n\r\n    return ret;\r\n  }\r\n\r\n  public renderFeatured() {\r\n    return this.managers.appStickersManager.getFeaturedStickers().then((coveredSets) => {\r\n      if(this.inputSearch.value) {\r\n        return;\r\n      }\r\n\r\n      coveredSets = this.filterRendered('', coveredSets);\r\n      coveredSets.forEach((set) => {\r\n        this.renderSet(set.set);\r\n      });\r\n    });\r\n  }\r\n\r\n  private filterRendered(query: string, coveredSets: StickerSetCovered[]) {\r\n    coveredSets = coveredSets.slice();\r\n\r\n    const children = Array.from(this.setsDiv.children) as HTMLElement[];\r\n    forEachReverse(children, el => {\r\n      const id = el.dataset.stickerSet;\r\n      const index = coveredSets.findIndex((covered) => covered.set.id === id);\r\n  \r\n      if(index !== -1) {\r\n        coveredSets.splice(index, 1);\r\n      } else if(!query || !el.dataset.title.toLowerCase().includes(query.toLowerCase())) {\r\n        el.remove();\r\n      }\r\n    });\r\n\r\n    animationIntersector.checkAnimations(undefined, 'STICKERS-SEARCH');\r\n\r\n    return coveredSets;\r\n  }\r\n\r\n  public search(query: string) {\r\n    if(!query) {\r\n      return this.renderFeatured();\r\n    }\r\n\r\n    return this.managers.appStickersManager.searchStickerSets(query, false).then((coveredSets) => {\r\n      if(this.inputSearch.value !== query) {\r\n        return;\r\n      }\r\n\r\n      //console.log('search result:', coveredSets);\r\n\r\n      coveredSets = this.filterRendered(query, coveredSets);\r\n      coveredSets.forEach((set) => {\r\n        this.renderSet(set.set);\r\n      });\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"./dom/clickEvent\";\r\nimport findUpAsChild from \"./dom/findUpAsChild\";\r\nimport EventListenerBase from \"./eventListenerBase\";\r\nimport ListenerSetter from \"./listenerSetter\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport safeAssign from \"./object/safeAssign\";\r\n\r\nconst KEEP_OPEN = false;\r\nconst TOGGLE_TIMEOUT = 200;\r\nconst ANIMATION_DURATION = 200;\r\n\r\nexport default class DropdownHover extends EventListenerBase<{\r\n  open: () => Promise<any> | void,\r\n  opened: () => any,\r\n  close: () => any,\r\n  closed: () => any\r\n}> {\r\n  protected element: HTMLElement;\r\n  protected displayTimeout: number;\r\n  protected forceClose = false;\r\n  protected inited = false;\r\n\r\n  constructor(options: {\r\n    element: DropdownHover['element']\r\n  }) {\r\n    super(false);\r\n    safeAssign(this, options);\r\n  }\r\n\r\n  public attachButtonListener(button: HTMLElement, listenerSetter: ListenerSetter) {\r\n    let firstTime = true;\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      attachClickEvent(button, () => {\r\n        if(firstTime) {\r\n          firstTime = false;\r\n          this.toggle(true);\r\n        } else {\r\n          this.toggle();\r\n        }\r\n      }, {listenerSetter});\r\n    } else {\r\n      listenerSetter.add(button)('mouseover', (e) => {\r\n        //console.log('onmouseover button');\r\n        if(firstTime) {\r\n          listenerSetter.add(button)('mouseout', (e) => {\r\n            clearTimeout(this.displayTimeout);\r\n            this.onMouseOut(e);\r\n          });\r\n          firstTime = false;\r\n        }\r\n\r\n        clearTimeout(this.displayTimeout);\r\n        this.displayTimeout = window.setTimeout(() => {\r\n          this.toggle(true);\r\n        }, TOGGLE_TIMEOUT);\r\n      });\r\n    }\r\n  }\r\n\r\n  private onMouseOut = (e: MouseEvent) => {\r\n    if(KEEP_OPEN || !this.isActive()) return;\r\n    clearTimeout(this.displayTimeout);\r\n\r\n    const toElement = (e as any).toElement as Element;\r\n    if(toElement && findUpAsChild(toElement, this.element)) {\r\n      return;\r\n    }\r\n\r\n    this.displayTimeout = window.setTimeout(() => {\r\n      this.toggle(false);\r\n    }, TOGGLE_TIMEOUT);\r\n  };\r\n\r\n  protected init() {\r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      this.element.onmouseout = this.onMouseOut;\r\n      this.element.onmouseover = (e) => {\r\n        if(this.forceClose) {\r\n          return;\r\n        }\r\n\r\n        //console.log('onmouseover element');\r\n        clearTimeout(this.displayTimeout);\r\n      };\r\n    }\r\n  }\r\n\r\n  public toggle = async(enable?: boolean) => {\r\n    //if(!this.element) return;\r\n    const willBeActive = (!!this.element.style.display && enable === undefined) || enable;\r\n    if(this.init) {\r\n      if(willBeActive) {\r\n        this.init();\r\n        this.init = null;\r\n      } else {\r\n        return;\r\n      }\r\n    }\r\n\r\n    if(willBeActive === this.isActive()) {\r\n      return;\r\n    }\r\n    \r\n    if((this.element.style.display && enable === undefined) || enable) {\r\n      const res = this.dispatchResultableEvent('open');\r\n      await Promise.all(res);\r\n\r\n      this.element.style.display = '';\r\n      void this.element.offsetLeft; // reflow\r\n      this.element.classList.add('active');\r\n\r\n      clearTimeout(this.displayTimeout);\r\n      this.displayTimeout = window.setTimeout(() => {\r\n        this.forceClose = false;\r\n        this.dispatchEvent('opened');\r\n      }, IS_TOUCH_SUPPORTED ? 0 : ANIMATION_DURATION);\r\n\r\n      // ! can't use together with resizeObserver\r\n      /* if(isTouchSupported) {\r\n        const height = this.element.scrollHeight + appImManager.chat.input.inputContainer.scrollHeight - 10;\r\n        console.log('[ESG]: toggle: enable height', height);\r\n        appImManager.chat.bubbles.scrollable.scrollTop += height;\r\n      } */\r\n\r\n      /* if(touchSupport) {\r\n        this.restoreScroll();\r\n      } */\r\n    } else {\r\n      this.dispatchEvent('close');\r\n\r\n      this.element.classList.remove('active');\r\n\r\n      clearTimeout(this.displayTimeout);\r\n      this.displayTimeout = window.setTimeout(() => {\r\n        this.element.style.display = 'none';\r\n        this.forceClose = false;\r\n        this.dispatchEvent('closed');\r\n      }, IS_TOUCH_SUPPORTED ? 0 : ANIMATION_DURATION);\r\n\r\n      /* if(isTouchSupported) {\r\n        const scrollHeight = this.container.scrollHeight;\r\n        if(scrollHeight) {\r\n          const height = this.container.scrollHeight + appImManager.chat.input.inputContainer.scrollHeight - 10;\r\n          appImManager.chat.bubbles.scrollable.scrollTop -= height;\r\n        }\r\n      } */\r\n\r\n      /* if(touchSupport) {\r\n        this.restoreScroll();\r\n      } */\r\n    }\r\n\r\n    //animationIntersector.checkAnimations(false, EMOTICONSSTICKERGROUP);\r\n  };\r\n\r\n  public isActive() {\r\n    return this.element.classList.contains('active');\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport { horizontalMenu } from \"../horizontalMenu\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport Scrollable, { ScrollableX } from \"../scrollable\";\r\nimport appSidebarRight from \"../sidebarRight\";\r\nimport StickyIntersector from \"../stickyIntersector\";\r\nimport EmojiTab from \"./tabs/emoji\";\r\nimport GifsTab from \"./tabs/gifs\";\r\nimport StickersTab from \"./tabs/stickers\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport AppGifsTab from \"../sidebarRight/tabs/gifs\";\r\nimport AppStickersTab from \"../sidebarRight/tabs/stickers\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport blurActiveElement from \"../../helpers/dom/blurActiveElement\";\r\nimport whichChild from \"../../helpers/dom/whichChild\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport DropdownHover from \"../../helpers/dropdownHover\";\r\nimport pause from \"../../helpers/schedulers/pause\";\r\nimport { IS_APPLE_MOBILE } from \"../../environment/userAgent\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport type LazyLoadQueueIntersector from \"../lazyLoadQueueIntersector\";\r\nimport { simulateClickEvent } from \"../../helpers/dom/clickEvent\";\r\n\r\nexport const EMOTICONSSTICKERGROUP = 'emoticons-dropdown';\r\n\r\nexport interface EmoticonsTab {\r\n  init: () => void,\r\n  onCloseAfterTimeout?: () => void\r\n}\r\n\r\nexport class EmoticonsDropdown extends DropdownHover {\r\n  public static lazyLoadQueue = new LazyLoadQueue();\r\n\r\n  private emojiTab: EmojiTab;\r\n  public stickersTab: StickersTab;\r\n  private gifsTab: GifsTab;\r\n\r\n  private container: HTMLElement;\r\n  private tabsEl: HTMLElement;\r\n  private tabId = -1;\r\n\r\n  private tabs: {[id: number]: EmoticonsTab};\r\n\r\n  private searchButton: HTMLElement;\r\n  private deleteBtn: HTMLElement;\r\n\r\n  private selectTab: ReturnType<typeof horizontalMenu>;\r\n\r\n  private savedRange: Range;\r\n  private managers: AppManagers;\r\n\r\n  constructor() {\r\n    super({\r\n      element: document.getElementById('emoji-dropdown') as HTMLDivElement\r\n    });\r\n\r\n    this.addEventListener('open', async() => {\r\n      if(IS_TOUCH_SUPPORTED) {\r\n        //appImManager.chat.input.saveScroll();\r\n        if(blurActiveElement()) {\r\n          await pause(100);\r\n        }\r\n      }\r\n\r\n      if(this.element.parentElement !== appImManager.chat.input.chatInput) {\r\n        appImManager.chat.input.chatInput.append(this.element);\r\n      }\r\n\r\n      this.savedRange = this.getGoodRange();\r\n\r\n      EmoticonsDropdown.lazyLoadQueue.lock();\r\n      //EmoticonsDropdown.lazyLoadQueue.unlock();\r\n      animationIntersector.lockIntersectionGroup(EMOTICONSSTICKERGROUP);\r\n    });\r\n\r\n    this.addEventListener('opened', () => {\r\n      animationIntersector.unlockIntersectionGroup(EMOTICONSSTICKERGROUP);\r\n      EmoticonsDropdown.lazyLoadQueue.unlock();\r\n      EmoticonsDropdown.lazyLoadQueue.refresh();\r\n\r\n      this.container.classList.remove('disable-hover');\r\n    });\r\n\r\n    this.addEventListener('close', () => {\r\n      EmoticonsDropdown.lazyLoadQueue.lock();\r\n      //EmoticonsDropdown.lazyLoadQueue.lock();\r\n\r\n      //      \r\n      animationIntersector.lockIntersectionGroup(EMOTICONSSTICKERGROUP);\r\n      animationIntersector.checkAnimations(true, EMOTICONSSTICKERGROUP);\r\n    });\r\n\r\n    this.addEventListener('closed', () => {\r\n      //    visible,      \r\n      animationIntersector.unlockIntersectionGroup(EMOTICONSSTICKERGROUP);\r\n      EmoticonsDropdown.lazyLoadQueue.unlock();\r\n      EmoticonsDropdown.lazyLoadQueue.refresh();\r\n\r\n      this.container.classList.remove('disable-hover');\r\n\r\n      this.savedRange = undefined;\r\n    });\r\n  }\r\n\r\n  protected init() {\r\n    this.managers = rootScope.managers;\r\n    this.emojiTab = new EmojiTab(this.managers);\r\n    this.stickersTab = new StickersTab(this.managers);\r\n    this.gifsTab = new GifsTab(this.managers);\r\n\r\n    this.tabs = {\r\n      0: this.emojiTab,\r\n      1: this.stickersTab,\r\n      2: this.gifsTab\r\n    };\r\n\r\n    this.container = this.element.querySelector('.emoji-container .tabs-container') as HTMLDivElement;\r\n    this.tabsEl = this.element.querySelector('.emoji-tabs') as HTMLUListElement;\r\n    this.selectTab = horizontalMenu(this.tabsEl, this.container, this.onSelectTabClick, () => {\r\n      const tab = this.tabs[this.tabId];\r\n      if(tab.init) {\r\n        tab.init();\r\n      }\r\n\r\n      tab.onCloseAfterTimeout && tab.onCloseAfterTimeout();\r\n      animationIntersector.checkAnimations(false, EMOTICONSSTICKERGROUP);\r\n    });\r\n\r\n    this.searchButton = this.element.querySelector('.emoji-tabs-search');\r\n    this.searchButton.addEventListener('click', () => {\r\n      if(this.tabId === 1) {\r\n        if(!appSidebarRight.isTabExists(AppStickersTab)) {\r\n          appSidebarRight.createTab(AppStickersTab).open();\r\n        }\r\n      } else {\r\n        if(!appSidebarRight.isTabExists(AppGifsTab)) {\r\n          appSidebarRight.createTab(AppGifsTab).open();\r\n        }\r\n      }\r\n    });\r\n\r\n    this.deleteBtn = this.element.querySelector('.emoji-tabs-delete');\r\n    this.deleteBtn.addEventListener('click', (e) => {\r\n      const input = appImManager.chat.input.messageInput;\r\n      if((input.lastChild as any)?.tagName) {\r\n        input.lastElementChild.remove();\r\n      } else if(input.lastChild) {\r\n        if(!input.lastChild.textContent.length) {\r\n          input.lastChild.remove();\r\n        } else {\r\n          input.lastChild.textContent = input.lastChild.textContent.slice(0, -1);\r\n        }\r\n      }\r\n\r\n      const event = new Event('input', {bubbles: true, cancelable: true});\r\n      appImManager.chat.input.messageInput.dispatchEvent(event);\r\n      //appSidebarRight.stickersTab.init();\r\n\r\n      cancelEvent(e);\r\n    });\r\n    \r\n    const HIDE_EMOJI_TAB = IS_APPLE_MOBILE;\r\n\r\n    const INIT_TAB_ID = HIDE_EMOJI_TAB ? 1 : 0;\r\n\r\n    if(HIDE_EMOJI_TAB) {\r\n      (this.tabsEl.children[1] as HTMLElement).classList.add('hide');\r\n    }\r\n\r\n    simulateClickEvent(this.tabsEl.children[INIT_TAB_ID + 1] as HTMLElement); // set emoji tab\r\n    if(this.tabs[INIT_TAB_ID].init) {\r\n      this.tabs[INIT_TAB_ID].init(); // onTransitionEnd  , ..    \r\n    }\r\n\r\n    appImManager.addEventListener('peer_changed', this.checkRights);\r\n    this.checkRights();\r\n\r\n    return super.init();\r\n  }\r\n\r\n  public getElement() {\r\n    return this.element;\r\n  }\r\n\r\n  private onSelectTabClick = (id: number) => {\r\n    if(this.tabId === id) {\r\n      return;\r\n    }\r\n    \r\n    animationIntersector.checkAnimations(true, EMOTICONSSTICKERGROUP);\r\n\r\n    this.tabId = id;\r\n    this.searchButton.classList.toggle('hide', this.tabId === 0);\r\n    this.deleteBtn.classList.toggle('hide', this.tabId !== 0);\r\n  };\r\n\r\n  private checkRights = () => {\r\n    const {peerId, threadId} = appImManager.chat;\r\n    const children = this.tabsEl.children;\r\n    const tabsElements = Array.from(children) as HTMLElement[];\r\n\r\n    const canSendStickers = this.managers.appMessagesManager.canSendToPeer(peerId, threadId, 'send_stickers');\r\n    tabsElements[2].toggleAttribute('disabled', !canSendStickers);\r\n\r\n    const canSendGifs = this.managers.appMessagesManager.canSendToPeer(peerId, threadId, 'send_gifs');\r\n    tabsElements[3].toggleAttribute('disabled', !canSendGifs);\r\n\r\n    const active = this.tabsEl.querySelector('.active');\r\n    if(active && whichChild(active) !== 1 && (!canSendStickers || !canSendGifs)) {\r\n      this.selectTab(0, false);\r\n    }\r\n  };\r\n\r\n  public static menuOnClick = (menu: HTMLElement, scroll: Scrollable, menuScroll?: ScrollableX, prevId = 0) => {\r\n    let jumpedTo = -1;\r\n\r\n    const setActive = (id: number) => {\r\n      if(id === prevId) {\r\n        return false;\r\n      }\r\n\r\n      menu.children[prevId].classList.remove('active');\r\n      menu.children[id].classList.add('active');\r\n      prevId = id;\r\n\r\n      return true;\r\n    };\r\n\r\n    const stickyIntersector = new StickyIntersector(scroll.container, (stuck, target) => {\r\n      //console.log('sticky scrollTOp', stuck, target, scroll.container.scrollTop);\r\n\r\n      if(Math.abs(jumpedTo - scroll.container.scrollTop) <= 1) {\r\n        return;\r\n      } else {\r\n        jumpedTo = -1;\r\n      }\r\n\r\n      const which = whichChild(target);\r\n      if(!stuck && which) { // * due to stickyIntersector\r\n        return;\r\n      }\r\n\r\n      setActive(which);\r\n\r\n      if(menuScroll) {\r\n        menuScroll.scrollIntoViewNew({\r\n          element: menu.children[which] as HTMLElement,\r\n          position: 'center',\r\n          axis: 'x'\r\n        });\r\n      }\r\n    });\r\n\r\n    menu.addEventListener('click', (e) => {\r\n      let target = e.target as HTMLElement;\r\n      target = findUpClassName(target, 'menu-horizontal-div-item');\r\n\r\n      if(!target) {\r\n        return;\r\n      }\r\n\r\n      const which = whichChild(target);\r\n\r\n      /* if(menuScroll) {\r\n        menuScroll.scrollIntoView(target, false, 0);\r\n      } */\r\n\r\n      if(!setActive(which)) {\r\n        return;\r\n      }\r\n\r\n      const element = (scroll.splitUp || scroll.container).children[which] as HTMLElement;\r\n      const offsetTop = element.offsetTop + 1; // * due to stickyIntersector\r\n\r\n      scroll.container.scrollTop = jumpedTo = offsetTop;\r\n\r\n      //console.log('set scrollTop:', offsetTop);\r\n    });\r\n\r\n    return {stickyIntersector, setActive};\r\n  };\r\n\r\n  public static onMediaClick = (e: {target: EventTarget | Element}, clearDraft = false) => {\r\n    let target = e.target as HTMLElement;\r\n    target = findUpTag(target, 'DIV');\r\n\r\n    if(!target) return false;\r\n    \r\n    const fileId = target.dataset.docId;\r\n    if(!fileId) return false;\r\n\r\n    if(appImManager.chat.input.sendMessageWithDocument(fileId, undefined, clearDraft)) {\r\n      /* dropdown.classList.remove('active');\r\n      toggleEl.classList.remove('active'); */\r\n      if(emoticonsDropdown.container) {\r\n        emoticonsDropdown.forceClose = true;\r\n        emoticonsDropdown.container.classList.add('disable-hover');\r\n        emoticonsDropdown.toggle(false);\r\n      }\r\n\r\n      return true;\r\n    } else {\r\n      console.warn('got no doc by id:', fileId);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  public addLazyLoadQueueRepeat(lazyLoadQueue: LazyLoadQueueIntersector, processInvisibleDiv: (div: HTMLElement) => void) {\r\n    this.addEventListener('close', () => {\r\n      lazyLoadQueue.lock();\r\n    });\r\n\r\n    this.addEventListener('closed', () => {\r\n      const divs = lazyLoadQueue.intersector.getVisible();\r\n\r\n      for(const div of divs) {\r\n        processInvisibleDiv(div);\r\n      }\r\n\r\n      lazyLoadQueue.intersector.clearVisible();\r\n    });\r\n\r\n    this.addEventListener('opened', () => {\r\n      lazyLoadQueue.unlockAndRefresh();\r\n    });\r\n  }\r\n\r\n  public getSavedRange() {\r\n    return this.getGoodRange() || this.savedRange;\r\n  }\r\n\r\n  private getGoodRange() {\r\n    const sel = document.getSelection();\r\n    if(sel.rangeCount && document.activeElement === appImManager.chat.input.messageInput) {\r\n      return sel.getRangeAt(0);\r\n    }\r\n  }\r\n}\r\n\r\nconst emoticonsDropdown = new EmoticonsDropdown();\r\nMOUNT_CLASS_TO.emoticonsDropdown = emoticonsDropdown;\r\nexport default emoticonsDropdown;\r\n","function cacheCallback<A, T>(callback: (str: A) => T) {\r\n  const stringResults: any = {}, numberResults: any = {};\r\n  return (value: A): T => {\r\n    const key = '_' + value;\r\n    return (typeof(value) === 'string' ? stringResults : numberResults)[key] ??= callback(value);\r\n  };\r\n}\r\n\r\nexport default cacheCallback;\r\n","export default function replaceNonNumber(str: string) {\r\n  return str.replace(/\\D/g, '');\r\n}\r\n","import cacheCallback from \"../cacheCallback\";\r\nimport replaceNonNumber from \"../string/replaceNonNumber\";\r\n\r\nconst CARD_BRAND_REGEXP: {[brand: string]: RegExp} = {\r\n  visa: /^4/,\r\n  mastercard: /^(51|52|53|54|55|222|23|24|25|26|27)/,\r\n  amex: /^(34|37)/,\r\n  discover: /^(60|64|65)/,\r\n  diners: /^(30|38|39)/,\r\n  diners14: /^(36)/,\r\n  jcb: /^(35)/,\r\n  unionpay: /^(62[0-6,8-9]|627[0-6,8-9]|6277[0-7,9]|62778[1-9]|81)/,\r\n  elo: /^(5067|509|636368|627780)/,\r\n  mir: /^(220[0-4])/\r\n};\r\n\r\n// * taken from Stripe\r\nexport const CARD_BRANDS: {[b: string]: {\r\n  minLength: number,\r\n  maxLength: number,\r\n  cvcMaxLength: number,\r\n  cvcMinLength: number | null\r\n}} = {\r\n  visa: {\r\n    minLength: 16,\r\n    maxLength: 16,\r\n    cvcMaxLength: 3,\r\n    cvcMinLength: null\r\n  },\r\n  mastercard: {\r\n    minLength: 16,\r\n    maxLength: 16,\r\n    cvcMaxLength: 3,\r\n    cvcMinLength: null\r\n  },\r\n  amex: {\r\n    minLength: 15,\r\n    maxLength: 15,\r\n    cvcMaxLength: 4,\r\n    cvcMinLength: 3\r\n  },\r\n  unionpay: {\r\n    minLength: 13,\r\n    maxLength: 19,\r\n    cvcMaxLength: 3,\r\n    cvcMinLength: null\r\n  },\r\n  diners: {\r\n    minLength: 16,\r\n    maxLength: 16,\r\n    cvcMaxLength: 3,\r\n    cvcMinLength: null\r\n  },\r\n  diners14: {\r\n    minLength: 14,\r\n    maxLength: 14,\r\n    cvcMaxLength: 3,\r\n    cvcMinLength: null\r\n  },\r\n  discover: {\r\n    minLength: 16,\r\n    maxLength: 16,\r\n    cvcMaxLength: 3,\r\n    cvcMinLength: null\r\n  },\r\n  jcb: {\r\n    minLength: 16,\r\n    maxLength: 16,\r\n    cvcMaxLength: 3,\r\n    cvcMinLength: null\r\n  },\r\n  elo: {\r\n    minLength: 16,\r\n    maxLength: 16,\r\n    cvcMaxLength: 3,\r\n    cvcMinLength: null\r\n  },\r\n  mir: {\r\n    minLength: 16,\r\n    maxLength: 16,\r\n    cvcMaxLength: 3,\r\n    cvcMinLength: null\r\n  },\r\n  unknown: {\r\n    minLength: 16,\r\n    maxLength: 16,\r\n    cvcMaxLength: 4,\r\n    cvcMinLength: 3\r\n  }\r\n};\r\n\r\nexport const detectCardBrand = cacheCallback((card: string = '') => {\r\n  const keys = Object.keys(CARD_BRAND_REGEXP);\r\n  const sanitizedCard = replaceNonNumber(card);\r\n  let brand: string;\r\n  let last = 0;\r\n  keys.forEach((key) => {\r\n    const regExp = CARD_BRAND_REGEXP[key];\r\n    const match = sanitizedCard.match(regExp);\r\n    if(match) {\r\n      const result = match[0];\r\n      if(result && result.length > last) {\r\n        brand = key;\r\n        last = result.length;\r\n      }\r\n    }\r\n  });\r\n\r\n  return brand || 'unknown';\r\n});\r\n\r\nexport function cardBrandToUnifiedBrand(brand: string) {\r\n  return brand === 'diners14' ? 'diners' : brand;\r\n}\r\n\r\nexport function detectUnifiedCardBrand(card = '') {\r\n  const brand = detectCardBrand(card);\r\n  return cardBrandToUnifiedBrand(brand);\r\n}\r\n","export default function createArray<T1>(length: number, fill?: T1, map?: any): T1[] {\r\n  const arr = new Array<T1>(length);\r\n  arr.fill(fill);\r\n  return map ? arr.map(map) : arr;\r\n}\r\n","const delta = ''.charCodeAt(0) - '0'.charCodeAt(0);\r\nconst buggedRegExp = /[-]/g;\r\n\r\n// function hasBuggedNumbers(str: string) {\r\n//   return !!str.match(a);\r\n// }\r\n\r\nfunction getDistanceFromBuggedToNormal(char: string) {\r\n  return String.fromCharCode(char.charCodeAt(0) - delta);\r\n}\r\n\r\nexport function fixBuggedNumbers(str: string) {\r\n  return str.replace(buggedRegExp, getDistanceFromBuggedToNormal);\r\n}\r\n","import { fixBuggedNumbers } from \"../string/buggedNumbers\";\r\nimport replaceNonNumber from \"../string/replaceNonNumber\";\r\n\r\nexport type PatternCharacter = {\r\n  type: 'optional',\r\n  result: string,\r\n  consumed: number\r\n} | {\r\n  type: 'required',\r\n  result: string,\r\n  consumed: number,\r\n  partial?: boolean\r\n} | {\r\n  type: 'formatting',\r\n  result: string,\r\n  consumed: number\r\n};\r\n\r\nexport type PatternFunction = (str: string) => ((str: string) => PatternCharacter)[];\r\n\r\nfunction makeOptionalCharacter(result: string, consumed: number): PatternCharacter {\r\n  return {type: 'optional', result, consumed};\r\n}\r\n\r\nfunction makeRequiredCharacter(result: string, consumed: number, partial?: boolean): PatternCharacter {\r\n  return {type: 'required', result, consumed, partial};\r\n}\r\n\r\nfunction makeFormattingCharacter(result: string, consumed: number): PatternCharacter {\r\n  return {type: 'formatting', result, consumed};\r\n}\r\n\r\nfunction wrapCharacterRegExpFactory(regExp: RegExp, optional?: boolean) {\r\n  return (str: string) => {\r\n    const _regExp = new RegExp('^'.concat(regExp.source.replace(/^\\^/, '')));\r\n    const match = str.match(_regExp);\r\n    const makeCharacter = optional ? makeOptionalCharacter : makeRequiredCharacter;\r\n    if(match) {\r\n      const result = match[0];\r\n      return makeCharacter(result, match.index + result.length);\r\n    }\r\n\r\n    return makeCharacter('', str.length);\r\n  };\r\n}\r\n\r\nfunction makeCapitalPatternCharacter(str: string) {\r\n  const char = wrapCharacterRegExpFactory(/\\w/)(str);\r\n  return char.result ? makeRequiredCharacter(char.result.toUpperCase(), char.consumed) : char;\r\n}\r\n\r\nconst makeMonthDigitPatternCharacter = wrapCharacterRegExpFactory(/1[0-2]|0?[1-9]|0/);\r\n\r\nfunction digit(str: string) {\r\n  return wrapCharacterRegExpFactory(/[0-9]/)(fixBuggedNumbers(str));\r\n}\r\n\r\nconst patternCharacters = {\r\n  digit,\r\n  capitalCharacter: makeCapitalPatternCharacter,\r\n  month: (str: string) => {\r\n    const char = makeMonthDigitPatternCharacter(fixBuggedNumbers(str));\r\n    const cleanedResult = replaceNonNumber(char.result);\r\n    const isPartial = ['0', '1'].includes(char.result) && str.length === 1;\r\n    if(isPartial || (char.result === '0' && str.length >= 2)) {\r\n      return makeRequiredCharacter(char.result, str.length, true);\r\n    }\r\n\r\n    return makeRequiredCharacter(cleanedResult.length === 1 ? '0' + cleanedResult : cleanedResult, char.consumed);\r\n  },\r\n  formattingCharacter: (str: string) => {\r\n    return (str1: string) => {\r\n      const consumed = str === str1[0] ? 1 : 0;\r\n      return makeFormattingCharacter(str, consumed);\r\n    }\r\n  },\r\n  optionalPattern: (regExp: RegExp) => {\r\n    return (str: string) => {\r\n      const char = wrapCharacterRegExpFactory(regExp, true)(str);\r\n      return char.result ? char : makeOptionalCharacter('', 0);\r\n    };\r\n  }\r\n};\r\n\r\nexport default patternCharacters;\r\n","import { IS_ANDROID } from \"../../environment/userAgent\";\r\nimport createArray from \"../array/createArray\";\r\nimport cacheCallback from \"../cacheCallback\";\r\nimport replaceNonNumber from \"../string/replaceNonNumber\";\r\nimport { CARD_BRANDS, detectCardBrand } from \"./cardBrands\";\r\nimport patternCharacters from \"./patternCharacters\";\r\n\r\nconst digit = patternCharacters.digit;\r\nconst capitalCharacter = patternCharacters.capitalCharacter;\r\nconst spaceCharacter = patternCharacters.formattingCharacter(' ');\r\nconst yearOptionalPattern = patternCharacters.optionalPattern(/\\d\\d/);\r\nconst sixteenPattern = [digit, digit, digit, digit, spaceCharacter, digit, digit, digit, digit, digit, digit, spaceCharacter, digit, digit, digit, digit, digit];\r\nconst fifteenPattern = [digit, digit, digit, digit, spaceCharacter, digit, digit, digit, digit, digit, digit, spaceCharacter, digit, digit, digit, digit];\r\n\r\nconst requiredPostcodes = new Set(['DZ', 'AR', 'AM', 'AU', 'AT', 'AZ', 'PT', 'BD', 'BY', 'BE', 'BA', 'BR', 'BN', 'BG', 'CA', 'IC', 'CN', 'CO', 'HR', 'CY', 'CZ', 'DK', 'EC', 'GB', 'EE', 'FO', 'FI', 'FR', 'GE', 'DE', 'GR', 'GL', 'GU', 'GG', 'NL', 'HU', 'IN', 'ID', 'IL', 'IT', 'JP', 'JE', 'KZ', 'KR', 'FM', 'KG', 'LV', 'LI', 'LT', 'LU', 'MK', 'MG', 'PT', 'MY', 'MH', 'MQ', 'YT', 'MX', 'MN', 'ME', 'NL', 'NZ', 'GB', 'NO', 'PK', 'PH', 'PL', 'FM', 'PT', 'PR', 'RE', 'RU', 'SA', 'SF', 'RS', 'SG', 'SK', 'SI', 'ZA', 'ES', 'LK', 'SX', 'VI', 'VI', 'SE', 'CH', 'TW', 'TJ', 'TH', 'TU', 'TN', 'TR', 'TM', 'VI', 'UA', 'GB', 'US', 'UY', 'UZ', 'VA', 'VN', 'GB', 'FM']);\r\n\r\nconst generateFourPattern = cacheCallback((length: number) => {\r\n  const out: Array<typeof digit | typeof spaceCharacter> = [];\r\n\r\n  for(let i = 0, k = 0; i < length;) {\r\n    if(k === 4) {\r\n      out.push(spaceCharacter);\r\n      k = 0;\r\n    } else {\r\n      out.push(digit);\r\n      ++i;\r\n      ++k;\r\n    }\r\n  }\r\n\r\n  return out;\r\n});\r\n\r\nfunction generateCardNumberPattern(card: string) {\r\n  const brand = detectCardBrand(card);\r\n  if(brand === 'amex') return sixteenPattern;\r\n  if(brand === 'diners14') return fifteenPattern;\r\n  const {minLength, maxLength} = CARD_BRANDS[brand];\r\n  const s = replaceNonNumber(card).length;\r\n  const d = Math.min(Math.max(minLength, s), maxLength);\r\n  return generateFourPattern(d);\r\n}\r\n\r\nconst cardFormattingPatterns = {\r\n  cardNumber: generateCardNumberPattern,\r\n  cardExpiry: () => [patternCharacters.month, patternCharacters.formattingCharacter('/'), digit, digit, yearOptionalPattern],\r\n  cardCvc: (card?: string) => cardFormattingPatterns.cardCvcFromBrand(detectCardBrand(card)),\r\n  cardCvcFromBrand: cacheCallback((brand: string) => {\r\n    const info = CARD_BRANDS[brand];\r\n    const {cvcMinLength, cvcMaxLength} = info;\r\n    const pattern = createArray(cvcMinLength || cvcMaxLength, digit);\r\n    if(cvcMinLength && cvcMinLength < cvcMaxLength) {\r\n      const i = cvcMaxLength - cvcMinLength;\r\n      const h = patternCharacters.optionalPattern(/\\d/);\r\n      if(i) {\r\n        pattern.push(...createArray(i, h));\r\n      }\r\n    }\r\n\r\n    return pattern;\r\n  }),\r\n  postalCodeFromCountry: cacheCallback((iso2: string) => {\r\n    switch(iso2) {\r\n      case 'US':\r\n        return createArray(5, digit);\r\n      case 'CA':\r\n        return IS_ANDROID ? null : [capitalCharacter, capitalCharacter, capitalCharacter, spaceCharacter, capitalCharacter, capitalCharacter, capitalCharacter];\r\n      default:\r\n        const optionalDigits = createArray(10, patternCharacters.optionalPattern(/\\d/));\r\n        if(requiredPostcodes.has(iso2)) {\r\n          optionalDigits[0] = digit;\r\n        }\r\n        return optionalDigits;\r\n    }\r\n  })\r\n};\r\n\r\nexport default cardFormattingPatterns;\r\n","import accumulate from \"../array/accumulate\";\r\nimport { PatternFunction } from \"./patternCharacters\";\r\n\r\nfunction accumulateLengths(strs: string[]) {\r\n  return accumulate(strs.map((str) => str.length), 0);\r\n}\r\n\r\nfunction formatValueByPattern(\r\n  getPattern: PatternFunction, \r\n  value: string, \r\n  options: Partial<{\r\n    selectionStart: number, \r\n    selectionEnd: number\r\n  }> = {}, \r\n  pushRest?: boolean\r\n) {\r\n  const pattern = getPattern(value);\r\n\r\n  if(!pattern) {\r\n    return {\r\n      value: value,\r\n      selection: null as typeof options,\r\n      autocorrectComplete: !!value\r\n    };\r\n  }\r\n\r\n  const length = pattern.length;\r\n  const c: string[] = [];\r\n  const s: string[] = [];\r\n\r\n  let l = 0;\r\n  let i = 0;\r\n  let f = options.selectionStart === 0 ? 0 : null;\r\n  let d = options.selectionEnd === 0 ? 0 : null;\r\n  const p = () => {\r\n    if(f === null && (i + 1) >= options.selectionStart) f = accumulateLengths(c) + (pushRest ? s.length : 0);\r\n    if(d === null && (i + 1) >= options.selectionEnd) d = accumulateLengths(c) + (pushRest ? s.length : 0);\r\n  };\r\n  const m = (e: number) => {\r\n    if(e > 0) {\r\n      p();\r\n      i += e;\r\n    }\r\n  };\r\n\r\n  for(; l < length;) {\r\n    const getCharacter = pattern[l];\r\n    const character = getCharacter(value.slice(i));\r\n    const {type, result, consumed} = character;\r\n    if(type === 'required') {\r\n      if(result) {\r\n        c.push(...s, result);\r\n        s.length = 0;\r\n        ++l;\r\n\r\n        if(character.partial) {\r\n          m(value.length - i);\r\n          break;\r\n        }\r\n\r\n        m(consumed);\r\n      } else {\r\n        if(!consumed) {\r\n          break;\r\n        }\r\n\r\n        m(1);\r\n      }\r\n    } else if(type === 'optional') {\r\n      if(result) {\r\n        c.push(...s, result);\r\n        s.length = 0;\r\n        m(consumed);\r\n      }\r\n\r\n      ++l;\r\n    } else if(type === 'formatting') {\r\n      if(!pushRest && i >= value.length) {\r\n        break;\r\n      }\r\n\r\n      s.push(result);\r\n      ++l;\r\n      m(consumed);\r\n    }\r\n  }\r\n\r\n  if(pushRest) {\r\n    c.push(...s);\r\n  }\r\n\r\n  return {\r\n    value: c.join(''),\r\n    selection: {\r\n      selectionStart: f === null || value.length && options.selectionStart === value.length ? accumulateLengths(c) : f,\r\n      selectionEnd: d === null || value.length && options.selectionEnd === value.length ? accumulateLengths(c) : d\r\n    },\r\n    autocorrectComplete: l === length\r\n  };\r\n}\r\n\r\nexport default formatValueByPattern;\r\n","import { CARD_BRANDS, detectCardBrand } from \"./cardBrands\";\r\nimport formatInputValueByPattern from './formatInputValueByPattern';\r\nimport NBSP from \"../string/nbsp\";\r\nimport replaceNonNumber from \"../string/replaceNonNumber\";\r\n\r\nexport type PatternValidationOptions = Partial<{\r\n  ignoreIncomplete: boolean\r\n}>;\r\n\r\nconst nbspRegExp = new RegExp(NBSP, 'g');\r\n\r\nfunction makeValidationError(code?: string) {\r\n  return code ? {\r\n    type: 'invalid',\r\n    code\r\n  } : null;\r\n}\r\n\r\n// Luhn algorithm\r\nfunction validateCompleteCardNumber(card: string) {\r\n  const t = '0'.charCodeAt(0);\r\n  const n = card.length % 2;\r\n  let a = 0;\r\n  for(let i = card.length - 1; i >= 0; --i) {\r\n    const c = n === (i % 2);\r\n    let o = card.charCodeAt(i) - t;\r\n    if(c) o *= 2;\r\n    if(o > 9) o -= 9;\r\n    a += o;\r\n  }\r\n  return !(a % 10);\r\n}\r\n\r\nfunction validateExpiry(year: number, month: number, options?: PatternValidationOptions) {\r\n  const date = new Date(Date.now());\r\n  const _year = year < 100 ? date.getFullYear() % 100 : date.getFullYear();\r\n  const nextMonth = date.getMonth() + 1;\r\n\r\n  if(isNaN(year) || isNaN(month)) {\r\n    return options?.ignoreIncomplete ? null : 'incomplete';\r\n  }\r\n\r\n  if((year - _year) < 0) {\r\n    return 'invalid_expiry_year_past';\r\n  }\r\n\r\n  if((year - _year) > 50) {\r\n    return 'invalid_expiry_year';\r\n  }\r\n\r\n  return !(year - _year) && month < nextMonth ? 'invalid_expiry_month_past' : null;\r\n}\r\n\r\nfunction getCardInfoByNumber(card: string) {\r\n  const sanitized = replaceNonNumber(card);\r\n  const brand = detectCardBrand(card);\r\n  return {\r\n    sanitized,\r\n    brand,\r\n    minLength: CARD_BRANDS[brand].minLength\r\n  };\r\n}\r\n\r\nfunction makeCardNumberError(str: string, length: number, ignoreIncomplete: boolean) {\r\n  if(str.length >= length) {\r\n    return validateCompleteCardNumber(str) || detectCardBrand(str) === 'mir' ? null : makeValidationError('invalid');\r\n  }\r\n\r\n  return ignoreIncomplete ? null : makeValidationError('incomplete');\r\n}\r\n\r\nexport function validateCardNumber(str: string, options: PatternValidationOptions = {}) {\r\n  const {sanitized, minLength} = getCardInfoByNumber(str);\r\n  return makeCardNumberError(sanitized, minLength, options.ignoreIncomplete);\r\n}\r\n\r\nexport function validateCardExpiry(str: string, options: PatternValidationOptions = {}) {\r\n  const sanitized = str.replace(nbspRegExp, '').split(/ ?\\/ ?/);\r\n  const [monthStr, yearStr = ''] = sanitized;\r\n  const [month, year] = [monthStr, yearStr].map((str) => +str);\r\n  const s = yearStr.length === 2 ? year % 100 : year;\r\n  return yearStr.length < 2 || yearStr.length === 3 ? (options.ignoreIncomplete ? null : makeValidationError('incomplete')) : makeValidationError(validateExpiry(s, month, options));\r\n}\r\n\r\nexport function validateAnyIncomplete(formatted: ReturnType<typeof formatInputValueByPattern>, str: string, options: PatternValidationOptions = {}) {\r\n  return formatted.meta.autocorrectComplete || options.ignoreIncomplete ? null : makeValidationError('incomplete');\r\n}\r\n","const NBSP = '';\r\nexport default NBSP;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \".\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport { TelegramWebviewEventCallback } from \"../../types\";\r\n\r\nconst weakMap: WeakMap<Window, TelegramWebviewEventCallback> = new WeakMap();\r\nwindow.addEventListener('message', (e) => {\r\n  const callback = weakMap.get(e.source as Window);\r\n  if(!callback) {\r\n    return;\r\n  }\r\n  \r\n  callback(JSON.parse(e.data));\r\n});\r\n\r\nexport function createVerificationIframe(url: string, callback: TelegramWebviewEventCallback) {\r\n  const iframe = document.createElement('iframe');\r\n  // iframe.title = 'Complete Payment';\r\n  iframe.allow = 'payment';\r\n  // iframe.setAttribute('sandbox', 'allow-forms allow-scripts allow-same-origin allow-top-navigation allow-modals');\r\n  iframe.setAttribute('sandbox', 'allow-forms allow-scripts allow-same-origin allow-modals');\r\n  iframe.classList.add('payment-verification');\r\n  iframe.src = url;\r\n\r\n  iframe.addEventListener('load', () => {\r\n    weakMap.set(iframe.contentWindow, callback);\r\n  }, {once: true});\r\n\r\n  return iframe;\r\n}\r\n\r\nexport default class PopupPaymentVerification extends PopupElement<{\r\n  finish: () => void\r\n}> {\r\n  constructor(private url: string) {\r\n    super('popup-payment popup-payment-verification', {\r\n      closable: true,\r\n      overlayClosable: true,\r\n      body: true,\r\n      title: 'Checkout.WebConfirmation.Title'\r\n    });\r\n\r\n    this.d();\r\n  }\r\n\r\n  private d() {\r\n    const iframe = createVerificationIframe(this.url, (event) => {\r\n      if(event.eventType !== 'web_app_open_tg_link') {\r\n        return;\r\n      }\r\n\r\n      this.dispatchEvent('finish');\r\n      this.hide();\r\n      appImManager.openUrl('https://t.me' + event.eventData.path_full);\r\n    });\r\n\r\n    this.body.append(iframe);\r\n    this.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \".\";\r\nimport cardFormattingPatterns from \"../../helpers/cards/cardFormattingPatterns\";\r\nimport { detectUnifiedCardBrand } from \"../../helpers/cards/cardBrands\";\r\nimport formatInputValueByPattern from \"../../helpers/cards/formatInputValueByPattern\";\r\nimport { validateAnyIncomplete, validateCardExpiry, validateCardNumber } from \"../../helpers/cards/validateCard\";\r\nimport placeCaretAtEnd from \"../../helpers/dom/placeCaretAtEnd\";\r\nimport { renderImageFromUrlPromise } from \"../../helpers/dom/renderImageFromUrl\";\r\nimport noop from \"../../helpers/noop\";\r\nimport { PaymentsPaymentForm } from \"../../layer\";\r\nimport { LangPackKey, _i18n } from \"../../lib/langPack\";\r\nimport { TelegramWebviewEvent } from \"../../types\";\r\nimport CheckboxField from \"../checkboxField\";\r\nimport confirmationPopup from \"../confirmationPopup\";\r\nimport CountryInputField from \"../countryInputField\";\r\nimport InputField, { InputFieldOptions, InputState } from \"../inputField\";\r\nimport Row from \"../row\";\r\nimport { SettingSection } from \"../sidebarLeft\";\r\nimport { getPaymentBrandIconPath, PaymentButton, PaymentsCredentialsToken } from \"./payment\";\r\nimport { createVerificationIframe } from \"./paymentVerification\";\r\n// import { putPreloader } from \"../putPreloader\";\r\n\r\nexport type PaymentCardDetails = {\r\n  cardNumber: string;\r\n  cardholderName: string;\r\n  expiryFull: string;\r\n  expiryMonth: string;\r\n  expiryYear: string;\r\n  cvc: string;\r\n  country: string;\r\n  zip: string;\r\n  save?: boolean;\r\n};\r\n\r\nexport type PaymentCardDetailsShort = {\r\n  title: string,\r\n  save?: boolean;\r\n  icon?: string;\r\n};\r\n\r\nexport type PaymentCardDetailsResult = PaymentCardDetails | PaymentCardDetailsShort;\r\n\r\nexport class InputFieldCorrected extends InputField {\r\n  private lastKeyDown: string;\r\n  private lastTransformed: ReturnType<typeof formatInputValueByPattern>;\r\n\r\n  constructor(public options: InputFieldOptions & {\r\n    formatMethod: typeof cardFormattingPatterns['cardNumber'],\r\n    validateMethod?: typeof validateCardNumber,\r\n    errorKeys?: {[code: string]: LangPackKey},\r\n    optional?: boolean,\r\n    onChange?: (transformed: InputFieldCorrected['lastTransformed']) => void,\r\n    onKeyDown?: (e: KeyboardEvent) => void\r\n  }) {\r\n    super(options);\r\n\r\n    // const handleIncomplete = (t?: any) => {\r\n    //   if(\r\n    //     (!lastTransformed.value && t) || \r\n    //     lastTransformed.meta.autocorrectComplete || \r\n    //     lastTransformed.meta.error || \r\n    //     optional\r\n    //   ) {\r\n    //     return;\r\n    //   }\r\n      \r\n      \r\n    // };\r\n\r\n    this.input.addEventListener('keydown', this.onKeyDown);\r\n    this.input.addEventListener('input', this.onInput);\r\n    this.input.addEventListener('blur', this.onBlur);\r\n  }\r\n\r\n  private onKeyDown = (e: KeyboardEvent) => {\r\n    this.lastKeyDown = e.key;\r\n    this.options.onKeyDown?.(e);\r\n  };\r\n\r\n  private onInput = () => {\r\n    const value = this.value;\r\n    const deleting = this.lastKeyDown === 'Backspace' && (((this.lastTransformed && this.lastTransformed.value.length) || 0) - value.length) === 1;\r\n    const result = this.lastTransformed = formatInputValueByPattern({\r\n      value: value, \r\n      getPattern: this.options.formatMethod, \r\n      deleting,\r\n      input: this.input\r\n    });\r\n\r\n    const transformedValue = result.value;\r\n    if(transformedValue !== value) {\r\n      this.setValueSilently(transformedValue);\r\n\r\n      if(result.selection) {\r\n        (this.input as HTMLInputElement).selectionStart = result.selection.selectionStart;\r\n        (this.input as HTMLInputElement).selectionEnd = result.selection.selectionEnd;\r\n      }\r\n    }\r\n\r\n    this.validateNew(transformedValue, {ignoreIncomplete: true/* !result.meta.autocorrectComplete */});\r\n\r\n    this.options.onChange?.(result);\r\n  };\r\n\r\n  private onBlur = () => {\r\n    const value = this.lastTransformed?.value;\r\n    if(value) {\r\n      this.validateNew(value);\r\n    }\r\n  };\r\n\r\n  public update() {\r\n    this.onInput();\r\n  }\r\n\r\n  public validate = () => {\r\n    return this.validateNew();\r\n  };\r\n\r\n  public validateNew(\r\n    value = this.lastTransformed?.value ?? '', \r\n    t: any = {}, \r\n    justReturn?: boolean\r\n  ) {\r\n    let result: ReturnType<InputFieldCorrected['options']['validateMethod']>;\r\n    if(this.options.validateMethod) {\r\n      result = this.options.validateMethod?.(value, t);\r\n    } else {\r\n      result = validateAnyIncomplete(this.lastTransformed, value, t);\r\n    }\r\n\r\n    if(result?.code) {\r\n      const langPackKey: LangPackKey = this.options.errorKeys?.[result.code];\r\n      !justReturn && this.setState(InputState.Error, langPackKey);\r\n      return false;\r\n    }\r\n    \r\n    !justReturn && this.setState(InputState.Neutral);\r\n    return true;\r\n  }\r\n}\r\n\r\nexport function handleInputFieldsOnChange(inputFields: (CountryInputField | InputField | InputFieldCorrected)[], _onChange: (valid: boolean) => void) {\r\n  const onChange = () => {\r\n    const valid = inputFields.every((inputField) => {\r\n      return 'validateNew' in inputField ? inputField.validateNew(undefined, undefined, true) : inputField.isValid();\r\n    });\r\n\r\n    _onChange(valid);\r\n  };\r\n\r\n  inputFields.forEach((inputField) => {\r\n    if(inputField instanceof InputFieldCorrected) {\r\n      const original = inputField.options.onChange;\r\n      inputField.options.onChange = (...args: any[]) => {\r\n        // @ts-ignore\r\n        original?.(...args);\r\n        onChange();\r\n      };\r\n\r\n      if('update' in inputField) {\r\n        inputField.update();\r\n      }\r\n    } else {\r\n      inputField.input.addEventListener('input', onChange);\r\n    }\r\n  });\r\n\r\n  return {validate: onChange};\r\n}\r\n\r\nexport function createCountryZipFields(country?: boolean, zip?: boolean) {\r\n  let countryInputField: CountryInputField, postcodeInputField: InputFieldCorrected;\r\n  if(country || zip) {\r\n    if(country) countryInputField = new CountryInputField({\r\n      noPhoneCodes: true,\r\n      onCountryChange: () => {\r\n        postcodeInputField?.update();\r\n      },\r\n      required: true,\r\n      autocomplete: 'country',\r\n    });\r\n    if(zip) postcodeInputField = new InputFieldCorrected({\r\n      label: 'PaymentShippingZipPlaceholder', \r\n      plainText: true, \r\n      inputMode: 'numeric',\r\n      autocomplete: 'postal-code',\r\n      formatMethod: (/* ...args */) => {\r\n        const {country} = countryInputField.getSelected();\r\n        const iso2 = country?.iso2;\r\n        return cardFormattingPatterns.postalCodeFromCountry(iso2 && iso2.toUpperCase());\r\n      }\r\n    });\r\n  }\r\n\r\n  return {countryInputField, postcodeInputField};\r\n}\r\n\r\nexport type PaymentsNativeProvider = 'stripe' | 'smartglocal';\r\nexport type PaymentsNativeParams = {\r\n  need_country?: boolean,\r\n  need_zip?: boolean,\r\n  need_cardholder_name?: boolean,\r\n  publishable_key?: string, // stripe\r\n  public_token?: string, // smartglocal\r\n  gpay_params: string,\r\n};\r\nconst SUPPORTED_NATIVE_PROVIDERS: Set<PaymentsNativeProvider> = new Set(['stripe', 'smartglocal']);\r\n\r\nexport default class PopupPaymentCard extends PopupElement<{\r\n  finish: (obj: {token: any, card: PaymentCardDetailsResult}) => void\r\n}> {\r\n  constructor(private paymentForm: PaymentsPaymentForm, private savedCard?: PaymentCardDetails) {\r\n    super('popup-payment popup-payment-card', {\r\n      closable: true,\r\n      overlayClosable: true,\r\n      body: true,\r\n      scrollable: SUPPORTED_NATIVE_PROVIDERS.has(paymentForm.native_provider as PaymentsNativeProvider),\r\n      title: 'PaymentCardInfo'\r\n    });\r\n\r\n    if(SUPPORTED_NATIVE_PROVIDERS.has(paymentForm.native_provider as PaymentsNativeProvider)) {\r\n      this.d();\r\n    } else {\r\n      const iframe = createVerificationIframe(paymentForm.url, (event) => {\r\n        if(event.eventType !== 'payment_form_submit') {\r\n          return;\r\n        }\r\n\r\n        const data = event.eventData;\r\n\r\n        const cardOut = {title: data.title, save: false} as any as PaymentCardDetails;\r\n        this.dispatchEvent('finish', {\r\n          token: data.credentials,\r\n          card: cardOut\r\n        });\r\n\r\n        this.hide();\r\n\r\n        if(paymentForm.pFlags.can_save_credentials) {\r\n          confirmationPopup({\r\n            titleLangKey: 'PaymentCardSavePaymentInformation',\r\n            descriptionLangKey: 'PaymentCardSavePaymentInformationInfoLine1',\r\n            button: {\r\n              langKey: 'Save'\r\n            }\r\n          }).then(() => {\r\n            cardOut.save = true;\r\n          }, noop);\r\n        }\r\n      });\r\n\r\n      // putPreloader(this.body, true);\r\n      this.body.append(iframe);\r\n      this.show();\r\n    }\r\n  }\r\n\r\n  private d() {\r\n    const savedCard = this.savedCard;\r\n    const cardSection = new SettingSection({name: 'PaymentInfo.Card.Title', noDelimiter: true, noShadow: true});\r\n\r\n    const nativeParams: PaymentsNativeParams = JSON.parse(this.paymentForm.native_params.data);\r\n\r\n    let lastBrand: string, brandIconTempId = 0, lastBrandImg: HTMLImageElement;\r\n    const setBrandIcon = (brand: string) => {\r\n      if(lastBrand === brand) {\r\n        return;\r\n      }\r\n\r\n      const tempId = ++brandIconTempId;\r\n      lastBrand = brand;\r\n\r\n      const path = getPaymentBrandIconPath(brand);\r\n      if(!path) {\r\n        if(lastBrandImg) {\r\n          lastBrandImg.remove();\r\n          lastBrandImg = undefined;\r\n        }\r\n\r\n        return;\r\n      }\r\n\r\n      const img = new Image();\r\n      img.classList.add('input-field-icon');\r\n      renderImageFromUrlPromise(img, path, false).then(() => {\r\n        if(brandIconTempId !== tempId) {\r\n          return;\r\n        }\r\n\r\n        if(lastBrandImg) {\r\n          lastBrandImg.replaceWith(img);\r\n        } else {\r\n          cardInputField.container.append(img);\r\n        }\r\n\r\n        lastBrandImg = img;\r\n      });\r\n    };\r\n    const cardInputField = new InputFieldCorrected({\r\n      label: 'PaymentCardNumber', \r\n      plainText: true, \r\n      inputMode: 'numeric',\r\n      autocomplete: 'cc-number',\r\n      formatMethod: cardFormattingPatterns.cardNumber,\r\n      validateMethod: validateCardNumber,\r\n      errorKeys: {\r\n        invalid: 'PaymentCard.Error.Invalid',\r\n        incomplete: 'PaymentCard.Error.Incomplete'\r\n      },\r\n      onChange: (transformed) => {\r\n        setBrandIcon(detectUnifiedCardBrand(transformed.value));\r\n        cvcInputField.update(); // format cvc\r\n      }\r\n    });\r\n\r\n    let nameInputField: InputField;\r\n    if(nativeParams.need_cardholder_name) nameInputField = new InputField({\r\n      label: 'Checkout.NewCard.CardholderNamePlaceholder', \r\n      maxLength: 255,\r\n      required: true,\r\n      autocomplete: 'cc-name',\r\n    });\r\n\r\n    const expireInputField = new InputFieldCorrected({\r\n      label: 'SecureId.Identity.Placeholder.ExpiryDate', \r\n      plainText: true, \r\n      inputMode: 'numeric',\r\n      autocomplete: 'cc-exp',\r\n      formatMethod: cardFormattingPatterns.cardExpiry,\r\n      validateMethod: validateCardExpiry\r\n    });\r\n\r\n    const cvcInputField = new InputFieldCorrected({\r\n      labelText: 'CVC', \r\n      plainText: true, \r\n      inputMode: 'numeric',\r\n      autocomplete: 'cc-csc',\r\n      formatMethod: () => cardFormattingPatterns.cardCvc(cardInputField.value),\r\n      // validateMethod: (...args) => _5AH3.a.cardCvc(cardInputField.value)(...args)\r\n    });\r\n\r\n    const switchFocusOrder: (InputFieldCorrected | InputField)[] = [\r\n      cardInputField, \r\n      expireInputField, \r\n      cvcInputField, \r\n      nameInputField\r\n    ].filter(Boolean);\r\n    switchFocusOrder.forEach((inputField) => {\r\n      const onKeyDown = (e: KeyboardEvent) => {\r\n        if(!inputField.value && e.key === 'Backspace') {\r\n          const previousInputField = switchFocusOrder[switchFocusOrder.indexOf(inputField) - 1];\r\n          if(previousInputField) {\r\n            // previousInputField.value = previousInputField.value.slice(0, -1);\r\n            placeCaretAtEnd(previousInputField.input, true);\r\n          }\r\n        }\r\n      };\r\n\r\n      if(inputField instanceof InputFieldCorrected) {\r\n        inputField.options.onKeyDown = onKeyDown;\r\n\r\n        const original = inputField.options.onChange;\r\n        inputField.options.onChange = (transformed) => {\r\n          original?.(transformed);\r\n  \r\n          if(document.activeElement === inputField.input && transformed.meta.autocorrectComplete) {\r\n            for(let i = switchFocusOrder.indexOf(inputField), length = switchFocusOrder.length; i < length; ++i) {\r\n              const nextInputField = switchFocusOrder[i];\r\n              if(\r\n                nextInputField instanceof InputFieldCorrected ? \r\n                !nextInputField.validateNew(undefined, undefined, true) : \r\n                !nextInputField.value\r\n              ) {\r\n                placeCaretAtEnd(nextInputField.input, true);\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        };\r\n      } else {\r\n        inputField.input.addEventListener('keydown', onKeyDown);\r\n      }\r\n    });\r\n\r\n    const inputFieldsRow = document.createElement('div');\r\n    inputFieldsRow.classList.add('input-fields-row');\r\n    inputFieldsRow.append(expireInputField.container, cvcInputField.container);\r\n    \r\n    cardSection.content.append(...[\r\n      cardInputField.container, \r\n      inputFieldsRow,\r\n      nameInputField?.container\r\n    ].filter(Boolean));\r\n    \r\n    let billingSection: SettingSection;\r\n    let saveCheckboxField: CheckboxField;\r\n    const {countryInputField, postcodeInputField} = createCountryZipFields(nativeParams.need_country, nativeParams.need_zip);\r\n    if(nativeParams.need_country || nativeParams.need_zip) {\r\n      billingSection = new SettingSection({name: 'PaymentInfo.Billing.Title', noDelimiter: true, noShadow: true});\r\n\r\n      // const inputFieldsRow2 = inputFieldsRow.cloneNode() as HTMLElement;\r\n      // inputFieldsRow2.append(countryInputField.container, postcodeInputField.container);\r\n      // billingSection.content.append(inputFieldsRow2);\r\n      billingSection.content.append(...[countryInputField, postcodeInputField].filter(Boolean).map((i) => i.container));\r\n    }\r\n\r\n    const canSave = !!this.paymentForm.pFlags.can_save_credentials;\r\n    saveCheckboxField = new CheckboxField({\r\n      text: 'PaymentCardSavePaymentInformation', \r\n      checked: !!canSave\r\n    });\r\n    const saveRow = new Row({\r\n      checkboxField: saveCheckboxField,\r\n      subtitleLangKey: canSave ? 'PaymentCardSavePaymentInformationInfoLine1' : 'Checkout.2FA.Text',\r\n      noCheckboxSubtitle: true\r\n    });\r\n\r\n    if(!canSave) {\r\n      saveRow.container.classList.add('is-disabled');\r\n    }\r\n\r\n    (billingSection || cardSection).content.append(saveRow.container);\r\n\r\n    this.scrollable.append(...[cardSection, billingSection].filter(Boolean).map((s) => s.container));\r\n\r\n    const payButton = PaymentButton({\r\n      key: 'PaymentInfo.Done',\r\n      onClick: async() => {\r\n        const data: PaymentCardDetails = {\r\n          cardNumber: cardInputField.value,\r\n          expiryFull: expireInputField.value,\r\n          expiryMonth: expireInputField.value.split('/')[0],\r\n          expiryYear: expireInputField.value.split('/')[1],\r\n          cvc: cvcInputField.value,\r\n\r\n          cardholderName: nameInputField?.value,\r\n          country: countryInputField?.value,\r\n          zip: postcodeInputField?.value,\r\n\r\n          save: saveCheckboxField?.checked\r\n        };\r\n\r\n        const nativeProvider: PaymentsNativeProvider = this.paymentForm.native_provider as any;\r\n        let out: PaymentsCredentialsToken;\r\n        if(nativeProvider === 'stripe') {\r\n          const url = new URL('https://api.stripe.com/v1/tokens');\r\n          url.search = new URLSearchParams({\r\n            'card[number]': data.cardNumber,\r\n            'card[exp_month]': data.expiryMonth,\r\n            'card[exp_year]': data.expiryYear,\r\n            'card[cvc]': data.cvc,\r\n            'card[address_zip]': data.zip,\r\n            'card[address_country]': data.country,\r\n            'card[name]': data.cardholderName,\r\n          }).toString();\r\n          \r\n          const response = await fetch(url.toString(), {\r\n            method: 'POST',\r\n            credentials: 'same-origin',\r\n            headers: {\r\n              'Content-Type': 'application/x-www-form-urlencoded',\r\n              Authorization: `Bearer ${nativeParams.publishable_key}`,\r\n            },\r\n          });\r\n  \r\n          out = await response.json();\r\n        } else if(nativeProvider === 'smartglocal') {\r\n          const params = {\r\n            card: {\r\n              number: data.cardNumber.replace(/[^\\d]+/g, ''),\r\n              expiration_month: data.expiryMonth,\r\n              expiration_year: data.expiryYear,\r\n              security_code: data.cvc.replace(/[^\\d]+/g, ''),\r\n            },\r\n          };\r\n\r\n          const url = /* DEBUG_PAYMENT_SMART_GLOCAL */false\r\n            ? 'https://tgb-playground.smart-glocal.com/cds/v1/tokenize/card'\r\n            : 'https://tgb.smart-glocal.com/cds/v1/tokenize/card';\r\n\r\n          const response = await fetch(url, {\r\n            method: 'POST',\r\n            headers: {\r\n              Accept: 'application/json',\r\n              'Content-Type': 'application/json',\r\n              'X-PUBLIC-TOKEN': nativeParams.public_token,\r\n            },\r\n            body: JSON.stringify(params),\r\n          });\r\n\r\n          const json: { // smartglocal\r\n            data: {\r\n              info: {\r\n                card_network: string,\r\n                card_type: string,\r\n                masked_card_number: string\r\n              },\r\n              token: string\r\n            },\r\n            status: 'ok'\r\n          } = await response.json();\r\n\r\n          out = {type: 'card', token: json.data.token}\r\n        }\r\n        \r\n        this.dispatchEvent('finish', {token: out, card: data});\r\n        this.hide();\r\n      }\r\n    });\r\n\r\n    const inputFields = ([\r\n      cardInputField,\r\n      nameInputField,\r\n      expireInputField,\r\n      cvcInputField,\r\n      countryInputField,\r\n      postcodeInputField\r\n    ] as const).filter(Boolean);\r\n    handleInputFieldsOnChange(inputFields, (valid) => {\r\n      payButton.disabled = !valid;\r\n      // payButton.classList.toggle('btn-disabled', !valid);\r\n    });\r\n\r\n    if(savedCard) {\r\n      cardInputField.value = savedCard.cardNumber;\r\n      expireInputField.value = savedCard.expiryFull;\r\n      cvcInputField.value = savedCard.cvc;\r\n      nameInputField && (nameInputField.value = savedCard.cardholderName);\r\n      countryInputField && (countryInputField.value = savedCard.country);\r\n      postcodeInputField && (postcodeInputField.value = savedCard.zip);\r\n    }\r\n\r\n    this.body.append(this.btnConfirmOnEnter = payButton);\r\n\r\n    this.show();\r\n\r\n    if(!cardInputField.validateNew(undefined, undefined, true)) {\r\n      placeCaretAtEnd(cardInputField.input);\r\n    }\r\n  }\r\n}\r\n","import formatValueByPattern from \"./formatValueByPattern\";\r\n\r\nexport default function formatInputValueByPattern(options: {\r\n  value: string, \r\n  getPattern: Parameters<typeof formatValueByPattern>[0], \r\n  deleting?: boolean,\r\n  input?: HTMLElement\r\n}) {\r\n  const {value: originalValue, getPattern, deleting, input} = options;\r\n  const pushRest = !deleting && !!originalValue.length;\r\n  const result = formatValueByPattern(getPattern, originalValue, {\r\n    selectionStart: input ? (input as HTMLInputElement).selectionStart : 0,\r\n    selectionEnd: input ? (input as HTMLInputElement).selectionEnd : 0\r\n  }, pushRest)\r\n  const {value, selection} = result;\r\n\r\n  return {\r\n    value,\r\n    meta: {\r\n      autocorrectComplete: result.autocorrectComplete,\r\n      empty: !value\r\n    },\r\n    selection\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \".\";\r\nimport placeCaretAtEnd from \"../../helpers/dom/placeCaretAtEnd\";\r\nimport { AccountPassword, AccountTmpPassword } from \"../../layer\";\r\nimport { ApiError } from \"../../lib/mtproto/apiManager\";\r\nimport { InputState } from \"../inputField\";\r\nimport PasswordInputField from \"../passwordInputField\";\r\nimport { SettingSection } from \"../sidebarLeft\";\r\nimport { PaymentButton } from \"./payment\";\r\n\r\nexport default class PopupPaymentCardConfirmation extends PopupElement<{\r\n  finish: (tmpPassword: AccountTmpPassword) => void\r\n}> {\r\n  constructor(card: string, passwordState: AccountPassword) {\r\n    super('popup-payment popup-payment-card-confirmation', {\r\n      closable: true,\r\n      overlayClosable: true,\r\n      body: true,\r\n      scrollable: true,\r\n      title: 'Checkout.PasswordEntry.Title'\r\n    });\r\n\r\n    const section = new SettingSection({noDelimiter: true, noShadow: true, caption: 'Checkout.PasswordEntry.Text', captionArgs: [card]});\r\n    const passwordInputField = new PasswordInputField({labelText: passwordState.hint});\r\n    section.content.append(passwordInputField.container);\r\n    this.scrollable.append(section.container);\r\n\r\n    const onInput = () => {\r\n      payButton.disabled = !passwordInputField.value;\r\n      passwordInputField.setState(InputState.Neutral);\r\n    };\r\n\r\n    passwordInputField.input.addEventListener('input', onInput);\r\n\r\n    const payButton = PaymentButton({\r\n      key: 'Checkout.PasswordEntry.Pay',\r\n      onClick: async() => {\r\n        try {\r\n          const inputCheckPassword = await this.managers.passwordManager.getInputCheckPassword(passwordInputField.value, passwordState);\r\n          const tmpPassword = await this.managers.apiManager.invokeApi('account.getTmpPassword', {\r\n            password: inputCheckPassword,\r\n            period: 60\r\n          });\r\n\r\n          this.dispatchEvent('finish', tmpPassword);\r\n          this.hide();\r\n        } catch(err) {\r\n          if((err as ApiError).type === 'PASSWORD_HASH_INVALID') {\r\n            (err as ApiError).handled = true;\r\n            passwordInputField.setError('PASSWORD_HASH_INVALID');\r\n          }\r\n\r\n          throw err;\r\n        }\r\n      }\r\n    });\r\n    this.body.append(this.btnConfirmOnEnter = payButton);\r\n\r\n    onInput();\r\n\r\n    this.show();\r\n\r\n    placeCaretAtEnd(passwordInputField.input);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \".\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport placeCaretAtEnd from \"../../helpers/dom/placeCaretAtEnd\";\r\nimport toggleDisability from \"../../helpers/dom/toggleDisability\";\r\nimport { Message, PaymentRequestedInfo, PaymentsPaymentForm, PaymentsValidatedRequestedInfo } from \"../../layer\";\r\nimport getServerMessageId from \"../../lib/appManagers/utils/messageId/getServerMessageId\";\r\nimport { ApiError } from \"../../lib/mtproto/apiManager\";\r\nimport matchEmail from \"../../lib/richTextProcessor/matchEmail\";\r\nimport Button from \"../button\";\r\nimport CheckboxField from \"../checkboxField\";\r\nimport CountryInputField from \"../countryInputField\";\r\nimport InputField from \"../inputField\";\r\nimport Row from \"../row\";\r\nimport { SettingSection } from \"../sidebarLeft\";\r\nimport TelInputField from \"../telInputField\";\r\nimport { PaymentButton } from \"./payment\";\r\nimport { createCountryZipFields, handleInputFieldsOnChange, InputFieldCorrected } from \"./paymentCard\";\r\n\r\nexport type PaymentShippingAddress = PaymentRequestedInfo;\r\n\r\ntype ShippingFocusField = 'name' | 'email' | 'phone';\r\n\r\nexport default class PopupPaymentShipping extends PopupElement<{\r\n  finish: (o: {shippingAddress: PaymentShippingAddress, requestedInfo: PaymentsValidatedRequestedInfo}) => void\r\n}> {\r\n  constructor(\r\n    private paymentForm: PaymentsPaymentForm, \r\n    private message: Message.message,\r\n    private focus?: ShippingFocusField\r\n  ) {\r\n    super('popup-payment popup-payment-shipping', {\r\n      closable: true,\r\n      overlayClosable: true,\r\n      body: true,\r\n      scrollable: true,\r\n      title: 'PaymentShippingInfo'\r\n    });\r\n\r\n    this.d();\r\n  }\r\n\r\n  private d() {\r\n    const paymentForm = this.paymentForm;\r\n    const invoice = paymentForm.invoice;\r\n    const savedInfo = this.paymentForm.saved_info;\r\n\r\n    let addressSection: SettingSection, \r\n      address1InputField: InputField, \r\n      address2InputField: InputField, \r\n      cityInputField: InputField, \r\n      stateInputField: InputField,\r\n      countryInputField: CountryInputField,\r\n      postcodeInputField: InputFieldCorrected;\r\n    if(invoice.pFlags.shipping_address_requested) {\r\n      addressSection = new SettingSection({name: 'PaymentShippingAddress', noDelimiter: true, noShadow: true});\r\n      address1InputField = new InputField({label: 'PaymentShippingAddress1Placeholder', maxLength: 64, required: true});\r\n      address2InputField = new InputField({label: 'PaymentShippingAddress2Placeholder', maxLength: 64});\r\n      cityInputField = new InputField({label: 'PaymentShippingCityPlaceholder', maxLength: 64, required: true});\r\n      stateInputField = new InputField({label: 'PaymentShippingStatePlaceholder', maxLength: 64});\r\n      const res = createCountryZipFields(true, true);\r\n      countryInputField = res.countryInputField;\r\n      postcodeInputField = res.postcodeInputField;\r\n\r\n      addressSection.content.append(...[\r\n        address1InputField,\r\n        address2InputField,\r\n        cityInputField,\r\n        stateInputField,\r\n        countryInputField,\r\n        postcodeInputField\r\n      ].filter(Boolean).map((inputField) => inputField.container));\r\n    }\r\n\r\n    let receiverSection: SettingSection;\r\n    let nameInputField: InputField, emailInputField: InputField, telInputField: TelInputField;\r\n    if([invoice.pFlags.name_requested, invoice.pFlags.email_requested, invoice.pFlags.phone_requested].includes(true)) {\r\n      receiverSection = new SettingSection({name: 'PaymentShippingReceiver', noDelimiter: true, noShadow: true});\r\n\r\n      const validateEmail = () => {\r\n        const value = emailInputField.value;\r\n        const match = matchEmail(value);\r\n        if(!match || match[0].length !== value.length) {\r\n          return false;\r\n        }\r\n\r\n        return true;\r\n      };\r\n\r\n      const validatePhone = () => {\r\n        return !!telInputField.value.match(/\\d/);\r\n      };\r\n\r\n      if(invoice.pFlags.name_requested) nameInputField = new InputField({label: 'PaymentShippingName', maxLength: 256, required: true});\r\n      if(invoice.pFlags.email_requested) emailInputField = new InputField({label: 'PaymentShippingEmailPlaceholder', maxLength: 64, required: true, validate: validateEmail});\r\n      if(invoice.pFlags.phone_requested) telInputField = new TelInputField({required: true, validate: validatePhone});\r\n\r\n      receiverSection.content.append(...[\r\n        nameInputField,\r\n        emailInputField,\r\n        telInputField,\r\n      ].filter(Boolean).map((inputField) => inputField.container));\r\n    }\r\n\r\n    const saveCheckboxField = new CheckboxField({\r\n      text: 'PaymentShippingSave', \r\n      checked: true\r\n    });\r\n    const saveRow = new Row({\r\n      checkboxField: saveCheckboxField,\r\n      subtitleLangKey: 'PaymentShippingSaveInfo',\r\n      noCheckboxSubtitle: true\r\n    });\r\n\r\n    (receiverSection || addressSection).content.append(saveRow.container);\r\n\r\n    this.scrollable.append(...[addressSection, receiverSection].filter(Boolean).map((section) => section.container));\r\n\r\n    const payButton = PaymentButton({\r\n      key: 'PaymentInfo.Done',\r\n      onClick: async() => {\r\n        const selectedCountry = countryInputField && countryInputField.getSelected().country;\r\n        const data: PaymentShippingAddress = {\r\n          _: 'paymentRequestedInfo',\r\n          shipping_address: selectedCountry && {\r\n            _: 'postAddress',\r\n            street_line1: address1InputField.value,\r\n            street_line2: address2InputField.value,\r\n            city: cityInputField.value,\r\n            state: stateInputField.value,\r\n            // country: countryInputField.value,\r\n            country_iso2: selectedCountry?.iso2,\r\n            post_code: postcodeInputField.value,\r\n          },\r\n          name: nameInputField?.value,\r\n          email: emailInputField?.value,\r\n          phone: telInputField?.value\r\n        };\r\n  \r\n        try {\r\n          const requestedInfo = await this.managers.appPaymentsManager.validateRequestedInfo(this.message.peerId, this.message.mid, data, saveCheckboxField?.checked);\r\n    \r\n          this.dispatchEvent('finish', {\r\n            shippingAddress: data,\r\n            requestedInfo\r\n          });\r\n  \r\n          this.hide();\r\n        } catch(err: any) {\r\n          const errorMap: {[err: string]: InputField} = {\r\n            ADDRESS_STREET_LINE1_INVALID: address1InputField,\r\n            ADDRESS_STREET_LINE2_INVALID: address2InputField,\r\n            ADDRESS_COUNTRY_INVALID: countryInputField,\r\n            ADDRESS_CITY_INVALID: cityInputField,\r\n            ADDRESS_STATE_INVALID: stateInputField,\r\n            ADDRESS_POSTCODE_INVALID: postcodeInputField,\r\n\r\n            REQ_INFO_NAME_INVALID: nameInputField,\r\n            REQ_INFO_EMAIL_INVALID: emailInputField,\r\n            REQ_INFO_PHONE_INVALID: telInputField\r\n          };\r\n          \r\n          const inputField = errorMap[(err as ApiError).type];\r\n          if(inputField) {\r\n            inputField.setError();\r\n            (err as any).handled = true;\r\n          }\r\n          \r\n          throw err;\r\n        }\r\n      }\r\n    });\r\n    this.body.append(this.btnConfirmOnEnter = payButton);\r\n\r\n    if(savedInfo) {\r\n      const shippingAddress = savedInfo.shipping_address;\r\n      if(shippingAddress) {\r\n        address1InputField.value = shippingAddress.street_line1;\r\n        address2InputField.value = shippingAddress.street_line2;\r\n        cityInputField.value = shippingAddress.city;\r\n        stateInputField.value = shippingAddress.state;\r\n        countryInputField.selectCountryByIso2(shippingAddress.country_iso2);\r\n        postcodeInputField.value = shippingAddress.post_code;\r\n      }\r\n\r\n      savedInfo.name && nameInputField && (nameInputField.value = savedInfo.name);\r\n      savedInfo.email && emailInputField && (emailInputField.value = savedInfo.email);\r\n      savedInfo.phone && telInputField && (telInputField.value = savedInfo.phone);\r\n    }\r\n\r\n    const {validate} = handleInputFieldsOnChange([\r\n      address1InputField,\r\n      address2InputField,\r\n      cityInputField,\r\n      stateInputField,\r\n      countryInputField,\r\n      postcodeInputField,\r\n      nameInputField,\r\n      emailInputField,\r\n      telInputField\r\n    ].filter(Boolean), (valid) => {\r\n      payButton.disabled = !valid;\r\n    });\r\n\r\n    validate();\r\n\r\n    this.show();\r\n\r\n    let focusField: InputField;\r\n    if(this.focus) {\r\n      const focusMap: {[field in ShippingFocusField]?: InputField} = {\r\n        name: nameInputField,\r\n        email: emailInputField,\r\n        phone: telInputField\r\n      };\r\n      \r\n      focusField = focusMap[this.focus];\r\n    } else {\r\n      focusField = address1InputField;\r\n    }\r\n\r\n    if(focusField) {\r\n      placeCaretAtEnd(focusField.input);\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \".\";\r\nimport accumulate from \"../../helpers/array/accumulate\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport paymentsWrapCurrencyAmount from \"../../helpers/paymentsWrapCurrencyAmount\";\r\nimport { PaymentsPaymentForm, PaymentsValidatedRequestedInfo, ShippingOption } from \"../../layer\";\r\nimport Button from \"../button\";\r\nimport RadioField from \"../radioField\";\r\nimport Row, { RadioFormFromRows } from \"../row\";\r\nimport { SettingSection } from \"../sidebarLeft\";\r\nimport { PaymentButton } from \"./payment\";\r\n\r\nexport default class PopupPaymentShippingMethods extends PopupElement<{\r\n  finish: (shippingOption: ShippingOption) => void\r\n}> {\r\n  constructor(\r\n    private paymentForm: PaymentsPaymentForm, \r\n    private requestedInfo: PaymentsValidatedRequestedInfo, \r\n    private shippingOption: ShippingOption\r\n  ) {\r\n    super('popup-payment popup-payment-shipping-methods', {\r\n      closable: true,\r\n      overlayClosable: true,\r\n      body: true,\r\n      scrollable: true,\r\n      title: 'PaymentShippingMethod'\r\n    });\r\n\r\n    this.d();\r\n  }\r\n\r\n  private d() {\r\n    const section = new SettingSection({name: 'PaymentCheckoutShippingMethod', noDelimiter: true, noShadow: true});\r\n\r\n    const rows = this.requestedInfo.shipping_options.map((shippingOption) => {\r\n      return new Row({\r\n        radioField: new RadioField({\r\n          text: shippingOption.title,\r\n          name: 'shipping-method',\r\n          value: shippingOption.id\r\n        }),\r\n        subtitle: paymentsWrapCurrencyAmount(\r\n          accumulate(shippingOption.prices.map(({amount}) => +amount), 0), \r\n          this.paymentForm.invoice.currency\r\n        )\r\n      });\r\n    });\r\n\r\n    let lastShippingId: string;\r\n    const form = RadioFormFromRows(rows, (value) => {\r\n      lastShippingId = value;\r\n    });\r\n\r\n    if(this.shippingOption) {\r\n      rows.find((row) => row.radioField.input.value === this.shippingOption.id).radioField.checked = true;\r\n    } else {\r\n      rows[0].radioField.checked = true;\r\n    }\r\n\r\n    section.content.append(form);\r\n\r\n    this.scrollable.append(section.container);\r\n    \r\n    const payButton = PaymentButton({\r\n      key: 'PaymentInfo.Done',\r\n      onClick: () => {\r\n        this.dispatchEvent('finish', this.requestedInfo.shipping_options.find((option) => option.id === lastShippingId));\r\n        this.hide();\r\n      }\r\n    });\r\n    this.body.append(this.btnConfirmOnEnter = payButton);\r\n\r\n    this.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \".\";\r\nimport Currencies from \"../../config/currencies\";\r\nimport { FontFamily, FontSize } from \"../../config/font\";\r\nimport accumulate from \"../../helpers/array/accumulate\";\r\nimport getTextWidth from \"../../helpers/canvas/getTextWidth\";\r\nimport { detectUnifiedCardBrand } from \"../../helpers/cards/cardBrands\";\r\nimport { attachClickEvent, simulateClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport findUpAsChild from \"../../helpers/dom/findUpAsChild\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport loadScript from \"../../helpers/dom/loadScript\";\r\nimport placeCaretAtEnd from \"../../helpers/dom/placeCaretAtEnd\";\r\nimport { renderImageFromUrlPromise } from \"../../helpers/dom/renderImageFromUrl\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport toggleDisability from \"../../helpers/dom/toggleDisability\";\r\nimport { formatPhoneNumber } from \"../../helpers/formatPhoneNumber\";\r\nimport paymentsWrapCurrencyAmount from \"../../helpers/paymentsWrapCurrencyAmount\";\r\nimport ScrollSaver from \"../../helpers/scrollSaver\";\r\nimport tsNow from \"../../helpers/tsNow\";\r\nimport { AccountTmpPassword, InputPaymentCredentials, LabeledPrice, Message, MessageMedia, PaymentRequestedInfo, PaymentSavedCredentials, PaymentsPaymentForm, PaymentsPaymentReceipt, PaymentsValidatedRequestedInfo, PostAddress, ShippingOption } from \"../../layer\";\r\nimport I18n, { i18n, LangPackKey, _i18n } from \"../../lib/langPack\";\r\nimport { ApiError } from \"../../lib/mtproto/apiManager\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport AvatarElement from \"../avatar\";\r\nimport Button from \"../button\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport { putPreloader } from \"../putPreloader\";\r\nimport Row from \"../row\";\r\nimport { toastNew } from \"../toast\";\r\nimport { wrapPhoto } from \"../wrappers\";\r\nimport wrapPeerTitle from \"../wrappers/peerTitle\";\r\nimport PopupPaymentCard, { PaymentCardDetails, PaymentCardDetailsResult } from \"./paymentCard\";\r\nimport PopupPaymentCardConfirmation from \"./paymentCardConfirmation\";\r\nimport PopupPaymentShipping, { PaymentShippingAddress } from \"./paymentShipping\";\r\nimport PopupPaymentShippingMethods from \"./paymentShippingMethods\";\r\nimport PopupPaymentVerification from \"./paymentVerification\";\r\n\r\nconst iconPath = 'assets/img/';\r\nconst icons = [\r\n  'amex',\r\n  'card',\r\n  'diners',\r\n  'discover',\r\n  'jcb',\r\n  'mastercard',\r\n  'visa',\r\n  'unionpay',\r\n  'mir',\r\n  'logo',\r\n];\r\n\r\nexport function getPaymentBrandIconPath(brand: string) {\r\n  if(!icons.includes(brand)) {\r\n    return;\r\n  }\r\n\r\n  return `${iconPath}${brand}.svg`;\r\n}\r\n\r\nexport function PaymentButton(options: {\r\n  onClick: () => Promise<any> | void,\r\n  key?: LangPackKey,\r\n  textEl?: I18n.IntlElement\r\n}) {\r\n  const textEl = options.textEl ?? new I18n.IntlElement({key: options.key ?? 'PaymentInfo.Done'});\r\n  const key = textEl.key;\r\n  const payButton = Button('btn-primary btn-color-primary payment-item-pay');\r\n  payButton.append(textEl.element);\r\n  attachClickEvent(payButton, async() => {\r\n    const result = options.onClick();\r\n    if(!(result instanceof Promise)) {\r\n      return;\r\n    }\r\n\r\n    const d = putPreloader(payButton);\r\n    const toggle = toggleDisability([payButton], true);\r\n    textEl.compareAndUpdate({key: 'PleaseWait'});\r\n    try {\r\n      await result;\r\n    } catch(err) {\r\n      if(!(err as any).handled) {\r\n        console.error('payment button error', err);\r\n      }\r\n\r\n      toggle();\r\n      textEl.compareAndUpdate({key});\r\n      d.remove();\r\n    }\r\n  });\r\n  return payButton;\r\n}\r\n\r\nexport type PaymentsCredentialsToken = {type: 'card', token?: string, id?: string};\r\n\r\nexport default class PopupPayment extends PopupElement {\r\n  private currency: string;\r\n  private tipButtonsMap: Map<number, HTMLElement>;\r\n\r\n  constructor(\r\n    private message: Message.message,\r\n    private receiptPeerId?: PeerId,\r\n    private receiptMsgId?: number\r\n  ) {\r\n    super('popup-payment', {\r\n      closable: true,\r\n      overlayClosable: true,\r\n      body: true,\r\n      scrollable: true,\r\n      title: true\r\n    });\r\n\r\n    this.tipButtonsMap = new Map();\r\n    this.d();\r\n  }\r\n\r\n  private async d() {\r\n    this.element.classList.add('is-loading');\r\n    this.show();\r\n\r\n    let confirmed = false;\r\n    const onConfirmed = () => {\r\n      if(confirmed) {\r\n        return;\r\n      }\r\n      \r\n      confirmed = true;\r\n      if(popupPaymentVerification) {\r\n        popupPaymentVerification.hide();\r\n      }\r\n\r\n      this.hide();\r\n    };\r\n\r\n    this.listenerSetter.add(rootScope)('payment_sent', ({peerId, mid}) => {\r\n      if(this.message.peerId === peerId && this.message.mid === mid) {\r\n        onConfirmed();\r\n      }\r\n    });\r\n\r\n    const {message} = this;\r\n    const mediaInvoice = message.media as MessageMedia.messageMediaInvoice;\r\n\r\n    const isReceipt = !!(this.receiptMsgId || mediaInvoice.receipt_msg_id);\r\n\r\n    _i18n(this.title, isReceipt ? 'PaymentReceipt' : 'PaymentCheckout');\r\n    if(mediaInvoice.pFlags.test) {\r\n      this.title.append(' (Test)');\r\n    }\r\n\r\n    const className = 'payment-item';\r\n\r\n    const itemEl = document.createElement('div');\r\n    itemEl.classList.add(className);\r\n\r\n    const detailsClassName = className + '-details';\r\n    const details = document.createElement('div');\r\n    details.classList.add(detailsClassName);\r\n\r\n    let photoEl: HTMLElement;\r\n    if(mediaInvoice.photo) {\r\n      photoEl = document.createElement('div');\r\n      photoEl.classList.add(detailsClassName + '-photo', 'media-container-contain');\r\n      wrapPhoto({\r\n        photo: mediaInvoice.photo,\r\n        container: photoEl,\r\n        boxWidth: 100,\r\n        boxHeight: 100,\r\n        size: {_: 'photoSizeEmpty', type: ''}\r\n      });\r\n      details.append(photoEl);\r\n    }\r\n\r\n    const linesClassName = detailsClassName + '-lines';\r\n    const lines = document.createElement('div');\r\n    lines.classList.add(linesClassName);\r\n\r\n    const title = document.createElement('div');\r\n    title.classList.add(linesClassName + '-title');\r\n\r\n    const description = document.createElement('div');\r\n    description.classList.add(linesClassName + '-description');\r\n\r\n    const botName = document.createElement('div');\r\n    botName.classList.add(linesClassName + '-bot-name');\r\n\r\n    lines.append(title, description, botName);\r\n\r\n    setInnerHTML(title, wrapEmojiText(mediaInvoice.title));\r\n    setInnerHTML(description, wrapEmojiText(mediaInvoice.description));\r\n\r\n    const peerTitle = new PeerTitle();\r\n    botName.append(peerTitle.element);\r\n    \r\n    details.append(lines);\r\n    itemEl.append(details);\r\n    this.scrollable.append(itemEl);\r\n\r\n    const preloaderContainer = document.createElement('div');\r\n    preloaderContainer.classList.add(className + '-preloader-container');\r\n    const preloader = putPreloader(preloaderContainer, true);\r\n    this.scrollable.container.append(preloaderContainer);\r\n\r\n    let paymentForm: PaymentsPaymentForm | PaymentsPaymentReceipt;\r\n    \r\n    this.receiptMsgId ??= mediaInvoice.receipt_msg_id;\r\n    this.receiptPeerId ??= this.receiptMsgId && message.peerId;\r\n\r\n    if(isReceipt) paymentForm = await this.managers.appPaymentsManager.getPaymentReceipt(this.receiptPeerId, this.receiptMsgId);\r\n    else paymentForm = await this.managers.appPaymentsManager.getPaymentForm(message.peerId, message.mid);\r\n    \r\n    let savedInfo = (paymentForm as PaymentsPaymentForm).saved_info || (paymentForm as PaymentsPaymentReceipt).info;\r\n    const savedCredentials = (paymentForm as PaymentsPaymentForm).saved_credentials;\r\n    let [lastRequestedInfo, passwordState, providerPeerTitle] = await Promise.all([\r\n      !isReceipt && savedInfo && this.managers.appPaymentsManager.validateRequestedInfo(message.peerId, message.mid, savedInfo).catch(() => undefined),\r\n      savedCredentials && this.managers.passwordManager.getState(),\r\n      wrapPeerTitle({peerId: paymentForm.provider_id.toPeerId()})\r\n    ]);\r\n\r\n    console.log(paymentForm, lastRequestedInfo);\r\n    \r\n    await peerTitle.update({peerId: paymentForm.bot_id.toPeerId()});\r\n    preloaderContainer.remove();\r\n    this.element.classList.remove('is-loading');\r\n\r\n    const wrapAmount = (amount: string | number, skipSymbol?: boolean) => {\r\n      return paymentsWrapCurrencyAmount(amount, currency, skipSymbol);\r\n    };\r\n\r\n    const {invoice} = paymentForm;\r\n    const currency = this.currency = invoice.currency;\r\n\r\n    const makeLabel = () => {\r\n      const labelEl = document.createElement('div');\r\n      labelEl.classList.add(pricesClassName + '-price');\r\n\r\n      const left = document.createElement('span');\r\n      const right = document.createElement('span');\r\n      labelEl.append(left, right);\r\n      return {label: labelEl, left, right};\r\n    };\r\n\r\n    const pricesClassName = className + '-prices';\r\n    const prices = document.createElement('div');\r\n    prices.classList.add(pricesClassName);\r\n    const makePricesElements = (prices: LabeledPrice[]) => {\r\n      return prices.map((price) => {\r\n        const {amount, label} = price;\r\n  \r\n        const _label = makeLabel();\r\n        _label.left.textContent = label;\r\n  \r\n        const wrappedAmount = wrapAmount(amount);\r\n        _label.right.textContent = wrappedAmount;\r\n  \r\n        return _label.label;\r\n      });\r\n    };\r\n\r\n    const pricesElements = makePricesElements(invoice.prices);\r\n\r\n    let getTipsAmount = (): number => 0;\r\n    let shippingAmount = 0;\r\n\r\n    const getTotalTotal = () => totalAmount + getTipsAmount() + shippingAmount;\r\n    const setTotal = () => {\r\n      const wrapped = wrapAmount(getTotalTotal());\r\n      totalLabel.right.textContent = wrapped;\r\n      payI18n.compareAndUpdate({\r\n        key: 'PaymentCheckoutPay',\r\n        args: [wrapped]\r\n      });\r\n    };\r\n\r\n    const payI18n = new I18n.IntlElement();\r\n\r\n    const totalLabel = makeLabel();\r\n    totalLabel.label.classList.add('is-total');\r\n    _i18n(totalLabel.left, 'PaymentTransactionTotal');\r\n    const totalAmount = accumulate(invoice.prices.map(({amount}) => +amount), 0);\r\n\r\n    const canTip = (invoice.max_tip_amount !== undefined && !isReceipt) || !!(paymentForm as PaymentsPaymentReceipt).tip_amount;\r\n    if(canTip) {\r\n      const tipsClassName = className + '-tips';\r\n\r\n      const currencyData = Currencies[currency];\r\n\r\n      getTipsAmount = () => +getInputValue().replace(/\\D/g, '');\r\n\r\n      const getInputValue = () => {\r\n        // return input.textContent;\r\n        return input.value;\r\n      };\r\n\r\n      const setInputWidth = () => {\r\n        const width = getTextWidth(getInputValue(), `500 ${FontSize} ${FontFamily}`);\r\n        input.style.width = width + 'px';\r\n      };\r\n\r\n      const setInputValue = (amount: string | number) => {\r\n        amount = Math.min(+amount, +invoice.max_tip_amount);\r\n        const wrapped = wrapAmount(amount, true);\r\n        \r\n        input.value = wrapped;\r\n        // input.textContent = wrapped;\r\n        if(document.activeElement === input) {\r\n          placeCaretAtEnd(input);\r\n        }\r\n\r\n        unsetActiveTip && unsetActiveTip();\r\n        const tipEl = this.tipButtonsMap.get(amount);\r\n        if(tipEl) {\r\n          tipEl.classList.add('active');\r\n        }\r\n\r\n        setInputWidth();\r\n        setTotal();\r\n      };\r\n\r\n      const tipsLabel = makeLabel();\r\n      _i18n(tipsLabel.left, isReceipt ? 'PaymentTip' : 'PaymentTipOptional');\r\n      const input = document.createElement('input');\r\n      input.type = 'tel';\r\n      // const input: HTMLElement = document.createElement('div');\r\n      // input.contentEditable = 'true';\r\n      input.classList.add('input-clear', tipsClassName + '-input');\r\n      tipsLabel.right.append(input);\r\n\r\n      if(!isReceipt) {\r\n        tipsLabel.label.style.cursor = 'text';\r\n      } else {\r\n        tipsLabel.label.classList.add('disable-hover');\r\n      }\r\n\r\n      tipsLabel.label.addEventListener('mousedown', (e) => {\r\n        if(!findUpAsChild(e.target, input)) {\r\n          placeCaretAtEnd(input);\r\n        }\r\n      });\r\n\r\n      const haveToIgnoreEvents = input instanceof HTMLInputElement ? 1 : 2;\r\n      const onSelectionChange = () => {\r\n        if(ignoreNextSelectionChange) {\r\n          --ignoreNextSelectionChange;\r\n          return;\r\n        }\r\n\r\n        // setTimeout(() => {\r\n          ignoreNextSelectionChange = haveToIgnoreEvents;\r\n          placeCaretAtEnd(input);\r\n        // }, 0);\r\n      };\r\n\r\n      const onFocus = () => {\r\n\r\n        // cancelEvent(e);\r\n        setTimeout(() => {\r\n          ignoreNextSelectionChange = haveToIgnoreEvents;\r\n          placeCaretAtEnd(input);\r\n          document.addEventListener('selectionchange', onSelectionChange);\r\n        }, 0);\r\n      };\r\n\r\n      const onFocusOut = () => {\r\n        input.addEventListener('focus', onFocus, {once: true});\r\n        document.removeEventListener('selectionchange', onSelectionChange);\r\n      };\r\n\r\n      let ignoreNextSelectionChange: number;\r\n      input.addEventListener('focusout', onFocusOut);\r\n      onFocusOut();\r\n\r\n      input.addEventListener('input', () => {\r\n        setInputValue(getTipsAmount());\r\n      });\r\n\r\n      let s = [currencyData.symbol, currencyData.space_between ? ' ' : ''];\r\n      if(!currencyData.symbol_left) s.reverse();\r\n      tipsLabel.right[currencyData.symbol_left ? 'prepend' : 'append'](s.join(''));\r\n\r\n      pricesElements.push(tipsLabel.label);\r\n\r\n      /// \r\n      let unsetActiveTip: () => void;\r\n      if(!isReceipt) {\r\n        const tipsEl = document.createElement('div');\r\n        tipsEl.classList.add(tipsClassName);\r\n  \r\n        const tipClassName = tipsClassName + '-tip';\r\n        const tipButtons = invoice.suggested_tip_amounts.map((tipAmount) => {\r\n          const button = Button(tipClassName, {noRipple: true});\r\n          button.textContent = wrapAmount(tipAmount);\r\n  \r\n          this.tipButtonsMap.set(+tipAmount, button);\r\n          return button;\r\n        });\r\n  \r\n        unsetActiveTip = () => {\r\n          const prevTipEl = tipsEl.querySelector('.active');\r\n          if(prevTipEl) {\r\n            prevTipEl.classList.remove('active');\r\n          }\r\n        };\r\n  \r\n        attachClickEvent(tipsEl, (e) => {\r\n          const tipEl = findUpClassName(e.target, tipClassName);\r\n          if(!tipEl) {\r\n            return;\r\n          }\r\n  \r\n          let tipAmount = 0;\r\n          if(tipEl.classList.contains('active')) {\r\n            tipEl.classList.remove('active');\r\n          } else {\r\n            unsetActiveTip();\r\n            tipEl.classList.add('active');\r\n  \r\n            for(const [amount, el] of this.tipButtonsMap) {\r\n              if(el === tipEl) {\r\n                tipAmount = amount;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n  \r\n          setInputValue(tipAmount);\r\n        });\r\n  \r\n        setInputValue(0);\r\n  \r\n        tipsEl.append(...tipButtons);\r\n        pricesElements.push(tipsEl);\r\n      } else {\r\n        setInputValue((paymentForm as PaymentsPaymentReceipt).tip_amount);\r\n      }\r\n    } else {\r\n      setTotal();\r\n    }\r\n\r\n    pricesElements.push(totalLabel.label);\r\n\r\n    prices.append(...pricesElements);\r\n    itemEl.append(prices);\r\n\r\n    ///\r\n\r\n    const setRowIcon = async(row: Row, icon?: string) => {\r\n      const img = document.createElement('img');\r\n      img.classList.add('media-photo');\r\n      await renderImageFromUrlPromise(img, getPaymentBrandIconPath(icon));\r\n      let container = row.media;\r\n      if(!container) {\r\n        container = row.createMedia('small');\r\n        container.classList.add('media-container-cover');\r\n        container.append(img);\r\n      } else {\r\n        replaceContent(container, img);\r\n      }\r\n    };\r\n\r\n    const createRow = (options: ConstructorParameters<typeof Row>[0]) => {\r\n      if(options.titleLangKey) {\r\n        options.subtitleLangKey = options.titleLangKey;\r\n      }\r\n\r\n      options.noWrap = true;\r\n      const row = new Row(options);\r\n      row.container.classList.add(className + '-row');\r\n\r\n      if(options.titleLangKey) {\r\n        row.subtitle.classList.add('hide');\r\n      }\r\n\r\n      return row;\r\n    };\r\n\r\n    const setRowTitle = (row: Row, textContent: string) => {\r\n      row.title.textContent = textContent;\r\n      if(!textContent) {\r\n        const e = I18n.weakMap.get(row.subtitle.firstElementChild as HTMLElement) as I18n.IntlElement;\r\n        row.title.append(i18n(e.key));\r\n      }\r\n\r\n      row.subtitle.classList.toggle('hide', !textContent);\r\n    };\r\n\r\n    const setCardSubtitle = (card: PaymentCardDetailsResult) => {\r\n      let brand: string;\r\n      let str: string;\r\n      let icon: string;\r\n      if('title' in card) {\r\n        brand = card.title.split(' ').shift();\r\n        str = card.title;\r\n        icon = card.icon;\r\n      } else {\r\n        brand = detectUnifiedCardBrand(card.cardNumber);\r\n        str = brand + ' *' + card.cardNumber.split(' ').pop();\r\n      }\r\n\r\n      methodRow.title.classList.remove('tgico', 'tgico-card_outline');\r\n      setRowIcon(methodRow, icon || brand.toLowerCase());\r\n      setRowTitle(methodRow, str);\r\n    };\r\n\r\n    const onMethodClick = () => {\r\n      new PopupPaymentCard(paymentForm as PaymentsPaymentForm, previousCardDetails as PaymentCardDetails).addEventListener('finish', ({token, card}) => {\r\n        previousToken = token, previousCardDetails = card;\r\n\r\n        setCardSubtitle(card);\r\n      });\r\n    };\r\n\r\n    let previousCardDetails: PaymentCardDetailsResult, previousToken: PaymentsCredentialsToken;\r\n    const methodRow = createRow({\r\n      titleLangKey: 'PaymentCheckoutMethod',\r\n      clickable: isReceipt ? undefined : onMethodClick,\r\n      icon: 'card_outline'\r\n    });\r\n\r\n    methodRow.container.classList.add(className + '-method-row');\r\n\r\n    if(savedCredentials) {\r\n      setCardSubtitle(savedCredentials);\r\n    } else if((paymentForm as PaymentsPaymentReceipt).credentials_title) {\r\n      setCardSubtitle({title: (paymentForm as PaymentsPaymentReceipt).credentials_title});\r\n    }\r\n\r\n    const providerRow = createRow({\r\n      title: providerPeerTitle,\r\n      subtitleLangKey: 'PaymentCheckoutProvider'\r\n    });\r\n\r\n    const providerAvatar = new AvatarElement();\r\n    providerAvatar.classList.add('avatar-32');\r\n    providerRow.createMedia('small').append(providerAvatar);\r\n    /* await */ providerAvatar.updateWithOptions({peerId: paymentForm.provider_id.toPeerId()});\r\n\r\n    let shippingAddressRow: Row, shippingNameRow: Row, shippingEmailRow: Row, shippingPhoneRow: Row, shippingMethodRow: Row;\r\n    let lastShippingOption: ShippingOption, onShippingAddressClick: (focus?: ConstructorParameters<typeof PopupPaymentShipping>[2]) => void, onShippingMethodClick: () => void;\r\n    const setShippingTitle = invoice.pFlags.shipping_address_requested ? (shippingAddress?: PaymentShippingAddress) => {\r\n      if(!shippingAddress) {\r\n        shippingMethodRow.subtitle.classList.add('hide');\r\n        replaceContent(shippingMethodRow.title, i18n('PaymentShippingAddress'));\r\n        return;\r\n      }\r\n\r\n      const postAddress = shippingAddress.shipping_address;\r\n      setRowTitle(shippingAddressRow, [postAddress.city, postAddress.street_line1, postAddress.street_line2].filter(Boolean).join(', '));\r\n\r\n      shippingMethodRow.container.classList.toggle('hide', !lastRequestedInfo && !isReceipt);\r\n    } : undefined;\r\n\r\n    const setShippingInfo = (info: PaymentRequestedInfo) => {\r\n      setShippingTitle && setShippingTitle(info);\r\n      shippingNameRow && setRowTitle(shippingNameRow, info.name);\r\n      shippingEmailRow && setRowTitle(shippingEmailRow, info.email);\r\n      shippingPhoneRow && setRowTitle(shippingPhoneRow, info.phone && ('+' + formatPhoneNumber(info.phone).formatted));\r\n    };\r\n\r\n    if(!isReceipt) {\r\n      onShippingAddressClick = (focus) => {\r\n        new PopupPaymentShipping(paymentForm as PaymentsPaymentForm, message, focus).addEventListener('finish', ({shippingAddress, requestedInfo}) => {\r\n          lastRequestedInfo = requestedInfo;\r\n          savedInfo = (paymentForm as PaymentsPaymentForm).saved_info = shippingAddress;\r\n          setShippingInfo(shippingAddress);\r\n        });\r\n      };\r\n    }\r\n\r\n    if(invoice.pFlags.shipping_address_requested) {\r\n      const setShippingOption = (shippingOption?: ShippingOption) => {\r\n        const scrollSaver = new ScrollSaver(this.scrollable, undefined, true);\r\n        scrollSaver.save();\r\n        if(lastShippingPricesElements) {\r\n          lastShippingPricesElements.forEach((node) => node.remove());\r\n        }\r\n\r\n        if(!shippingOption) {\r\n          shippingAmount = 0;\r\n\r\n          setTotal();\r\n          scrollSaver.restore();\r\n          this.onContentUpdate();\r\n          return;\r\n        }\r\n\r\n        lastShippingOption = shippingOption;\r\n        setRowTitle(shippingMethodRow, shippingOption.title);\r\n\r\n        shippingAmount = accumulate(shippingOption.prices.map(({amount}) => +amount), 0);\r\n        lastShippingPricesElements = makePricesElements(shippingOption.prices);\r\n        let l = totalLabel.label;\r\n        if(canTip) {\r\n          l = l.previousElementSibling as any;\r\n          if(!isReceipt) {\r\n            l = l.previousElementSibling as any;\r\n          }\r\n        }\r\n\r\n        lastShippingPricesElements.forEach((element) => l.parentElement.insertBefore(element, l));\r\n\r\n        setTotal();\r\n        scrollSaver.restore();\r\n        this.onContentUpdate();\r\n      };\r\n\r\n      shippingAddressRow = createRow({\r\n        icon: 'location',\r\n        titleLangKey: 'PaymentShippingAddress',\r\n        clickable: !isReceipt && onShippingAddressClick.bind(null, undefined)\r\n      });\r\n      \r\n      let lastShippingPricesElements: HTMLElement[];\r\n      shippingMethodRow = createRow({\r\n        icon: 'shipping',\r\n        titleLangKey: 'PaymentCheckoutShippingMethod',\r\n        clickable: !isReceipt && (onShippingMethodClick = () => {\r\n          new PopupPaymentShippingMethods(paymentForm as PaymentsPaymentForm, lastRequestedInfo, lastShippingOption).addEventListener('finish', (shippingOption) => {\r\n            setShippingOption(shippingOption);\r\n          });\r\n        })\r\n      });\r\n\r\n      shippingMethodRow.container.classList.add('hide');\r\n\r\n      const shippingOption = (paymentForm as PaymentsPaymentReceipt).shipping;\r\n      if(shippingOption) {\r\n        setShippingOption(shippingOption);\r\n      }\r\n    }\r\n\r\n    if(invoice.pFlags.name_requested) {\r\n      shippingNameRow = createRow({\r\n        icon: 'newprivate',\r\n        titleLangKey: 'PaymentCheckoutName',\r\n        clickable: !isReceipt && onShippingAddressClick.bind(null, 'name')\r\n      });\r\n    }\r\n\r\n    if(invoice.pFlags.email_requested) {\r\n      shippingEmailRow = createRow({\r\n        icon: 'mention',\r\n        titleLangKey: 'PaymentShippingEmailPlaceholder',\r\n        clickable: !isReceipt && onShippingAddressClick.bind(null, 'email')\r\n      });\r\n    }\r\n\r\n    if(invoice.pFlags.phone_requested) {\r\n      shippingPhoneRow = createRow({\r\n        icon: 'phone',\r\n        titleLangKey: 'PaymentCheckoutPhoneNumber',\r\n        clickable: !isReceipt && onShippingAddressClick.bind(null, 'phone')\r\n      });\r\n    }\r\n\r\n    if(savedInfo) {\r\n      setShippingInfo(savedInfo);\r\n    }\r\n\r\n    const rows = [\r\n      methodRow,\r\n      providerRow,\r\n      shippingAddressRow,\r\n      shippingMethodRow,\r\n      shippingNameRow,\r\n      shippingEmailRow,\r\n      shippingPhoneRow,\r\n    ].filter(Boolean);\r\n    this.scrollable.append(...[\r\n      document.createElement('hr'),\r\n      ...rows.map((row) => row.container)\r\n    ].filter(Boolean));\r\n    \r\n    ///\r\n    let popupPaymentVerification: PopupPaymentVerification, lastTmpPasword: AccountTmpPassword;\r\n    const onClick = () => {\r\n      const missingInfo = invoice.pFlags.name_requested && !savedInfo?.name ? 'name' : (invoice.pFlags.email_requested && !savedInfo?.email ? 'email' : (invoice.pFlags.phone_requested && !savedInfo?.phone ? 'phone' : undefined));\r\n      if(invoice.pFlags.shipping_address_requested) {\r\n        if(!lastRequestedInfo) {\r\n          onShippingAddressClick();\r\n          return;\r\n        } else if(!lastShippingOption) {\r\n          onShippingMethodClick();\r\n          return;\r\n        }\r\n      } else if(missingInfo) {\r\n        onShippingAddressClick(missingInfo);\r\n        return;\r\n      }\r\n      \r\n      if(!previousCardDetails && !lastTmpPasword) {\r\n        if(!savedCredentials) {\r\n          onMethodClick();\r\n          return;\r\n        }\r\n\r\n        Promise.resolve(passwordState ?? this.managers.passwordManager.getState()).then((_passwordState) => {\r\n          new PopupPaymentCardConfirmation(savedCredentials.title, _passwordState).addEventListener('finish', (tmpPassword) => {\r\n            passwordState = undefined;\r\n            lastTmpPasword = tmpPassword;\r\n            simulateClickEvent(payButton);\r\n  \r\n            // * reserve 5 seconds\r\n            const diff = tmpPassword.valid_until - tsNow(true) - 5;\r\n            setTimeout(() => {\r\n              if(lastTmpPasword === tmpPassword) {\r\n                lastTmpPasword = undefined;\r\n              }\r\n            }, diff * 1000);\r\n          });\r\n        });\r\n        \r\n        return;\r\n      }\r\n\r\n      return Promise.resolve().then(async() => {\r\n        const credentials: InputPaymentCredentials = lastTmpPasword ? {\r\n          _: 'inputPaymentCredentialsSaved',\r\n          id: savedCredentials.id,\r\n          tmp_password: lastTmpPasword.tmp_password\r\n        } : {\r\n          _: 'inputPaymentCredentials',\r\n          data: {\r\n            _: 'dataJSON',\r\n            data: JSON.stringify(previousToken.token ? previousToken : {type: previousToken.type, id: previousToken.id})\r\n          },\r\n          pFlags: {\r\n            save: previousCardDetails.save || undefined\r\n          }\r\n        };\r\n\r\n        try {\r\n          const paymentResult = await this.managers.appPaymentsManager.sendPaymentForm(\r\n            message.peerId, \r\n            message.mid, \r\n            (paymentForm as PaymentsPaymentForm).form_id, \r\n            lastRequestedInfo?.id, \r\n            lastShippingOption?.id, \r\n            credentials, \r\n            getTipsAmount()\r\n          );\r\n  \r\n          if(paymentResult._ === 'payments.paymentResult') {\r\n            onConfirmed();\r\n          } else {\r\n            popupPaymentVerification = new PopupPaymentVerification(paymentResult.url);\r\n            popupPaymentVerification.addEventListener('finish', () => {\r\n              popupPaymentVerification = undefined;\r\n\r\n              // setTimeout(() => {\r\n                onConfirmed();\r\n              // }, 0);\r\n            });\r\n            await new Promise<void>((resolve, reject) => {\r\n              popupPaymentVerification.addEventListener('close', () => {\r\n                popupPaymentVerification = undefined;\r\n                if(confirmed) {\r\n                  resolve();\r\n                } else {\r\n                  const err = new Error('payment not finished');\r\n                  (err as ApiError).handled = true;\r\n                  reject(err);\r\n                }\r\n              });\r\n            });\r\n          }\r\n        } catch(err) {\r\n          if((err as ApiError).type === 'BOT_PRECHECKOUT_TIMEOUT') {\r\n            toastNew({langPackKey: 'Error.AnError'});\r\n            (err as ApiError).handled = true;\r\n          } else if((err as ApiError).type === 'TMP_PASSWORD_INVALID') {\r\n            passwordState = lastTmpPasword = undefined;\r\n            simulateClickEvent(payButton);\r\n            (err as ApiError).handled = true;\r\n          }\r\n\r\n          throw err;\r\n        }\r\n      });\r\n    };\r\n\r\n    let payButton: HTMLElement;\r\n    if(isReceipt) {\r\n      payButton = PaymentButton({\r\n        onClick: () => this.hide(),\r\n        key: 'Done'\r\n      });\r\n    } else {\r\n      payButton = PaymentButton({\r\n        onClick: onClick,\r\n        textEl: payI18n\r\n      });\r\n    }\r\n\r\n    this.body.append(this.btnConfirmOnEnter = payButton);\r\n\r\n    this.onContentUpdate();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { AppImManager, ChatSavedPosition } from \"../../lib/appManagers/appImManager\";\r\nimport type { HistoryResult, MyMessage } from \"../../lib/appManagers/appMessagesManager\";\r\nimport type { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport type Chat from \"./chat\";\r\nimport { CHAT_ANIMATION_GROUP } from \"../../lib/appManagers/appImManager\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport { logger } from \"../../lib/logger\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport BubbleGroups from \"./bubbleGroups\";\r\nimport PopupDatePicker from \"../popups/datePicker\";\r\nimport PopupForward from \"../popups/forward\";\r\nimport PopupStickers from \"../popups/stickers\";\r\nimport ProgressivePreloader from \"../preloader\";\r\nimport Scrollable, { SliceSides } from \"../scrollable\";\r\nimport StickyIntersector from \"../stickyIntersector\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport { IS_ANDROID, IS_APPLE, IS_MOBILE, IS_SAFARI } from \"../../environment/userAgent\";\r\nimport I18n, { FormatterArguments, i18n, langPack, LangPackKey, UNSUPPORTED_LANG_PACK_KEY, _i18n } from \"../../lib/langPack\";\r\nimport AvatarElement from \"../avatar\";\r\nimport ripple from \"../ripple\";\r\nimport { wrapAlbum, wrapPhoto, wrapVideo, wrapDocument, wrapSticker, wrapPoll, wrapGroupedDocuments } from \"../wrappers\";\r\nimport { MessageRender } from \"./messageRender\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport PollElement from \"../poll\";\r\nimport AudioElement from \"../audio\";\r\nimport { ChatInvite, Document, Message, MessageEntity,  MessageMedia,  MessageReplyHeader, Photo, PhotoSize, ReactionCount, ReplyMarkup, SponsoredMessage, Update, User, WebPage } from \"../../layer\";\r\nimport { BOT_START_PARAM, NULL_PEER_ID, REPLIES_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\nimport { FocusDirection, ScrollStartCallbackDimensions } from \"../../helpers/fastSmoothScroll\";\r\nimport useHeavyAnimationCheck, { getHeavyAnimationPromise, dispatchHeavyAnimationEvent, interruptHeavyAnimation } from \"../../hooks/useHeavyAnimationCheck\";\r\nimport { fastRaf, fastRafPromise } from \"../../helpers/schedulers\";\r\nimport deferredPromise from \"../../helpers/cancellablePromise\";\r\nimport RepliesElement from \"./replies\";\r\nimport DEBUG from \"../../config/debug\";\r\nimport { SliceEnd } from \"../../helpers/slicedArray\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport { toast, toastNew } from \"../toast\";\r\nimport { getElementByPoint } from \"../../helpers/dom/getElementByPoint\";\r\nimport { getMiddleware } from \"../../helpers/middleware\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent, simulateClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport htmlToDocumentFragment from \"../../helpers/dom/htmlToDocumentFragment\";\r\nimport reflowScrollableElement from \"../../helpers/dom/reflowScrollableElement\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport whichChild from \"../../helpers/dom/whichChild\";\r\nimport { cancelAnimationByKey } from \"../../helpers/animation\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport debounce, { DebounceReturnType } from \"../../helpers/schedulers/debounce\";\r\nimport { SEND_WHEN_ONLINE_TIMESTAMP } from \"../../lib/mtproto/constants\";\r\nimport windowSize from \"../../helpers/windowSize\";\r\nimport { formatPhoneNumber } from \"../../helpers/formatPhoneNumber\";\r\nimport AppMediaViewer from \"../appMediaViewer\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport handleHorizontalSwipe from \"../../helpers/dom/handleHorizontalSwipe\";\r\nimport findUpAttribute from \"../../helpers/dom/findUpAttribute\";\r\nimport findUpAsChild from \"../../helpers/dom/findUpAsChild\";\r\nimport formatCallDuration from \"../../helpers/formatCallDuration\";\r\nimport IS_CALL_SUPPORTED from \"../../environment/callSupport\";\r\nimport Button from \"../button\";\r\nimport { CallType } from \"../../lib/calls/types\";\r\nimport getVisibleRect from \"../../helpers/dom/getVisibleRect\";\r\nimport PopupJoinChatInvite from \"../popups/joinChatInvite\";\r\nimport { InternalLink, INTERNAL_LINK_TYPE } from \"../../lib/appManagers/internalLink\";\r\nimport ReactionsElement, { REACTIONS_ELEMENTS } from \"./reactions\";\r\nimport type ReactionElement from \"./reaction\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\nimport pause from \"../../helpers/schedulers/pause\";\r\nimport ScrollSaver from \"../../helpers/scrollSaver\";\r\nimport getObjectKeysAndSort from \"../../helpers/object/getObjectKeysAndSort\";\r\nimport forEachReverse from \"../../helpers/array/forEachReverse\";\r\nimport formatNumber from \"../../helpers/number/formatNumber\";\r\nimport getViewportSlice from \"../../helpers/dom/getViewportSlice\";\r\nimport SuperIntersectionObserver from \"../../helpers/dom/superIntersectionObserver\";\r\nimport generateFakeIcon from \"../generateFakeIcon\";\r\nimport copyFromElement from \"../../helpers/dom/copyFromElement\";\r\nimport PopupElement from \"../popups\";\r\nimport setAttachmentSize from \"../../helpers/setAttachmentSize\";\r\nimport wrapWebPageDescription from \"../wrappers/webPageDescription\";\r\nimport wrapWebPageTitle from \"../wrappers/webPageTitle\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\nimport wrapMessageActionTextNew from \"../wrappers/messageActionTextNew\";\r\nimport isMentionUnread from \"../../lib/appManagers/utils/messages/isMentionUnread\";\r\nimport getMediaFromMessage from \"../../lib/appManagers/utils/messages/getMediaFromMessage\";\r\nimport getPeerColorById from \"../../lib/appManagers/utils/peers/getPeerColorById\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport getServerMessageId from \"../../lib/appManagers/utils/messageId/getServerMessageId\";\r\nimport generateMessageId from \"../../lib/appManagers/utils/messageId/generateMessageId\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport { Awaited } from \"../../types\";\r\nimport idleController from \"../../helpers/idleController\";\r\nimport overlayCounter from \"../../helpers/overlayCounter\";\r\nimport { cancelContextMenuOpening } from \"../../helpers/dom/attachContextMenuListener\";\r\nimport contextMenuController from \"../../helpers/contextMenuController\";\r\nimport { AckedResult } from \"../../lib/mtproto/superMessagePort\";\r\nimport middlewarePromise from \"../../helpers/middlewarePromise\";\r\nimport { EmoticonsDropdown } from \"../emoticonsDropdown\";\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport noop from \"../../helpers/noop\";\r\nimport getAlbumText from \"../../lib/appManagers/utils/messages/getAlbumText\";\r\nimport paymentsWrapCurrencyAmount from \"../../helpers/paymentsWrapCurrencyAmount\";\r\nimport PopupPayment from \"../popups/payment\";\r\n\r\nconst USE_MEDIA_TAILS = false;\r\nconst IGNORE_ACTIONS: Set<Message.messageService['action']['_']> = new Set([\r\n  'messageActionHistoryClear',\r\n  'messageActionChatCreate'/* ,\r\n  'messageActionChannelMigrateFrom' */\r\n]);\r\n\r\nexport const SERVICE_AS_REGULAR: Set<Message.messageService['action']['_']> = new Set();\r\n\r\nif(IS_CALL_SUPPORTED) {\r\n  SERVICE_AS_REGULAR.add('messageActionPhoneCall');\r\n}\r\n\r\nconst TEST_SCROLL_TIMES: number = undefined;\r\nlet TEST_SCROLL = TEST_SCROLL_TIMES;\r\n\r\nlet queueId = 0;\r\n\r\ntype GenerateLocalMessageType<IsService> = IsService extends true ? Message.messageService : Message.message;\r\n\r\nconst SPONSORED_MESSAGE_ID_OFFSET = 1;\r\nexport const STICKY_OFFSET = 3;\r\nconst SCROLLED_DOWN_THRESHOLD = 300;\r\nconst PEER_CHANGED_ERROR = new Error('peer changed');\r\n\r\nconst DO_NOT_SLICE_VIEWPORT = false;\r\nconst DO_NOT_SLICE_VIEWPORT_ON_RENDER = false;\r\nconst DO_NOT_UPDATE_MESSAGE_VIEWS = false;\r\nconst DO_NOT_UPDATE_MESSAGE_REACTIONS = false;\r\nconst DO_NOT_UPDATE_MESSAGE_REPLY = false;\r\n\r\ntype Bubble = {\r\n  bubble: HTMLElement, \r\n  mids: Set<number>, \r\n  groupedId?: string\r\n};\r\n\r\ntype MyHistoryResult = HistoryResult | {history: number[]};\r\n\r\nfunction getMainMidForGrouped(mids: number[]) {\r\n  return Math.max(...mids);\r\n}\r\n\r\nexport default class ChatBubbles {\r\n  public container: HTMLDivElement;\r\n  public chatInner: HTMLDivElement;\r\n  public scrollable: Scrollable;\r\n\r\n  private getHistoryTopPromise: Promise<boolean>;\r\n  private getHistoryBottomPromise: Promise<boolean>;\r\n\r\n  //public messagesCount: number = -1;\r\n\r\n  private unreadOut = new Set<number>();\r\n  public needUpdate: {replyToPeerId: PeerId, replyMid: number, mid: number}[] = []; // if need wrapSingleMessage\r\n\r\n  public bubbles: {[mid: string]: HTMLElement} = {};\r\n  public skippedMids: Set<number> = new Set();\r\n  public bubblesNewByGroupedId: {[groupId: string]: Bubble} = {};\r\n  public bubblesNew: {[mid: string]: Bubble} = {};\r\n  private dateMessages: {[timestamp: number]: { \r\n    div: HTMLElement, \r\n    firstTimestamp: number, \r\n    container: HTMLElement,\r\n    timeout?: number \r\n  }} = {};\r\n\r\n  private scrolledDown = true;\r\n  private isScrollingTimeout = 0;\r\n\r\n  private stickyIntersector: StickyIntersector;\r\n\r\n  private unreaded: Map<HTMLElement, number> = new Map();\r\n  private unreadedSeen: Set<number> = new Set();\r\n  private readPromise: Promise<void>;\r\n\r\n  private bubbleGroups: BubbleGroups;\r\n\r\n  private preloader: ProgressivePreloader = null;\r\n\r\n  public messagesQueuePromise: Promise<void> = null;\r\n  private messagesQueue: ReturnType<ChatBubbles['safeRenderMessage']>[] = [];\r\n  // private messagesQueueOnRender: () => void = null;\r\n  private messagesQueueOnRenderAdditional: () => void = null;\r\n\r\n  private firstUnreadBubble: HTMLElement = null;\r\n  private attachedUnreadBubble: boolean;\r\n\r\n  public lazyLoadQueue: LazyLoadQueue;\r\n\r\n  private middleware = getMiddleware();\r\n\r\n  private log: ReturnType<typeof logger>;\r\n\r\n  public listenerSetter: ListenerSetter;\r\n\r\n  private replyFollowHistory: number[] = [];\r\n\r\n  private isHeavyAnimationInProgress = false;\r\n  private scrollingToBubble: HTMLElement;\r\n\r\n  private isFirstLoad = true;\r\n  private needReflowScroll: boolean;\r\n\r\n  private fetchNewPromise: Promise<void>;\r\n\r\n  private passEntities: Partial<{\r\n    [_ in MessageEntity['_']]: boolean\r\n  }> = {};\r\n\r\n  private onAnimateLadder: () => Promise<any> | void;\r\n  // private ladderDeferred: CancellablePromise<void>;\r\n  private resolveLadderAnimation: () => Promise<any>;\r\n  private emptyPlaceholderBubble: HTMLElement;\r\n\r\n  private viewsMids: Set<number> = new Set();\r\n  private sendViewCountersDebounced: () => Promise<void>;\r\n\r\n  private isTopPaddingSet = false;\r\n\r\n  private getSponsoredMessagePromise: Promise<void>;\r\n\r\n  private previousStickyDate: HTMLElement;\r\n  private sponsoredMessage: SponsoredMessage.sponsoredMessage;\r\n  \r\n  private hoverBubble: HTMLElement;\r\n  private hoverReaction: HTMLElement;\r\n  private sliceViewportDebounced: DebounceReturnType<ChatBubbles['sliceViewport']>;\r\n  private resizeObserver: ResizeObserver;\r\n  private willScrollOnLoad: boolean;\r\n  private observer: SuperIntersectionObserver;\r\n\r\n  private renderingMessages: Set<number> = new Set();\r\n  private setPeerCached: boolean;\r\n  private attachPlaceholderOnRender: () => void;\r\n\r\n  private bubblesToEject: Set<HTMLElement> = new Set();\r\n  private bubblesToReplace: Map<HTMLElement, HTMLElement> = new Map(); // TO -> FROM\r\n  private updatePlaceholderPosition: () => void;\r\n  private setPeerOptions: {lastMsgId: number; topMessage: number;};\r\n\r\n  private setPeerTempId: number = 0;\r\n\r\n  private renderNewPromises: Set<Promise<any>> = new Set();\r\n\r\n  // private reactions: Map<number, ReactionsElement>;\r\n\r\n  constructor(\r\n    private chat: Chat, \r\n    private managers: AppManagers\r\n  ) {\r\n    this.log = this.chat.log;\r\n    //this.chat.log.error('Bubbles construction');\r\n    \r\n    this.listenerSetter = new ListenerSetter();\r\n\r\n    this.constructBubbles();\r\n\r\n    // * constructor end\r\n\r\n    this.bubbleGroups = new BubbleGroups(this.chat);\r\n    this.preloader = new ProgressivePreloader({\r\n      cancelable: false\r\n    });\r\n    this.lazyLoadQueue = new LazyLoadQueue();\r\n    this.lazyLoadQueue.queueId = ++queueId;\r\n\r\n    // this.reactions = new Map();\r\n\r\n    // * events\r\n\r\n    // will call when sent for update pos\r\n    this.listenerSetter.add(rootScope)('history_update', async({storageKey, sequential, message}) => {\r\n      if(this.chat.messagesStorageKey !== storageKey || this.chat.type === 'scheduled') {\r\n        return;\r\n      }\r\n\r\n      const {mid} = message;\r\n      const log = false ? this.log.bindPrefix('history_update-' + mid) : undefined;\r\n      log && log('start');\r\n\r\n      const bubble = this.bubbles[mid];\r\n      if(!bubble) return;\r\n\r\n      if(this.renderNewPromises.size) {\r\n        log && log.error('will await new messages render');\r\n        await Promise.all(Array.from(this.renderNewPromises));\r\n      }\r\n\r\n      if(this.messagesQueuePromise) {\r\n        log && log.error('messages render in process');\r\n        await this.messagesQueuePromise;\r\n      }\r\n\r\n      if(this.bubbles[mid] !== bubble) return;\r\n\r\n      // await getHeavyAnimationPromise();\r\n      \r\n      const item = this.bubbleGroups.getItemByBubble(bubble);\r\n      if(!item) { // probably a group item\r\n        log && log.error('no item by bubble', bubble);\r\n        return;\r\n      } else if(item.mid === mid) {\r\n        log && log.warn('wow what', item, mid);\r\n        return;\r\n      }\r\n\r\n      if(sequential) {\r\n        const group = item.group;\r\n        const newItem = this.bubbleGroups.createItem(bubble, message);\r\n        // newItem.mid = item.mid;\r\n        const _items = this.bubbleGroups.itemsArr.slice();\r\n        indexOfAndSplice(_items, item);\r\n        const foundItem = this.bubbleGroups.findGroupSiblingByItem(newItem, _items);\r\n        if(\r\n          group === foundItem?.group \r\n          || (group === this.bubbleGroups.getLastGroup() && group.items.length === 1 && newItem.dateTimestamp === item.dateTimestamp) \r\n          || (this.peerId === rootScope.myId && sequential && newItem.dateTimestamp === item.dateTimestamp)\r\n        ) {\r\n          log && log('item has correct position', item);\r\n          this.bubbleGroups.changeBubbleMid(bubble, mid);\r\n          return;\r\n        }\r\n      }\r\n\r\n      // return;\r\n\r\n      // await fastRafPromise();\r\n      // if(this.bubbles[mid] !== bubble) return;\r\n\r\n      // const groupIndex = this.bubbleGroups.groups.indexOf(group);\r\n      this.bubbleGroups.removeAndUnmountBubble(bubble);\r\n      // if(!group.items.length) { // group has collapsed, next message can have higher mid so have to reposition them too\r\n      //   log && log('group has collapsed', item);\r\n\r\n      //   const siblingGroups = this.bubbleGroups.groups.slice(0, groupIndex + 1);\r\n      //   for(let length = siblingGroups.length, i = length - 2; i >= 0; --i) {\r\n      //     const siblingGroup = siblingGroups[i];\r\n      //     const siblingItems = siblingGroup.items;\r\n      //     const nextGroup = siblingGroups[i + 1];\r\n      //     const nextItems = nextGroup.items;\r\n\r\n      //     let _break = false, moved = false;\r\n      //     for(let j = siblingItems.length - 1; j >= 0; --j) {\r\n      //       const siblingItem = siblingItems[j];\r\n      //       const foundItem = this.bubbleGroups.findGroupSiblingByItem(siblingItem, nextItems);\r\n      //       if(!foundItem) {\r\n      //         _break = true;\r\n      //         break;\r\n      //       }\r\n\r\n      //       log('will move item', siblingItem, nextGroup);\r\n      //       this.bubbleGroups.removeAndUnmountBubble(siblingItem.bubble);\r\n      //       this.bubbleGroups.addItemToGroup(siblingItem, nextGroup);\r\n      //       moved = true;\r\n      //     }\r\n\r\n      //     if(moved) {\r\n      //       nextGroup.mount();\r\n      //     }\r\n\r\n      //     if(_break) {\r\n      //       break;\r\n      //     }\r\n      //   }\r\n      // }\r\n\r\n      const {groups} = this.groupBubbles([{bubble, message}]);\r\n      this.bubbleGroups.mountUnmountGroups(groups);\r\n\r\n      if(this.scrollingToBubble) {\r\n        this.scrollToEnd();\r\n      }\r\n\r\n      log && log('end');\r\n\r\n      // this.bubbleGroups.findIncorrentPositions();\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('dialog_flush', ({peerId}) => {\r\n      if(this.peerId === peerId) {\r\n        this.deleteMessagesByIds(Object.keys(this.bubbles).map((m) => +m));\r\n      }\r\n    });\r\n\r\n    // Calls when message successfully sent and we have an id\r\n    this.listenerSetter.add(rootScope)('message_sent', async(e) => {\r\n      const {storageKey, tempId, tempMessage, mid, message} = e;\r\n\r\n      // ! can't use peerId to validate here, because id can be the same in 'scheduled' and 'chat' types\r\n      if(this.chat.messagesStorageKey !== storageKey) {\r\n        return;\r\n      }\r\n\r\n      const bubbles = this.bubbles;\r\n      const _bubble = bubbles[tempId];\r\n      if(_bubble) {\r\n        const bubble = bubbles[tempId];\r\n        bubbles[mid] = bubble;\r\n        bubble.dataset.mid = '' + mid;\r\n        delete bubbles[tempId];\r\n\r\n        fastRaf(() => {\r\n          const mid = +bubble.dataset.mid;\r\n          if(bubbles[mid] === bubble && bubble.classList.contains('is-outgoing')) {\r\n            bubble.classList.remove('is-sending', 'is-outgoing');\r\n            bubble.classList.add((this.peerId === rootScope.myId && this.chat.type !== 'scheduled') || !this.unreadOut.has(mid) ? 'is-read' : 'is-sent');\r\n          }\r\n        });\r\n      }\r\n\r\n      if(this.unreadOut.has(tempId)) {\r\n        this.unreadOut.delete(tempId);\r\n        this.unreadOut.add(mid);\r\n      }\r\n\r\n      // * check timing of scheduled message\r\n      if(this.chat.type === 'scheduled') {\r\n        const timestamp = Date.now() / 1000 | 0;\r\n        const maxTimestamp = tempMessage.date - 10;\r\n        if(timestamp >= maxTimestamp) {\r\n          this.deleteMessagesByIds([mid]);\r\n        }\r\n      }\r\n\r\n      if(!_bubble) {\r\n        return;\r\n      }\r\n\r\n      let messages: (Message.message | Message.messageService)[], tempIds: number[];\r\n      const groupedId = (message as Message.message).grouped_id;\r\n      if(groupedId) {\r\n        messages = await this.managers.appMessagesManager.getMessagesByAlbum(groupedId);\r\n        const mids = messages.map(({mid}) => mid);\r\n        if(!mids.length || getMainMidForGrouped(mids) !== mid || bubbles[mid] !== _bubble) {\r\n          return;\r\n        }\r\n  \r\n        if(bubbles[mid] !== _bubble) {\r\n          return;\r\n        }\r\n\r\n        tempIds = (Array.from(_bubble.querySelectorAll('.grouped-item')) as HTMLElement[]).map((el) => +el.dataset.mid);\r\n      } else {\r\n        messages = [message];\r\n        tempIds = [tempId];\r\n      }\r\n\r\n      const reactionsElements = Array.from(_bubble.querySelectorAll('reactions-element')) as ReactionsElement[];\r\n      if(reactionsElements.length) {\r\n        reactionsElements.forEach((reactionsElement) => {\r\n          reactionsElement.changeMessage(message as Message.message);\r\n        });\r\n      }\r\n\r\n      (messages as Message.message[]).forEach((message, idx) => {\r\n        if(!message) {\r\n          return;\r\n        }\r\n\r\n        const tempId = tempIds[idx];\r\n        const mid = message.mid;\r\n        const bubble: HTMLElement = _bubble.querySelector(`.document-container[data-mid=\"${mid}\"]`) || _bubble;\r\n\r\n        if(message._ !== 'message') {\r\n          return;\r\n        }\r\n\r\n        if(message.replies) {\r\n          const repliesElement = _bubble.querySelector('replies-element') as RepliesElement;\r\n          if(repliesElement) {\r\n            repliesElement.message = message;\r\n            repliesElement.init();\r\n          }\r\n        }\r\n\r\n        const media = message.media ?? {} as MessageMedia.messageMediaEmpty;\r\n        const doc = (media as MessageMedia.messageMediaDocument).document as Document.document;\r\n        const poll = (media as MessageMedia.messageMediaPoll).poll;\r\n        const webPage = (media as MessageMedia.messageMediaWebPage).webpage as WebPage.webPage;\r\n        if(doc) {\r\n          const div = bubble.querySelector(`.document-container[data-mid=\"${tempId}\"] .document`);\r\n          if(div) {\r\n            const container = findUpClassName(div, 'document-container');\r\n\r\n            if(!tempMessage.media?.document?.thumbs?.length && doc.thumbs?.length) {\r\n              getHeavyAnimationPromise().then(async() => {\r\n                const timeSpan = div.querySelector('.time');\r\n                const newDiv = await wrapDocument({message});\r\n                div.replaceWith(newDiv);\r\n                \r\n                if(timeSpan) {\r\n                  newDiv.querySelector('.document-size').append(timeSpan);\r\n                }\r\n              });\r\n            }\r\n\r\n            if(container) {\r\n              container.dataset.mid = '' + mid;\r\n            }\r\n          }\r\n\r\n          const element = bubble.querySelector(`audio-element[data-mid=\"${tempId}\"], .document[data-doc-id=\"${tempId}\"], .media-round[data-mid=\"${tempId}\"]`) as HTMLElement;\r\n          if(element) {\r\n            if(element instanceof AudioElement || element.classList.contains('media-round')) {\r\n              element.dataset.mid = '' + message.mid;\r\n              delete element.dataset.isOutgoing;\r\n              (element as any).message = message;\r\n              (element as any).onLoad(true);\r\n            } else {\r\n              element.dataset.docId = '' + doc.id;\r\n            }\r\n          }\r\n        } else if(poll) {\r\n          const pollElement = bubble.querySelector('poll-element') as PollElement;\r\n          if(pollElement) {\r\n            pollElement.message = message;\r\n            pollElement.setAttribute('poll-id', '' + poll.id);\r\n            pollElement.setAttribute('message-id', '' + mid);\r\n          }\r\n        } else if(webPage && !bubble.querySelector('.web')) {\r\n          getHeavyAnimationPromise().then(() => {\r\n            this.safeRenderMessage(message, true, bubble);\r\n            this.scrollToBubbleIfLast(bubble);\r\n          });\r\n        }\r\n        \r\n        // set new mids to album items for mediaViewer\r\n        if(groupedId) {\r\n          const item = (bubble.querySelector(`.grouped-item[data-mid=\"${tempId}\"]`) as HTMLElement) || bubble; // * it can be .document-container\r\n          if(item) {\r\n            item.dataset.mid = '' + mid;\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('message_edit', async({storageKey, message}) => {\r\n      if(storageKey !== this.chat.messagesStorageKey) return;\r\n\r\n      const bubble = this.bubbles[message.mid];\r\n      if(!bubble) return;\r\n\r\n      await getHeavyAnimationPromise();\r\n      if(this.bubbles[message.mid] !== bubble) return;\r\n\r\n      this.safeRenderMessage(message, true, bubble);\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('album_edit', ({peerId, messages, deletedMids}) => {\r\n      if(peerId !== this.peerId) return;\r\n      \r\n      const mids = messages.map(({mid}) => mid);\r\n      const oldMids = mids.concat(Array.from(deletedMids));\r\n      const wasMainMid = getMainMidForGrouped(oldMids);\r\n      const bubble = this.bubbles[wasMainMid];\r\n      if(!bubble) {\r\n        return;\r\n      }\r\n\r\n      const mainMid = getMainMidForGrouped(mids);\r\n      const message = messages.find((message) => message.mid === mainMid);\r\n      this.safeRenderMessage(message, true, bubble);\r\n    });\r\n\r\n    if(this.chat.type !== 'scheduled' && !DO_NOT_UPDATE_MESSAGE_REACTIONS/*  && false */) {\r\n      this.listenerSetter.add(rootScope)('messages_reactions', async(arr) => {\r\n        let scrollSaver: ScrollSaver;\r\n\r\n        const a = arr.map(async({message, changedResults}) => {\r\n          if(this.peerId !== message.peerId) {\r\n            return;\r\n          }\r\n\r\n          const result = await this.getMountedBubble(message.mid, message);\r\n          if(!result) {\r\n            return;\r\n          }\r\n\r\n          return {bubble: result.bubble, message, changedResults};\r\n        });\r\n\r\n        let top: number;\r\n        (await Promise.all(a)).filter(Boolean).forEach(({bubble, message, changedResults}) => {\r\n          if(!scrollSaver) {\r\n            scrollSaver = this.createScrollSaver(false);\r\n            scrollSaver.save();\r\n          }\r\n  \r\n          const key = message.peerId + '_' + message.mid;\r\n          const set = REACTIONS_ELEMENTS.get(key);\r\n          if(set) {\r\n            for(const element of set) {\r\n              element.update(message, changedResults);\r\n            }\r\n          } else if(!message.reactions || !message.reactions.results.length) {\r\n            return;\r\n          } else {\r\n            this.appendReactionsElementToBubble(bubble, message, message, changedResults);\r\n          }\r\n        });\r\n\r\n        if(scrollSaver) {\r\n          scrollSaver.restore();\r\n        }\r\n      });\r\n    }\r\n\r\n    !DO_NOT_UPDATE_MESSAGE_REPLY && this.listenerSetter.add(rootScope)('messages_downloaded', async({peerId, mids}) => {\r\n      const middleware = this.getMiddleware();\r\n      await getHeavyAnimationPromise();\r\n      if(!middleware()) return;\r\n\r\n      (mids as number[]).forEach((mid) => {\r\n        const needUpdate = this.needUpdate;\r\n        const filtered: typeof needUpdate[0][] = [];\r\n        forEachReverse(this.needUpdate, (obj, idx) => {\r\n          if(obj.replyMid === mid && obj.replyToPeerId === peerId) {\r\n            this.needUpdate.splice(idx, 1)[0];\r\n            filtered.push(obj);\r\n          }\r\n        });\r\n\r\n        filtered.forEach(async({mid, replyMid, replyToPeerId}) => {\r\n          const bubble = this.bubbles[mid];\r\n          if(!bubble) return;\r\n\r\n          const message = (await this.chat.getMessage(mid)) as Message.message;\r\n          \r\n          MessageRender.setReply({\r\n            chat: this.chat,\r\n            bubble,\r\n            message\r\n          });\r\n        });\r\n      });\r\n    });\r\n\r\n    attachClickEvent(this.scrollable.container, this.onBubblesClick, {listenerSetter: this.listenerSetter});\r\n    // this.listenerSetter.add(this.bubblesContainer)('click', this.onBubblesClick/* , {capture: true, passive: false} */);\r\n\r\n    this.listenerSetter.add(this.scrollable.container)('mousedown', (e) => {\r\n      if(e.button !== 0) return;\r\n      \r\n      const code: HTMLElement = findUpTag(e.target, 'CODE');\r\n      if(code) {\r\n        cancelEvent(e);\r\n        copyFromElement(code);\r\n        toastNew({langPackKey: 'TextCopied'});\r\n        return;\r\n      }\r\n    });\r\n\r\n    /* if(false)  */this.stickyIntersector = new StickyIntersector(this.scrollable.container, (stuck, target) => {\r\n      for(const timestamp in this.dateMessages) {\r\n        const dateMessage = this.dateMessages[timestamp];\r\n        if(dateMessage.container === target) {\r\n          const dateBubble = dateMessage.div;\r\n\r\n          // dateMessage.container.classList.add('has-sticky-dates');\r\n\r\n          // SetTransition(dateBubble, 'kek', stuck, this.previousStickyDate ? 300 : 0);\r\n          // if(this.previousStickyDate) {\r\n            // dateBubble.classList.add('kek');\r\n          // }\r\n\r\n          dateBubble.classList.toggle('is-sticky', stuck);\r\n          if(stuck) {\r\n            this.previousStickyDate = dateBubble;\r\n          }\r\n\r\n          break;\r\n        }\r\n      }\r\n\r\n      if(this.previousStickyDate) {\r\n        // fastRaf(() => {\r\n          // this.bubblesContainer.classList.add('has-sticky-dates');\r\n        // });\r\n      }\r\n    });\r\n\r\n    if(!IS_SAFARI) {\r\n      this.sliceViewportDebounced = debounce(this.sliceViewport.bind(this), 3000, false, true);\r\n    }\r\n\r\n    let middleware: ReturnType<ChatBubbles['getMiddleware']>;\r\n    useHeavyAnimationCheck(() => {\r\n      this.isHeavyAnimationInProgress = true;\r\n      this.lazyLoadQueue.lock();\r\n      middleware = this.getMiddleware();\r\n\r\n      // if(this.sliceViewportDebounced) {\r\n      //   this.sliceViewportDebounced.clearTimeout();\r\n      // }\r\n    }, () => {\r\n      this.isHeavyAnimationInProgress = false;\r\n\r\n      if(middleware && middleware()) {\r\n        this.lazyLoadQueue.unlock();\r\n        this.lazyLoadQueue.refresh();\r\n\r\n        // if(this.sliceViewportDebounced) {\r\n        //   this.sliceViewportDebounced();\r\n        // }\r\n      }\r\n\r\n      middleware = null;\r\n    }, this.listenerSetter);\r\n  }\r\n\r\n  private constructBubbles() {\r\n    const container = this.container = document.createElement('div');\r\n    container.classList.add('bubbles', 'scrolled-down');\r\n\r\n    const chatInner = this.chatInner = document.createElement('div');\r\n    chatInner.classList.add('bubbles-inner');\r\n\r\n    this.setScroll();\r\n\r\n    container.append(this.scrollable.container);\r\n  }\r\n\r\n  public attachContainerListeners() {\r\n    const container = this.container;\r\n\r\n    this.chat.contextMenu.attachTo(container);\r\n    this.chat.selection.attachListeners(container, new ListenerSetter());\r\n\r\n    if(DEBUG) {\r\n      this.listenerSetter.add(container)('dblclick', async(e) => {\r\n        const bubble = findUpClassName(e.target, 'grouped-item') || findUpClassName(e.target, 'bubble');\r\n        if(bubble) {\r\n          const mid = +bubble.dataset.mid\r\n          this.log('debug message:', await this.chat.getMessage(mid));\r\n          this.highlightBubble(bubble);\r\n        }\r\n      });\r\n    }\r\n\r\n    if(this.chat.type !== 'pinned' && this.chat.type !== 'scheduled') {\r\n      if(!IS_MOBILE) {\r\n        this.listenerSetter.add(container)('dblclick', async(e) => {\r\n          if(this.chat.selection.isSelecting || \r\n            !(await this.chat.canSend())) {\r\n            return;\r\n          }\r\n          \r\n          const target = e.target as HTMLElement;\r\n          const bubble = target.classList.contains('bubble') ? \r\n            target : \r\n            (target.classList.contains('document-selection') ? target.parentElement : null);\r\n          if(bubble && !bubble.classList.contains('bubble-first')) {\r\n            const mid = +bubble.dataset.mid;\r\n            const message = await this.chat.getMessage(mid);\r\n            if(message.pFlags.is_outgoing) {\r\n              return;\r\n            }\r\n            \r\n            this.chat.input.initMessageReply(mid);\r\n          }\r\n        });\r\n      } else if(IS_TOUCH_SUPPORTED) {\r\n        const className = 'is-gesturing-reply';\r\n        const MAX = 64;\r\n        const replyAfter = MAX * .75;\r\n        let shouldReply = false;\r\n        let target: HTMLElement;\r\n        let icon: HTMLElement;\r\n        handleHorizontalSwipe({\r\n          element: container,\r\n          verifyTouchTarget: async(e) => {\r\n            if(this.chat.selection.isSelecting || !(await this.chat.canSend())) {\r\n              return false;\r\n            }\r\n  \r\n            // cancelEvent(e);\r\n            target = findUpClassName(e.target, 'bubble');\r\n            if(target) {\r\n              SetTransition(target, className, true, 250);\r\n              void target.offsetLeft; // reflow\r\n  \r\n              if(!icon) {\r\n                icon = document.createElement('span');\r\n                icon.classList.add('tgico-reply_filled', 'bubble-gesture-reply-icon');\r\n              } else {\r\n                icon.classList.remove('is-visible');\r\n                icon.style.opacity = '';\r\n              }\r\n  \r\n              target/* .querySelector('.bubble-content') */.append(icon);\r\n            }\r\n  \r\n            return !!target;\r\n          },\r\n          onSwipe: (xDiff, yDiff) => {\r\n            shouldReply = xDiff >= replyAfter;\r\n  \r\n            if(shouldReply && !icon.classList.contains('is-visible')) {\r\n              icon.classList.add('is-visible');\r\n            }\r\n            icon.style.opacity = '' + Math.min(1, xDiff / replyAfter);\r\n  \r\n            const x = -Math.max(0, Math.min(MAX, xDiff));\r\n            target.style.transform = `translateX(${x}px)`;\r\n            cancelContextMenuOpening();\r\n          },\r\n          onReset: () => {\r\n            const _target = target;\r\n            SetTransition(_target, className, false, 250, () => {\r\n              if(icon.parentElement === _target) {\r\n                icon.classList.remove('is-visible');\r\n                icon.remove();\r\n              }\r\n            });\r\n  \r\n            fastRaf(() => {\r\n              _target.style.transform = ``;\r\n  \r\n              if(shouldReply) {\r\n                const {mid} = _target.dataset;\r\n                this.chat.input.initMessageReply(+mid);\r\n                shouldReply = false;\r\n              }\r\n            });\r\n          },\r\n          listenerOptions: {capture: true}\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  public constructPeerHelpers() {\r\n    // will call when message is sent (only 1)\r\n    this.listenerSetter.add(rootScope)('history_append', async({storageKey, message}) => {\r\n      if(storageKey !== this.chat.messagesStorageKey) return;\r\n\r\n      if(!this.scrollable.loadedAll.bottom) {\r\n        this.chat.setMessageId();\r\n      } else {\r\n        this.renderNewMessage(message, true);\r\n      }\r\n\r\n      if(rootScope.settings.animationsEnabled) {\r\n        const gradientRenderer = this.chat.gradientRenderer;\r\n        if(gradientRenderer) {\r\n          gradientRenderer.toNextPosition();\r\n        }\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('history_multiappend', (message) => {\r\n      if(this.peerId !== message.peerId) return;\r\n      this.renderNewMessage(message);\r\n    });\r\n    \r\n    this.listenerSetter.add(rootScope)('history_delete', ({peerId, msgs}) => {\r\n      if(peerId === this.peerId) {\r\n        this.deleteMessagesByIds(Array.from(msgs));\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('dialog_unread', ({peerId}) => {\r\n      if(peerId === this.peerId) {\r\n        this.chat.input.setUnreadCount();\r\n\r\n        getHeavyAnimationPromise().then(() => {\r\n          this.updateUnreadByDialog();\r\n        });\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('dialogs_multiupdate', (dialogs) => {\r\n      if(dialogs[this.peerId]) {\r\n        this.chat.input.setUnreadCount();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('dialog_notify_settings', (dialog) => {\r\n      if(this.peerId === dialog.peerId) {\r\n        this.chat.input.setUnreadCount();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('chat_update', async(chatId) => {\r\n      if(this.peerId === chatId.toPeerId(true)) {\r\n        const hadRights = this.chatInner.classList.contains('has-rights');\r\n        const hasRights = await this.chat.canSend();\r\n\r\n        if(hadRights !== hasRights) {\r\n          const callbacks = await Promise.all([\r\n            this.finishPeerChange(),\r\n            this.chat.input.finishPeerChange(),\r\n          ]);\r\n\r\n          callbacks.forEach((callback) => callback());\r\n        }\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('settings_updated', async({key}) => {\r\n      if(key === 'settings.emoji.big') {\r\n        const middleware = this.getMiddleware();\r\n        const mids = getObjectKeysAndSort(this.bubbles, 'desc');\r\n        const m = mids.map(async(mid) => {\r\n          const bubble = this.bubbles[mid];\r\n          if(bubble.classList.contains('can-have-big-emoji')) {\r\n            return {bubble, message: await this.chat.getMessage(mid)};\r\n          }\r\n        });\r\n\r\n        const awaited = await Promise.all(m);\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n\r\n        awaited.forEach(({bubble, message}) => {\r\n          if(this.bubbles[message.mid] !== bubble) {\r\n            return;\r\n          }\r\n          \r\n          this.safeRenderMessage(message, true, bubble);\r\n        });\r\n      }\r\n    });\r\n\r\n    !DO_NOT_UPDATE_MESSAGE_VIEWS && this.listenerSetter.add(rootScope)('messages_views', (arr) => {\r\n      fastRaf(() => {\r\n        let scrollSaver: ScrollSaver;\r\n        for(const {peerId, views, mid} of arr) {\r\n          if(this.peerId !== peerId) continue;\r\n\r\n          const bubble = this.bubbles[mid];\r\n          if(!bubble) continue;\r\n  \r\n          const postViewsElements = Array.from(bubble.querySelectorAll('.post-views')) as HTMLElement[];\r\n          if(!postViewsElements.length) continue;\r\n\r\n          const str = formatNumber(views, 1);\r\n          let different = false;\r\n          postViewsElements.forEach((postViews) => {\r\n            if(different || postViews.textContent !== str) {\r\n              if(!scrollSaver) {\r\n                scrollSaver = this.createScrollSaver(true);\r\n                scrollSaver.save();\r\n              }\r\n\r\n              different = true;\r\n              postViews.textContent = str;\r\n            }\r\n          });\r\n        }\r\n\r\n        if(scrollSaver) {\r\n          scrollSaver.restore();\r\n        }\r\n      });\r\n    });\r\n\r\n    this.observer = new SuperIntersectionObserver({root: this.scrollable.container});\r\n\r\n    this.listenerSetter.add(this.chat.appImManager)('chat_changing', ({to}) => {\r\n      const freeze = to !== this.chat;\r\n\r\n      const cb = () => {\r\n        this.observer.toggleObservingNew(freeze);\r\n      };\r\n\r\n      if(!freeze) {\r\n        setTimeout(() => {\r\n          cb();\r\n        }, 400);\r\n      } else {\r\n        cb();\r\n      }\r\n    });\r\n\r\n    this.sendViewCountersDebounced = debounce(() => {\r\n      const mids = [...this.viewsMids];\r\n      this.viewsMids.clear();\r\n\r\n      this.managers.appMessagesManager.incrementMessageViews(this.peerId, mids);\r\n    }, 1000, false, true);\r\n  }\r\n\r\n  private get peerId() {\r\n    return this.chat.peerId;\r\n  }\r\n\r\n  private createScrollSaver(reverse = true) {\r\n    const scrollSaver = new ScrollSaver(this.scrollable, '.bubble:not(.is-date)', reverse);\r\n    return scrollSaver;\r\n  }\r\n\r\n  private unreadedObserverCallback = (entry: IntersectionObserverEntry) => {\r\n    if(entry.isIntersecting) {\r\n      const target = entry.target as HTMLElement;\r\n      const mid = this.unreaded.get(target as HTMLElement);\r\n      this.onUnreadedInViewport(target, mid);\r\n    }\r\n  };\r\n\r\n  private viewsObserverCallback = (entry: IntersectionObserverEntry) => {\r\n    if(entry.isIntersecting) {\r\n      const mid = +(entry.target as HTMLElement).dataset.mid;\r\n      this.observer.unobserve(entry.target, this.viewsObserverCallback);\r\n\r\n      if(mid) {\r\n        this.viewsMids.add(mid);\r\n        this.sendViewCountersDebounced();\r\n      } else {\r\n        const {sponsoredMessage} = this;\r\n        if(sponsoredMessage && sponsoredMessage.random_id) {\r\n          delete sponsoredMessage.random_id;\r\n          this.managers.appChatsManager.viewSponsoredMessage(this.peerId.toChatId(), sponsoredMessage.random_id);\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  private createResizeObserver() {\r\n    if(!('ResizeObserver' in window) || this.resizeObserver) {\r\n      return;\r\n    }\r\n\r\n    const container = this.scrollable.container;\r\n    let wasHeight = 0/* container.offsetHeight */;\r\n    let resizing = false;\r\n    let skip = false;\r\n    let scrolled = 0;\r\n    let part = 0;\r\n    let rAF = 0;\r\n    // let skipNext = true;\r\n\r\n    const onResizeEnd = () => {\r\n      const height = container.offsetHeight;\r\n      const isScrolledDown = this.scrollable.isScrolledDown;\r\n      if(height !== wasHeight && (!skip || !isScrolledDown)) { // * fix opening keyboard while ESG is active, offsetHeight will change right between 'start' and this first frame\r\n        part += wasHeight - height;\r\n      }\r\n\r\n      /* if(DEBUG) {\r\n        this.log('resize end', scrolled, part, this.scrollable.scrollTop, height, wasHeight, this.scrollable.isScrolledDown);\r\n      } */\r\n\r\n      if(part) {\r\n        this.scrollable.setScrollTopSilently(this.scrollable.scrollTop + Math.round(part));\r\n      }\r\n\r\n      wasHeight = height;\r\n      scrolled = 0;\r\n      rAF = 0;\r\n      part = 0;\r\n      resizing = false;\r\n      skip = false;\r\n    };\r\n\r\n    const setEndRAF = (single: boolean) => {\r\n      if(rAF) window.cancelAnimationFrame(rAF);\r\n      rAF = window.requestAnimationFrame(single ? onResizeEnd : () => {\r\n        rAF = window.requestAnimationFrame(onResizeEnd);\r\n        //this.log('resize after RAF', part);\r\n      });\r\n    };\r\n\r\n    const processEntries: ResizeObserverCallback = (entries) => {\r\n      /* if(skipNext) {\r\n        skipNext = false;\r\n        return;\r\n      } */\r\n\r\n      if(skip) {\r\n        setEndRAF(false);\r\n        return;\r\n      }\r\n\r\n      const entry = entries[0];\r\n      const height = entry.contentRect.height;/* Math.ceil(entry.contentRect.height); */\r\n      \r\n      if(!wasHeight) {\r\n        wasHeight = height;\r\n        return;\r\n      }\r\n\r\n      const realDiff = wasHeight - height;\r\n      let diff = realDiff + part;\r\n      const _part = diff % 1;\r\n      diff -= _part;\r\n\r\n      if(!resizing) {\r\n        resizing = true;\r\n\r\n        /* if(DEBUG) {\r\n          this.log('resize start', realDiff, this.scrollable.scrollTop, this.scrollable.container.offsetHeight, this.scrollable.isScrolledDown);\r\n        } */\r\n\r\n        if(realDiff < 0 && this.scrollable.isScrolledDown) {\r\n          //if(isSafari) { // * fix opening keyboard while ESG is active \r\n            part = -realDiff;\r\n          //}\r\n\r\n          skip = true;\r\n          setEndRAF(false);\r\n          return;\r\n        }\r\n      }\r\n\r\n      scrolled += diff;\r\n\r\n      /* if(DEBUG) {\r\n        this.log('resize', wasHeight - height, diff, this.scrollable.container.offsetHeight, this.scrollable.isScrolledDown, height, wasHeight);\r\n      } */\r\n\r\n      if(diff) {\r\n        const needScrollTop = this.scrollable.scrollTop + diff;\r\n        this.scrollable.setScrollTopSilently(needScrollTop);\r\n      }\r\n      \r\n      setEndRAF(false);\r\n\r\n      part = _part;\r\n      wasHeight = height;\r\n    };\r\n\r\n    const resizeObserver = this.resizeObserver = new ResizeObserver(processEntries);\r\n    resizeObserver.observe(container);\r\n  }\r\n\r\n  private destroyResizeObserver() {\r\n    const resizeObserver = this.resizeObserver;\r\n    if(!resizeObserver) {\r\n      return;\r\n    }\r\n\r\n    resizeObserver.disconnect();\r\n    this.resizeObserver = undefined;\r\n  }\r\n\r\n  private onBubblesMouseMove = async(e: MouseEvent) => {\r\n    const content = findUpClassName(e.target, 'bubble-content');\r\n    if(content && !this.chat.selection.isSelecting) {\r\n      const bubble = findUpClassName(content, 'bubble');\r\n      if(!this.chat.selection.canSelectBubble(bubble)) {\r\n        this.unhoverPrevious();\r\n        return;\r\n      }\r\n\r\n      let {hoverBubble, hoverReaction} = this;\r\n      if(bubble === hoverBubble) {\r\n        return;\r\n      }\r\n\r\n      this.unhoverPrevious();\r\n\r\n      hoverBubble = this.hoverBubble = bubble;\r\n      hoverReaction = this.hoverReaction;\r\n      // hoverReaction = contentWrapper.querySelector('.bubble-hover-reaction');\r\n      if(!hoverReaction) {\r\n        hoverReaction = this.hoverReaction = document.createElement('div');\r\n        hoverReaction.classList.add('bubble-hover-reaction');\r\n\r\n        const stickerWrapper = document.createElement('div');\r\n        stickerWrapper.classList.add('bubble-hover-reaction-sticker');\r\n        hoverReaction.append(stickerWrapper);\r\n\r\n        content.append(hoverReaction);\r\n\r\n        let message = (await this.chat.getMessage(+bubble.dataset.mid)) as Message.message;\r\n        message = await this.managers.appMessagesManager.getGroupsFirstMessage(message);\r\n\r\n        const middleware = this.getMiddleware(() => this.hoverReaction === hoverReaction);\r\n        Promise.all([\r\n          this.managers.appReactionsManager.getAvailableReactionsByMessage(message),\r\n          pause(400)\r\n        ]).then(([availableReactions]) => {\r\n          const availableReaction = availableReactions[0];\r\n          if(!availableReaction) {\r\n            hoverReaction.remove();\r\n            return;\r\n          }\r\n\r\n          wrapSticker({\r\n            div: stickerWrapper,\r\n            doc: availableReaction.select_animation,\r\n            width: 18,\r\n            height: 18,\r\n            needUpscale: true,\r\n            middleware,\r\n            group: CHAT_ANIMATION_GROUP,\r\n            withThumb: false,\r\n            needFadeIn: false\r\n          }).then(({render}) => render).then((player) => {\r\n            assumeType<RLottiePlayer>(player);\r\n            if(!middleware()) {\r\n              return;\r\n            }\r\n\r\n            player.addEventListener('firstFrame', () => {\r\n              if(!middleware()) {\r\n                // debugger;\r\n                return;\r\n              }\r\n\r\n              hoverReaction.dataset.loaded = '1';\r\n              this.setHoverVisible(hoverReaction, true);\r\n            }, {once: true});\r\n\r\n            attachClickEvent(hoverReaction, (e) => {\r\n              cancelEvent(e); // cancel triggering selection\r\n\r\n              this.managers.appReactionsManager.sendReaction(message, availableReaction.reaction);\r\n              this.unhoverPrevious();\r\n            }, {listenerSetter: this.listenerSetter});\r\n          });\r\n        });\r\n      } else if(hoverReaction.dataset.loaded) {\r\n        this.setHoverVisible(hoverReaction, true);\r\n      }\r\n    } else {\r\n      this.unhoverPrevious();\r\n    }\r\n  };\r\n\r\n  public setReactionsHoverListeners() {\r\n    this.listenerSetter.add(contextMenuController)('toggle', this.unhoverPrevious);\r\n    this.listenerSetter.add(overlayCounter)('change', this.unhoverPrevious);\r\n    this.listenerSetter.add(this.chat.selection)('toggle', this.unhoverPrevious);\r\n    this.listenerSetter.add(this.container)('mousemove', this.onBubblesMouseMove);\r\n  }\r\n\r\n  private setHoverVisible(hoverReaction: HTMLElement, visible: boolean) {\r\n    SetTransition(hoverReaction, 'is-visible', visible, 200, visible ? undefined : () => {\r\n      hoverReaction.remove();\r\n    }, 2);\r\n  }\r\n\r\n  private unhoverPrevious = () => {\r\n    const {hoverBubble, hoverReaction} = this;\r\n    if(hoverBubble) {\r\n      this.setHoverVisible(hoverReaction, false);\r\n      this.hoverBubble = undefined;\r\n      this.hoverReaction = undefined;\r\n    }\r\n  };\r\n\r\n  public setStickyDateManually() {\r\n    return;\r\n\r\n    const timestamps = Object.keys(this.dateMessages).map((k) => +k).sort((a, b) => b - a);\r\n    let lastVisible: HTMLElement;\r\n\r\n    // if(this.chatInner.classList.contains('is-scrolling')) {\r\n      const {scrollTop} = this.scrollable.container;\r\n      const isOverflown = scrollTop > 0;\r\n      if(isOverflown) {\r\n        for(const timestamp of timestamps) {\r\n          const dateMessage = this.dateMessages[timestamp];\r\n          const visibleRect = getVisibleRect(dateMessage.container, this.scrollable.container);\r\n          if(visibleRect && visibleRect.overflow.top) {\r\n            lastVisible = dateMessage.div;\r\n          } else if(lastVisible) {\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    // }\r\n\r\n    if(lastVisible === this.previousStickyDate) {\r\n      return;\r\n    }\r\n\r\n    if(lastVisible) {\r\n      const needReflow = /* !!this.chat.setPeerPromise ||  */!this.previousStickyDate;\r\n      if(needReflow) {\r\n        lastVisible.classList.add('no-transition');\r\n      }\r\n\r\n      lastVisible.classList.add('is-sticky');\r\n\r\n      if(needReflow) {\r\n        void lastVisible.offsetLeft; // reflow\r\n        lastVisible.classList.remove('no-transition');\r\n      }\r\n    }\r\n\r\n    if(this.previousStickyDate && this.previousStickyDate !== lastVisible) {\r\n      this.previousStickyDate.classList.remove('is-sticky');\r\n    }\r\n\r\n    this.previousStickyDate = lastVisible;\r\n  }\r\n\r\n  public getRenderedLength() {\r\n    return Object.keys(this.bubbles).length - this.skippedMids.size;\r\n  }\r\n\r\n  private onUnreadedInViewport(target: HTMLElement, mid: number) {\r\n    this.unreadedSeen.add(mid);\r\n    this.observer.unobserve(target, this.unreadedObserverCallback);\r\n    this.unreaded.delete(target);\r\n    this.readUnreaded();\r\n  }\r\n\r\n  private readUnreaded() {\r\n    if(this.readPromise) return;\r\n\r\n    const middleware = this.getMiddleware();\r\n    this.readPromise = idleController.getFocusPromise().then(async() => {\r\n      if(!middleware()) return;\r\n      let maxId = Math.max(...Array.from(this.unreadedSeen));\r\n\r\n      // ? if message with maxId is not rendered ?\r\n      if(this.scrollable.loadedAll.bottom) {\r\n        const bubblesMaxId = Math.max(...Object.keys(this.bubbles).map((i) => +i));\r\n        if(maxId >= bubblesMaxId) {\r\n          maxId = Math.max((await this.chat.getHistoryMaxId()) || 0, maxId);\r\n        }\r\n      }\r\n\r\n      this.unreaded.forEach((mid, target) => {\r\n        if(mid <= maxId) {\r\n          this.onUnreadedInViewport(target, mid);\r\n        }\r\n      });\r\n\r\n      const readContents: number[] = [];\r\n      for(const mid of this.unreadedSeen) {\r\n        const message: MyMessage = await this.chat.getMessage(mid);\r\n        if(isMentionUnread(message)) {\r\n          readContents.push(mid);\r\n        }\r\n      }\r\n\r\n      this.managers.appMessagesManager.readMessages(this.peerId, readContents);\r\n\r\n      this.unreadedSeen.clear();\r\n\r\n      if(DEBUG) {\r\n        this.log('will readHistory by maxId:', maxId);\r\n      }\r\n\r\n      // return;\r\n      \r\n      return this.managers.appMessagesManager.readHistory(this.peerId, maxId, this.chat.threadId).catch((err: any) => {\r\n        this.log.error('readHistory err:', err);\r\n        this.managers.appMessagesManager.readHistory(this.peerId, maxId, this.chat.threadId);\r\n      }).finally(() => {\r\n        if(!middleware()) return;\r\n        this.readPromise = undefined;\r\n\r\n        if(this.unreadedSeen.size) {\r\n          this.readUnreaded();\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  public constructPinnedHelpers() {\r\n    this.listenerSetter.add(rootScope)('peer_pinned_messages', (e) => {\r\n      const {peerId, mids, pinned} = e;\r\n      if(peerId !== this.peerId) return;\r\n\r\n      if(mids) {\r\n        if(!pinned) {\r\n          this.deleteMessagesByIds(mids);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  public constructScheduledHelpers() {\r\n    const onUpdate = async() => {\r\n      this.chat.topbar.setTitle((await this.managers.appMessagesManager.getScheduledMessagesStorage(this.peerId)).size);\r\n    };\r\n\r\n    this.listenerSetter.add(rootScope)('scheduled_new', (message) => {\r\n      if(message.peerId !== this.peerId) return;\r\n\r\n      this.renderNewMessage(message);\r\n      onUpdate();\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('scheduled_delete', ({peerId, mids}) => {\r\n      if(peerId !== this.peerId) return;\r\n\r\n      this.deleteMessagesByIds(mids);\r\n      onUpdate();\r\n    });\r\n  }\r\n\r\n  public onBubblesClick = async(e: Event) => {\r\n    let target = e.target as HTMLElement;\r\n    let bubble: HTMLElement = null;\r\n    try {\r\n      bubble = findUpClassName(target, 'bubble');\r\n    } catch(err) {}\r\n    \r\n    if(!bubble && !this.chat.selection.isSelecting) {\r\n      const avatar = findUpClassName(target, 'user-avatar');\r\n      if(!avatar) {\r\n        return;\r\n      }\r\n\r\n      const peerId = avatar.dataset.peerId.toPeerId();\r\n      if(peerId !== NULL_PEER_ID) {\r\n        this.chat.appImManager.setInnerPeer({peerId});\r\n      } else {\r\n        toast(I18n.format('HidAccount', true));\r\n      }\r\n      return;\r\n    }\r\n\r\n    if(bubble.classList.contains('is-date') && findUpClassName(target, 'bubble-content')) {\r\n      if(bubble.classList.contains('is-sticky') && !this.chatInner.classList.contains('is-scrolling')) {\r\n        return;\r\n      }\r\n\r\n      for(const timestamp in this.dateMessages) {\r\n        const d = this.dateMessages[timestamp];\r\n        if(d.div === bubble) {\r\n          PopupElement.createPopup(PopupDatePicker, new Date(+timestamp), this.onDatePick).show();\r\n          break;\r\n        }\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    if(!IS_TOUCH_SUPPORTED && findUpClassName(target, 'time')) {\r\n      this.chat.selection.toggleByElement(bubble);\r\n      return;\r\n    }\r\n\r\n    // ! Trusted - due to audio autoclick\r\n    if(this.chat.selection.isSelecting && e.isTrusted) {\r\n      if(bubble.classList.contains('service') && bubble.dataset.mid === undefined) {\r\n        return;\r\n      }\r\n\r\n      cancelEvent(e);\r\n      //console.log('bubble click', e);\r\n\r\n      if(IS_TOUCH_SUPPORTED && this.chat.selection.selectedText) {\r\n        this.chat.selection.selectedText = undefined;\r\n        return;\r\n      }\r\n\r\n      //this.chatSelection.toggleByBubble(bubble);\r\n      this.chat.selection.toggleByElement(findUpClassName(target, 'grouped-item') || bubble);\r\n      return;\r\n    }\r\n\r\n    const contactDiv: HTMLElement = findUpClassName(target, 'contact');\r\n    if(contactDiv) {\r\n      this.chat.appImManager.setInnerPeer({\r\n        peerId: contactDiv.dataset.peerId.toPeerId()\r\n      });\r\n      return;\r\n    }\r\n\r\n    const callDiv: HTMLElement = findUpClassName(target, 'bubble-call');\r\n    if(callDiv) {\r\n      this.chat.appImManager.callUser(this.peerId.toUserId(), callDiv.dataset.type as any);\r\n      return;\r\n    }\r\n\r\n    const buyButton: HTMLElement = findUpClassName(target, 'is-buy');\r\n    if(buyButton) {\r\n      cancelEvent(e);\r\n      \r\n      const message = await this.chat.getMessage(+bubble.dataset.mid);\r\n      if(!message) {\r\n        return;\r\n      }\r\n\r\n      new PopupPayment(message as Message.message);\r\n      return;\r\n    }\r\n\r\n    const reactionElement = findUpTag(target, 'REACTION-ELEMENT') as ReactionElement;\r\n    if(reactionElement) {\r\n      cancelEvent(e);\r\n      if(reactionElement.classList.contains('is-inactive')) {\r\n        return;\r\n      }\r\n\r\n      const reactionsElement = reactionElement.parentElement as ReactionsElement;\r\n      const reactionCount = reactionsElement.getReactionCount(reactionElement);\r\n\r\n      const message = reactionsElement.getMessage();\r\n      this.managers.appReactionsManager.sendReaction(message, reactionCount.reaction);\r\n\r\n      return;\r\n    }\r\n\r\n    const commentsDiv: HTMLElement = findUpClassName(target, 'replies');\r\n    if(commentsDiv) {\r\n      const bubbleMid = +bubble.dataset.mid;\r\n      if(this.peerId === REPLIES_PEER_ID) {\r\n        const message = await this.chat.getMessage(bubbleMid) as Message.message;\r\n        const peerId = getPeerId(message.reply_to.reply_to_peer_id);\r\n        const threadId = message.reply_to.reply_to_top_id;\r\n        const lastMsgId = message.fwd_from.saved_from_msg_id;\r\n        this.chat.appImManager.openThread(peerId, lastMsgId, threadId);\r\n      } else {\r\n        const message1 = await this.chat.getMessage(bubbleMid);\r\n        const message = await this.managers.appMessagesManager.getMessageWithReplies(message1 as Message.message);\r\n        const replies = message.replies;\r\n        if(replies) {\r\n          this.managers.appMessagesManager.getDiscussionMessage(this.peerId, message.mid).then((message) => {\r\n            this.chat.appImManager.setInnerPeer({\r\n              peerId: replies.channel_id.toPeerId(true),\r\n              type: 'discussion', \r\n              threadId: (message as MyMessage).mid\r\n            });\r\n          });\r\n        }\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    const via = findUpClassName(target, 'is-via');\r\n    if(via) {\r\n      const el = via.querySelector('.peer-title') as HTMLElement;\r\n      if(target === el || findUpAsChild(target, el)) {\r\n        const message = el.innerText + ' ';\r\n        this.managers.appDraftsManager.setDraft(this.peerId, this.chat.threadId, message);\r\n        cancelEvent(e);\r\n        \r\n        return;\r\n      }\r\n    }\r\n\r\n    const nameDiv = findUpClassName(target, 'peer-title') || findUpTag(target, 'AVATAR-ELEMENT') || findUpAttribute(target, 'data-saved-from');\r\n    if(nameDiv && nameDiv !== bubble) {\r\n      target = nameDiv || target;\r\n      const peerIdStr = target.dataset.peerId || target.getAttribute('peer') || (target as AvatarElement).peerId;\r\n      const savedFrom = target.dataset.savedFrom;\r\n      if(typeof(peerIdStr) === 'string' || savedFrom) {\r\n        if(savedFrom) {\r\n          const [peerId, mid] = savedFrom.split('_');\r\n          if(target.classList.contains('is-receipt-link')) {\r\n            const message = await this.managers.appMessagesManager.getMessageByPeer(peerId.toPeerId(), +mid);\r\n            if(message) {\r\n              new PopupPayment(message as Message.message, this.peerId, +bubble.dataset.mid);\r\n            }\r\n          } else {\r\n            this.chat.appImManager.setInnerPeer({\r\n              peerId: peerId.toPeerId(), \r\n              lastMsgId: +mid\r\n            });\r\n          }\r\n        } else {\r\n          const peerId = peerIdStr.toPeerId();\r\n          if(peerId !== NULL_PEER_ID) {\r\n            this.chat.appImManager.setInnerPeer({peerId});\r\n          } else {\r\n            toast(I18n.format('HidAccount', true));\r\n          }\r\n        }\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    //this.log('chatInner click:', target);\r\n    // const isVideoComponentElement = target.tagName === 'SPAN' && findUpClassName(target, 'media-container');\r\n    /* if(isVideoComponentElement) {\r\n      const video = target.parentElement.querySelector('video') as HTMLElement;\r\n      if(video) {\r\n        video.click(); // hot-fix for time and play button\r\n        return;\r\n      }\r\n    } */\r\n\r\n    if(bubble.classList.contains('sticker') && target.parentElement.classList.contains('attachment')) {\r\n      const messageId = +bubble.dataset.mid;\r\n      const message = await this.chat.getMessage(messageId);\r\n\r\n      const doc = ((message as Message.message).media as MessageMedia.messageMediaDocument)?.document as Document.document;\r\n\r\n      if(doc?.stickerSetInput) {\r\n        new PopupStickers(doc.stickerSetInput).show();\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    const documentDiv = findUpClassName(target, 'document-with-thumb');\r\n    if((target.tagName === 'IMG' && !target.classList.contains('emoji') && !target.classList.contains('document-thumb')) \r\n      || target.classList.contains('album-item')\r\n      // || isVideoComponentElement\r\n      || (target.tagName === 'VIDEO' && !bubble.classList.contains('round'))\r\n      || (documentDiv && !documentDiv.querySelector('.preloader-container'))\r\n      || target.classList.contains('canvas-thumbnail')) {\r\n      const groupedItem = findUpClassName(target, 'album-item') || findUpClassName(target, 'document-container');\r\n      const preloader = (groupedItem || bubble).querySelector<HTMLElement>('.preloader-container');\r\n      if(preloader) {\r\n        simulateClickEvent(preloader);\r\n        cancelEvent(e);\r\n        return;\r\n      }\r\n\r\n      cancelEvent(e);\r\n      const messageId = +(groupedItem || bubble).dataset.mid;\r\n      const message = await this.chat.getMessage(messageId);\r\n      if(!message) {\r\n        this.log.warn('no message by messageId:', messageId);\r\n        return;\r\n      }\r\n\r\n      const SINGLE_MEDIA_CLASSNAME = 'webpage';\r\n      const isSingleMedia = bubble.classList.contains(SINGLE_MEDIA_CLASSNAME);\r\n\r\n      const f = documentDiv ? (media: any) => {\r\n        return AppMediaViewer.isMediaCompatibleForDocumentViewer(media);\r\n      } : (media: any) => {\r\n        return media._ === 'photo' || ['video', 'gif'].includes(media.type);\r\n      };\r\n\r\n      const targets: {element: HTMLElement, mid: number, peerId: PeerId}[] = [];\r\n      const ids = isSingleMedia ? [messageId] : (await Promise.all(Object.keys(this.bubbles).map((k) => +k).map(async(mid) => {\r\n        /* if(isSingleMedia && !this.bubbles[id].classList.contains(SINGLE_MEDIA_CLASSNAME)) {\r\n          return false;\r\n        }  */\r\n        //if(!this.scrollable.visibleElements.find((e) => e.element === this.bubbles[id])) return false;\r\n\r\n        const message = await this.chat.getMessage(mid);\r\n        const media = getMediaFromMessage(message);\r\n        \r\n        return media && f(media) && mid;\r\n      }))).filter(Boolean).sort((a, b) => a - b);\r\n\r\n      ids.forEach((id) => {\r\n        let selector: string;\r\n        if(documentDiv) {\r\n          selector = '.document-container';\r\n        } else {\r\n          const withTail = this.bubbles[id].classList.contains('with-media-tail');\r\n          selector = '.album-item video, .album-item img, .preview video, .preview img, ';\r\n          if(withTail) {\r\n            selector += '.bubble__media-container';\r\n          } else {\r\n            selector += '.attachment video, .attachment img';\r\n          }\r\n        }\r\n\r\n        const elements = Array.from(this.bubbles[id].querySelectorAll(selector)) as HTMLElement[];\r\n        const parents: Set<HTMLElement> = new Set();\r\n        if(documentDiv) {\r\n          elements.forEach((element) => {\r\n            targets.push({\r\n              element: element.querySelector('.document-ico'),\r\n              mid: +element.dataset.mid,\r\n              peerId: this.peerId\r\n            });\r\n          });\r\n        } else {\r\n          const hasAspecter = !!this.bubbles[id].querySelector('.media-container-aspecter');\r\n          elements.forEach((element) => {\r\n            if(hasAspecter && !findUpClassName(element, 'media-container-aspecter')) return;\r\n            let albumItem = findUpClassName(element, 'album-item');\r\n            const parent = albumItem || element.parentElement;\r\n            if(parents.has(parent)) return;\r\n            parents.add(parent);\r\n            targets.push({\r\n              element,\r\n              mid: albumItem ? +albumItem.dataset.mid : id,\r\n              peerId: this.peerId\r\n            });\r\n          });\r\n        }\r\n      });\r\n\r\n      targets.sort((a, b) => a.mid - b.mid);\r\n\r\n      let idx = targets.findIndex((t) => t.mid === messageId);\r\n\r\n      if(DEBUG) {\r\n        this.log('open mediaViewer single with ids:', ids, idx, targets);\r\n      }\r\n\r\n      if(!targets[idx]) {\r\n        this.log('no target for media viewer!', target);\r\n        return;\r\n      }\r\n\r\n      new AppMediaViewer()\r\n      .setSearchContext({\r\n        threadId: this.chat.threadId,\r\n        peerId: this.peerId,\r\n        inputFilter: {_: documentDiv ? 'inputMessagesFilterDocument' : 'inputMessagesFilterPhotoVideo'},\r\n        useSearch: this.chat.type !== 'scheduled' && !isSingleMedia,\r\n        isScheduled: this.chat.type === 'scheduled'\r\n      })\r\n      .openMedia(message, targets[idx].element, 0, true, targets.slice(0, idx), targets.slice(idx + 1));\r\n      \r\n      //appMediaViewer.openMedia(message, target as HTMLImageElement);\r\n      return;\r\n    }\r\n    \r\n    if(['IMG', 'DIV', 'SPAN'/* , 'A' */].indexOf(target.tagName) === -1) target = findUpTag(target, 'DIV');\r\n    \r\n    if(['DIV', 'SPAN'].indexOf(target.tagName) !== -1/*  || target.tagName === 'A' */) {\r\n      if(target.classList.contains('goto-original')) {\r\n        const savedFrom = bubble.dataset.savedFrom;\r\n        const [peerId, mid] = savedFrom.split('_');\r\n        ////this.log('savedFrom', peerId, msgID);\r\n        this.chat.appImManager.setInnerPeer({\r\n          peerId: peerId.toPeerId(), \r\n          lastMsgId: +mid\r\n        });\r\n        return;\r\n      } else if(target.classList.contains('forward')) {\r\n        const mid = +bubble.dataset.mid;\r\n        const message = await this.managers.appMessagesManager.getMessageByPeer(this.peerId, mid);\r\n        new PopupForward({\r\n          [this.peerId]: await this.managers.appMessagesManager.getMidsByMessage(message)\r\n        });\r\n        //appSidebarRight.forwardTab.open([mid]);\r\n        return;\r\n      }\r\n      \r\n      let isReplyClick = false;\r\n      \r\n      try {\r\n        isReplyClick = !!findUpClassName(e.target, 'reply');\r\n      } catch(err) {}\r\n      \r\n      if(isReplyClick && bubble.classList.contains('is-reply')/*  || bubble.classList.contains('forwarded') */) {\r\n        const bubbleMid = +bubble.dataset.mid;\r\n        this.replyFollowHistory.push(bubbleMid);\r\n\r\n        const message = (await this.chat.getMessage(bubbleMid)) as Message.message;\r\n\r\n        const replyToPeerId = message.reply_to.reply_to_peer_id ? getPeerId(message.reply_to.reply_to_peer_id) : this.peerId;\r\n        const replyToMid = message.reply_to.reply_to_msg_id;\r\n\r\n        this.chat.appImManager.setInnerPeer({\r\n          peerId: replyToPeerId, \r\n          lastMsgId: replyToMid, \r\n          type: this.chat.type, \r\n          threadId: this.chat.threadId\r\n        });\r\n\r\n        /* if(this.chat.type === 'discussion') {\r\n          this.chat.appImManager.setMessageId(, originalMessageId);\r\n        } else {\r\n          this.chat.appImManager.setInnerPeer(this.peerId, originalMessageId);\r\n        } */\r\n        //this.chat.setMessageId(, originalMessageId);\r\n      }\r\n    }\r\n    \r\n    //console.log('chatInner click', e);\r\n  };\r\n\r\n  public async onGoDownClick() {\r\n    if(!this.replyFollowHistory.length) {\r\n      this.chat.setMessageId(/* , dialog.top_message */);\r\n      // const dialog = this.appMessagesManager.getDialogByPeerId(this.peerId)[0];\r\n      \r\n      // if(dialog) {\r\n      //   this.chat.setPeer(this.peerId/* , dialog.top_message */);\r\n      // } else {\r\n      //   this.log('will scroll down 3');\r\n      //   this.scroll.scrollTop = this.scroll.scrollHeight;\r\n      // }\r\n\r\n      return;\r\n    }\r\n\r\n    const middleware = this.getMiddleware();\r\n    const slice = this.replyFollowHistory.slice();\r\n    const messages = await Promise.all(slice.map((mid) => this.chat.getMessage(mid)));\r\n    if(!middleware()) return;\r\n\r\n    slice.forEach((mid, idx) => {\r\n      const message = messages[idx];\r\n\r\n      const bubble = this.bubbles[mid];\r\n      let bad = true;\r\n      if(bubble) {\r\n        const rect = bubble.getBoundingClientRect();\r\n        bad = (windowSize.height / 2) > rect.top;\r\n      } else if(message) {\r\n        bad = false;\r\n      }\r\n\r\n      if(bad) {\r\n        this.replyFollowHistory.splice(this.replyFollowHistory.indexOf(mid), 1);\r\n      }\r\n    });\r\n\r\n    this.replyFollowHistory.sort((a, b) => b - a);\r\n\r\n    const mid = this.replyFollowHistory.pop();\r\n    this.chat.setMessageId(mid);\r\n  }\r\n\r\n  public getBubbleByPoint(verticalSide: 'top' | 'bottom') {\r\n    let element = getElementByPoint(this.scrollable.container, verticalSide, 'center');\r\n    /* if(element) {\r\n      if(element.classList.contains('bubbles-date-group')) {\r\n        const children = Array.from(element.children) as HTMLElement[];\r\n        if(verticalSide === 'top') {\r\n          element = children[this.stickyIntersector ? 2 : 1];\r\n        } else {\r\n          element = children[children.length - 1];\r\n        }\r\n      } else {\r\n        element = findUpClassName(element, 'bubble');\r\n        if(element && element.classList.contains('is-date')) {\r\n          element = element.nextElementSibling as HTMLElement;\r\n        }\r\n      }\r\n    } */\r\n    if(element) element = findUpClassName(element, 'bubble');\r\n\r\n    return element;\r\n  }\r\n\r\n  public async getGroupedBubble(groupId: string) {\r\n    const mids = await this.managers.appMessagesManager.getMidsByAlbum(groupId);\r\n    for(const mid of mids) {\r\n      if(this.bubbles[mid] && !this.skippedMids.has(mid)) {\r\n        // const maxId = Math.max(...mids); // * because in scheduled album can be rendered by lowest mid during sending\r\n        return {\r\n          bubble: this.bubbles[mid], \r\n          mid: mid,\r\n          // message: await this.chat.getMessage(maxId) as Message.message\r\n        };\r\n      }\r\n    }\r\n  }\r\n\r\n  public getBubbleGroupedItems(bubble: HTMLElement) {\r\n    return Array.from(bubble.querySelectorAll('.grouped-item')) as HTMLElement[];\r\n  }\r\n\r\n  public async getMountedBubble(mid: number, message?: Message.message | Message.messageService) {\r\n    if(message === undefined) {\r\n      message = await this.chat.getMessage(mid);\r\n    }\r\n\r\n    if(!message) {\r\n      return;\r\n    }\r\n\r\n    const groupedId = (message as Message.message).grouped_id;\r\n    if(groupedId) {\r\n      const a = await this.getGroupedBubble(groupedId);\r\n      if(a) {\r\n        a.bubble = a.bubble.querySelector(`.document-container[data-mid=\"${mid}\"]`) || a.bubble;\r\n        return a;\r\n      }\r\n    }\r\n\r\n    const bubble = this.bubbles[mid];\r\n    if(!bubble) return;\r\n\r\n    return {bubble, mid};\r\n  }\r\n\r\n  private findNextMountedBubbleByMsgId(mid: number, prev?: boolean) {\r\n    const mids = getObjectKeysAndSort(this.bubbles, prev ? 'desc' : 'asc');\r\n\r\n    let filterCallback: (_mid: number) => boolean;\r\n    if(prev) filterCallback = (_mid) => _mid < mid;\r\n    else filterCallback = (_mid) => mid < _mid;\r\n\r\n    const foundMid = mids.find((_mid) => {\r\n      if(!filterCallback(_mid)) return false;\r\n      return !!this.bubbles[_mid]?.parentElement;\r\n    });\r\n\r\n    return this.bubbles[foundMid];\r\n  }\r\n\r\n  public loadMoreHistory(top: boolean, justLoad = false) {\r\n    //this.log('loadMoreHistory', top);\r\n    if(\r\n      !this.peerId || \r\n      /* TEST_SCROLL || */ \r\n      this.chat.setPeerPromise || \r\n      this.isHeavyAnimationInProgress || \r\n      (top && (this.getHistoryTopPromise || this.scrollable.loadedAll.top)) || \r\n      (!top && (this.getHistoryBottomPromise || this.scrollable.loadedAll.bottom))\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    // warning,         (     )\r\n    // some messages can have negative id (such as sponsored message)\r\n    const history = Object.keys(this.bubbles)\r\n    .map((id) => +id)\r\n    .filter((id) => id > 0 && !this.skippedMids.has(id))\r\n    .sort((a, b) => a - b);\r\n    if(!history.length) return;\r\n    \r\n    if(top) {\r\n      if(DEBUG) {\r\n        this.log('Will load more (up) history by id:', history[0], 'maxId:', history[history.length - 1], justLoad/* , history */);\r\n      }\r\n\r\n      this.getHistory1(history[0], true, undefined, undefined, justLoad);\r\n    } else {\r\n      //let dialog = this.appMessagesManager.getDialogByPeerId(this.peerId)[0];\r\n      // const historyMaxId = await this.chat.getHistoryMaxId();\r\n          \r\n      // // if scroll down after search\r\n      // if(history.indexOf(historyMaxId) !== -1) {\r\n      //   this.setLoaded('bottom', true);\r\n      //   return;\r\n      // }\r\n\r\n      if(DEBUG) {\r\n        this.log('Will load more (down) history by id:', history[history.length - 1], justLoad/* , history */);\r\n      }\r\n\r\n      this.getHistory1(history[history.length - 1], false, true, undefined, justLoad);\r\n    }\r\n  }\r\n\r\n  public onScroll = (ignoreHeavyAnimation?: boolean, scrollDimensions?: ScrollStartCallbackDimensions) => {\r\n    // return;\r\n\r\n    if(this.isHeavyAnimationInProgress) {\r\n      if(this.sliceViewportDebounced) {\r\n        this.sliceViewportDebounced.clearTimeout();\r\n      }\r\n\r\n      // *   ,         ,          \r\n      if(this.scrolledDown && !ignoreHeavyAnimation) {\r\n        return;\r\n      }\r\n    } else {\r\n      if(this.chat.topbar.pinnedMessage) {\r\n        this.chat.topbar.pinnedMessage.setCorrectIndexThrottled(this.scrollable.lastScrollDirection);\r\n      }\r\n  \r\n      if(this.sliceViewportDebounced) {\r\n        this.sliceViewportDebounced();\r\n      }\r\n  \r\n      this.setStickyDateManually();\r\n    }\r\n    \r\n    //lottieLoader.checkAnimations(false, 'chat');\r\n\r\n    if(scrollDimensions && scrollDimensions.distanceToEnd < SCROLLED_DOWN_THRESHOLD && this.scrolledDown) {\r\n      return;\r\n    }\r\n\r\n    const distanceToEnd = scrollDimensions?.distanceToEnd ?? this.scrollable.getDistanceToEnd();\r\n    if(/* !IS_TOUCH_SUPPORTED &&  */(this.scrollable.lastScrollDirection !== 0 && distanceToEnd > 0) || scrollDimensions) {\r\n    // if(/* !IS_TOUCH_SUPPORTED &&  */(this.scrollable.lastScrollDirection !== 0 || scrollDimensions) && distanceToEnd > 0) {\r\n      if(this.isScrollingTimeout) {\r\n        clearTimeout(this.isScrollingTimeout);\r\n      } else if(!this.chatInner.classList.contains('is-scrolling')) {\r\n        this.chatInner.classList.add('is-scrolling');\r\n      }\r\n  \r\n      this.isScrollingTimeout = window.setTimeout(() => {\r\n        this.chatInner.classList.remove('is-scrolling');\r\n        this.isScrollingTimeout = 0;\r\n      }, 1350 + (scrollDimensions?.duration ?? 0));\r\n    }\r\n    \r\n    if(distanceToEnd < SCROLLED_DOWN_THRESHOLD && (this.scrollable.loadedAll.bottom || this.chat.setPeerPromise || !this.peerId)) {\r\n      this.container.classList.add('scrolled-down');\r\n      this.scrolledDown = true;\r\n    } else if(this.container.classList.contains('scrolled-down')) {\r\n      this.container.classList.remove('scrolled-down');\r\n      this.scrolledDown = false;\r\n    }\r\n  };\r\n\r\n  public setScroll() {\r\n    if(this.scrollable) {\r\n      this.destroyScrollable();\r\n    }\r\n\r\n    this.scrollable = new Scrollable(null, 'IM', /* 10300 */300);\r\n    this.setLoaded('top', false, false);\r\n    this.setLoaded('bottom', false, false);\r\n\r\n    this.scrollable.container.append(this.chatInner);\r\n\r\n    /* const getScrollOffset = () => {\r\n      //return Math.round(Math.max(300, appPhotosManager.windowH / 1.5));\r\n      return 300; \r\n    };\r\n\r\n    window.addEventListener('resize', () => {\r\n      this.scrollable.onScrollOffset = getScrollOffset();\r\n    });\r\n\r\n    this.scrollable = new Scrollable(this.bubblesContainer, 'y', 'IM', this.chatInner, getScrollOffset()); */\r\n\r\n    this.scrollable.onAdditionalScroll = this.onScroll;\r\n    this.scrollable.onScrolledTop = () => this.loadMoreHistory(true);\r\n    this.scrollable.onScrolledBottom = () => this.loadMoreHistory(false);\r\n    //this.scrollable.attachSentinels(undefined, 300);\r\n\r\n    if(IS_TOUCH_SUPPORTED && false) {\r\n      this.scrollable.container.addEventListener('touchmove', () => {\r\n        if(this.isScrollingTimeout) {\r\n          clearTimeout(this.isScrollingTimeout);\r\n        } else if(!this.chatInner.classList.contains('is-scrolling')) {\r\n          this.chatInner.classList.add('is-scrolling');\r\n        }\r\n      }, {passive: true});\r\n\r\n      this.scrollable.container.addEventListener('touchend', () => {\r\n        if(!this.chatInner.classList.contains('is-scrolling')) {\r\n          return;\r\n        }\r\n\r\n        if(this.isScrollingTimeout) {\r\n          clearTimeout(this.isScrollingTimeout);\r\n        }\r\n\r\n        this.isScrollingTimeout = window.setTimeout(() => {\r\n          this.chatInner.classList.remove('is-scrolling');\r\n          this.isScrollingTimeout = 0;\r\n        }, 1350);\r\n      }, {passive: true});\r\n    }\r\n  }\r\n\r\n  public async updateUnreadByDialog() {\r\n    const historyStorage = await this.chat.getHistoryStorage();\r\n    const maxId = this.peerId === rootScope.myId ? historyStorage.readMaxId : historyStorage.readOutboxMaxId;\r\n    \r\n    ///////this.log('updateUnreadByDialog', maxId, dialog, this.unreadOut);\r\n    \r\n    for(const msgId of this.unreadOut) {\r\n      if(msgId > 0 && msgId <= maxId) {\r\n        const bubble = this.bubbles[msgId];\r\n        if(bubble) {\r\n          this.unreadOut.delete(msgId);\r\n\r\n          if(bubble.classList.contains('is-outgoing')) {\r\n            continue;\r\n          }\r\n          \r\n          bubble.classList.remove('is-sent', 'is-sending', 'is-outgoing'); // is-sending can be when there are bulk of updates (e.g. sending command to Stickers bot)\r\n          bubble.classList.add('is-read');\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  public deleteMessagesByIds(mids: number[], permanent = true, ignoreOnScroll?: boolean) {\r\n    let deleted = false;\r\n    mids.forEach((mid) => {\r\n      const bubble = this.bubbles[mid];\r\n      if(!bubble) return;\r\n      \r\n      deleted = true;\r\n      /* const mounted = this.getMountedBubble(mid);\r\n      if(!mounted) return; */\r\n\r\n      delete this.bubbles[mid];\r\n      this.skippedMids.delete(mid);\r\n\r\n      if(this.firstUnreadBubble === bubble) {\r\n        this.firstUnreadBubble = null;\r\n      }\r\n\r\n      this.bubbleGroups.removeAndUnmountBubble(bubble);\r\n      if(this.observer) {\r\n        this.observer.unobserve(bubble, this.unreadedObserverCallback);\r\n        this.unreaded.delete(bubble);\r\n\r\n        this.observer.unobserve(bubble, this.viewsObserverCallback);\r\n        this.viewsMids.delete(mid);\r\n      }\r\n\r\n      if(this.emptyPlaceholderBubble === bubble) {\r\n        this.emptyPlaceholderBubble = undefined;\r\n      }\r\n\r\n      // this.reactions.delete(mid);\r\n    });\r\n\r\n    if(!deleted) {\r\n      return;\r\n    }\r\n\r\n    this.scrollable.ignoreNextScrollEvent();\r\n    if(permanent && this.chat.selection.isSelecting) {\r\n      this.chat.selection.deleteSelectedMids(this.peerId, mids);\r\n    }\r\n    \r\n    animationIntersector.checkAnimations(false, CHAT_ANIMATION_GROUP);\r\n    this.deleteEmptyDateGroups();\r\n\r\n    if(!ignoreOnScroll) {\r\n      this.scrollable.onScroll();\r\n      // this.onScroll();\r\n    }\r\n  }\r\n\r\n  private setTopPadding(middleware = this.getMiddleware()) {\r\n    let isPaddingNeeded = false;\r\n    let setPaddingTo: HTMLElement;\r\n    if(!this.isTopPaddingSet && this.chat.type !== 'scheduled') {\r\n      const {clientHeight, scrollHeight} = this.scrollable.container;\r\n      isPaddingNeeded = clientHeight === scrollHeight;\r\n      /* const firstEl = this.chatInner.firstElementChild as HTMLElement;\r\n      if(this.chatInner.firstElementChild) {\r\n        const visibleRect = getVisibleRect(firstEl, this.scrollable.container);\r\n        isPaddingNeeded = !visibleRect.overflow.top && (visibleRect.rect.top - firstEl.offsetTop) !== this.scrollable.container.getBoundingClientRect().top;\r\n      } else {\r\n        isPaddingNeeded = true;\r\n      } */\r\n\r\n      if(isPaddingNeeded) {\r\n        /* const add = clientHeight - scrollHeight;\r\n        this.chatInner.style.paddingTop = add + 'px';\r\n        this.scrollable.scrollTop += add; */\r\n        setPaddingTo = this.chatInner;\r\n        setPaddingTo.style.paddingTop = clientHeight + 'px';\r\n        this.scrollable.setScrollTopSilently(scrollHeight);\r\n        this.isTopPaddingSet = true;\r\n      }\r\n    }\r\n\r\n    return {\r\n      isPaddingNeeded,\r\n      unsetPadding: isPaddingNeeded ? () => {\r\n        if(middleware() && isPaddingNeeded) {\r\n          setPaddingTo.style.paddingTop = '';\r\n          this.isTopPaddingSet = false;\r\n        }\r\n      } : undefined\r\n    };\r\n  }\r\n\r\n  private renderNewMessage(message: MyMessage, scrolledDown?: boolean) {\r\n    const promise = this._renderNewMessage(message, scrolledDown);\r\n    this.renderNewPromises.add(promise);\r\n    promise.catch(noop).finally(() => {\r\n      this.renderNewPromises.delete(promise);\r\n    });\r\n    return promise;\r\n  }\r\n  \r\n  private async _renderNewMessage(message: MyMessage, scrolledDown?: boolean) {\r\n    if(!this.scrollable.loadedAll.bottom) { // seems search active or sliced\r\n      //this.log('renderNewMessagesByIds: seems search is active, skipping render:', mids);\r\n      const setPeerPromise = this.chat.setPeerPromise;\r\n      if(setPeerPromise) {\r\n        const middleware = this.getMiddleware();\r\n        setPeerPromise.then(async() => {\r\n          if(!middleware()) return;\r\n          const newMessage = await this.chat.getMessage(message.mid);\r\n          if(!middleware()) return;\r\n          this.renderNewMessage(newMessage);\r\n        });\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    if(this.chat.threadId) {\r\n      const replyTo = message?.reply_to as MessageReplyHeader;\r\n      if(!(replyTo && (replyTo.reply_to_top_id || replyTo.reply_to_msg_id) === this.chat.threadId)) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    if(this.bubbles[message.mid]) {\r\n      return;\r\n    }\r\n    // ! should scroll even without new messages\r\n    /* if(!mids.length) {\r\n      return;\r\n    } */\r\n\r\n    if(!scrolledDown) {\r\n      scrolledDown = this.scrolledDown && (\r\n        !this.scrollingToBubble || \r\n        this.scrollingToBubble === this.getLastBubble() || \r\n        this.scrollingToBubble === this.chatInner\r\n      );\r\n    }\r\n\r\n    const middleware = this.getMiddleware();\r\n    const {isPaddingNeeded, unsetPadding} = this.setTopPadding(middleware);\r\n\r\n    const promise = this.performHistoryResult({history: [message]}, false);\r\n    if(scrolledDown) {\r\n      promise.then(() => {\r\n        if(!middleware()) return;\r\n        //this.log('renderNewMessagesByIDs: messagesQueuePromise after', this.scrollable.isScrolledDown);\r\n        //this.scrollable.scrollTo(this.scrollable.scrollHeight, 'top', true, true, 5000);\r\n        //const bubble = this.bubbles[Math.max(...mids)];\r\n\r\n        let bubble: HTMLElement;\r\n        if(this.chat.type === 'scheduled') {\r\n          bubble = this.bubbles[message.mid];\r\n        }\r\n\r\n        const promise = bubble ? this.scrollToBubbleEnd(bubble) : this.scrollToEnd();\r\n        if(isPaddingNeeded) {\r\n          // it will be called only once even if was set multiple times (that won't happen)\r\n          promise.then(unsetPadding);\r\n        }\r\n\r\n        //this.scrollable.scrollIntoViewNew(this.chatInner, 'end');\r\n\r\n        /* setTimeout(() => {\r\n          this.log('messagesQueuePromise afterafter:', this.chatInner.childElementCount, this.scrollable.scrollHeight);\r\n        }, 10); */\r\n      });\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  public getLastBubble() {\r\n    const group = this.bubbleGroups.getLastGroup();\r\n    return group?.lastItem?.bubble;\r\n  }\r\n\r\n  public scrollToBubble(\r\n    element: HTMLElement, \r\n    position: ScrollLogicalPosition,\r\n    forceDirection?: FocusDirection,\r\n    forceDuration?: number\r\n  ) {\r\n    const bubble = findUpClassName(element, 'bubble');\r\n\r\n    if(!element.parentElement) {\r\n      this.log.error('element is not connected', bubble);\r\n    }\r\n\r\n    let fallbackToElementStartWhenCentering: HTMLElement;\r\n    // * if it's a start, then scroll to start of the group\r\n    if(bubble && position !== 'end') {\r\n      const item = this.bubbleGroups.getItemByBubble(bubble);\r\n      if(item.group.firstItem === item && whichChild(item.group.container) === (this.stickyIntersector ? STICKY_OFFSET : 1)) {\r\n        const dateGroup = item.group.container.parentElement;\r\n        // if(whichChild(dateGroup) === 0) {\r\n          fallbackToElementStartWhenCentering = dateGroup;\r\n          // position = 'start';\r\n          // element = dateGroup;\r\n        // }\r\n      }\r\n    }\r\n\r\n    // const isLastBubble = this.getLastBubble() === bubble;\r\n    /* if(isLastBubble) {\r\n      element = this.getLastDateGroup();\r\n    } */\r\n\r\n    let margin = 4; // * 4 = .25rem\r\n    /* if(isLastBubble && this.chat.type === 'chat' && this.bubblesContainer.classList.contains('is-chat-input-hidden')) {\r\n      margin = 20;\r\n    } */\r\n\r\n    const isChangingHeight = (this.chat.input.messageInput && this.chat.input.messageInput.classList.contains('is-changing-height')) || this.chat.container.classList.contains('is-toggling-helper');\r\n    const promise = this.scrollable.scrollIntoViewNew({\r\n      element, \r\n      position, \r\n      margin, \r\n      forceDirection, \r\n      forceDuration, \r\n      axis: 'y', \r\n      getNormalSize: isChangingHeight ? ({rect}) => {\r\n        // return rect.height;\r\n\r\n        let height = windowSize.height;\r\n        // height -= this.chat.topbar.container.getBoundingClientRect().height;\r\n        height -= this.container.offsetTop;\r\n        height -= mediaSizes.isMobile || windowSize.height < 570 ? 58 : 78;\r\n        return height;\r\n\r\n        /* const rowsWrapperHeight = this.chat.input.rowsWrapper.getBoundingClientRect().height;\r\n        const diff = rowsWrapperHeight - 54;\r\n        return rect.height + diff; */\r\n      } : undefined,\r\n      fallbackToElementStartWhenCentering,\r\n      startCallback: (dimensions) => {\r\n        // this.onScroll(true, this.scrolledDown && dimensions.distanceToEnd <= SCROLLED_DOWN_THRESHOLD ? undefined : dimensions);\r\n        this.onScroll(true, dimensions);\r\n      }\r\n    });\r\n\r\n    // fix flickering date when opening unread chat and focusing message\r\n    if(forceDirection === FocusDirection.Static) {\r\n      this.scrollable.lastScrollPosition = this.scrollable.scrollTop;\r\n    }\r\n    \r\n    return promise;\r\n  }\r\n\r\n  public scrollToEnd() {\r\n    return this.scrollToBubbleEnd(this.chatInner);\r\n  }\r\n\r\n  public async scrollToBubbleEnd(bubble: HTMLElement) {\r\n    /* if(DEBUG) {\r\n      this.log('scrollToNewLastBubble: will scroll into view:', bubble);\r\n    } */\r\n\r\n    if(bubble) {\r\n      this.scrollingToBubble = bubble;\r\n      const middleware = this.getMiddleware();\r\n      await this.scrollToBubble(bubble, 'end', undefined, undefined);\r\n      if(!middleware()) return;\r\n      this.scrollingToBubble = undefined;\r\n    }\r\n  }\r\n\r\n  // ! can't get it by chatInner.lastElementChild because placeholder can be the last...\r\n  // private getLastDateGroup() {\r\n  //   let lastTime = 0, lastElem: HTMLElement;\r\n  //   for(const i in this.dateMessages) {\r\n  //     const dateMessage = this.dateMessages[i];\r\n  //     if(dateMessage.firstTimestamp > lastTime) {\r\n  //       lastElem = dateMessage.container;\r\n  //       lastTime = dateMessage.firstTimestamp;\r\n  //     }\r\n  //   }\r\n\r\n  //   return lastElem;\r\n  // }\r\n\r\n  public async scrollToBubbleIfLast(bubble: HTMLElement) {\r\n    if(this.getLastBubble() === bubble) {\r\n      // return this.scrollToBubbleEnd(bubble);\r\n      return this.scrollToEnd();\r\n    }\r\n  }\r\n\r\n  public highlightBubble(element: HTMLElement) {\r\n    const datasetKey = 'highlightTimeout';\r\n    if(element.dataset[datasetKey]) {\r\n      clearTimeout(+element.dataset[datasetKey]);\r\n      element.classList.remove('is-highlighted');\r\n      void element.offsetWidth; // reflow\r\n    }\r\n\r\n    element.classList.add('is-highlighted');\r\n    element.dataset[datasetKey] = '' + setTimeout(() => {\r\n      element.classList.remove('is-highlighted');\r\n      delete element.dataset[datasetKey];\r\n    }, 2000);\r\n  }\r\n\r\n  private createDateBubble(timestamp: number, date: Date = new Date(timestamp * 1000)) {\r\n    let dateElement: HTMLElement;\r\n      \r\n    const today = new Date();\r\n    today.setHours(0, 0, 0, 0);\r\n\r\n    const isScheduled = this.chat.type === 'scheduled';\r\n    \r\n    if(today.getTime() === date.getTime()) {\r\n      dateElement = i18n(isScheduled ? 'Chat.Date.ScheduledForToday' : 'Date.Today');\r\n    } else if(isScheduled && timestamp === SEND_WHEN_ONLINE_TIMESTAMP) {\r\n      dateElement = i18n('MessageScheduledUntilOnline');\r\n    } else {\r\n      const options: Intl.DateTimeFormatOptions = {\r\n        day: 'numeric',\r\n        month: 'long'\r\n      };\r\n\r\n      if(date.getFullYear() !== today.getFullYear()) {\r\n        options.year = 'numeric';\r\n      }\r\n\r\n      dateElement = new I18n.IntlDateElement({\r\n        date,\r\n        options\r\n      }).element;\r\n\r\n      if(isScheduled) {\r\n        dateElement = i18n('Chat.Date.ScheduledFor', [dateElement]);\r\n      }\r\n    }\r\n    \r\n    const bubble = document.createElement('div');\r\n    bubble.className = 'bubble service is-date';\r\n    const bubbleContent = document.createElement('div');\r\n    bubbleContent.classList.add('bubble-content');\r\n    const serviceMsg = document.createElement('div');\r\n    serviceMsg.classList.add('service-msg');\r\n\r\n    serviceMsg.append(dateElement);\r\n\r\n    bubbleContent.append(serviceMsg);\r\n    bubble.append(bubbleContent);\r\n\r\n    return bubble;\r\n  }\r\n\r\n  public getDateForDateContainer(timestamp: number) {\r\n    const date = new Date(timestamp * 1000);\r\n    date.setHours(0, 0, 0);\r\n    return {date, dateTimestamp: date.getTime()};\r\n  }\r\n\r\n  public getDateContainerByTimestamp(timestamp: number) {\r\n    const {date, dateTimestamp} = this.getDateForDateContainer(timestamp);\r\n    if(!this.dateMessages[dateTimestamp]) {\r\n      const bubble = this.createDateBubble(timestamp, date);\r\n      // bubble.classList.add('is-sticky');\r\n      const fakeBubble = this.createDateBubble(timestamp, date);\r\n      fakeBubble.classList.add('is-fake');\r\n\r\n      const container = document.createElement('section');\r\n      container.className = 'bubbles-date-group';\r\n      container.append(bubble, fakeBubble);\r\n\r\n      this.dateMessages[dateTimestamp] = {\r\n        div: bubble,\r\n        container,\r\n        firstTimestamp: date.getTime()\r\n      };\r\n\r\n      const haveTimestamps = getObjectKeysAndSort(this.dateMessages, 'asc');\r\n      let i = 0, length = haveTimestamps.length, insertBefore: HTMLElement; // there can be 'first bubble' (e.g. bot description) so can't insert by index\r\n      for(; i < haveTimestamps.length; ++i) {\r\n        const t = haveTimestamps[i];\r\n        insertBefore = this.dateMessages[t].container;\r\n        if(dateTimestamp < t) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      if(i === length && insertBefore) {\r\n        insertBefore = insertBefore.nextElementSibling as HTMLElement;\r\n      }\r\n\r\n      if(!insertBefore) {\r\n        this.chatInner.append(container);\r\n      } else {\r\n        this.chatInner.insertBefore(container, insertBefore);\r\n      }\r\n\r\n      if(this.stickyIntersector) {\r\n        this.stickyIntersector.observeStickyHeaderChanges(container);\r\n      }\r\n\r\n      if(this.chatInner.parentElement) {\r\n        this.container.classList.add('has-groups');\r\n      }\r\n    }\r\n\r\n    return this.dateMessages[dateTimestamp];\r\n  }\r\n\r\n  private destroyScrollable() {\r\n    this.scrollable.destroy();\r\n  }\r\n\r\n  public destroy() {\r\n    //this.chat.log.error('Bubbles destroying');\r\n\r\n    this.destroyScrollable();\r\n\r\n    this.listenerSetter.removeAll();\r\n\r\n    this.lazyLoadQueue.clear();\r\n    this.observer && this.observer.disconnect();\r\n    this.stickyIntersector && this.stickyIntersector.disconnect();\r\n\r\n    delete this.lazyLoadQueue;\r\n    this.observer && delete this.observer;\r\n    this.stickyIntersector && delete this.stickyIntersector;\r\n  }\r\n\r\n  public cleanup(bubblesToo = false) {\r\n    this.bubbles = {}; // clean it before so sponsored message won't be deleted faster on peer changing\r\n    ////console.time('appImManager cleanup');\r\n    this.setLoaded('top', false, false);\r\n    this.setLoaded('bottom', false, false);\r\n\r\n    // cancel scroll\r\n    cancelAnimationByKey(this.scrollable.container);\r\n\r\n    // do not wait ending of previous scale animation\r\n    interruptHeavyAnimation();\r\n\r\n    if(TEST_SCROLL !== undefined) {\r\n      TEST_SCROLL = TEST_SCROLL_TIMES;\r\n    }\r\n\r\n    this.skippedMids.clear();\r\n    this.dateMessages = {};\r\n    this.bubbleGroups.cleanup();\r\n    this.unreadOut.clear();\r\n    this.needUpdate.length = 0;\r\n    this.lazyLoadQueue.clear();\r\n    this.renderNewPromises.clear();\r\n    \r\n    // clear messages\r\n    if(bubblesToo) {\r\n      this.scrollable.container.textContent = '';\r\n      this.chatInner.textContent = '';\r\n      this.cleanupPlaceholders();\r\n    }\r\n    \r\n    this.firstUnreadBubble = null;\r\n    this.attachedUnreadBubble = false;\r\n    \r\n    this.messagesQueue.length = 0;\r\n    this.messagesQueuePromise = null;\r\n    \r\n    this.getHistoryTopPromise = this.getHistoryBottomPromise = undefined;\r\n    this.fetchNewPromise = undefined;\r\n    this.getSponsoredMessagePromise = undefined;\r\n    \r\n    if(this.stickyIntersector) {\r\n      this.stickyIntersector.disconnect();\r\n    }\r\n    \r\n    if(this.observer) {\r\n      this.observer.disconnect();\r\n\r\n      this.unreaded.clear();\r\n      this.unreadedSeen.clear();\r\n      this.readPromise = undefined;\r\n\r\n      this.viewsMids.clear();\r\n    }\r\n\r\n    this.middleware.clean();\r\n    \r\n    this.onAnimateLadder = undefined;\r\n    this.resolveLadderAnimation = undefined;\r\n    this.attachPlaceholderOnRender = undefined;\r\n    this.emptyPlaceholderBubble = undefined;\r\n    this.sponsoredMessage = undefined;\r\n    this.previousStickyDate = undefined;\r\n\r\n    this.scrollingToBubble = undefined;\r\n    ////console.timeEnd('appImManager cleanup');\r\n\r\n    this.isTopPaddingSet = false;\r\n\r\n    this.renderingMessages.clear();\r\n    this.bubblesToEject.clear();\r\n    this.bubblesToReplace.clear();\r\n\r\n    // this.reactions.clear();\r\n\r\n    if(this.isScrollingTimeout) {\r\n      clearTimeout(this.isScrollingTimeout);\r\n      this.isScrollingTimeout = 0;\r\n    }\r\n\r\n    this.container.classList.remove('has-sticky-dates');\r\n    this.scrollable.cancelMeasure();\r\n  }\r\n\r\n  private cleanupPlaceholders(bubble = this.emptyPlaceholderBubble) {\r\n    if(bubble) {\r\n      bubble.remove();\r\n\r\n      if(this.emptyPlaceholderBubble === bubble) {\r\n        this.emptyPlaceholderBubble = undefined;\r\n      }\r\n    }\r\n  }\r\n\r\n  public async setPeer(samePeer: boolean, peerId: PeerId, lastMsgId?: number, startParam?: string): Promise<{cached?: boolean, promise: Chat['setPeerPromise']}> {\r\n    const tempId = ++this.setPeerTempId;\r\n\r\n    if(!peerId) {\r\n      this.cleanup(true);\r\n      this.preloader.detach();\r\n      return null;\r\n    }\r\n\r\n    const perf = performance.now();\r\n    const log = this.log.bindPrefix('setPeer');\r\n    log.warn('start');\r\n\r\n    const middleware = () => {\r\n      return this.setPeerTempId === tempId;\r\n    };\r\n\r\n    const m = middlewarePromise(middleware, PEER_CHANGED_ERROR);\r\n\r\n    if(!samePeer) {\r\n      await m(this.chat.onChangePeer(m));\r\n    }\r\n\r\n    /* if(samePeer && this.chat.setPeerPromise) {\r\n      return {cached: true, promise: this.chat.setPeerPromise};\r\n    } */\r\n\r\n    const chatType = this.chat.type;\r\n\r\n    if(chatType === 'scheduled' || this.chat.isRestricted) {\r\n      lastMsgId = 0;\r\n    }\r\n\r\n    const historyStorage = await m(this.chat.getHistoryStorage());\r\n    let topMessage = chatType === 'pinned' ? await m(this.managers.appMessagesManager.getPinnedMessagesMaxId(peerId)) : historyStorage.maxId ?? 0;\r\n    const isTarget = lastMsgId !== undefined;\r\n\r\n    // * this one will fix topMessage for null message in history (e.g. channel comments with only 1 comment and it is a topMessage)\r\n    /* if(chatType !== 'pinned' && topMessage && !historyStorage.history.slice.includes(topMessage)) {\r\n      topMessage = 0;\r\n    } */\r\n\r\n    let followingUnread: boolean;\r\n    let readMaxId = 0, savedPosition: ReturnType<AppImManager['getChatSavedPosition']>, overrideAdditionMsgId: number;\r\n    if(!isTarget) {\r\n      if(!samePeer) {\r\n        savedPosition = this.chat.appImManager.getChatSavedPosition(this.chat);\r\n      }\r\n\r\n      if(savedPosition) {\r\n        \r\n      } else if(topMessage) {\r\n        readMaxId = await m(this.managers.appMessagesManager.getReadMaxIdIfUnread(peerId, this.chat.threadId));\r\n        const dialog = await m(this.managers.appMessagesManager.getDialogOnly(peerId));\r\n        if(/* dialog.unread_count */readMaxId && !samePeer && (!dialog || dialog.unread_count !== 1)) {\r\n          const foundSlice = historyStorage.history.findSliceOffset(readMaxId);\r\n          if(foundSlice && foundSlice.slice.isEnd(SliceEnd.Bottom)) {\r\n            overrideAdditionMsgId = foundSlice.slice[foundSlice.offset - 25] || foundSlice.slice[0] || readMaxId;\r\n          }\r\n\r\n          followingUnread = !isTarget;\r\n          lastMsgId = readMaxId;\r\n        } else {\r\n          lastMsgId = topMessage;\r\n          //lastMsgID = topMessage;\r\n        }\r\n      }\r\n    }\r\n\r\n    const isJump = lastMsgId !== topMessage/*  && overrideAdditionMsgId === undefined */;\r\n\r\n    if(startParam === undefined && await m(this.chat.isStartButtonNeeded())) {\r\n      startParam = BOT_START_PARAM;\r\n    }\r\n\r\n    if(samePeer) {\r\n      const mounted = await m(this.getMountedBubble(lastMsgId));\r\n      if(mounted) {\r\n        if(isTarget) {\r\n          this.scrollToBubble(mounted.bubble, 'center');\r\n          this.highlightBubble(mounted.bubble);\r\n          this.chat.dispatchEvent('setPeer', lastMsgId, false);\r\n        } else if(topMessage && !isJump) {\r\n          //log('will scroll down', this.scroll.scrollTop, this.scroll.scrollHeight);\r\n          // scrollable.setScrollTopSilently(scrollable.scrollHeight);\r\n          this.scrollToEnd();\r\n          this.chat.dispatchEvent('setPeer', lastMsgId, true);\r\n        }\r\n\r\n        if(startParam !== undefined) {\r\n          this.chat.input.setStartParam(startParam);\r\n        }\r\n        \r\n        return null;\r\n      }\r\n    } else {\r\n      if(this.peerId) { // * set new queue id if new peer (setting not from 0)\r\n        this.lazyLoadQueue.queueId = ++queueId;\r\n        this.managers.apiFileManager.setQueueId(this.chat.bubbles.lazyLoadQueue.queueId);\r\n      }\r\n\r\n      this.replyFollowHistory.length = 0;\r\n\r\n      this.passEntities = {\r\n        messageEntityBotCommand: await m(this.managers.appPeersManager.isAnyGroup(peerId)) || await m(this.managers.appUsersManager.isBot(peerId))\r\n      };\r\n    }\r\n\r\n    if(DEBUG) {\r\n      log('setPeer peerId:', peerId, historyStorage, lastMsgId, topMessage);\r\n    }\r\n\r\n    // add last message, bc in getHistory will load < max_id\r\n    const additionMsgId = overrideAdditionMsgId ?? (isJump || chatType === 'scheduled' || this.chat.isRestricted ? 0 : topMessage);\r\n\r\n    let maxBubbleId = 0;\r\n    if(samePeer) {\r\n      let el = this.getBubbleByPoint('bottom'); // ! this may not work if being called when chat is hidden\r\n      //this.chat.log('[PM]: setCorrectIndex: get last element perf:', performance.now() - perf, el);\r\n      if(el) {\r\n        maxBubbleId = +el.dataset.mid;\r\n      }\r\n\r\n      if(maxBubbleId <= 0) {\r\n        maxBubbleId = Math.max(...Object.keys(this.bubbles).map((mid) => +mid));\r\n      }\r\n    } else {\r\n      this.isFirstLoad = true;\r\n      this.destroyResizeObserver();\r\n    }\r\n\r\n    const oldChatInner = this.chatInner;\r\n    const oldPlaceholderBubble = this.emptyPlaceholderBubble;\r\n    this.cleanup();\r\n    const chatInner = this.chatInner = document.createElement('div');\r\n    if(samePeer) {\r\n      chatInner.className = oldChatInner.className;\r\n      chatInner.classList.remove('disable-hover', 'is-scrolling');\r\n    } else {\r\n      chatInner.classList.add('bubbles-inner');\r\n    }\r\n\r\n    this.lazyLoadQueue.lock();\r\n\r\n    // const haveToScrollToBubble = (topMessage && (isJump || samePeer)) || isTarget;\r\n    const haveToScrollToBubble = samePeer || (topMessage && isJump) || isTarget;\r\n    const fromUp = maxBubbleId > 0 && (!lastMsgId || maxBubbleId < lastMsgId || lastMsgId < 0);\r\n    const scrollFromDown = !fromUp && samePeer;\r\n    const scrollFromUp = !scrollFromDown && fromUp/*  && (samePeer || forwardingUnread) */;\r\n    this.willScrollOnLoad = scrollFromDown || scrollFromUp;\r\n\r\n    this.setPeerOptions = {\r\n      lastMsgId,\r\n      topMessage\r\n    };\r\n\r\n    let result: Awaited<ReturnType<ChatBubbles['getHistory']>>;\r\n    if(!savedPosition) {\r\n      result = await m(this.getHistory1(lastMsgId, true, isJump, additionMsgId));\r\n    } else {\r\n      result = {\r\n        promise: getHeavyAnimationPromise().then(() => {\r\n          return this.performHistoryResult({history: savedPosition.mids}, true);\r\n        }) as any,\r\n        cached: true,\r\n        waitPromise: Promise.resolve()\r\n      };\r\n    }\r\n\r\n    this.setPeerCached = result.cached;\r\n\r\n    log.warn('got history');// warning\r\n\r\n    const {promise, cached} = result;\r\n\r\n    if(!cached && !samePeer) {\r\n      await m(this.chat.finishPeerChange(isTarget, isJump, lastMsgId, startParam));\r\n      this.scrollable.container.textContent = '';\r\n      // oldContainer.textContent = '';\r\n      //oldChatInner.remove();\r\n      this.preloader.attach(this.container);\r\n    }\r\n\r\n    /* this.ladderDeferred && this.ladderDeferred.resolve();\r\n    this.ladderDeferred = deferredPromise<void>(); */\r\n\r\n    animationIntersector.lockGroup(CHAT_ANIMATION_GROUP);\r\n    const setPeerPromise = m(promise).then(async() => {\r\n      log.warn('promise fulfilled');\r\n\r\n      let mountedByLastMsgId = haveToScrollToBubble ? await m(lastMsgId ? this.getMountedBubble(lastMsgId) : {bubble: this.getLastBubble()}) : undefined;\r\n      if(cached && !samePeer) {\r\n        log.warn('finishing peer change');\r\n        await m(this.chat.finishPeerChange(isTarget, isJump, lastMsgId, startParam)); // * \r\n        log.warn('finished peer change');\r\n      }\r\n\r\n      this.preloader.detach();\r\n\r\n      if(this.resolveLadderAnimation) {\r\n        this.resolveLadderAnimation();\r\n        this.resolveLadderAnimation = undefined;\r\n      }\r\n\r\n      this.setPeerCached = undefined;\r\n\r\n      // this.ladderDeferred.resolve();\r\n\r\n      const scrollable = this.scrollable;\r\n      scrollable.lastScrollDirection = 0;\r\n      scrollable.lastScrollPosition = 0;\r\n      replaceContent(scrollable.container, chatInner);\r\n      // this.chat.topbar.container.nextElementSibling.replaceWith(container);\r\n\r\n      if(oldPlaceholderBubble) {\r\n        this.cleanupPlaceholders(oldPlaceholderBubble);\r\n      }\r\n\r\n      if(this.attachPlaceholderOnRender) {\r\n        this.attachPlaceholderOnRender();\r\n      }\r\n\r\n      if(!isTarget && this.chat.type === 'chat' && this.chat.topbar.pinnedMessage) {\r\n        this.chat.topbar.pinnedMessage.setCorrectIndex(0);\r\n      }\r\n\r\n      this.container.classList.toggle('has-groups', !!Object.keys(this.dateMessages).length);\r\n\r\n      log.warn('mounted chat', this.chatInner === chatInner, this.chatInner.parentElement, performance.now() - perf);\r\n\r\n      animationIntersector.unlockGroup(CHAT_ANIMATION_GROUP);\r\n      animationIntersector.checkAnimations(false, CHAT_ANIMATION_GROUP/* , true */);\r\n\r\n      //fastRaf(() => {\r\n        this.lazyLoadQueue.unlock();\r\n      //});\r\n\r\n      //if(dialog && lastMsgID && lastMsgID !== topMessage && (this.bubbles[lastMsgID] || this.firstUnreadBubble)) {\r\n      if(savedPosition) {\r\n        scrollable.setScrollTopSilently(savedPosition.top);\r\n        /* const mountedByLastMsgId = this.getMountedBubble(lastMsgId);\r\n        let bubble: HTMLElement = mountedByLastMsgId?.bubble;\r\n        if(!bubble?.parentElement) {\r\n          bubble = this.findNextMountedBubbleByMsgId(lastMsgId);\r\n        }\r\n\r\n        if(bubble) {\r\n          const top = bubble.getBoundingClientRect().top;\r\n          const distance = savedPosition.top - top;\r\n          scrollable.scrollTop += distance;\r\n        } */\r\n      } else if(haveToScrollToBubble) {\r\n        let unsetPadding: () => void;\r\n        if(scrollFromDown) {\r\n          scrollable.setScrollTopSilently(99999);\r\n        } else if(scrollFromUp) {\r\n          const set = this.setTopPadding();\r\n          if(set.isPaddingNeeded) {\r\n            unsetPadding = set.unsetPadding;\r\n          }\r\n\r\n          scrollable.setScrollTopSilently(0);\r\n        }\r\n\r\n        // const mountedByLastMsgId = lastMsgId ? this.getMountedBubble(lastMsgId) : {bubble: this.getLastBubble()};\r\n        let bubble: HTMLElement = (followingUnread && this.firstUnreadBubble) || mountedByLastMsgId?.bubble;\r\n        if(!bubble?.parentElement) {\r\n          bubble = this.findNextMountedBubbleByMsgId(lastMsgId, false) || this.findNextMountedBubbleByMsgId(lastMsgId, true);\r\n        }\r\n        \r\n        let promise: Promise<void>;\r\n        // ! sometimes there can be no bubble\r\n        if(bubble) {\r\n          const lastBubble = this.getLastBubble();\r\n          const position: ScrollLogicalPosition = followingUnread ? 'start' : (!isJump && !isTarget && lastBubble === bubble ? 'end' : 'center');\r\n\r\n          if(position === 'end' && lastBubble === bubble && samePeer) {\r\n            promise = this.scrollToEnd();\r\n          } else {\r\n            promise = this.scrollToBubble(bubble, position, !samePeer ? FocusDirection.Static : undefined);\r\n          }\r\n\r\n          if(!followingUnread && isTarget) {\r\n            this.highlightBubble(bubble);\r\n          }\r\n        }\r\n\r\n        if(unsetPadding) {\r\n          (promise || Promise.resolve()).then(() => {\r\n            unsetPadding();\r\n          });\r\n        }\r\n      } else {\r\n        scrollable.setScrollTopSilently(99999);\r\n      }\r\n\r\n      // if(!cached) {\r\n        this.onRenderScrollSet();\r\n      // }\r\n\r\n      this.onScroll();\r\n\r\n      const afterSetPromise = Promise.all([setPeerPromise, getHeavyAnimationPromise()]);\r\n      afterSetPromise.then(() => { // check whether list isn't full\r\n        scrollable.checkForTriggers();\r\n\r\n        // if(cached) {\r\n          // this.onRenderScrollSet();\r\n        // }\r\n      });\r\n\r\n      this.chat.dispatchEvent('setPeer', lastMsgId, !isJump);\r\n\r\n      Promise.all([\r\n        this.setFetchReactionsInterval(afterSetPromise),\r\n        this.setFetchHistoryInterval({\r\n          afterSetPromise,\r\n          lastMsgId,\r\n          samePeer,\r\n          savedPosition,\r\n          topMessage\r\n        }),\r\n      ]).then(() => {\r\n        log('scrolledAllDown:', scrollable.loadedAll.bottom);\r\n        //if(!this.unreaded.length && dialog) { // lol\r\n        if(scrollable.loadedAll.bottom && topMessage && !this.unreaded.size) { // lol\r\n          this.onScrolledAllDown();\r\n        }\r\n      });\r\n\r\n      if(chatType === 'chat') {\r\n        const dialog = await m(this.managers.appMessagesManager.getDialogOnly(peerId));\r\n        if(dialog?.pFlags.unread_mark) {\r\n          this.managers.appMessagesManager.markDialogUnread(peerId, true);\r\n        }\r\n      }\r\n\r\n      //this.chatInner.classList.remove('disable-hover', 'is-scrolling'); // warning, performance!\r\n    }).catch((err) => {\r\n      log.error('getHistory promise error:', err);\r\n      if(!middleware()) {\r\n        this.preloader.detach();\r\n      }\r\n\r\n      throw err;\r\n    });\r\n\r\n    return {cached, promise: setPeerPromise};\r\n  }\r\n\r\n  private async setFetchReactionsInterval(afterSetPromise: Promise<any>) {\r\n    const middleware = this.getMiddleware();\r\n    const needReactionsInterval = await this.managers.appPeersManager.isChannel(this.peerId);\r\n    if(needReactionsInterval) {\r\n      const fetchReactions = async() => {\r\n        if(!middleware()) return;\r\n\r\n        const mids: number[] = [];\r\n        for(const mid in this.bubbles) {\r\n          let message = await this.chat.getMessage(+mid);\r\n          if(message?._ !== 'message') {\r\n            continue;\r\n          }\r\n\r\n          message = await this.managers.appMessagesManager.getGroupsFirstMessage(message);\r\n          mids.push(message.mid);\r\n        }\r\n\r\n        const promise = mids.length ? this.managers.appReactionsManager.getMessagesReactions(this.peerId, mids) : Promise.resolve();\r\n        promise.then(() => {\r\n          setTimeout(fetchReactions, 10e3);\r\n        });\r\n      };\r\n\r\n      Promise.all([afterSetPromise, getHeavyAnimationPromise(), pause(500)]).then(() => {\r\n        fetchReactions();\r\n      });\r\n    }\r\n  }\r\n\r\n  private async setFetchHistoryInterval({\r\n    lastMsgId,\r\n    topMessage,\r\n    afterSetPromise,\r\n    savedPosition,\r\n    samePeer\r\n  }: {\r\n    lastMsgId: number,\r\n    topMessage: number,\r\n    afterSetPromise: Promise<any>,\r\n    savedPosition: ChatSavedPosition,\r\n    samePeer: boolean\r\n  }) {\r\n    const middleware = this.getMiddleware();\r\n    const peerId = this.peerId;\r\n\r\n    const needFetchInterval = await this.managers.appMessagesManager.isFetchIntervalNeeded(peerId);\r\n    const needFetchNew = savedPosition || needFetchInterval;\r\n    if(!needFetchNew) {\r\n      return;\r\n    }\r\n\r\n    await afterSetPromise;\r\n    if(!middleware()) {\r\n      return;\r\n    }\r\n\r\n    this.setLoaded('bottom', false);\r\n    this.scrollable.checkForTriggers();\r\n\r\n    if(!needFetchInterval) {\r\n      return;\r\n    }\r\n\r\n    const f = () => {\r\n      this.fetchNewPromise = new Promise<void>(async(resolve) => {\r\n        if(!middleware() || !(await this.managers.appMessagesManager.isFetchIntervalNeeded(peerId))) {\r\n          resolve();\r\n          return;\r\n        }\r\n\r\n        this.managers.appMessagesManager.getNewHistory(peerId, this.chat.threadId).then((result) => {\r\n          if(!middleware() || !result) {\r\n            resolve();\r\n            return;\r\n          }\r\n\r\n          const {isBottomEnd} = result;\r\n          if(this.scrollable.loadedAll.bottom && this.scrollable.loadedAll.bottom !== isBottomEnd) {\r\n            this.setLoaded('bottom', isBottomEnd);\r\n            this.onScroll();\r\n          }\r\n\r\n          setTimeout(f, 30e3);\r\n          resolve();\r\n        });\r\n      }).finally(() => {\r\n        this.fetchNewPromise = undefined;\r\n      });\r\n    };\r\n    \r\n    if(samePeer) {\r\n      setTimeout(f, 30e3);\r\n    } else {\r\n      f();\r\n    }\r\n  }\r\n\r\n  public async onScrolledAllDown() {\r\n    if(this.chat.type === 'chat' || this.chat.type === 'discussion') {\r\n      const historyMaxId = await this.chat.getHistoryMaxId();\r\n      this.managers.appMessagesManager.readHistory(this.peerId, historyMaxId, this.chat.threadId, true);\r\n    }\r\n  }\r\n\r\n  public async finishPeerChange() {\r\n    const [isChannel, canWrite, isAnyGroup] = await Promise.all([\r\n      this.managers.appPeersManager.isChannel(this.peerId),\r\n      this.chat.canSend(),\r\n      this.chat.isAnyGroup\r\n    ]);\r\n\r\n    return () => {\r\n      this.chatInner.classList.toggle('has-rights', canWrite);\r\n      this.container.classList.toggle('is-chat-input-hidden', !canWrite);\r\n  \r\n      this.chatInner.classList.toggle('is-chat', isAnyGroup);\r\n      this.chatInner.classList.toggle('is-channel', isChannel);\r\n  \r\n      this.createResizeObserver();\r\n    };\r\n  }\r\n\r\n  public renderMessagesQueue(options: ChatBubbles['messagesQueue'][0]) {\r\n    this.messagesQueue.push(options);\r\n    return this.setMessagesQueuePromise();    \r\n  }\r\n\r\n  public setMessagesQueuePromise() {\r\n    if(!this.messagesQueue.length) return Promise.resolve();\r\n\r\n    if(this.messagesQueuePromise) {\r\n      return this.messagesQueuePromise;\r\n    }\r\n    \r\n    const middleware = this.getMiddleware();\r\n    const log = this.log.bindPrefix('queue');\r\n    const possibleError = PEER_CHANGED_ERROR;\r\n    const m = middlewarePromise(middleware, possibleError);\r\n\r\n    const processQueue = async(): Promise<void> => {\r\n      log('start');\r\n\r\n      // if(!this.chat.setPeerPromise) {\r\n      //   await pause(10000000);\r\n      // }\r\n\r\n      const renderQueue = this.messagesQueue.slice();\r\n      this.messagesQueue.length = 0;\r\n\r\n      const renderQueuePromises = renderQueue.map((promise) => {\r\n        const perf = performance.now();\r\n        promise.then((details) => {\r\n          log('render message time', performance.now() - perf, details);\r\n        });\r\n\r\n        return promise;\r\n      });\r\n\r\n      let loadQueue = await m(Promise.all(renderQueuePromises));\r\n      const filterQueue = (queue: typeof loadQueue) => {\r\n        return queue.filter((details) => {\r\n          // message can be deleted during rendering\r\n          return details && this.bubbles[details.bubble.dataset.mid] === details.bubble;\r\n        });\r\n      };\r\n\r\n      loadQueue = filterQueue(loadQueue);\r\n\r\n      log('messages rendered');\r\n\r\n      const reverse = loadQueue[0]?.reverse;\r\n\r\n      const {groups, avatarPromises} = this.groupBubbles(loadQueue.filter((details) => details.updatePosition));\r\n\r\n      // if(groups.length > 2 && loadQueue.length === 1) {\r\n      //   debugger;\r\n      // }\r\n      \r\n      const promises = loadQueue.reduce((acc, details) => {\r\n        const perf = performance.now();\r\n\r\n        const promises = details.promises.slice();\r\n        const timePromises = promises.map(async(promise) => (await promise, performance.now() - perf));\r\n        Promise.all(timePromises).then((times) => {\r\n          log.groupCollapsed('media message time', performance.now() - perf, details, times);\r\n          times.forEach((time, idx) => {\r\n            log('media message time', time, idx, promises[idx]);\r\n          });\r\n          log.groupEnd();\r\n        });\r\n\r\n        // if(details.updatePosition) {\r\n        //   if(res) {\r\n        //     groups.add(res.group);\r\n        //     if(details.needAvatar) {\r\n        //       details.promises.push(res.group.createAvatar(details.message));\r\n        //     }\r\n        //   }\r\n        // }\r\n\r\n        acc.push(...details.promises);\r\n        return acc;\r\n      }, [] as Promise<any>[]);\r\n\r\n      promises.push(...avatarPromises);\r\n      // promises.push(pause(200));\r\n\r\n      // *    ,     reply  - ,    \r\n      // *     -     ,       \r\n      // promises.push(getHeavyAnimationPromise());\r\n\r\n      log('media promises to call', promises, loadQueue, this.isHeavyAnimationInProgress);\r\n      await m(Promise.all([...promises, this.setUnreadDelimiter()])); //    \r\n      await m(fastRafPromise()); // have to be the last\r\n      log('media promises end');\r\n\r\n      loadQueue = filterQueue(loadQueue);\r\n\r\n      const {restoreScroll, scrollSaver} = this.prepareToSaveScroll(reverse);\r\n      // if(this.messagesQueueOnRender) {\r\n        // this.messagesQueueOnRender();\r\n      // }\r\n\r\n      if(this.messagesQueueOnRenderAdditional) {\r\n        this.messagesQueueOnRenderAdditional();\r\n      }\r\n\r\n      this.ejectBubbles();\r\n      for(const [bubble, oldBubble] of this.bubblesToReplace) {\r\n        if(scrollSaver) {\r\n          scrollSaver.replaceSaved(oldBubble, bubble);\r\n        }\r\n        \r\n        if(!loadQueue.find((details) => details.bubble === bubble)) {\r\n          continue;\r\n        }\r\n\r\n        const item = this.bubbleGroups.getItemByBubble(bubble);\r\n        item.mounted = false;\r\n        if(!groups.includes(item.group)) {\r\n          groups.push(item.group);\r\n        }\r\n\r\n        this.bubblesToReplace.delete(bubble);\r\n      }\r\n      \r\n      if(this.chat.selection.isSelecting) {\r\n        loadQueue.forEach(({bubble}) => {\r\n          this.chat.selection.toggleElementCheckbox(bubble, true);\r\n        });\r\n      }\r\n\r\n      loadQueue.forEach(({message, bubble, updatePosition}) => {\r\n        if(message.pFlags.local && updatePosition) {\r\n          this.chatInner[(message as Message.message).pFlags.sponsored ? 'append' : 'prepend'](bubble);\r\n          return;\r\n        }\r\n      });\r\n\r\n      this.bubbleGroups.mountUnmountGroups(groups);\r\n      // this.bubbleGroups.findIncorrentPositions();\r\n\r\n      if(this.updatePlaceholderPosition) {\r\n        this.updatePlaceholderPosition();\r\n      }\r\n\r\n      if(restoreScroll) {\r\n        restoreScroll();\r\n      }\r\n\r\n      // this.setStickyDateManually();\r\n      \r\n      if(this.messagesQueue.length) {\r\n        log('have new messages to render');\r\n        return processQueue();\r\n      } else {\r\n        log('end');\r\n      }\r\n    };\r\n\r\n    log('setting pause');\r\n    const promise = this.messagesQueuePromise = m(pause(0)).then(processQueue).finally(() => {\r\n      if(this.messagesQueuePromise === promise) {\r\n        this.messagesQueuePromise = null;\r\n      }\r\n    });\r\n\r\n    return promise;\r\n  }\r\n\r\n  private ejectBubbles() {\r\n    for(const bubble of this.bubblesToEject) {\r\n      bubble.remove();\r\n      // this.bubbleGroups.removeAndUnmountBubble(bubble);\r\n    }\r\n\r\n    this.bubblesToEject.clear();\r\n  }\r\n\r\n  public groupBubbles(items: Array<{\r\n    // Awaited<ReturnType<ChatBubbles['safeRenderMessage']>> & \r\n    bubble: HTMLElement, \r\n    message: Message.message | Message.messageService\r\n  }/*  & {\r\n    unmountIfFound?: boolean\r\n  } */>) {\r\n    let modifiedGroups: typeof groups;\r\n\r\n    if(this.chat.type === 'scheduled') {\r\n      modifiedGroups = new Set();\r\n      items.forEach(({bubble, message}) => {\r\n        const item = this.bubbleGroups.getItemByBubble(bubble);\r\n        const group = item?.group;\r\n        if(group && item.message.date !== message.date) {\r\n          this.bubbleGroups.removeItem(item);\r\n          modifiedGroups.add(group);\r\n        }\r\n      });\r\n    }\r\n    \r\n    items.forEach(({bubble, message}) => {\r\n      this.bubbleGroups.prepareForGrouping(bubble, message);\r\n    });\r\n\r\n    const groups = this.bubbleGroups.groupUngrouped();\r\n\r\n    const avatarPromises = Array.from(groups).map((group) => {\r\n      if(group.avatar) return;\r\n      const firstItem = group.firstItem;\r\n      if(firstItem && this.chat.isAvatarNeeded(firstItem.message)) {\r\n        return group.createAvatar(firstItem.message);\r\n      }\r\n    }).filter(Boolean);\r\n\r\n    if(modifiedGroups) {\r\n      for(const group of modifiedGroups) {\r\n        groups.add(group);\r\n      }\r\n    }\r\n\r\n    return {\r\n      groups: [...groups], \r\n      avatarPromises\r\n    };\r\n  }\r\n\r\n  public getMiddleware(additionalCallback?: () => boolean) {\r\n    return this.middleware.get(additionalCallback);\r\n  }\r\n\r\n  private async safeRenderMessage(\r\n    message: Message.message | Message.messageService, \r\n    reverse?: boolean, \r\n    bubble?: HTMLElement, \r\n    updatePosition = true,\r\n    processResult?: (result: ReturnType<ChatBubbles['renderMessage']>, bubble: HTMLElement) => typeof result\r\n  ) {\r\n    if(!message || this.renderingMessages.has(message.mid) || (this.bubbles[message.mid] && !bubble)) {\r\n      return;\r\n    }\r\n\r\n    const middleware = this.getMiddleware();\r\n\r\n    let result: Awaited<ReturnType<ChatBubbles['renderMessage']>> & {updatePosition: typeof updatePosition};\r\n    try {\r\n      this.renderingMessages.add(message.mid);\r\n\r\n      // const groupedId = (message as Message.message).grouped_id;\r\n      const newBubble = document.createElement('div');\r\n      newBubble.dataset.mid = '' + message.mid;\r\n      newBubble.dataset.peerId = '' + message.peerId;\r\n      newBubble.dataset.timestamp = '' + message.date;\r\n\r\n      // const bubbleNew: Bubble = this.bubblesNew[message.mid] ??= {\r\n      //   bubble: newBubble, \r\n      //   mids: new Set(), \r\n      //   groupedId\r\n      // };\r\n\r\n      // bubbleNew.mids.add(message.mid);\r\n\r\n      if(bubble) {\r\n        this.skippedMids.delete(message.mid);\r\n\r\n        this.bubblesToEject.add(bubble);\r\n        this.bubblesToReplace.delete(bubble);\r\n        this.bubblesToReplace.set(newBubble, bubble);\r\n        this.bubbleGroups.changeBubbleByBubble(bubble, newBubble);\r\n      }\r\n\r\n      bubble = this.bubbles[message.mid] = newBubble;\r\n      let originalPromise = this.renderMessage(message, reverse, bubble);\r\n      if(processResult) {\r\n        originalPromise = processResult(originalPromise, bubble);\r\n      }\r\n      \r\n      const promise = originalPromise.then((r) => ((r && middleware() ? {...r, updatePosition} : undefined) as typeof result));\r\n\r\n      this.renderMessagesQueue(promise.catch(() => undefined));\r\n\r\n      result = await promise;\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      if(!result) {\r\n        this.skippedMids.add(+message.mid);\r\n      }\r\n    } catch(err) {\r\n      this.log.error('renderMessage error:', err);\r\n    }\r\n\r\n    if(!middleware()) {\r\n      return;\r\n    }\r\n\r\n    this.renderingMessages.delete(message.mid);\r\n    return result;\r\n  }\r\n  \r\n  // reverse means top\r\n  private async renderMessage(\r\n    message: Message.message | Message.messageService, \r\n    reverse = false, \r\n    bubble: HTMLElement\r\n  ) {\r\n    // if(DEBUG) {\r\n    //   this.log('message to render:', message);\r\n    // }\r\n\r\n    // if(!bubble && this.bubbles[message.mid]) {\r\n    //   return;\r\n    // }\r\n\r\n    // await pause(1000);\r\n\r\n    const isMessage = message._ === 'message';\r\n    const groupedId = isMessage && message.grouped_id;\r\n    let albumMids: number[], reactionsMessage: Message.message;\r\n    const albumMessages = groupedId ? await this.managers.appMessagesManager.getMessagesByAlbum(groupedId) : undefined;\r\n\r\n    const albumMustBeRenderedFull = this.chat.type !== 'pinned';\r\n\r\n    if(groupedId && albumMustBeRenderedFull) { // will render only last album's message\r\n      albumMids = albumMessages.map((message) => message.mid);\r\n      const mainMid = getMainMidForGrouped(albumMids);\r\n      if(message.mid !== mainMid) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    if(isMessage) {\r\n      reactionsMessage = groupedId ? albumMessages[0] : message;\r\n    }\r\n    \r\n    // * can't use 'message.pFlags.out' here because this check will be used to define side of message (left-right)\r\n    const our = this.chat.isOurMessage(message);\r\n    \r\n    const messageDiv = document.createElement('div');\r\n    messageDiv.classList.add('message');\r\n    \r\n    let bubbleContainer: HTMLDivElement;\r\n    let contentWrapper: HTMLElement;\r\n    \r\n    contentWrapper = document.createElement('div');\r\n    contentWrapper.classList.add('bubble-content-wrapper');\r\n    \r\n    bubbleContainer = document.createElement('div');\r\n    bubbleContainer.classList.add('bubble-content');\r\n    \r\n    bubble.classList.add('bubble');\r\n    contentWrapper.append(bubbleContainer);\r\n    bubble.append(contentWrapper);\r\n\r\n    if(!our && !message.pFlags.out && this.observer) {\r\n      //this.log('not our message', message, message.pFlags.unread);\r\n      const isUnread = message.pFlags.unread || \r\n        isMentionUnread(message)/*  || \r\n        (this.historyStorage.readMaxId !== undefined && this.historyStorage.readMaxId < message.mid) */;\r\n      if(isUnread) {\r\n        this.observer.observe(bubble, this.unreadedObserverCallback);\r\n        this.unreaded.set(bubble, message.mid);\r\n      }\r\n    }\r\n\r\n    const loadPromises: Promise<any>[] = [];\r\n    const ret = {\r\n      bubble,\r\n      promises: loadPromises,\r\n      message,\r\n      reverse\r\n    };\r\n\r\n    if(message._ === 'messageService' && (!message.action || !SERVICE_AS_REGULAR.has(message.action._))) {\r\n      const action = message.action;\r\n      if(action) {\r\n        const _ = action._;\r\n        if(IGNORE_ACTIONS.has(_) || (langPack.hasOwnProperty(_) && !langPack[_])) {\r\n          return;\r\n        }\r\n      }\r\n\r\n      bubble.className = 'bubble service';\r\n\r\n      bubbleContainer.innerHTML = '';\r\n      const s = document.createElement('div');\r\n      s.classList.add('service-msg');\r\n      if(action) {\r\n        let promise: Promise<any>;\r\n        if(action._ === 'messageActionChannelMigrateFrom') {\r\n          const peerTitle = new PeerTitle();\r\n          promise = peerTitle.update({peerId: action.chat_id.toPeerId(true)});\r\n          s.append(i18n('ChatMigration.From', [peerTitle.element]));\r\n        } else if(action._ === 'messageActionChatMigrateTo') {\r\n          const peerTitle = new PeerTitle();\r\n          promise = peerTitle.update({peerId: action.channel_id.toPeerId(true)});\r\n          s.append(i18n('ChatMigration.To', [peerTitle.element]));\r\n        } else {\r\n          s.append(await wrapMessageActionTextNew(message));\r\n        }\r\n      }\r\n      bubbleContainer.append(s);\r\n\r\n      if(message.pFlags.is_single) { // * Ignore 'Discussion started'\r\n        bubble.classList.add('is-group-last');\r\n      }\r\n\r\n      return ret;\r\n    }\r\n\r\n    let messageMedia: MessageMedia = isMessage && message.media;\r\n\r\n    let messageMessage: string, totalEntities: MessageEntity[];\r\n    if(isMessage) {\r\n      if((messageMedia as MessageMedia.messageMediaDocument)?.document && \r\n        !['video', 'gif'].includes(((messageMedia as MessageMedia.messageMediaDocument).document as MyDocument).type)) {\r\n        // * just filter these cases for documents caption\r\n      } else if(groupedId && albumMustBeRenderedFull) {\r\n        const t = getAlbumText(albumMessages);\r\n        messageMessage = t.message;\r\n        //totalEntities = t.entities;\r\n        totalEntities = t.totalEntities;\r\n      } else if(((messageMedia as MessageMedia.messageMediaDocument)?.document as MyDocument)?.type !== 'sticker') {\r\n        messageMessage = message.message;\r\n        //totalEntities = message.entities;\r\n        totalEntities = message.totalEntities;\r\n      }\r\n    } else {\r\n      if(message.action._ === 'messageActionPhoneCall') {\r\n        messageMedia = {\r\n          _: 'messageMediaCall',\r\n          action: message.action\r\n        };\r\n      }\r\n    }\r\n    \r\n    /* let richText = wrapRichText(messageMessage, {\r\n      entities: totalEntities\r\n    }); */\r\n    let richText = wrapRichText(messageMessage, {\r\n      entities: totalEntities,\r\n      passEntities: this.passEntities\r\n    });\r\n\r\n    let canHaveTail = true;\r\n    let isStandaloneMedia = false;\r\n    let needToSetHTML = true;\r\n    if(totalEntities && !messageMedia) {\r\n      let emojiEntities = totalEntities.filter((e) => e._ === 'messageEntityEmoji');\r\n      let strLength = messageMessage.length;\r\n      let emojiStrLength = emojiEntities.reduce((acc, curr) => acc + curr.length, 0);\r\n      \r\n      if(emojiStrLength === strLength && emojiEntities.length <= 3 && totalEntities.length === emojiEntities.length) {\r\n        if(rootScope.settings.emoji.big) {\r\n          let sticker = await this.managers.appStickersManager.getAnimatedEmojiSticker(messageMessage);\r\n          if(emojiEntities.length === 1 && !messageMedia && sticker) {\r\n            messageMedia = {\r\n              _: 'messageMediaDocument',\r\n              document: sticker\r\n            };\r\n          } else {\r\n            let attachmentDiv = document.createElement('div');\r\n            attachmentDiv.classList.add('attachment');\r\n            \r\n            setInnerHTML(attachmentDiv, richText);\r\n            \r\n            bubble.classList.add('emoji-' + emojiEntities.length + 'x');\r\n            \r\n            bubbleContainer.append(attachmentDiv);\r\n          }\r\n\r\n          bubble.classList.add('is-message-empty', 'emoji-big');\r\n          isStandaloneMedia = true;\r\n          canHaveTail = false;\r\n          needToSetHTML = false;\r\n        }\r\n        \r\n        bubble.classList.add('can-have-big-emoji');\r\n      }\r\n      \r\n      /* if(strLength === emojiStrLength) {\r\n        messageDiv.classList.add('emoji-only');\r\n        messageDiv.classList.add('message-empty');\r\n      } */\r\n    }\r\n\r\n    if(needToSetHTML) {\r\n      setInnerHTML(messageDiv, richText);\r\n    }\r\n\r\n    const timeSpan = MessageRender.setTime({\r\n      chatType: this.chat.type, \r\n      message,\r\n      reactionsMessage\r\n    });\r\n    messageDiv.append(timeSpan);\r\n    bubbleContainer.prepend(messageDiv);\r\n    //bubble.prepend(timeSpan, messageDiv); // that's bad\r\n\r\n    if(isMessage && message.views) {\r\n      bubble.classList.add('channel-post');\r\n\r\n      if(!message.fwd_from?.saved_from_msg_id && this.chat.type !== 'pinned') {\r\n        const forward = document.createElement('div');\r\n        forward.classList.add('bubble-beside-button', 'forward', 'tgico-forward_filled');\r\n        bubbleContainer.prepend(forward);\r\n        bubble.classList.add('with-beside-button');\r\n      }\r\n  \r\n      if(!message.pFlags.is_outgoing && this.observer) {\r\n        this.observer.observe(bubble, this.viewsObserverCallback);\r\n      }\r\n    }\r\n\r\n    const replyMarkup = isMessage && message.reply_markup;\r\n    if(replyMarkup && replyMarkup._ === 'replyInlineMarkup' && replyMarkup.rows && replyMarkup.rows.length) {\r\n      const rows = replyMarkup.rows;\r\n\r\n      const containerDiv = document.createElement('div');\r\n      containerDiv.classList.add('reply-markup');\r\n      rows.forEach((row) => {\r\n        const buttons = row.buttons;\r\n        if(!buttons || !buttons.length) return;\r\n\r\n        const rowDiv = document.createElement('div');\r\n        rowDiv.classList.add('reply-markup-row');\r\n\r\n        buttons.forEach((button) => {\r\n          let text: DocumentFragment | HTMLElement | string = wrapRichText(button.text, {noLinks: true, noLinebreaks: true});\r\n\r\n          let buttonEl: HTMLButtonElement | HTMLAnchorElement;\r\n          \r\n          switch(button._) {\r\n            case 'keyboardButtonUrl': {\r\n              const r = wrapRichText(' ', {\r\n                entities: [{\r\n                  _: 'messageEntityTextUrl',\r\n                  length: 1,\r\n                  offset: 0,\r\n                  url: button.url\r\n                }]\r\n              });\r\n\r\n              buttonEl = htmlToDocumentFragment(r).firstElementChild as HTMLAnchorElement;\r\n              buttonEl.classList.add('is-link');\r\n\r\n              break;\r\n            }\r\n\r\n            case 'keyboardButtonSwitchInline': {\r\n              buttonEl = document.createElement('button');\r\n              buttonEl.classList.add('is-switch-inline');\r\n              attachClickEvent(buttonEl, (e) => {\r\n                cancelEvent(e);\r\n\r\n                const botId = message.viaBotId || message.fromId;\r\n                let promise: Promise<PeerId>;\r\n                if(button.pFlags.same_peer) promise = Promise.resolve(this.peerId);\r\n                else promise = this.managers.appInlineBotsManager.checkSwitchReturn(botId).then((peerId) => {\r\n                  if(peerId) {\r\n                    return peerId;\r\n                  }\r\n                  \r\n                  return new Promise<PeerId>((resolve, reject) => {\r\n                    const popup = new PopupForward({\r\n                      [this.peerId]: []\r\n                    }, (peerId) => {\r\n                      resolve(peerId);\r\n                    }, true);\r\n\r\n                    popup.addEventListener('close', () => {\r\n                      reject();\r\n                    });\r\n                  });\r\n                });\r\n                \r\n                promise.then((peerId) => {\r\n                  const threadId = this.peerId === peerId ? this.chat.threadId : undefined;\r\n                  this.chat.appImManager.setInnerPeer({peerId});\r\n                  this.managers.appInlineBotsManager.switchInlineQuery(peerId, threadId, botId, button.query);\r\n                });\r\n              });\r\n              break;\r\n            }\r\n\r\n            case 'keyboardButtonBuy': {\r\n              buttonEl = document.createElement('button');\r\n              buttonEl.classList.add('is-buy');\r\n\r\n              if(messageMedia?._ === 'messageMediaInvoice') {\r\n                if(messageMedia.receipt_msg_id) {\r\n                  text = i18n('Message.ReplyActionButtonShowReceipt');\r\n                }\r\n              }\r\n\r\n              break;\r\n            }\r\n\r\n            default: {\r\n              buttonEl = document.createElement('button');\r\n              break;\r\n            }\r\n          }\r\n          \r\n          buttonEl.classList.add('reply-markup-button', 'rp', 'tgico');\r\n          if(typeof(text) === 'string') {\r\n            buttonEl.insertAdjacentHTML('beforeend', text);\r\n          } else {\r\n            buttonEl.append(text);\r\n          }\r\n\r\n          ripple(buttonEl);\r\n\r\n          rowDiv.append(buttonEl);\r\n        });\r\n\r\n        containerDiv.append(rowDiv);\r\n      });\r\n\r\n      attachClickEvent(containerDiv, (e) => {\r\n        let target = e.target as HTMLElement;\r\n        \r\n        if(!target.classList.contains('reply-markup-button')) target = findUpClassName(target, 'reply-markup-button');\r\n        if(\r\n          !target \r\n          || target.classList.contains('is-link') \r\n          || target.classList.contains('is-switch-inline')\r\n          || target.classList.contains('is-buy')\r\n        ) return;\r\n\r\n        cancelEvent(e);\r\n\r\n        const column = whichChild(target);\r\n        const row = rows[whichChild(target.parentElement)];\r\n\r\n        if(!row.buttons || !row.buttons[column]) {\r\n          this.log.warn('no such button', row, column, message);\r\n          return;\r\n        }\r\n\r\n        const button = row.buttons[column];\r\n        this.managers.appInlineBotsManager.callbackButtonClick(this.peerId, message.mid, button).then((callbackAnswer) => {\r\n          if(typeof callbackAnswer.message === 'string' && callbackAnswer.message.length) {\r\n            toast(wrapRichText(callbackAnswer.message, {noLinks: true, noLinebreaks: true}));\r\n          }\r\n          \r\n          //console.log('callbackButtonClick callbackAnswer:', callbackAnswer);\r\n        });\r\n      });\r\n\r\n      canHaveTail = false;\r\n      bubble.classList.add('with-reply-markup');\r\n      contentWrapper.append(containerDiv);\r\n    }\r\n    \r\n    const isOutgoing = message.pFlags.is_outgoing/*  && this.peerId !== rootScope.myId */;\r\n    if(our) {\r\n      if(message.pFlags.unread || isOutgoing) this.unreadOut.add(message.mid);\r\n      let status = '';\r\n      if(isOutgoing) status = 'is-sending';\r\n      else status = message.pFlags.unread || (message as Message.message).pFlags.is_scheduled ? 'is-sent' : 'is-read';\r\n      bubble.classList.add(status);\r\n    }\r\n\r\n    if(isOutgoing) {\r\n      bubble.classList.add('is-outgoing');\r\n    }\r\n\r\n    const messageWithReplies = isMessage && await this.managers.appMessagesManager.getMessageWithCommentReplies(message);\r\n    const withReplies = !!messageWithReplies && message.mid > 0;\r\n\r\n    if(withReplies) {\r\n      bubble.classList.add('with-replies');\r\n    }\r\n\r\n    const fwdFrom = isMessage && message.fwd_from;\r\n    const fwdFromId = isMessage && message.fwdFromId;\r\n\r\n    const isOut = this.chat.isOutMessage(message);\r\n    let nameContainer: HTMLElement = bubbleContainer;\r\n\r\n    const canHideNameIfMedia = !message.viaBotId && (message.fromId === rootScope.myId || !message.pFlags.out);\r\n\r\n    // media\r\n    if(messageMedia/*  && messageMedia._ === 'messageMediaPhoto' */) {\r\n      let attachmentDiv = document.createElement('div');\r\n      attachmentDiv.classList.add('attachment');\r\n      \r\n      if(!messageMessage) {\r\n        bubble.classList.add('is-message-empty');\r\n      }\r\n      \r\n      let processingWebPage = false;\r\n      \r\n      /* if(isMessage)  */switch(messageMedia._) {\r\n        case 'messageMediaPhoto': {\r\n          const photo = messageMedia.photo;\r\n          ////////this.log('messageMediaPhoto', photo);\r\n\r\n          if(!messageMessage) {\r\n            canHaveTail = false;\r\n          }\r\n          \r\n          if(canHideNameIfMedia) {\r\n            bubble.classList.add('hide-name');  \r\n          }\r\n\r\n          bubble.classList.add('photo');\r\n          \r\n          if(albumMustBeRenderedFull && groupedId && albumMids.length !== 1) {\r\n            bubble.classList.add('is-album', 'is-grouped');\r\n            wrapAlbum({\r\n              messages: albumMessages,\r\n              attachmentDiv,\r\n              middleware: this.getMiddleware(),\r\n              isOut: our,\r\n              lazyLoadQueue: this.lazyLoadQueue,\r\n              chat: this.chat,\r\n              loadPromises,\r\n              autoDownload: this.chat.autoDownload,\r\n            });\r\n\r\n            break;\r\n          }\r\n          \r\n          const withTail = !IS_ANDROID && canHaveTail && !withReplies && USE_MEDIA_TAILS;\r\n          if(withTail) bubble.classList.add('with-media-tail');\r\n          wrapPhoto({\r\n            photo: photo as Photo.photo, \r\n            message,\r\n            container: attachmentDiv,\r\n            withTail, \r\n            isOut, \r\n            lazyLoadQueue: this.lazyLoadQueue,\r\n            middleware: this.getMiddleware(),\r\n            loadPromises,\r\n            autoDownloadSize: this.chat.autoDownload.photo,\r\n          });\r\n\r\n          break;\r\n        }\r\n        \r\n        case 'messageMediaWebPage': {\r\n          processingWebPage = true;\r\n          \r\n          let webPage: WebPage = messageMedia.webpage;\r\n          ////////this.log('messageMediaWebPage', webpage);\r\n          if(webPage._ !== 'webPage') {\r\n            break;\r\n          } \r\n          \r\n          bubble.classList.add('webpage');\r\n          \r\n          let box = document.createElement('div');\r\n          box.classList.add('web');\r\n          \r\n          let quote = document.createElement('div');\r\n          quote.classList.add('quote');\r\n\r\n          let previewResizer: HTMLDivElement, preview: HTMLDivElement;\r\n          const photo: Photo.photo = webPage.photo as any;\r\n          if(photo || webPage.document) {\r\n            previewResizer = document.createElement('div');\r\n            previewResizer.classList.add('preview-resizer');\r\n            preview = document.createElement('div');\r\n            preview.classList.add('preview');\r\n            previewResizer.append(preview);\r\n          }\r\n\r\n          let quoteTextDiv = document.createElement('div');\r\n          quoteTextDiv.classList.add('quote-text');\r\n          \r\n          const doc = webPage.document as MyDocument;\r\n          if(doc) {\r\n            if(doc.type === 'gif' || doc.type === 'video' || doc.type === 'round') {\r\n              //if(doc.size <= 20e6) {\r\n              const mediaSize = doc.type === 'round' ? mediaSizes.active.round : mediaSizes.active.webpage;\r\n              if(doc.type === 'round') {\r\n                bubble.classList.add('round');\r\n                preview.classList.add('is-round');\r\n              } else {\r\n                bubble.classList.add('video');\r\n              }\r\n              wrapVideo({\r\n                doc, \r\n                container: preview, \r\n                message: message as Message.message, \r\n                boxWidth: mediaSize.width,\r\n                boxHeight: mediaSize.height,\r\n                lazyLoadQueue: this.lazyLoadQueue,\r\n                middleware: this.getMiddleware(),\r\n                isOut,\r\n                group: CHAT_ANIMATION_GROUP,\r\n                loadPromises,\r\n                autoDownload: this.chat.autoDownload,\r\n              });\r\n              //}\r\n            } else {\r\n              const docDiv = await wrapDocument({\r\n                message: message as Message.message,\r\n                autoDownloadSize: this.chat.autoDownload.file,\r\n                lazyLoadQueue: this.lazyLoadQueue,\r\n                loadPromises,\r\n                sizeType: 'documentName',\r\n                searchContext: {\r\n                  useSearch: false,\r\n                  peerId: this.peerId,\r\n                  inputFilter: {\r\n                    _: 'inputMessagesFilterEmpty'\r\n                  }\r\n                }\r\n              });\r\n              preview.append(docDiv);\r\n              preview.classList.add('preview-with-document');\r\n              quoteTextDiv.classList.add('has-document');\r\n              //messageDiv.classList.add((webpage.type || 'document') + '-message');\r\n              //doc = null;\r\n            }\r\n          }\r\n          \r\n          if(previewResizer) {\r\n            quoteTextDiv.append(previewResizer);\r\n          }\r\n\r\n          let t: HTMLElement;\r\n          if(webPage.site_name) {\r\n            const html = wrapRichText(webPage.url);\r\n            const a: HTMLAnchorElement = htmlToDocumentFragment(html).firstElementChild as any;\r\n            a.classList.add('webpage-name');\r\n            const strong = document.createElement('strong');\r\n            setInnerHTML(strong, wrapEmojiText(webPage.site_name));\r\n            a.textContent = '';\r\n            a.append(strong);\r\n            quoteTextDiv.append(a);\r\n            t = a;\r\n          }\r\n\r\n          const title = wrapWebPageTitle(webPage);\r\n          if(title.textContent) {\r\n            let titleDiv = document.createElement('div');\r\n            titleDiv.classList.add('title');\r\n            const strong = document.createElement('strong');\r\n            setInnerHTML(strong, title);\r\n            titleDiv.append(strong);\r\n            quoteTextDiv.append(titleDiv);\r\n            t = titleDiv;\r\n          }\r\n\r\n          const description = wrapWebPageDescription(webPage);\r\n          if(description.textContent) {\r\n            let textDiv = document.createElement('div');\r\n            textDiv.classList.add('text');\r\n            setInnerHTML(textDiv, description);\r\n            quoteTextDiv.append(textDiv);\r\n            t = textDiv;\r\n          }\r\n\r\n          /* if(t) {\r\n            t.append(timeSpan);\r\n          } else {\r\n            box.classList.add('no-text');\r\n          } */\r\n\r\n          quote.append(quoteTextDiv);\r\n\r\n          if(photo && !doc) {\r\n            bubble.classList.add('photo');\r\n\r\n            const size: PhotoSize.photoSize = photo.sizes[photo.sizes.length - 1] as any;\r\n            let isSquare = false;\r\n            if(size.w === size.h && t) {\r\n              bubble.classList.add('is-square-photo');\r\n              isSquare = true;\r\n              setAttachmentSize(photo, preview, 48, 48, false);\r\n\r\n              /* if(t) {\r\n                t.append(timeSpan);\r\n              } */\r\n            } else if(size.h > size.w) {\r\n              bubble.classList.add('is-vertical-photo');\r\n            }\r\n\r\n            wrapPhoto({\r\n              photo, \r\n              message, \r\n              container: preview, \r\n              boxWidth: isSquare ? 0 : mediaSizes.active.webpage.width, \r\n              boxHeight: isSquare ? 0 : mediaSizes.active.webpage.height, \r\n              isOut, \r\n              lazyLoadQueue: this.lazyLoadQueue, \r\n              middleware: this.getMiddleware(),\r\n              loadPromises,\r\n              withoutPreloader: isSquare,\r\n              autoDownloadSize: this.chat.autoDownload.photo,\r\n            });\r\n          }\r\n          \r\n          box.append(quote);\r\n          \r\n          //bubble.prepend(box);\r\n          // if(timeSpan.parentElement === messageDiv) {\r\n            messageDiv.insertBefore(box, timeSpan);\r\n          // } else {\r\n          //   messageDiv.append(box);\r\n          // }\r\n          \r\n          //this.log('night running', bubble.scrollHeight);\r\n          \r\n          break;\r\n        }\r\n        \r\n        case 'messageMediaDocument': {\r\n          const doc = messageMedia.document as MyDocument;\r\n\r\n          //this.log('messageMediaDocument', doc, bubble);\r\n          \r\n          if(doc.sticker/*  && doc.size <= 1e6 */) {\r\n            bubble.classList.add('sticker');\r\n            canHaveTail = false;\r\n            isStandaloneMedia = true;\r\n            \r\n            if(doc.animated) {\r\n              bubble.classList.add('sticker-animated');\r\n            }\r\n            \r\n            const sizes = mediaSizes.active;\r\n            const size = bubble.classList.contains('emoji-big') ? sizes.emojiSticker : (doc.animated ? sizes.animatedSticker : sizes.staticSticker);\r\n            setAttachmentSize(doc, attachmentDiv, size.width, size.height);\r\n            //let preloader = new ProgressivePreloader(attachmentDiv, false);\r\n            bubbleContainer.style.minWidth = attachmentDiv.style.width;\r\n            bubbleContainer.style.minHeight = attachmentDiv.style.height;\r\n            //appPhotosManager.setAttachmentSize(doc, bubble);\r\n            wrapSticker({\r\n              doc, \r\n              div: attachmentDiv,\r\n              middleware: this.getMiddleware(),\r\n              lazyLoadQueue: this.lazyLoadQueue,\r\n              group: CHAT_ANIMATION_GROUP,\r\n              //play: !!message.pending || !multipleRender,\r\n              play: true,\r\n              loop: true,\r\n              emoji: bubble.classList.contains('emoji-big') ? messageMessage : undefined,\r\n              withThumb: true,\r\n              loadPromises\r\n            });\r\n          } else if(doc.type === 'video' || doc.type === 'gif' || doc.type === 'round'/*  && doc.size <= 20e6 */) {\r\n            //this.log('never get free 2', doc);\r\n\r\n            const isRound = doc.type === 'round';\r\n            if(isRound) {\r\n              isStandaloneMedia = true;\r\n            }\r\n\r\n            if(isRound || !messageMessage) {\r\n              canHaveTail = false;\r\n            }\r\n\r\n            if(canHideNameIfMedia) {\r\n              bubble.classList.add('hide-name');\r\n            }\r\n            \r\n            bubble.classList.add(isRound ? 'round' : 'video');\r\n            if(albumMustBeRenderedFull && groupedId && albumMids.length !== 1) {\r\n              bubble.classList.add('is-album', 'is-grouped');\r\n  \r\n              wrapAlbum({\r\n                messages: albumMessages,\r\n                attachmentDiv,\r\n                middleware: this.getMiddleware(),\r\n                isOut: our,\r\n                lazyLoadQueue: this.lazyLoadQueue,\r\n                chat: this.chat,\r\n                loadPromises,\r\n                autoDownload: this.chat.autoDownload,\r\n              });\r\n            } else {\r\n              const withTail = !IS_ANDROID && !IS_APPLE && !isRound && canHaveTail && !withReplies && USE_MEDIA_TAILS;\r\n              if(withTail) bubble.classList.add('with-media-tail');\r\n              wrapVideo({\r\n                doc, \r\n                container: attachmentDiv, \r\n                message: message as Message.message, \r\n                boxWidth: mediaSizes.active.regular.width,\r\n                boxHeight: mediaSizes.active.regular.height, \r\n                withTail, \r\n                isOut,\r\n                lazyLoadQueue: this.lazyLoadQueue,\r\n                middleware: this.getMiddleware(),\r\n                group: CHAT_ANIMATION_GROUP,\r\n                loadPromises,\r\n                autoDownload: this.chat.autoDownload,\r\n                searchContext: isRound ? {\r\n                  peerId: this.peerId,\r\n                  inputFilter: {_: 'inputMessagesFilterRoundVoice'},\r\n                  threadId: this.chat.threadId,\r\n                  useSearch: !(message as Message.message).pFlags.is_scheduled,\r\n                  isScheduled: (message as Message.message).pFlags.is_scheduled\r\n                } : undefined,\r\n              });\r\n            }\r\n          } else {\r\n            const newNameContainer = await wrapGroupedDocuments({\r\n              albumMustBeRenderedFull,\r\n              message,\r\n              bubble,\r\n              messageDiv,\r\n              chat: this.chat,\r\n              loadPromises,\r\n              autoDownloadSize: this.chat.autoDownload.file,\r\n              lazyLoadQueue: this.lazyLoadQueue,\r\n              searchContext: doc.type === 'voice' || doc.type === 'audio' ? {\r\n                peerId: this.peerId,\r\n                inputFilter: {_: doc.type === 'voice' ? 'inputMessagesFilterRoundVoice' : 'inputMessagesFilterMusic'},\r\n                threadId: this.chat.threadId,\r\n                useSearch: !(message as Message.message).pFlags.is_scheduled,\r\n                isScheduled: (message as Message.message).pFlags.is_scheduled\r\n              } : undefined,\r\n              sizeType: 'documentName'\r\n            });\r\n\r\n            if(newNameContainer) {\r\n              nameContainer = newNameContainer;\r\n            }\r\n\r\n            const lastContainer = messageDiv.lastElementChild.querySelector('.document-message, .document-size, .audio');\r\n            // lastContainer && lastContainer.append(timeSpan.cloneNode(true));\r\n            lastContainer && lastContainer.append(timeSpan);\r\n\r\n            bubble.classList.remove('is-message-empty');\r\n            messageDiv.classList.add((!(['photo', 'pdf'] as MyDocument['type'][]).includes(doc.type) ? doc.type || 'document' : 'document') + '-message');\r\n            processingWebPage = true;\r\n          }\r\n\r\n          break;\r\n        }\r\n\r\n        case 'messageMediaCall': {\r\n          const action = messageMedia.action;\r\n          const div = document.createElement('div');\r\n          div.classList.add('bubble-call', action.pFlags.video ? 'tgico-videocamera' : 'tgico-phone');\r\n\r\n          const type: CallType = action.pFlags.video ? 'video' : 'voice';\r\n          div.dataset.type = type;\r\n\r\n          const title = document.createElement('div');\r\n          title.classList.add('bubble-call-title');\r\n\r\n          _i18n(title, isOut ? \r\n            (action.pFlags.video ? 'CallMessageVideoOutgoing' : 'CallMessageOutgoing') : \r\n            (action.pFlags.video ? 'CallMessageVideoIncoming' : 'CallMessageIncoming'));\r\n\r\n          const subtitle = document.createElement('div');\r\n          subtitle.classList.add('bubble-call-subtitle');\r\n\r\n          if(action.duration !== undefined) {\r\n            subtitle.append(formatCallDuration(action.duration));\r\n          } else {\r\n            let langPackKey: LangPackKey;\r\n            switch(action.reason._) {\r\n              case 'phoneCallDiscardReasonBusy':\r\n                langPackKey = 'Call.StatusBusy';\r\n                break;\r\n              case 'phoneCallDiscardReasonMissed':\r\n                langPackKey = 'Chat.Service.Call.Missed';\r\n                break;\r\n              // case 'phoneCallDiscardReasonHangup':\r\n              default:\r\n                langPackKey = 'Chat.Service.Call.Cancelled';\r\n                break;\r\n            }\r\n\r\n            subtitle.classList.add('is-reason');\r\n            _i18n(subtitle, langPackKey);\r\n          }\r\n\r\n          subtitle.classList.add('tgico', 'arrow-' + (action.duration !== undefined ? 'green' : 'red'));\r\n\r\n          div.append(title, subtitle);\r\n\r\n          processingWebPage = true;\r\n\r\n          bubble.classList.remove('is-message-empty');\r\n          messageDiv.classList.add('call-message');\r\n          messageDiv.append(div);\r\n\r\n          break;\r\n        }\r\n\r\n        case 'messageMediaContact': {\r\n          //this.log('wrapping contact', message);\r\n\r\n          const contact = messageMedia;\r\n          const contactDiv = document.createElement('div');\r\n          contactDiv.classList.add('contact');\r\n          contactDiv.dataset.peerId = '' + contact.user_id;\r\n\r\n          processingWebPage = true;\r\n\r\n          const contactDetails = document.createElement('div');\r\n          contactDetails.className = 'contact-details';\r\n          const contactNameDiv = document.createElement('div');\r\n          contactNameDiv.className = 'contact-name';\r\n          contactNameDiv.append(\r\n            wrapEmojiText([\r\n              contact.first_name,\r\n              contact.last_name\r\n            ].filter(Boolean).join(' '))\r\n          );\r\n\r\n          const contactNumberDiv = document.createElement('div');\r\n          contactNumberDiv.className = 'contact-number';\r\n          contactNumberDiv.textContent = contact.phone_number ? '+' + formatPhoneNumber(contact.phone_number).formatted : 'Unknown phone number';\r\n\r\n          contactDiv.append(contactDetails);\r\n          contactDetails.append(contactNameDiv, contactNumberDiv);\r\n\r\n          const avatarElem = new AvatarElement();\r\n          avatarElem.updateWithOptions({\r\n            lazyLoadQueue: this.lazyLoadQueue,\r\n            peerId: contact.user_id.toPeerId()\r\n          });\r\n          avatarElem.classList.add('contact-avatar', 'avatar-54');\r\n\r\n          contactDiv.prepend(avatarElem);\r\n\r\n          bubble.classList.remove('is-message-empty');\r\n          messageDiv.classList.add('contact-message');\r\n          messageDiv.append(contactDiv);\r\n\r\n          break;\r\n        }\r\n\r\n        case 'messageMediaPoll': {\r\n          bubble.classList.remove('is-message-empty');\r\n          \r\n          const pollElement = wrapPoll(message);\r\n          messageDiv.prepend(pollElement);\r\n          messageDiv.classList.add('poll-message');\r\n\r\n          break;\r\n        }\r\n\r\n        case 'messageMediaInvoice': {\r\n          const isTest = messageMedia.pFlags.test;\r\n          const photo = messageMedia.photo;\r\n\r\n          const priceEl = document.createElement(photo ? 'span' : 'div');\r\n          const f = document.createDocumentFragment();\r\n          const l = i18n(messageMedia.receipt_msg_id ? 'PaymentReceipt' : (isTest ? 'PaymentTestInvoice' : 'PaymentInvoice'));\r\n          l.classList.add('text-uppercase');\r\n          const joiner = ' ';\r\n          const p = document.createElement('span');\r\n          p.classList.add('text-bold');\r\n          p.textContent = paymentsWrapCurrencyAmount(messageMedia.total_amount, messageMedia.currency) + joiner;\r\n          f.append(p, l);\r\n          if(isTest && messageMedia.receipt_msg_id) {\r\n            const a = document.createElement('span');\r\n            a.classList.add('text-uppercase', 'pre-wrap');\r\n            a.append(joiner + '(Test)');\r\n            f.append(a);\r\n          }\r\n          setInnerHTML(priceEl, f);\r\n\r\n          if(photo) {\r\n            const mediaSize = mediaSizes.active.invoice;\r\n            wrapPhoto({\r\n              photo, \r\n              container: attachmentDiv,\r\n              withTail: false, \r\n              isOut, \r\n              lazyLoadQueue: this.lazyLoadQueue,\r\n              middleware: this.getMiddleware(),\r\n              loadPromises,\r\n              boxWidth: mediaSize.width,\r\n              boxHeight: mediaSize.height\r\n            });\r\n\r\n            bubble.classList.add('photo');\r\n\r\n            priceEl.classList.add('video-time');\r\n            attachmentDiv.append(priceEl);\r\n          } else {\r\n            attachmentDiv = undefined;\r\n          }\r\n\r\n          const titleDiv = document.createElement('div');\r\n          titleDiv.classList.add('bubble-primary-color');\r\n          setInnerHTML(titleDiv, wrapEmojiText(messageMedia.title));\r\n          \r\n          const richText = wrapEmojiText(messageMedia.description);\r\n          messageDiv.prepend(...[titleDiv, !photo && priceEl, richText].filter(Boolean));\r\n\r\n          bubble.classList.remove('is-message-empty');\r\n          bubble.classList.add('is-invoice');\r\n\r\n          break;\r\n        }\r\n        \r\n        default:\r\n          attachmentDiv = undefined;\r\n          bubble.classList.remove('is-message-empty');\r\n          messageDiv.append(i18n(UNSUPPORTED_LANG_PACK_KEY), timeSpan);\r\n          this.log.warn('unrecognized media type:', messageMedia._, message);\r\n          break;\r\n      }\r\n      \r\n      if(!processingWebPage && attachmentDiv) {\r\n        bubbleContainer.append(attachmentDiv);\r\n      }\r\n\r\n      /* if(bubble.classList.contains('is-message-empty') && (bubble.classList.contains('photo') || bubble.classList.contains('video'))) {\r\n        bubble.classList.add('no-tail');\r\n\r\n        if(!bubble.classList.contains('with-media-tail')) {\r\n          bubble.classList.add('use-border-radius');\r\n        }\r\n      } */\r\n    }\r\n\r\n    if(isStandaloneMedia) {\r\n      bubble.classList.add('just-media');\r\n    }\r\n\r\n    let savedFrom = '';\r\n    \r\n    // const needName = ((peerId.isAnyChat() && (peerId !== message.fromId || our)) && message.fromId !== rootScope.myId) || message.viaBotId;\r\n    const needName = (message.fromId !== rootScope.myId && this.chat.isAnyGroup) || message.viaBotId || (message as Message.message).pFlags.sponsored;\r\n    if(needName || fwdFrom || message.reply_to_mid) { // chat\r\n      let title: HTMLElement | DocumentFragment;\r\n      let titleVia: typeof title;\r\n\r\n      const isForwardFromChannel = message.from_id && message.from_id._ === 'peerChannel' && message.fromId === fwdFromId;\r\n      \r\n      let isHidden = fwdFrom && !fwdFrom.from_id;\r\n      if(message.viaBotId) {\r\n        titleVia = document.createElement('span');\r\n        titleVia.innerText = '@' + (await this.managers.appUsersManager.getUser(message.viaBotId)).username;\r\n        titleVia.classList.add('peer-title');\r\n        bubble.classList.add('must-have-name');\r\n      }\r\n      \r\n      if(isHidden) {\r\n        ///////this.log('message to render hidden', message);\r\n        title = document.createElement('span');\r\n        setInnerHTML(title, wrapEmojiText(fwdFrom.from_name));\r\n        title.classList.add('peer-title');\r\n        //title = fwdFrom.from_name;\r\n        bubble.classList.add('hidden-profile');\r\n      } else {\r\n        title = new PeerTitle({peerId: fwdFromId || message.fromId}).element;\r\n      }\r\n\r\n      if(message.reply_to_mid && message.reply_to_mid !== this.chat.threadId && isMessage) {\r\n        await MessageRender.setReply({\r\n          chat: this.chat,\r\n          bubble,\r\n          bubbleContainer,\r\n          message\r\n        });\r\n      }\r\n      \r\n      //this.log(title);\r\n      \r\n      let nameDiv: HTMLElement;\r\n      if((fwdFromId || fwdFrom)) {\r\n        if(this.peerId !== rootScope.myId && !isForwardFromChannel) {\r\n          bubble.classList.add('forwarded');\r\n        }\r\n        \r\n        if(message.savedFrom) {\r\n          savedFrom = message.savedFrom;\r\n          title.dataset.savedFrom = savedFrom;\r\n        }\r\n        \r\n        nameDiv = document.createElement('div');\r\n        title.dataset.peerId = '' + fwdFromId;\r\n\r\n        if((this.peerId === rootScope.myId || this.peerId === REPLIES_PEER_ID || isForwardFromChannel) && !isStandaloneMedia) {\r\n          nameDiv.style.color = getPeerColorById(fwdFromId, false);\r\n          nameDiv.append(title);\r\n        } else {\r\n          /* const fromTitle = message.fromId === this.myID || appPeersManager.isBroadcast(fwdFromId || message.fromId) ? '' : `<div class=\"name\" data-peer-id=\"${message.fromId}\" style=\"color: ${appPeersManager.getPeerColorByID(message.fromId, false)};\">${appPeersManager.getPeerTitle(message.fromId)}</div>`;\r\n          nameDiv.innerHTML = fromTitle + 'Forwarded from ' + title; */\r\n          const args: FormatterArguments = [title];\r\n          if(isStandaloneMedia) {\r\n            args.unshift(document.createElement('br'));\r\n          }\r\n          nameDiv.append(i18n('ForwardedFrom', [args]));\r\n        }\r\n      } else if(!message.viaBotId) {\r\n        if(!isStandaloneMedia && needName) {\r\n          nameDiv = document.createElement('div');\r\n          nameDiv.append(title);\r\n\r\n          const peer = await this.managers.appPeersManager.getPeer(message.fromId);\r\n          const pFlags = (peer as User.user)?.pFlags;\r\n          if(pFlags && (pFlags.scam || pFlags.fake)) {\r\n            nameDiv.append(generateFakeIcon(pFlags.scam));\r\n          }\r\n\r\n          if(!our) {\r\n            nameDiv.style.color = getPeerColorById(message.fromId, false);\r\n          }\r\n\r\n          nameDiv.dataset.peerId = '' + message.fromId;\r\n        } else /* if(!message.reply_to_mid) */ {\r\n          bubble.classList.add('hide-name');\r\n        }\r\n      }\r\n\r\n      if(message.viaBotId) {\r\n        if(!nameDiv) {\r\n          nameDiv = document.createElement('div');\r\n        } else {\r\n          nameDiv.append(' ');\r\n        }\r\n\r\n        const span = document.createElement('span');\r\n        span.append(i18n('ViaBot'), ' ', titleVia);\r\n        span.classList.add('is-via');\r\n\r\n        nameDiv.append(span);\r\n      }\r\n\r\n      if(nameDiv) {\r\n        nameDiv.classList.add('name');\r\n        nameContainer.append(nameDiv);\r\n      }\r\n    } else {\r\n      bubble.classList.add('hide-name');\r\n    }\r\n\r\n    if(this.chat.type === 'pinned') {\r\n      savedFrom = `${this.chat.peerId}_${message.mid}`;\r\n    }\r\n\r\n    const isThreadStarter = messageWithReplies && messageWithReplies.mid === this.chat.threadId;\r\n    if(isThreadStarter) {\r\n      bubble.classList.add('is-thread-starter', 'is-group-last');\r\n    }\r\n\r\n    if(savedFrom && (this.chat.type === 'pinned' || fwdFrom.saved_from_msg_id) && this.peerId !== REPLIES_PEER_ID) {\r\n      const goto = document.createElement('div');\r\n      goto.classList.add('bubble-beside-button', 'goto-original', 'tgico-arrow_next');\r\n      bubbleContainer.append(goto);\r\n      bubble.dataset.savedFrom = savedFrom;\r\n      bubble.classList.add('with-beside-button');\r\n    }\r\n    \r\n    bubble.classList.add(isOut ? 'is-out' : 'is-in');\r\n\r\n    if(withReplies) {\r\n      const isFooter = MessageRender.renderReplies({\r\n        bubble,\r\n        bubbleContainer,\r\n        message: messageWithReplies,\r\n        messageDiv,\r\n        loadPromises,\r\n        lazyLoadQueue: this.lazyLoadQueue\r\n      });\r\n\r\n      if(isFooter) {\r\n        canHaveTail = true;\r\n      }\r\n    }\r\n\r\n    if(isMessage) {\r\n      this.appendReactionsElementToBubble(bubble, message, reactionsMessage);\r\n    }\r\n\r\n    /* if(isMessage) {\r\n      const reactionHover = document.createElement('div');\r\n      reactionHover.classList.add('bubble-reaction-hover');\r\n      contentWrapper.append(reactionHover);\r\n    } */\r\n\r\n    if(canHaveTail) {\r\n      bubble.classList.add('can-have-tail');\r\n\r\n      bubbleContainer.append(generateTail());\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  private appendReactionsElementToBubble(bubble: HTMLElement, message: Message.message, reactionsMessage: Message.message, changedResults?: ReactionCount[]) {\r\n    if(this.peerId.isUser()/*  || true */) {\r\n      return;\r\n    }\r\n\r\n    if(!reactionsMessage?.reactions || !reactionsMessage.reactions.results.length) {\r\n      return;\r\n    }\r\n\r\n    // message = this.appMessagesManager.getMessageWithReactions(message);\r\n\r\n    const reactionsElement = new ReactionsElement();\r\n    reactionsElement.init(reactionsMessage, 'block');\r\n    reactionsElement.render(changedResults);\r\n\r\n    if(bubble.classList.contains('is-message-empty')) {\r\n      bubble.querySelector('.bubble-content-wrapper').append(reactionsElement);\r\n    } else {\r\n      const messageDiv = bubble.querySelector('.message');\r\n      if(bubble.classList.contains('is-multiple-documents')) {\r\n        const documentContainer = messageDiv.lastElementChild as HTMLElement;\r\n        let documentMessageDiv = documentContainer.querySelector('.document-message');\r\n\r\n        let timeSpan: HTMLElement = documentMessageDiv && documentMessageDiv.querySelector('.time');\r\n        if(!timeSpan) {\r\n          timeSpan = MessageRender.setTime({\r\n            chatType: this.chat.type,\r\n            message,\r\n            reactionsMessage\r\n          });\r\n        }\r\n        \r\n        reactionsElement.append(timeSpan);\r\n\r\n        if(!documentMessageDiv) {\r\n          documentMessageDiv = document.createElement('div');\r\n          documentMessageDiv.classList.add('document-message');\r\n          documentContainer.querySelector('.document-wrapper').prepend(documentMessageDiv);\r\n        }\r\n\r\n        documentMessageDiv.append(reactionsElement);\r\n      } else {\r\n        const timeSpan = Array.from(bubble.querySelectorAll('.time')).pop();\r\n        reactionsElement.append(timeSpan);\r\n        \r\n        messageDiv.append(reactionsElement);\r\n      }\r\n    }\r\n  }\r\n\r\n  private prepareToSaveScroll(reverse?: boolean) {\r\n    const isMounted = !!this.chatInner.parentElement;\r\n    if(!isMounted) {\r\n      return {};\r\n    }\r\n\r\n    const log = this.log.bindPrefix('prepareToSaveScroll');\r\n    log('save');\r\n    const scrollSaver = this.createScrollSaver(reverse);\r\n    scrollSaver.save(); // * let's save scroll position by point before the slicing, not after\r\n    \r\n    if(this.getRenderedLength() && !this.chat.setPeerPromise) {\r\n      const viewportSlice = this.getViewportSlice();\r\n      this.deleteViewportSlice(viewportSlice, true);\r\n    }\r\n    \r\n    // scrollSaver.save(); // ! slicing will corrupt scroll position\r\n    // const saved = scrollSaver.getSaved();\r\n    // const hadScroll = saved.scrollHeight !== saved.clientHeight;\r\n\r\n    return {\r\n      restoreScroll: () => {\r\n        log('restore');\r\n        // scrollSaver.restore(_history.length === 1 && !reverse ? false : true);\r\n        scrollSaver.restore(reverse);\r\n        this.onRenderScrollSet(scrollSaver.getSaved());\r\n      },\r\n      scrollSaver\r\n    };\r\n  }\r\n\r\n  public async performHistoryResult(historyResult: HistoryResult | {history: (Message.message | Message.messageService | number)[]}, reverse: boolean) {\r\n    const log = false ? this.log.bindPrefix('perform-' + (Math.random() * 1000 | 0)) : undefined;\r\n    log && log('start', this.chatInner.parentElement);\r\n\r\n    let history = historyResult.history;\r\n    history = history.slice(); // need\r\n\r\n    if(this.needReflowScroll) {\r\n      reflowScrollableElement(this.scrollable.container);\r\n      this.needReflowScroll = false;\r\n    }\r\n\r\n    const cb = (message: Message.message | Message.messageService) => {\r\n      if(!message) {\r\n        return;\r\n      } else if(message.pFlags.local) {\r\n        return this.processLocalMessageRender(message);\r\n      } else {\r\n        return this.safeRenderMessage(message, reverse);\r\n      }\r\n    };\r\n\r\n    const messages = await Promise.all(history.map((mid) => {\r\n      return typeof(mid) === 'number' ? this.chat.getMessage(mid) : mid;\r\n    }));\r\n\r\n    const setLoadedPromises: Promise<any>[] = [];\r\n    if(!this.scrollable.loadedAll['bottom'] || !this.scrollable.loadedAll['top']) {\r\n      let isEnd = (historyResult as HistoryResult).isEnd;\r\n      if(!isEnd) {\r\n        const historyStorage = await this.chat.getHistoryStorage();\r\n        const firstSlice = historyStorage.history.first;\r\n        const lastSlice = historyStorage.history.last;\r\n        isEnd = {top: false, bottom: false, both: false};\r\n        if(firstSlice.isEnd(SliceEnd.Bottom) && (!firstSlice.length || history.includes(firstSlice[0]))) {\r\n          isEnd.bottom = true;\r\n        }\r\n        \r\n        if(lastSlice.isEnd(SliceEnd.Top) && (!lastSlice.length || history.includes(lastSlice[lastSlice.length - 1]))) {\r\n          isEnd.top = true;\r\n        }\r\n      }\r\n\r\n      if(!isEnd.bottom && this.setPeerOptions) {\r\n        const {lastMsgId, topMessage} = this.setPeerOptions;\r\n        this.setPeerOptions = undefined;\r\n        if(!lastMsgId || this.bubbles[topMessage] || lastMsgId === topMessage) {\r\n          isEnd.bottom = true;\r\n        }\r\n      }\r\n\r\n      if(isEnd.top) setLoadedPromises.push(this.setLoaded('top', true));\r\n      if(isEnd.bottom) setLoadedPromises.push(this.setLoaded('bottom', true));\r\n    }\r\n\r\n    await Promise.all(setLoadedPromises);\r\n\r\n    // ! it is important to insert bubbles to group reversed way\r\n    // const length = history.length, promises: Promise<any>[] = [];\r\n    // if(reverse) for(let i = 0; i < length; ++i) promises.push(cb(messages[i]));\r\n    // else for(let i = length - 1; i >= 0; --i) promises.push(cb(messages[i]));\r\n    const promises = messages.map(cb);\r\n\r\n    // cannot combine them into one promise\r\n    await Promise.all(promises);\r\n    await this.messagesQueuePromise;\r\n\r\n    if(this.scrollable.loadedAll.top && this.messagesQueueOnRenderAdditional) {\r\n      this.messagesQueueOnRenderAdditional();\r\n\r\n      if(this.messagesQueueOnRenderAdditional) {\r\n        this.messagesQueueOnRenderAdditional();\r\n      }\r\n    }\r\n\r\n    log && log('performHistoryResult end');\r\n  }\r\n\r\n  private onRenderScrollSet(state?: {scrollHeight: number, clientHeight: number}) {\r\n    const className = 'has-sticky-dates';\r\n    if(!this.container.classList.contains(className)) {\r\n      const isLoading = !this.preloader.detached;\r\n\r\n      if(isLoading || \r\n        (\r\n          state ??= {\r\n            scrollHeight: this.scrollable.scrollHeight,\r\n            clientHeight: this.scrollable.container.clientHeight\r\n          }, \r\n          state.scrollHeight !== state.clientHeight\r\n        )\r\n      ) {\r\n        /* for(const timestamp in this.dateMessages) {\r\n          const dateMessage = this.dateMessages[timestamp];\r\n          dateMessage.div.classList.add('is-sticky');\r\n        } */\r\n        \r\n        const middleware = this.getMiddleware();\r\n        const callback = () => {\r\n          if(!middleware()) return;\r\n          this.container.classList.add(className);\r\n        };\r\n\r\n        if(this.willScrollOnLoad) {\r\n          callback();\r\n        } else {\r\n          setTimeout(callback, 600);\r\n        }\r\n\r\n        return;\r\n      }\r\n    }\r\n    \r\n    this.willScrollOnLoad = undefined;\r\n  }\r\n\r\n  public onDatePick = (timestamp: number) => {\r\n    const peerId = this.peerId;\r\n    this.managers.appMessagesManager.requestHistory(peerId, 0, 2, -1, timestamp, this.chat.threadId).then((history) => {\r\n      if(!history?.messages?.length) {\r\n        this.log.error('no history!');\r\n        return;\r\n      } else if(this.peerId !== peerId) {\r\n        return;\r\n      }\r\n\r\n      this.chat.setMessageId((history.messages[0] as MyMessage).mid);\r\n      //console.log('got history date:', history);\r\n    });\r\n  };\r\n\r\n  public requestHistory(maxId: number, loadCount: number, backLimit: number) {\r\n    //const middleware = this.getMiddleware();\r\n    if(this.chat.type === 'chat' || this.chat.type === 'discussion') {\r\n      return this.managers.acknowledged.appMessagesManager.getHistory(this.peerId, maxId, loadCount, backLimit, this.chat.threadId);\r\n    } else if(this.chat.type === 'pinned') {\r\n      return this.managers.acknowledged.appMessagesManager.getSearch({\r\n        peerId: this.peerId, \r\n        inputFilter: {_: 'inputMessagesFilterPinned'}, \r\n        maxId, \r\n        limit: loadCount, \r\n        backLimit\r\n      }).then((ackedResult) => {\r\n        return {\r\n          cached: ackedResult.cached,\r\n          result: Promise.resolve(ackedResult.result).then((value) => {\r\n            return {history: value.history.map((m) => m.mid)};\r\n          })\r\n        };\r\n      });\r\n    } else if(this.chat.type === 'scheduled') {\r\n      return this.managers.acknowledged.appMessagesManager.getScheduledMessages(this.peerId).then((ackedResult) => {\r\n        // this.setLoaded('top', true);\r\n        // this.setLoaded('bottom', true);\r\n        return {\r\n          cached: ackedResult.cached,\r\n          result: Promise.resolve(ackedResult.result).then((mids) => ({history: mids.slice().reverse()}))\r\n        };\r\n      });\r\n    }\r\n  }\r\n\r\n  private async animateAsLadder(additionMsgId: number, additionMsgIds: number[], isAdditionRender: boolean, backLimit: number, maxId: number) {\r\n    /* const middleware = this.getMiddleware();\r\n    await this.ladderDeferred; */\r\n\r\n    const log = this.log.bindPrefix('ladder');\r\n    if(this.chat.setPeerPromise && !this.resolveLadderAnimation) {\r\n      log.warn('will be delayed');\r\n      // @ts-ignore\r\n      this.resolveLadderAnimation = this.animateAsLadder.bind(this, additionMsgId, additionMsgIds, isAdditionRender, backLimit, maxId);\r\n      return;\r\n    }\r\n\r\n    /* if(!middleware()) {\r\n      return;\r\n    } */\r\n\r\n    if(!Object.keys(this.bubbles).length) {\r\n      log.warn('no bubbles');\r\n      return;\r\n    }\r\n\r\n    let sortedMids = getObjectKeysAndSort(this.bubbles, 'desc');\r\n\r\n    if(isAdditionRender && additionMsgIds.length) {\r\n      sortedMids = sortedMids.filter((mid) => !additionMsgIds.includes(mid));\r\n    }\r\n\r\n    let targetMid: number;\r\n    if(backLimit) {\r\n      targetMid = maxId || Math.max(...sortedMids); // * on discussion enter\r\n    } else {\r\n      if(additionMsgId) {\r\n        targetMid = additionMsgId;\r\n      } else { // * if maxId === 0\r\n        targetMid = Math.max(...sortedMids);\r\n      }\r\n    }\r\n\r\n    const topIds = sortedMids.slice(sortedMids.findIndex((mid) => targetMid > mid));\r\n    const middleIds = isAdditionRender ? [] : [targetMid];\r\n    const bottomIds = isAdditionRender ? [] : sortedMids.slice(0, sortedMids.findIndex((mid) => targetMid >= mid)).reverse();\r\n    \r\n    if(DEBUG) {\r\n      log('targeting mid:', targetMid, maxId, additionMsgId, \r\n        topIds.map((m) => getServerMessageId(m)), \r\n        bottomIds.map((m) => getServerMessageId(m)));\r\n    }\r\n\r\n    const setBubbles: HTMLElement[] = [];\r\n\r\n    this.chatInner.classList.add('zoom-fading');\r\n    const delay = isAdditionRender ? 10 : 40;\r\n    const offsetIndex = isAdditionRender ? 0 : 1;\r\n    const animateAsLadder = (mids: number[], offsetIndex = 0) => {\r\n      const animationPromise = deferredPromise<void>();\r\n      let lastMsDelay = 0;\r\n      mids.forEach((mid, idx) => {\r\n        const bubble = this.bubbles[mid];\r\n        if(!bubble || this.skippedMids.has(mid)) {\r\n          log.warn('no bubble by mid:', mid);\r\n          return;\r\n        }\r\n\r\n        lastMsDelay = ((idx + offsetIndex) || 0.1) * delay;\r\n        //lastMsDelay = (idx + offsetIndex) * delay;\r\n        //lastMsDelay = (idx || 0.1) * 1000;\r\n\r\n        const contentWrapper = bubble.lastElementChild as HTMLElement;\r\n        const elementsToAnimate: HTMLElement[] = [contentWrapper];\r\n        const item = this.bubbleGroups.getItemByBubble(bubble);\r\n        if(item && item.group.avatar && item.group.lastItem === item) {\r\n          elementsToAnimate.push(item.group.avatar);\r\n        }\r\n\r\n        elementsToAnimate.forEach((element) => {\r\n          element.classList.add('zoom-fade', 'can-zoom-fade');\r\n          element.style.transitionDelay = lastMsDelay + 'ms';\r\n        });\r\n        \r\n        if(idx === (mids.length - 1)) {\r\n          const onTransitionEnd = (e: TransitionEvent) => {\r\n            if(e.target !== contentWrapper) {\r\n              return;\r\n            }\r\n\r\n            animationPromise.resolve();\r\n            contentWrapper.removeEventListener('transitionend', onTransitionEnd);\r\n          };\r\n\r\n          contentWrapper.addEventListener('transitionend', onTransitionEnd);\r\n        }\r\n\r\n        setBubbles.push(...elementsToAnimate);\r\n      });\r\n\r\n      if(!mids.length) {\r\n        animationPromise.resolve();\r\n      }\r\n\r\n      return {lastMsDelay, animationPromise};\r\n    };\r\n\r\n    const topRes = animateAsLadder(topIds, offsetIndex);\r\n    const middleRes = animateAsLadder(middleIds);\r\n    const bottomRes = animateAsLadder(bottomIds, offsetIndex);\r\n    const promises = [topRes.animationPromise, middleRes.animationPromise, bottomRes.animationPromise];\r\n    const delays: number[] = [topRes.lastMsDelay, middleRes.lastMsDelay, bottomRes.lastMsDelay];\r\n\r\n    if(this.onAnimateLadder) {\r\n      await this.onAnimateLadder();\r\n    }\r\n\r\n    fastRaf(() => {\r\n      this.setStickyDateManually(); // ! maybe it's not efficient\r\n\r\n      setBubbles.forEach((element) => {\r\n        element.classList.remove('zoom-fade');\r\n      });\r\n    });\r\n\r\n    let promise: Promise<any>;\r\n    if(topIds.length || middleIds.length || bottomIds.length) {\r\n      promise = Promise.all(promises);\r\n\r\n      dispatchHeavyAnimationEvent(promise, Math.max(...delays) + 200) // * 200 - transition time\r\n      .then(() => { \r\n        fastRaf(() => {\r\n          setBubbles.forEach((element) => {\r\n            element.style.transitionDelay = '';\r\n            element.classList.remove('can-zoom-fade');\r\n          });\r\n\r\n          this.chatInner.classList.remove('zoom-fading');\r\n        });\r\n\r\n        // !  , -  - zoom-fade        , \r\n        // ! ..   ,  ,     translateZ    scrollable\r\n        // if(!IS_SAFARI) {\r\n        //   this.needReflowScroll = true;\r\n        // }\r\n      });\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  private async renderEmptyPlaceholder(\r\n    type: 'group' | 'saved' | 'noMessages' | 'noScheduledMessages' | 'greeting' | 'restricted', \r\n    bubble: HTMLElement, \r\n    message: any, \r\n    elements: (Node | string)[]\r\n  ) {\r\n    const BASE_CLASS = 'empty-bubble-placeholder';\r\n    bubble.classList.add(BASE_CLASS, BASE_CLASS + '-' + type);\r\n\r\n    let title: HTMLElement; \r\n    if(type === 'group') title = i18n('GroupEmptyTitle1');\r\n    else if(type === 'saved') title = i18n('ChatYourSelfTitle');\r\n    else if(type === 'noMessages' || type === 'greeting') title = i18n('NoMessages');\r\n    else if(type === 'noScheduledMessages') title = i18n('NoScheduledMessages');\r\n    else if(type === 'restricted') {\r\n      title = document.createElement('span');\r\n      title.innerText = await this.managers.appPeersManager.getRestrictionReasonText(this.peerId);\r\n    }\r\n    title.classList.add('center', BASE_CLASS + '-title');\r\n\r\n    elements.push(title);\r\n\r\n    let listElements: HTMLElement[];\r\n    if(type === 'group') {\r\n      elements.push(i18n('GroupEmptyTitle2'));\r\n      listElements = [\r\n        i18n('GroupDescription1'),\r\n        i18n('GroupDescription2'),\r\n        i18n('GroupDescription3'),\r\n        i18n('GroupDescription4')\r\n      ];\r\n    } else if(type === 'saved') {\r\n      listElements = [\r\n        i18n('ChatYourSelfDescription1'),\r\n        i18n('ChatYourSelfDescription2'),\r\n        i18n('ChatYourSelfDescription3'),\r\n        i18n('ChatYourSelfDescription4')\r\n      ];\r\n    } else if(type === 'greeting') {\r\n      const subtitle = i18n('NoMessagesGreetingsDescription');\r\n      subtitle.classList.add('center', BASE_CLASS + '-subtitle');\r\n\r\n      // findAndSplice(this.messagesQueue, q => q.bubble === bubble);\r\n\r\n      const stickerDiv = document.createElement('div');\r\n      stickerDiv.classList.add(BASE_CLASS + '-sticker');\r\n\r\n      const middleware = this.getMiddleware();\r\n      \r\n      await this.managers.appStickersManager.getGreetingSticker().then(async(doc) => {\r\n        if(!middleware()) return;\r\n\r\n        const loadPromises: Promise<any>[] = [];\r\n        await wrapSticker({\r\n          doc, \r\n          // doc: appDocsManager.getDoc(\"5431607541660389336\"), // cubigator mockup\r\n          div: stickerDiv,\r\n          middleware,\r\n          lazyLoadQueue: this.lazyLoadQueue,\r\n          group: CHAT_ANIMATION_GROUP,\r\n          //play: !!message.pending || !multipleRender,\r\n          play: true,\r\n          loop: true,\r\n          withThumb: true,\r\n          loadPromises\r\n        });\r\n\r\n        attachClickEvent(stickerDiv, (e) => {\r\n          cancelEvent(e);\r\n          EmoticonsDropdown.onMediaClick({target: e.target});\r\n        });\r\n\r\n        return Promise.all(loadPromises);\r\n      });\r\n\r\n      // this.renderMessagesQueue({\r\n      //   message, \r\n      //   bubble, \r\n      //   reverse: false, \r\n      //   promises: [loadPromise]\r\n      // });\r\n\r\n      elements.push(subtitle, stickerDiv);\r\n    }\r\n\r\n    if(listElements) {\r\n      elements.push(\r\n        ...listElements.map((elem) => {\r\n          const span = document.createElement('span');\r\n          span.classList.add(BASE_CLASS + '-list-item');\r\n          span.append(elem);\r\n          return span;\r\n        })\r\n      );\r\n  \r\n      if(type === 'group') {\r\n        listElements.forEach((elem) => {\r\n          const i = document.createElement('span');\r\n          i.classList.add('tgico-check');\r\n          elem.prepend(i);\r\n        });\r\n      } else if(type === 'saved') {\r\n        listElements.forEach((elem) => {\r\n          const i = document.createElement('span');\r\n          i.classList.add(BASE_CLASS + '-list-bullet');\r\n          i.innerText = '';\r\n          elem.prepend(i);\r\n        });\r\n      }\r\n    }\r\n\r\n    if(elements.length > 1) {\r\n      bubble.classList.add('has-description');\r\n    }\r\n\r\n    elements.forEach((element: any) => element.classList.add(BASE_CLASS + '-line'));\r\n  }\r\n\r\n  private async processLocalMessageRender(message: Message.message | Message.messageService, animate?: boolean) {\r\n    const isSponsored = !!(message as Message.message).pFlags.sponsored;\r\n    const middleware = this.getMiddleware();\r\n    const m = middlewarePromise(middleware);\r\n    return this.safeRenderMessage(message, isSponsored ? false : true, undefined, isSponsored, async(result) => {\r\n      const {bubble} = await m(result);\r\n      if(!bubble) {\r\n        return result;\r\n      }\r\n\r\n      bubble.classList.add('is-group-last', 'is-group-first');\r\n\r\n      const updatePosition = () => {\r\n        if(this.updatePlaceholderPosition === updatePosition) {\r\n          this.updatePlaceholderPosition = undefined;\r\n        }\r\n\r\n        appendTo[method](bubble);\r\n      };\r\n\r\n      if(!isSponsored) {\r\n        bubble.classList.add('bubble-first');\r\n        bubble.classList.remove('can-have-tail', 'is-in');\r\n      }\r\n\r\n      const elements: (Node | string)[] = [];\r\n      const isBot = await m(this.managers.appPeersManager.isBot(this.peerId));\r\n      let renderPromise: Promise<any>, appendTo = this.container, method: 'append' | 'prepend' = 'append';\r\n      if(this.chat.isRestricted) {\r\n        renderPromise = this.renderEmptyPlaceholder('restricted', bubble, message, elements);\r\n      } else if(isSponsored) {\r\n        let text: LangPackKey, mid: number, startParam: string, callback: () => void;\r\n\r\n        bubble.classList.add('avoid-selection');\r\n\r\n        const sponsoredMessage = this.sponsoredMessage = (message as Message.message).sponsoredMessage;\r\n        const peerId = getPeerId(sponsoredMessage.from_id);\r\n        // const peer = this.appPeersManager.getPeer(peerId);\r\n        if(sponsoredMessage.channel_post) {\r\n          text = 'OpenChannelPost';\r\n          mid = generateMessageId(sponsoredMessage.channel_post);\r\n        } else if(sponsoredMessage.start_param || isBot) {\r\n          text = 'Chat.Message.ViewBot';\r\n          startParam = sponsoredMessage.start_param;\r\n        } else {\r\n          text = await this.managers.appPeersManager.isAnyGroup(peerId) ? 'Chat.Message.ViewGroup' : 'Chat.Message.ViewChannel';\r\n        }\r\n\r\n        if(sponsoredMessage.chat_invite) {\r\n          callback = () => {\r\n            new PopupJoinChatInvite(sponsoredMessage.chat_invite_hash, sponsoredMessage.chat_invite as ChatInvite.chatInvite);\r\n          };\r\n        } else if(sponsoredMessage.chat_invite_hash) {\r\n          callback = () => {\r\n            const link: InternalLink = {\r\n              _: INTERNAL_LINK_TYPE.JOIN_CHAT,\r\n              invite: sponsoredMessage.chat_invite_hash\r\n            };\r\n            \r\n            this.chat.appImManager.processInternalLink(link);\r\n          };\r\n        } else {\r\n          callback = () => {\r\n            this.chat.appImManager.setInnerPeer({\r\n              peerId,\r\n              lastMsgId: mid,\r\n              startParam\r\n            });\r\n          };\r\n        }\r\n\r\n        const button = Button('btn-primary btn-primary-transparent bubble-view-button', {\r\n          text\r\n        });\r\n\r\n        this.observer.observe(button, this.viewsObserverCallback);\r\n\r\n        if(callback) {\r\n          attachClickEvent(button, callback);\r\n        }\r\n\r\n        bubble.querySelector('.bubble-content').prepend(button);\r\n\r\n        return result;\r\n      } else if(isBot && message._ === 'message') {\r\n        const b = document.createElement('b');\r\n        b.append(i18n('BotInfoTitle'));\r\n        elements.push(b, '\\n\\n');\r\n        appendTo = this.chatInner;\r\n        method = 'prepend';\r\n      } else if(await m(this.managers.appPeersManager.isAnyGroup(this.peerId)) && (await m(this.managers.appPeersManager.getPeer(this.peerId))).pFlags.creator) {\r\n        renderPromise = this.renderEmptyPlaceholder('group', bubble, message, elements);\r\n      } else if(this.chat.type === 'scheduled') {\r\n        renderPromise = this.renderEmptyPlaceholder('noScheduledMessages', bubble, message, elements);\r\n      } else if(rootScope.myId === this.peerId) {\r\n        renderPromise = this.renderEmptyPlaceholder('saved', bubble, message, elements);\r\n      } else if(this.peerId.isUser() && !isBot && await m(this.chat.canSend()) && this.chat.type === 'chat') {\r\n        renderPromise = this.renderEmptyPlaceholder('greeting', bubble, message, elements);\r\n      } else {\r\n        renderPromise = this.renderEmptyPlaceholder('noMessages', bubble, message, elements);\r\n      }\r\n\r\n      if(renderPromise) {\r\n        await renderPromise;\r\n      }\r\n\r\n      if(elements.length) {\r\n        const messageDiv = bubble.querySelector('.message, .service-msg');\r\n        messageDiv.prepend(...elements);\r\n      }\r\n\r\n      const isWaitingForAnimation = !!this.messagesQueueOnRenderAdditional;\r\n      const noTransition = this.setPeerCached && !isWaitingForAnimation;\r\n      if(noTransition) {\r\n        const setOn = bubble.firstElementChild;\r\n        setOn.classList.add('no-transition');\r\n        \r\n        if(this.chat.setPeerPromise) {\r\n          this.chat.setPeerPromise.catch(noop).finally(() => {\r\n            setOn.classList.remove('no-transition');\r\n          });\r\n        }\r\n      }\r\n\r\n      if(animate === undefined && !noTransition) {\r\n        animate = true;\r\n      }\r\n\r\n      if(isWaitingForAnimation || animate) {\r\n        this.updatePlaceholderPosition = updatePosition;\r\n\r\n        this.onAnimateLadder = () => {\r\n          // appendTo[method](bubble);\r\n          this.onAnimateLadder = undefined;\r\n\r\n          // need raf here because animation won't fire if this message is single\r\n          if(!this.messagesQueuePromise) {\r\n            return fastRafPromise();\r\n          }\r\n        };\r\n      } else if(this.chat.setPeerPromise) {\r\n        this.attachPlaceholderOnRender = () => {\r\n          this.attachPlaceholderOnRender = undefined;\r\n          updatePosition();\r\n          // appendTo[method](bubble);\r\n        };\r\n      } else {\r\n        this.updatePlaceholderPosition = updatePosition;\r\n        // appendTo[method](bubble);\r\n      }\r\n\r\n      if(!isWaitingForAnimation && animate) {\r\n        await m(getHeavyAnimationPromise());\r\n        const additionMsgIds = getObjectKeysAndSort(this.bubbles);\r\n        indexOfAndSplice(additionMsgIds, message.mid);\r\n        this.animateAsLadder(message.mid, additionMsgIds, false, 0, 0);\r\n      }\r\n\r\n      // if(!isSponsored) {\r\n        this.emptyPlaceholderBubble = bubble;\r\n      // }\r\n\r\n      return result;\r\n    });\r\n  }\r\n\r\n  private generateLocalMessageId(addOffset = 0) {\r\n    // const INCREMENT = 0x10;\r\n    let offset = (this.chat.type === 'scheduled' ? -1 : 0) + addOffset;\r\n    // offset = generateMessageId(offset);\r\n    // id: -Math.abs(+this.peerId * INCREMENT + offset),\r\n    const id = -Math.abs(offset);\r\n    const mid = -Math.abs(generateMessageId(id));\r\n    return {id, mid};\r\n  }\r\n\r\n  private async generateLocalFirstMessage<T extends boolean>(service?: T, fill?: (message: GenerateLocalMessageType<T>) => void, addOffset = 0): Promise<GenerateLocalMessageType<T>> {\r\n    const {id, mid} = this.generateLocalMessageId(addOffset);\r\n    let message: Omit<Message.message | Message.messageService, 'message'> & {message?: string} = {\r\n      _: service ? 'messageService' : 'message',\r\n      date: 0,\r\n      id,\r\n      mid,\r\n      peer_id: await this.managers.appPeersManager.getOutputPeer(this.peerId),\r\n      pFlags: {\r\n        local: true\r\n      }\r\n    };\r\n\r\n    if(!service) {\r\n      message.message = '';\r\n    }/*  else {\r\n      (message as Message.messageService).action = {} as any;\r\n    } */\r\n\r\n    assumeType<GenerateLocalMessageType<T>>(message);\r\n\r\n    fill && fill(message);\r\n\r\n    const savedMessages = await this.managers.appMessagesManager.saveMessages([message], {storage: new Map() as any});\r\n    message = savedMessages[0];\r\n    message.mid = mid;\r\n    return message as any;\r\n  }\r\n\r\n  public getViewportSlice() {\r\n    // this.log.trace('viewport slice');\r\n    return getViewportSlice({\r\n      overflowElement: this.scrollable.container, \r\n      selector: '.bubbles-date-group .bubble:not(.is-date)',\r\n      extraSize: Math.max(700, windowSize.height) * 2\r\n    });\r\n  }\r\n\r\n  public deleteViewportSlice(slice: ReturnType<ChatBubbles['getViewportSlice']>, ignoreScrollSaving?: boolean) {\r\n    if(DO_NOT_SLICE_VIEWPORT_ON_RENDER) {\r\n      return;\r\n    }\r\n\r\n    const {invisibleTop, invisibleBottom} = slice;\r\n    const invisible = invisibleTop.concat(invisibleBottom);\r\n    if(!invisible.length) {\r\n      return;\r\n    }\r\n\r\n    if(invisibleTop.length) {\r\n      this.setLoaded('top', false);\r\n      this.getHistoryTopPromise = undefined;\r\n    }\r\n\r\n    if(invisibleBottom.length) {\r\n      this.setLoaded('bottom', false);\r\n      this.getHistoryBottomPromise = undefined;\r\n    }\r\n\r\n    const mids = invisible.map(({element}) => +element.dataset.mid);\r\n\r\n    let scrollSaver: ScrollSaver;\r\n    if(!!invisibleTop.length !== !!invisibleBottom.length && !ignoreScrollSaving) {\r\n      scrollSaver = this.createScrollSaver(!!invisibleTop.length);\r\n      scrollSaver.save();\r\n    }\r\n    \r\n    this.deleteMessagesByIds(mids, false, true);\r\n\r\n    if(scrollSaver) {\r\n      scrollSaver.restore();\r\n    } else if(invisibleTop.length) {\r\n      this.scrollable.lastScrollPosition = this.scrollable.scrollTop;\r\n    }\r\n  }\r\n\r\n  public sliceViewport(ignoreHeavyAnimation?: boolean) {\r\n    // Safari cannot reset the scroll.\r\n    if(IS_SAFARI || (this.isHeavyAnimationInProgress && !ignoreHeavyAnimation) || DO_NOT_SLICE_VIEWPORT) {\r\n      return;\r\n    }\r\n\r\n    // const scrollSaver = new ScrollSaver(this.scrollable, true);\r\n    // scrollSaver.save();\r\n    const slice = this.getViewportSlice();\r\n    // if(IS_SAFARI) slice.invisibleTop = [];\r\n    this.deleteViewportSlice(slice);\r\n    // scrollSaver.restore();\r\n  }\r\n\r\n  private async setLoaded(side: SliceSides, value: boolean, checkPlaceholders = true) {\r\n    const willChange = this.scrollable.loadedAll[side] !== value;\r\n    if(!willChange) {\r\n      return;\r\n    }\r\n\r\n    const log = this.log.bindPrefix('setLoaded');\r\n    log('change', side, value);\r\n\r\n    this.scrollable.loadedAll[side] = value;\r\n\r\n    // return;\r\n\r\n    if(!checkPlaceholders) {\r\n      return;\r\n    }\r\n\r\n    if(!this.chat.isRestricted) {\r\n      if(side === 'bottom' && await this.managers.appPeersManager.isBroadcast(this.peerId)/*  && false */) {\r\n        this.toggleSponsoredMessage(value);\r\n      }\r\n  \r\n      if(side === 'top' && value && await this.managers.appPeersManager.isBot(this.peerId)) {\r\n        return this.renderBotPlaceholder();\r\n      }\r\n    }\r\n\r\n    return this.checkIfEmptyPlaceholderNeeded();\r\n  }\r\n\r\n  private async toggleSponsoredMessage(value: boolean) {\r\n    const _log = this.log.bindPrefix('sponsored');\r\n    _log('checking');\r\n    const {mid} = this.generateLocalMessageId(SPONSORED_MESSAGE_ID_OFFSET);\r\n    if(value) {\r\n      const middleware = this.getMiddleware(() => {\r\n        return this.scrollable.loadedAll.bottom && !this.bubbles[mid] && this.getSponsoredMessagePromise === promise;\r\n      });\r\n\r\n      const promise = this.getSponsoredMessagePromise = this.managers.appChatsManager.getSponsoredMessage(this.peerId.toChatId())\r\n      .then(async(sponsoredMessages) => {\r\n        const sponsoredMessage = sponsoredMessages.messages[0];\r\n        if(!sponsoredMessage) {\r\n          _log('no message');\r\n          return;\r\n        }\r\n\r\n        const messagePromise = this.generateLocalFirstMessage(false, (message) => {\r\n          message.message = sponsoredMessage.message;\r\n          message.from_id = sponsoredMessage.from_id;\r\n          message.entities = sponsoredMessage.entities;\r\n          message.pFlags.sponsored = true;\r\n          message.sponsoredMessage = sponsoredMessage;\r\n        }, SPONSORED_MESSAGE_ID_OFFSET);\r\n  \r\n        return Promise.all([\r\n          messagePromise,\r\n          this.getHistoryTopPromise, // wait for top load and execute rendering after or with it\r\n          this.messagesQueuePromise\r\n        ]).then(([message]) => {\r\n          if(!middleware()) return;\r\n          // this.processLocalMessageRender(message);\r\n          _log('rendering', message);\r\n          const promise = this.performHistoryResult({history: [message]}, false);\r\n        });\r\n      }).finally(() => {\r\n        this.getSponsoredMessagePromise = undefined;\r\n      });\r\n    } else {\r\n      _log('clearing rendered', mid);\r\n      this.deleteMessagesByIds([mid]);\r\n      this.getSponsoredMessagePromise = undefined;\r\n    }\r\n  }\r\n\r\n  private async renderBotPlaceholder() {\r\n    const _log = this.log.bindPrefix('bot placeholder');\r\n      \r\n    const middleware = this.getMiddleware();\r\n    const result = await this.managers.acknowledged.appProfileManager.getProfile(this.peerId.toUserId());\r\n    _log('getting profile, cached:', result.cached);\r\n    const processPromise = result.result.then(async(userFull) => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      if(!userFull.bot_info?.description) {\r\n        _log.warn('no description');\r\n        return this.checkIfEmptyPlaceholderNeeded();\r\n      }\r\n\r\n      const message = await this.generateLocalFirstMessage(false, (message) => {\r\n        message.message = userFull.bot_info.description;\r\n      });\r\n\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      _log('rendering');\r\n      const renderPromise = this.processLocalMessageRender(message, !result.cached).then(() => {\r\n        _log('done');\r\n      });\r\n\r\n      return {renderPromise};\r\n    });\r\n\r\n    if(!result.cached) {\r\n      return;\r\n    }\r\n\r\n    return processPromise;\r\n  }\r\n\r\n  public async checkIfEmptyPlaceholderNeeded() {\r\n    if(this.scrollable.loadedAll.top && \r\n      this.scrollable.loadedAll.bottom && \r\n      this.emptyPlaceholderBubble === undefined && \r\n      (\r\n        this.chat.isRestricted || \r\n        !(await this.chat.getHistoryStorage()).count || \r\n        (\r\n          !Object.keys(this.bubbles).length || \r\n          // ! WARNING ! ! ! ! ! ! REPLACE LINE ABOVE WITH THESE\r\n          Object.keys(this.bubbles).length && \r\n          !this.getRenderedLength()\r\n        ) ||\r\n        (this.chat.type === 'scheduled' && !Object.keys(this.bubbles).length)\r\n      )\r\n    ) {\r\n      this.log('inject empty peer placeholder');\r\n\r\n      const message = await this.generateLocalFirstMessage(true);\r\n      return {renderPromise: this.processLocalMessageRender(message)};\r\n    }\r\n  }\r\n\r\n  public getHistory1(maxId?: number, reverse?: boolean, isBackLimit?: boolean, additionMsgId?: number, justLoad?: boolean) {\r\n    const middleware = this.getMiddleware(justLoad ? undefined : () => {\r\n      return (reverse ? this.getHistoryTopPromise : this.getHistoryBottomPromise) === waitPromise;\r\n    });\r\n\r\n    const result = this.getHistory(maxId, reverse, isBackLimit, additionMsgId, justLoad, middleware);\r\n    const waitPromise = result.then((res) => res && (res.waitPromise || res.promise));\r\n\r\n    (reverse ? this.getHistoryTopPromise = waitPromise : this.getHistoryBottomPromise = waitPromise);\r\n    waitPromise.then(() => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      (reverse ? this.getHistoryTopPromise = undefined : this.getHistoryBottomPromise = undefined);\r\n\r\n      if(!justLoad) {\r\n        // preload more\r\n        //if(!isFirstMessageRender) {\r\n          if(this.chat.type === 'chat'/*  || this.chat.type === 'discussion' */) {\r\n            /* const storage = this.appMessagesManager.getHistoryStorage(peerId, this.chat.threadId);\r\n            const isMaxIdInHistory = storage.history.indexOf(maxId) !== -1;\r\n            if(isMaxIdInHistory || true) { // * otherwise it is a search or jump */\r\n              setTimeout(() => {\r\n                if(reverse) {\r\n                  this.loadMoreHistory(true, true);\r\n                } else {\r\n                  this.loadMoreHistory(false, true);\r\n                }\r\n              }, 0);\r\n            //}\r\n          }\r\n        //}\r\n      }\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Load and render history\r\n   * @param maxId max message id\r\n   * @param reverse 'true' means up\r\n   * @param isBackLimit is search\r\n   * @param additionMsgId for the last message\r\n   * @param justLoad do not render\r\n   */\r\n  public async getHistory(\r\n    maxId = 0, \r\n    reverse = false, \r\n    isBackLimit = false, \r\n    additionMsgId = 0, \r\n    justLoad = false,\r\n    middleware?: () => boolean\r\n  ): Promise<{cached: boolean, promise: Promise<void>, waitPromise: Promise<any>}> {\r\n    const peerId = this.peerId;\r\n\r\n    const isBroadcast = await this.managers.appPeersManager.isBroadcast(peerId);\r\n    //console.time('appImManager call getHistory');\r\n    const pageCount = Math.min(30, windowSize.height / 40/*  * 1.25 */ | 0);\r\n    //const loadCount = Object.keys(this.bubbles).length > 0 ? 50 : pageCount;\r\n    const realLoadCount = isBroadcast ? 20 : (Object.keys(this.bubbles).length > 0 ? Math.max(35, pageCount) : pageCount);\r\n    //const realLoadCount = pageCount;//const realLoadCount = 50;\r\n    let loadCount = realLoadCount;\r\n    \r\n    /* if(TEST_SCROLL) {\r\n      //loadCount = 1;\r\n      if(Object.keys(this.bubbles).length > 0)\r\n      return {cached: false, promise: Promise.resolve(true)};\r\n    } */\r\n    if(TEST_SCROLL !== undefined) {\r\n      if(TEST_SCROLL) {\r\n        if(Object.keys(this.bubbles).length > 0) {\r\n          --TEST_SCROLL;\r\n        }\r\n      } else {\r\n        return {cached: false, promise: Promise.resolve(), waitPromise: Promise.resolve()};\r\n      }\r\n    }\r\n    \r\n    ////console.time('render history total');\r\n    \r\n    let backLimit = 0;\r\n    if(isBackLimit) {\r\n      backLimit = loadCount;\r\n\r\n      if(!reverse) { // if not jump\r\n        loadCount = 0;\r\n        //maxId = this.appMessagesManager.incrementMessageId(maxId, 1);\r\n      }\r\n    }\r\n\r\n    let additionMsgIds: number[];\r\n    if(additionMsgId && !isBackLimit) {\r\n      if(this.chat.type === 'pinned') {\r\n        additionMsgIds = [additionMsgId];\r\n      } else {\r\n        const historyStorage = await this.chat.getHistoryStorage();\r\n        const slice = historyStorage.history.slice;\r\n        if(slice.length < loadCount && !slice.isEnd(SliceEnd.Both)) {\r\n          additionMsgIds = slice.slice();\r\n\r\n          // * filter last album, because we don't know is it the last item\r\n          for(let i = additionMsgIds.length - 1; i >= 0; --i) {\r\n            const message = await this.chat.getMessage(additionMsgIds[i]);\r\n            if((message as Message.message)?.grouped_id) additionMsgIds.splice(i, 1);\r\n            else break;\r\n          }\r\n\r\n          maxId = additionMsgIds[additionMsgIds.length - 1] || maxId;\r\n        }\r\n      }\r\n    }\r\n\r\n    /* const result = additionMsgID ? \r\n      {history: [additionMsgID]} : \r\n      appMessagesManager.getHistory(this.peerId, maxId, loadCount, backLimit); */\r\n    let result: AckedResult<MyHistoryResult> = await this.requestHistory(maxId, loadCount, backLimit) as any;\r\n    let resultPromise: typeof result['result'];\r\n\r\n    //const isFirstMessageRender = !!additionMsgID && result.cached && !appMessagesManager.getMessage(additionMsgID).grouped_id;\r\n    const isAdditionRender = additionMsgIds?.length && !result.cached;\r\n    const isFirstMessageRender = (this.isFirstLoad && backLimit && !result.cached) || isAdditionRender;\r\n    if(isAdditionRender) {\r\n      resultPromise = result.result;\r\n\r\n      result = {\r\n        cached: true,\r\n        result: Promise.resolve({history: additionMsgIds})\r\n      };\r\n\r\n      //additionMsgID = 0;\r\n    }\r\n\r\n    this.isFirstLoad = false;\r\n\r\n    const processResult = async(historyResult: Awaited<typeof result['result']>) => {\r\n      if((historyResult as HistoryResult).isEnd?.top) {\r\n        if(this.chat.type === 'discussion') { // * inject discussion start\r\n          const serviceStartMessageId = await this.managers.appMessagesManager.getThreadServiceMessageId(this.peerId, this.chat.threadId);\r\n          if(serviceStartMessageId) historyResult.history.push(serviceStartMessageId);\r\n          const mids = await this.chat.getMidsByMid(this.chat.threadId);\r\n          historyResult.history.push(...mids.reverse());\r\n        }\r\n\r\n        // synchronize bot placeholder appearance\r\n        await this.managers.appProfileManager.getProfileByPeerId(peerId);\r\n\r\n        // await this.setLoaded('top', true);\r\n      }\r\n    };\r\n\r\n    const sup = (historyResult: Awaited<typeof result['result']>) => {\r\n      return getHeavyAnimationPromise().then(() => {\r\n        return processResult(historyResult);\r\n      }).then(() => {\r\n        if(!isAdditionRender && additionMsgId) {\r\n          historyResult.history.unshift(additionMsgId);\r\n        }\r\n\r\n        return this.performHistoryResult(historyResult, reverse);\r\n      });\r\n    };\r\n\r\n    const processPromise = (_promise: typeof result['result']) => {\r\n      const promise = Promise.resolve(_promise).then((result) => {\r\n        if(middleware && !middleware()) {\r\n          throw PEER_CHANGED_ERROR;\r\n        }\r\n\r\n        if(justLoad) {\r\n          //   -  \r\n          this.scrollable.onScroll();\r\n          // fastRaf(() => {\r\n          //   this.scrollable.checkForTriggers();\r\n          // });\r\n          return;\r\n        }\r\n\r\n        return sup(result);\r\n      }, (err) => {\r\n        this.log.error('getHistory error:', err);\r\n        throw err;\r\n      });\r\n      \r\n      return promise;\r\n    };\r\n\r\n    let promise: Promise<void>, cached: boolean;\r\n    if(!result.cached) {\r\n      cached = false;\r\n      promise = processPromise(result.result);\r\n    } else if(justLoad) {\r\n      //   -  \r\n      this.scrollable.onScroll();\r\n      return null;\r\n    } else {\r\n      cached = true;\r\n      promise = sup(await result.result);\r\n    }\r\n\r\n    const waitPromise = isAdditionRender ? processPromise(resultPromise) : promise;\r\n\r\n    if(isFirstMessageRender && rootScope.settings.animationsEnabled/*  && false */) {\r\n      let times = isAdditionRender ? 2 : 1;\r\n      this.messagesQueueOnRenderAdditional = () => {\r\n        this.log('messagesQueueOnRenderAdditional');\r\n\r\n        if(--times) return;\r\n\r\n        this.messagesQueueOnRenderAdditional = undefined;\r\n        \r\n        const promise = this.animateAsLadder(additionMsgId, additionMsgIds, isAdditionRender, backLimit, maxId);\r\n        promise.then(() => {\r\n          setTimeout(() => { // preload messages\r\n            this.loadMoreHistory(reverse, true);\r\n          }, 0);\r\n        });\r\n      };\r\n    } else {\r\n      this.messagesQueueOnRenderAdditional = undefined;\r\n    }\r\n\r\n    if(justLoad) {\r\n      return null;\r\n    }\r\n\r\n    return {cached, promise, waitPromise};\r\n  }\r\n\r\n  public async setUnreadDelimiter() {\r\n    if(!(this.chat.type === 'chat' || this.chat.type === 'discussion')) {\r\n      return;\r\n    }\r\n\r\n    if(this.attachedUnreadBubble) {\r\n      return;\r\n    }\r\n\r\n    const historyMaxId = await this.chat.getHistoryMaxId();\r\n    let readMaxId = await this.managers.appMessagesManager.getReadMaxIdIfUnread(this.peerId, this.chat.threadId);\r\n    if(!readMaxId) return;\r\n\r\n    readMaxId = Object.keys(this.bubbles)\r\n    .filter((mid) => !this.bubbles[mid].classList.contains('is-out'))\r\n    .map((i) => +i)\r\n    .sort((a, b) => a - b)\r\n    .find((i) => i > readMaxId);\r\n\r\n    if(readMaxId && this.bubbles[readMaxId]) {\r\n      let bubble = this.bubbles[readMaxId];\r\n      if(this.firstUnreadBubble && this.firstUnreadBubble !== bubble) {\r\n        this.firstUnreadBubble.classList.remove('is-first-unread');\r\n        this.firstUnreadBubble = null;\r\n      }\r\n\r\n      if(readMaxId !== historyMaxId) {\r\n        bubble.classList.add('is-first-unread');\r\n      }\r\n\r\n      this.firstUnreadBubble = bubble;\r\n      this.attachedUnreadBubble = true;\r\n    }\r\n  }\r\n\r\n  public deleteEmptyDateGroups() {\r\n    const mustBeCount = this.stickyIntersector ? STICKY_OFFSET : 1;\r\n    let deleted = false;\r\n    for(const i in this.dateMessages) {\r\n      const dateMessage = this.dateMessages[i];\r\n\r\n      if(dateMessage.container.childElementCount === mustBeCount) { // only date div + sentinel div\r\n        dateMessage.container.remove();\r\n        if(this.stickyIntersector) {\r\n          this.stickyIntersector.unobserve(dateMessage.container, dateMessage.div);\r\n        }\r\n        delete this.dateMessages[i];\r\n        deleted = true;\r\n\r\n        // * no sense in it\r\n        /* if(dateMessage.div === this.previousStickyDate) {\r\n          this.previousStickyDate = undefined;\r\n        } */\r\n      }\r\n    }\r\n\r\n    if(!deleted) {\r\n      return;\r\n    }\r\n\r\n    if(!Object.keys(this.dateMessages).length) {\r\n      this.container.classList.remove('has-groups');\r\n    }\r\n\r\n    this.checkIfEmptyPlaceholderNeeded();\r\n    this.setStickyDateManually();\r\n  }\r\n}\r\n\r\nexport function generateTail() {\r\n  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\r\n  svg.setAttributeNS(null, 'viewBox', '0 0 11 20');\r\n  svg.setAttributeNS(null, 'width', '11');\r\n  svg.setAttributeNS(null, 'height', '20');\r\n  svg.classList.add('bubble-tail');\r\n\r\n  const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');\r\n  use.setAttributeNS(null, 'href', '#message-tail-filled');\r\n\r\n  svg.append(use);\r\n\r\n  return svg;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { copyTextToClipboard } from \"../clipboard\";\r\n// import SelectionSaver from \"../selectionSaver\";\r\n// import selectElementContents from \"./selectElementContents\";\r\n\r\nexport default function copyFromElement(element: HTMLElement) {\r\n  copyTextToClipboard(element.textContent);\r\n  // const saver = new SelectionSaver();\r\n  // saver.save();\r\n  // selectElementContents(element);\r\n  // document.execCommand('copy');\r\n  // saver.restore();\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport { MediaSizeType } from \"../../helpers/mediaSizes\";\r\nimport { Message } from \"../../layer\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\nimport { MediaSearchContext } from \"../appMediaPlaybackController\";\r\nimport Chat from \"../chat/chat\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport wrapDocument from \"./document\";\r\n\r\nexport default async function wrapGroupedDocuments({albumMustBeRenderedFull, message, bubble, messageDiv, chat, loadPromises, autoDownloadSize, lazyLoadQueue, searchContext, useSearch, sizeType, managers}: {\r\n  albumMustBeRenderedFull: boolean,\r\n  message: any,\r\n  messageDiv: HTMLElement,\r\n  bubble: HTMLElement,\r\n  uploading?: boolean,\r\n  chat: Chat,\r\n  loadPromises?: Promise<any>[],\r\n  autoDownloadSize?: number,\r\n  lazyLoadQueue?: LazyLoadQueue,\r\n  searchContext?: MediaSearchContext,\r\n  useSearch?: boolean,\r\n  sizeType?: MediaSizeType,\r\n  managers?: AppManagers\r\n}) {\r\n  let nameContainer: HTMLElement;\r\n  const mids = albumMustBeRenderedFull ? await chat.getMidsByMid(message.mid) : [message.mid];\r\n  /* if(isPending) {\r\n    mids.reverse();\r\n  } */\r\n\r\n  const promises = mids.map(async(mid, idx) => {\r\n    const message = (await chat.getMessage(mid)) as Message.message;\r\n    const div = await wrapDocument({\r\n      message,\r\n      loadPromises,\r\n      autoDownloadSize,\r\n      lazyLoadQueue,\r\n      searchContext,\r\n      sizeType,\r\n      managers\r\n    });\r\n\r\n    const container = document.createElement('div');\r\n    container.classList.add('document-container');\r\n    container.dataset.mid = '' + mid;\r\n    container.dataset.peerId = '' + message.peerId;\r\n\r\n    const wrapper = document.createElement('div');\r\n    wrapper.classList.add('document-wrapper');\r\n    \r\n    if(message.message) {\r\n      const messageDiv = document.createElement('div');\r\n      messageDiv.classList.add('document-message');\r\n\r\n      const richText = wrapRichText(message.message, {\r\n        entities: message.totalEntities\r\n      });\r\n\r\n      setInnerHTML(messageDiv, richText);\r\n      wrapper.append(messageDiv);\r\n    }\r\n\r\n    if(mids.length > 1) {\r\n      const selection = document.createElement('div');\r\n      selection.classList.add('document-selection');\r\n      container.append(selection);\r\n      \r\n      container.classList.add('grouped-item');\r\n\r\n      if(idx === 0) {\r\n        nameContainer = wrapper;\r\n      }\r\n    }\r\n\r\n    wrapper.append(div);\r\n    container.append(wrapper);\r\n    return container;\r\n  });\r\n\r\n  const containers = await Promise.all(promises);\r\n  messageDiv.append(...containers);\r\n\r\n  if(mids.length > 1) {\r\n    bubble.classList.add('is-multiple-documents', 'is-grouped');\r\n  }\r\n\r\n  return nameContainer;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport PollElement from \"../poll\";\r\n\r\nexport default function wrapPoll(message: any, managers: AppManagers = rootScope.managers) {\r\n  const elem = new PollElement();\r\n  elem.message = message;\r\n  elem.managers = managers;\r\n  elem.setAttribute('peer-id', '' + message.peerId);\r\n  elem.setAttribute('poll-id', message.media.poll.id);\r\n  elem.setAttribute('message-id', '' + message.mid);\r\n  elem.render();\r\n  return elem;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getVisibleRect from \"./getVisibleRect\";\r\n\r\nexport type ViewportSlicePart = {element: HTMLElement, rect: DOMRect, visibleRect: ReturnType<typeof getVisibleRect>}[];\r\n\r\nexport default function getViewportSlice({overflowElement, selector, extraSize}: {\r\n  overflowElement: HTMLElement,\r\n  selector: string,\r\n  extraSize?: number\r\n}) {\r\n  // const perf = performance.now();\r\n  const overflowRect = overflowElement.getBoundingClientRect();\r\n  const elements = Array.from(overflowElement.querySelectorAll<HTMLElement>(selector));\r\n\r\n  const invisibleTop: ViewportSlicePart = [], \r\n    visible: typeof invisibleTop = [], \r\n    invisibleBottom: typeof invisibleTop = [];\r\n  let foundVisible = false;\r\n  for(const element of elements) {\r\n    const rect = element.getBoundingClientRect();\r\n    const visibleRect = getVisibleRect(element, overflowElement, false, rect, overflowRect);\r\n    \r\n    const isVisible = !!visibleRect;\r\n    let array: typeof invisibleTop;\r\n    if(isVisible) {\r\n      foundVisible = true;\r\n      array = visible;\r\n    } else if(foundVisible) {\r\n      array = invisibleBottom; \r\n    } else {\r\n      array = invisibleTop;\r\n    }\r\n\r\n    array.push({\r\n      element,\r\n      rect,\r\n      visibleRect\r\n    });\r\n  }\r\n\r\n  if(extraSize && visible.length) {\r\n    const maxTop = visible[0].rect.top;\r\n    const minTop = maxTop - extraSize;\r\n    const minBottom = visible[visible.length - 1].rect.bottom;\r\n    const maxBottom = minBottom + extraSize;\r\n    \r\n    for(let length = invisibleTop.length, i = length - 1; i >= 0; --i) {\r\n      const element = invisibleTop[i];\r\n      if(element.rect.top >= minTop) {\r\n        invisibleTop.splice(i, 1);\r\n        visible.unshift(element);\r\n      }\r\n    }\r\n\r\n    for(let i = 0, length = invisibleBottom.length; i < length; ++i) {\r\n      const element = invisibleBottom[i];\r\n      if(element.rect.bottom <= maxBottom) {\r\n        invisibleBottom.splice(i--, 1);\r\n        --length;\r\n        visible.push(element);\r\n      }\r\n    }\r\n  }\r\n\r\n  // console.log('getViewportSlice time:', performance.now() - perf);\r\n\r\n  return {invisibleTop, visible, invisibleBottom};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement, { addCancelButton } from \".\";\r\nimport PopupPeer, { PopupPeerButtonCallbackCheckboxes, PopupPeerOptions } from \"./peer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport { FormatterArguments, LangPackKey } from \"../../lib/langPack\";\r\nimport PeerTitle from \"../peerTitle\";\r\n\r\nexport default class PopupPinMessage {\r\n  constructor(private peerId: PeerId, private mid: number, private unpin?: true, private onConfirm?: () => void) {\r\n    this.construct();\r\n  }\r\n  \r\n  private async construct() {\r\n    const {peerId, mid, unpin, onConfirm} = this;\r\n    let title: LangPackKey, description: LangPackKey, descriptionArgs: FormatterArguments, \r\n      buttons: PopupPeerOptions['buttons'] = [], checkboxes: PopupPeerOptions['checkboxes'] = [];\r\n\r\n    const managers = PopupElement.MANAGERS;\r\n\r\n    const canUnpin = await managers.appPeersManager.canPinMessage(peerId);\r\n\r\n    const callback = (checked: PopupPeerButtonCallbackCheckboxes, oneSide?: boolean, silent?: boolean) => {\r\n      setTimeout(() => { // * ,   document.elementFromPoint  popup-peer    \r\n        let promise: Promise<any>;\r\n        if(unpin && !mid) {\r\n          if(canUnpin) {\r\n            promise = managers.appMessagesManager.unpinAllMessages(peerId);\r\n          } else {\r\n            promise = managers.appMessagesManager.hidePinnedMessages(peerId);\r\n          }\r\n        } else {\r\n          promise = managers.appMessagesManager.updatePinnedMessage(peerId, mid, unpin, silent, oneSide);\r\n        }\r\n\r\n        if(onConfirm) {\r\n          promise.then(onConfirm);\r\n        }\r\n      }, 300);\r\n    };\r\n\r\n    if(unpin) {\r\n      let buttonText: LangPackKey = 'UnpinMessage';\r\n      if(!mid) {\r\n        if(canUnpin) {\r\n          title = 'Popup.Unpin.AllTitle';\r\n          description = 'Chat.UnpinAllMessagesConfirmation';\r\n          descriptionArgs = ['' + ((await managers.appMessagesManager.getPinnedMessagesCount(peerId)) || 1)];\r\n        } else {\r\n          title = 'Popup.Unpin.HideTitle';\r\n          description = 'Popup.Unpin.HideDescription';\r\n          buttonText = 'Popup.Unpin.Hide';\r\n        }\r\n      } else {\r\n        title = 'UnpinMessageAlertTitle';\r\n        description = 'Chat.Confirm.Unpin';\r\n      }\r\n      \r\n      buttons.push({\r\n        langKey: buttonText,\r\n        isDanger: true,\r\n        callback\r\n      });\r\n    } else {\r\n      title = 'PinMessageAlertTitle';\r\n      const pinButtonText: LangPackKey = 'PinMessage';\r\n      \r\n      if(peerId.isAnyChat()) {\r\n        buttons.push({\r\n          langKey: pinButtonText,\r\n          callback: (checked) => callback(checked, false, !checked.size)\r\n        });\r\n\r\n        if(await managers.appChatsManager.isBroadcast(peerId.toChatId())) {\r\n          description = 'PinMessageAlertChannel';\r\n        } else {\r\n          description = 'PinMessageAlert';\r\n  \r\n          checkboxes.push({\r\n            text: 'PinNotify',\r\n            checked: true\r\n          });\r\n        }\r\n      } else {\r\n        description = 'PinMessageAlertChat';\r\n\r\n        if(peerId === rootScope.myId) {\r\n          buttons.push({\r\n            langKey: pinButtonText,\r\n            callback\r\n          });\r\n        } else {\r\n          buttons.push({\r\n            langKey: pinButtonText,\r\n            callback: (checked) => callback(checked, !checked.size)\r\n          });\r\n\r\n          checkboxes.push({\r\n            text: 'PinAlsoFor',\r\n            textArgs: [new PeerTitle({peerId}).element],\r\n            checked: true\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    addCancelButton(buttons);\r\n\r\n    const popup = new PopupPeer('popup-delete-chat', {\r\n      peerId,\r\n      titleLangKey: title,\r\n      descriptionLangKey: description,\r\n      descriptionLangArgs: descriptionArgs,\r\n      buttons,\r\n      checkboxes\r\n    });\r\n\r\n    popup.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function isSelectionEmpty(selection = window.getSelection()) {\r\n  if(!selection || !selection.rangeCount) {\r\n    return true;\r\n  }\r\n\r\n  const selectionRange = selection.getRangeAt(0);\r\n  if(!selectionRange.toString() || !selectionRange.START_TO_END) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDownloadManager from \"../lib/appManagers/appDownloadManager\";\r\nimport lottieLoader from \"../lib/rlottie/lottieLoader\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { getEmojiToneIndex } from \"../vendor/emoji\";\r\nimport mediaSizes from \"./mediaSizes\";\r\nimport { saveLottiePreview } from \"./saveLottiePreview\";\r\n\r\nexport default function preloadAnimatedEmojiSticker(emoji: string, width?: number, height?: number) {\r\n  return rootScope.managers.appStickersManager.preloadAnimatedEmojiSticker(emoji).then(({doc}) => {\r\n    if(!doc) {\r\n      return;\r\n    }\r\n\r\n    return appDownloadManager.downloadMedia({media: doc})\r\n    .then(async(blob) => {\r\n      const mediaSize = mediaSizes.active.emojiSticker;\r\n      const toneIndex = getEmojiToneIndex(emoji);\r\n      const animation = await lottieLoader.loadAnimationWorker({\r\n        container: undefined,\r\n        animationData: blob,\r\n        width: width ?? mediaSize.width,\r\n        height: height ?? mediaSize.height,\r\n        name: 'doc' + doc.id,\r\n        autoplay: false,\r\n        loop: false,\r\n        toneIndex\r\n      }, 'none');\r\n\r\n      animation.addEventListener('firstFrame', () => {\r\n        saveLottiePreview(doc, animation.canvas, toneIndex);\r\n        animation.remove();\r\n      }, {once: true});\r\n    });\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { ReportReason } from \"../../layer\";\r\nimport InputField from \"../inputField\";\r\nimport { toastNew } from \"../toast\";\r\nimport wrapStickerEmoji from \"../wrappers/stickerEmoji\";\r\nimport PopupPeer from \"./peer\";\r\n\r\nexport default class PopupReportMessagesConfirm extends PopupPeer {\r\n  public static STICKER_EMOJI = '';\r\n  constructor(peerId: PeerId, mids: number[], reason: ReportReason['_'], onConfirm?: () => void) {\r\n    super('popup-report-messages-confirm', {\r\n      noTitle: true, \r\n      descriptionLangKey: 'ReportInfo', \r\n      buttons: [{\r\n        langKey: 'ReportChat',\r\n        callback: () => {\r\n          if(!inputField.isValid()) {\r\n            return;\r\n          }\r\n\r\n          onConfirm && onConfirm();\r\n          this.managers.appMessagesManager.reportMessages(peerId, mids, reason, inputField.value).then((bool) => {\r\n            if(!bool) return;\r\n\r\n            toastNew({\r\n              langPackKey: 'ReportSentInfo'\r\n            });\r\n          });\r\n        }\r\n      }], \r\n      body: true\r\n    });\r\n\r\n    const div = document.createElement('div');\r\n    const size = 100;\r\n    wrapStickerEmoji({\r\n      div,\r\n      emoji: PopupReportMessagesConfirm.STICKER_EMOJI,\r\n      width: size,\r\n      height: size,\r\n    }).then(({render}) => render).finally(() => {\r\n      this.show();\r\n    });\r\n\r\n    this.header.append(div);\r\n\r\n    const inputField = new InputField({\r\n      label: 'ReportHint',\r\n      maxLength: 512,\r\n      placeholder: 'ReportChatDescription'\r\n    });\r\n\r\n    inputField.input.addEventListener('input', () => {\r\n      this.buttons[0].element.toggleAttribute('disabled', !inputField.isValid());\r\n    });\r\n\r\n    this.body.append(inputField.container);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport whichChild from \"../../helpers/dom/whichChild\";\r\nimport preloadAnimatedEmojiSticker from \"../../helpers/preloadAnimatedEmojiSticker\";\r\nimport { ReportReason } from \"../../layer\";\r\nimport { LangPackKey } from \"../../lib/langPack\";\r\nimport Button from \"../button\";\r\nimport PopupPeer from \"./peer\";\r\nimport PopupReportMessagesConfirm from \"./reportMessagesConfirm\";\r\n\r\nexport default class PopupReportMessages extends PopupPeer {\r\n  constructor(peerId: PeerId, mids: number[], onConfirm?: () => void) {\r\n    super('popup-report-messages', {titleLangKey: 'ChatTitle.ReportMessages', buttons: [], body: true});\r\n\r\n    mids = mids.slice();\r\n\r\n    const buttons: [LangPackKey, ReportReason['_']][] = [\r\n      ['ReportChatSpam', 'inputReportReasonSpam'],\r\n      ['ReportChatViolence', 'inputReportReasonViolence'],\r\n      ['ReportChatChild', 'inputReportReasonChildAbuse'],\r\n      ['ReportChatPornography', 'inputReportReasonPornography'],\r\n      ['ReportChatOther', 'inputReportReasonOther'],\r\n      ['ReportChatPersonalDetails', 'inputReportReasonPersonalDetails'],\r\n      ['ReportChatIllegalDrugs', 'inputReportReasonIllegalDrugs']\r\n    ];\r\n\r\n    const className = 'btn-primary btn-transparent';\r\n    buttons.forEach((b) => {\r\n      const button = Button(className, {/* icon: 'edit',  */text: b[0]});\r\n      this.body.append(button);\r\n    });\r\n\r\n    const preloadStickerPromise = preloadAnimatedEmojiSticker(PopupReportMessagesConfirm.STICKER_EMOJI);\r\n\r\n    attachClickEvent(this.body, (e) => {\r\n      const target = findUpClassName(e.target, 'btn-primary');\r\n      const reason = buttons[whichChild(target)][1];\r\n\r\n      preloadStickerPromise.then(() => {\r\n        this.hide();\r\n\r\n        new PopupReportMessagesConfirm(peerId, mids, reason, onConfirm);\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n    \r\n    this.body.style.margin = '0 -1rem';\r\n    this.buttonsEl.style.marginTop = '.5rem';\r\n\r\n    this.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport I18n, { i18n } from \"../../lib/langPack\";\r\nimport PopupPeer from \"./peer\";\r\n\r\nexport default class PopupSponsored extends PopupPeer {\r\n  constructor() {\r\n    super('popup-sponsored', {\r\n      titleLangKey: 'Chat.Message.Sponsored.What',\r\n      descriptionLangKey: 'Chat.Message.Ad.Text',\r\n      descriptionLangArgs: [i18n('Chat.Message.Sponsored.Link')],\r\n      buttons: [{\r\n        langKey: 'OK',\r\n        isCancel: true\r\n      }, {\r\n        langKey: 'Chat.Message.Ad.ReadMore',\r\n        callback: () => {\r\n          window.open(I18n.format('Chat.Message.Sponsored.Link', true));\r\n        },\r\n        isCancel: true\r\n      }],\r\n      scrollable: true\r\n    });\r\n\r\n    this.scrollable.append(this.description);\r\n\r\n    this.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \".\";\r\nimport { Message } from \"../../layer\";\r\nimport { SettingSection } from \"../sidebarLeft\";\r\nimport ReactionsElement from \"../chat/reactions\";\r\nimport { horizontalMenu } from \"../horizontalMenu\";\r\nimport Scrollable from \"../scrollable\";\r\nimport ScrollableLoader from \"../../helpers/scrollableLoader\";\r\nimport appDialogsManager from \"../../lib/appManagers/appDialogsManager\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport { wrapSticker } from \"../wrappers\";\r\nimport ReactionElement from \"../chat/reaction\";\r\nimport getUserStatusString from \"../wrappers/getUserStatusString\";\r\n\r\nexport default class PopupReactedList extends PopupElement {\r\n  constructor(\r\n    private message: Message.message\r\n  ) {\r\n    super('popup-reacted-list', {closable: true, overlayClosable: true, body: true});\r\n\r\n    this.init();\r\n  }\r\n\r\n  private async init() {\r\n    const message = await this.managers.appMessagesManager.getGroupsFirstMessage(this.message);\r\n\r\n    const canViewReadParticipants = await this.managers.appMessagesManager.canViewMessageReadParticipants(message);\r\n\r\n    // this.body.append(generateDelimiter());\r\n\r\n    const reactionsElement = new ReactionsElement();\r\n    const newMessage: Message.message = {\r\n      ...message,\r\n      mid: 0,\r\n      id: 0,\r\n      reactions: {\r\n        _: 'messageReactions',\r\n        results: [],\r\n\r\n        ...message.reactions,\r\n\r\n        pFlags: {},\r\n        recent_reactions: []\r\n      }\r\n    };\r\n\r\n    newMessage.reactions.results = newMessage.reactions.results.map((reactionCount) => {\r\n      return {\r\n        ...reactionCount,\r\n        pFlags: {}\r\n      };\r\n    });\r\n\r\n    reactionsElement.init(newMessage, 'block');\r\n    reactionsElement.render();\r\n    reactionsElement.classList.add('no-stripe');\r\n    reactionsElement.classList.remove('has-no-reactions');\r\n    \r\n    reactionsElement.append(this.btnClose);\r\n\r\n    this.header.append(reactionsElement);\r\n\r\n    const tabsContainer = document.createElement('div');\r\n    tabsContainer.classList.add('tabs-container');\r\n    tabsContainer.dataset.animation = 'tabs';\r\n\r\n    const loaders: Map<HTMLElement, ScrollableLoader> = new Map();\r\n\r\n    let hasAllReactions = false;\r\n    if(newMessage.reactions.results.length) {\r\n      const reaction = this.createFakeReaction('reactions', newMessage.reactions.results.reduce((acc, r) => acc + r.count, 0));\r\n\r\n      reactionsElement.prepend(reaction);\r\n      newMessage.reactions.results.unshift(reaction.reactionCount);\r\n      hasAllReactions = true;\r\n    }\r\n\r\n    let hasReadParticipants = false;\r\n    if(canViewReadParticipants) {\r\n      try {\r\n        const readUserIds = await this.managers.appMessagesManager.getMessageReadParticipants(message.peerId, message.mid);\r\n        if(!readUserIds.length) {\r\n          throw '';\r\n        }\r\n\r\n        const reaction = this.createFakeReaction('checks', readUserIds.length);\r\n\r\n        reactionsElement.prepend(reaction);\r\n        newMessage.reactions.results.unshift(reaction.reactionCount);\r\n        hasReadParticipants = true;\r\n      } catch(err) {\r\n\r\n      }\r\n    }\r\n    \r\n    newMessage.reactions.results.forEach((reactionCount) => {\r\n      const scrollable = new Scrollable(undefined);\r\n      scrollable.container.classList.add('tabs-tab');\r\n\r\n      const section = new SettingSection({\r\n        noShadow: true,\r\n        noDelimiter: true\r\n      });\r\n\r\n      const chatlist = appDialogsManager.createChatList({\r\n        dialogSize: 72\r\n      });\r\n\r\n      appDialogsManager.setListClickListener(chatlist, () => {\r\n        this.hide();\r\n      }, undefined, false, true);\r\n\r\n      section.content.append(chatlist);\r\n      scrollable.container.append(section.container);\r\n\r\n      const skipReadParticipants = reactionCount.reaction !== 'checks';\r\n      const skipReactionsList = reactionCount.reaction === 'checks';\r\n      if(['checks', 'reactions'].includes(reactionCount.reaction)) {\r\n        reactionCount.reaction = undefined;\r\n      }\r\n\r\n      let nextOffset: string;\r\n      const loader = new ScrollableLoader({\r\n        scrollable,\r\n        getPromise: async() => {\r\n          const result = await this.managers.appMessagesManager.getMessageReactionsListAndReadParticipants(message, undefined, reactionCount.reaction, nextOffset, skipReadParticipants, skipReactionsList);\r\n          nextOffset = result.nextOffset;\r\n\r\n          await Promise.all(result.combined.map(async({peerId, reaction}) => {\r\n            const {dom} = appDialogsManager.addDialogNew({\r\n              peerId: peerId,\r\n              autonomous: true,\r\n              container: chatlist,\r\n              avatarSize: 54,\r\n              rippleEnabled: false,\r\n              meAsSaved: false,\r\n            });\r\n\r\n            if(reaction) {\r\n              const stickerContainer = document.createElement('div');\r\n              stickerContainer.classList.add('reacted-list-reaction-icon');\r\n              const availableReaction = await this.managers.appReactionsManager.getReactionCached(reaction);\r\n\r\n              wrapSticker({\r\n                doc: availableReaction.static_icon,\r\n                div: stickerContainer,\r\n                width: 24,\r\n                height: 24\r\n              });\r\n  \r\n              dom.listEl.append(stickerContainer);\r\n            }\r\n\r\n            replaceContent(dom.lastMessageSpan, getUserStatusString(await this.managers.appUsersManager.getUser(peerId.toUserId())));\r\n          }));\r\n\r\n          return !nextOffset;\r\n        }\r\n      });\r\n\r\n      loaders.set(scrollable.container, loader);\r\n\r\n      tabsContainer.append(scrollable.container);\r\n    });\r\n\r\n    this.body.append(tabsContainer);\r\n\r\n    const selectTab = horizontalMenu(reactionsElement, tabsContainer, (id, tabContent) => {\r\n      if(id === (reactionsElement.childElementCount - 1)) {\r\n        return false;\r\n      }\r\n\r\n      const reaction = reactionsElement.children[id] as ReactionElement;\r\n      const prevId = selectTab.prevId();\r\n      if(prevId !== -1) {\r\n        (reactionsElement.children[prevId] as ReactionElement).setIsChosen(false);\r\n      }\r\n      \r\n      reaction.setIsChosen(true);\r\n\r\n      const loader = loaders.get(tabContent);\r\n      loader.load();\r\n    }, undefined, undefined, undefined, this.listenerSetter);\r\n\r\n    // selectTab(hasAllReactions && hasReadParticipants ? 1 : 0, false);\r\n    selectTab(0, false);\r\n\r\n    this.show();\r\n  }\r\n\r\n  private createFakeReaction(icon: string, count: number) {\r\n    const reaction = new ReactionElement();\r\n    reaction.init('block');\r\n    reaction.reactionCount = {\r\n      _: 'reactionCount',\r\n      count: count,\r\n      reaction: icon\r\n    };\r\n    reaction.setCanRenderAvatars(false);\r\n    reaction.renderCounter();\r\n\r\n    const allReactionsSticker = document.createElement('div');\r\n    allReactionsSticker.classList.add('reaction-counter', 'reaction-sticker-icon', 'tgico-' + icon);\r\n    reaction.prepend(allReactionsSticker);\r\n\r\n    return reaction;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport { IS_MOBILE, IS_SAFARI } from \"../../environment/userAgent\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport callbackify from \"../../helpers/callbackify\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport getVisibleRect from \"../../helpers/dom/getVisibleRect\";\r\nimport { getMiddleware } from \"../../helpers/middleware\";\r\nimport noop from \"../../helpers/noop\";\r\nimport { fastRaf } from \"../../helpers/schedulers\";\r\nimport { Message, AvailableReaction } from \"../../layer\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport lottieLoader from \"../../lib/rlottie/lottieLoader\";\r\nimport RLottiePlayer from \"../../lib/rlottie/rlottiePlayer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport Scrollable, { ScrollableBase, ScrollableX } from \"../scrollable\";\r\nimport { wrapSticker } from \"../wrappers\";\r\n\r\nconst REACTIONS_CLASS_NAME = 'btn-menu-reactions';\r\nconst REACTION_CLASS_NAME = REACTIONS_CLASS_NAME + '-reaction';\r\n\r\nconst REACTION_SIZE = 26;\r\nconst PADDING = 4;\r\nexport const REACTION_CONTAINER_SIZE = REACTION_SIZE + PADDING * 2;\r\n\r\nconst CAN_USE_TRANSFORM = !IS_SAFARI;\r\n\r\ntype ChatReactionsMenuPlayers = {\r\n  select?: RLottiePlayer,\r\n  appear?: RLottiePlayer,\r\n  selectWrapper: HTMLElement,\r\n  appearWrapper: HTMLElement,\r\n  reaction: string\r\n};\r\nexport class ChatReactionsMenu {\r\n  public widthContainer: HTMLElement;\r\n  public container: HTMLElement;\r\n  private reactionsMap: Map<HTMLElement, ChatReactionsMenuPlayers>;\r\n  public scrollable: ScrollableBase;\r\n  private animationGroup: string;\r\n  private middleware: ReturnType<typeof getMiddleware>;\r\n  private message: Message.message;\r\n\r\n  constructor(\r\n    private managers: AppManagers,\r\n    private type: 'horizontal' | 'vertical',\r\n    middleware: ChatReactionsMenu['middleware']\r\n  ) {\r\n    const widthContainer = this.widthContainer = document.createElement('div');\r\n    widthContainer.classList.add(REACTIONS_CLASS_NAME + '-container');\r\n    widthContainer.classList.add(REACTIONS_CLASS_NAME + '-container-' + type);\r\n\r\n    const reactionsContainer = this.container = document.createElement('div');\r\n    reactionsContainer.classList.add(REACTIONS_CLASS_NAME);\r\n\r\n    const reactionsScrollable = this.scrollable = type === 'vertical' ? new Scrollable(undefined) : new ScrollableX(undefined);\r\n    reactionsContainer.append(reactionsScrollable.container);\r\n    reactionsScrollable.onAdditionalScroll = this.onScroll;\r\n    reactionsScrollable.setListeners();\r\n\r\n    reactionsScrollable.container.classList.add('no-scrollbar');\r\n\r\n    // ['big'].forEach((type) => {\r\n    //   const bubble = document.createElement('div');\r\n    //   bubble.classList.add(REACTIONS_CLASS_NAME + '-bubble', REACTIONS_CLASS_NAME + '-bubble-' + type);\r\n    //   reactionsContainer.append(bubble);\r\n    // });\r\n\r\n    this.reactionsMap = new Map();\r\n    this.animationGroup = 'CHAT-MENU-REACTIONS-' + Date.now();\r\n    animationIntersector.setOverrideIdleGroup(this.animationGroup, true);\r\n\r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      reactionsContainer.addEventListener('mousemove', this.onMouseMove);\r\n    }\r\n\r\n    attachClickEvent(reactionsContainer, (e) => {\r\n      const reactionDiv = findUpClassName(e.target, REACTION_CLASS_NAME);\r\n      if(!reactionDiv) return;\r\n\r\n      const players = this.reactionsMap.get(reactionDiv);\r\n      if(!players) return;\r\n\r\n      this.managers.appReactionsManager.sendReaction(this.message, players.reaction);\r\n    });\r\n\r\n    widthContainer.append(reactionsContainer);\r\n\r\n    this.middleware = middleware ?? getMiddleware();\r\n  }\r\n\r\n  public init(message: Message.message) {\r\n    this.message = message;\r\n\r\n    const middleware = this.middleware.get();\r\n    // const result = Promise.resolve(this.appReactionsManager.getAvailableReactionsForPeer(message.peerId)).then((res) => pause(1000).then(() => res));\r\n    const result = this.managers.appReactionsManager.getAvailableReactionsByMessage(message);\r\n    callbackify(result, (reactions) => {\r\n      if(!middleware() || !reactions.length) return;\r\n      reactions.forEach((reaction) => {\r\n        this.renderReaction(reaction);\r\n      });\r\n\r\n      const setVisible = () => {\r\n        this.container.classList.add('is-visible');\r\n      };\r\n\r\n      if(result instanceof Promise) {\r\n        fastRaf(setVisible);\r\n      } else {\r\n        setVisible();\r\n      }\r\n    });\r\n  }\r\n\r\n  public cleanup() {\r\n    this.middleware.clean();\r\n    this.scrollable.removeListeners();\r\n    this.reactionsMap.clear();\r\n    animationIntersector.setOverrideIdleGroup(this.animationGroup, false);\r\n    animationIntersector.checkAnimations(true, this.animationGroup, true);\r\n  }\r\n\r\n  private onScroll = () => {\r\n    this.reactionsMap.forEach((players, div) => {\r\n      this.onScrollProcessItem(div, players);\r\n    });\r\n  };\r\n\r\n  private canUseAnimations() {\r\n    return rootScope.settings.animationsEnabled && !IS_MOBILE;\r\n  }\r\n\r\n  private renderReaction(reaction: AvailableReaction) {\r\n    const reactionDiv = document.createElement('div');\r\n    reactionDiv.classList.add(REACTION_CLASS_NAME);\r\n\r\n    const scaleContainer = document.createElement('div');\r\n    scaleContainer.classList.add(REACTION_CLASS_NAME + '-scale');\r\n\r\n    const appearWrapper = document.createElement('div');\r\n    let selectWrapper: HTMLElement;;\r\n    appearWrapper.classList.add(REACTION_CLASS_NAME + '-appear');\r\n\r\n    if(this.canUseAnimations()) {\r\n      selectWrapper = document.createElement('div');\r\n      selectWrapper.classList.add(REACTION_CLASS_NAME + '-select', 'hide');\r\n    }\r\n\r\n    const players: ChatReactionsMenuPlayers = {\r\n      selectWrapper,\r\n      appearWrapper,\r\n      reaction: reaction.reaction\r\n    };\r\n    this.reactionsMap.set(reactionDiv, players);\r\n\r\n    const middleware = this.middleware.get();\r\n\r\n    const hoverScale = IS_TOUCH_SUPPORTED ? 1 : 1.25;\r\n    const size = REACTION_SIZE * hoverScale;\r\n\r\n    const options = {\r\n      width: size,\r\n      height: size,\r\n      skipRatio: 1,\r\n      needFadeIn: false,\r\n      withThumb: false,\r\n      group: this.animationGroup,\r\n      middleware\r\n    };\r\n\r\n    if(!this.canUseAnimations()) {\r\n      delete options.needFadeIn;\r\n      delete options.withThumb;\r\n\r\n      wrapSticker({\r\n        doc: reaction.static_icon,\r\n        div: appearWrapper,\r\n        ...options\r\n      });\r\n    } else {\r\n      let isFirst = true;\r\n      wrapSticker({\r\n        doc: reaction.appear_animation,\r\n        div: appearWrapper,\r\n        play: true,\r\n        ...options\r\n      }).then(({render}) => render).then((player) => {\r\n        assumeType<RLottiePlayer>(player);\r\n  \r\n        players.appear = player;\r\n  \r\n        player.addEventListener('enterFrame', (frameNo) => {\r\n          if(player.maxFrame === frameNo) {\r\n            selectLoadPromise.then((selectPlayer) => {\r\n              assumeType<RLottiePlayer>(selectPlayer);\r\n              appearWrapper.classList.add('hide');\r\n              selectWrapper.classList.remove('hide');\r\n  \r\n              if(isFirst) {\r\n                players.select = selectPlayer;\r\n                isFirst = false;\r\n              }\r\n            }, noop);\r\n          }\r\n        });\r\n      }, noop);\r\n  \r\n      const selectLoadPromise = wrapSticker({\r\n        doc: reaction.select_animation,\r\n        div: selectWrapper,\r\n        ...options\r\n      }).then(({render}) => render).then((player) => {\r\n        assumeType<RLottiePlayer>(player);\r\n\r\n        return lottieLoader.waitForFirstFrame(player);\r\n      }).catch(noop);\r\n    }\r\n    \r\n    scaleContainer.append(appearWrapper);\r\n    selectWrapper && scaleContainer.append(selectWrapper);\r\n    reactionDiv.append(scaleContainer);\r\n    this.scrollable.append(reactionDiv);\r\n  }\r\n\r\n  private onScrollProcessItem(div: HTMLElement, players: ChatReactionsMenuPlayers) {\r\n    // return;\r\n\r\n    const scaleContainer = div.firstElementChild as HTMLElement;\r\n    const visibleRect = getVisibleRect(div, this.scrollable.container);\r\n    let transform: string;\r\n    if(!visibleRect) {\r\n      if(!players.appearWrapper.classList.contains('hide') || !players.appear) {\r\n        return;\r\n      }\r\n\r\n      if(players.select) {\r\n        players.select.stop();\r\n      }\r\n\r\n      players.appear.stop();\r\n      players.appear.autoplay = true;\r\n      players.appearWrapper.classList.remove('hide');\r\n      players.selectWrapper.classList.add('hide');\r\n\r\n      transform = '';\r\n    } else if(visibleRect.overflow.left || visibleRect.overflow.right) {\r\n      const diff = Math.abs(visibleRect.rect.left - visibleRect.rect.right);\r\n      const scale = Math.min(diff ** 2 / REACTION_CONTAINER_SIZE ** 2, 1);\r\n\r\n      transform = 'scale(' + scale + ')';\r\n    } else {\r\n      transform = '';\r\n    }\r\n\r\n    if(CAN_USE_TRANSFORM) {\r\n      scaleContainer.style.transform = transform;\r\n    }\r\n  }\r\n\r\n  private onMouseMove = (e: MouseEvent) => {\r\n    const reactionDiv = findUpClassName(e.target, REACTION_CLASS_NAME);\r\n    if(!reactionDiv) {\r\n      return;\r\n    }\r\n    \r\n    const players = this.reactionsMap.get(reactionDiv);\r\n    if(!players) {\r\n      return;\r\n    }\r\n\r\n    // do not play select animation when appearing\r\n    if(!players.appear?.paused) {\r\n      return;\r\n    }\r\n\r\n    const player = players.select;\r\n    if(!player) {\r\n      return;\r\n    }\r\n\r\n    if(player.paused) {\r\n      player.autoplay = true;\r\n      player.restart();\r\n    }\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport type Chat from \"./chat\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"../buttonMenu\";\r\nimport PopupDeleteMessages from \"../popups/deleteMessages\";\r\nimport PopupForward from \"../popups/forward\";\r\nimport PopupPinMessage from \"../popups/unpinMessage\";\r\nimport { copyTextToClipboard } from \"../../helpers/clipboard\";\r\nimport PopupSendNow from \"../popups/sendNow\";\r\nimport { toast } from \"../toast\";\r\nimport I18n, { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent, simulateClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport isSelectionEmpty from \"../../helpers/dom/isSelectionEmpty\";\r\nimport { Message, Poll, Chat as MTChat, MessageMedia, AvailableReaction } from \"../../layer\";\r\nimport PopupReportMessages from \"../popups/reportMessages\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport PopupSponsored from \"../popups/sponsored\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport { getMiddleware } from \"../../helpers/middleware\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport StackedAvatars from \"../stackedAvatars\";\r\nimport { IS_APPLE } from \"../../environment/userAgent\";\r\nimport PopupReactedList from \"../popups/reactedList\";\r\nimport { ChatReactionsMenu, REACTION_CONTAINER_SIZE } from \"./reactionsMenu\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport getServerMessageId from \"../../lib/appManagers/utils/messageId/getServerMessageId\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport positionMenu, { MenuPositionPadding } from \"../../helpers/positionMenu\";\r\nimport contextMenuController from \"../../helpers/contextMenuController\";\r\nimport { attachContextMenuListener } from \"../../helpers/dom/attachContextMenuListener\";\r\nimport filterAsync from \"../../helpers/array/filterAsync\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\nimport { SERVICE_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\nimport { MessagesStorageKey } from \"../../lib/appManagers/appMessagesManager\";\r\n\r\nexport default class ChatContextMenu {\r\n  private buttons: (ButtonMenuItemOptions & {verify: () => boolean | Promise<boolean>, notDirect?: () => boolean, withSelection?: true, isSponsored?: true})[];\r\n  private element: HTMLElement;\r\n\r\n  private isSelectable: boolean;\r\n  private isSelected: boolean;\r\n  private target: HTMLElement;\r\n  private isTargetAGroupedItem: boolean;\r\n  private isTextSelected: boolean;\r\n  private isAnchorTarget: boolean;\r\n  private isUsernameTarget: boolean;\r\n  private isSponsored: boolean;\r\n  private isOverBubble: boolean;\r\n  private peerId: PeerId;\r\n  private mid: number;\r\n  private message: Message.message | Message.messageService;\r\n  private noForwards: boolean;\r\n\r\n  private reactionsMenu: ChatReactionsMenu;\r\n  private listenerSetter: ListenerSetter;\r\n  private attachListenerSetter: ListenerSetter;\r\n\r\n  private viewerPeerId: PeerId;\r\n  private middleware: ReturnType<typeof getMiddleware>;\r\n  private canOpenReactedList: boolean;\r\n\r\n  constructor(\r\n    private chat: Chat, \r\n    private managers: AppManagers\r\n  ) {\r\n    this.listenerSetter = new ListenerSetter();\r\n    this.attachListenerSetter = new ListenerSetter();\r\n    this.middleware = getMiddleware();\r\n  }\r\n\r\n  public attachTo(element: HTMLElement) {\r\n    this.attachListenerSetter.removeAll();\r\n    \r\n    if(IS_TOUCH_SUPPORTED/*  && false */) {\r\n      attachClickEvent(element, (e) => {\r\n        if(this.chat.selection.isSelecting) {\r\n          return;\r\n        }\r\n\r\n        this.chat.log('touchend', e);\r\n\r\n        const badSelectors = [\r\n          '.name',\r\n          '.peer-title',\r\n          '.reply',\r\n          '.document',\r\n          'audio-element',\r\n          'avatar-element',\r\n          'a',\r\n          '.bubble-beside-button',\r\n          'replies-element',\r\n          '[data-saved-from]:not(.bubble)',\r\n          'poll-element',\r\n          '.attachment',\r\n          '.reply-markup-button'\r\n        ];\r\n        let good = !(e.target as HTMLElement).closest(badSelectors.join(', '));\r\n        if(good) {\r\n          cancelEvent(e);\r\n          //onContextMenu((e as TouchEvent).changedTouches[0]);\r\n          // onContextMenu((e as TouchEvent).changedTouches ? (e as TouchEvent).changedTouches[0] : e as MouseEvent);\r\n          this.onContextMenu(e);\r\n        }\r\n      }, {listenerSetter: this.attachListenerSetter});\r\n    } else attachContextMenuListener(element, this.onContextMenu, this.attachListenerSetter);\r\n  }\r\n\r\n  private onContextMenu = (e: MouseEvent | Touch | TouchEvent) => {\r\n    let bubble: HTMLElement, contentWrapper: HTMLElement;\r\n\r\n    try {\r\n      contentWrapper = findUpClassName(e.target, 'bubble-content-wrapper');\r\n      bubble = contentWrapper ? contentWrapper.parentElement : findUpClassName(e.target, 'bubble');\r\n    } catch(e) {}\r\n\r\n    // ! context menu click by date bubble (there is no pointer-events)\r\n    if(!bubble || bubble.classList.contains('bubble-first')) return;\r\n\r\n    let element = this.element;\r\n    if(e instanceof MouseEvent || e.hasOwnProperty('preventDefault')) (e as any).preventDefault();\r\n    if(element && element.classList.contains('active')) {\r\n      return false;\r\n    }\r\n    if(e instanceof MouseEvent || e.hasOwnProperty('cancelBubble')) (e as any).cancelBubble = true;\r\n\r\n    let mid = +bubble.dataset.mid;\r\n    if(!mid) return;\r\n    \r\n    const r = async() => {\r\n      const isSponsored = this.isSponsored = mid < 0;\r\n      this.isSelectable = this.chat.selection.canSelectBubble(bubble);\r\n      this.peerId = this.chat.peerId;\r\n      //this.msgID = msgID;\r\n      this.target = e.target as HTMLElement;\r\n      this.isTextSelected = !isSelectionEmpty();\r\n      this.isAnchorTarget = this.target.tagName === 'A' && (\r\n        (this.target as HTMLAnchorElement).target === '_blank' || \r\n        this.target.classList.contains('anchor-url')\r\n      );\r\n      this.isUsernameTarget = this.target.tagName === 'A' && this.target.classList.contains('mention');\r\n\r\n      // *         ,     ,    \r\n      if(this.chat.selection.isSelecting && !contentWrapper) {\r\n        if(isSponsored) {\r\n          return;\r\n        }\r\n\r\n        const mids = await this.chat.getMidsByMid(mid);\r\n        if(mids.length > 1) {\r\n          const selectedMid = this.chat.selection.isMidSelected(this.peerId, mid) ? \r\n            mid : \r\n            mids.find((mid) => this.chat.selection.isMidSelected(this.peerId, mid));\r\n          if(selectedMid) {\r\n            mid = selectedMid;\r\n          }\r\n        }\r\n      }\r\n\r\n      this.isOverBubble = !!contentWrapper;\r\n\r\n      const groupedItem = findUpClassName(this.target, 'grouped-item');\r\n      this.isTargetAGroupedItem = !!groupedItem;\r\n      if(groupedItem) {\r\n        this.mid = +groupedItem.dataset.mid;\r\n      } else {\r\n        this.mid = mid;\r\n      }\r\n\r\n      this.isSelected = this.chat.selection.isMidSelected(this.peerId, this.mid);\r\n      this.message = await this.chat.getMessage(this.mid);\r\n      this.noForwards = !isSponsored && !(await this.managers.appMessagesManager.canForward(this.message));\r\n      this.viewerPeerId = undefined;\r\n      this.canOpenReactedList = undefined;\r\n\r\n      const initResult = await this.init();\r\n      if(!initResult) {\r\n        return;\r\n      }\r\n      \r\n      element = initResult.element;\r\n      const {cleanup, destroy, menuPadding, reactionsMenu, reactionsMenuPosition} = initResult;\r\n      let isReactionsMenuVisible = false;\r\n      if(reactionsMenu) {\r\n        const className = 'is-visible';\r\n        isReactionsMenuVisible = reactionsMenu.container.classList.contains(className);\r\n        if(isReactionsMenuVisible) reactionsMenu.container.classList.remove(className);\r\n\r\n        if(reactionsMenuPosition === 'horizontal') {\r\n          const offsetSize = element[/* reactionsMenuPosition === 'vertical' ? 'offsetHeight' :  */'offsetWidth'];\r\n          // if(reactionsMenu.scrollable.container.scrollWidth > offsetWidth) {\r\n            const INNER_CONTAINER_PADDING = 8;\r\n            const visibleLength = (offsetSize - INNER_CONTAINER_PADDING) / REACTION_CONTAINER_SIZE;\r\n            const nextVisiblePart = visibleLength % 1;\r\n            const MIN_NEXT_VISIBLE_PART = 0.65;\r\n            if(nextVisiblePart < MIN_NEXT_VISIBLE_PART) {\r\n              const minSize = (offsetSize + (MIN_NEXT_VISIBLE_PART - nextVisiblePart) * REACTION_CONTAINER_SIZE) | 0;\r\n              element.style[/* reactionsMenuPosition === 'vertical' ? 'minHeight' :  */'minWidth'] = minSize + 'px';\r\n            }\r\n          // }\r\n        }\r\n      }\r\n      \r\n      const side: 'left' | 'right' = bubble.classList.contains('is-in') ? 'left' : 'right';\r\n      //bubble.parentElement.append(element);\r\n      //appImManager.log('contextmenu', e, bubble, side);\r\n      positionMenu((e as TouchEvent).touches ? (e as TouchEvent).touches[0] : e as MouseEvent, element, side, menuPadding);\r\n\r\n      if(reactionsMenu) {\r\n        reactionsMenu.widthContainer.style.top = element.style.top;\r\n        reactionsMenu.widthContainer.style.left = element.style.left;\r\n        reactionsMenu.widthContainer.style.setProperty('--menu-width', element[reactionsMenuPosition === 'vertical' ? 'offsetHeight' : 'offsetWidth'] + 'px');\r\n        element.parentElement.append(reactionsMenu.widthContainer);\r\n        if(isReactionsMenuVisible) void reactionsMenu.container.offsetLeft; // reflow\r\n      }\r\n\r\n      contextMenuController.openBtnMenu(element, () => {\r\n        if(reactionsMenu) {\r\n          reactionsMenu.container.classList.remove('is-visible');\r\n        }\r\n\r\n        this.mid = 0;\r\n        this.peerId = undefined;\r\n        this.target = null;\r\n        this.viewerPeerId = undefined;\r\n        this.canOpenReactedList = undefined;\r\n        cleanup();\r\n\r\n        setTimeout(() => {\r\n          destroy();\r\n        }, 300);\r\n      });\r\n\r\n      if(isReactionsMenuVisible) {\r\n        reactionsMenu.container.classList.add('is-visible');\r\n      }\r\n    };\r\n    \r\n    r();\r\n  };\r\n\r\n  public cleanup() {\r\n    this.listenerSetter.removeAll();\r\n    this.reactionsMenu && this.reactionsMenu.cleanup();\r\n    this.middleware.clean();\r\n  }\r\n\r\n  public destroy() {\r\n    this.cleanup();\r\n    this.attachListenerSetter.removeAll();\r\n  }\r\n\r\n  private async filterButtons(buttons: ChatContextMenu['buttons']) {\r\n    if(this.isSponsored) {\r\n      return buttons.filter((button) => {\r\n        return button.isSponsored;\r\n      });\r\n    } else {\r\n      return filterAsync(buttons, async(button) => {\r\n        let good: boolean;\r\n\r\n        //if((appImManager.chatSelection.isSelecting && !button.withSelection) || (button.withSelection && !appImManager.chatSelection.isSelecting)) {\r\n        if(this.chat.selection.isSelecting && !button.withSelection) {\r\n          good = false;\r\n        } else {\r\n          good = this.isOverBubble || IS_TOUCH_SUPPORTED || true ? \r\n            await button.verify() : \r\n            button.notDirect && await button.verify() && button.notDirect();\r\n        }\r\n\r\n        return !!good;\r\n      });\r\n    }\r\n  }\r\n\r\n  private setButtons() {\r\n    this.buttons = [{\r\n      icon: 'send2',\r\n      text: 'MessageScheduleSend',\r\n      onClick: this.onSendScheduledClick,\r\n      verify: () => this.chat.type === 'scheduled' && !this.message.pFlags.is_outgoing\r\n    }, {\r\n      icon: 'send2',\r\n      text: 'Message.Context.Selection.SendNow',\r\n      onClick: this.onSendScheduledClick,\r\n      verify: () => this.chat.type === 'scheduled' && this.isSelected && !this.chat.selection.selectionSendNowBtn.hasAttribute('disabled'),\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'schedule',\r\n      text: 'MessageScheduleEditTime',\r\n      onClick: () => {\r\n        this.chat.input.scheduleSending(() => {\r\n          assumeType<Message.message>(this.message);\r\n          this.managers.appMessagesManager.editMessage(this.message, this.message.message, {\r\n            scheduleDate: this.chat.input.scheduleDate,\r\n            entities: this.message.entities\r\n          });\r\n\r\n          this.chat.input.onMessageSent(false, false);\r\n        }, new Date(this.message.date * 1000));\r\n      },\r\n      verify: () => this.chat.type === 'scheduled'\r\n    }, {\r\n      icon: 'reply',\r\n      text: 'Reply',\r\n      onClick: this.onReplyClick,\r\n      verify: async() => await this.chat.canSend() && \r\n        !this.message.pFlags.is_outgoing && \r\n        !!this.chat.input.messageInput && \r\n        this.chat.type !== 'scheduled'/* ,\r\n      cancelEvent: true */\r\n    }, {\r\n      icon: 'edit',\r\n      text: 'Edit',\r\n      onClick: this.onEditClick,\r\n      verify: async() => (await this.managers.appMessagesManager.canEditMessage(this.message, 'text')) && !!this.chat.input.messageInput\r\n    }, {\r\n      icon: 'copy',\r\n      text: 'Copy',\r\n      onClick: this.onCopyClick,\r\n      verify: () => !this.noForwards && !!(this.message as Message.message).message && !this.isTextSelected && (!this.isAnchorTarget || (this.message as Message.message).message !== this.target.innerText)\r\n    }, {\r\n      icon: 'copy',\r\n      text: 'Chat.CopySelectedText',\r\n      onClick: this.onCopyClick,\r\n      verify: () => !this.noForwards && !!(this.message as Message.message).message && this.isTextSelected\r\n    }, {\r\n      icon: 'copy',\r\n      text: 'Message.Context.Selection.Copy',\r\n      onClick: this.onCopyClick,\r\n      verify: async() => {\r\n        if(!this.isSelected || this.noForwards) {\r\n          return false;\r\n        }\r\n\r\n        for(const [peerId, mids] of this.chat.selection.selectedMids) {\r\n          const storageKey: MessagesStorageKey = `${peerId}_${this.chat.type === 'scheduled' ? 'scheduled' : 'history'}`;\r\n          for(const mid of mids) {\r\n            const message = (await this.managers.appMessagesManager.getMessageFromStorage(storageKey, mid)) as Message.message;\r\n            if(!!message.message) {\r\n              return true;\r\n            }\r\n          }\r\n        }\r\n\r\n        return false;\r\n      },\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'copy',\r\n      text: 'CopyLink',\r\n      onClick: this.onCopyAnchorLinkClick,\r\n      verify: () => this.isAnchorTarget,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'copy',\r\n      text: 'Text.Context.Copy.Username',\r\n      onClick: () => {\r\n        copyTextToClipboard(this.target.innerHTML);\r\n      },\r\n      verify: () => this.isUsernameTarget,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'copy',\r\n      text: 'Text.Context.Copy.Hashtag',\r\n      onClick: () => {\r\n        copyTextToClipboard(this.target.innerHTML);\r\n      },\r\n      verify: () => this.target.classList.contains('anchor-hashtag'),\r\n      withSelection: true\r\n    }, {\r\n      icon: 'link',\r\n      text: 'MessageContext.CopyMessageLink1',\r\n      onClick: this.onCopyLinkClick,\r\n      verify: async() => await this.managers.appPeersManager.isChannel(this.peerId) && !this.message.pFlags.is_outgoing\r\n    }, {\r\n      icon: 'pin',\r\n      text: 'Message.Context.Pin',\r\n      onClick: this.onPinClick,\r\n      verify: async() => !this.message.pFlags.is_outgoing && \r\n        this.message._ !== 'messageService' && \r\n        !this.message.pFlags.pinned && \r\n        await this.managers.appPeersManager.canPinMessage(this.peerId) && \r\n        this.chat.type !== 'scheduled',\r\n    }, {\r\n      icon: 'unpin',\r\n      text: 'Message.Context.Unpin',\r\n      onClick: this.onUnpinClick,\r\n      verify: async() => (this.message as Message.message).pFlags.pinned && await this.managers.appPeersManager.canPinMessage(this.peerId),\r\n    }, {\r\n      icon: 'download',\r\n      text: 'MediaViewer.Context.Download',\r\n      onClick: () => {\r\n        appDownloadManager.downloadToDisc({media: (this.message as any).media.document});\r\n      },\r\n      verify: () => {\r\n        if(this.message.pFlags.is_outgoing) {\r\n          return false;\r\n        }\r\n        \r\n        const doc: MyDocument = ((this.message as Message.message).media as MessageMedia.messageMediaDocument)?.document as any;\r\n        if(!doc) return false;\r\n        \r\n        let hasTarget = !!IS_TOUCH_SUPPORTED;\r\n        const isGoodType = !doc.type || !(['gif', 'video', 'sticker'] as MyDocument['type'][]).includes(doc.type);\r\n        if(isGoodType) hasTarget = hasTarget || !!findUpClassName(this.target, 'document') || !!findUpClassName(this.target, 'audio');\r\n        return isGoodType && hasTarget;\r\n      }\r\n    }, {\r\n      icon: 'checkretract',\r\n      text: 'Chat.Poll.Unvote',\r\n      onClick: this.onRetractVote,\r\n      verify: () => {\r\n        const poll = (this.message as any).media?.poll as Poll;\r\n        return poll && poll.chosenIndexes.length && !poll.pFlags.closed && !poll.pFlags.quiz;\r\n      }/* ,\r\n      cancelEvent: true */\r\n    }, {\r\n      icon: 'stop',\r\n      text: 'Chat.Poll.Stop',\r\n      onClick: this.onStopPoll,\r\n      verify: async() => {\r\n        const poll = (this.message as any).media?.poll;\r\n        return await this.managers.appMessagesManager.canEditMessage(this.message, 'poll') && poll && !poll.pFlags.closed && !this.message.pFlags.is_outgoing;\r\n      }/* ,\r\n      cancelEvent: true */\r\n    }, {\r\n      icon: 'forward',\r\n      text: 'Forward',\r\n      onClick: this.onForwardClick, // let forward the message if it's outgoing but not ours (like a changelog)\r\n      verify: () => !this.noForwards && this.chat.type !== 'scheduled' && (!this.message.pFlags.is_outgoing || this.message.fromId === SERVICE_PEER_ID) && this.message._ !== 'messageService'\r\n    }, {\r\n      icon: 'forward',\r\n      text: 'Message.Context.Selection.Forward',\r\n      onClick: this.onForwardClick,\r\n      verify: () => this.chat.selection.selectionForwardBtn && \r\n        this.isSelected && \r\n        !this.chat.selection.selectionForwardBtn.hasAttribute('disabled'),\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'flag',\r\n      text: 'ReportChat',\r\n      onClick: () => {\r\n        new PopupReportMessages(this.peerId, [this.mid]);\r\n      },\r\n      verify: async() => !this.message.pFlags.out && this.message._ === 'message' && !this.message.pFlags.is_outgoing && await this.managers.appPeersManager.isChannel(this.peerId),\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'select',\r\n      text: 'Message.Context.Select',\r\n      onClick: this.onSelectClick,\r\n      verify: () => !(this.message as Message.messageService).action && !this.isSelected && this.isSelectable,\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'select',\r\n      text: 'Message.Context.Selection.Clear',\r\n      onClick: this.onClearSelectionClick,\r\n      verify: () => this.isSelected,\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      onClick: () => {\r\n        if(this.viewerPeerId) {\r\n          this.chat.appImManager.setInnerPeer({\r\n            peerId: this.viewerPeerId\r\n          });\r\n        } else if(this.canOpenReactedList) {\r\n          new PopupReactedList(this.message as Message.message);\r\n        } else {\r\n          return false;\r\n        }\r\n      },\r\n      verify: async() => !this.peerId.isUser() && (!!(this.message as Message.message).reactions?.recent_reactions?.length || await this.managers.appMessagesManager.canViewMessageReadParticipants(this.message)),\r\n      notDirect: () => true\r\n    }, {\r\n      icon: 'delete danger',\r\n      text: 'Delete',\r\n      onClick: this.onDeleteClick,\r\n      verify: async() => this.managers.appMessagesManager.canDeleteMessage(this.message)\r\n    }, {\r\n      icon: 'delete danger',\r\n      text: 'Message.Context.Selection.Delete',\r\n      onClick: this.onDeleteClick,\r\n      verify: () => this.isSelected && !this.chat.selection.selectionDeleteBtn.hasAttribute('disabled'),\r\n      notDirect: () => true,\r\n      withSelection: true\r\n    }, {\r\n      icon: 'info',\r\n      text: 'Chat.Message.Sponsored.What',\r\n      onClick: () => {\r\n        new PopupSponsored();\r\n      },\r\n      verify: () => false,\r\n      isSponsored: true\r\n    }];\r\n  }\r\n\r\n  private async init() {\r\n    this.cleanup();\r\n    this.setButtons();\r\n    \r\n    const filteredButtons = await this.filterButtons(this.buttons);\r\n    if(!filteredButtons.length) {\r\n      return;\r\n    }\r\n\r\n    const element = this.element = ButtonMenu(filteredButtons, this.listenerSetter);\r\n    element.id = 'bubble-contextmenu';\r\n    element.classList.add('contextmenu');\r\n\r\n    const viewsButton = filteredButtons.find((button) => !button.icon);\r\n    if(viewsButton) {\r\n      const reactions = (this.message as Message.message).reactions;\r\n      const recentReactions = reactions?.recent_reactions;\r\n      const isViewingReactions = !!recentReactions?.length;\r\n      const participantsCount = await this.managers.appMessagesManager.canViewMessageReadParticipants(this.message) ? ((await this.managers.appPeersManager.getPeer(this.peerId)) as MTChat.chat).participants_count : undefined;\r\n      const reactedLength = reactions ? reactions.results.reduce((acc, r) => acc + r.count, 0) : undefined;\r\n\r\n      viewsButton.element.classList.add('tgico-' + (isViewingReactions ? 'reactions' : 'checks'));\r\n      const i18nElem = new I18n.IntlElement({\r\n        key: isViewingReactions ? (\r\n          participantsCount === undefined ? 'Chat.Context.ReactedFast' : 'Chat.Context.Reacted'\r\n        ) : 'NobodyViewed',\r\n        args: isViewingReactions ? (\r\n          participantsCount === undefined ? [reactedLength] : [participantsCount, participantsCount]\r\n        ) : undefined,\r\n        element: viewsButton.textElement\r\n      });\r\n\r\n      let fakeText: HTMLElement;\r\n      if(isViewingReactions) {\r\n        if(participantsCount === undefined) {\r\n          fakeText = i18n('Chat.Context.ReactedFast', [reactedLength]);\r\n        } else {\r\n          fakeText = i18n(\r\n            recentReactions.length === participantsCount ? 'Chat.Context.ReactedFast' : 'Chat.Context.Reacted', \r\n            [recentReactions.length, participantsCount]\r\n          );\r\n        }\r\n      } else {\r\n        fakeText = i18n('Loading');\r\n      }\r\n\r\n      fakeText.classList.add('btn-menu-item-text-fake');\r\n      viewsButton.element.append(fakeText);\r\n\r\n      const AVATAR_SIZE = 22;\r\n      const MAX_AVATARS = 3;\r\n      const PADDING_PER_AVATAR = 1.125;\r\n      i18nElem.element.style.visibility = 'hidden';\r\n      i18nElem.element.style.paddingRight = isViewingReactions ? PADDING_PER_AVATAR * Math.min(MAX_AVATARS, recentReactions.length) + 'rem' : '1rem';\r\n      const middleware = this.middleware.get();\r\n      this.managers.appMessagesManager.getMessageReactionsListAndReadParticipants(this.message as Message.message).then((result) => {\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n\r\n        if(fakeText) {\r\n          fakeText.remove();\r\n        }\r\n\r\n        const reactions = result.combined;\r\n        const reactedLength = participantsCount === undefined ? \r\n          result.reactionsCount : \r\n          (\r\n            isViewingReactions ? \r\n              reactions.filter((reaction) => reaction.reaction).length : \r\n              reactions.length\r\n          );\r\n\r\n        let fakeElem: HTMLElement;\r\n        if(reactions.length === 1) {\r\n          fakeElem = new PeerTitle({\r\n            peerId: reactions[0].peerId,\r\n            onlyFirstName: true,\r\n            dialog: false,\r\n          }).element;\r\n\r\n          if(!isViewingReactions || result.readParticipants.length <= 1) {\r\n            this.viewerPeerId = reactions[0].peerId;\r\n          }\r\n        } else if(isViewingReactions) {\r\n          const isFull = reactedLength === reactions.length || participantsCount === undefined;\r\n          fakeElem = i18n(\r\n            isFull ? 'Chat.Context.ReactedFast' : 'Chat.Context.Reacted', \r\n            isFull ? [reactedLength] : [reactedLength, reactions.length]\r\n          );\r\n        } else {\r\n          if(!reactions.length) {\r\n            i18nElem.element.style.visibility = '';\r\n          } else {\r\n            fakeElem = i18n('MessageSeen', [reactions.length]);\r\n          }\r\n        }\r\n\r\n        if(fakeElem) {\r\n          fakeElem.style.paddingRight = PADDING_PER_AVATAR * Math.min(MAX_AVATARS, reactedLength) + 'rem';\r\n          fakeElem.classList.add('btn-menu-item-text-fake');\r\n          viewsButton.element.append(fakeElem);\r\n        }\r\n\r\n        if(reactions.length) {\r\n          const avatars = new StackedAvatars({avatarSize: AVATAR_SIZE});\r\n          avatars.render(recentReactions ? recentReactions.map((r) => getPeerId(r.peer_id)) : reactions.map((reaction) => reaction.peerId));\r\n          viewsButton.element.append(avatars.container);\r\n\r\n          // if(reactions.length > 1) {\r\n          // if(isViewingReactions) {\r\n            this.canOpenReactedList = true;\r\n          // }\r\n        }\r\n      });\r\n    }\r\n\r\n    let menuPadding: MenuPositionPadding;\r\n    let reactionsMenu: ChatReactionsMenu;\r\n    let reactionsMenuPosition: 'horizontal' | 'vertical';\r\n    if(this.message._ === 'message' && !this.chat.selection.isSelecting && !this.message.pFlags.is_outgoing && !this.message.pFlags.is_scheduled) {\r\n      reactionsMenuPosition = (IS_APPLE || IS_TOUCH_SUPPORTED)/*  && false */ ? 'horizontal' : 'vertical';\r\n      reactionsMenu = this.reactionsMenu = new ChatReactionsMenu(this.managers, reactionsMenuPosition, this.middleware);\r\n      reactionsMenu.init(await this.managers.appMessagesManager.getGroupsFirstMessage(this.message));\r\n      // element.prepend(reactionsMenu.widthContainer);\r\n\r\n      const size = 36;\r\n      const margin = 8;\r\n      const totalSize = size + margin;\r\n      const paddingLeft = 0, paddingRight = 0;\r\n      if(reactionsMenuPosition === 'vertical') {\r\n        menuPadding = {\r\n          top: paddingLeft,\r\n          // bottom: 36, // positionMenu will detect it itself somehow\r\n          left: totalSize\r\n        };\r\n      } else {\r\n        menuPadding = {\r\n          top: totalSize,\r\n          right: paddingRight,\r\n          left: paddingLeft\r\n        };\r\n      }\r\n    }\r\n\r\n    this.chat.container.append(element);\r\n\r\n    return {\r\n      element, \r\n      cleanup: () => {\r\n        this.cleanup();\r\n        reactionsMenu && reactionsMenu.cleanup();\r\n      },\r\n      destroy: () => {\r\n        element.remove();\r\n        reactionsMenu && reactionsMenu.widthContainer.remove();\r\n      },\r\n      menuPadding,\r\n      reactionsMenu,\r\n      reactionsMenuPosition\r\n    };\r\n  }\r\n\r\n  private onSendScheduledClick = async() => {\r\n    if(this.chat.selection.isSelecting) {\r\n      simulateClickEvent(this.chat.selection.selectionSendNowBtn);\r\n    } else {\r\n      new PopupSendNow(this.peerId, await this.chat.getMidsByMid(this.mid));\r\n    }\r\n  };\r\n\r\n  private onReplyClick = () => {\r\n    this.chat.input.initMessageReply(this.mid);\r\n  };\r\n\r\n  private onEditClick = () => {\r\n    this.chat.input.initMessageEditing(this.mid);\r\n  };\r\n\r\n  private onCopyClick = async() => {\r\n    if(isSelectionEmpty()) {\r\n      const mids = this.chat.selection.isSelecting ? \r\n        [...this.chat.selection.selectedMids.get(this.peerId)].sort((a, b) => a - b) : \r\n        [this.mid];\r\n\r\n      const parts: string[] = await Promise.all(mids.map(async(mid) => {\r\n        const message = (await this.chat.getMessage(mid)) as Message.message;\r\n        return message?.message ? message.message + '\\n' : '';\r\n      }));\r\n\r\n      const str = parts.join('');\r\n\r\n      copyTextToClipboard(str);\r\n    } else {\r\n      document.execCommand('copy');\r\n      //cancelSelection();\r\n    }\r\n  };\r\n\r\n  private onCopyAnchorLinkClick = () => {\r\n    copyTextToClipboard((this.target as HTMLAnchorElement).href);\r\n  };\r\n\r\n  private onCopyLinkClick = async() => {\r\n    let threadMessage: Message.message;\r\n    const {peerId, mid} = this;\r\n    const threadId = this.chat.threadId;\r\n    if(this.chat.type === 'discussion') {\r\n      threadMessage = (await this.managers.appMessagesManager.getMessageByPeer(peerId, threadId)) as Message.message;\r\n    }\r\n\r\n    const username = await this.managers.appPeersManager.getPeerUsername(threadMessage ? threadMessage.fromId : peerId);\r\n    const msgId = getServerMessageId(mid);\r\n    let url = 'https://t.me/';\r\n    let key: LangPackKey;\r\n    if(username) {\r\n      url += username + '/' + (threadMessage ? getServerMessageId(threadMessage.fwd_from.channel_post) : msgId);\r\n      if(threadMessage) url += '?comment=' + msgId;\r\n      key = 'LinkCopied';\r\n    } else {\r\n      url += 'c/' + peerId.toChatId() + '/' + msgId;\r\n      if(threadMessage) url += '?thread=' + getServerMessageId(threadMessage.mid);\r\n      key = 'LinkCopiedPrivateInfo';\r\n    }\r\n\r\n    toast(I18n.format(key, true));\r\n\r\n    copyTextToClipboard(url);\r\n  };\r\n\r\n  private onPinClick = () => {\r\n    new PopupPinMessage(this.peerId, this.mid);\r\n  };\r\n\r\n  private onUnpinClick = () => {\r\n    new PopupPinMessage(this.peerId, this.mid, true);\r\n  };\r\n\r\n  private onRetractVote = () => {\r\n    this.managers.appPollsManager.sendVote(this.message, []);\r\n  };\r\n\r\n  private onStopPoll = () => {\r\n    this.managers.appPollsManager.stopPoll(this.message);\r\n  };\r\n\r\n  private onForwardClick = async() => {\r\n    if(this.chat.selection.isSelecting) {\r\n      simulateClickEvent(this.chat.selection.selectionForwardBtn);\r\n    } else {\r\n      const peerId = this.peerId;\r\n      const mids = this.isTargetAGroupedItem ? [this.mid] : await this.chat.getMidsByMid(this.mid);\r\n      new PopupForward({\r\n        [peerId]: mids\r\n      });\r\n    }\r\n  };\r\n\r\n  private onSelectClick = () => {\r\n    this.chat.selection.toggleByElement(findUpClassName(this.target, 'grouped-item') || findUpClassName(this.target, 'bubble'));\r\n  };\r\n\r\n  private onClearSelectionClick = () => {\r\n    this.chat.selection.cancelSelection();\r\n  };\r\n\r\n  private onDeleteClick = async() => {\r\n    if(this.chat.selection.isSelecting) {\r\n      simulateClickEvent(this.chat.selection.selectionDeleteBtn);\r\n    } else {\r\n      new PopupDeleteMessages(this.peerId, this.isTargetAGroupedItem ? [this.mid] : await this.chat.getMidsByMid(this.mid), this.chat.type);\r\n    }\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport contextMenuController from \"../../helpers/contextMenuController\";\r\nimport { attachContextMenuListener } from \"../../helpers/dom/attachContextMenuListener\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"../buttonMenu\";\r\n\r\nexport default class SendMenu {\r\n  public sendMenu: HTMLDivElement;\r\n  private sendMenuButtons: (ButtonMenuItemOptions & {verify: () => boolean})[];\r\n  private type: 'schedule' | 'reminder';\r\n  \r\n  constructor(options: {\r\n    onSilentClick: () => void,\r\n    onScheduleClick: () => void,\r\n    listenerSetter?: ListenerSetter,\r\n    openSide: string,\r\n    onContextElement: HTMLElement,\r\n    onOpen?: () => boolean\r\n  }) {\r\n    this.sendMenuButtons = [{\r\n      icon: 'mute',\r\n      text: 'Chat.Send.WithoutSound',\r\n      onClick: options.onSilentClick,\r\n      verify: () => this.type === 'schedule'\r\n    }, {\r\n      icon: 'schedule',\r\n      text: 'Chat.Send.ScheduledMessage',\r\n      onClick: options.onScheduleClick,\r\n      verify: () => this.type === 'schedule'\r\n    }, {\r\n      icon: 'schedule',\r\n      text: 'Chat.Send.SetReminder',\r\n      onClick: options.onScheduleClick,\r\n      verify: () => this.type === 'reminder'\r\n    }];\r\n  \r\n    this.sendMenu = ButtonMenu(this.sendMenuButtons, options.listenerSetter);\r\n    this.sendMenu.classList.add('menu-send', options.openSide);\r\n\r\n    attachContextMenuListener(options.onContextElement, (e: any) => {\r\n      if(options.onOpen && !options.onOpen()) {\r\n        return;\r\n      }\r\n\r\n      this.sendMenuButtons.forEach((button) => {\r\n        button.element.classList.toggle('hide', !button.verify());\r\n      });\r\n      \r\n      cancelEvent(e);\r\n      contextMenuController.openBtnMenu(this.sendMenu);\r\n    }, options.listenerSetter);\r\n  }\r\n\r\n  public setPeerId(peerId: PeerId) {\r\n    this.type = peerId === rootScope.myId ? 'reminder' : 'schedule';\r\n  }\r\n};\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type Chat from \"../chat/chat\";\r\nimport PopupElement from \".\";\r\nimport CheckboxField from \"../checkboxField\";\r\nimport InputField from \"../inputField\";\r\nimport RadioField from \"../radioField\";\r\nimport Scrollable from \"../scrollable\";\r\nimport SendContextMenu from \"../chat/sendContextMenu\";\r\nimport I18n, { _i18n } from \"../../lib/langPack\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport getRichValue from \"../../helpers/dom/getRichValue\";\r\nimport isInputEmpty from \"../../helpers/dom/isInputEmpty\";\r\nimport whichChild from \"../../helpers/dom/whichChild\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport { Poll } from \"../../layer\";\r\n\r\nconst MAX_LENGTH_QUESTION = 255;\r\nconst MAX_LENGTH_OPTION = 100;\r\nconst MAX_LENGTH_SOLUTION = 200;\r\n\r\nexport default class PopupCreatePoll extends PopupElement {\r\n  private questionInputField: InputField;\r\n  private questions: HTMLElement;\r\n  protected scrollable: Scrollable;\r\n  private tempId = 0;\r\n\r\n  private anonymousCheckboxField: CheckboxField;\r\n  private multipleCheckboxField: PopupCreatePoll['anonymousCheckboxField'];\r\n  private quizCheckboxField: PopupCreatePoll['anonymousCheckboxField'];\r\n\r\n  private correctAnswers: Uint8Array[];\r\n  private quizSolutionField: InputField;\r\n  private optionInputFields: InputField[];\r\n\r\n  constructor(private chat: Chat) {\r\n    super('popup-create-poll popup-new-media', {closable: true, withConfirm: 'Create', body: true, title: 'NewPoll'});\r\n    this.construct();\r\n  }\r\n  \r\n  private async construct() {\r\n    this.questionInputField = new InputField({\r\n      placeholder: 'AskAQuestion',\r\n      label: 'AskAQuestion', \r\n      name: 'question', \r\n      maxLength: MAX_LENGTH_QUESTION\r\n    });\r\n\r\n    this.listenerSetter.add(this.questionInputField.input)('input', () => {\r\n      this.handleChange();\r\n    });\r\n\r\n    this.optionInputFields = [];\r\n\r\n    if(this.chat.type !== 'scheduled') {\r\n      const sendMenu = new SendContextMenu({\r\n        onSilentClick: () => {\r\n          this.chat.input.sendSilent = true;\r\n          this.send();\r\n        },\r\n        onScheduleClick: () => {\r\n          this.chat.input.scheduleSending(() => {\r\n            this.send();\r\n          });\r\n        },\r\n        openSide: 'bottom-left',\r\n        onContextElement: this.btnConfirm,\r\n      });\r\n  \r\n      sendMenu.setPeerId(this.chat.peerId);\r\n\r\n      this.header.append(sendMenu.sendMenu);\r\n    }\r\n\r\n    this.header.append(this.questionInputField.container);\r\n\r\n    const hr = document.createElement('hr');\r\n    const d = document.createElement('div');\r\n    d.classList.add('caption');\r\n    _i18n(d, 'PollOptions');\r\n\r\n    this.questions = document.createElement('form');\r\n    this.questions.classList.add('poll-create-questions');\r\n\r\n    const dd = document.createElement('div');\r\n    dd.classList.add('poll-create-settings');\r\n    \r\n    const settingsCaption = document.createElement('div');\r\n    settingsCaption.classList.add('caption');\r\n    _i18n(settingsCaption, 'Settings');\r\n\r\n    if(!(await this.chat.managers.appPeersManager.isBroadcast(this.chat.peerId))) {\r\n      this.anonymousCheckboxField = new CheckboxField({\r\n        text: 'NewPoll.Anonymous', \r\n        name: 'anonymous'\r\n      });\r\n      this.anonymousCheckboxField.input.checked = true;\r\n      dd.append(this.anonymousCheckboxField.label);\r\n    }\r\n    \r\n    this.multipleCheckboxField = new CheckboxField({\r\n      text: 'NewPoll.MultipleChoice', \r\n      name: 'multiple'\r\n    });\r\n    this.quizCheckboxField = new CheckboxField({\r\n      text: 'NewPoll.Quiz', \r\n      name: 'quiz'\r\n    });\r\n\r\n    this.listenerSetter.add(this.multipleCheckboxField.input)('change', () => {\r\n      const checked = this.multipleCheckboxField.input.checked;\r\n      this.quizCheckboxField.input.toggleAttribute('disabled', checked);\r\n    });\r\n\r\n    this.listenerSetter.add(this.quizCheckboxField.input)('change', () => {\r\n      const checked = this.quizCheckboxField.input.checked;\r\n\r\n      (Array.from(this.questions.children) as HTMLElement[]).map((el) => {\r\n        el.classList.toggle('radio-field', checked);\r\n      });\r\n\r\n      if(!checked) {\r\n        this.correctAnswers = undefined;\r\n        this.quizSolutionField.setValueSilently('');\r\n      }\r\n\r\n      quizElements.forEach((el) => el.classList.toggle('hide', !checked));\r\n\r\n      this.multipleCheckboxField.input.toggleAttribute('disabled', checked);\r\n      this.handleChange();\r\n    });\r\n\r\n    dd.append(this.multipleCheckboxField.label, this.quizCheckboxField.label);\r\n\r\n    const quizElements: HTMLElement[] = [];\r\n\r\n    const quizSolutionCaption = document.createElement('div');\r\n    quizSolutionCaption.classList.add('caption');\r\n    _i18n(quizSolutionCaption, 'AccDescrQuizExplanation');\r\n\r\n    const quizHr = document.createElement('hr');\r\n\r\n    const quizSolutionContainer = document.createElement('div');\r\n    quizSolutionContainer.classList.add('poll-create-questions');\r\n\r\n    this.quizSolutionField = new InputField({\r\n      placeholder: 'NewPoll.Explanation.Placeholder', \r\n      label: 'NewPoll.Explanation.Placeholder',\r\n      name: 'solution',\r\n      maxLength: MAX_LENGTH_SOLUTION\r\n    });\r\n\r\n    this.listenerSetter.add(this.questionInputField.input)('input', () => {\r\n      this.handleChange();\r\n    });\r\n\r\n    const quizSolutionSubtitle = document.createElement('div');\r\n    quizSolutionSubtitle.classList.add('subtitle');\r\n    _i18n(quizSolutionSubtitle, 'AddAnExplanationInfo');\r\n\r\n    quizSolutionContainer.append(this.quizSolutionField.container, quizSolutionSubtitle);\r\n\r\n    quizElements.push(quizHr, quizSolutionCaption, quizSolutionContainer);\r\n    quizElements.forEach((el) => el.classList.add('hide'));\r\n\r\n    this.body.parentElement.insertBefore(hr, this.body);\r\n    this.body.append(d, this.questions, document.createElement('hr'), settingsCaption, dd, ...quizElements);\r\n\r\n    attachClickEvent(this.btnConfirm, this.onSubmitClick, {listenerSetter: this.listenerSetter});\r\n\r\n    this.scrollable = new Scrollable(this.body);\r\n    this.appendMoreField();\r\n\r\n    this.onEscape = () => {\r\n      return !this.getFilledAnswers().length;\r\n    };\r\n\r\n    this.handleChange();\r\n  }\r\n\r\n  private getFilledAnswers() {\r\n    const answers = Array.from(this.questions.children).map((el, idx) => {\r\n      const input = el.querySelector('.input-field-input') as HTMLElement;\r\n      return input instanceof HTMLInputElement ? input.value : getRichValue(input, false).value;\r\n    }).filter((v) => !!v.trim());\r\n\r\n    return answers;\r\n  }\r\n\r\n  private onSubmitClick = () => {\r\n    this.send();\r\n  };\r\n\r\n  private validate() {\r\n    const question = this.questionInputField.value;\r\n    if(!question) {\r\n      return false;\r\n    }\r\n\r\n    if(question.length > MAX_LENGTH_QUESTION) {\r\n      return false;\r\n    }\r\n\r\n    if(this.quizCheckboxField.input.checked && !this.correctAnswers?.length) {\r\n      return false;\r\n    }\r\n\r\n    const answers = this.getFilledAnswers();\r\n    if(answers.length < 2) {\r\n      return false;\r\n    }\r\n    \r\n    const tooLongOption = answers.find((a) => a.length > MAX_LENGTH_OPTION);\r\n    if(tooLongOption) {\r\n      return false;\r\n    }\r\n\r\n    const {value: quizSolution} = getRichValue(this.quizSolutionField.input, false);\r\n    if(quizSolution.length > MAX_LENGTH_SOLUTION) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  private handleChange() {\r\n    const valid = this.validate();\r\n    this.btnConfirm.toggleAttribute('disabled', !valid);\r\n  }\r\n\r\n  public async send(force = false) {\r\n    const question = this.questionInputField.value;\r\n\r\n    const answers = this.getFilledAnswers();\r\n\r\n    const {value: quizSolution, entities: quizSolutionEntities} = getRichValue(this.quizSolutionField.input);\r\n\r\n    if(this.chat.type === 'scheduled' && !force) {\r\n      this.chat.input.scheduleSending(() => {\r\n        this.send(true);\r\n      });\r\n      \r\n      return;\r\n    }\r\n\r\n    this.hide();\r\n\r\n    //const randomID = [nextRandomInt(0xFFFFFFFF), nextRandomInt(0xFFFFFFFF)];\r\n    //const randomIDS = bigint(randomID[0]).shiftLeft(32).add(bigint(randomID[1])).toString();\r\n\r\n    const pFlags: Poll['pFlags'] = {};\r\n\r\n    if(this.anonymousCheckboxField && !this.anonymousCheckboxField.input.checked) {\r\n      pFlags.public_voters = true;\r\n    }\r\n\r\n    if(this.multipleCheckboxField.input.checked) {\r\n      pFlags.multiple_choice = true;\r\n    }\r\n\r\n    if(this.quizCheckboxField.input.checked) {\r\n      pFlags.quiz = true;\r\n    }\r\n\r\n    const poll: Poll = {\r\n      _: 'poll',\r\n      pFlags,\r\n      question,\r\n      answers: answers.map((value, idx) => {\r\n        return {\r\n          _: 'pollAnswer',\r\n          text: value,\r\n          option: new Uint8Array([idx])\r\n        };\r\n      }),\r\n      id: undefined\r\n    };\r\n    //poll.id = randomIDS;\r\n\r\n    const inputMediaPoll = await this.chat.managers.appPollsManager.getInputMediaPoll(poll, this.correctAnswers, quizSolution, quizSolutionEntities);\r\n\r\n    //console.log('Will try to create poll:', inputMediaPoll);\r\n\r\n    this.chat.managers.appMessagesManager.sendOther(this.chat.peerId, inputMediaPoll, {\r\n      ...this.chat.getMessageSendingParams()\r\n    });\r\n\r\n    if(this.chat.input.helperType === 'reply') {\r\n      this.chat.input.clearHelper();\r\n    }\r\n\r\n    this.chat.input.onMessageSent(false, false);\r\n  }\r\n\r\n  onInput = (e: Event) => {\r\n    const target = e.target as HTMLInputElement;\r\n\r\n    const radioLabel = findUpTag(target, 'LABEL');\r\n    const isEmpty = isInputEmpty(target);\r\n    if(!isEmpty) {\r\n      target.parentElement.classList.add('is-filled');\r\n      radioLabel.classList.remove('hidden-widget');\r\n      radioLabel.firstElementChild.removeAttribute('disabled');\r\n    }\r\n\r\n    const isLast = !radioLabel.nextElementSibling;\r\n    if(isLast && !isEmpty && this.questions.childElementCount < 10) {\r\n      this.appendMoreField();\r\n    }\r\n\r\n    this.handleChange();\r\n  };\r\n\r\n  onDeleteClick = (e: MouseEvent) => {\r\n    const target = e.target as HTMLSpanElement;\r\n    const label = findUpTag(target, 'LABEL');\r\n    const idx = whichChild(label);\r\n\r\n    if(this.correctAnswers && this.correctAnswers[0][0] === idx) {\r\n      this.correctAnswers = undefined;\r\n    }\r\n\r\n    label.remove();\r\n    this.optionInputFields.splice(idx, 1);\r\n\r\n    this.optionInputFields.forEach((inputField, idx) => {\r\n      inputField.options.labelOptions.length = 0;\r\n      inputField.options.labelOptions.push(idx + 1);\r\n      const i18nElement = I18n.weakMap.get(inputField.label.firstElementChild as HTMLElement);\r\n      i18nElement.update();\r\n    });\r\n\r\n    this.handleChange();\r\n  };\r\n\r\n  private appendMoreField() {\r\n    const tempId = this.tempId++;\r\n    const idx = this.questions.childElementCount + 1;\r\n    const questionField = new InputField({\r\n      placeholder: 'NewPoll.OptionsAddOption', \r\n      label: 'NewPoll.OptionLabel',\r\n      labelOptions: [idx],\r\n      name: 'question-' + tempId, \r\n      maxLength: MAX_LENGTH_OPTION\r\n    });\r\n    this.listenerSetter.add(questionField.input)('input', this.onInput);\r\n\r\n    const radioField = new RadioField({\r\n      text: '', \r\n      name: 'question'\r\n    });\r\n    radioField.main.append(questionField.container);\r\n    attachClickEvent(questionField.input, cancelEvent, {listenerSetter: this.listenerSetter});\r\n    radioField.label.classList.add('hidden-widget');\r\n    radioField.input.disabled = true;\r\n    if(!this.quizCheckboxField.input.checked) {\r\n      radioField.label.classList.remove('radio-field');\r\n    }\r\n    this.listenerSetter.add(radioField.input)('change', () => {\r\n      const checked = radioField.input.checked;\r\n      if(checked) {\r\n        const idx = whichChild(radioField.label);\r\n        this.correctAnswers = [new Uint8Array([idx])];\r\n        this.handleChange();\r\n      }\r\n    });\r\n\r\n    const deleteBtn = document.createElement('span');\r\n    deleteBtn.classList.add('btn-icon', 'tgico-close');\r\n    questionField.container.append(deleteBtn);\r\n  \r\n    attachClickEvent(deleteBtn, this.onDeleteClick, {listenerSetter: this.listenerSetter, once: true});\r\n\r\n    this.questions.append(radioField.label);\r\n\r\n    this.scrollable.scrollIntoViewNew({\r\n      element: this.questions.lastElementChild as HTMLElement, \r\n      position: 'center'\r\n    });\r\n    //this.scrollable.scrollTo(this.scrollable.scrollHeight, 'top', true, true);\r\n\r\n    this.optionInputFields.push(questionField);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport pause from \"./schedulers/pause\";\r\nimport { makeMediaSize } from \"./mediaSize\";\r\nimport scaleMediaElement from \"./canvas/scaleMediaElement\";\r\nimport preloadVideo from \"./preloadVideo\";\r\n\r\nexport function createPosterFromMedia(media: HTMLVideoElement | HTMLImageElement) {\r\n  let width: number, height: number;\r\n  if(media instanceof HTMLVideoElement) {\r\n    width = media.videoWidth;\r\n    height = media.videoHeight;\r\n  } else {\r\n    width = media.naturalWidth;\r\n    height = media.naturalHeight;\r\n  }\r\n\r\n  return scaleMediaElement({\r\n    media, \r\n    mediaSize: makeMediaSize(width, height), \r\n    boxSize: makeMediaSize(320, 240),\r\n    quality: .9\r\n  });\r\n}\r\n\r\nexport function createPosterFromVideo(video: HTMLVideoElement): ReturnType<typeof scaleMediaElement> {\r\n  return new Promise((resolve, reject) => {\r\n    video.onseeked = () => {\r\n      video.onseeked = () => {\r\n        createPosterFromMedia(video).then(resolve);\r\n\r\n        video.onseeked = undefined;\r\n      };\r\n\r\n      video.currentTime = 0;\r\n    };\r\n    \r\n    video.onerror = reject;\r\n    video.currentTime = Math.min(video.duration, 1);\r\n  });\r\n}\r\n\r\nexport async function createPosterForVideo(url: string) {\r\n  const video = await preloadVideo(url);\r\n\r\n  return Promise.race([\r\n    pause(2000) as Promise<undefined>,\r\n    createPosterFromVideo(video),\r\n  ]);\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n","/**\r\n * @returns duration in ms\r\n */\r\nexport default function getGifDuration(image: HTMLImageElement) {\r\n  const src = image.src;\r\n\r\n  return fetch(src)\r\n  .then((response) => response.arrayBuffer())\r\n  .then((arrayBuffer) => {\r\n    const d = new Uint8Array(arrayBuffer);\r\n    // Thanks to http://justinsomnia.org/2006/10/gif-animation-duration-calculation/\r\n    // And http://www.w3.org/Graphics/GIF/spec-gif89a.txt\r\n    let duration = 0;\r\n    for(let i = 0, length = d.length; i < length; ++i) {\r\n      // Find a Graphic Control Extension hex(21F904__ ____ __00)\r\n      if(d[i] == 0x21 \r\n       && d[i + 1] == 0xF9 \r\n       && d[i + 2] == 0x04 \r\n       && d[i + 7] == 0x00) {\r\n        // Swap 5th and 6th bytes to get the delay per frame\r\n        const delay = (d[i + 5] << 8) | (d[i + 4] & 0xFF);\r\n        \r\n        // Should be aware browsers have a minimum frame delay \r\n        // e.g. 6ms for IE, 2ms modern browsers (50fps)\r\n        duration += delay < 2 ? 10 : delay;\r\n      }\r\n    }\r\n\r\n    return duration / 1000;\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type Chat from \"../chat/chat\";\r\nimport InputField from \"../inputField\";\r\nimport PopupElement from \".\";\r\nimport Scrollable from \"../scrollable\";\r\nimport { toast } from \"../toast\";\r\nimport { wrapDocument } from \"../wrappers\";\r\nimport CheckboxField from \"../checkboxField\";\r\nimport SendContextMenu from \"../chat/sendContextMenu\";\r\nimport { createPosterFromMedia, createPosterFromVideo } from \"../../helpers/createPoster\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport I18n, { FormatterArguments, i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport calcImageInBox from \"../../helpers/calcImageInBox\";\r\nimport placeCaretAtEnd from \"../../helpers/dom/placeCaretAtEnd\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport MEDIA_MIME_TYPES_SUPPORTED from '../../environment/mediaMimeTypesSupport';\r\nimport getGifDuration from \"../../helpers/getGifDuration\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport createVideo from \"../../helpers/dom/createVideo\";\r\nimport prepareAlbum from \"../prepareAlbum\";\r\nimport { MediaSize } from \"../../helpers/mediaSize\";\r\nimport { ThumbCache } from \"../../lib/storages/thumbs\";\r\nimport onMediaLoad from \"../../helpers/onMediaLoad\";\r\nimport apiManagerProxy from \"../../lib/mtproto/mtprotoworker\";\r\n\r\ntype SendFileParams = Partial<{\r\n  file: File,\r\n  objectURL: string,\r\n  thumb: {\r\n    blob: Blob,\r\n    url: string,\r\n    size: MediaSize\r\n  },\r\n  width: number,\r\n  height: number,\r\n  duration: number,\r\n  noSound: boolean,\r\n  itemDiv: HTMLElement\r\n}>;\r\n\r\nlet currentPopup: PopupNewMedia;\r\n\r\nexport function getCurrentNewMediaPopup() {\r\n  return currentPopup;\r\n}\r\n\r\nexport default class PopupNewMedia extends PopupElement {\r\n  private input: HTMLElement;\r\n  private mediaContainer: HTMLElement;\r\n  private groupCheckboxField: CheckboxField;\r\n  private mediaCheckboxField: CheckboxField;\r\n  private wasInputValue: string;\r\n\r\n  private willAttach: Partial<{\r\n    type: 'media' | 'document',\r\n    isMedia: true,\r\n    group: boolean,\r\n    sendFileDetails: SendFileParams[]\r\n  }>;\r\n  private inputField: InputField;\r\n  private captionLengthMax: number;\r\n\r\n  constructor(private chat: Chat, private files: File[], willAttachType: PopupNewMedia['willAttach']['type']) {\r\n    super('popup-send-photo popup-new-media', {closable: true, withConfirm: 'Modal.Send', confirmShortcutIsSendShortcut: true, body: true, title: true});\r\n    this.construct(willAttachType);\r\n  }\r\n\r\n  private async construct(willAttachType: PopupNewMedia['willAttach']['type']) {\r\n    this.willAttach = {\r\n      type: willAttachType,\r\n      sendFileDetails: [],\r\n      group: false\r\n    };\r\n\r\n    const config = await this.managers.apiManager.getConfig();\r\n    this.captionLengthMax = config.caption_length_max;\r\n\r\n    attachClickEvent(this.btnConfirm, () => this.send(), {listenerSetter: this.listenerSetter});\r\n\r\n    if(this.chat.type !== 'scheduled') {\r\n      const sendMenu = new SendContextMenu({\r\n        onSilentClick: () => {\r\n          this.chat.input.sendSilent = true;\r\n          this.send();\r\n        },\r\n        onScheduleClick: () => {\r\n          this.chat.input.scheduleSending(() => {\r\n            this.send();\r\n          });\r\n        },\r\n        openSide: 'bottom-left',\r\n        onContextElement: this.btnConfirm,\r\n        listenerSetter: this.listenerSetter\r\n      });\r\n\r\n      sendMenu.setPeerId(this.chat.peerId);\r\n\r\n      this.header.append(sendMenu.sendMenu);\r\n    }\r\n\r\n    this.mediaContainer = document.createElement('div');\r\n    this.mediaContainer.classList.add('popup-photo');\r\n    const scrollable = new Scrollable(null);\r\n    scrollable.container.append(this.mediaContainer);\r\n    \r\n    this.inputField = new InputField({\r\n      placeholder: 'PreviewSender.CaptionPlaceholder',\r\n      label: 'Caption',\r\n      name: 'photo-caption',\r\n      maxLength: this.captionLengthMax,\r\n      withLinebreaks: true\r\n    });\r\n    this.input = this.inputField.input;\r\n\r\n    this.inputField.value = this.wasInputValue = this.chat.input.messageInputField.input.innerHTML;\r\n    this.chat.input.messageInputField.value = '';\r\n\r\n    this.body.append(scrollable.container);\r\n    this.container.append(this.inputField.container);\r\n\r\n    this.attachFiles();\r\n\r\n    this.addEventListener('close', () => {\r\n      this.files = [];\r\n      currentPopup = undefined;\r\n    });\r\n\r\n    currentPopup = this;\r\n  }\r\n\r\n  public appendDrops(element: HTMLElement) {\r\n    this.body.append(element);\r\n  }\r\n\r\n  get type() {\r\n    return this.willAttach.type;\r\n  }\r\n\r\n  set type(type: PopupNewMedia['willAttach']['type']) {\r\n    this.willAttach.type = type;\r\n  }\r\n\r\n  private appendGroupCheckboxField() {\r\n    const good = this.files.length > 1;\r\n    if(good && !this.groupCheckboxField) {\r\n      this.groupCheckboxField = new CheckboxField({\r\n        text: 'PreviewSender.GroupItems', \r\n        name: 'group-items'\r\n      });\r\n      this.container.append(...[this.groupCheckboxField.label, this.mediaCheckboxField?.label, this.inputField.container].filter(Boolean));\r\n  \r\n      this.willAttach.group = true;\r\n      this.groupCheckboxField.setValueSilently(this.willAttach.group);\r\n\r\n      this.listenerSetter.add(this.groupCheckboxField.input)('change', () => {\r\n        const checked = this.groupCheckboxField.checked;\r\n  \r\n        this.willAttach.group = checked;\r\n\r\n        this.attachFiles();\r\n      });\r\n    } else if(this.groupCheckboxField) {\r\n      this.groupCheckboxField.label.classList.toggle('hide', !good);\r\n    }\r\n  }\r\n\r\n  private appendMediaCheckboxField() {\r\n    const good = !!this.files.find((file) => MEDIA_MIME_TYPES_SUPPORTED.has(file.type));\r\n    if(good && !this.mediaCheckboxField) {\r\n      this.mediaCheckboxField = new CheckboxField({\r\n        text: 'PreviewSender.CompressFile',\r\n        name: 'compress-items'\r\n      });\r\n      this.container.append(...[this.groupCheckboxField?.label, this.mediaCheckboxField.label, this.inputField.container].filter(Boolean));\r\n\r\n      this.mediaCheckboxField.setValueSilently(this.willAttach.type === 'media');\r\n\r\n      this.listenerSetter.add(this.mediaCheckboxField.input)('change', () => {\r\n        const checked = this.mediaCheckboxField.checked;\r\n  \r\n        this.willAttach.type = checked ? 'media' : 'document';\r\n\r\n        this.attachFiles();\r\n      });\r\n    } else if(this.mediaCheckboxField) {\r\n      this.mediaCheckboxField.label.classList.toggle('hide', !good);\r\n    }\r\n  }\r\n\r\n  public addFiles(files: File[]) {\r\n    const toPush = files.filter((file) => {\r\n      const found = this.files.find((_file) => {\r\n        return _file.lastModified === file.lastModified && _file.name === file.name && _file.size === file.size;\r\n      });\r\n      \r\n      return !found;\r\n    });\r\n\r\n    if(toPush.length) {\r\n      this.files.push(...toPush);\r\n      this.attachFiles();\r\n    }\r\n  }\r\n\r\n  private onKeyDown = (e: KeyboardEvent) => {\r\n    const target = e.target as HTMLElement;\r\n    if(target !== this.input) {\r\n      if(target.tagName === 'INPUT' || target.hasAttribute('contenteditable')) {\r\n        return;\r\n      }\r\n\r\n      this.input.focus();\r\n      placeCaretAtEnd(this.input);\r\n    }\r\n  };\r\n\r\n  private send(force = false) {\r\n    if(this.chat.type === 'scheduled' && !force) {\r\n      this.chat.input.scheduleSending(() => {\r\n        this.send(true);\r\n      });\r\n      \r\n      return;\r\n    }\r\n\r\n    let caption = this.inputField.value;\r\n    if(caption.length > this.captionLengthMax) {\r\n      toast(I18n.format('Error.PreviewSender.CaptionTooLong', true));\r\n      return;\r\n    }\r\n\r\n    this.hide();\r\n    const willAttach = this.willAttach;\r\n    willAttach.isMedia = willAttach.type === 'media' ? true : undefined;\r\n    const {sendFileDetails, isMedia} = willAttach;\r\n\r\n    //console.log('will send files with options:', willAttach);\r\n\r\n    const {peerId, input} = this.chat;\r\n\r\n    sendFileDetails.forEach((d) => {\r\n      d.itemDiv = undefined;\r\n    });\r\n\r\n    const {length} = sendFileDetails;\r\n    const sendingParams = this.chat.getMessageSendingParams();\r\n    this.iterate((sendFileDetails) => {\r\n      if(caption && sendFileDetails.length !== length) {\r\n        this.managers.appMessagesManager.sendText(peerId, caption, {\r\n          ...sendingParams,\r\n          clearDraft: true\r\n        });\r\n\r\n        caption = undefined;\r\n      }\r\n\r\n      const w = {\r\n        ...willAttach,\r\n        sendFileDetails\r\n      };\r\n\r\n      this.managers.appMessagesManager.sendAlbum(peerId, w.sendFileDetails.map((d) => d.file), Object.assign({\r\n        ...sendingParams,\r\n        caption,\r\n        isMedia: isMedia,\r\n        clearDraft: true as true\r\n      }, w));\r\n\r\n      caption = undefined;\r\n    });\r\n    \r\n    input.replyToMsgId = this.chat.threadId;\r\n    input.onMessageSent();\r\n  }\r\n\r\n  private async attachMedia(params: SendFileParams, itemDiv: HTMLElement) {\r\n    itemDiv.classList.add('popup-item-media');\r\n\r\n    const file = params.file;\r\n    const isVideo = file.type.startsWith('video/');\r\n\r\n    let promise: Promise<void>;\r\n    if(isVideo) {\r\n      const video = createVideo();\r\n      const source = document.createElement('source');\r\n      source.src = params.objectURL = await apiManagerProxy.invoke('createObjectURL', file);\r\n      video.autoplay = true;\r\n      video.controls = false;\r\n      video.muted = true;\r\n\r\n      video.addEventListener('timeupdate', () => {\r\n        video.pause();\r\n      }, {once: true});\r\n\r\n      promise = onMediaLoad(video).then(async() => {\r\n        params.width = video.videoWidth;\r\n        params.height = video.videoHeight;\r\n        params.duration = Math.floor(video.duration);\r\n        \r\n        const audioDecodedByteCount = (video as any).webkitAudioDecodedByteCount;\r\n        if(audioDecodedByteCount !== undefined) {\r\n          params.noSound = !audioDecodedByteCount;\r\n        }\r\n\r\n        itemDiv.append(video);\r\n        const thumb = await createPosterFromVideo(video);\r\n        params.thumb = {\r\n          url: await apiManagerProxy.invoke('createObjectURL', thumb.blob),\r\n          ...thumb\r\n        };\r\n      });\r\n\r\n      video.append(source);\r\n    } else {\r\n      const img = new Image();\r\n      promise = new Promise<void>((resolve) => {\r\n        img.onload = () => {\r\n          params.width = img.naturalWidth;\r\n          params.height = img.naturalHeight;\r\n          \r\n          itemDiv.append(img);\r\n          \r\n          if(file.type === 'image/gif') {\r\n            params.noSound = true;\r\n            \r\n            Promise.all([\r\n              getGifDuration(img).then((duration) => {\r\n                params.duration = Math.ceil(duration);\r\n              }),\r\n              \r\n              createPosterFromMedia(img).then(async(thumb) => {\r\n                params.thumb = {\r\n                  url: await apiManagerProxy.invoke('createObjectURL', thumb.blob),\r\n                  ...thumb\r\n                };\r\n              })\r\n            ]).then(() => {\r\n              resolve();\r\n            });\r\n          } else {\r\n            resolve();\r\n          }\r\n        };\r\n      });\r\n      \r\n      img.src = params.objectURL = await apiManagerProxy.invoke('createObjectURL', file);\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  private async attachDocument(params: SendFileParams, itemDiv: HTMLElement): ReturnType<PopupNewMedia['attachMedia']> {\r\n    itemDiv.classList.add('popup-item-document');\r\n    const file = params.file;\r\n\r\n    const isPhoto = file.type.startsWith('image/');\r\n    const isAudio = file.type.startsWith('audio/');\r\n    if(isPhoto || isAudio || file.size < 20e6) {\r\n      params.objectURL = await apiManagerProxy.invoke('createObjectURL', file);\r\n    }\r\n\r\n    const doc = {\r\n      _: 'document',\r\n      file: file,\r\n      file_name: file.name || '',\r\n      size: file.size,\r\n      type: isPhoto ? 'photo' : 'doc'\r\n    } as MyDocument;\r\n\r\n    let cacheContext: ThumbCache;\r\n    if(params.objectURL) {\r\n      cacheContext = {\r\n        url: params.objectURL,\r\n        downloaded: file.size,\r\n        type: 'full'\r\n      };\r\n    }\r\n\r\n    const docDiv = await wrapDocument({\r\n      message: {\r\n        _: 'message',\r\n        pFlags: {\r\n          is_outgoing: true\r\n        },\r\n        mid: 0,\r\n        peerId: 0,\r\n        media: {\r\n          _: 'messageMediaDocument',\r\n          document: doc\r\n        }\r\n      } as any,\r\n      cacheContext\r\n    });\r\n\r\n    const promise = new Promise<void>((resolve) => {\r\n      const finish = () => {\r\n        itemDiv.append(docDiv);\r\n        resolve();\r\n      };\r\n  \r\n      if(isPhoto) {\r\n        const img = new Image();\r\n        img.src = params.objectURL;\r\n        img.onload = () => {\r\n          params.width = img.naturalWidth;\r\n          params.height = img.naturalHeight;\r\n  \r\n          finish();\r\n        };\r\n  \r\n        img.onerror = finish;\r\n      } else {\r\n        finish();\r\n      }\r\n    });\r\n\r\n    return promise;\r\n  }\r\n\r\n  private attachFile = (file: File) => {\r\n    const willAttach = this.willAttach;\r\n    const shouldCompress = this.shouldCompress(file.type);\r\n\r\n    const params: SendFileParams = {};\r\n    params.file = file;\r\n\r\n    const itemDiv = document.createElement('div');\r\n    itemDiv.classList.add('popup-item');\r\n\r\n    params.itemDiv = itemDiv;\r\n\r\n    const promise = shouldCompress ? this.attachMedia(params, itemDiv) : this.attachDocument(params, itemDiv);\r\n    willAttach.sendFileDetails.push(params);\r\n    return promise;\r\n  };\r\n  \r\n  private shouldCompress(mimeType: string) {\r\n    return this.willAttach.type === 'media' && MEDIA_MIME_TYPES_SUPPORTED.has(mimeType);\r\n  }\r\n\r\n  private onRender() {\r\n    // show now\r\n    if(!this.element.classList.contains('active')) {\r\n      this.listenerSetter.add(document.body)('keydown', this.onKeyDown);\r\n      this.addEventListener('close', () => {\r\n        if(this.wasInputValue) {\r\n          this.chat.input.messageInputField.value = this.wasInputValue;\r\n        }\r\n      });\r\n      this.show();\r\n    }\r\n  }\r\n\r\n  private setTitle() {\r\n    const {willAttach, title, files} = this;\r\n    let key: LangPackKey;\r\n    const args: FormatterArguments = [];\r\n    if(willAttach.type === 'document') {\r\n      key = 'PreviewSender.SendFile';\r\n      args.push(files.length);\r\n    } else {\r\n      let foundPhotos = 0, foundVideos = 0, foundFiles = 0;\r\n      files.forEach((file) => {\r\n        if(file.type.startsWith('image/')) ++foundPhotos;\r\n        else if(file.type.startsWith('video/')) ++foundVideos;\r\n        else ++foundFiles;\r\n      });\r\n\r\n      if([foundPhotos, foundVideos, foundFiles].filter((n) => n > 0).length > 1) {\r\n        key = 'PreviewSender.SendFile';\r\n        args.push(files.length);\r\n      } else \r\n      \r\n      /* const sum = foundPhotos + foundVideos;\r\n      if(sum > 1 && willAttach.group) {\r\n        key = 'PreviewSender.SendAlbum';\r\n        const albumsLength = Math.ceil(sum / 10);\r\n        args.push(albumsLength);\r\n      } else  */if(foundPhotos) {\r\n        key = 'PreviewSender.SendPhoto';\r\n        args.push(foundPhotos);\r\n      } else if(foundVideos) {\r\n        key = 'PreviewSender.SendVideo';\r\n        args.push(foundVideos);\r\n      }\r\n    }\r\n\r\n    replaceContent(title, i18n(key, args));\r\n  }\r\n\r\n  private appendMediaToContainer(div: HTMLElement, params: SendFileParams) {\r\n    if(this.shouldCompress(params.file.type)) {\r\n      const size = calcImageInBox(params.width, params.height, 380, 320);\r\n      div.style.width = size.width + 'px';\r\n      div.style.height = size.height + 'px';\r\n    }\r\n\r\n    this.mediaContainer.append(div);\r\n  }\r\n\r\n  private iterate(cb: (sendFileDetails: SendFileParams[]) => void) {\r\n    const {sendFileDetails} = this.willAttach;\r\n    if(!this.willAttach.group) {\r\n      sendFileDetails.forEach((p) => cb([p]));\r\n      return;\r\n    }\r\n\r\n    const length = sendFileDetails.length;\r\n    for(let i = 0; i < length;) {\r\n      const firstType = sendFileDetails[i].file.type;\r\n      let k = 0;\r\n      for(; k < 10 && i < length; ++i, ++k) {\r\n        const type = sendFileDetails[i].file.type;\r\n        if(this.shouldCompress(firstType) !== this.shouldCompress(type)) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      cb(sendFileDetails.slice(i - k, i));\r\n    }\r\n  }\r\n\r\n  private attachFiles() {\r\n    const {files, willAttach, mediaContainer} = this;\r\n    willAttach.sendFileDetails.length = 0;\r\n\r\n    this.appendGroupCheckboxField();\r\n    this.appendMediaCheckboxField();\r\n\r\n    Promise.all(files.map(this.attachFile)).then(() => {\r\n      mediaContainer.innerHTML = '';\r\n\r\n      if(!files.length) {\r\n        return;\r\n      }\r\n\r\n      this.setTitle();\r\n\r\n      this.iterate((sendFileDetails) => {\r\n        if(this.shouldCompress(sendFileDetails[0].file.type) && sendFileDetails.length > 1) {\r\n          const albumContainer = document.createElement('div');\r\n          albumContainer.classList.add('popup-item-album', 'popup-item');\r\n          albumContainer.append(...sendFileDetails.map((s) => s.itemDiv));\r\n\r\n          prepareAlbum({\r\n            container: albumContainer,\r\n            items: sendFileDetails.map((o) => ({w: o.width, h: o.height})),\r\n            maxWidth: 380,\r\n            minWidth: 100,\r\n            spacing: 4\r\n          });\r\n\r\n          mediaContainer.append(albumContainer);\r\n        } else {\r\n          sendFileDetails.forEach((params) => {\r\n            this.appendMediaToContainer(params.itemDiv, params);\r\n          });\r\n        }\r\n      });\r\n    }).then(() => {\r\n      this.onRender();\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport fastSmoothScroll from \"../fastSmoothScroll\";\r\nimport cancelEvent from \"./cancelEvent\";\r\nimport { attachClickEvent, detachClickEvent } from \"./clickEvent\";\r\nimport findUpAsChild from \"./findUpAsChild\";\r\nimport findUpClassName from \"./findUpClassName\";\r\n\r\ntype ArrowKey = 'ArrowUp' | 'ArrowDown' | 'ArrowLeft' | 'ArrowRight';\r\nconst HANDLE_EVENT = 'keydown';\r\nconst ACTIVE_CLASS_NAME = 'active';\r\n\r\nconst AXIS_Y_KEYS: ArrowKey[] = ['ArrowUp', 'ArrowDown'];\r\nconst AXIS_X_KEYS: ArrowKey[] = ['ArrowLeft', 'ArrowRight'];\r\n\r\nexport default function attachListNavigation({list, type, onSelect, once, waitForKey}: {\r\n  list: HTMLElement, \r\n  type: 'xy' | 'x' | 'y',\r\n  onSelect: (target: Element) => void | boolean,\r\n  once: boolean,\r\n  waitForKey?: string[]\r\n}) {\r\n  let waitForKeySet = waitForKey?.length ? new Set(waitForKey) : undefined;\r\n  const keyNames = new Set(type === 'xy' ? AXIS_Y_KEYS.concat(AXIS_X_KEYS) : (type === 'x' ? AXIS_X_KEYS : AXIS_Y_KEYS)); \r\n\r\n  let target: Element;\r\n  const getCurrentTarget = () => {\r\n    return target || list.querySelector('.' + ACTIVE_CLASS_NAME) || list.firstElementChild;\r\n  };\r\n\r\n  const setCurrentTarget = (_target: Element, scrollTo: boolean) => {\r\n    if(target === _target) {\r\n      return;\r\n    }\r\n\r\n    let hadTarget = false;\r\n    if(target) {\r\n      hadTarget = true;\r\n      target.classList.remove(ACTIVE_CLASS_NAME);\r\n    }\r\n\r\n    target = _target;\r\n    if(!target) return;\r\n    target.classList.add(ACTIVE_CLASS_NAME);\r\n\r\n    if(hadTarget && scrollable && scrollTo) {\r\n      fastSmoothScroll({\r\n        container: scrollable, \r\n        element: target as HTMLElement, \r\n        position: 'center', \r\n        forceDuration: 100, \r\n        axis: type === 'x' ? 'x' : 'y'\r\n      });\r\n    }\r\n  };\r\n\r\n  const getNextTargetX = (currentTarget: Element, isNext: boolean) => {\r\n    let nextTarget: Element;\r\n    if(isNext) nextTarget = currentTarget.nextElementSibling || list.firstElementChild;\r\n    else nextTarget = currentTarget.previousElementSibling || list.lastElementChild;\r\n\r\n    return nextTarget;\r\n  };\r\n\r\n  const getNextTargetY = (currentTarget: Element, isNext: boolean) => {\r\n    const property = isNext ? 'nextElementSibling' : 'previousElementSibling';\r\n    const endProperty = isNext ? 'firstElementChild' : 'lastElementChild';\r\n    const currentRect = currentTarget.getBoundingClientRect();\r\n\r\n    let nextTarget = currentTarget[property] || list[endProperty];\r\n    while(nextTarget !== currentTarget) {\r\n      const targetRect = nextTarget.getBoundingClientRect();\r\n      if(targetRect.x === currentRect.x && targetRect.y !== currentRect.y) {\r\n        break;\r\n      }\r\n\r\n      nextTarget = nextTarget[property] || list[endProperty];\r\n    }\r\n\r\n    return nextTarget;\r\n  };\r\n\r\n  let handleArrowKey: (currentTarget: Element, key: ArrowKey) => Element;\r\n  if(type === 'xy') { // flex-direction: row; flex-wrap: wrap;\r\n    handleArrowKey = (currentTarget, key) => {\r\n      if(key === 'ArrowUp' || key === 'ArrowDown') return getNextTargetY(currentTarget, key === 'ArrowDown');\r\n      else return getNextTargetX(currentTarget, key === 'ArrowRight');\r\n    };\r\n  } else { // flex-direction: row | column;\r\n    handleArrowKey = (currentTarget, key) => getNextTargetX(currentTarget, key === 'ArrowRight' || key === 'ArrowDown');\r\n  }\r\n\r\n  let onKeyDown = (e: KeyboardEvent) => {\r\n    const key = e.key;\r\n    if(!keyNames.has(key as any)) {\r\n      if(key === 'Enter' || (type !== 'xy' && key === 'Tab')) {\r\n        cancelEvent(e);\r\n        fireSelect(getCurrentTarget());\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    cancelEvent(e);\r\n\r\n    if(list.childElementCount > 1) {\r\n      let currentTarget = getCurrentTarget();\r\n      currentTarget = handleArrowKey(currentTarget, key as any);\r\n      setCurrentTarget(currentTarget, true);\r\n    }\r\n  };\r\n\r\n  const scrollable = findUpClassName(list, 'scrollable');\r\n  list.classList.add('navigable-list');\r\n\r\n  const onMouseMove = (e: MouseEvent) => {\r\n    const target = findUpAsChild(e.target, list) as HTMLElement;\r\n    if(!target) {\r\n      return;\r\n    }\r\n\r\n    setCurrentTarget(target, false);\r\n  };\r\n\r\n  const onClick = (e: Event) => {\r\n    cancelEvent(e); // cancel keyboard closening\r\n\r\n    const target = findUpAsChild(e.target, list) as HTMLElement;\r\n    if(!target) {\r\n      return;\r\n    }\r\n\r\n    setCurrentTarget(target, false);\r\n    fireSelect(getCurrentTarget());\r\n  };\r\n\r\n  const fireSelect = (target: Element) => {\r\n    const canContinue = onSelect(target);\r\n    if(canContinue !== undefined ? !canContinue : once) {\r\n      detach();\r\n    }\r\n  };\r\n\r\n  let attached = false;\r\n  const attach = () => {\r\n    if(attached) return;\r\n    attached = true;\r\n    // const input = document.activeElement as HTMLElement;\r\n    // input.addEventListener(HANDLE_EVENT, onKeyDown, {capture: true, passive: false});\r\n    document.addEventListener(HANDLE_EVENT, onKeyDown, {capture: true, passive: false});\r\n    list.addEventListener('mousemove', onMouseMove, {passive: true});\r\n    attachClickEvent(list, onClick);\r\n  };\r\n\r\n  const detach = () => {\r\n    if(!attached) return;\r\n    attached = false;\r\n    // input.removeEventListener(HANDLE_EVENT, onKeyDown, {capture: true});\r\n    document.removeEventListener(HANDLE_EVENT, onKeyDown, {capture: true});\r\n    list.removeEventListener('mousemove', onMouseMove);\r\n    detachClickEvent(list, onClick);\r\n  };\r\n\r\n  const resetTarget = () => {\r\n    if(waitForKeySet) return;\r\n    setCurrentTarget(list.firstElementChild, false);\r\n  };\r\n\r\n  if(waitForKeySet) {\r\n    const _onKeyDown = onKeyDown;\r\n    onKeyDown = (e) => {\r\n      if(waitForKeySet.has(e.key)) {\r\n        cancelEvent(e);\r\n\r\n        document.removeEventListener(HANDLE_EVENT, onKeyDown, {capture: true});\r\n        onKeyDown = _onKeyDown;\r\n        document.addEventListener(HANDLE_EVENT, onKeyDown, {capture: true, passive: false});\r\n\r\n        waitForKeySet = undefined;\r\n        resetTarget();\r\n      }\r\n    };\r\n  } else {\r\n    resetTarget();\r\n  }\r\n\r\n  attach();\r\n\r\n  return {\r\n    attach,\r\n    detach,\r\n    resetTarget\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport attachListNavigation from \"../../helpers/dom/attachListNavigation\";\r\nimport EventListenerBase from \"../../helpers/eventListenerBase\";\r\nimport { IS_MOBILE } from \"../../environment/userAgent\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport appNavigationController, { NavigationItem } from \"../appNavigationController\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\n\r\nexport default class AutocompleteHelper extends EventListenerBase<{\r\n  hidden: () => void,\r\n  visible: () => void,\r\n  hiding: () => void\r\n}> {\r\n  protected hidden = true;\r\n  protected container: HTMLElement;\r\n  protected list: HTMLElement;\r\n  protected resetTarget: () => void;\r\n  protected attach: () => void;\r\n  protected detach: () => void;\r\n  protected init?(): void;\r\n\r\n  protected controller: AutocompleteHelperController;\r\n  protected listType: 'xy' | 'x' | 'y';\r\n  protected onSelect: (target: Element) => boolean | void;\r\n  protected waitForKey?: string[];\r\n\r\n  protected navigationItem: NavigationItem;\r\n\r\n  constructor(options: {\r\n    appendTo: HTMLElement,\r\n    controller?: AutocompleteHelper['controller'],\r\n    listType: AutocompleteHelper['listType'],\r\n    onSelect: AutocompleteHelper['onSelect'],\r\n    waitForKey?: AutocompleteHelper['waitForKey']\r\n  }) {\r\n    super(false);\r\n\r\n    safeAssign(this, options);\r\n    \r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('autocomplete-helper', 'z-depth-1');\r\n    \r\n    options.appendTo.append(this.container);\r\n    \r\n    this.attachNavigation();\r\n\r\n    this.controller && this.controller.addHelper(this);\r\n  }\r\n\r\n  public toggleListNavigation(enabled: boolean) {\r\n    if(enabled) {\r\n      this.attach && this.attach();\r\n    } else {\r\n      this.detach && this.detach();\r\n    }\r\n  }\r\n\r\n  protected onVisible = () => {\r\n    if(this.detach) { // it can be so because 'visible' calls before animation's end\r\n      this.detach();\r\n    }\r\n\r\n    const list = this.list;\r\n    const {attach, detach, resetTarget} = attachListNavigation({\r\n      list, \r\n      type: this.listType,\r\n      onSelect: this.onSelect,\r\n      once: true,\r\n      waitForKey: this.waitForKey\r\n    });\r\n\r\n    this.attach = attach;\r\n    this.detach = detach;\r\n    this.resetTarget = resetTarget;\r\n    if(!IS_MOBILE && !this.navigationItem) {\r\n      this.navigationItem = {\r\n        type: 'autocomplete-helper',\r\n        onPop: () => {\r\n          this.navigationItem = undefined;\r\n          this.toggle(true);\r\n        },\r\n        noBlurOnPop: true\r\n      };\r\n\r\n      appNavigationController.pushItem(this.navigationItem);\r\n    }\r\n\r\n    this.addEventListener('hidden', () => {\r\n      this.resetTarget = undefined;\r\n      this.attach = undefined;\r\n      this.detach = undefined;\r\n\r\n      list.innerHTML = '';\r\n      detach();\r\n\r\n      if(this.navigationItem) {\r\n        appNavigationController.removeItem(this.navigationItem);\r\n        this.navigationItem = undefined;\r\n      }\r\n    }, {once: true});\r\n  };\r\n\r\n  protected attachNavigation() {\r\n    this.addEventListener('visible', this.onVisible);\r\n  }\r\n\r\n  public toggle(hide?: boolean, fromController = false, skipAnimation?: boolean) {\r\n    if(this.init) {\r\n      return;\r\n    }\r\n    \r\n    if(hide === undefined) {\r\n      hide = this.container.classList.contains('is-visible') && !this.container.classList.contains('backwards');\r\n    }\r\n\r\n    if(this.hidden === hide) {\r\n      if(!hide) {\r\n        this.dispatchEvent('visible'); // reset target and listener\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    this.hidden = hide;\r\n\r\n    if(!hide) {\r\n      this.controller && this.controller.hideOtherHelpers(this);\r\n      this.dispatchEvent('visible'); // fire it before so target will be set\r\n    } else {\r\n      if(this.navigationItem) {\r\n        appNavigationController.removeItem(this.navigationItem);\r\n        this.navigationItem = undefined;\r\n      }\r\n\r\n      if(!fromController && this.controller) {\r\n        this.controller.hideOtherHelpers();\r\n      }\r\n\r\n      if(this.detach) { // force detach here\r\n        this.detach();\r\n      }\r\n    }\r\n\r\n    const useRafs = this.controller || hide ? 0 : 2;\r\n\r\n    if(hide) {\r\n      this.dispatchEvent('hiding');\r\n    }\r\n\r\n    SetTransition(\r\n      this.container, \r\n      'is-visible', \r\n      !hide, \r\n      rootScope.settings.animationsEnabled && !skipAnimation ? 300 : 0, \r\n      () => {\r\n        this.hidden && this.dispatchEvent('hidden');\r\n      }, \r\n      useRafs\r\n    );\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport preloadAnimatedEmojiSticker from \"../../helpers/preloadAnimatedEmojiSticker\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport { CHAT_ANIMATION_GROUP } from \"../../lib/appManagers/appImManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport { EmoticonsDropdown } from \"../emoticonsDropdown\";\r\nimport { SuperStickerRenderer } from \"../emoticonsDropdown/tabs/stickers\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport Scrollable from \"../scrollable\";\r\nimport AutocompleteHelper from \"./autocompleteHelper\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\n\r\nexport default class StickersHelper extends AutocompleteHelper {\r\n  private scrollable: Scrollable;\r\n  private superStickerRenderer: SuperStickerRenderer;\r\n  private lazyLoadQueue: LazyLoadQueue;\r\n  private onChangeScreen: () => void;\r\n\r\n  constructor(\r\n    appendTo: HTMLElement, \r\n    controller: AutocompleteHelperController,\r\n    private managers: AppManagers\r\n  ) {\r\n    super({\r\n      appendTo, \r\n      controller,\r\n      listType: 'xy', \r\n      onSelect: (target) => {\r\n        return !EmoticonsDropdown.onMediaClick({target}, true);\r\n      }, \r\n      waitForKey: ['ArrowUp', 'ArrowDown']\r\n    });\r\n\r\n    this.container.classList.add('stickers-helper');\r\n\r\n    this.addEventListener('visible', () => {\r\n      setTimeout(() => { // it is not rendered yet\r\n        this.scrollable.container.scrollTop = 0;\r\n      }, 0);\r\n\r\n      rootScope.dispatchEvent('choosing_sticker', true);\r\n    });\r\n\r\n    this.addEventListener('hidden', () => {\r\n      if(this.onChangeScreen) {\r\n        mediaSizes.removeEventListener('changeScreen', this.onChangeScreen);\r\n        this.onChangeScreen = undefined;\r\n      }\r\n\r\n      rootScope.dispatchEvent('choosing_sticker', false);\r\n    });\r\n  }\r\n\r\n  public checkEmoticon(emoticon: string) {\r\n    const middleware = this.controller.getMiddleware();\r\n\r\n    if(this.lazyLoadQueue) {\r\n      this.lazyLoadQueue.clear();\r\n    }\r\n\r\n    preloadAnimatedEmojiSticker(emoticon);\r\n    this.managers.appStickersManager.getStickersByEmoticon(emoticon)\r\n    .then((stickers) => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      if(this.init) {\r\n        this.init();\r\n        this.init = null;\r\n      }\r\n\r\n      const container = this.list.cloneNode() as HTMLElement;\r\n\r\n      let ready: Promise<void>;\r\n\r\n      this.lazyLoadQueue.clear();\r\n      if(stickers.length) {\r\n        ready = new Promise<void>((resolve) => {\r\n          const promises: Promise<any>[] = [];\r\n          stickers.forEach((sticker) => {\r\n            container.append(this.superStickerRenderer.renderSticker(sticker as MyDocument, undefined, promises));\r\n          });\r\n\r\n          (Promise.all(promises) as Promise<any>).finally(resolve);\r\n        });\r\n      } else {\r\n        ready = Promise.resolve();\r\n      }\r\n\r\n      ready.then(() => {\r\n        this.list.replaceWith(container);\r\n        this.list = container;\r\n\r\n        if(!this.onChangeScreen) {\r\n          this.onChangeScreen = () => {\r\n            const width = (this.list.childElementCount * mediaSizes.active.esgSticker.width) + (this.list.childElementCount - 1 * 1);\r\n            this.list.style.width = width + 'px';\r\n          };\r\n          mediaSizes.addEventListener('changeScreen', this.onChangeScreen);\r\n        }\r\n\r\n        this.onChangeScreen();\r\n\r\n        this.toggle(!stickers.length);\r\n        this.scrollable.scrollTop = 0;\r\n      });\r\n    });\r\n  }\r\n\r\n  protected init() {\r\n    this.list = document.createElement('div');\r\n    this.list.classList.add('stickers-helper-stickers', 'super-stickers');\r\n\r\n    this.container.append(this.list);\r\n\r\n    this.scrollable = new Scrollable(this.container);\r\n    this.lazyLoadQueue = new LazyLoadQueue();\r\n    this.superStickerRenderer = new SuperStickerRenderer(this.lazyLoadQueue, CHAT_ANIMATION_GROUP, this.managers);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport { SEND_WHEN_ONLINE_TIMESTAMP } from \"../../lib/mtproto/constants\";\r\nimport Button from \"../button\";\r\nimport PopupDatePicker from \"./datePicker\";\r\n\r\nconst getMinDate = () => {\r\n  const date = new Date();\r\n  //date.setDate(date.getDate() - 1);\r\n  date.setHours(0, 0, 0, 0);\r\n  return date;\r\n};\r\n\r\nconst getMaxDate = () => {\r\n  const date = new Date();\r\n  date.setFullYear(date.getFullYear() + 1);\r\n  date.setDate(date.getDate() - 1);\r\n  return date;\r\n};\r\n\r\nconst checkDate = (date: Date) => {\r\n  return date.getTime() > getMaxDate().getTime() ? new Date() : date;\r\n};\r\n\r\nexport default class PopupSchedule extends PopupDatePicker {\r\n  constructor(initDate: Date, onPick: (timestamp: number) => void, canSendWhenOnline: boolean) {\r\n    super(checkDate(initDate), onPick, {\r\n      noButtons: true,\r\n      noTitle: true,\r\n      closable: true,\r\n      withConfirm: true,\r\n      minDate: getMinDate(),\r\n      maxDate: getMaxDate(),\r\n      withTime: true,\r\n      showOverflowMonths: true,\r\n      confirmShortcutIsSendShortcut: true,\r\n      title: true\r\n    });\r\n\r\n    this.element.classList.add('popup-schedule');\r\n    this.header.append(this.controlsDiv);\r\n    this.title.replaceWith(this.monthTitle);\r\n    this.body.append(this.btnConfirm);\r\n\r\n    if(canSendWhenOnline) {\r\n      const btnSendWhenOnline = Button('btn-primary btn-secondary btn-primary-transparent primary', {text: 'Schedule.SendWhenOnline'});\r\n      this.body.append(btnSendWhenOnline);\r\n\r\n      attachClickEvent(btnSendWhenOnline, () => {\r\n        onPick(SEND_WHEN_ONLINE_TIMESTAMP);\r\n        this.hide();\r\n      });\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nimport { MessageEntity } from \"../../layer\";\r\nimport combineSameEntities from \"../../lib/richTextProcessor/combineSameEntities\";\r\nimport getRichElementValue from \"./getRichElementValue\";\r\n\r\nexport default function getRichValueWithCaret(field: HTMLElement, withEntities = true) {\r\n  const lines: string[] = [];\r\n  const line: string[] = [];\r\n\r\n  const sel = window.getSelection();\r\n  let selNode: Node;\r\n  let selOffset: number;\r\n  if(sel && sel.rangeCount) {\r\n    const range = sel.getRangeAt(0);\r\n    const startOffset = range.startOffset;\r\n    if(\r\n      range.startContainer &&\r\n      range.startContainer == range.endContainer &&\r\n      startOffset == range.endOffset\r\n    ) {\r\n      // * if focused on img, or caret has been set via placeCaretAtEnd\r\n      const possibleChildrenFocusOffset = startOffset - 1;\r\n      const childNodes = field.childNodes;\r\n      if(range.startContainer === field && childNodes[possibleChildrenFocusOffset]) {\r\n        selNode = childNodes[possibleChildrenFocusOffset];\r\n        selOffset = 0;\r\n\r\n        for(let i = 0; i < range.endOffset; ++i) {\r\n          const node = childNodes[i];\r\n          const value = node.nodeValue || (node as HTMLImageElement).alt;\r\n\r\n          if(value) {\r\n            selOffset += value.length;\r\n          }\r\n        }\r\n      } else {\r\n        selNode = range.startContainer;\r\n        selOffset = startOffset;\r\n      }\r\n    }\r\n  }\r\n\r\n  const entities: MessageEntity[] = withEntities ? [] : undefined;\r\n  getRichElementValue(field, lines, line, selNode, selOffset, entities);\r\n\r\n  if(line.length) {\r\n    lines.push(line.join(''));\r\n  }\r\n\r\n  let value = lines.join('\\n');\r\n  const caretPos = value.indexOf('\\x01');\r\n  if(caretPos != -1) {\r\n    value = value.substr(0, caretPos) + value.substr(caretPos + 1);\r\n  }\r\n  value = value.replace(/\\u00A0/g, ' ');\r\n\r\n  if(entities) {\r\n    combineSameEntities(entities);\r\n  }\r\n\r\n  return {value, entities, caretPos};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatInput from \"./input\";\r\nimport { appendEmoji, getEmojiFromElement } from \"../emoticonsDropdown/tabs/emoji\";\r\nimport { ScrollableX } from \"../scrollable\";\r\nimport AutocompleteHelper from \"./autocompleteHelper\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nexport default class EmojiHelper extends AutocompleteHelper {\r\n  private scrollable: ScrollableX;\r\n\r\n  constructor(\r\n    appendTo: HTMLElement, \r\n    controller: AutocompleteHelperController, \r\n    chatInput: ChatInput, \r\n    private managers: AppManagers\r\n  ) {\r\n    super({\r\n      appendTo,\r\n      controller, \r\n      listType: 'x', \r\n      onSelect: (target) => {\r\n        chatInput.onEmojiSelected(getEmojiFromElement(target as any), true);\r\n      }\r\n    });\r\n\r\n    this.container.classList.add('emoji-helper');\r\n  }\r\n\r\n  protected init() {\r\n    this.list = document.createElement('div');\r\n    this.list.classList.add('emoji-helper-emojis', 'super-emojis');\r\n\r\n    this.container.append(this.list);\r\n\r\n    this.scrollable = new ScrollableX(this.container);\r\n\r\n    this.addEventListener('visible', () => {\r\n      setTimeout(() => { // it is not rendered yet\r\n        this.scrollable.container.scrollLeft = 0;\r\n      }, 0);\r\n    });\r\n  }\r\n\r\n  public render(emojis: string[], waitForKey: boolean) {\r\n    if(this.init) {\r\n      if(!emojis.length) {\r\n        return;\r\n      }\r\n\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n    \r\n    emojis = emojis.slice(0, 80);\r\n\r\n    if(emojis.length) {\r\n      this.list.innerHTML = '';\r\n      emojis.forEach((emoji) => {\r\n        appendEmoji(emoji, this.list, false, true);\r\n      });\r\n    }\r\n\r\n    this.waitForKey = waitForKey ? ['ArrowUp', 'ArrowDown'] : undefined;\r\n    this.toggle(!emojis.length);\r\n\r\n    /* window.requestAnimationFrame(() => {\r\n      this.container.style.width = (3 * 2) + (emojis.length * 44) + 'px';\r\n    }); */\r\n  }\r\n\r\n  public checkQuery(query: string, firstChar: string) {\r\n    const middleware = this.controller.getMiddleware();\r\n    this.managers.appEmojiManager.getBothEmojiKeywords().then(async() => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      const q = query.replace(/^:/, '');\r\n      const emojis = await this.managers.appEmojiManager.searchEmojis(q);\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n      \r\n      this.render(emojis, firstChar !== ':');\r\n      //console.log(emojis);\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport AvatarElement from \"../avatar\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport Scrollable from \"../scrollable\";\r\nimport AutocompleteHelper from \"./autocompleteHelper\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\n\r\nexport default class AutocompletePeerHelper extends AutocompleteHelper {\r\n  protected static BASE_CLASS = 'autocomplete-peer-helper';\r\n  protected static BASE_CLASS_LIST_ELEMENT = AutocompletePeerHelper.BASE_CLASS + '-list-element';\r\n  private scrollable: Scrollable;\r\n\r\n  constructor(\r\n    appendTo: HTMLElement, \r\n    controller: AutocompleteHelperController, \r\n    protected className: string, \r\n    onSelect: (target: Element) => boolean | void\r\n  ) {\r\n    super({\r\n      appendTo, \r\n      controller,\r\n      listType: 'y', \r\n      onSelect\r\n    });\r\n\r\n    this.container.classList.add(AutocompletePeerHelper.BASE_CLASS, className);\r\n  }\r\n\r\n  protected init() {\r\n    this.list = document.createElement('div');\r\n    this.list.classList.add(AutocompletePeerHelper.BASE_CLASS + '-list', this.className + '-list');\r\n\r\n    this.container.append(this.list);\r\n\r\n    this.scrollable = new Scrollable(this.container);\r\n\r\n    this.addEventListener('visible', () => {\r\n      setTimeout(() => { // it is not rendered yet\r\n        this.scrollable.container.scrollTop = 0;\r\n      }, 0);\r\n    });\r\n  }\r\n\r\n  public render(data: {peerId: PeerId, name?: string, description?: string}[], doNotShow?: boolean) {\r\n    if(this.init) {\r\n      if(!data.length) {\r\n        return;\r\n      }\r\n\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    if(data.length) {\r\n      this.list.innerHTML = '';\r\n      data.forEach((d) => {\r\n        const div = AutocompletePeerHelper.listElement({\r\n          className: this.className,\r\n          peerId: d.peerId,\r\n          name: d.name,\r\n          description: d.description\r\n        });\r\n\r\n        this.list.append(div);\r\n      });\r\n    }\r\n\r\n    if(!doNotShow) {\r\n      this.toggle(!data.length);\r\n    }\r\n  }\r\n\r\n  public static listElement(options: {\r\n    className: string,\r\n    peerId: PeerId,\r\n    name?: string,\r\n    description?: string\r\n  }) {\r\n    const BASE = AutocompletePeerHelper.BASE_CLASS_LIST_ELEMENT;\r\n    options.className += '-list-element';\r\n\r\n    const div = document.createElement('div');\r\n    div.classList.add(BASE, options.className);\r\n    div.dataset.peerId = '' + options.peerId;\r\n  \r\n    const avatar = new AvatarElement();\r\n    avatar.classList.add('avatar-30', BASE + '-avatar', options.className + '-avatar');\r\n    avatar.updateWithOptions({\r\n      isDialog: false,\r\n      peerId: options.peerId\r\n    });\r\n  \r\n    const name = document.createElement('div');\r\n    name.classList.add(BASE + '-name', options.className + '-name');\r\n    if(!options.name) {\r\n      name.append(new PeerTitle({\r\n        peerId: options.peerId,\r\n        dialog: false,\r\n        onlyFirstName: false,\r\n        plainText: false\r\n      }).element);\r\n    } else {\r\n      setInnerHTML(name, wrapEmojiText(options.name));\r\n    }\r\n  \r\n    div.append(avatar, name);\r\n\r\n    if(options.description) {\r\n      const description = document.createElement('div');\r\n      description.classList.add(BASE + '-description', options.className + '-description');\r\n      setInnerHTML(description, wrapEmojiText(options.description));\r\n      div.append(description);\r\n    }\r\n  \r\n    return div;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatInput from \"./input\";\r\nimport type { BotInfo, ChatFull, UserFull } from \"../../layer\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\nimport AutocompletePeerHelper from \"./autocompletePeerHelper\";\r\nimport SearchIndex from \"../../lib/searchIndex\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nexport function processPeerFullForCommands(peerId: PeerId, full: ChatFull.chatFull | ChatFull.channelFull | UserFull.userFull, query?: string) {\r\n  const botInfos: BotInfo.botInfo[] = [].concat(full.bot_info);\r\n  let index: SearchIndex<string>; \r\n  \r\n  if(query !== undefined) {\r\n    index = new SearchIndex<string>({\r\n      ignoreCase: true\r\n    });\r\n  }\r\n  \r\n  type T = {peerId: PeerId, name: string, description: string, index: number, command: string};\r\n  const commands: Map<string, T> = new Map();\r\n  botInfos.forEach((botInfo) => {\r\n    botInfo.commands.forEach(({command, description}, idx) => {\r\n      const c = '/' + command;\r\n      commands.set(command, {\r\n        peerId: botInfo.user_id ? botInfo.user_id.toPeerId(false) : peerId, \r\n        command: command, \r\n        name: c, \r\n        description: description,\r\n        index: idx\r\n      });\r\n\r\n      if(index) {\r\n        index.indexObject(command, c);\r\n      }\r\n    });\r\n  });\r\n\r\n  let out: T[];\r\n  if(!index) {\r\n    out = [...commands.values()];\r\n  } else {\r\n    const found = index.search(query);\r\n    out = Array.from(found).map((command) => commands.get(command));\r\n  }\r\n\r\n  out = out.sort((a, b) => commands.get(a.command).index - commands.get(b.command).index);\r\n  \r\n  return out;\r\n}\r\n\r\nexport default class CommandsHelper extends AutocompletePeerHelper {\r\n  constructor(\r\n    appendTo: HTMLElement, \r\n    controller: AutocompleteHelperController, \r\n    chatInput: ChatInput, \r\n    private managers: AppManagers\r\n  ) {\r\n    super(appendTo, \r\n      controller,\r\n      'commands-helper',\r\n      (target) => {\r\n        const innerHTML = target.querySelector(`.${AutocompletePeerHelper.BASE_CLASS_LIST_ELEMENT}-name`).innerHTML;\r\n        return chatInput.getReadyToSend(() => {\r\n          chatInput.messageInput.innerHTML = innerHTML;\r\n          chatInput.sendMessage(true);\r\n        });\r\n      }\r\n    );\r\n  }\r\n\r\n  public async checkQuery(query: string, peerId: PeerId) {\r\n    if(!(await this.managers.appUsersManager.isBot(peerId))) {\r\n      return false;\r\n    }\r\n\r\n    const middleware = this.controller.getMiddleware();\r\n    this.managers.appProfileManager.getProfileByPeerId(peerId).then((full) => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      const filtered = processPeerFullForCommands(peerId, full, query);\r\n      this.render(filtered);\r\n      // console.log('found commands', found, filtered);\r\n    });\r\n\r\n    return true;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { getMiddleware } from \"../../helpers/middleware\";\r\nimport AutocompleteHelper from \"./autocompleteHelper\";\r\n\r\nexport default class AutocompleteHelperController {\r\n  private helpers: Set<AutocompleteHelper> = new Set();\r\n  private middleware = getMiddleware();\r\n  /* private tempId = 0;\r\n\r\n  public incrementToggleCount() {\r\n    return ++this.tempId;\r\n  }\r\n\r\n  public getToggleCount() {\r\n    return this.tempId;\r\n  } */\r\n\r\n  public toggleListNavigation(enabled: boolean) {\r\n    for(const helper of this.helpers) {\r\n      helper.toggleListNavigation(enabled);\r\n    }\r\n  }\r\n\r\n  public getMiddleware() {\r\n    this.middleware.clean();\r\n    return this.middleware.get();\r\n  }\r\n\r\n  public addHelper(helper: AutocompleteHelper) {\r\n    this.helpers.add(helper);\r\n  }\r\n\r\n  public hideOtherHelpers(preserveHelper?: AutocompleteHelper) {\r\n    this.helpers.forEach((helper) => {\r\n      if(helper !== preserveHelper) {\r\n        helper.toggle(true, true);\r\n      }\r\n    });\r\n\r\n    if(!preserveHelper) {\r\n      this.middleware.clean();\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatInput from \"./input\";\r\nimport type { MessageEntity } from \"../../layer\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\nimport AutocompletePeerHelper from \"./autocompletePeerHelper\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nexport default class MentionsHelper extends AutocompletePeerHelper {\r\n  constructor(\r\n    appendTo: HTMLElement, \r\n    controller: AutocompleteHelperController, \r\n    chatInput: ChatInput, \r\n    private managers: AppManagers\r\n  ) {\r\n    super(\r\n      appendTo, \r\n      controller,\r\n      'mentions-helper',\r\n      (target) => {\r\n        const userId = (target as HTMLElement).dataset.peerId.toUserId();\r\n        const user = Promise.resolve(managers.appUsersManager.getUser(userId)).then((user) => {\r\n          let str = '', entity: MessageEntity;\r\n          if(user.username) {\r\n            str = '@' + user.username;\r\n          } else {\r\n            str = user.first_name || user.last_name;\r\n            entity = {\r\n              _: 'messageEntityMentionName',\r\n              length: str.length,\r\n              offset: 0,\r\n              user_id: user.id\r\n            };\r\n          }\r\n  \r\n          str += ' ';\r\n          chatInput.insertAtCaret(str, entity);\r\n        });\r\n      }\r\n    );\r\n  }\r\n\r\n  public checkQuery(query: string, peerId: PeerId, topMsgId: number) {\r\n    const trimmed = query.trim(); // check that there is no whitespace\r\n    if(query.length !== trimmed.length) return false;\r\n\r\n    const middleware = this.controller.getMiddleware();\r\n    this.managers.appProfileManager.getMentions(peerId && peerId.toChatId(), trimmed, topMsgId).then(async(peerIds) => {\r\n      if(!middleware()) return;\r\n      \r\n      const username = trimmed.slice(1).toLowerCase();\r\n\r\n      const p = peerIds.map(async(peerId) => {\r\n        const user = await this.managers.appUsersManager.getUser(peerId);\r\n        if(user.username && user.username.toLowerCase() === username) { // hide full matched suggestion\r\n          return;\r\n        }\r\n\r\n        return {\r\n          peerId,\r\n          description: user.username ? '@' + user.username : undefined\r\n        };\r\n      });\r\n\r\n      this.render((await Promise.all(p)).filter(Boolean));\r\n    });\r\n\r\n    return true;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatInput from \"./input\";\r\nimport DropdownHover from \"../../helpers/dropdownHover\";\r\nimport { KeyboardButton, ReplyMarkup } from \"../../layer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport ListenerSetter, { Listener } from \"../../helpers/listenerSetter\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport findUpAsChild from \"../../helpers/dom/findUpAsChild\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { getHeavyAnimationPromise } from \"../../hooks/useHeavyAnimationCheck\";\r\nimport confirmationPopup from \"../confirmationPopup\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\n\r\nexport default class ReplyKeyboard extends DropdownHover {\r\n  private static BASE_CLASS = 'reply-keyboard';\r\n  private appendTo: HTMLElement;\r\n  private listenerSetter: ListenerSetter;\r\n  private managers: AppManagers;\r\n  private btnHover: HTMLElement;\r\n  private peerId: PeerId;\r\n  private touchListener: Listener;\r\n  private chatInput: ChatInput;\r\n\r\n  constructor(options: {\r\n    listenerSetter: ListenerSetter,\r\n    managers: AppManagers,\r\n    appendTo: HTMLElement,\r\n    btnHover: HTMLElement,\r\n    chatInput: ChatInput\r\n  }) {\r\n    super({\r\n      element: document.createElement('div')\r\n    });\r\n\r\n    safeAssign(this, options);\r\n\r\n    this.element.classList.add(ReplyKeyboard.BASE_CLASS);\r\n    this.element.style.display = 'none';\r\n\r\n    this.attachButtonListener(this.btnHover, this.listenerSetter);\r\n    this.listenerSetter.add(rootScope)('history_reply_markup', async({peerId}) => {\r\n      if(this.peerId === peerId) {\r\n        if(this.checkAvailability() && this.isActive()) {\r\n          await this.render();\r\n        }\r\n\r\n        getHeavyAnimationPromise().then(() => {\r\n          this.checkForceReply();\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  protected init() {\r\n    this.appendTo.append(this.element);\r\n\r\n    this.listenerSetter.add(this)('open', async() => {\r\n      await this.render();\r\n\r\n      if(IS_TOUCH_SUPPORTED) {\r\n        this.touchListener = this.listenerSetter.add(document.body)('touchstart', this.onBodyTouchStart, {passive: false, capture: true}) as any as Listener;\r\n        this.listenerSetter.add(this)('close', () => {\r\n          this.listenerSetter.remove(this.touchListener);\r\n        }, {once: true});\r\n      }\r\n    });\r\n    \r\n    attachClickEvent(this.element, (e) => {\r\n      const target = findUpClassName(e.target, 'btn');\r\n      if(!target) {\r\n        return;\r\n      }\r\n\r\n      const type = target.dataset.type as KeyboardButton['_'];\r\n      const {peerId} = this;\r\n      switch(type) {\r\n        case 'keyboardButtonRequestPhone': {\r\n          confirmationPopup({\r\n            titleLangKey: 'ShareYouPhoneNumberTitle',\r\n            button: {\r\n              langKey: 'OK'\r\n            },\r\n            descriptionLangKey: 'AreYouSureShareMyContactInfoBot'\r\n          }).then(() => {\r\n            this.managers.appMessagesManager.sendContact(peerId, rootScope.myId);\r\n          });\r\n          break;\r\n        }\r\n\r\n        default: {\r\n          this.managers.appMessagesManager.sendText(peerId, target.dataset.text);\r\n          break;\r\n        }\r\n      }\r\n\r\n      this.toggle(false);\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    return super.init();\r\n  }\r\n\r\n  private onBodyTouchStart = (e: TouchEvent) => {\r\n    const target = e.touches[0].target as HTMLElement;\r\n    if(!findUpAsChild(target, this.element) && target !== this.btnHover) {\r\n      cancelEvent(e);\r\n      this.toggle(false);\r\n    }\r\n  };\r\n\r\n  public async checkForceReply() {\r\n    const replyMarkup = await this.getReplyMarkup();\r\n    if(replyMarkup._ === 'replyKeyboardForceReply' &&\r\n      !replyMarkup.pFlags.hidden && \r\n      !replyMarkup.pFlags.used) {\r\n      replyMarkup.pFlags.used = true;\r\n      this.chatInput.initMessageReply(replyMarkup.mid);\r\n    }\r\n  }\r\n\r\n  private async getReplyMarkup() {\r\n    return (await this.managers.appMessagesManager.getHistoryStorageTransferable(this.peerId)).replyMarkup ?? {\r\n      _: 'replyKeyboardHide'\r\n    };\r\n  }\r\n\r\n  public async render(replyMarkup?: ReplyMarkup.replyKeyboardMarkup) {\r\n    if(replyMarkup === undefined) {\r\n      replyMarkup = await this.getReplyMarkup() as any;\r\n    }\r\n\r\n    this.element.textContent = '';\r\n\r\n    for(const row of replyMarkup.rows) {\r\n      const div = document.createElement('div');\r\n      div.classList.add(ReplyKeyboard.BASE_CLASS + '-row');\r\n\r\n      for(const button of row.buttons) {\r\n        const btn = document.createElement('button');\r\n        btn.classList.add(ReplyKeyboard.BASE_CLASS + '-button', 'btn');\r\n        setInnerHTML(btn, wrapEmojiText(button.text));\r\n        btn.dataset.text = button.text;\r\n        btn.dataset.type = button._;\r\n        div.append(btn);\r\n      }\r\n\r\n      this.element.append(div);\r\n    }\r\n  }\r\n\r\n  public async checkAvailability(replyMarkup?: ReplyMarkup) {\r\n    if(replyMarkup === undefined) {\r\n      replyMarkup = await this.getReplyMarkup();\r\n    }\r\n\r\n    const hide = replyMarkup._ === 'replyKeyboardHide' || !(replyMarkup as ReplyMarkup.replyInlineMarkup).rows?.length;\r\n    this.btnHover.classList.toggle('hide', hide);\r\n\r\n    if(hide) {\r\n      this.toggle(false);\r\n    }\r\n\r\n    return !hide;\r\n  }\r\n\r\n  public setPeer(peerId: PeerId) {\r\n    this.peerId = peerId;\r\n\r\n    this.checkAvailability();\r\n    this.checkForceReply();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type Chat from \"./chat\";\r\nimport debounce from \"../../helpers/schedulers/debounce\";\r\nimport { WebDocument } from \"../../layer\";\r\nimport { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport LazyLoadQueue from \"../lazyLoadQueue\";\r\nimport Scrollable from \"../scrollable\";\r\nimport { wrapPhoto } from \"../wrappers\";\r\nimport AutocompleteHelper from \"./autocompleteHelper\";\r\nimport AutocompleteHelperController from \"./autocompleteHelperController\";\r\nimport Button from \"../button\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport { MyPhoto } from \"../../lib/appManagers/appPhotosManager\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport GifsMasonry from \"../gifsMasonry\";\r\nimport { SuperStickerRenderer } from \"../emoticonsDropdown/tabs/stickers\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport readBlobAsDataURL from \"../../helpers/blob/readBlobAsDataURL\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport renderImageWithFadeIn from \"../../helpers/dom/renderImageWithFadeIn\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport wrapRichText from \"../../lib/richTextProcessor/wrapRichText\";\r\nimport generateQId from \"../../lib/appManagers/utils/inlineBots/generateQId\";\r\nimport appDownloadManager from \"../../lib/appManagers/appDownloadManager\";\r\n\r\nconst ANIMATION_GROUP = 'INLINE-HELPER';\r\n// const GRID_ITEMS = 5;\r\n\r\nexport default class InlineHelper extends AutocompleteHelper {\r\n  private scrollable: Scrollable;\r\n  private lazyLoadQueue: LazyLoadQueue;\r\n  private gifsMasonry: GifsMasonry;\r\n  private superStickerRenderer: SuperStickerRenderer;\r\n  private onChangeScreen: () => void;\r\n  public checkQuery: (peerId: PeerId, username: string, query: string) => ReturnType<InlineHelper['_checkQuery']>;\r\n\r\n  constructor(\r\n    appendTo: HTMLElement, \r\n    controller: AutocompleteHelperController,\r\n    private chat: Chat,\r\n    private managers: AppManagers\r\n  ) {\r\n    super({\r\n      appendTo, \r\n      controller,\r\n      listType: 'xy', \r\n      waitForKey: ['ArrowUp', 'ArrowDown'],\r\n      onSelect: (target) => {\r\n        if(!target) return false; // can happen when there is only button\r\n        const {peerId, botId, queryId} = this.list.dataset;\r\n        return this.chat.input.getReadyToSend(() => {\r\n          const queryAndResultIds = generateQId(queryId, (target as HTMLElement).dataset.resultId);\r\n          this.managers.appInlineBotsManager.sendInlineResult(peerId.toPeerId(), botId, queryAndResultIds, {\r\n            ...this.chat.getMessageSendingParams(),\r\n            clearDraft: true,\r\n          });\r\n\r\n          this.chat.input.onMessageSent(true, true);\r\n        });\r\n      }\r\n    });\r\n\r\n    this.container.classList.add('inline-helper');\r\n\r\n    this.addEventListener('visible', () => {\r\n      setTimeout(() => { // it is not rendered yet\r\n        this.scrollable.container.scrollTop = 0;\r\n      }, 0); \r\n    });\r\n\r\n    this.checkQuery = debounce(this._checkQuery, 200, true, true);\r\n\r\n    this.addEventListener('hidden', () => {\r\n      if(this.onChangeScreen) {\r\n        mediaSizes.removeEventListener('changeScreen', this.onChangeScreen);\r\n        this.onChangeScreen = undefined;\r\n      }\r\n    });\r\n  }\r\n\r\n  public _checkQuery = async(peerId: PeerId, username: string, query: string) => {\r\n    const middleware = this.controller.getMiddleware();\r\n\r\n    const peer = await this.managers.appUsersManager.resolveUsername(username);\r\n    if(!middleware()) {\r\n      throw 'PEER_CHANGED';\r\n    }\r\n\r\n    if(peer._ !== 'user') {\r\n      throw 'NOT_A_BOT';\r\n    }\r\n\r\n    const renderPromise = this.managers.appInlineBotsManager.getInlineResults(peerId, peer.id, query).then((botResults) => {\r\n      if(!middleware()) {\r\n        throw 'PEER_CHANGED';\r\n      }\r\n\r\n      if(this.init) {\r\n        this.init();\r\n        this.init = null;\r\n      }\r\n\r\n      const list = this.list.cloneNode() as HTMLElement;\r\n      list.dataset.peerId = '' + peerId;\r\n      list.dataset.botId = '' + peer.id;\r\n      list.dataset.queryId = '' + botResults.query_id;\r\n\r\n      const gifsMasonry = new GifsMasonry(null, ANIMATION_GROUP, this.scrollable, false);\r\n\r\n      this.lazyLoadQueue.clear();\r\n      this.superStickerRenderer.clear();\r\n      \r\n      const loadPromises: Promise<any>[] = [];\r\n      const isGallery = !!botResults.pFlags.gallery;\r\n      // botResults.results.length = 3;\r\n      for(const item of botResults.results) {\r\n        const container = document.createElement('div');\r\n        container.classList.add('inline-helper-result');\r\n        container.dataset.resultId = item.id;\r\n  \r\n        const preview = isGallery ? undefined : document.createElement('div');\r\n        if(preview) {\r\n          preview.classList.add('inline-helper-result-preview');\r\n\r\n          container.append(preview);\r\n        }\r\n\r\n        list.append(container);\r\n\r\n        if(!isGallery) {\r\n          preview.classList.add('empty');\r\n          setInnerHTML(preview, wrapEmojiText([...item.title.trim()][0]));\r\n\r\n          const title = document.createElement('div');\r\n          title.classList.add('inline-helper-result-title');\r\n          setInnerHTML(title, wrapEmojiText(item.title));\r\n    \r\n          const description = document.createElement('div');\r\n          description.classList.add('inline-helper-result-description');\r\n          setInnerHTML(description, wrapRichText(item.description, {\r\n            noCommands: true,\r\n            noLinks: true\r\n          }));\r\n    \r\n          container.append(title, description);\r\n  \r\n          const separator = document.createElement('div');\r\n          separator.classList.add('inline-helper-separator');\r\n    \r\n          list.append(separator);\r\n        } else {\r\n          container.classList.add('grid-item');\r\n        }\r\n        \r\n        if(item._ === 'botInlineResult') {\r\n          if(item.thumb && item.thumb.mime_type.indexOf('image/') === 0) {\r\n            let mediaContainer: HTMLElement;\r\n            if(preview) {\r\n              mediaContainer = document.createElement('div');\r\n              preview.append(mediaContainer);\r\n            } else {\r\n              mediaContainer = container;\r\n            }\r\n\r\n            mediaContainer.classList.add('media-container'); \r\n            isGallery && mediaContainer.classList.add('no-border-radius');\r\n\r\n            this.lazyLoadQueue.push({\r\n              div: container,\r\n              load: () => {\r\n                return appDownloadManager.download({\r\n                  dcId: 4,\r\n                  location: {\r\n                    _: 'inputWebFileLocation',\r\n                    access_hash: (item.thumb as WebDocument.webDocument).access_hash,\r\n                    url: item.thumb.url\r\n                  },\r\n                  size: item.thumb.size,\r\n                  mimeType: item.thumb.mime_type\r\n                }).then((blob) => {\r\n                  const image = new Image();\r\n                  image.classList.add('media-photo');\r\n                  readBlobAsDataURL(blob).then((dataURL) => {\r\n                    renderImageWithFadeIn(mediaContainer, image, dataURL, true);\r\n                  });\r\n                });\r\n              }\r\n            });\r\n          }\r\n        } else {\r\n          const media = item.document as MyDocument || item.photo as MyPhoto;\r\n          if((['sticker', 'gif'] as MyDocument['type'][]).includes((media as MyDocument)?.type) && isGallery) {\r\n            assumeType<MyDocument>(media);\r\n\r\n            if(media.type === 'gif') {\r\n              gifsMasonry.add(media, container);\r\n            } else if(media.type === 'sticker') {\r\n              container.classList.add('super-sticker');\r\n              this.superStickerRenderer.renderSticker(media, container, loadPromises);\r\n              if(media.animated) {\r\n                this.superStickerRenderer.observeAnimated(container);\r\n              }\r\n            }\r\n          } else if(media) {\r\n            const size = isGallery ? 48 : undefined;\r\n            isGallery && container.classList.add('no-border-radius');\r\n            wrapPhoto({\r\n              photo: media,\r\n              container: isGallery ? container : preview,\r\n              boxWidth: size,\r\n              boxHeight: size,\r\n              middleware,\r\n              lazyLoadQueue: this.lazyLoadQueue,\r\n              loadPromises\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      return Promise.all(loadPromises).then(() => {\r\n        if(!middleware()) {\r\n          gifsMasonry.clear();\r\n          return;\r\n        }\r\n\r\n        list.classList.toggle('is-gallery', isGallery);\r\n        list.classList.toggle('super-stickers', isGallery);\r\n        this.container.classList.toggle('is-gallery', isGallery);\r\n\r\n        /* if(isGallery) {\r\n          list.style.gridTemplateColumns = `repeat(${Math.min(botResults.results.length, 4)}, 1fr)`;\r\n        }\r\n\r\n        this.container.style.setProperty('width', isGallery ? `${Math.min(botResults.results.length, 4) * 25}%` : '', 'important'); */\r\n\r\n        const parent = this.list.parentElement;\r\n        parent.textContent = '';\r\n        if(botResults.switch_pm) {\r\n          const btnSwitchToPM = Button('btn-primary btn-secondary btn-primary-transparent primary');\r\n          setInnerHTML(btnSwitchToPM, wrapEmojiText(botResults.switch_pm.text));\r\n          attachClickEvent(btnSwitchToPM, (e) => {\r\n            this.chat.appImManager.setInnerPeer({peerId});\r\n            this.managers.appInlineBotsManager.switchToPM(peerId, peer.id, botResults.switch_pm.start_param);\r\n          });\r\n          parent.append(btnSwitchToPM);\r\n        }\r\n        parent.append(this.list = list);\r\n\r\n        if(this.gifsMasonry) {\r\n          this.gifsMasonry.detach();\r\n        }\r\n        this.gifsMasonry = gifsMasonry;\r\n        gifsMasonry.attach();\r\n\r\n        if(!this.onChangeScreen) {\r\n          this.onChangeScreen = () => {\r\n            if(this.list.classList.contains('is-gallery')) {\r\n              const width = (this.list.childElementCount * mediaSizes.active.esgSticker.width) + (this.list.childElementCount - 1 * 1);\r\n              this.list.style.width = width + 'px';\r\n            } else {\r\n              this.list.style.width = '';\r\n            }\r\n          };\r\n          mediaSizes.addEventListener('changeScreen', this.onChangeScreen);\r\n        }\r\n\r\n        this.onChangeScreen();\r\n  \r\n        this.toggle(!botResults.results.length && !botResults.switch_pm);\r\n        this.scrollable.scrollTop = 0;\r\n      });\r\n    });\r\n\r\n    return {user: peer, renderPromise};\r\n  };\r\n\r\n  protected init() {\r\n    this.list = document.createElement('div');\r\n    this.list.classList.add('inline-helper-results');\r\n\r\n    this.container.append(this.list);\r\n\r\n    this.scrollable = new Scrollable(this.container);\r\n    this.lazyLoadQueue = new LazyLoadQueue();\r\n    this.superStickerRenderer = new SuperStickerRenderer(this.lazyLoadQueue, ANIMATION_GROUP, this.managers);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatInput from \"./input\";\r\nimport callbackify from \"../../helpers/callbackify\";\r\nimport AutocompletePeerHelper from \"./autocompletePeerHelper\";\r\nimport { processPeerFullForCommands } from \"./commandsHelper\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nconst CLASS_NAME = 'bot-commands';\r\nexport default class ChatBotCommands extends AutocompletePeerHelper {\r\n  private userId: UserId;\r\n\r\n  constructor(\r\n    appendTo: HTMLElement,\r\n    chatInput: ChatInput,\r\n    private managers: AppManagers\r\n  ) {\r\n    super(appendTo, undefined, CLASS_NAME, (target) => {\r\n      const innerHTML = target.querySelector(`.${AutocompletePeerHelper.BASE_CLASS_LIST_ELEMENT}-name`).innerHTML;\r\n      return chatInput.getReadyToSend(() => {\r\n        chatInput.messageInput.innerHTML = innerHTML;\r\n        chatInput.sendMessage(true);\r\n        this.toggle(true);\r\n      });\r\n    });\r\n  }\r\n\r\n  public setUserId(userId: UserId, middleware: () => boolean) {\r\n    if(this.userId === userId && this.list?.childElementCount) {\r\n      this.toggle(false);\r\n      return;\r\n    }\r\n\r\n    this.userId = userId;\r\n    return callbackify(this.managers.appProfileManager.getProfile(userId), (full) => {\r\n      if(!middleware()) return;\r\n      const filtered = processPeerFullForCommands(userId.toPeerId(false), full);\r\n      \r\n      const PADDING_TOP = 8;\r\n      // const PADDING_BOTTOM = 8;\r\n      const PADDING_BOTTOM = 24;\r\n      const height = filtered.length * 50 + PADDING_TOP + PADDING_BOTTOM;\r\n      this.container.style.setProperty('--height', height + 'px');\r\n\r\n      this.render(filtered);\r\n      \r\n      // this.container.style.top = \r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { AckedResult } from \"../lib/mtproto/superMessagePort\";\r\nimport { Modify } from \"../types\";\r\n\r\nexport default async function modifyAckedResult<T>(acked: AckedResult<T>): Promise<Modify<AckedResult<T>, {result: T | Promise<T>}>> {\r\n  return {\r\n    cached: acked.cached,\r\n    result: acked.cached ? await acked.result : acked.result\r\n  };\r\n}\r\n\r\nexport function modifyAckedPromise<T>(promise: Promise<AckedResult<T>>) {\r\n  return promise.then(modifyAckedResult);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport callbackify from \"../../helpers/callbackify\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport { getMiddleware } from \"../../helpers/middleware\";\r\nimport { modifyAckedPromise } from \"../../helpers/modifyAckedResult\";\r\nimport { ChatFull } from \"../../layer\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport { AckedResult } from \"../../lib/mtproto/superMessagePort\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport AvatarElement from \"../avatar\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"../buttonMenu\";\r\nimport ButtonMenuToggle from \"../buttonMenuToggle\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport getChatMembersString from \"../wrappers/getChatMembersString\";\r\n\r\nconst SEND_AS_ANIMATION_DURATION = 300;\r\n\r\nexport default class ChatSendAs {\r\n  private avatar: AvatarElement;\r\n  private container: HTMLElement;\r\n  private closeBtn: HTMLElement;\r\n  private btnMenu: HTMLElement;\r\n  private sendAsPeerIds: PeerId[];\r\n  private sendAsPeerId: PeerId;\r\n  private updatingPromise: ReturnType<ChatSendAs['updateManual']>;\r\n  private middleware: ReturnType<typeof getMiddleware>;\r\n  private listenerSetter: ListenerSetter;\r\n  private peerId: PeerId;\r\n  private addedListener: boolean;\r\n\r\n  constructor(\r\n    private managers: AppManagers,\r\n    private onReady: (container: HTMLElement, skipAnimation?: boolean) => void,\r\n    private onChange: (sendAsPeerId: PeerId) => void\r\n  ) {\r\n    this.middleware = getMiddleware();\r\n    this.listenerSetter = new ListenerSetter();\r\n    this.construct();\r\n  }\r\n  \r\n  private construct() {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('new-message-send-as-container');\r\n\r\n    this.closeBtn = document.createElement('div');\r\n    this.closeBtn.classList.add('new-message-send-as-close', 'new-message-send-as-avatar', 'tgico-close');\r\n\r\n    const sendAsButtons: ButtonMenuItemOptions[] = [{\r\n      text: 'SendMessageAsTitle',\r\n      onClick: undefined\r\n    }];\r\n\r\n    let previousAvatar: HTMLElement;\r\n    const onSendAsMenuToggle = (visible: boolean) => {\r\n      if(visible) {\r\n        previousAvatar = this.avatar;\r\n      }\r\n\r\n      const isChanged = this.avatar !== previousAvatar;\r\n      const useRafs = !visible && isChanged ? 2 : 0;\r\n\r\n      SetTransition(this.closeBtn, 'is-visible', visible, SEND_AS_ANIMATION_DURATION, undefined, useRafs);\r\n      if(!isChanged) {\r\n        SetTransition(previousAvatar, 'is-visible', !visible, SEND_AS_ANIMATION_DURATION, undefined, useRafs);\r\n      }\r\n    };\r\n\r\n    ButtonMenuToggle({\r\n      noRipple: true, \r\n      listenerSetter: this.listenerSetter, \r\n      container: this.container\r\n    }, 'top-right', sendAsButtons, () => {\r\n      onSendAsMenuToggle(true);\r\n    }, () => {\r\n      onSendAsMenuToggle(false);\r\n    });\r\n\r\n    sendAsButtons[0].element.classList.add('btn-menu-item-header');\r\n    this.btnMenu = this.container.firstElementChild as any;\r\n    this.btnMenu.classList.add('scrollable', 'scrollable-y');\r\n    this.container.append(this.closeBtn);\r\n  }\r\n\r\n  private async updateButtons(peerIds: PeerId[]) {\r\n    const promises: Promise<ButtonMenuItemOptions>[] = peerIds.map(async(sendAsPeerId, idx) => {\r\n      const textElement = document.createElement('div');\r\n\r\n      const subtitle = document.createElement('div');\r\n      subtitle.classList.add('btn-menu-item-subtitle');\r\n      if(sendAsPeerId.isUser()) {\r\n        subtitle.append(i18n('Chat.SendAs.PersonalAccount'));\r\n      } else if(sendAsPeerId === this.peerId) {\r\n        subtitle.append(i18n('VoiceChat.DiscussionGroup'));\r\n      } else {\r\n        subtitle.append(await getChatMembersString(sendAsPeerId.toChatId()));\r\n      }\r\n\r\n      textElement.append(\r\n        new PeerTitle({peerId: sendAsPeerId}).element,\r\n        subtitle\r\n      );\r\n\r\n      return {\r\n        onClick: idx ? async() => {\r\n          const currentPeerId = this.peerId;\r\n          this.changeSendAsPeerId(sendAsPeerId);\r\n\r\n          const middleware = this.middleware.get();\r\n          const executeButtonsUpdate = () => {\r\n            if(this.sendAsPeerId !== sendAsPeerId || !middleware()) return;\r\n            const peerIds = this.sendAsPeerIds.slice();\r\n            indexOfAndSplice(peerIds, sendAsPeerId);\r\n            peerIds.unshift(sendAsPeerId);\r\n            this.updateButtons(peerIds);\r\n          };\r\n          \r\n          if(rootScope.settings.animationsEnabled) {\r\n            setTimeout(executeButtonsUpdate, 250);\r\n          } else {\r\n            executeButtonsUpdate();\r\n          }\r\n\r\n          // return;\r\n          this.managers.appMessagesManager.saveDefaultSendAs(currentPeerId, sendAsPeerId);\r\n        } : undefined,\r\n        textElement\r\n      };\r\n    });\r\n\r\n    const buttons = await Promise.all(promises);\r\n    const btnMenu = ButtonMenu(buttons/* , this.listenerSetter */);\r\n    buttons.forEach((button, idx) => {\r\n      const peerId = peerIds[idx];\r\n      const avatar = new AvatarElement();\r\n      avatar.classList.add('avatar-26', 'btn-menu-item-icon');\r\n      avatar.updateWithOptions({peerId});\r\n\r\n      if(!idx) {\r\n        avatar.classList.add('active');\r\n      }\r\n      \r\n      button.element.prepend(avatar);\r\n    });\r\n\r\n    Array.from(this.btnMenu.children).slice(1).forEach((node) => node.remove());\r\n    this.btnMenu.append(...Array.from(btnMenu.children));\r\n  }\r\n\r\n  private async updateAvatar(sendAsPeerId: PeerId, skipAnimation?: boolean) {\r\n    const previousAvatar = this.avatar;\r\n    if(previousAvatar) {\r\n      if(previousAvatar.peerId === sendAsPeerId) {\r\n        return;\r\n      }\r\n    }\r\n    \r\n    if(!previousAvatar) {\r\n      skipAnimation = true;\r\n    }\r\n    \r\n    let useRafs = skipAnimation ? 0 : 2;\r\n    const duration = skipAnimation ? 0 : SEND_AS_ANIMATION_DURATION;\r\n    const avatar = this.avatar = new AvatarElement();\r\n    avatar.classList.add('new-message-send-as-avatar', 'avatar-30');\r\n    await avatar.updateWithOptions({\r\n      isDialog: false,\r\n      peerId: sendAsPeerId\r\n    });\r\n\r\n    SetTransition(avatar, 'is-visible', true, duration, undefined, useRafs);    \r\n    if(previousAvatar) {\r\n      SetTransition(previousAvatar, 'is-visible', false, duration, () => {\r\n        previousAvatar.remove();\r\n      }, useRafs);\r\n    }\r\n    \r\n    this.container.append(avatar);\r\n  }\r\n\r\n  private changeSendAsPeerId(sendAsPeerId: PeerId, skipAnimation?: boolean) {\r\n    this.sendAsPeerId = sendAsPeerId;\r\n    this.onChange(sendAsPeerId);\r\n    return this.updateAvatar(sendAsPeerId, skipAnimation);\r\n  }\r\n\r\n  private getDefaultSendAs(): Promise<AckedResult<PeerId>> {\r\n    // return rootScope.myId;\r\n    return this.managers.acknowledged.appProfileManager.getChannelFull(this.peerId.toChatId()).then((acked) => {\r\n      return {\r\n        cached: acked.cached,\r\n        result: acked.result.then((channelFull) => {\r\n          return channelFull.default_send_as ? getPeerId(channelFull.default_send_as) : undefined\r\n        })\r\n      };\r\n    });\r\n  }\r\n  \r\n  public async updateManual(skipAnimation?: boolean): Promise<() => void> {\r\n    const peerId = this.peerId;\r\n    if(this.updatingPromise || !(await this.managers.appPeersManager.isChannel(peerId))) {\r\n      return;\r\n    }\r\n\r\n    const middleware = this.middleware.get(() => {\r\n      return !this.updatingPromise || this.updatingPromise === updatingPromise;\r\n    });\r\n\r\n    const {container} = this;\r\n    const chatId = peerId.toChatId();\r\n    const result = (await modifyAckedPromise(this.getDefaultSendAs())).result;\r\n    // const result = Promise.resolve(this.getDefaultSendAs());\r\n\r\n    const wasSkippingAnimation = skipAnimation;\r\n    if(result instanceof Promise) {\r\n      skipAnimation = undefined;\r\n    }\r\n\r\n    const auto = wasSkippingAnimation && !skipAnimation;\r\n\r\n    const updatingPromise = this.updatingPromise = callbackify(result, async(sendAsPeerId) => {\r\n      if(!middleware() || sendAsPeerId === undefined) return;\r\n      \r\n      await this.changeSendAsPeerId(sendAsPeerId, skipAnimation);\r\n      if(!middleware()) return;\r\n\r\n      this.managers.appChatsManager.getSendAs(chatId).then((peers) => {\r\n        if(!middleware()) return;\r\n\r\n        const peerIds = peers.map((peer) => getPeerId(peer));\r\n        this.sendAsPeerIds = peerIds.slice();\r\n\r\n        indexOfAndSplice(peerIds, sendAsPeerId);\r\n        peerIds.unshift(sendAsPeerId);\r\n        this.updateButtons(peerIds);\r\n      });\r\n\r\n      const callback = () => {\r\n        this.onReady(container, skipAnimation);\r\n\r\n        if(!this.addedListener) {\r\n          this.listenerSetter.add(rootScope)('peer_full_update', (peerId) => {\r\n            if(this.peerId === peerId) {\r\n              this.update();\r\n            }\r\n          });\r\n\r\n          this.addedListener = true;\r\n        }\r\n      };\r\n\r\n      if(auto) {\r\n        callback();\r\n        return;\r\n      }\r\n\r\n      return callback;\r\n    });\r\n\r\n    updatingPromise.finally(() => {\r\n      if(this.updatingPromise === updatingPromise) {\r\n        this.updatingPromise = undefined;\r\n      }\r\n    });\r\n\r\n    if(!auto) {\r\n      return updatingPromise;\r\n    }\r\n  }\r\n\r\n  public update(skipAnimation?: boolean) {\r\n    return this.updateManual(skipAnimation).then((callback) => callback && callback());\r\n  }\r\n\r\n  public setPeerId(peerId?: PeerId) {\r\n    /* if(this.avatar) {\r\n      this.avatar.remove();\r\n      this.avatar = undefined;\r\n    } */\r\n\r\n    this.middleware.clean();\r\n    this.updatingPromise = undefined;\r\n    this.peerId = peerId;\r\n  }\r\n\r\n  public destroy() {\r\n    this.container.remove();\r\n    this.setPeerId();\r\n    this.listenerSetter.removeAll();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { _i18n } from \"../lib/langPack\";\r\nimport InputField, { InputFieldOptions } from \"./inputField\";\r\nimport SetTransition from \"./singleTransition\";\r\n\r\nexport default class InputFieldAnimated extends InputField {\r\n  public inputFake: HTMLElement;\r\n\r\n  //public onLengthChange: (length: number, isOverflow: boolean) => void;\r\n  // protected wasInputFakeClientHeight: number;\r\n  // protected showScrollDebounced: () => void;\r\n\r\n  constructor(options?: InputFieldOptions) {\r\n    super(options);\r\n\r\n    this.input.addEventListener('input', () => {\r\n      this.inputFake.innerHTML = this.input.innerHTML;\r\n      this.onFakeInput();\r\n    });\r\n\r\n    if(options.placeholder) {\r\n      _i18n(this.inputFake, options.placeholder, undefined, 'placeholder');\r\n    }\r\n\r\n    this.input.classList.add('scrollable', 'scrollable-y');\r\n    // this.wasInputFakeClientHeight = 0;\r\n    // this.showScrollDebounced = debounce(() => this.input.classList.remove('no-scrollbar'), 150, false, true);\r\n    this.inputFake = document.createElement('div');\r\n    this.inputFake.setAttribute('contenteditable', 'true');\r\n    this.inputFake.className = this.input.className + ' input-field-input-fake';\r\n  }\r\n\r\n  public onFakeInput(setHeight = true) {\r\n    const {scrollHeight: newHeight/* , clientHeight */} = this.inputFake;\r\n    /* if(this.wasInputFakeClientHeight && this.wasInputFakeClientHeight !== clientHeight) {\r\n      this.input.classList.add('no-scrollbar'); // !         ,      reflow   overflow.\r\n      this.showScrollDebounced();\r\n    } */\r\n\r\n    const currentHeight = +this.input.style.height.replace('px', '');\r\n    if(currentHeight === newHeight) {\r\n      return;\r\n    }\r\n\r\n    const TRANSITION_DURATION_FACTOR = 50;\r\n    const transitionDuration = Math.round(\r\n      TRANSITION_DURATION_FACTOR * Math.log(Math.abs(newHeight - currentHeight)),\r\n    );\r\n\r\n    // this.wasInputFakeClientHeight = clientHeight;\r\n    this.input.style.transitionDuration = `${transitionDuration}ms`;\r\n\r\n    if(setHeight) {\r\n      this.input.style.height = newHeight ? newHeight + 'px' : '';\r\n    }\r\n\r\n    const className = 'is-changing-height';\r\n    SetTransition(this.input, className, true, transitionDuration, () => {\r\n      this.input.classList.remove(className);\r\n    });\r\n  }\r\n\r\n  public setValueSilently(value: string, fromSet?: boolean) {\r\n    super.setValueSilently(value, fromSet);\r\n\r\n    this.inputFake.innerHTML = value;\r\n    if(!fromSet) {\r\n      this.onFakeInput();\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDocument } from \"../../lib/appManagers/appDocsManager\";\r\nimport type { AppImManager } from '../../lib/appManagers/appImManager';\r\nimport type { MyDraftMessage } from '../../lib/appManagers/appDraftsManager';\r\nimport type Chat from './chat';\r\nimport Recorder from '../../../public/recorder.min';\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\n//import Recorder from '../opus-recorder/dist/recorder.min';\r\nimport opusDecodeController from \"../../lib/opusDecodeController\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from '../buttonMenu';\r\nimport emoticonsDropdown from \"../emoticonsDropdown\";\r\nimport PopupCreatePoll from \"../popups/createPoll\";\r\nimport PopupForward from '../popups/forward';\r\nimport PopupNewMedia from '../popups/newMedia';\r\nimport { toast } from \"../toast\";\r\nimport { wrapReply } from \"../wrappers\";\r\nimport InputField from '../inputField';\r\nimport { MessageEntity, DraftMessage, WebPage, Message, ChatFull, UserFull } from '../../layer';\r\nimport StickersHelper from './stickersHelper';\r\nimport ButtonIcon from '../buttonIcon';\r\nimport ButtonMenuToggle from '../buttonMenuToggle';\r\nimport ListenerSetter, { Listener } from '../../helpers/listenerSetter';\r\nimport Button from '../button';\r\nimport PopupSchedule from '../popups/schedule';\r\nimport SendMenu from './sendContextMenu';\r\nimport rootScope from '../../lib/rootScope';\r\nimport PopupPinMessage from '../popups/unpinMessage';\r\nimport tsNow from '../../helpers/tsNow';\r\nimport appNavigationController, { NavigationItem } from '../appNavigationController';\r\nimport { IS_MOBILE, IS_MOBILE_SAFARI } from '../../environment/userAgent';\r\nimport I18n, { i18n, join, LangPackKey } from '../../lib/langPack';\r\nimport { generateTail } from './bubbles';\r\nimport findUpClassName from '../../helpers/dom/findUpClassName';\r\nimport ButtonCorner from '../buttonCorner';\r\nimport blurActiveElement from '../../helpers/dom/blurActiveElement';\r\nimport cancelEvent from '../../helpers/dom/cancelEvent';\r\nimport cancelSelection from '../../helpers/dom/cancelSelection';\r\nimport { attachClickEvent, simulateClickEvent } from '../../helpers/dom/clickEvent';\r\nimport getRichValue from '../../helpers/dom/getRichValue';\r\nimport isInputEmpty from '../../helpers/dom/isInputEmpty';\r\nimport isSendShortcutPressed from '../../helpers/dom/isSendShortcutPressed';\r\nimport placeCaretAtEnd from '../../helpers/dom/placeCaretAtEnd';\r\nimport { MarkdownType, markdownTags } from '../../helpers/dom/getRichElementValue';\r\nimport getRichValueWithCaret from '../../helpers/dom/getRichValueWithCaret';\r\nimport EmojiHelper from './emojiHelper';\r\nimport CommandsHelper from './commandsHelper';\r\nimport AutocompleteHelperController from './autocompleteHelperController';\r\nimport AutocompleteHelper from './autocompleteHelper';\r\nimport MentionsHelper from './mentionsHelper';\r\nimport fixSafariStickyInput from '../../helpers/dom/fixSafariStickyInput';\r\nimport ReplyKeyboard from './replyKeyboard';\r\nimport InlineHelper from './inlineHelper';\r\nimport debounce from '../../helpers/schedulers/debounce';\r\nimport noop from '../../helpers/noop';\r\nimport { putPreloader } from '../putPreloader';\r\nimport SetTransition from '../singleTransition';\r\nimport PeerTitle from '../peerTitle';\r\nimport { fastRaf } from '../../helpers/schedulers';\r\nimport PopupDeleteMessages from '../popups/deleteMessages';\r\nimport fixSafariStickyInputFocusing, { IS_STICKY_INPUT_BUGGED } from '../../helpers/dom/fixSafariStickyInputFocusing';\r\nimport PopupPeer from '../popups/peer';\r\nimport MEDIA_MIME_TYPES_SUPPORTED from '../../environment/mediaMimeTypesSupport';\r\nimport appMediaPlaybackController from '../appMediaPlaybackController';\r\nimport { BOT_START_PARAM, NULL_PEER_ID } from '../../lib/mtproto/mtproto_config';\r\nimport setCaretAt from '../../helpers/dom/setCaretAt';\r\nimport CheckboxField from '../checkboxField';\r\nimport DropdownHover from '../../helpers/dropdownHover';\r\nimport RadioForm from '../radioForm';\r\nimport findUpTag from '../../helpers/dom/findUpTag';\r\nimport toggleDisability from '../../helpers/dom/toggleDisability';\r\nimport callbackify from '../../helpers/callbackify';\r\nimport ChatBotCommands from './botCommands';\r\nimport copy from '../../helpers/object/copy';\r\nimport toHHMMSS from '../../helpers/string/toHHMMSS';\r\nimport documentFragmentToHTML from '../../helpers/dom/documentFragmentToHTML';\r\nimport PopupElement from '../popups';\r\nimport getEmojiEntityFromEmoji from '../../lib/richTextProcessor/getEmojiEntityFromEmoji';\r\nimport mergeEntities from '../../lib/richTextProcessor/mergeEntities';\r\nimport parseEntities from '../../lib/richTextProcessor/parseEntities';\r\nimport parseMarkdown from '../../lib/richTextProcessor/parseMarkdown';\r\nimport wrapDraftText from '../../lib/richTextProcessor/wrapDraftText';\r\nimport wrapDraft from '../wrappers/draft';\r\nimport wrapMessageForReply from '../wrappers/messageForReply';\r\nimport getServerMessageId from '../../lib/appManagers/utils/messageId/getServerMessageId';\r\nimport { AppManagers } from '../../lib/appManagers/managers';\r\nimport contextMenuController from \"../../helpers/contextMenuController\";\r\nimport { emojiFromCodePoints } from \"../../vendor/emoji\";\r\nimport { modifyAckedPromise } from \"../../helpers/modifyAckedResult\";\r\nimport ChatSendAs from \"./sendAs\";\r\nimport filterAsync from \"../../helpers/array/filterAsync\";\r\nimport InputFieldAnimated from \"../inputFieldAnimated\";\r\n\r\nconst RECORD_MIN_TIME = 500;\r\nconst POSTING_MEDIA_NOT_ALLOWED = 'Posting media content isn\\'t allowed in this group.';\r\n\r\ntype ChatInputHelperType = 'edit' | 'webpage' | 'forward' | 'reply';\r\n\r\nexport default class ChatInput {\r\n  // private static AUTO_COMPLETE_REG_EXP = /(\\s|^)((?::|.)(?!.*[:@]).*|(?:[@\\/]\\S*))$/;\r\n  private static AUTO_COMPLETE_REG_EXP = /(\\s|^)((?:(?:@|^\\/)\\S*)|(?::|^[^:@\\/])(?!.*[:@\\/]).*)$/;\r\n  public messageInput: HTMLElement;\r\n  public messageInputField: InputFieldAnimated;\r\n  private fileInput: HTMLInputElement;\r\n  private inputMessageContainer: HTMLDivElement;\r\n  private btnSend: HTMLButtonElement;\r\n  private btnCancelRecord: HTMLButtonElement;\r\n  private lastUrl = '';\r\n  private lastTimeType = 0;\r\n\r\n  public chatInput: HTMLElement;\r\n  public inputContainer: HTMLElement;\r\n  public rowsWrapper: HTMLDivElement;\r\n  private newMessageWrapper: HTMLDivElement;\r\n  private btnToggleEmoticons: HTMLButtonElement;\r\n  private btnToggleReplyMarkup: HTMLButtonElement;\r\n  private btnSendContainer: HTMLDivElement;\r\n\r\n  private replyKeyboard: ReplyKeyboard;\r\n\r\n  private attachMenu: HTMLElement;\r\n  private attachMenuButtons: (ButtonMenuItemOptions & {verify: (peerId: PeerId, threadId: number) => boolean | Promise<boolean>})[];\r\n\r\n  private sendMenu: SendMenu;\r\n\r\n  private replyElements: {\r\n    container: HTMLElement,\r\n    cancelBtn: HTMLButtonElement,\r\n    iconBtn: HTMLButtonElement\r\n  } = {} as any;\r\n\r\n  private forwardElements: {\r\n    changePeer: ButtonMenuItemOptions,\r\n    showSender: ButtonMenuItemOptions,\r\n    hideSender: ButtonMenuItemOptions,\r\n    showCaption: ButtonMenuItemOptions,\r\n    hideCaption: ButtonMenuItemOptions,\r\n    container: HTMLElement,\r\n    modifyArgs?: ButtonMenuItemOptions[]\r\n  };  \r\n  private forwardHover: DropdownHover;\r\n  private forwardWasDroppingAuthor: boolean;\r\n\r\n  private getWebPagePromise: Promise<void>;\r\n  private willSendWebPage: WebPage = null;\r\n  private forwarding: {[fromPeerId: PeerId]: number[]};\r\n  public replyToMsgId: number;\r\n  public editMsgId: number;\r\n  public editMessage: Message.message;\r\n  private noWebPage: true;\r\n  public scheduleDate: number;\r\n  public sendSilent: true;\r\n  public startParam: string;\r\n\r\n  private recorder: any;\r\n  public recording = false;\r\n  private recordCanceled = false;\r\n  private recordTimeEl: HTMLElement;\r\n  private recordRippleEl: HTMLElement;\r\n  private recordStartTime = 0;\r\n  private recordingOverlayListener: Listener;\r\n  private recordingNavigationItem: NavigationItem;\r\n\r\n  // private scrollTop = 0;\r\n  // private scrollOffsetTop = 0;\r\n  // private scrollDiff = 0;\r\n\r\n  public helperType: Exclude<ChatInputHelperType, 'webpage'>;\r\n  private helperFunc: () => void | Promise<void>;\r\n  private helperWaitingForward: boolean;\r\n\r\n  public willAttachType: 'document' | 'media';\r\n\r\n  private lockRedo = false;\r\n  private canRedoFromHTML = '';\r\n  private readonly undoHistory: string[] = [];\r\n  private readonly executedHistory: string[] = [];\r\n  private canUndoFromHTML = '';\r\n\r\n  private autocompleteHelperController: AutocompleteHelperController;\r\n  private stickersHelper: StickersHelper;\r\n  private emojiHelper: EmojiHelper;\r\n  private commandsHelper: CommandsHelper;\r\n  private mentionsHelper: MentionsHelper;\r\n  private inlineHelper: InlineHelper;\r\n  private listenerSetter: ListenerSetter;\r\n\r\n  private pinnedControlBtn: HTMLButtonElement;\r\n\r\n  private goDownBtn: HTMLButtonElement;\r\n  private goDownUnreadBadge: HTMLElement;\r\n  private goMentionBtn: HTMLButtonElement;\r\n  private goMentionUnreadBadge: HTMLSpanElement;\r\n  private btnScheduled: HTMLButtonElement;\r\n\r\n  private btnPreloader: HTMLButtonElement;\r\n\r\n  private saveDraftDebounced: () => void;\r\n\r\n  private fakeRowsWrapper: HTMLDivElement;\r\n\r\n  private previousQuery: string;\r\n  \r\n  private releaseMediaPlayback: () => void;\r\n\r\n  private botStartBtn: HTMLButtonElement;\r\n  private rowsWrapperWrapper: HTMLDivElement;\r\n  private controlContainer: HTMLElement;\r\n  private fakeSelectionWrapper: HTMLDivElement;\r\n\r\n  private fakeWrapperTo: HTMLElement;\r\n  private toggleBotStartBtnDisability: () => void;\r\n\r\n  private botCommandsToggle: HTMLElement;\r\n  private botCommands: ChatBotCommands;\r\n  private botCommandsIcon: HTMLDivElement;\r\n  private hasBotCommands: boolean;\r\n\r\n  // private activeContainer: HTMLElement;\r\n\r\n  private sendAs: ChatSendAs;\r\n  public sendAsPeerId: PeerId;\r\n\r\n  constructor(\r\n    private chat: Chat, \r\n    private appImManager: AppImManager, \r\n    private managers: AppManagers\r\n  ) {\r\n    this.listenerSetter = new ListenerSetter();\r\n  }\r\n\r\n  public construct() {\r\n    this.chatInput = document.createElement('div');\r\n    this.chatInput.classList.add('chat-input', 'hide');\r\n\r\n    this.inputContainer = document.createElement('div');\r\n    this.inputContainer.classList.add('chat-input-container');\r\n\r\n    this.rowsWrapperWrapper = document.createElement('div');\r\n    this.rowsWrapperWrapper.classList.add('rows-wrapper-wrapper');\r\n\r\n    this.rowsWrapper = document.createElement('div');\r\n    this.rowsWrapper.classList.add('rows-wrapper', 'chat-input-wrapper');\r\n\r\n    this.rowsWrapperWrapper.append(this.rowsWrapper);\r\n\r\n    const tail = generateTail();\r\n    this.rowsWrapper.append(tail);\r\n\r\n    const fakeRowsWrapper = this.fakeRowsWrapper = document.createElement('div');\r\n    fakeRowsWrapper.classList.add('fake-wrapper', 'fake-rows-wrapper');\r\n\r\n    const fakeSelectionWrapper = this.fakeSelectionWrapper = document.createElement('div');\r\n    fakeSelectionWrapper.classList.add('fake-wrapper', 'fake-selection-wrapper');\r\n\r\n    this.inputContainer.append(this.rowsWrapperWrapper, fakeRowsWrapper, fakeSelectionWrapper);\r\n    this.chatInput.append(this.inputContainer);\r\n\r\n    this.goDownBtn = ButtonCorner({icon: 'arrow_down', className: 'bubbles-corner-button bubbles-go-down hide'});\r\n    this.inputContainer.append(this.goDownBtn);\r\n\r\n    attachClickEvent(this.goDownBtn, (e) => {\r\n      cancelEvent(e);\r\n      this.chat.bubbles.onGoDownClick();\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    // * constructor end\r\n\r\n    /* let setScrollTopTimeout: number;\r\n    // @ts-ignore\r\n    let height = window.visualViewport.height; */\r\n    // @ts-ignore\r\n    // this.listenerSetter.add(window.visualViewport)('resize', () => {\r\n    //   const scrollable = this.chat.bubbles.scrollable;\r\n    //   const wasScrolledDown = scrollable.isScrolledDown;\r\n      \r\n    //   /* if(wasScrolledDown) {\r\n    //     this.saveScroll();\r\n    //   } */\r\n      \r\n    //   // @ts-ignore\r\n    //   let newHeight = window.visualViewport.height;\r\n    //   const diff = height - newHeight;\r\n    //   const scrollTop = scrollable.scrollTop;\r\n    //   const needScrollTop = wasScrolledDown ? scrollable.scrollHeight : scrollTop + diff; // * wasScrolledDown     ,     \r\n\r\n    //   console.log('resize before', scrollable.scrollTop, scrollable.container.clientHeight, scrollable.scrollHeight, wasScrolledDown, scrollable.lastScrollTop, diff, needScrollTop);\r\n\r\n    //   scrollable.scrollTop = needScrollTop;\r\n\r\n    //   if(setScrollTopTimeout) clearTimeout(setScrollTopTimeout);\r\n    //   setScrollTopTimeout = window.setTimeout(() => {\r\n    //     const diff = height - newHeight;\r\n    //     const isScrolledDown = scrollable.scrollHeight - Math.round(scrollable.scrollTop + scrollable.container.offsetHeight + diff) <= 1;\r\n    //     height = newHeight;\r\n\r\n    //     scrollable.scrollTop = needScrollTop;\r\n        \r\n    //     console.log('resize after', scrollable.scrollTop, scrollable.container.clientHeight, scrollable.scrollHeight, scrollable.isScrolledDown, scrollable.lastScrollTop, isScrolledDown);\r\n\r\n    //     /* if(isScrolledDown) {\r\n    //       scrollable.scrollTop = scrollable.scrollHeight;\r\n    //     } */\r\n\r\n    //     //scrollable.scrollTop += diff;\r\n    //     setScrollTopTimeout = 0;\r\n    //   }, 0);\r\n    // });\r\n\r\n    // ! Can't use it with resizeObserver\r\n    /* this.listenerSetter.add(window.visualViewport)('resize', () => {\r\n      const scrollable = this.chat.bubbles.scrollable;\r\n      const wasScrolledDown = scrollable.isScrolledDown;\r\n\r\n      // @ts-ignore\r\n      let newHeight = window.visualViewport.height;\r\n      const diff = height - newHeight;\r\n      const needScrollTop = wasScrolledDown ? scrollable.scrollHeight : scrollable.scrollTop + diff; // * wasScrolledDown     ,     \r\n\r\n      //console.log('resize before', scrollable.scrollTop, scrollable.container.clientHeight, scrollable.scrollHeight, wasScrolledDown, scrollable.lastScrollTop, diff, needScrollTop);\r\n\r\n      scrollable.scrollTop = needScrollTop;\r\n      height = newHeight;\r\n\r\n      if(setScrollTopTimeout) clearTimeout(setScrollTopTimeout);\r\n      setScrollTopTimeout = window.setTimeout(() => { // * try again for scrolled down Android Chrome\r\n        scrollable.scrollTop = needScrollTop;\r\n        \r\n        //console.log('resize after', scrollable.scrollTop, scrollable.container.clientHeight, scrollable.scrollHeight, scrollable.isScrolledDown, scrollable.lastScrollTop, isScrolledDown);\r\n        setScrollTopTimeout = 0;\r\n      }, 0);\r\n    }); */\r\n\r\n    const c = this.controlContainer = document.createElement('div');\r\n    c.classList.add('chat-input-control', 'chat-input-wrapper');\r\n    this.inputContainer.append(c);\r\n  }\r\n\r\n  public constructPeerHelpers() {\r\n    this.replyElements.container = document.createElement('div');\r\n    this.replyElements.container.classList.add('reply-wrapper');\r\n\r\n    this.replyElements.iconBtn = ButtonIcon('');\r\n    this.replyElements.cancelBtn = ButtonIcon('close reply-cancel', {noRipple: true});\r\n\r\n    this.replyElements.container.append(this.replyElements.iconBtn, this.replyElements.cancelBtn);\r\n\r\n    //\r\n\r\n    const onHideAuthorClick = () => {\r\n      isChangingAuthor = true;\r\n      return this.canToggleHideAuthor();\r\n    };\r\n\r\n    const onHideCaptionClick = () => {\r\n      isChangingAuthor = false;\r\n    };\r\n\r\n    const forwardElements: ChatInput['forwardElements'] = this.forwardElements = {} as any;\r\n    let isChangingAuthor = false;\r\n    const forwardButtons: ButtonMenuItemOptions[] = [\r\n      forwardElements.showSender = {\r\n        text: 'Chat.Alert.Forward.Action.Show1',\r\n        onClick: onHideAuthorClick,\r\n        checkboxField: new CheckboxField({checked: true})\r\n      },\r\n      forwardElements.hideSender = {\r\n        text: 'Chat.Alert.Forward.Action.Hide1',\r\n        onClick: onHideAuthorClick,\r\n        checkboxField: new CheckboxField({checked: false})\r\n      },\r\n      forwardElements.showCaption = {\r\n        text: 'Chat.Alert.Forward.Action.ShowCaption',\r\n        onClick: onHideCaptionClick,\r\n        checkboxField: new CheckboxField({checked: true})\r\n      },\r\n      forwardElements.hideCaption = {\r\n        text: 'Chat.Alert.Forward.Action.HideCaption',\r\n        onClick: onHideCaptionClick,\r\n        checkboxField: new CheckboxField({checked: false})\r\n      },\r\n      forwardElements.changePeer = {\r\n        text: 'Chat.Alert.Forward.Action.Another',\r\n        onClick: () => {\r\n          this.changeForwardRecipient();\r\n        },\r\n        icon: 'replace'\r\n      }\r\n    ];\r\n    const forwardBtnMenu = forwardElements.container = ButtonMenu(forwardButtons, this.listenerSetter);\r\n    // forwardBtnMenu.classList.add('top-center');\r\n\r\n    const children = Array.from(forwardBtnMenu.children) as HTMLElement[];\r\n    const groups: {\r\n      elements: HTMLElement[],\r\n      onChange: (value: string, event: Event) => void\r\n    }[] = [{\r\n      elements: children.slice(0, 2),\r\n      onChange: (value, e) => {\r\n        const checked = !!+value;\r\n        if(isChangingAuthor) {\r\n          this.forwardWasDroppingAuthor = !checked;\r\n        }\r\n\r\n        const replyTitle = this.replyElements.container.querySelector('.reply-title');\r\n        if(replyTitle) {\r\n          const el = replyTitle.firstElementChild as HTMLElement;\r\n          const i = I18n.weakMap.get(el) as I18n.IntlElement;\r\n          const langPackKey: LangPackKey = forwardElements.showSender.checkboxField.checked ? 'Chat.Accessory.Forward' : 'Chat.Accessory.Hidden';\r\n          i.key = langPackKey;\r\n          i.update();\r\n        }\r\n      }\r\n    }, {\r\n      elements: children.slice(2, 4),\r\n      onChange: (value) => {\r\n        const checked = !!+value;\r\n        let b: ButtonMenuItemOptions;\r\n        if(checked && this.forwardWasDroppingAuthor !== undefined) {\r\n          b = this.forwardWasDroppingAuthor ? forwardElements.hideSender : forwardElements.showSender;\r\n        } else {\r\n          b = checked ? forwardElements.showSender : forwardElements.hideSender;\r\n        }\r\n\r\n        b.checkboxField.checked = true;\r\n      }\r\n    }];\r\n    groups.forEach((group) => {\r\n      const container = RadioForm(group.elements.map((e) => {\r\n        return {\r\n          container: e, \r\n          input: e.querySelector('input')\r\n        };\r\n      }), group.onChange);\r\n\r\n      const hr = document.createElement('hr');\r\n      container.append(hr);\r\n      forwardBtnMenu.append(container);\r\n    });\r\n\r\n    forwardBtnMenu.append(forwardElements.changePeer.element);\r\n\r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      const forwardHover = this.forwardHover = new DropdownHover({\r\n        element: forwardBtnMenu\r\n      });\r\n    }\r\n\r\n    forwardElements.modifyArgs = forwardButtons.slice(0, -1);\r\n    this.replyElements.container.append(forwardBtnMenu);\r\n\r\n    forwardElements.modifyArgs.forEach((b, idx) => {\r\n      const {input} = b.checkboxField;\r\n      input.type = 'radio';\r\n      input.name = idx < 2 ? 'author' : 'caption';\r\n      input.value = '' + +!(idx % 2);\r\n    });\r\n\r\n    //\r\n\r\n    this.newMessageWrapper = document.createElement('div');\r\n    this.newMessageWrapper.classList.add('new-message-wrapper');\r\n\r\n    this.btnToggleEmoticons = ButtonIcon('none toggle-emoticons', {noRipple: true});\r\n\r\n    this.inputMessageContainer = document.createElement('div');\r\n    this.inputMessageContainer.classList.add('input-message-container');\r\n\r\n    if(this.chat.type === 'chat') {\r\n      this.goDownUnreadBadge = document.createElement('span');\r\n      this.goDownUnreadBadge.classList.add('badge', 'badge-24', 'badge-primary');\r\n      this.goDownBtn.append(this.goDownUnreadBadge);\r\n\r\n      this.goMentionBtn = ButtonCorner({icon: 'mention', className: 'bubbles-corner-button bubbles-go-mention'});\r\n      this.goMentionUnreadBadge = document.createElement('span');\r\n      this.goMentionUnreadBadge.classList.add('badge', 'badge-24', 'badge-primary');\r\n      this.goMentionBtn.append(this.goMentionUnreadBadge);\r\n      this.inputContainer.append(this.goMentionBtn);\r\n\r\n      attachClickEvent(this.goMentionBtn, (e) => {\r\n        cancelEvent(e);\r\n        const middleware = this.chat.bubbles.getMiddleware();\r\n        this.managers.appMessagesManager.goToNextMention(this.chat.peerId).then((mid) => {\r\n          if(!middleware()) {\r\n            return;\r\n          }\r\n          \r\n          if(mid) {\r\n            this.chat.setMessageId(mid);\r\n          }\r\n        });\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      this.btnScheduled = ButtonIcon('scheduled btn-scheduled float hide', {noRipple: true});\r\n\r\n      attachClickEvent(this.btnScheduled, (e) => {\r\n        this.appImManager.openScheduled(this.chat.peerId);\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      this.listenerSetter.add(rootScope)('scheduled_new', ({peerId}) => {\r\n        if(this.chat.peerId !== peerId) {\r\n          return;\r\n        }\r\n\r\n        this.btnScheduled.classList.remove('hide');\r\n      });\r\n\r\n      this.listenerSetter.add(rootScope)('scheduled_delete', ({peerId}) => {\r\n        if(this.chat.peerId !== peerId) {\r\n          return;\r\n        }\r\n\r\n        this.managers.appMessagesManager.getScheduledMessages(this.chat.peerId).then((value) => {\r\n          this.btnScheduled.classList.toggle('hide', !value.length);\r\n        });\r\n      });\r\n\r\n      this.btnToggleReplyMarkup = ButtonIcon('botcom toggle-reply-markup float hide', {noRipple: true});\r\n      this.replyKeyboard = new ReplyKeyboard({\r\n        appendTo: this.rowsWrapper,\r\n        listenerSetter: this.listenerSetter,\r\n        managers: this.managers,\r\n        btnHover: this.btnToggleReplyMarkup,\r\n        chatInput: this\r\n      });\r\n      this.listenerSetter.add(this.replyKeyboard)('open', () => this.btnToggleReplyMarkup.classList.add('active'));\r\n      this.listenerSetter.add(this.replyKeyboard)('close', () => this.btnToggleReplyMarkup.classList.remove('active'));\r\n\r\n      this.botCommands = new ChatBotCommands(this.rowsWrapper, this, this.managers);\r\n      this.botCommandsToggle = document.createElement('div');\r\n      this.botCommandsToggle.classList.add('new-message-bot-commands');\r\n\r\n      const scaler = document.createElement('div');\r\n      scaler.classList.add('new-message-bot-commands-icon-scale');\r\n\r\n      const icon = this.botCommandsIcon = document.createElement('div');\r\n      icon.classList.add('animated-menu-icon', 'animated-menu-close-icon');\r\n      scaler.append(icon);\r\n      this.botCommandsToggle.append(scaler);\r\n\r\n      attachClickEvent(this.botCommandsToggle, (e) => {\r\n        cancelEvent(e);\r\n        const isShown = icon.classList.contains('state-back');\r\n        if(isShown) {\r\n          this.botCommands.toggle(true);\r\n          icon.classList.remove('state-back');\r\n        } else {\r\n          this.botCommands.setUserId(this.chat.peerId.toUserId(), this.chat.bubbles.getMiddleware());\r\n          icon.classList.add('state-back');\r\n        }\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      this.botCommands.addEventListener('visible', () => {\r\n        icon.classList.add('state-back');\r\n      });\r\n\r\n      this.botCommands.addEventListener('hiding', () => {\r\n        icon.classList.remove('state-back');\r\n      });\r\n    }\r\n\r\n    this.attachMenuButtons = [{\r\n      icon: 'image',\r\n      text: 'Chat.Input.Attach.PhotoOrVideo',\r\n      onClick: () => {\r\n        this.fileInput.value = '';\r\n        const accept = [...MEDIA_MIME_TYPES_SUPPORTED].join(', ');\r\n        this.fileInput.setAttribute('accept', accept);\r\n        this.willAttachType = 'media';\r\n        this.fileInput.click();\r\n      },\r\n      verify: () => this.chat.canSend('send_media')\r\n    }, {\r\n      icon: 'document',\r\n      text: 'Chat.Input.Attach.Document',\r\n      onClick: () => {\r\n        this.fileInput.value = '';\r\n        this.fileInput.removeAttribute('accept');\r\n        this.willAttachType = 'document';\r\n        this.fileInput.click();\r\n      },\r\n      verify: () => this.chat.canSend('send_media')\r\n    }, {\r\n      icon: 'poll',\r\n      text: 'Poll',\r\n      onClick: () => {\r\n        PopupElement.createPopup(PopupCreatePoll, this.chat).show();\r\n      },\r\n      verify: (peerId) => peerId.isAnyChat() && this.chat.canSend('send_polls')\r\n    }];\r\n\r\n    this.attachMenu = ButtonMenuToggle({noRipple: true, listenerSetter: this.listenerSetter}, 'top-left', this.attachMenuButtons);\r\n    this.attachMenu.classList.add('attach-file', 'tgico-attach');\r\n    this.attachMenu.classList.remove('tgico-more');\r\n\r\n    //this.inputContainer.append(this.sendMenu);\r\n\r\n    this.recordTimeEl = document.createElement('div');\r\n    this.recordTimeEl.classList.add('record-time');\r\n\r\n    this.fileInput = document.createElement('input');\r\n    this.fileInput.type = 'file';\r\n    this.fileInput.multiple = true;\r\n    this.fileInput.style.display = 'none';\r\n\r\n    this.newMessageWrapper.append(...[this.botCommandsToggle, this.btnToggleEmoticons, this.inputMessageContainer, this.btnScheduled, this.btnToggleReplyMarkup, this.attachMenu, this.recordTimeEl, this.fileInput].filter(Boolean));\r\n\r\n    this.rowsWrapper.append(this.replyElements.container);\r\n    this.autocompleteHelperController = new AutocompleteHelperController();\r\n    this.stickersHelper = new StickersHelper(this.rowsWrapper, this.autocompleteHelperController, this.managers);\r\n    this.emojiHelper = new EmojiHelper(this.rowsWrapper, this.autocompleteHelperController, this, this.managers);\r\n    this.commandsHelper = new CommandsHelper(this.rowsWrapper, this.autocompleteHelperController, this, this.managers);\r\n    this.mentionsHelper = new MentionsHelper(this.rowsWrapper, this.autocompleteHelperController, this, this.managers);\r\n    this.inlineHelper = new InlineHelper(this.rowsWrapper, this.autocompleteHelperController, this.chat, this.managers);\r\n    this.rowsWrapper.append(this.newMessageWrapper);\r\n\r\n    this.btnCancelRecord = ButtonIcon('delete btn-circle z-depth-1 btn-record-cancel');\r\n\r\n    this.btnSendContainer = document.createElement('div');\r\n    this.btnSendContainer.classList.add('btn-send-container');\r\n\r\n    this.recordRippleEl = document.createElement('div');\r\n    this.recordRippleEl.classList.add('record-ripple');\r\n\r\n    this.btnSend = ButtonIcon('none btn-circle z-depth-1 btn-send animated-button-icon');\r\n    this.btnSend.insertAdjacentHTML('afterbegin', `\r\n    <span class=\"tgico tgico-send\"></span>\r\n    <span class=\"tgico tgico-schedule\"></span>\r\n    <span class=\"tgico tgico-check\"></span>\r\n    <span class=\"tgico tgico-microphone_filled\"></span>\r\n    `);\r\n\r\n    this.btnSendContainer.append(this.recordRippleEl, this.btnSend);\r\n\r\n    if(this.chat.type !== 'scheduled') {\r\n      this.sendMenu = new SendMenu({\r\n        onSilentClick: () => {\r\n          this.sendSilent = true;\r\n          this.sendMessage();\r\n        },\r\n        onScheduleClick: () => {\r\n          this.scheduleSending(undefined);\r\n        },\r\n        listenerSetter: this.listenerSetter,\r\n        openSide: 'top-left',\r\n        onContextElement: this.btnSend,\r\n        onOpen: () => {\r\n          return !this.isInputEmpty() || !!Object.keys(this.forwarding).length;\r\n        }\r\n      });\r\n      \r\n      this.btnSendContainer.append(this.sendMenu.sendMenu);\r\n    }\r\n\r\n    this.inputContainer.append(this.btnCancelRecord, this.btnSendContainer);\r\n\r\n    emoticonsDropdown.attachButtonListener(this.btnToggleEmoticons, this.listenerSetter);\r\n    this.listenerSetter.add(emoticonsDropdown)('open', this.onEmoticonsOpen);\r\n    this.listenerSetter.add(emoticonsDropdown)('close', this.onEmoticonsClose);\r\n\r\n    this.attachMessageInputField();\r\n\r\n    /* this.attachMenu.addEventListener('mousedown', (e) => {\r\n      const hidden = this.attachMenu.querySelectorAll('.hide');\r\n      if(hidden.length === this.attachMenuButtons.length) {\r\n        toast(POSTING_MEDIA_NOT_ALLOWED);\r\n        cancelEvent(e);\r\n        return false;\r\n      }\r\n    }, {passive: false, capture: true}); */\r\n\r\n    this.listenerSetter.add(rootScope)('settings_updated', () => {\r\n      if(this.stickersHelper || this.emojiHelper) {\r\n        // this.previousQuery = undefined;\r\n        this.previousQuery = '';\r\n        this.checkAutocomplete();\r\n        /* if(!rootScope.settings.stickers.suggest) {\r\n          this.stickersHelper.checkEmoticon('');\r\n        } else {\r\n          this.onMessageInput();\r\n        } */\r\n      }\r\n\r\n      if(this.messageInputField) {\r\n        this.messageInputField.onFakeInput();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('draft_updated', ({peerId, threadId, draft, force}) => {\r\n      if(this.chat.threadId !== threadId || this.chat.peerId !== peerId) return;\r\n      this.setDraft(draft, true, force);\r\n    });\r\n\r\n    this.listenerSetter.add(this.appImManager)('peer_changing', (chat) => {\r\n      if(this.chat === chat) {\r\n        this.saveDraft();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(this.appImManager)('chat_changing', ({from, to}) => {\r\n      if(this.chat === from) {\r\n        this.autocompleteHelperController.toggleListNavigation(false);\r\n      } else if(this.chat === to) {\r\n        this.autocompleteHelperController.toggleListNavigation(true);\r\n      }\r\n    });\r\n\r\n    if(this.chat.type === 'scheduled') {\r\n      this.listenerSetter.add(rootScope)('scheduled_delete', ({peerId, mids}) => {\r\n        if(this.chat.peerId === peerId && mids.includes(this.editMsgId)) {\r\n          this.onMessageSent();\r\n        }\r\n      });\r\n    } else {\r\n      this.listenerSetter.add(rootScope)('history_delete', ({peerId, msgs}) => {\r\n        if(this.chat.peerId === peerId) {\r\n          if(msgs.has(this.editMsgId)) {\r\n            this.onMessageSent();\r\n          }\r\n\r\n          if(this.replyToMsgId && msgs.has(this.replyToMsgId)) {\r\n            this.clearHelper('reply');\r\n          }\r\n\r\n          /* if(this.chat.isStartButtonNeeded()) {\r\n            this.setStartParam(BOT_START_PARAM);\r\n          } */\r\n        }\r\n      });\r\n\r\n      this.listenerSetter.add(rootScope)('dialogs_multiupdate', (dialogs) => {\r\n        if(dialogs[this.chat.peerId]) {\r\n          if(this.startParam === BOT_START_PARAM) {\r\n            this.setStartParam();\r\n          } else { // updateNewMessage comes earlier than dialog appers\r\n            this.center(true);\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    try {\r\n      this.recorder = new Recorder({\r\n        //encoderBitRate: 32,\r\n        //encoderPath: \"../dist/encoderWorker.min.js\",\r\n        encoderSampleRate: 48000,\r\n        monitorGain: 0,\r\n        numberOfChannels: 1,\r\n        recordingGain: 1,\r\n        reuseWorker: true\r\n      });\r\n    } catch(err) {\r\n      console.error('Recorder constructor error:', err);\r\n    }\r\n\r\n    this.updateSendBtn();\r\n\r\n    this.listenerSetter.add(this.fileInput)('change', (e) => {\r\n      let files = (e.target as HTMLInputElement & EventTarget).files;\r\n      if(!files.length) {\r\n        return;\r\n      }\r\n      \r\n      PopupElement.createPopup(PopupNewMedia, this.chat, Array.from(files).slice(), this.willAttachType);\r\n      this.fileInput.value = '';\r\n    }, false);\r\n\r\n    /* let time = Date.now();\r\n    this.btnSend.addEventListener('touchstart', (e) => {\r\n      time = Date.now();\r\n    });\r\n\r\n    let eventName1 = 'touchend';\r\n    this.btnSend.addEventListener(eventName1, (e: Event) => {\r\n      //cancelEvent(e);\r\n      console.log(eventName1 + ', time: ' + (Date.now() - time));\r\n    });\r\n\r\n    let eventName = 'mousedown';\r\n    this.btnSend.addEventListener(eventName, (e: Event) => {\r\n      cancelEvent(e);\r\n      console.log(eventName + ', time: ' + (Date.now() - time));\r\n    }); */\r\n    attachClickEvent(this.btnSend, this.onBtnSendClick, {listenerSetter: this.listenerSetter, touchMouseDown: true});\r\n\r\n    if(this.recorder) {\r\n      attachClickEvent(this.btnCancelRecord, this.onCancelRecordClick, {listenerSetter: this.listenerSetter});\r\n\r\n      this.recorder.onstop = () => {\r\n        this.setRecording(false);\r\n        this.chatInput.classList.remove('is-locked');\r\n        this.recordRippleEl.style.transform = '';\r\n      };\r\n  \r\n      this.recorder.ondataavailable = (typedArray: Uint8Array) => {\r\n        if(this.releaseMediaPlayback) {\r\n          this.releaseMediaPlayback();\r\n          this.releaseMediaPlayback = undefined;\r\n        }\r\n\r\n        if(this.recordingOverlayListener) {\r\n          this.listenerSetter.remove(this.recordingOverlayListener);\r\n          this.recordingOverlayListener = undefined;\r\n        }\r\n\r\n        if(this.recordingNavigationItem) {\r\n          appNavigationController.removeItem(this.recordingNavigationItem);\r\n          this.recordingNavigationItem = undefined;\r\n        }\r\n\r\n        if(this.recordCanceled) {\r\n          return;\r\n        }\r\n\r\n        const {peerId, threadId} = this.chat;\r\n        const replyToMsgId = this.replyToMsgId;\r\n  \r\n        const duration = (Date.now() - this.recordStartTime) / 1000 | 0;\r\n        const dataBlob = new Blob([typedArray], {type: 'audio/ogg'});\r\n        /* const fileName = new Date().toISOString() + \".opus\";\r\n        console.log('Recorder data received', typedArray, dataBlob); */\r\n\r\n        //let perf = performance.now();\r\n        opusDecodeController.decode(typedArray, true).then((result) => {\r\n          //console.log('WAVEFORM!:', /* waveform,  */performance.now() - perf);\r\n  \r\n          opusDecodeController.setKeepAlive(false);\r\n  \r\n          //  objectURL    audio/wav\r\n          this.managers.appMessagesManager.sendFile(peerId, dataBlob, {\r\n            isVoiceMessage: true,\r\n            isMedia: true,\r\n            duration,\r\n            waveform: result.waveform,\r\n            objectURL: result.url,\r\n            replyToMsgId,\r\n            threadId,\r\n            clearDraft: true\r\n          });\r\n\r\n          this.onMessageSent(false, true);\r\n        });\r\n      };\r\n    }\r\n\r\n    attachClickEvent(this.replyElements.cancelBtn, this.onHelperCancel, {listenerSetter: this.listenerSetter});\r\n    attachClickEvent(this.replyElements.container, this.onHelperClick, {listenerSetter: this.listenerSetter});\r\n\r\n    this.saveDraftDebounced = debounce(() => this.saveDraft(), 2500, false, true);\r\n\r\n    this.botStartBtn = Button('btn-primary btn-transparent text-bold chat-input-control-button');\r\n    this.botStartBtn.append(i18n('BotStart'));\r\n\r\n    attachClickEvent(this.botStartBtn, () => {\r\n      const {startParam} = this;\r\n      if(startParam === undefined) {\r\n        return;\r\n      }\r\n\r\n      const toggle = this.toggleBotStartBtnDisability = toggleDisability([this.botStartBtn], true);\r\n      const peerId = this.chat.peerId;\r\n      const middleware = this.chat.bubbles.getMiddleware(() => {\r\n        return this.chat.peerId === peerId && this.startParam === startParam && this.toggleBotStartBtnDisability === toggle;\r\n      });\r\n\r\n      this.managers.appMessagesManager.startBot(peerId.toUserId(), undefined, startParam).then(() => {\r\n        if(middleware()) {\r\n          toggle();\r\n          this.toggleBotStartBtnDisability = undefined;\r\n          this.setStartParam();\r\n        }\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    this.controlContainer.append(this.botStartBtn);\r\n  }\r\n\r\n  public constructPinnedHelpers() {\r\n    this.pinnedControlBtn = Button('btn-primary btn-transparent text-bold chat-input-control-button', {icon: 'unpin'});\r\n    this.controlContainer.append(this.pinnedControlBtn);\r\n\r\n    this.listenerSetter.add(this.pinnedControlBtn)('click', () => {\r\n      const peerId = this.chat.peerId;\r\n\r\n      new PopupPinMessage(peerId, 0, true, () => {\r\n        this.chat.appImManager.setPeer(); // * close tab\r\n\r\n        // ! ,     ,  ,      \r\n        const originalChat = this.chat.appImManager.chat;\r\n        if(originalChat.topbar.pinnedMessage) {\r\n          originalChat.topbar.pinnedMessage.pinnedMessageContainer.toggle(true);\r\n        }\r\n      });\r\n    });\r\n\r\n    this.chatInput.classList.add('type-pinned');\r\n  }\r\n\r\n  public _center(neededFakeContainer: HTMLElement, animate?: boolean) {\r\n    if(!neededFakeContainer && !this.inputContainer.classList.contains('is-centering')) {\r\n      return;\r\n    }\r\n\r\n    if(neededFakeContainer === this.fakeWrapperTo) {\r\n      return;\r\n    }\r\n\r\n    /* if(neededFakeContainer === this.botStartContainer && this.fakeWrapperTo === this.fakeSelectionWrapper) {\r\n      this.inputContainer.classList.remove('is-centering');\r\n      void this.rowsWrapper.offsetLeft; // reflow\r\n      // this.inputContainer.classList.add('is-centering');\r\n      // void this.rowsWrapper.offsetLeft; // reflow\r\n    } */\r\n\r\n    const fakeSelectionWrapper = neededFakeContainer || this.fakeWrapperTo;\r\n    const forwards = !!neededFakeContainer;\r\n    const oldFakeWrapperTo = this.fakeWrapperTo;\r\n    let transform = '', borderRadius = '', needTranslateX: number;\r\n    // if(forwards) {]\r\n      const fakeSelectionRect = fakeSelectionWrapper.getBoundingClientRect();\r\n      const fakeRowsRect = this.fakeRowsWrapper.getBoundingClientRect();\r\n      const widthFrom = fakeRowsRect.width;\r\n      const widthTo = fakeSelectionRect.width;\r\n\r\n      if(widthFrom !== widthTo) {\r\n        const scale = (widthTo/*  - 8 */) / widthFrom;\r\n        const initTranslateX = (widthFrom - widthTo) / 2;\r\n        needTranslateX = fakeSelectionRect.left - fakeRowsRect.left - initTranslateX;\r\n\r\n        if(forwards) {\r\n          transform = `translateX(${needTranslateX}px) scaleX(${scale})`;\r\n          // transform = `translateX(0px) scaleX(${scale})`;\r\n  \r\n          if(scale < 1) {\r\n            const br = 12;\r\n            borderRadius = '' + (br + br * (1 - scale)) + 'px';\r\n          }\r\n        }\r\n        //scale = widthTo / widthFrom;\r\n      }\r\n    // }\r\n\r\n    this.fakeWrapperTo = neededFakeContainer;\r\n\r\n    const duration = animate ? 200 : 0;\r\n    SetTransition(this.inputContainer, 'is-centering', forwards, duration);\r\n    SetTransition(this.rowsWrapperWrapper, 'is-centering-to-control', !!(forwards && neededFakeContainer && neededFakeContainer.classList.contains('chat-input-control')), duration);\r\n    this.rowsWrapper.style.transform = transform;\r\n    this.rowsWrapper.style.borderRadius = borderRadius;\r\n\r\n    return {\r\n      transform, \r\n      borderRadius, \r\n      needTranslateX: oldFakeWrapperTo && (\r\n          (\r\n            neededFakeContainer && \r\n            neededFakeContainer.classList.contains('chat-input-control') && \r\n            oldFakeWrapperTo === this.fakeSelectionWrapper\r\n          ) || oldFakeWrapperTo.classList.contains('chat-input-control')\r\n        ) ? needTranslateX * -.5 : needTranslateX,\r\n      widthFrom, \r\n      widthTo\r\n    };\r\n  }\r\n\r\n  public async center(animate = false) {\r\n    return this._center(await this.getNeededFakeContainer(), animate);\r\n  }\r\n\r\n  public setStartParam(startParam?: string) {\r\n    if(this.startParam === startParam) {\r\n      return;\r\n    }\r\n\r\n    this.startParam = startParam;\r\n    this.center(true);\r\n  }\r\n\r\n  public async getNeededFakeContainer(startParam = this.startParam) {\r\n    if(this.chat.selection.isSelecting) {\r\n      return this.fakeSelectionWrapper;\r\n    } else if(\r\n      startParam !== undefined || \r\n      !(await this.chat.canSend()) || \r\n      this.chat.type === 'pinned' || \r\n      await this.chat.isStartButtonNeeded()\r\n    ) {\r\n      return this.controlContainer;\r\n    }\r\n  }\r\n\r\n  // public getActiveContainer() {\r\n  //   if(this.chat.selection.isSelecting) {\r\n  //     return this.chat\r\n  //   }\r\n  //   return this.startParam !== undefined ? this.botStartContainer : this.rowsWrapper;\r\n  // }\r\n\r\n  // public setActiveContainer() {\r\n  //   const container = this.activeContainer;\r\n  //   const newContainer = this.getActiveContainer();\r\n  //   if(newContainer === container) {\r\n  //     return;\r\n  //   }\r\n\r\n\r\n  // }\r\n\r\n  private onCancelRecordClick = (e?: Event) => {\r\n    if(e) {\r\n      cancelEvent(e);\r\n    }\r\n    \r\n    this.recordCanceled = true;\r\n    this.recorder.stop();\r\n    opusDecodeController.setKeepAlive(false);\r\n  };\r\n\r\n  private onEmoticonsOpen = () => {\r\n    const toggleClass = IS_TOUCH_SUPPORTED ? 'flip-icon' : 'active';\r\n    this.btnToggleEmoticons.classList.toggle(toggleClass, true);\r\n  };\r\n\r\n  private onEmoticonsClose = () => {\r\n    const toggleClass = IS_TOUCH_SUPPORTED ? 'flip-icon' : 'active';\r\n    this.btnToggleEmoticons.classList.toggle(toggleClass, false);\r\n  };\r\n\r\n  public getReadyToSend(callback: () => void) {\r\n    return this.chat.type === 'scheduled' ? (this.scheduleSending(callback), true) : (callback(), false);\r\n  }\r\n\r\n  public scheduleSending = async(callback: () => void = this.sendMessage.bind(this, true), initDate = new Date()) => {\r\n    const {peerId} = this.chat;\r\n    const middleware = this.chat.bubbles.getMiddleware();\r\n    const canSendWhenOnline = rootScope.myId !== peerId && peerId.isUser() && await this.managers.appUsersManager.isUserOnlineVisible(peerId);\r\n\r\n    new PopupSchedule(initDate, (timestamp) => {\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n\r\n      const minTimestamp = (Date.now() / 1000 | 0) + 10;\r\n      if(timestamp <= minTimestamp) {\r\n        timestamp = undefined;\r\n      }\r\n\r\n      this.scheduleDate = timestamp;\r\n      callback();\r\n\r\n      if(this.chat.type !== 'scheduled' && timestamp) {\r\n        setTimeout(() => { // ! need timeout here because .forwardMessages will be called after timeout\r\n          if(!middleware()) {\r\n            return;\r\n          }\r\n\r\n          this.appImManager.openScheduled(peerId);\r\n        }, 0);\r\n      }\r\n    }, canSendWhenOnline).show();\r\n  };\r\n\r\n  public async setUnreadCount() {\r\n    if(!this.goDownUnreadBadge) {\r\n      return;\r\n    }\r\n    \r\n    const dialog = await this.managers.appMessagesManager.getDialogOnly(this.chat.peerId);\r\n    const count = dialog?.unread_count;\r\n    this.goDownUnreadBadge.innerText = '' + (count || '');\r\n    this.goDownUnreadBadge.classList.toggle('badge-gray', await this.managers.appNotificationsManager.isPeerLocalMuted(this.chat.peerId, true));\r\n\r\n    if(this.goMentionUnreadBadge && this.chat.type === 'chat') {\r\n      const hasMentions = !!(dialog?.unread_mentions_count && dialog.unread_count);\r\n      this.goMentionUnreadBadge.innerText = hasMentions ? '' + (dialog.unread_mentions_count) : '';\r\n      this.goMentionBtn.classList.toggle('is-visible', hasMentions);\r\n    }\r\n  }\r\n\r\n  public saveDraft() {\r\n    if(!this.chat.peerId || this.editMsgId || this.chat.type === 'scheduled') return;\r\n    \r\n    const {value, entities} = getRichValue(this.messageInputField.input);\r\n\r\n    let draft: DraftMessage.draftMessage;\r\n    if(value.length || this.replyToMsgId) {\r\n      draft = {\r\n        _: 'draftMessage',\r\n        date: tsNow(true),\r\n        message: value,\r\n        entities: entities.length ? entities : undefined,\r\n        pFlags: {\r\n          no_webpage: this.noWebPage\r\n        },\r\n        reply_to_msg_id: this.replyToMsgId\r\n      };\r\n    }\r\n\r\n    this.managers.appDraftsManager.syncDraft(this.chat.peerId, this.chat.threadId, draft);\r\n  }\r\n\r\n  public destroy() {\r\n    //this.chat.log.error('Input destroying');\r\n\r\n    this.listenerSetter.removeAll();\r\n  }\r\n\r\n  public cleanup(helperToo = true) {\r\n    if(!this.chat.peerId) {\r\n      this.chatInput.classList.add('hide');\r\n      this.goDownBtn.classList.add('hide');\r\n    }\r\n\r\n    cancelSelection();\r\n\r\n    this.lastTimeType = 0;\r\n    this.startParam = undefined;\r\n\r\n    if(this.toggleBotStartBtnDisability) {\r\n      this.toggleBotStartBtnDisability();\r\n      this.toggleBotStartBtnDisability = undefined;\r\n    }\r\n\r\n    if(this.messageInput) {\r\n      this.clearInput();\r\n      helperToo && this.clearHelper();\r\n    }\r\n  }\r\n\r\n  public async setDraft(draft?: MyDraftMessage, fromUpdate = true, force = false) {\r\n    if((!force && !isInputEmpty(this.messageInput)) || this.chat.type === 'scheduled') return false;\r\n    \r\n    if(!draft) {\r\n      draft = await this.managers.appDraftsManager.getDraft(this.chat.peerId, this.chat.threadId);\r\n\r\n      if(!draft) {\r\n        if(force) { // this situation can only happen when sending message with clearDraft\r\n          /* const height = this.chatInput.getBoundingClientRect().height;\r\n          const willChangeHeight = 78 - height;\r\n          this.willChangeHeight = willChangeHeight; */\r\n          if(this.chat.container.classList.contains('is-helper-active')) {\r\n            this.t();\r\n          }\r\n\r\n          this.messageInputField.inputFake.textContent = '';\r\n          this.messageInputField.onFakeInput(false);\r\n\r\n          ((this.chat.bubbles.messagesQueuePromise || Promise.resolve()) as Promise<any>).then(() => {\r\n            fastRaf(() => {\r\n              this.onMessageSent();\r\n            });\r\n          });\r\n        }\r\n        \r\n        return false;\r\n      }\r\n    }\r\n\r\n    const wrappedDraft = wrapDraft(draft);\r\n\r\n    if(this.messageInputField.value === wrappedDraft && this.replyToMsgId === draft.reply_to_msg_id) return false;\r\n\r\n    if(fromUpdate) {\r\n      this.clearHelper();\r\n    }\r\n\r\n    this.noWebPage = draft.pFlags.no_webpage;\r\n    if(draft.reply_to_msg_id) {\r\n      this.initMessageReply(draft.reply_to_msg_id);\r\n    }\r\n\r\n    this.setInputValue(wrappedDraft, fromUpdate, fromUpdate);\r\n    return true;\r\n  }\r\n\r\n  private createSendAs() {\r\n    this.sendAsPeerId = undefined;\r\n\r\n    if(this.chat.type === 'chat' || this.chat.type === 'discussion') {\r\n      let firstChange = true;\r\n      this.sendAs = new ChatSendAs(\r\n        this.managers,\r\n        (container, skipAnimation) => {\r\n          let useRafs = 0;\r\n          if(!container.parentElement) {\r\n            this.newMessageWrapper.prepend(container);\r\n            useRafs = 2;\r\n          }\r\n\r\n          this.updateOffset('as', true, skipAnimation, useRafs);\r\n        },\r\n        (sendAsPeerId) => {\r\n          this.sendAsPeerId = sendAsPeerId;\r\n\r\n          // do not change placeholder earlier than finishPeerChange does\r\n          if(firstChange) {\r\n            firstChange = false;\r\n            return;\r\n          }\r\n\r\n          this.getPlaceholderKey().then((key) => {\r\n            this.updateMessageInputPlaceholder(key);\r\n          });\r\n        }\r\n      );\r\n    } else {\r\n      this.sendAs = undefined;\r\n    }\r\n\r\n    return this.sendAs;\r\n  }\r\n\r\n  public async finishPeerChange(startParam?: string) {\r\n    const peerId = this.chat.peerId;\r\n\r\n    const {forwardElements, btnScheduled, replyKeyboard, sendMenu, goDownBtn, chatInput, botCommandsToggle} = this;\r\n    \r\n    const previousSendAs = this.sendAs;\r\n    const sendAs = this.createSendAs();\r\n\r\n    const [\r\n      isBroadcast, \r\n      canPinMessage, \r\n      isBot, \r\n      canSend, \r\n      neededFakeContainer, \r\n      ackedPeerFull, \r\n      ackedScheduledMids, \r\n      setSendAsCallback,\r\n      filteredAttachMenuButtons\r\n    ] = await Promise.all([\r\n      this.managers.appPeersManager.isBroadcast(peerId),\r\n      this.managers.appPeersManager.canPinMessage(peerId),\r\n      this.managers.appPeersManager.isBot(peerId),\r\n      this.chat.canSend(),\r\n      this.getNeededFakeContainer(startParam),\r\n      modifyAckedPromise(this.managers.acknowledged.appProfileManager.getProfileByPeerId(peerId)),\r\n      btnScheduled ? modifyAckedPromise(this.managers.acknowledged.appMessagesManager.getScheduledMessages(peerId)) : undefined,\r\n      sendAs ? (sendAs.setPeerId(this.chat.peerId), sendAs.updateManual(true)) : undefined,\r\n      this.filterAttachMenuButtons()\r\n    ]);\r\n\r\n    const placeholderKey = this.messageInput ? await this.getPlaceholderKey() : undefined;\r\n\r\n    return () => {\r\n      // console.warn('[input] finishpeerchange start');\r\n      \r\n      chatInput.classList.remove('hide');\r\n      goDownBtn.classList.toggle('is-broadcast', isBroadcast);\r\n      goDownBtn.classList.remove('hide');\r\n  \r\n      if(this.goDownUnreadBadge) {\r\n        this.setUnreadCount();\r\n      }\r\n  \r\n      if(this.chat.type === 'pinned') {\r\n        chatInput.classList.toggle('can-pin', canPinMessage);\r\n      }/*  else if(this.chat.type === 'chat') {\r\n      } */\r\n  \r\n      if(forwardElements) {\r\n        this.forwardWasDroppingAuthor = false;\r\n        forwardElements.showCaption.checkboxField.setValueSilently(true);\r\n        forwardElements.showSender.checkboxField.setValueSilently(true);\r\n      }\r\n  \r\n      if(btnScheduled && ackedScheduledMids) {\r\n        btnScheduled.classList.add('hide');\r\n        const middleware = this.chat.bubbles.getMiddleware();\r\n        callbackify(ackedScheduledMids.result, (mids) => {\r\n          if(!middleware() || !mids) return;\r\n          btnScheduled.classList.toggle('hide', !mids.length);\r\n        });\r\n      }\r\n  \r\n      if(this.newMessageWrapper) {\r\n        this.updateOffset(null, false, true);\r\n      }\r\n  \r\n      if(botCommandsToggle) {\r\n        this.hasBotCommands = undefined;\r\n        this.botCommands.toggle(true, undefined, true);\r\n        this.updateBotCommandsToggle(true);\r\n        botCommandsToggle.remove();\r\n        if(isBot) {\r\n          const middleware = this.chat.bubbles.getMiddleware();\r\n          const result = ackedPeerFull.result;\r\n          callbackify(result, (userFull) => {\r\n            if(!middleware()) return;\r\n            this.updateBotCommands(userFull as UserFull.userFull, !(result instanceof Promise));\r\n          });\r\n        }\r\n      }\r\n\r\n      if(previousSendAs) {\r\n        previousSendAs.destroy();\r\n      }\r\n\r\n      if(setSendAsCallback) {\r\n        setSendAsCallback();\r\n      }\r\n  \r\n      if(replyKeyboard) {\r\n        replyKeyboard.setPeer(peerId);\r\n      }\r\n  \r\n      if(sendMenu) {\r\n        sendMenu.setPeerId(peerId);\r\n      }\r\n      \r\n      if(this.messageInput) {\r\n        this.updateMessageInput(canSend, placeholderKey, filteredAttachMenuButtons);\r\n      } else if(this.pinnedControlBtn) {\r\n        this.pinnedControlBtn.append(i18n(canPinMessage ? 'Chat.Input.UnpinAll' : 'Chat.Pinned.DontShow'));\r\n      }\r\n  \r\n      // * testing\r\n      // this.startParam = this.appPeersManager.isBot(peerId) ? '123' : undefined;\r\n      \r\n      this.startParam = startParam;\r\n  \r\n      this._center(neededFakeContainer, false);\r\n\r\n      // console.warn('[input] finishpeerchange ends');\r\n    };\r\n  }\r\n\r\n  private updateOffset(type: 'commands' | 'as', forwards: boolean, skipAnimation?: boolean, useRafs?: number) {\r\n    if(type) {\r\n      this.newMessageWrapper.dataset.offset = type;\r\n    } else {\r\n      delete this.newMessageWrapper.dataset.offset;\r\n    }\r\n\r\n    SetTransition(this.newMessageWrapper, 'has-offset', forwards, skipAnimation ? 0 : 300, undefined, useRafs);\r\n  }\r\n\r\n  private updateBotCommands(userFull: UserFull.userFull, skipAnimation?: boolean) {\r\n    this.hasBotCommands = !!userFull.bot_info?.commands?.length;\r\n    this.updateBotCommandsToggle(skipAnimation);\r\n  }\r\n\r\n  private updateBotCommandsToggle(skipAnimation?: boolean) {\r\n    const {botCommandsToggle, hasBotCommands} = this;\r\n\r\n    const show = !!hasBotCommands && this.isInputEmpty();\r\n    if(!hasBotCommands) {\r\n      if(!botCommandsToggle.parentElement) {\r\n        return;\r\n      }\r\n      \r\n      botCommandsToggle.remove();\r\n    }\r\n    \r\n    const forwards = show;\r\n    const useRafs = botCommandsToggle.parentElement ? 0 : 2;\r\n\r\n    if(!botCommandsToggle.parentElement) {\r\n      this.newMessageWrapper.prepend(botCommandsToggle);\r\n    }\r\n\r\n    this.updateOffset('commands', forwards, skipAnimation, useRafs);\r\n  }\r\n\r\n  private async getPlaceholderKey() {\r\n    const {peerId, threadId} = this.chat;\r\n    let key: LangPackKey;\r\n    if(threadId) {\r\n      key = 'Comment';\r\n    } else if(await this.managers.appPeersManager.isBroadcast(peerId)) {\r\n      key = 'ChannelBroadcast';\r\n    } else if(\r\n      (this.sendAsPeerId !== undefined && this.sendAsPeerId !== rootScope.myId) || \r\n      await this.managers.appMessagesManager.isAnonymousSending(peerId)\r\n    ) {\r\n      key = 'SendAnonymously';\r\n    } else {\r\n      key = 'Message';\r\n    }\r\n\r\n    return key;\r\n  }\r\n\r\n  private updateMessageInputPlaceholder(key: LangPackKey) {\r\n    // console.warn('[input] update placeholder');\r\n    const i = I18n.weakMap.get(this.messageInput) as I18n.IntlElement;\r\n    if(!i) {\r\n      return;\r\n    }\r\n\r\n    i.compareAndUpdate({key});\r\n  }\r\n\r\n  private filterAttachMenuButtons() {\r\n    if(!this.attachMenuButtons) return;\r\n    const {peerId, threadId} = this.chat;\r\n    return filterAsync(this.attachMenuButtons, (button) => {\r\n      return button.verify(peerId, threadId);\r\n    });\r\n  }\r\n\r\n  public updateMessageInput(canSend: boolean, placeholderKey: LangPackKey, visible: ChatInput['attachMenuButtons']) {\r\n    const {chatInput, attachMenu, messageInput} = this;\r\n    const {peerId, threadId} = this.chat;\r\n    const isHidden = chatInput.classList.contains('is-hidden');\r\n    const willBeHidden = !canSend;\r\n    if(isHidden !== willBeHidden) {\r\n      chatInput.classList.add('no-transition');\r\n      chatInput.classList.toggle('is-hidden', !canSend);\r\n      void chatInput.offsetLeft; // reflow\r\n      chatInput.classList.remove('no-transition');\r\n    }\r\n\r\n    this.updateMessageInputPlaceholder(placeholderKey);\r\n\r\n    this.attachMenuButtons && this.attachMenuButtons.forEach((button) => {\r\n      button.element.classList.toggle('hide', !visible.includes(button));\r\n    });\r\n\r\n    if(!canSend) {\r\n      messageInput.removeAttribute('contenteditable');\r\n    } else {\r\n      messageInput.setAttribute('contenteditable', 'true');\r\n      this.setDraft(undefined, false);\r\n\r\n      if(!messageInput.innerHTML) {\r\n        this.messageInputField.onFakeInput();\r\n      }\r\n    }\r\n    \r\n    if(attachMenu) {\r\n      attachMenu.toggleAttribute('disabled', !visible.length);\r\n      attachMenu.classList.toggle('btn-disabled', !visible.length);\r\n    }\r\n    \r\n    this.updateSendBtn();\r\n  }\r\n\r\n  private attachMessageInputField() {\r\n    const oldInputField = this.messageInputField;\r\n    this.messageInputField = new InputFieldAnimated({\r\n      placeholder: 'Message',\r\n      name: 'message',\r\n      withLinebreaks: true\r\n    });\r\n\r\n    this.messageInputField.input.classList.replace('input-field-input', 'input-message-input');\r\n    this.messageInputField.inputFake.classList.replace('input-field-input', 'input-message-input');\r\n    this.messageInput = this.messageInputField.input;\r\n    this.messageInput.classList.add('no-scrollbar');\r\n    this.attachMessageInputListeners();\r\n    \r\n    if(IS_STICKY_INPUT_BUGGED) {\r\n      fixSafariStickyInputFocusing(this.messageInput);\r\n    }\r\n\r\n    if(oldInputField) {\r\n      oldInputField.input.replaceWith(this.messageInputField.input);\r\n      oldInputField.inputFake.replaceWith(this.messageInputField.inputFake);\r\n    } else {\r\n      this.inputMessageContainer.append(this.messageInputField.input, this.messageInputField.inputFake);\r\n    }\r\n  }\r\n\r\n  private attachMessageInputListeners() {\r\n    this.listenerSetter.add(this.messageInput)('keydown', (e: KeyboardEvent) => {\r\n      const key = e.key;\r\n      if(isSendShortcutPressed(e)) {\r\n        cancelEvent(e);\r\n        this.sendMessage();\r\n      } else if(e.ctrlKey || e.metaKey) {\r\n        this.handleMarkdownShortcut(e);\r\n      } else if((key === 'PageUp' || key === 'PageDown') && !e.shiftKey) { // * fix pushing page to left (Chrome Windows)\r\n        e.preventDefault();\r\n\r\n        if(key === 'PageUp') {\r\n          const range = document.createRange();\r\n          const sel = window.getSelection();\r\n          \r\n          range.setStart(this.messageInput.childNodes[0] || this.messageInput, 0);\r\n          range.collapse(true);\r\n          \r\n          sel.removeAllRanges();\r\n          sel.addRange(range);\r\n        } else {\r\n          placeCaretAtEnd(this.messageInput);\r\n        }\r\n      }\r\n    });\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      attachClickEvent(this.messageInput, (e) => {\r\n        this.appImManager.selectTab(1); // * set chat tab for album orientation\r\n        //this.saveScroll();\r\n        emoticonsDropdown.toggle(false);\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      /* this.listenerSetter.add(window)('resize', () => {\r\n        this.restoreScroll();\r\n      }); */\r\n\r\n      /* if(isSafari) {  \r\n        this.listenerSetter.add(this.messageInput)('mousedown', () => {\r\n          window.requestAnimationFrame(() => {\r\n            window.requestAnimationFrame(() => {\r\n              emoticonsDropdown.toggle(false);\r\n            });\r\n          });\r\n        });\r\n      } */\r\n    }\r\n\r\n    /* this.listenerSetter.add(this.messageInput)('beforeinput', (e: Event) => {\r\n      // * validate due to manual formatting through browser's context menu\r\n      const inputType = (e as InputEvent).inputType;\r\n      //console.log('message beforeinput event', e);\r\n\r\n      if(inputType.indexOf('format') === 0) {\r\n        //console.log('message beforeinput format', e, inputType, this.messageInput.innerHTML);\r\n        const markdownType = inputType.split('format')[1].toLowerCase() as MarkdownType;\r\n        if(this.applyMarkdown(markdownType)) {\r\n          cancelEvent(e); // * cancel legacy markdown event\r\n        }\r\n      }\r\n    }); */\r\n    this.listenerSetter.add(this.messageInput)('input', this.onMessageInput);\r\n    this.listenerSetter.add(this.messageInput)('keyup', () => {\r\n      this.checkAutocomplete();\r\n    });\r\n\r\n    if(this.chat.type === 'chat' || this.chat.type === 'discussion') {\r\n      this.listenerSetter.add(this.messageInput)('focusin', () => {\r\n        if(this.chat.bubbles.scrollable.loadedAll.bottom) {\r\n          this.managers.appMessagesManager.readAllHistory(this.chat.peerId, this.chat.threadId);\r\n        }\r\n      }); \r\n    }\r\n  }\r\n\r\n  private prepareDocumentExecute = () => {\r\n    this.executedHistory.push(this.messageInput.innerHTML);\r\n    return () => this.canUndoFromHTML = this.messageInput.innerHTML;\r\n  };\r\n\r\n  private undoRedo = (e: Event, type: 'undo' | 'redo', needHTML: string) => {\r\n    cancelEvent(e); // cancel legacy event\r\n\r\n    let html = this.messageInput.innerHTML;\r\n    if(html && html !== needHTML) {\r\n      this.lockRedo = true;\r\n\r\n      let sameHTMLTimes = 0;\r\n      do {\r\n        document.execCommand(type, false, null);\r\n        const currentHTML = this.messageInput.innerHTML;\r\n        if(html === currentHTML) {\r\n          if(++sameHTMLTimes > 2) { // * unlink, removeFormat (   , :    (  ),  )\r\n            break;\r\n          }\r\n        } else {\r\n          sameHTMLTimes = 0;\r\n        }\r\n\r\n        html = currentHTML;\r\n      } while(html !== needHTML);\r\n\r\n      this.lockRedo = false;\r\n    }\r\n  };\r\n\r\n  public applyMarkdown(type: MarkdownType, href?: string) {\r\n    const MONOSPACE_FONT = 'var(--font-monospace)';\r\n    const SPOILER_FONT = 'spoiler';\r\n    const commandsMap: Partial<{[key in typeof type]: string | (() => void)}> = {\r\n      bold: 'Bold',\r\n      italic: 'Italic',\r\n      underline: 'Underline',\r\n      strikethrough: 'Strikethrough',\r\n      monospace: () => document.execCommand('fontName', false, MONOSPACE_FONT),\r\n      link: href ? () => document.execCommand('createLink', false, href) : () => document.execCommand('unlink', false, null),\r\n      spoiler: () => document.execCommand('fontName', false, SPOILER_FONT)\r\n    };\r\n\r\n    if(!commandsMap[type]) {\r\n      return false;\r\n    }\r\n\r\n    const command = commandsMap[type];\r\n\r\n    //type = 'monospace';\r\n\r\n    const saveExecuted = this.prepareDocumentExecute();\r\n    const executed: any[] = [];\r\n    /**\r\n     * * clear previous formatting, due to Telegram's inability to handle several entities\r\n     */\r\n    /* const checkForSingle = () => {\r\n      const nodes = getSelectedNodes();\r\n      //console.log('Using formatting:', commandsMap[type], nodes, this.executedHistory);\r\n\r\n      const parents = [...new Set(nodes.map((node) => node.parentNode))];\r\n      //const differentParents = !!nodes.find((node) => node.parentNode !== firstParent);\r\n      const differentParents = parents.length > 1;\r\n\r\n      let notSingle = false;\r\n      if(differentParents) {\r\n        notSingle = true;\r\n      } else {\r\n        const node = nodes[0];\r\n        if(node && (node.parentNode as HTMLElement) !== this.messageInput && (node.parentNode.parentNode as HTMLElement) !== this.messageInput) {\r\n          notSingle = true;\r\n        }\r\n      }\r\n\r\n      if(notSingle) {\r\n        //if(type === 'monospace') {\r\n          executed.push(document.execCommand('styleWithCSS', false, 'true'));\r\n        //}\r\n\r\n        executed.push(document.execCommand('unlink', false, null));\r\n        executed.push(document.execCommand('removeFormat', false, null));\r\n        executed.push(typeof(command) === 'function' ? command() : document.execCommand(command, false, null));\r\n\r\n        //if(type === 'monospace') {\r\n          executed.push(document.execCommand('styleWithCSS', false, 'false'));\r\n        //}\r\n      }\r\n    }; */\r\n\r\n    executed.push(document.execCommand('styleWithCSS', false, 'true'));\r\n\r\n    const checkType = (type: MarkdownType) => {\r\n      let haveThisType = false;\r\n      //executed.push(document.execCommand('styleWithCSS', false, 'true'));\r\n\r\n      const selection = window.getSelection();\r\n      if(!selection.isCollapsed) {\r\n        const range = selection.getRangeAt(0);\r\n        const tag = markdownTags[type];\r\n\r\n        const node = range.commonAncestorContainer;\r\n        if((node.parentNode as HTMLElement).matches(tag.match) || (node instanceof HTMLElement && node.matches(tag.match))) {\r\n          haveThisType = true;\r\n        }\r\n      }\r\n\r\n      return haveThisType;\r\n    };\r\n\r\n    // * monospace can't be combined with different types\r\n    if(type === 'monospace' || type === 'spoiler') {\r\n      // executed.push(document.execCommand('styleWithCSS', false, 'true'));\r\n\r\n      const haveThisType = checkType(type);\r\n      // executed.push(document.execCommand('removeFormat', false, null));\r\n\r\n      if(haveThisType) {\r\n        executed.push(this.resetCurrentFontFormatting());\r\n      } else {\r\n        if(type === 'monospace' || checkType('monospace')) {\r\n          executed.push(this.resetCurrentFormatting());\r\n        }\r\n\r\n        executed.push(typeof(command) === 'function' ? command() : document.execCommand(command, false, null));\r\n      }\r\n    } else {\r\n      if(checkType('monospace')) {\r\n        executed.push(this.resetCurrentFormatting());\r\n      }\r\n\r\n      executed.push(typeof(command) === 'function' ? command() : document.execCommand(command, false, null));\r\n    }\r\n\r\n    executed.push(document.execCommand('styleWithCSS', false, 'false'));\r\n\r\n    //checkForSingle();\r\n    saveExecuted();\r\n    if(this.appImManager.markupTooltip) {\r\n      this.appImManager.markupTooltip.setActiveMarkupButton();\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  private resetCurrentFormatting() {\r\n    return document.execCommand('removeFormat', false, null);\r\n  }\r\n\r\n  private resetCurrentFontFormatting() {\r\n    return document.execCommand('fontName', false, 'Roboto');\r\n  }\r\n\r\n  private handleMarkdownShortcut = (e: KeyboardEvent) => {\r\n    // console.log('handleMarkdownShortcut', e);\r\n    const formatKeys: {[key: string]: MarkdownType} = {\r\n      'KeyB': 'bold',\r\n      'KeyI': 'italic',\r\n      'KeyU': 'underline',\r\n      'KeyS': 'strikethrough',\r\n      'KeyM': 'monospace',\r\n      'KeyP': 'spoiler'\r\n    };\r\n\r\n    if(this.appImManager.markupTooltip) {\r\n      formatKeys['KeyK'] = 'link';\r\n    }\r\n\r\n    const code = e.code;\r\n    const applyMarkdown = formatKeys[code];\r\n\r\n    const selection = document.getSelection();\r\n    if(selection.toString().trim().length && applyMarkdown) {\r\n      // * \r\n      if(code === 'KeyK') {\r\n        this.appImManager.markupTooltip.showLinkEditor();\r\n      } else {\r\n        this.applyMarkdown(applyMarkdown);\r\n      }\r\n  \r\n      cancelEvent(e); // cancel legacy event\r\n    }\r\n\r\n    //return;\r\n    if(code === 'KeyZ') {\r\n      let html = this.messageInput.innerHTML;\r\n\r\n      if(e.shiftKey) {\r\n        if(this.undoHistory.length) {\r\n          this.executedHistory.push(html);\r\n          html = this.undoHistory.pop();\r\n          this.undoRedo(e, 'redo', html);\r\n          html = this.messageInput.innerHTML;\r\n          this.canRedoFromHTML = this.undoHistory.length ? html : '';\r\n          this.canUndoFromHTML = html;\r\n        }\r\n      } else {\r\n        // * ,        ,     saveExecuted\r\n        if(this.executedHistory.length && (!this.canUndoFromHTML || html === this.canUndoFromHTML)) {\r\n          this.undoHistory.push(html);\r\n          html = this.executedHistory.pop();\r\n          this.undoRedo(e, 'undo', html);\r\n\r\n          // *      ,    -,       \r\n          this.canUndoFromHTML = this.canRedoFromHTML = this.messageInput.innerHTML;\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  private onMessageInput = (e?: Event) => {\r\n    // * validate due to manual formatting through browser's context menu\r\n    /* const inputType = (e as InputEvent).inputType;\r\n    console.log('message input event', e);\r\n    if(inputType === 'formatBold') {\r\n      console.log('message input format', this.messageInput.innerHTML);\r\n      cancelEvent(e);\r\n    }\r\n\r\n    if(!isSelectionSingle()) {\r\n      alert('not single');\r\n    } */\r\n\r\n    //console.log('messageInput input', this.messageInput.innerText);\r\n    //const value = this.messageInput.innerText;\r\n    const {value: richValue, entities: markdownEntities, caretPos} = getRichValueWithCaret(this.messageInputField.input);\r\n      \r\n    //const entities = parseEntities(value);\r\n    const value = parseMarkdown(richValue, markdownEntities, true);\r\n    const entities = mergeEntities(markdownEntities, parseEntities(value));\r\n\r\n    //this.chat.log('messageInput entities', richValue, value, markdownEntities, caretPos);\r\n\r\n    if(this.canRedoFromHTML && !this.lockRedo && this.messageInput.innerHTML !== this.canRedoFromHTML) {\r\n      this.canRedoFromHTML = '';\r\n      this.undoHistory.length = 0;\r\n    }\r\n\r\n    const urlEntities: Array<MessageEntity.messageEntityUrl | MessageEntity.messageEntityTextUrl> = (!this.editMessage?.media || this.editMessage.media._ === 'messageMediaWebPage') && entities.filter((e) => e._ === 'messageEntityUrl' || e._ === 'messageEntityTextUrl') as any;\r\n    if(urlEntities.length) {\r\n      for(const entity of urlEntities) {\r\n        let url: string;\r\n        if(entity._ === 'messageEntityTextUrl') {\r\n          url = entity.url;\r\n        } else {\r\n          url = richValue.slice(entity.offset, entity.offset + entity.length);\r\n\r\n          if(!(url.includes('http://') || url.includes('https://'))) {\r\n            continue;\r\n          }\r\n        }\r\n\r\n        //console.log('messageInput url:', url);\r\n\r\n        if(this.lastUrl !== url) {\r\n          this.lastUrl = url;\r\n          // this.willSendWebPage = null;\r\n          const promise = this.getWebPagePromise = this.managers.appWebPagesManager.getWebPage(url).then((webpage) => {\r\n            if(this.getWebPagePromise === promise) this.getWebPagePromise = undefined;\r\n            if(this.lastUrl !== url) return;\r\n            if(webpage._  === 'webPage') {\r\n              //console.log('got webpage: ', webpage);\r\n\r\n              this.setTopInfo('webpage', () => {}, webpage.site_name || webpage.title || 'Webpage', webpage.description || webpage.url || '');\r\n              delete this.noWebPage;\r\n              this.willSendWebPage = webpage;\r\n            } else if(this.willSendWebPage) {\r\n              this.onHelperCancel();\r\n            }\r\n          });\r\n        }\r\n\r\n        break;\r\n      }\r\n    } else if(this.lastUrl) {\r\n      this.lastUrl = '';\r\n      delete this.noWebPage;\r\n      this.willSendWebPage = null;\r\n      \r\n      if(this.helperType) {\r\n        this.helperFunc();\r\n      } else {\r\n        this.clearHelper();\r\n      }\r\n    }\r\n\r\n    const isEmpty = !richValue.trim();\r\n    if(isEmpty) {\r\n      if(this.lastTimeType) {\r\n        this.managers.appMessagesManager.setTyping(this.chat.peerId, {_: 'sendMessageCancelAction'});\r\n      }\r\n\r\n      if(this.appImManager.markupTooltip) {\r\n        this.appImManager.markupTooltip.hide();\r\n      }\r\n\r\n      // * Chrome has a bug - it will preserve the formatting if the input with monospace text is cleared\r\n      // * so have to reset formatting\r\n      if(document.activeElement === this.messageInput) {\r\n        // document.execCommand('styleWithCSS', false, 'true');\r\n        setTimeout(() => {\r\n          if(document.activeElement === this.messageInput) {\r\n            this.resetCurrentFontFormatting();\r\n          }\r\n        }, 0);\r\n        // document.execCommand('styleWithCSS', false, 'false');\r\n      }\r\n    } else {\r\n      const time = Date.now();\r\n      if(time - this.lastTimeType >= 6000) {\r\n        this.lastTimeType = time;\r\n        this.managers.appMessagesManager.setTyping(this.chat.peerId, {_: 'sendMessageTypingAction'});\r\n      }\r\n\r\n      if(this.botCommands) {\r\n        this.botCommands.toggle(true);\r\n      }\r\n    }\r\n\r\n    if(this.botCommands) {\r\n      this.updateBotCommandsToggle();\r\n    }\r\n\r\n    if(!this.editMsgId) {\r\n      this.saveDraftDebounced();\r\n    }\r\n\r\n    this.checkAutocomplete(richValue, caretPos, entities);\r\n\r\n    this.updateSendBtn();\r\n  };\r\n\r\n  public insertAtCaret(insertText: string, insertEntity?: MessageEntity, isHelper = true) {\r\n    const {value: fullValue, caretPos, entities} = getRichValueWithCaret(this.messageInput);\r\n    const pos = caretPos >= 0 ? caretPos : fullValue.length;\r\n    const prefix = fullValue.substr(0, pos);\r\n    const suffix = fullValue.substr(pos);\r\n\r\n    const matches = isHelper ? prefix.match(ChatInput.AUTO_COMPLETE_REG_EXP) : null;\r\n\r\n    const matchIndex = matches ? matches.index + (matches[0].length - matches[2].length) : prefix.length;\r\n    const newPrefix = prefix.slice(0, matchIndex);\r\n    const newValue = newPrefix + insertText + suffix;\r\n\r\n    // merge emojis\r\n    const hadEntities = parseEntities(fullValue);\r\n    mergeEntities(entities, hadEntities);\r\n\r\n    // max for additional whitespace\r\n    const insertLength = insertEntity ? Math.max(insertEntity.length, insertText.length) : insertText.length;\r\n    const addEntities: MessageEntity[] = [];\r\n    if(insertEntity) {\r\n      addEntities.push(insertEntity);\r\n      insertEntity.offset = matchIndex;\r\n    }\r\n\r\n    // add offset to entities next to emoji\r\n    const diff = matches ? insertLength - matches[2].length : insertLength;\r\n    entities.forEach((entity) => {\r\n      if(entity.offset >= matchIndex) {\r\n        entity.offset += diff;\r\n      }\r\n    });\r\n\r\n    mergeEntities(entities, addEntities);\r\n\r\n    if(/* caretPos !== -1 && caretPos !== fullValue.length */true) {\r\n      const caretEntity: MessageEntity.messageEntityCaret = {\r\n        _: 'messageEntityCaret',\r\n        offset: matchIndex + insertLength,\r\n        length: 0\r\n      };\r\n\r\n      let insertCaretAtIndex = 0;\r\n      for(let length = entities.length; insertCaretAtIndex < length; ++insertCaretAtIndex) {\r\n        const entity = entities[insertCaretAtIndex];\r\n        if(entity.offset > caretEntity.offset) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      entities.splice(insertCaretAtIndex, 0, caretEntity);\r\n    }\r\n\r\n    //const saveExecuted = this.prepareDocumentExecute();\r\n    // can't exec .value here because it will instantly check for autocomplete\r\n    const value = documentFragmentToHTML(wrapDraftText(newValue, {entities}));\r\n    this.messageInputField.setValueSilently(value);\r\n\r\n    const caret = this.messageInput.querySelector('.composer-sel');\r\n    if(caret) {\r\n      setCaretAt(caret);\r\n      caret.remove();\r\n    }\r\n\r\n    // but it's needed to be checked only here\r\n    this.onMessageInput();\r\n\r\n    //saveExecuted();\r\n\r\n    //document.execCommand('insertHTML', true, wrapEmojiText(emoji));\r\n  }\r\n\r\n  public onEmojiSelected = (emoji: string, autocomplete: boolean) => {\r\n    this.insertAtCaret(emoji, getEmojiEntityFromEmoji(emoji), autocomplete);\r\n  };\r\n\r\n  private async checkAutocomplete(value?: string, caretPos?: number, entities?: MessageEntity[]) {\r\n    //return;\r\n\r\n    if(value === undefined) {\r\n      const r = getRichValueWithCaret(this.messageInputField.input, true);\r\n      value = r.value;\r\n      caretPos = r.caretPos;\r\n      entities = r.entities;\r\n    }\r\n\r\n    if(caretPos === -1) {\r\n      caretPos = value.length;\r\n    }\r\n\r\n    if(entities === undefined) {\r\n      const _value = parseMarkdown(value, entities, true);\r\n      entities = mergeEntities(entities, parseEntities(_value));\r\n    }\r\n\r\n    value = value.slice(0, caretPos);\r\n\r\n    if(this.previousQuery === value) {\r\n      return;\r\n    }\r\n\r\n    this.previousQuery = value;\r\n    \r\n    const matches = value.match(ChatInput.AUTO_COMPLETE_REG_EXP);\r\n    let foundHelper: AutocompleteHelper;\r\n    if(matches) {\r\n      const entity = entities[0];\r\n\r\n      let query = matches[2];\r\n      const firstChar = query[0];\r\n\r\n      if(this.stickersHelper && \r\n        rootScope.settings.stickers.suggest && \r\n        await this.chat.canSend('send_stickers') &&\r\n        entity?._ === 'messageEntityEmoji' && entity.length === value.length && !entity.offset) {\r\n        foundHelper = this.stickersHelper;\r\n        this.stickersHelper.checkEmoticon(value);\r\n      } else if(firstChar === '@') { // mentions\r\n        const topMsgId = this.chat.threadId ? getServerMessageId(this.chat.threadId) : undefined;\r\n        if(await this.mentionsHelper.checkQuery(query, this.chat.peerId.isUser() ? NULL_PEER_ID : this.chat.peerId, topMsgId)) {\r\n          foundHelper = this.mentionsHelper;\r\n        }\r\n      } else if(!matches[1] && firstChar === '/') { // commands\r\n        if(await this.commandsHelper.checkQuery(query, this.chat.peerId)) {\r\n          foundHelper = this.commandsHelper;\r\n        }\r\n      } else if(rootScope.settings.emoji.suggest) { // emoji\r\n        query = query.replace(/^\\s*/, '');\r\n        if(!value.match(/^\\s*:(.+):\\s*$/) && !value.match(/:[;!@#$%^&*()-=|]/) && query) {\r\n          foundHelper = this.emojiHelper;\r\n          this.emojiHelper.checkQuery(query, firstChar);\r\n        }\r\n      }\r\n    }\r\n    \r\n    foundHelper = this.checkInlineAutocomplete(value, foundHelper);\r\n\r\n    this.autocompleteHelperController.hideOtherHelpers(foundHelper);\r\n  }\r\n\r\n  private checkInlineAutocomplete(value: string, foundHelper?: AutocompleteHelper): AutocompleteHelper {\r\n    let needPlaceholder = false;\r\n\r\n    if(!foundHelper) {\r\n      const inlineMatch = value.match(/^@([a-zA-Z\\\\d_]{3,32})\\s/);\r\n      if(inlineMatch) {\r\n        const username = inlineMatch[1];\r\n        const query = value.slice(inlineMatch[0].length);\r\n        needPlaceholder = inlineMatch[0].length === value.length;\r\n  \r\n        foundHelper = this.inlineHelper;\r\n\r\n        if(!this.btnPreloader) {\r\n          this.btnPreloader = ButtonIcon('none btn-preloader float show disable-hover', {noRipple: true});\r\n          putPreloader(this.btnPreloader, true);\r\n          this.inputMessageContainer.parentElement.insertBefore(this.btnPreloader, this.inputMessageContainer.nextSibling);\r\n        } else {\r\n          SetTransition(this.btnPreloader, 'show', true, 400);\r\n        }\r\n        \r\n        this.inlineHelper.checkQuery(this.chat.peerId, username, query).then(({user, renderPromise}) => {\r\n          if(needPlaceholder && user.bot_inline_placeholder) {\r\n            this.messageInput.dataset.inlinePlaceholder = user.bot_inline_placeholder;\r\n          }\r\n\r\n          renderPromise.then(() => {\r\n            SetTransition(this.btnPreloader, 'show', false, 400);\r\n          });\r\n        }).catch(noop);\r\n      }\r\n    }\r\n    \r\n    if(!needPlaceholder) {\r\n      delete this.messageInput.dataset.inlinePlaceholder;\r\n    }\r\n\r\n    if(foundHelper !== this.inlineHelper) {\r\n      if(this.btnPreloader) {\r\n        SetTransition(this.btnPreloader, 'show', false, 400);\r\n      }\r\n    }\r\n\r\n    return foundHelper;\r\n  }\r\n\r\n  private setRecording(value: boolean) {\r\n    if(this.recording === value) {\r\n      return;\r\n    }\r\n\r\n    SetTransition(this.chatInput, 'is-recording', value, 200);\r\n    this.recording = value;\r\n    this.updateSendBtn();\r\n  }\r\n\r\n  private onBtnSendClick = async(e: Event) => {\r\n    cancelEvent(e);\r\n\r\n    if(!this.recorder || this.recording || !this.isInputEmpty() || this.forwarding || this.editMsgId) {\r\n      if(this.recording) {\r\n        if((Date.now() - this.recordStartTime) < RECORD_MIN_TIME) {\r\n          this.onCancelRecordClick();\r\n        } else {\r\n          this.recorder.stop();\r\n        }\r\n      } else {\r\n        this.sendMessage();\r\n      }\r\n    } else {\r\n      if(this.chat.peerId.isAnyChat() && !(await this.chat.canSend('send_media'))) {\r\n        toast(POSTING_MEDIA_NOT_ALLOWED);\r\n        return;\r\n      }\r\n\r\n      this.chatInput.classList.add('is-locked');\r\n      blurActiveElement();\r\n\r\n      this.recorder.start().then(() => {\r\n        this.releaseMediaPlayback = appMediaPlaybackController.setSingleMedia();\r\n        this.recordCanceled = false;\r\n        \r\n        this.setRecording(true);\r\n        opusDecodeController.setKeepAlive(true);\r\n        \r\n        const showDiscardPopup = () => {\r\n          new PopupPeer('popup-cancel-record', {\r\n            titleLangKey: 'DiscardVoiceMessageTitle',\r\n            descriptionLangKey: 'DiscardVoiceMessageDescription',\r\n            buttons: [{\r\n              langKey: 'DiscardVoiceMessageAction',\r\n              callback: () => {\r\n                simulateClickEvent(this.btnCancelRecord);\r\n              }\r\n            }, {\r\n              langKey: 'Continue',\r\n              isCancel: true\r\n            }]\r\n          }).show();\r\n        };\r\n\r\n        this.recordingOverlayListener = this.listenerSetter.add(document.body)('mousedown', (e) => {\r\n          if(!findUpClassName(e.target, 'chat-input') && !findUpClassName(e.target, 'popup-cancel-record')) {\r\n            cancelEvent(e);\r\n            showDiscardPopup();\r\n          }\r\n        }, {capture: true, passive: false}) as any;\r\n\r\n        appNavigationController.pushItem(this.recordingNavigationItem = {\r\n          type: 'voice',\r\n          onPop: () => {\r\n            setTimeout(() => {\r\n              showDiscardPopup();\r\n            }, 0);\r\n\r\n            return false;\r\n          }\r\n        });\r\n\r\n        this.recordStartTime = Date.now();\r\n\r\n        const sourceNode: MediaStreamAudioSourceNode = this.recorder.sourceNode;\r\n        const context = sourceNode.context;\r\n\r\n        const analyser = context.createAnalyser();\r\n        sourceNode.connect(analyser);\r\n        //analyser.connect(context.destination);\r\n        analyser.fftSize = 32;\r\n\r\n        const frequencyData = new Uint8Array(analyser.frequencyBinCount);\r\n        const max = frequencyData.length * 255;\r\n        const min = 54 / 150;\r\n        let r = () => {\r\n          if(!this.recording) return;\r\n\r\n          analyser.getByteFrequencyData(frequencyData);\r\n\r\n          let sum = 0;\r\n          frequencyData.forEach((value) => {\r\n            sum += value;\r\n          });\r\n          \r\n          let percents = Math.min(1, (sum / max) + min);\r\n          //console.log('frequencyData', frequencyData, percents);\r\n\r\n          this.recordRippleEl.style.transform = `scale(${percents})`;\r\n\r\n          let diff = Date.now() - this.recordStartTime;\r\n          let ms = diff % 1000;\r\n\r\n          let formatted = toHHMMSS(diff / 1000) + ',' + ('00' + Math.round(ms / 10)).slice(-2);\r\n\r\n          this.recordTimeEl.innerText = formatted;\r\n\r\n          fastRaf(r);\r\n        };\r\n\r\n        r();\r\n      }).catch((e: Error) => {\r\n        switch(e.name as string) {\r\n          case 'NotAllowedError': {\r\n            toast('Please allow access to your microphone');\r\n            break;\r\n          }\r\n\r\n          case 'NotReadableError': {\r\n            toast(e.message);\r\n            break;\r\n          }\r\n\r\n          default:\r\n            console.error('Recorder start error:', e, e.name, e.message);\r\n            toast(e.message);\r\n            break;\r\n        }\r\n\r\n        this.setRecording(false);\r\n        this.chatInput.classList.remove('is-locked');\r\n      });\r\n    }\r\n  };\r\n\r\n  private onHelperCancel = async(e?: Event, force?: boolean) => {\r\n    if(e) {\r\n      cancelEvent(e);\r\n    }\r\n\r\n    if(this.willSendWebPage) {\r\n      const lastUrl = this.lastUrl;\r\n      let needReturn = false;\r\n      if(this.helperType) {\r\n        //if(this.helperFunc) {\r\n          await this.helperFunc();\r\n        //}\r\n\r\n        needReturn = true;\r\n      }\r\n\r\n      // * restore values\r\n      this.lastUrl = lastUrl;\r\n      this.noWebPage = true;\r\n      this.willSendWebPage = null;\r\n\r\n      if(needReturn) return;\r\n    }\r\n\r\n    if(this.helperType === 'edit' && !force) {\r\n      const message = this.editMessage\r\n      const value = parseMarkdown(this.messageInputField.value, []);\r\n      if(message.message !== value) {\r\n        new PopupPeer('discard-editing', {\r\n          buttons: [{\r\n            langKey: 'Alert.Confirm.Discard',\r\n            callback: () => {\r\n              this.onHelperCancel(undefined, true);\r\n            }\r\n          }],\r\n          descriptionLangKey: 'Chat.Edit.Cancel.Text'\r\n        }).show();\r\n\r\n        return;\r\n      }\r\n    }\r\n\r\n    this.clearHelper();\r\n    this.updateSendBtn();\r\n  };\r\n\r\n  private onHelperClick = (e: Event) => {\r\n    cancelEvent(e);\r\n      \r\n    if(!findUpClassName(e.target, 'reply')) return;\r\n    if(this.helperType === 'forward') {\r\n      const {forwardElements} = this;\r\n      if(forwardElements && IS_TOUCH_SUPPORTED && !forwardElements.container.classList.contains('active')) {\r\n        contextMenuController.openBtnMenu(forwardElements.container);\r\n      }\r\n    } else if(this.helperType === 'reply') {\r\n      this.chat.setMessageId(this.replyToMsgId);\r\n    } else if(this.helperType === 'edit') {\r\n      this.chat.setMessageId(this.editMsgId);\r\n    }\r\n  };\r\n\r\n  private changeForwardRecipient() {\r\n    if(this.helperWaitingForward) return;\r\n    this.helperWaitingForward = true;\r\n\r\n    const forwarding = copy(this.forwarding);\r\n    const helperFunc = this.helperFunc;\r\n    this.clearHelper();\r\n    this.updateSendBtn();\r\n    let selected = false;\r\n    const popup = new PopupForward(forwarding, () => {\r\n      selected = true;\r\n    });\r\n\r\n    popup.addEventListener('close', () => {\r\n      this.helperWaitingForward = false;\r\n\r\n      if(!selected) {\r\n        helperFunc();\r\n      }\r\n    });\r\n  }\r\n\r\n  public async clearInput(canSetDraft = true, fireEvent = true, clearValue = '') {\r\n    if(document.activeElement === this.messageInput && IS_MOBILE_SAFARI) { // fix first char uppercase\r\n      const i = document.createElement('input');\r\n      document.body.append(i);\r\n      fixSafariStickyInput(i);\r\n      this.messageInputField.setValueSilently(clearValue);\r\n      fixSafariStickyInput(this.messageInput);\r\n      i.remove();\r\n    } else {\r\n      this.messageInputField.setValueSilently(clearValue);\r\n    }\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      //this.messageInput.innerText = '';\r\n    } else {\r\n      //this.attachMessageInputField();\r\n      //this.messageInput.innerText = '';\r\n\r\n      // clear executions\r\n      this.canRedoFromHTML = '';\r\n      this.undoHistory.length = 0;\r\n      this.executedHistory.length = 0;\r\n      this.canUndoFromHTML = '';\r\n    }\r\n\r\n    let set = false;\r\n    if(canSetDraft) {\r\n      set = await this.setDraft(undefined, false);\r\n    }\r\n\r\n    if(!set && fireEvent) {\r\n      this.onMessageInput();\r\n    }\r\n  }\r\n\r\n  public isInputEmpty() {\r\n    return isInputEmpty(this.messageInput);\r\n  }\r\n\r\n  public updateSendBtn() {\r\n    let icon: 'send' | 'record' | 'edit' | 'schedule';\r\n\r\n    const isInputEmpty = this.isInputEmpty();\r\n\r\n    if(this.editMsgId) icon = 'edit';\r\n    else if(!this.recorder || this.recording || !isInputEmpty || this.forwarding) icon = this.chat.type === 'scheduled' ? 'schedule' : 'send';\r\n    else icon = 'record';\r\n\r\n    ['send', 'record', 'edit', 'schedule'].forEach((i) => {\r\n      this.btnSend.classList.toggle(i, icon === i);\r\n    });\r\n\r\n    if(this.btnScheduled) {\r\n      this.btnScheduled.classList.toggle('show', isInputEmpty);\r\n    }\r\n\r\n    if(this.btnToggleReplyMarkup) {\r\n      this.btnToggleReplyMarkup.classList.toggle('show', isInputEmpty);\r\n    }\r\n  }\r\n\r\n  public onMessageSent(clearInput = true, clearReply?: boolean) {\r\n    if(this.chat.type !== 'scheduled') {\r\n      this.managers.appMessagesManager.readAllHistory(this.chat.peerId, this.chat.threadId, true);\r\n    }\r\n\r\n    this.scheduleDate = undefined;\r\n    this.sendSilent = undefined;\r\n\r\n    const value = this.messageInputField.value;\r\n    const entities = parseEntities(value);\r\n    const emojiEntities: MessageEntity.messageEntityEmoji[] = entities.filter((entity) => entity._ === 'messageEntityEmoji') as any;\r\n    emojiEntities.forEach((entity) => {\r\n      const emoji = emojiFromCodePoints(entity.unicode);\r\n      this.managers.appEmojiManager.pushRecentEmoji(emoji);\r\n    });\r\n\r\n    if(clearInput) {\r\n      this.lastUrl = '';\r\n      delete this.noWebPage;\r\n      this.willSendWebPage = null;\r\n      this.clearInput();\r\n    }\r\n\r\n    if(clearReply || clearInput) {\r\n      this.clearHelper();\r\n    }\r\n\r\n    this.updateSendBtn();\r\n  }\r\n\r\n  public sendMessage(force = false) {\r\n    const {editMsgId, chat} = this;\r\n    if(chat.type === 'scheduled' && !force && !editMsgId) {\r\n      this.scheduleSending();\r\n      return;\r\n    }\r\n\r\n    const {peerId} = chat;\r\n    const {noWebPage} = this;\r\n    const sendingParams = this.chat.getMessageSendingParams();\r\n\r\n    const {value, entities} = getRichValue(this.messageInputField.input);\r\n\r\n    //return;\r\n    if(editMsgId) {\r\n      const message = this.editMessage;\r\n      if(value.trim() || message.media) {\r\n        this.managers.appMessagesManager.editMessage(message, value, {\r\n          entities,\r\n          noWebPage: noWebPage\r\n        });\r\n\r\n        this.onMessageSent();\r\n      } else {\r\n        new PopupDeleteMessages(peerId, [editMsgId], chat.type);\r\n\r\n        return;\r\n      }\r\n    } else if(value.trim()) {\r\n      this.managers.appMessagesManager.sendText(peerId, value, {\r\n        entities,\r\n        ...sendingParams,\r\n        noWebPage: noWebPage,\r\n        webPage: this.getWebPagePromise ? undefined : this.willSendWebPage,\r\n        clearDraft: true\r\n      });\r\n\r\n      if(this.chat.type === 'scheduled') {\r\n        this.onMessageSent(true);\r\n      } else {\r\n        this.onMessageSent(false, false);\r\n      }\r\n      // this.onMessageSent();\r\n    }\r\n\r\n    // * wait for sendText set messageId for invokeAfterMsg\r\n    if(this.forwarding) {\r\n      const forwarding = copy(this.forwarding);\r\n      // setTimeout(() => {\r\n        for(const fromPeerId in forwarding) {\r\n          this.managers.appMessagesManager.forwardMessages(peerId, fromPeerId.toPeerId(), forwarding[fromPeerId], {\r\n            ...sendingParams,\r\n            dropAuthor: this.forwardElements && this.forwardElements.hideSender.checkboxField.checked,\r\n            dropCaptions: this.isDroppingCaptions()\r\n          });\r\n        }\r\n\r\n        if(!value) {\r\n          this.onMessageSent();\r\n        }\r\n      // }, 0);\r\n    }\r\n\r\n    // this.onMessageSent();\r\n  }\r\n\r\n  public async sendMessageWithDocument(document: MyDocument | string, force = false, clearDraft = false) {\r\n    document = await this.managers.appDocsManager.getDoc(document);\r\n\r\n    const flag = document.type === 'sticker' ? 'send_stickers' : (document.type === 'gif' ? 'send_gifs' : 'send_media');\r\n    if(this.chat.peerId.isAnyChat() && !(await this.chat.canSend(flag))) {\r\n      toast(POSTING_MEDIA_NOT_ALLOWED);\r\n      return false;\r\n    }\r\n\r\n    if(this.chat.type === 'scheduled' && !force) {\r\n      this.scheduleSending(() => this.sendMessageWithDocument(document, true, clearDraft));\r\n      return false;\r\n    }\r\n\r\n    if(document) {\r\n      this.managers.appMessagesManager.sendFile(this.chat.peerId, document, {\r\n        ...this.chat.getMessageSendingParams(),\r\n        isMedia: true, \r\n        clearDraft: clearDraft || undefined\r\n      });\r\n      this.onMessageSent(clearDraft, true);\r\n\r\n      if(document.type === 'sticker') {\r\n        emoticonsDropdown.stickersTab?.pushRecentSticker(document);\r\n      }\r\n\r\n      return true;\r\n    }\r\n    \r\n    return false;\r\n  }\r\n\r\n  private canToggleHideAuthor() {\r\n    const {forwardElements} = this;\r\n    if(!forwardElements) return false;\r\n    const hideCaptionCheckboxField = forwardElements.hideCaption.checkboxField;\r\n    return !hideCaptionCheckboxField.checked ||\r\n      findUpTag(hideCaptionCheckboxField.label, 'FORM').classList.contains('hide');\r\n  }\r\n\r\n  private isDroppingCaptions() {\r\n    return !this.canToggleHideAuthor();\r\n  }\r\n\r\n  /* public sendSomething(callback: () => void, force = false) {\r\n    if(this.chat.type === 'scheduled' && !force) {\r\n      this.scheduleSending(() => this.sendSomething(callback, true));\r\n      return false;\r\n    }\r\n\r\n    callback();\r\n    this.onMessageSent(false, true);\r\n\r\n    return true;\r\n  } */\r\n\r\n  public async initMessageEditing(mid: number) {\r\n    const message = (await this.chat.getMessage(mid)) as Message.message;\r\n\r\n    let input = documentFragmentToHTML(wrapDraftText(message.message, {entities: message.totalEntities}));\r\n    const f = async() => {\r\n      const replyFragment = await wrapMessageForReply(message, undefined, [message.mid]);\r\n      this.setTopInfo('edit', f, i18n('AccDescrEditing'), replyFragment, input, message);\r\n\r\n      this.editMsgId = mid;\r\n      this.editMessage = message;\r\n      input = undefined;\r\n    };\r\n    f();\r\n  }\r\n\r\n  public initMessagesForward(fromPeerIdsMids: {[fromPeerId: PeerId]: number[]}) {\r\n    const f = async() => {\r\n      //const peerTitles: string[]\r\n      const fromPeerIds = Object.keys(fromPeerIdsMids).map((fromPeerId) => fromPeerId.toPeerId());\r\n      const smth: Set<string> = new Set();\r\n      let length = 0, messagesWithCaptionsLength = 0;\r\n\r\n      const p = fromPeerIds.map(async(fromPeerId) => {\r\n        const mids = fromPeerIdsMids[fromPeerId];\r\n        const promises = mids.map(async(mid) => {\r\n          const message = (await this.managers.appMessagesManager.getMessageByPeer(fromPeerId, mid)) as Message.message;\r\n          if(message.fwd_from?.from_name && !message.fromId && !message.fwdFromId) {\r\n            smth.add('N' + message.fwd_from.from_name);\r\n          } else {\r\n            smth.add('P' + message.fromId);\r\n          }\r\n\r\n          if(message.media && message.message) {\r\n            ++messagesWithCaptionsLength;\r\n          }\r\n        });\r\n\r\n        await Promise.all(promises);\r\n\r\n        length += mids.length;\r\n      });\r\n\r\n      await Promise.all(p);\r\n\r\n      const onlyFirstName = smth.size > 2;\r\n      const peerTitles = [...smth].map((smth) => {\r\n        const type = smth[0];\r\n        smth = smth.slice(1);\r\n        if(type === 'P') {\r\n          const peerId = smth.toPeerId();\r\n          return peerId === rootScope.myId ? i18n('Chat.Accessory.Forward.You') : new PeerTitle({peerId, dialog: false, onlyFirstName}).element;\r\n        } else {\r\n          return onlyFirstName ? smth.split(' ')[0] : smth;\r\n        }\r\n      });\r\n\r\n      const {forwardElements} = this;\r\n      const form = findUpTag(forwardElements.showCaption.checkboxField.label, 'FORM');\r\n      form.classList.toggle('hide', !messagesWithCaptionsLength);\r\n      const hideCaption = forwardElements.hideCaption.checkboxField.checked;\r\n      if(messagesWithCaptionsLength && hideCaption) {\r\n        forwardElements.hideSender.checkboxField.setValueSilently(true);\r\n      } else if(this.forwardWasDroppingAuthor !== undefined) {\r\n        (this.forwardWasDroppingAuthor ? forwardElements.hideSender : forwardElements.showSender).checkboxField.setValueSilently(true);\r\n      }\r\n\r\n      const titleKey: LangPackKey = forwardElements.showSender.checkboxField.checked ? 'Chat.Accessory.Forward' : 'Chat.Accessory.Hidden';\r\n      const title = i18n(titleKey, [length]);\r\n\r\n      const senderTitles = document.createDocumentFragment();\r\n      if(peerTitles.length < 3) {\r\n        senderTitles.append(...join(peerTitles, false));\r\n      } else {\r\n        senderTitles.append(peerTitles[0], i18n('AndOther', [peerTitles.length - 1]));\r\n      }\r\n\r\n      let firstMessage: Message.message, usingFullAlbum: boolean;\r\n      if(fromPeerIds.length === 1) {\r\n        const fromPeerId = fromPeerIds[0];\r\n        const mids = fromPeerIdsMids[fromPeerId];\r\n        firstMessage = (await this.managers.appMessagesManager.getMessageByPeer(fromPeerId, mids[0])) as Message.message;\r\n  \r\n        usingFullAlbum = !!firstMessage.grouped_id;\r\n        if(usingFullAlbum) {\r\n          const albumMids = await this.managers.appMessagesManager.getMidsByMessage(firstMessage);\r\n          if(albumMids.length !== length || albumMids.find((mid) => !mids.includes(mid))) {\r\n            usingFullAlbum = false;\r\n          }\r\n        }\r\n      }\r\n\r\n      const subtitleFragment = document.createDocumentFragment();\r\n      const delimiter = ': ';\r\n      if(usingFullAlbum || length === 1) {\r\n        const mids = fromPeerIdsMids[fromPeerIds[0]];\r\n        const replyFragment = await wrapMessageForReply(firstMessage, undefined, mids);\r\n        subtitleFragment.append(\r\n          senderTitles, \r\n          delimiter, \r\n          replyFragment\r\n        );\r\n      } else {\r\n        subtitleFragment.append(\r\n          i18n('Chat.Accessory.Forward.From'), \r\n          delimiter, \r\n          senderTitles\r\n        );\r\n      }\r\n  \r\n      let newReply = this.setTopInfo('forward', f, title, subtitleFragment);\r\n\r\n      forwardElements.modifyArgs.forEach((b, idx) => {\r\n        const text = b.textElement;\r\n        const intl: I18n.IntlElement = I18n.weakMap.get(text) as any;\r\n        intl.args = [idx < 2 ? fromPeerIds.length : messagesWithCaptionsLength];\r\n        intl.update();\r\n      });\r\n\r\n      if(this.forwardHover) {\r\n        this.forwardHover.attachButtonListener(newReply, this.listenerSetter);\r\n      }\r\n\r\n      this.forwarding = fromPeerIdsMids;\r\n    };\r\n    \r\n    f();\r\n  }\r\n\r\n  public async initMessageReply(mid: number) {\r\n    if(this.replyToMsgId === mid) {\r\n      return;\r\n    }\r\n    \r\n    let message = await this.chat.getMessage(mid);\r\n    const f = () => {\r\n      let peerTitleEl: HTMLElement;\r\n      if(!message) { // load missing replying message\r\n        peerTitleEl = i18n('Loading');\r\n\r\n        this.managers.appMessagesManager.wrapSingleMessage(this.chat.peerId, mid).then((_message) => {\r\n          if(this.replyToMsgId !== mid) {\r\n            return;\r\n          }\r\n\r\n          message = _message;\r\n          if(!message) {\r\n            this.clearHelper('reply');\r\n          } else {\r\n            f();\r\n          }\r\n        });\r\n      } else {\r\n        peerTitleEl = new PeerTitle({\r\n          peerId: message.fromId,\r\n          dialog: false\r\n        }).element;\r\n      }\r\n\r\n      this.setTopInfo('reply', f, peerTitleEl, message && (message as Message.message).message, undefined, message);\r\n      this.replyToMsgId = mid;\r\n    };\r\n    f();\r\n  }\r\n\r\n  public clearHelper(type?: ChatInputHelperType) {\r\n    if(this.helperType === 'edit' && type !== 'edit') {\r\n      this.clearInput();\r\n    }\r\n\r\n    if(type) {\r\n      this.lastUrl = '';\r\n      delete this.noWebPage;\r\n      this.willSendWebPage = null;\r\n    }\r\n    \r\n    if(type !== 'reply') {\r\n      this.replyToMsgId = undefined;\r\n      this.forwarding = undefined;\r\n    }\r\n\r\n    this.editMsgId = this.editMessage = undefined;\r\n    this.helperType = this.helperFunc = undefined;\r\n\r\n    if(this.chat.container.classList.contains('is-helper-active')) {\r\n      appNavigationController.removeByType('input-helper');\r\n      this.chat.container.classList.remove('is-helper-active');\r\n      this.t();\r\n    }\r\n  }\r\n\r\n  private t() {\r\n    const className = 'is-toggling-helper';\r\n    SetTransition(this.chat.container, className, true, 150, () => {\r\n      this.chat.container.classList.remove(className);\r\n    });\r\n  }\r\n\r\n  public setInputValue(value: string, clear = true, focus = true) {\r\n    if(!value) value = '';\r\n\r\n    if(clear) this.clearInput(false, false, value);\r\n    else this.messageInputField.setValueSilently(value);\r\n\r\n    fastRaf(() => {\r\n      focus && placeCaretAtEnd(this.messageInput);\r\n      this.onMessageInput();\r\n      this.messageInput.scrollTop = this.messageInput.scrollHeight;\r\n    });\r\n  }\r\n\r\n  public setTopInfo(\r\n    type: ChatInputHelperType, \r\n    callerFunc: () => void, \r\n    title: Parameters<typeof wrapReply>[0] = '', \r\n    subtitle: Parameters<typeof wrapReply>[1] = '', \r\n    input?: string, \r\n    message?: any\r\n  ) {\r\n    if(this.willSendWebPage && type === 'reply') {\r\n      return;\r\n    }\r\n\r\n    if(type !== 'webpage') {\r\n      this.clearHelper(type);\r\n      this.helperType = type;\r\n      this.helperFunc = callerFunc;\r\n    }\r\n    \r\n    const replyParent = this.replyElements.container;\r\n    const oldReply = replyParent.lastElementChild.previousElementSibling;\r\n    const haveReply = oldReply.classList.contains('reply');\r\n\r\n    this.replyElements.iconBtn.replaceWith(this.replyElements.iconBtn = ButtonIcon((type === 'webpage' ? 'link' : type) + ' active reply-icon', {noRipple: true}));\r\n    const {container} = wrapReply(title, subtitle, message);\r\n    if(haveReply) {\r\n      oldReply.replaceWith(container);\r\n    } else {\r\n      replyParent.insertBefore(container, replyParent.lastElementChild);\r\n    }\r\n\r\n    if(type === 'webpage') {\r\n      container.style.cursor = 'default';\r\n    }\r\n\r\n    if(!this.chat.container.classList.contains('is-helper-active')) {\r\n      this.chat.container.classList.add('is-helper-active');\r\n      this.t();\r\n    }\r\n\r\n    /* const scroll = appImManager.scrollable;\r\n    if(scroll.isScrolledDown && !scroll.scrollLocked && !appImManager.messagesQueuePromise && !appImManager.setPeerPromise) {\r\n      scroll.scrollTo(scroll.scrollHeight, 'top', true, true, 200);\r\n    } */\r\n\r\n    if(!IS_MOBILE) {\r\n      appNavigationController.pushItem({\r\n        type: 'input-helper',\r\n        onPop: () => {\r\n          this.onHelperCancel();\r\n        }\r\n      });\r\n    }\r\n\r\n    if(input !== undefined) {\r\n      this.setInputValue(input);\r\n    }\r\n\r\n    setTimeout(() => {\r\n      this.updateSendBtn();\r\n    }, 0);\r\n\r\n    return container;\r\n  }\r\n\r\n  // public saveScroll() {\r\n  //   this.scrollTop = this.chat.bubbles.scrollable.container.scrollTop;\r\n  //   this.scrollOffsetTop = this.chatInput.offsetTop;\r\n  // }\r\n\r\n  // public restoreScroll() {\r\n  //   if(this.chatInput.style.display) return;\r\n  //   //console.log('input resize', offsetTop, this.chatInput.offsetTop);\r\n  //   let newOffsetTop = this.chatInput.offsetTop;\r\n  //   let container = this.chat.bubbles.scrollable.container;\r\n  //   let scrollTop = container.scrollTop;\r\n  //   let clientHeight = container.clientHeight;\r\n  //   let maxScrollTop = container.scrollHeight;\r\n\r\n  //   if(newOffsetTop < this.scrollOffsetTop) {\r\n  //     this.scrollDiff = this.scrollOffsetTop - newOffsetTop;\r\n  //     container.scrollTop += this.scrollDiff;\r\n  //   } else if(scrollTop !== this.scrollTop) {\r\n  //     let endDiff = maxScrollTop - (scrollTop + clientHeight);\r\n  //     if(endDiff < this.scrollDiff/*  && false */) {\r\n  //       //container.scrollTop -= endDiff;\r\n  //     } else {\r\n  //       container.scrollTop -= this.scrollDiff;\r\n  //     }\r\n  //   }\r\n  // }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport documentFragmentToHTML from \"../../helpers/dom/documentFragmentToHTML\";\r\nimport { DraftMessage } from \"../../layer\";\r\nimport mergeEntities from \"../../lib/richTextProcessor/mergeEntities\";\r\nimport parseEntities from \"../../lib/richTextProcessor/parseEntities\";\r\nimport wrapDraftText from \"../../lib/richTextProcessor/wrapDraftText\";\r\n\r\nexport default function wrapDraft(draft: DraftMessage.draftMessage) {\r\n  const myEntities = parseEntities(draft.message);\r\n  const apiEntities = draft.entities || [];\r\n  const totalEntities = mergeEntities(apiEntities.slice(), myEntities); // ! only in this order, otherwise bold and emoji formatting won't work\r\n\r\n  return documentFragmentToHTML(wrapDraftText(draft.message, {entities: totalEntities}));\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function setCaretAt(node: Node) {\r\n  // node.appendChild(document.createTextNode(''));\r\n\r\n  const originalNode = node;\r\n  node = node.previousSibling;\r\n\r\n  if(node.nodeType === 1) {\r\n    const newNode = document.createTextNode('');\r\n    node.parentNode.insertBefore(newNode, !originalNode.nextSibling || originalNode.nextSibling.nodeType === node.nodeType ? originalNode : originalNode.nextSibling);\r\n    node = newNode;\r\n  }\r\n\r\n  if(window.getSelection && document.createRange) {\r\n    const range = document.createRange();\r\n    if(node) {\r\n      range.setStartAfter(node);\r\n      range.insertNode(node);\r\n      range.setStart(node, node.nodeValue.length);\r\n    }\r\n\r\n    range.collapse(true);\r\n\r\n    const sel = window.getSelection();\r\n    sel.removeAllRanges();\r\n    sel.addRange(range);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type Chat from \"./chat\";\r\nimport type ChatTopbar from \"./topbar\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport DivAndCaption from \"../divAndCaption\";\r\nimport ripple from \"../ripple\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport { Message } from \"../../layer\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\n\r\nconst classNames: string[] = ['is-pinned-message-shown', 'is-pinned-audio-shown'];\r\nconst CLASSNAME_BASE = 'pinned-container';\r\nconst HEIGHT = 52;\r\n\r\nexport default class PinnedContainer {\r\n  public wrapperUtils: HTMLElement;\r\n  public btnClose: HTMLElement;\r\n  protected wrapper: HTMLElement;\r\n\r\n  protected topbar: ChatTopbar;\r\n  protected chat: Chat;\r\n  protected listenerSetter: ListenerSetter;\r\n  public className: string;\r\n  public divAndCaption: DivAndCaption<(title: string | HTMLElement | DocumentFragment, subtitle: string | HTMLElement | DocumentFragment, message?: any) => void>;\r\n  \r\n  protected floating = false;\r\n\r\n  public onClose?: () => void | Promise<boolean>;\r\n\r\n  constructor(options: {\r\n    topbar: PinnedContainer['topbar'],\r\n    chat: PinnedContainer['chat'],\r\n    listenerSetter: PinnedContainer['listenerSetter'],\r\n    className: PinnedContainer['className'],\r\n    divAndCaption: PinnedContainer['divAndCaption'],\r\n    onClose?: PinnedContainer['onClose'],\r\n    floating?: PinnedContainer['floating']\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    const {divAndCaption, className} = this;\r\n    divAndCaption.container.classList.add(CLASSNAME_BASE, 'hide');\r\n    divAndCaption.title.classList.add(CLASSNAME_BASE + '-title');\r\n    divAndCaption.subtitle.classList.add(CLASSNAME_BASE + '-subtitle');\r\n    divAndCaption.content.classList.add(CLASSNAME_BASE + '-content');\r\n    \r\n    this.btnClose = document.createElement('button');\r\n    this.btnClose.classList.add(CLASSNAME_BASE + '-close', `pinned-${className}-close`, 'btn-icon', 'tgico-close');\r\n    \r\n    this.wrapper = document.createElement('div');\r\n    this.wrapper.classList.add(CLASSNAME_BASE + '-wrapper');\r\n    ripple(this.wrapper);\r\n\r\n    this.wrapperUtils = document.createElement('div');\r\n    this.wrapperUtils.classList.add(CLASSNAME_BASE + '-wrapper-utils');\r\n    this.wrapperUtils.append(this.btnClose);\r\n\r\n    this.wrapper.append(...Array.from(divAndCaption.container.children), this.wrapperUtils);\r\n\r\n    divAndCaption.container.append(this.wrapper/* , this.close */);\r\n\r\n    this.attachOnCloseEvent(this.btnClose);\r\n  }\r\n\r\n  public attachOnCloseEvent(elem: HTMLElement) {\r\n    attachClickEvent(elem, (e) => {\r\n      cancelEvent(e);\r\n\r\n      ((this.onClose ? this.onClose() : null) || Promise.resolve(true)).then((needClose) => {\r\n        if(needClose) {\r\n          this.toggle(true);\r\n        }\r\n      });\r\n    }, {listenerSetter: this.listenerSetter});\r\n  }\r\n\r\n  public toggle(hide?: boolean) {\r\n    const isHidden = this.divAndCaption.container.classList.contains('hide');\r\n    if(hide === undefined) {\r\n      hide = !isHidden;\r\n    } else if(hide === isHidden) {\r\n      return;\r\n    }\r\n\r\n    // const scrollable = this.chat.bubbles.scrollable;\r\n    \r\n    const isFloating = (this.floating || mediaSizes.isMobile) && !hide;\r\n    // const scrollTop = isFloating || this.divAndCaption.container.classList.contains('is-floating') ? scrollable.scrollTop : undefined;\r\n\r\n    this.divAndCaption.container.classList.toggle('is-floating', isFloating);\r\n    this.divAndCaption.container.classList.toggle('hide', hide);\r\n    \r\n    this.topbar.container.classList.toggle('is-pinned-floating', isFloating);\r\n    this.topbar.container.classList.toggle(`is-pinned-${this.className}-shown`, !hide);\r\n    \r\n    // const active = classNames.filter((className) => this.topbar.container.classList.contains(className));\r\n    // const maxActive = hide ? 0 : 1;\r\n    \r\n    // * not sure when it became unneeded\r\n    // if(scrollTop !== undefined && active.length <= maxActive/*  && !scrollable.isScrolledDown */) {\r\n    //   scrollable.scrollTop = scrollTop + ((hide ? -1 : 1) * HEIGHT);\r\n    // }\r\n    \r\n    this.topbar.setFloating();\r\n    this.topbar.setUtilsWidth();\r\n  }\r\n\r\n  public isVisible() {\r\n    return !this.divAndCaption.container.classList.contains('hide');\r\n  }\r\n\r\n  public isFloating() {\r\n    return this.divAndCaption.container.classList.contains('is-floating');\r\n  }\r\n\r\n  public fill(title: string | HTMLElement | DocumentFragment, subtitle: string | HTMLElement | DocumentFragment, message: Message.message) {\r\n    this.divAndCaption.container.dataset.peerId = '' + message.peerId;\r\n    this.divAndCaption.container.dataset.mid = '' + message.mid;\r\n    this.divAndCaption.fill(title, subtitle, message);\r\n    this.topbar.setUtilsWidth();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport appMediaPlaybackController from \"./appMediaPlaybackController\";\r\nimport RangeSelector from \"./rangeSelector\";\r\n\r\nexport default class VolumeSelector extends RangeSelector {\r\n  private static ICONS = ['volume_off', 'volume_mute', 'volume_down', 'volume_up'];\r\n  public btn: HTMLElement;\r\n  protected icon: HTMLSpanElement;\r\n\r\n  constructor(protected listenerSetter: ListenerSetter, protected vertical = false) {\r\n    super({\r\n      step: 0.01, \r\n      min: 0, \r\n      max: 1,\r\n      vertical\r\n    }, 1);\r\n\r\n    this.setListeners();\r\n    this.setHandlers({\r\n      onScrub: currentTime => {\r\n        const value = Math.max(Math.min(currentTime, 1), 0);\r\n\r\n        //console.log('volume scrub:', currentTime, value);\r\n\r\n        appMediaPlaybackController.muted = false;\r\n        appMediaPlaybackController.volume = value;\r\n      },\r\n\r\n      /* onMouseUp: (e) => {\r\n        cancelEvent(e.event);\r\n      } */\r\n    });\r\n\r\n    const className = 'player-volume';\r\n    const btn = this.btn = document.createElement('div');\r\n    btn.classList.add('btn-icon', className);\r\n    const icon = this.icon = document.createElement('span');\r\n    icon.classList.add(className + '__icon');\r\n\r\n    btn.append(icon, this.container);\r\n\r\n    attachClickEvent(icon, this.onMuteClick, {listenerSetter: this.listenerSetter});\r\n    this.listenerSetter.add(appMediaPlaybackController)('playbackParams', this.setVolume);\r\n\r\n    this.setVolume();\r\n  }\r\n\r\n  private onMuteClick = (e?: Event) => {\r\n    e && cancelEvent(e);\r\n    appMediaPlaybackController.muted = !appMediaPlaybackController.muted;\r\n  };\r\n\r\n  public setVolume = () => {\r\n    // const volume = video.volume;\r\n    const {volume, muted} = appMediaPlaybackController;\r\n    let d: string;\r\n    let iconIndex: number;\r\n    if(!volume || muted) {\r\n      iconIndex = 0;\r\n    } else if(volume > .5) {\r\n      iconIndex = 3;\r\n    } else if(volume > 0 && volume < .25) {\r\n      iconIndex = 1;\r\n    } else {\r\n      iconIndex = 2;\r\n    }\r\n\r\n    VolumeSelector.ICONS.forEach((icon) => this.icon.classList.remove('tgico-' + icon));\r\n    this.icon.classList.add('tgico-' + VolumeSelector.ICONS[iconIndex]);\r\n\r\n    if(!this.mousedown) {\r\n      this.setProgress(muted ? 0 : volume);\r\n    }\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { AppMessagesManager } from \"../../lib/appManagers/appMessagesManager\";\r\nimport type ChatTopbar from \"./topbar\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport appMediaPlaybackController, { AppMediaPlaybackController } from \"../appMediaPlaybackController\";\r\nimport DivAndCaption from \"../divAndCaption\";\r\nimport PinnedContainer from \"./pinnedContainer\";\r\nimport Chat from \"./chat\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport { formatFullSentTime } from \"../../helpers/date\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport { DocumentAttribute } from \"../../layer\";\r\nimport MediaProgressLine from \"../mediaProgressLine\";\r\nimport VolumeSelector from \"../volumeSelector\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nexport default class ChatAudio extends PinnedContainer {\r\n  private toggleEl: HTMLElement;\r\n  private progressLine: MediaProgressLine;\r\n  private volumeSelector: VolumeSelector;\r\n  private fasterEl: HTMLElement;\r\n  private repeatEl: HTMLButtonElement;\r\n\r\n  constructor(protected topbar: ChatTopbar, protected chat: Chat, protected managers: AppManagers) {\r\n    super({\r\n      topbar, \r\n      chat, \r\n      listenerSetter: topbar.listenerSetter, \r\n      className: 'audio', \r\n      divAndCaption: new DivAndCaption(\r\n        'pinned-audio', \r\n        (title: string | HTMLElement | DocumentFragment, subtitle: string | HTMLElement | DocumentFragment) => {\r\n          replaceContent(this.divAndCaption.title, title);\r\n          replaceContent(this.divAndCaption.subtitle, subtitle);\r\n        }\r\n      ), \r\n      onClose: () => {\r\n        appMediaPlaybackController.stop();\r\n      },\r\n      floating: true\r\n    });\r\n\r\n    this.divAndCaption.border.remove();\r\n\r\n    const prevEl = ButtonIcon('fast_rewind active', {noRipple: true});\r\n    const nextEl = ButtonIcon('fast_forward active', {noRipple: true});\r\n\r\n    const attachClick = (elem: HTMLElement, callback: () => void) => {\r\n      attachClickEvent(elem, (e) => {\r\n        cancelEvent(e);\r\n        callback();\r\n      }, {listenerSetter: this.topbar.listenerSetter});\r\n    };\r\n\r\n    attachClick(prevEl, () => {\r\n      appMediaPlaybackController.previous();\r\n    });\r\n\r\n    attachClick(nextEl, () => {\r\n      appMediaPlaybackController.next();\r\n    });\r\n\r\n    this.toggleEl = ButtonIcon('', {noRipple: true});\r\n    this.toggleEl.classList.add('active', 'pinned-audio-ico', 'tgico');\r\n    attachClick(this.toggleEl, () => {\r\n      appMediaPlaybackController.toggle();\r\n    });\r\n    this.wrapper.prepend(this.wrapper.firstElementChild, prevEl, this.toggleEl, nextEl);\r\n\r\n    this.volumeSelector = new VolumeSelector(this.listenerSetter, true);\r\n    const volumeProgressLineContainer = document.createElement('div');\r\n    volumeProgressLineContainer.classList.add('progress-line-container');\r\n    volumeProgressLineContainer.append(this.volumeSelector.container);\r\n    const tunnel = document.createElement('div');\r\n    tunnel.classList.add('pinned-audio-volume-tunnel');\r\n    this.volumeSelector.btn.classList.add('pinned-audio-volume', 'active');\r\n    this.volumeSelector.btn.prepend(tunnel);\r\n    this.volumeSelector.btn.append(volumeProgressLineContainer);\r\n\r\n    this.repeatEl = ButtonIcon('audio_repeat', {noRipple: true});\r\n    attachClick(this.repeatEl, () => {\r\n      const params = appMediaPlaybackController.getPlaybackParams();\r\n      if(!params.round) {\r\n        appMediaPlaybackController.round = true;\r\n      } else if(params.loop) {\r\n        appMediaPlaybackController.round = false;\r\n        appMediaPlaybackController.loop = false;\r\n      } else {\r\n        appMediaPlaybackController.loop = !appMediaPlaybackController.loop;\r\n      }\r\n    });\r\n\r\n    const fasterEl = this.fasterEl = ButtonIcon('playback_2x', {noRipple: true});\r\n    attachClick(fasterEl, () => {\r\n      appMediaPlaybackController.playbackRate = fasterEl.classList.contains('active') ? 1 : 1.75;\r\n    });\r\n\r\n    this.wrapperUtils.prepend(this.volumeSelector.btn, fasterEl, this.repeatEl);\r\n\r\n    const progressWrapper = document.createElement('div');\r\n    progressWrapper.classList.add('pinned-audio-progress-wrapper');\r\n\r\n    this.progressLine = new MediaProgressLine(undefined, undefined, true, true);\r\n    this.progressLine.container.classList.add('pinned-audio-progress');\r\n    progressWrapper.append(this.progressLine.container);\r\n    this.wrapper.insertBefore(progressWrapper, this.wrapperUtils);\r\n\r\n    this.topbar.listenerSetter.add(appMediaPlaybackController)('play', this.onMediaPlay);\r\n    this.topbar.listenerSetter.add(appMediaPlaybackController)('pause', this.onPause);\r\n    this.topbar.listenerSetter.add(appMediaPlaybackController)('stop', this.onStop);\r\n    this.topbar.listenerSetter.add(appMediaPlaybackController)('playbackParams', this.onPlaybackParams);\r\n\r\n    const playingDetails = appMediaPlaybackController.getPlayingDetails();\r\n    if(playingDetails) {\r\n      this.onMediaPlay(playingDetails);\r\n      this.onPlaybackParams(playingDetails.playbackParams);\r\n    }\r\n  }\r\n\r\n  public destroy() {\r\n    if(this.progressLine) {\r\n      this.progressLine.removeListeners();\r\n    }\r\n  }\r\n\r\n  private onPlaybackParams = (playbackParams: ReturnType<AppMediaPlaybackController['getPlaybackParams']>) => {\r\n    this.fasterEl.classList.toggle('active', playbackParams.playbackRate > 1);\r\n\r\n    this.repeatEl.classList.remove('tgico-audio_repeat', 'tgico-audio_repeat_single');\r\n    this.repeatEl.classList.add(playbackParams.loop ? 'tgico-audio_repeat_single' : 'tgico-audio_repeat');\r\n    this.repeatEl.classList.toggle('active', playbackParams.loop || playbackParams.round);\r\n  };\r\n\r\n  private onPause = () => {\r\n    this.toggleEl.classList.remove('flip-icon');\r\n  };\r\n\r\n  private onStop = () => {\r\n    this.toggle(true);\r\n  };\r\n  \r\n  private onMediaPlay = ({doc, message, media, playbackParams}: ReturnType<AppMediaPlaybackController['getPlayingDetails']>) => {\r\n    let title: string | HTMLElement | DocumentFragment, subtitle: string | HTMLElement | DocumentFragment;\r\n    const isMusic = doc.type !== 'voice' && doc.type !== 'round';\r\n    if(!isMusic) {\r\n      title = new PeerTitle({peerId: message.fromId, fromName: message.fwd_from?.from_name}).element;\r\n\r\n      //subtitle = 'Voice message';\r\n      subtitle = formatFullSentTime(message.date);\r\n    } else {\r\n      const audioAttribute = doc.attributes.find((attr) => attr._ === 'documentAttributeAudio') as DocumentAttribute.documentAttributeAudio;\r\n      title = wrapEmojiText(audioAttribute?.title ?? doc.file_name);\r\n      subtitle = audioAttribute?.performer ? wrapEmojiText(audioAttribute.performer) : i18n('AudioUnknownArtist');\r\n    }\r\n\r\n    this.fasterEl.classList.toggle('hide', isMusic);\r\n    this.repeatEl.classList.toggle('hide', !isMusic);\r\n\r\n    this.onPlaybackParams(playbackParams);\r\n    this.volumeSelector.setVolume();\r\n\r\n    this.progressLine.setMedia(media);\r\n\r\n    this.fill(title, subtitle, message);\r\n    // this.toggleEl.classList.add('flip-icon');\r\n    this.toggleEl.classList.toggle('flip-icon', !media.paused);\r\n    this.toggle(false);\r\n  };\r\n}\r\n","// https://github.com/evgeny-nadymov/telegram-react/blob/master/src/Components/ColumnMiddle/PinnedMessageBorder.js\r\n\r\nenum BAR_HEIGHTS {\r\n  ONE = 32,\r\n  TWO = 15,\r\n  THREE = 10,\r\n  FOUR = 8,\r\n  MORE = 8\r\n};\r\n\r\nconst GAP = 1;\r\nconst WIDTH = 2;\r\nconst BASE_CLASS = 'pinned-message-border';\r\n\r\nexport default class PinnedMessageBorder {\r\n  private border: HTMLElement;\r\n  private wrapper: HTMLElement;\r\n  private svg: SVGSVGElement;\r\n  private defs: SVGDefsElement;\r\n  private clipPath: SVGClipPathElement;\r\n  private path: SVGPathElement;\r\n  private mark: HTMLElement;\r\n\r\n  private count: number;\r\n  private index: number;\r\n\r\n  private drawRect = (x: number, y: number, width: number, height: number, radius: number) => {\r\n    return `M${x},${y + radius}a${radius},${radius},0,0,1,${width},0v${height - 2 * radius}a${radius},${radius},0,0,1,${-width},0Z`;\r\n  };\r\n\r\n  private getClipPath = (id: string, barHeight: number, count: number) => {\r\n    const radius = 1;\r\n\r\n    let d = '';\r\n    /* if(count === 3) {\r\n      d = this.drawRect(0, 0, WIDTH, barHeight, radius)\r\n        + this.drawRect(0, barHeight + GAP, WIDTH, barHeight + 1, radius)\r\n        + this.drawRect(0, barHeight * 2 + GAP * 2 + 1, WIDTH, barHeight, radius);\r\n    } */if(count === 2) {\r\n      d = this.drawRect(0, 0, WIDTH, barHeight, radius) + this.drawRect(0, barHeight + GAP * 2, WIDTH, barHeight, radius);\r\n    } else {\r\n      for(let i = 0; i < count; ++i) {\r\n        d += this.drawRect(0, (barHeight + GAP) * i, WIDTH, barHeight, radius);\r\n      }\r\n    }\r\n\r\n    if(!this.clipPath) {\r\n      this.clipPath = document.createElementNS('http://www.w3.org/2000/svg', 'clipPath');\r\n      this.path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n\r\n      this.clipPath.append(this.path);\r\n    }\r\n\r\n    this.clipPath.id = id;\r\n    this.path.setAttributeNS(null, 'd', d);\r\n\r\n    return this.clipPath;\r\n  };\r\n\r\n  private getBarHeight = (count: number, index: number) => {\r\n    let barHeight: number;\r\n    if(count <= 1) {\r\n      barHeight = BAR_HEIGHTS.ONE;\r\n    } else if(count === 2) {\r\n      barHeight = BAR_HEIGHTS.TWO;\r\n    } else if(count === 3) {\r\n      barHeight = BAR_HEIGHTS.THREE;\r\n    } else if(count === 4) {\r\n      barHeight = BAR_HEIGHTS.FOUR;\r\n    } else if(count > 3) {\r\n      barHeight = BAR_HEIGHTS.MORE;\r\n    }\r\n\r\n    return barHeight;\r\n  };\r\n\r\n  private getMarkHeight = (count: number, index: number) => {\r\n    let markHeight: number;\r\n    if(count <= 1) {\r\n      markHeight = BAR_HEIGHTS.ONE;\r\n    } else if(count === 2) {\r\n      markHeight = BAR_HEIGHTS.TWO;\r\n    } else if(count === 3) {\r\n      markHeight = BAR_HEIGHTS.THREE;\r\n    } else if(count === 4) {\r\n      markHeight = BAR_HEIGHTS.FOUR;\r\n    } else if(count > 3) {\r\n      markHeight = BAR_HEIGHTS.MORE;\r\n    }\r\n\r\n    return markHeight;\r\n  };\r\n\r\n  private getMarkTranslateY = (index: number, barHeight: number, count: number) => {\r\n    if(count === 1) {\r\n      return 0;\r\n    } else if(count === 2) {\r\n      return !index ? 0 : barHeight + GAP;\r\n    }\r\n\r\n    if(count === 3) {\r\n      if(!index) {\r\n        return 0;\r\n      } else if(index === 1) {\r\n        return barHeight + GAP;\r\n      }\r\n\r\n      return barHeight * 2 + GAP * 2 + 1;\r\n    } else {\r\n      return (barHeight + GAP) * index;\r\n    }\r\n  };\r\n\r\n  private getTrackTranslateY = (index: number, count: number, barHeight: number, trackHeight: number) => {\r\n    if(count <= 4) {\r\n      return 0;\r\n    }\r\n\r\n    if(index <= 1) {\r\n      return 0;\r\n    } else if(index >= (count - 2)) {\r\n      return trackHeight - BAR_HEIGHTS.ONE - barHeight;\r\n    }\r\n\r\n    // return (index + 1) * barHeight + index * GAP;\r\n    return (index - 2) * barHeight + index * GAP;\r\n    //return (barHeight + GAP * 2) / 2 + (index - 2) * (barHeight + GAP);\r\n  };\r\n\r\n  private getTrackHeight = (count: number, barHeight: number) => {\r\n    return count <= 3 ? BAR_HEIGHTS.ONE : barHeight * count + GAP * (count - 1);\r\n  };\r\n\r\n  public render(count: number, index: number) {\r\n    if(!this.border) {\r\n      this.border = document.createElement('div');\r\n      this.border.classList.add(BASE_CLASS);\r\n\r\n      this.wrapper = document.createElement('div');\r\n      this.border.append(this.wrapper);\r\n    }\r\n    \r\n    if(count === 1) {\r\n      if(this.count !== count) {\r\n        this.wrapper.className = BASE_CLASS + '-wrapper-1';\r\n        this.border.classList.remove(BASE_CLASS + '-mask');\r\n        this.wrapper.innerHTML = this.wrapper.style.cssText = '';\r\n      }\r\n\r\n      return this.border;\r\n    }\r\n\r\n    const barHeight = this.getBarHeight(count, index);\r\n    const markHeight = this.getMarkHeight(count, index);\r\n    const trackHeight = this.getTrackHeight(count, barHeight);\r\n\r\n    const clipPathId = `clipPath_${count}`;\r\n    const clipPath = this.getClipPath(clipPathId, barHeight, count);\r\n\r\n    const markTranslateY = this.getMarkTranslateY(index, barHeight, count);\r\n    const trackTranslateY = this.getTrackTranslateY(index, count, barHeight, trackHeight);\r\n\r\n    this.border.classList.toggle(BASE_CLASS + '-mask', count > 4);\r\n\r\n    if(index <= 1) {\r\n      this.border.classList.add('mask-bottom');\r\n      this.border.classList.remove('mask-top');\r\n    } else if(index >= (count - 2)) {\r\n      this.border.classList.add('mask-top');\r\n      this.border.classList.remove('mask-bottom');\r\n    } else {\r\n      this.border.classList.add('mask-top', 'mask-bottom');\r\n    }\r\n\r\n    this.wrapper.className = BASE_CLASS + '-wrapper';\r\n    this.wrapper.style.cssText = `clip-path: url(#${clipPathId}); width: 2px; height: ${trackHeight}px; transform: translateY(-${trackTranslateY}px);`;\r\n    \r\n    if(!this.svg) {\r\n      this.svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\r\n      this.svg.setAttributeNS(null, 'height', '0');\r\n      this.svg.setAttributeNS(null, 'width', '0');\r\n  \r\n      this.defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');\r\n      this.defs.append(clipPath);\r\n\r\n      this.svg.append(this.defs);\r\n\r\n      this.mark = document.createElement('div');\r\n      this.mark.classList.add(BASE_CLASS + '-mark');\r\n    }\r\n\r\n    if(!this.svg.parentElement) {\r\n      this.wrapper.append(this.svg, this.mark);\r\n    }\r\n\r\n    this.mark.style.cssText = `height: ${markHeight}px; transform: translateY(${markTranslateY}px);`;\r\n    \r\n    this.count = count;\r\n    this.index = index;\r\n\r\n    return this.border;\r\n  }\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatTopbar from \"./topbar\";\r\nimport PopupPinMessage from \"../popups/unpinMessage\";\r\nimport PinnedContainer from \"./pinnedContainer\";\r\nimport PinnedMessageBorder from \"./pinnedMessageBorder\";\r\nimport ReplyContainer, { wrapReplyDivAndCaption } from \"./replyContainer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport Chat from \"./chat\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport { getHeavyAnimationPromise } from \"../../hooks/useHeavyAnimationCheck\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport handleScrollSideEvent from \"../../helpers/dom/handleScrollSideEvent\";\r\nimport debounce from \"../../helpers/schedulers/debounce\";\r\nimport throttle from \"../../helpers/schedulers/throttle\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport { Message } from \"../../layer\";\r\nimport { logger } from \"../../lib/logger\";\r\n\r\nclass AnimatedSuper {\r\n  static DURATION = 200;\r\n  static BASE_CLASS = 'animated-super';\r\n  container: HTMLDivElement;\r\n  rows: {[index: string]: {element: HTMLElement, timeout?: number, new?: true}} = {};\r\n  clearTimeout: number;\r\n\r\n  constructor() {\r\n    this.container = document.createElement('div');\r\n    this.container.className = AnimatedSuper.BASE_CLASS;\r\n  }\r\n\r\n  public getRow(index: number, animateFirst = false) {\r\n    if(this.rows[index]) return this.rows[index].element;\r\n    const row = document.createElement('div');\r\n    const isFirst = !Object.keys(this.rows).length && !animateFirst;\r\n    row.className = AnimatedSuper.BASE_CLASS + '-row' + (isFirst ? '' : ' is-hiding hide');\r\n    this.rows[index] = {element: row, new: true};\r\n    this.container.append(row);\r\n    return row;\r\n  }\r\n\r\n  public clearRow(index: number) {\r\n    if(!this.rows[index]) return;\r\n    this.rows[index].element.remove();\r\n    delete this.rows[index];\r\n  }\r\n\r\n  public clearRows(currentIndex?: number) {\r\n    if(this.clearTimeout) clearTimeout(this.clearTimeout);\r\n    this.clearTimeout = window.setTimeout(() => {\r\n      for(const i in this.rows) {\r\n        if(+i === currentIndex) continue;\r\n        this.clearRow(+i);\r\n      }\r\n    }, AnimatedSuper.DURATION);\r\n  }\r\n\r\n  public setNewRow(index: number, reflow = false) {\r\n    const row = this.rows[index];\r\n    if(row.new) {\r\n      if(reflow) {\r\n        row.element.classList.remove('hide');\r\n        void row.element.offsetLeft; // reflow\r\n      } else {\r\n        row.element.classList.remove('is-hiding', 'hide');\r\n      }\r\n\r\n      delete row.new;\r\n    }\r\n\r\n    this.clearRows(index);\r\n  }\r\n\r\n  public animate(index: number, previousIndex: number, fromTop = index > previousIndex, ignorePrevious = false) {\r\n    if(index === previousIndex) { // * handle if set index 0 and previousIndex 0\r\n      return this.setNewRow(index);\r\n    }\r\n\r\n    const row = this.rows[index];\r\n    const previousRow = this.rows[previousIndex];\r\n    if(!previousRow && !ignorePrevious) {\r\n      return this.setNewRow(index);\r\n    }\r\n\r\n    const sides = ['from-top', 'from-bottom'];\r\n    if(!fromTop) sides.reverse();\r\n\r\n    row.element.classList.add(sides[0]);\r\n    row.element.classList.remove(sides[1]);\r\n    if(previousRow) {\r\n      previousRow.element.classList.add(sides[1]);\r\n      previousRow.element.classList.remove(sides[0]);\r\n    }\r\n\r\n    if(row.new) {\r\n      this.setNewRow(index, true);\r\n    }\r\n\r\n    row.element.classList.toggle('is-hiding', false);\r\n    previousRow && previousRow.element.classList.toggle('is-hiding', true);\r\n\r\n    /* const height = row.element.getBoundingClientRect().height;\r\n    row.element.style.transform = `translateY(${fromTop ? height * -1 : height}px)`;\r\n    if(previousRow) {\r\n      previousRow.element.style.transform = `translateY(${fromTop ? height : height * -1}px)`;\r\n    } */\r\n\r\n    /* row.element.style.setProperty('--height', row.element.getBoundingClientRect().height + 'px');\r\n    if(previousRow) {\r\n      previousRow.element.style.setProperty('--height', previousRow.element.getBoundingClientRect().height + 'px');\r\n    } */\r\n    \r\n    this.clearRows(index);\r\n  }\r\n}\r\n\r\nclass AnimatedCounter {\r\n  static EMPTY_INDEX = -1;\r\n  static BASE_CLASS = 'animated-counter';\r\n  container: HTMLElement;\r\n  decimals: {\r\n    container: HTMLElement,\r\n    placeholder: HTMLElement,\r\n    animatedSuper: AnimatedSuper\r\n  }[] = [];\r\n  previousNumber = 0;\r\n  clearTimeout: number;\r\n\r\n  constructor(private reverse = false) {\r\n    this.container = document.createElement('div');\r\n    this.container.className = AnimatedCounter.BASE_CLASS;\r\n  }\r\n\r\n  getDecimal(index: number) {\r\n    if(this.decimals[index]) return this.decimals[index];\r\n    const item = document.createElement('div');\r\n    item.className = AnimatedCounter.BASE_CLASS + '-decimal';\r\n\r\n    const placeholder = document.createElement('div');\r\n    placeholder.className = AnimatedCounter.BASE_CLASS + '-decimal-placeholder';\r\n\r\n    const animatedSuper = new AnimatedSuper();\r\n    animatedSuper.container.className = AnimatedCounter.BASE_CLASS + '-decimal-wrapper';\r\n\r\n    item.append(placeholder, animatedSuper.container);\r\n\r\n    this.container.append(item);\r\n\r\n    return this.decimals[index] = {container: item, placeholder, animatedSuper};\r\n  }\r\n\r\n  clear(number: number) {\r\n    if(this.clearTimeout) clearTimeout(this.clearTimeout);\r\n\r\n    const decimals = ('' + number).length;\r\n    if(decimals >= this.decimals.length) {\r\n      return;\r\n    }\r\n\r\n    this.clearTimeout = window.setTimeout(() => {\r\n      const byDecimal = this.decimals.splice(decimals, this.decimals.length - decimals);\r\n      byDecimal.forEach((decimal) => {\r\n        decimal.container.remove();\r\n      });\r\n    }, AnimatedSuper.DURATION);\r\n  }\r\n\r\n  /* prepareNumber(number: number) {\r\n    const decimals = ('' + number).length;\r\n    if(this.decimals.length < decimals) {\r\n      for(let i = this.decimals.length; i < decimals; ++i) {\r\n        this.getDecimal(i);\r\n      }\r\n    }\r\n  } */\r\n\r\n  hideLeft(number: number) {\r\n    const decimals = ('' + number).length;\r\n    const byDecimal = this.decimals.slice(decimals);//this.decimals.splice(deleteCount, this.decimals.length - deleteCount);\r\n    byDecimal.forEach((decimal) => {\r\n      const previousDecimalNumber = +decimal.placeholder.innerText || 0;\r\n      const row = decimal.animatedSuper.getRow(AnimatedCounter.EMPTY_INDEX, true);\r\n      decimal.animatedSuper.animate(AnimatedCounter.EMPTY_INDEX, previousDecimalNumber, this.reverse ? number < this.previousNumber : number > this.previousNumber, true);\r\n    });\r\n\r\n    this.clear(number);\r\n  }\r\n\r\n  setCount(number: number) {\r\n    //this.prepareNumber(number);\r\n\r\n    const previousByDecimal = Array.from('' + this.previousNumber).map((n) => +n);\r\n    const byDecimal = Array.from('' + number).map((n) => +n);\r\n    byDecimal.forEach((decimalNumber, idx) => {\r\n      const decimal = this.getDecimal(idx);\r\n      //const row = decimal.animatedSuper.getRow(number, true);\r\n      const row = decimal.animatedSuper.getRow(decimalNumber, true);\r\n      const previousDecimalNumber = previousByDecimal[idx] ?? AnimatedCounter.EMPTY_INDEX;\r\n      row.innerText = decimal.placeholder.innerText = '' + decimalNumber;\r\n      //decimal.animatedSuper.animate(number, this.previousNumber, this.reverse ? number < this.previousNumber : number > this.previousNumber, true);\r\n      decimal.animatedSuper.animate(decimalNumber, previousDecimalNumber, this.reverse ? number < this.previousNumber : number > this.previousNumber, true);\r\n    });\r\n\r\n    this.hideLeft(number);\r\n    //this.clear(number);\r\n    this.previousNumber = number;\r\n  }\r\n}\r\n\r\nexport default class ChatPinnedMessage {\r\n  private static LOAD_COUNT = 50;\r\n  private static LOAD_OFFSET = 5;\r\n\r\n  public pinnedMessageContainer: PinnedContainer;\r\n  private pinnedMessageBorder: PinnedMessageBorder;\r\n\r\n  private pinnedMaxMid = 0;\r\n  public pinnedMid = 0;\r\n  public pinnedIndex = -1;\r\n  private wasPinnedIndex = 0;\r\n  private wasPinnedMediaIndex = 0;\r\n  \r\n  public locked = false;\r\n  private waitForScrollBottom = false;\r\n\r\n  public count = 0;\r\n  private mids: number[] = [];\r\n  private offsetIndex = 0;\r\n\r\n  private loading = false;\r\n  private loadedBottom = false;\r\n  private loadedTop = false;\r\n\r\n  private animatedSubtitle: AnimatedSuper;\r\n  private animatedMedia: AnimatedSuper;\r\n  private animatedCounter: AnimatedCounter;\r\n\r\n  private listenerSetter: ListenerSetter;\r\n  private scrollDownListenerSetter: ListenerSetter = null;\r\n\r\n  public hidden = false;\r\n\r\n  private getCurrentIndexPromise: Promise<any> = null;\r\n  private btnOpen: HTMLButtonElement;\r\n  \r\n  private setPinnedMessage: () => void;\r\n\r\n  private isStatic: boolean;\r\n\r\n  private debug: boolean;\r\n  \r\n  public setCorrectIndexThrottled: (lastScrollDirection?: number) => void;\r\n\r\n  private log: ReturnType<typeof logger>;\r\n  \r\n  constructor(private topbar: ChatTopbar, private chat: Chat, private managers: AppManagers) {\r\n    this.listenerSetter = new ListenerSetter();\r\n    this.log = logger('PM');\r\n    this.debug = true;\r\n    this.isStatic = false;\r\n\r\n    const dAC = new ReplyContainer('pinned-message');\r\n    this.pinnedMessageContainer = new PinnedContainer({\r\n      topbar, \r\n      chat, \r\n      listenerSetter: this.listenerSetter, \r\n      className: 'message', \r\n      divAndCaption: dAC, \r\n      onClose: async() => {\r\n        if(await managers.appPeersManager.canPinMessage(this.chat.peerId)) {\r\n          new PopupPinMessage(this.chat.peerId, this.pinnedMid, true);\r\n        } else {\r\n          new PopupPinMessage(this.chat.peerId, 0, true);\r\n        }\r\n\r\n        return false;\r\n      }\r\n    });\r\n\r\n    this.pinnedMessageBorder = new PinnedMessageBorder();\r\n    dAC.border.replaceWith(this.pinnedMessageBorder.render(1, 0));\r\n\r\n    this.animatedSubtitle = new AnimatedSuper();\r\n    dAC.subtitle.append(this.animatedSubtitle.container);\r\n\r\n    this.animatedMedia = new AnimatedSuper();\r\n    this.animatedMedia.container.classList.add('pinned-message-media-container');\r\n    dAC.content.prepend(this.animatedMedia.container);\r\n\r\n    this.animatedCounter = new AnimatedCounter(true);\r\n    dAC.title.append(i18n('PinnedMessage'), ' ', this.animatedCounter.container);\r\n\r\n    const btnClose = this.pinnedMessageContainer.btnClose.cloneNode(true) as HTMLElement;\r\n    this.pinnedMessageContainer.attachOnCloseEvent(btnClose);\r\n    dAC.container.prepend(btnClose);\r\n\r\n    this.btnOpen = ButtonIcon('pinlist pinned-container-close pinned-message-pinlist', {noRipple: true});\r\n\r\n    this.pinnedMessageContainer.wrapperUtils.prepend(this.btnOpen);\r\n\r\n    attachClickEvent(this.btnOpen, (e) => {\r\n      cancelEvent(e);\r\n      this.topbar.openPinned(true);\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    this.listenerSetter.add(rootScope)('peer_pinned_messages', ({peerId}) => {\r\n      if(peerId === this.chat.peerId) {\r\n        //this.wasPinnedIndex = 0;\r\n        //setTimeout(() => {\r\n          if(this.hidden) {\r\n            this.pinnedMessageContainer.toggle(this.hidden = false);\r\n          }\r\n\r\n          this.loadedTop = this.loadedBottom = false;\r\n          this.pinnedIndex = -1;\r\n          this.pinnedMid = 0;\r\n          this.count = 0;\r\n          this.mids = [];\r\n          this.offsetIndex = 0;\r\n          this.pinnedMaxMid = 0;\r\n          this.setCorrectIndex(0);\r\n        //}, 300);\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('peer_pinned_hidden', ({peerId}) => {\r\n      if(peerId === this.chat.peerId) {\r\n        this.pinnedMessageContainer.toggle(this.hidden = true);\r\n      }\r\n    });\r\n\r\n    // * 200 - no lags\r\n    // * 100 - need test\r\n    this.setPinnedMessage = debounce(() => this._setPinnedMessage(), 100, true, true);\r\n    this.setCorrectIndexThrottled = throttle(this.setCorrectIndex.bind(this), 100, false);\r\n\r\n    this.isStatic = this.chat.type === 'discussion';\r\n  }\r\n\r\n  public destroy() {\r\n    this.pinnedMessageContainer.divAndCaption.container.remove();\r\n    this.pinnedMessageContainer.toggle(true);\r\n    this.listenerSetter.removeAll();\r\n    this.unsetScrollDownListener(false);\r\n  }\r\n\r\n  public setCorrectIndex(lastScrollDirection?: number) {\r\n    if(this.isStatic) return;\r\n    // return;\r\n\r\n    if(this.locked || this.hidden/*  || this.chat.setPeerPromise || this.chat.bubbles.messagesQueuePromise */) {\r\n      return;\r\n    }\r\n\r\n    if((this.loadedBottom || this.loadedTop) && !this.count) {\r\n      return;\r\n    }\r\n\r\n    //const perf = performance.now();\r\n    let el = this.chat.bubbles.getBubbleByPoint('bottom');\r\n    //this.log('setCorrectIndex: get last element perf:', performance.now() - perf, el);\r\n    if(!el) return;\r\n\r\n    //return;\r\n\r\n    const mid = el.dataset.mid;\r\n    if(el && mid !== undefined) {\r\n      //this.log('setCorrectIndex will test mid:', mid);\r\n      this.testMid(+mid, lastScrollDirection);\r\n    }\r\n  }\r\n\r\n  public testMid(mid: number, lastScrollDirection?: number) {\r\n    if(this.isStatic) return;\r\n    \r\n    //if(lastScrollDirection !== undefined) return;\r\n    if(this.hidden) return;\r\n\r\n    //this.log('testMid', mid);\r\n\r\n    let currentIndex: number = this.mids.findIndex((_mid) => _mid <= mid);\r\n    if(currentIndex !== -1 && !this.isNeededMore(currentIndex)) {\r\n      currentIndex += this.offsetIndex;\r\n    } else if(this.loadedTop && mid < this.mids[this.mids.length - 1]) {\r\n      //currentIndex = 0;\r\n      currentIndex = this.mids.length - 1 + this.offsetIndex;\r\n    } else {\r\n      if(!this.getCurrentIndexPromise) {\r\n        this.getCurrentIndexPromise = this.getCurrentIndex(mid, lastScrollDirection !== undefined);\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    //const idx = Math.max(0, this.mids.indexOf(mid));\r\n\r\n    /* if(currentIndex === this.count) {\r\n      currentIndex = 0;\r\n    } */\r\n\r\n    //this.log('testMid: pinned currentIndex', currentIndex, mid);\r\n\r\n    const changed = this.pinnedIndex !== currentIndex;\r\n    if(changed) {\r\n      if(this.waitForScrollBottom && lastScrollDirection !== undefined) {\r\n        if(this.pinnedIndex === 0 || this.pinnedIndex > currentIndex) { //          - \r\n          return;\r\n        }\r\n      }\r\n\r\n      this.pinnedIndex = currentIndex;\r\n      this.pinnedMid = this.mids.find((_mid) => _mid <= mid) || this.mids[this.mids.length - 1];\r\n      this.setPinnedMessage();\r\n    }\r\n  }\r\n\r\n  private isNeededMore(currentIndex: number) {\r\n    return (this.count > ChatPinnedMessage.LOAD_COUNT && \r\n      (\r\n        (!this.loadedBottom && currentIndex <= ChatPinnedMessage.LOAD_OFFSET) || \r\n        (!this.loadedTop && (this.count - 1 - currentIndex) <= ChatPinnedMessage.LOAD_OFFSET)\r\n      )\r\n    );\r\n  }\r\n\r\n  private async getCurrentIndex(mid: number, correctAfter = true) {\r\n    if(this.loading) return;\r\n    this.loading = true;\r\n\r\n    try {\r\n      const log = this.debug ? this.log.bindPrefix('getCurrentIndex') : undefined;\r\n      log && log('start', mid, correctAfter);\r\n\r\n      let gotRest = false;\r\n      const promises = [\r\n        this.managers.appMessagesManager.getSearch({\r\n          peerId: this.chat.peerId, \r\n          inputFilter: {_: 'inputMessagesFilterPinned'}, \r\n          maxId: mid, \r\n          limit: ChatPinnedMessage.LOAD_COUNT, \r\n          backLimit: ChatPinnedMessage.LOAD_COUNT\r\n        })\r\n        .then((r) => {\r\n          gotRest = true;\r\n          return r;\r\n        })\r\n      ];\r\n  \r\n      if(!this.pinnedMaxMid) {\r\n        const promise = this.managers.appMessagesManager.getPinnedMessage(this.chat.peerId).then((p) => {\r\n          if(!p.maxId) return;\r\n          this.pinnedMaxMid = p.maxId;\r\n\r\n          if(!gotRest && correctAfter) {\r\n            this.mids = [this.pinnedMaxMid];\r\n            this.count = p.count;\r\n            this.pinnedIndex = 0;\r\n            this.pinnedMid = this.mids[0];\r\n            this.setPinnedMessage();\r\n            //this.pinnedMessageContainer.toggle(false);\r\n          }\r\n        });\r\n  \r\n        promises.push(promise as any);\r\n      }\r\n      \r\n      const result = (await Promise.all(promises))[0];\r\n  \r\n      let backLimited = result.history.findIndex((message) => message.mid <= mid);\r\n      if(backLimited === -1) {\r\n        backLimited = result.history.length;\r\n      }/*  else {\r\n        backLimited -= 1;\r\n      } */\r\n      \r\n      this.offsetIndex = result.offset_id_offset ? result.offset_id_offset - backLimited : 0;\r\n      this.mids = result.history.map((message) => message.mid).slice();\r\n      this.count = result.count;\r\n\r\n      if(!this.count) {\r\n        this.pinnedMessageContainer.toggle(true);\r\n      }\r\n  \r\n      this.loadedTop = (this.offsetIndex + this.mids.length) === this.count;\r\n      this.loadedBottom = !this.offsetIndex;\r\n  \r\n      log && log('result', mid, result, backLimited, this.offsetIndex, this.loadedTop, this.loadedBottom);\r\n    } catch(err) {\r\n      this.log.error('getCurrentIndex error', err);\r\n    }\r\n    \r\n    this.loading = false;\r\n\r\n    if(this.locked) {\r\n      this.testMid(mid);\r\n    } else if(correctAfter) {\r\n      this.setCorrectIndex(0);\r\n    }\r\n\r\n    this.getCurrentIndexPromise = null;\r\n    //return result.offset_id_offset || 0;\r\n  }\r\n\r\n  public setScrollDownListener() {\r\n    this.waitForScrollBottom = true;\r\n\r\n    if(!this.scrollDownListenerSetter) {\r\n      this.scrollDownListenerSetter = new ListenerSetter();\r\n      handleScrollSideEvent(this.chat.bubbles.scrollable.container, 'bottom', () => {\r\n        this.unsetScrollDownListener();\r\n      }, this.scrollDownListenerSetter);\r\n    }\r\n  }\r\n\r\n  public unsetScrollDownListener(refreshPosition = true) {\r\n    this.waitForScrollBottom = false;\r\n\r\n    if(this.scrollDownListenerSetter) {\r\n      this.scrollDownListenerSetter.removeAll();\r\n      this.scrollDownListenerSetter = null;\r\n    }\r\n\r\n    if(refreshPosition) {\r\n      this.setCorrectIndex(0);\r\n    }\r\n  }\r\n\r\n  public async handleFollowingPinnedMessage() {\r\n    this.locked = true;\r\n\r\n    this.debug && this.log('handleFollowingPinnedMessage');\r\n    try {\r\n      this.setScrollDownListener();\r\n\r\n      const setPeerPromise = this.chat.setPeerPromise;\r\n      if(setPeerPromise instanceof Promise) {\r\n        await setPeerPromise;\r\n      }\r\n  \r\n      //await this.chat.bubbles.scrollable.scrollLockedPromise;\r\n      await getHeavyAnimationPromise();\r\n\r\n      if(this.getCurrentIndexPromise) {\r\n        await this.getCurrentIndexPromise;\r\n      }\r\n\r\n      this.debug && this.log('handleFollowingPinnedMessage: unlock');\r\n      this.locked = false;\r\n\r\n      /* // ,   \r\n      setTimeout(() => {\r\n        this.log('handleFollowingPinnedMessage: unlock');\r\n        this.locked = false;\r\n      }, 50); */\r\n    } catch(err) {\r\n      this.log.error('handleFollowingPinnedMessage error:', err);\r\n\r\n      this.locked = false;\r\n      this.waitForScrollBottom = false;\r\n      this.setCorrectIndex(0);\r\n    }\r\n  }\r\n\r\n  public async followPinnedMessage(mid: number) {\r\n    const message = await this.chat.getMessage(mid);\r\n    if(!message) {\r\n      return;\r\n    }\r\n    \r\n    this.chat.setMessageId(mid);\r\n    (this.chat.setPeerPromise || Promise.resolve()).then(() => { // * debounce fast clicker\r\n      this.handleFollowingPinnedMessage();\r\n      this.testMid(this.pinnedIndex >= (this.count - 1) ? this.pinnedMaxMid : mid - 1);\r\n    });\r\n  }\r\n\r\n  public async _setPinnedMessage() {\r\n    /////this.log('setting pinned message', message);\r\n    //return;\r\n    /* const promise: Promise<any> = this.chat.setPeerPromise || this.chat.bubbles.messagesQueuePromise || Promise.resolve();\r\n    Promise.all([\r\n      promise\r\n    ]).then(() => { */\r\n      //const mids = results[0];\r\n      const count = this.count;\r\n      if(count) {\r\n        const pinnedIndex = this.pinnedIndex;\r\n        const message = await this.chat.getMessage(this.pinnedMid);\r\n\r\n        //this.animatedCounter.prepareNumber(count);\r\n\r\n        //setTimeout(() => {\r\n          const isLast = pinnedIndex === 0;\r\n          this.animatedCounter.container.classList.toggle('is-last', isLast);\r\n          //SetTransition(this.animatedCounter.container, 'is-last', isLast, AnimatedSuper.DURATION);\r\n          if(!isLast) {\r\n            this.animatedCounter.setCount(count - pinnedIndex);\r\n          }\r\n        //}, 100);\r\n\r\n        //this.pinnedMessageContainer.fill(undefined, message.message, message);\r\n        this.pinnedMessageContainer.toggle(false);\r\n\r\n        const fromTop = pinnedIndex > this.wasPinnedIndex;\r\n\r\n        this.debug && this.log('setPinnedMessage: fromTop', fromTop, pinnedIndex, this.wasPinnedIndex);\r\n\r\n        const writeTo = this.animatedSubtitle.getRow(pinnedIndex);\r\n        const writeMediaTo = this.animatedMedia.getRow(pinnedIndex);\r\n        writeMediaTo.classList.add('pinned-message-media');\r\n        //writeMediaTo.innerHTML = writeMediaTo.style.cssText = writeMediaTo.dataset.docId = '';\r\n        const loadPromises: Promise<any>[] = [];\r\n        const isMediaSet = await wrapReplyDivAndCaption({\r\n          title: undefined,\r\n          titleEl: null,\r\n          subtitle: (message as Message.message).message,\r\n          subtitleEl: writeTo,\r\n          message,\r\n          mediaEl: writeMediaTo,\r\n          loadPromises\r\n        });\r\n\r\n        await Promise.all(loadPromises);\r\n\r\n        this.pinnedMessageContainer.divAndCaption.container.classList.toggle('is-media', isMediaSet);\r\n\r\n        //if(this.wasPinnedIndex !== this.pinnedIndex) {\r\n          this.animatedSubtitle.animate(pinnedIndex, this.wasPinnedIndex);\r\n          if(isMediaSet) {\r\n            this.animatedMedia.animate(pinnedIndex, this.wasPinnedMediaIndex); // * wasPinnedMediaIndex - ,      \r\n            this.wasPinnedMediaIndex = pinnedIndex;\r\n          } else {\r\n            this.animatedMedia.clearRows();\r\n          }\r\n        //}\r\n\r\n        this.pinnedMessageBorder.render(count, count - pinnedIndex - 1);\r\n        this.wasPinnedIndex = pinnedIndex;\r\n        this.pinnedMessageContainer.divAndCaption.container.dataset.mid = '' + message.mid;\r\n      } else {\r\n        this.pinnedMessageContainer.toggle(true);\r\n        this.wasPinnedIndex = 0;\r\n      }\r\n\r\n      this.pinnedMessageContainer.divAndCaption.container.classList.toggle('is-many', this.count > 1);\r\n    //});\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ListenerSetter from \"../listenerSetter\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\n\r\nexport default function handleScrollSideEvent(elem: HTMLElement, side: 'top' | 'bottom', callback: () => void, listenerSetter: ListenerSetter) {\r\n  if(IS_TOUCH_SUPPORTED) {\r\n    let lastY: number;\r\n    const options = {passive: true};\r\n    listenerSetter.add(elem)('touchstart', (e) => {\r\n      if(e.touches.length > 1) {\r\n        onTouchEnd();\r\n        return;\r\n      }\r\n\r\n      lastY = e.touches[0].clientY;\r\n\r\n      listenerSetter.add(elem)('touchmove', onTouchMove, options);\r\n      listenerSetter.add(elem)('touchend', onTouchEnd, options);\r\n    }, options);\r\n\r\n    const onTouchMove = (e: TouchEvent) => {\r\n      const clientY = e.touches[0].clientY;\r\n\r\n      const isDown = clientY < lastY;\r\n      if(side === 'bottom' && isDown) callback();\r\n      else if(side === 'top' && !isDown) callback();\r\n      lastY = clientY;\r\n      //alert('isDown: ' + !!isDown);\r\n    };\r\n    \r\n    const onTouchEnd = () => {\r\n      listenerSetter.removeManual(elem, 'touchmove', onTouchMove, options);\r\n      listenerSetter.removeManual(elem, 'touchend', onTouchEnd, options);\r\n    };\r\n  } else {\r\n    listenerSetter.add(elem)('wheel', (e) => {\r\n      const isDown = e.deltaY > 0;\r\n      //this.log('wheel', e, isDown);\r\n      if(side === 'bottom' && isDown) callback();\r\n      else if(side === 'top' && !isDown) callback();\r\n    }, {passive: true});\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport tsNow from \"../../helpers/tsNow\";\r\nimport { LangPackKey } from \"../../lib/langPack\";\r\nimport { MUTE_UNTIL } from \"../../lib/mtproto/mtproto_config\";\r\nimport RadioField from \"../radioField\";\r\nimport Row, { RadioFormFromRows } from \"../row\";\r\nimport PopupPeer from \"./peer\";\r\n\r\nconst ONE_HOUR = 3600;\r\nconst times: {time: number, langKey: LangPackKey}[] = [{\r\n  time: ONE_HOUR, \r\n  langKey: 'ChatList.Mute.1Hour'\r\n}, {\r\n  time: ONE_HOUR * 4, \r\n  langKey: 'ChatList.Mute.4Hours'\r\n}, {\r\n  time: ONE_HOUR * 8, \r\n  langKey: 'ChatList.Mute.8Hours'\r\n}, {\r\n  time: ONE_HOUR * 24, \r\n  langKey: 'ChatList.Mute.1Day'\r\n}, {\r\n  time: ONE_HOUR * 24 * 3,\r\n  langKey: 'ChatList.Mute.3Days'\r\n}, {\r\n  time: -1,\r\n  langKey: 'ChatList.Mute.Forever'\r\n}];\r\n\r\nexport default class PopupMute extends PopupPeer {\r\n  constructor(peerId: PeerId) {\r\n    super('popup-mute', {\r\n      peerId,\r\n      titleLangKey: 'Notifications',\r\n      buttons: [{\r\n        langKey: 'ChatList.Context.Mute',\r\n        callback: () => {\r\n          this.managers.appMessagesManager.mutePeer(peerId, time === -1 ? MUTE_UNTIL : tsNow(true) + time);\r\n        }\r\n      }],\r\n      body: true\r\n    });\r\n\r\n    const name = 'mute-time';\r\n    const rows = times.map((time) => {\r\n      const row = new Row({\r\n        radioField: new RadioField({\r\n          langKey: time.langKey, \r\n          name, \r\n          value: '' + time.time\r\n        })\r\n      });\r\n\r\n      return row;\r\n    });\r\n\r\n    let time: number;\r\n    const radioForm = RadioFormFromRows(rows, (value) => {\r\n      time = +value;\r\n    });\r\n\r\n    this.body.append(radioForm);\r\n\r\n    rows[rows.length - 1].radioField.checked = true;\r\n\r\n    this.show();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nconst ASSETS_PATH = 'assets/audio/';\r\n\r\nexport default class AudioAssetPlayer<AssetName extends string> {\r\n  private audio: HTMLAudioElement;\r\n  private tempId: number;\r\n  private assetName: AssetName;\r\n\r\n  constructor(private assets: AssetName[]) {\r\n    this.tempId = 0;\r\n  }\r\n\r\n  public playSound(name: AssetName, loop = false) {\r\n    ++this.tempId;\r\n    this.assetName = name;\r\n\r\n    try {\r\n      const audio = this.createAudio();\r\n      audio.autoplay = true;\r\n      audio.src = ASSETS_PATH + name;\r\n      audio.loop = loop;\r\n      audio.play();\r\n    } catch(e) {\r\n      console.error('playSound', name, e);\r\n    }\r\n  }\r\n\r\n  public playSoundIfDifferent(name: AssetName, loop?: boolean) {\r\n    if(this.assetName !== name) {\r\n      this.playSound(name, loop);\r\n    }\r\n  }\r\n\r\n  public createAudio() {\r\n    let {audio} = this;\r\n    if(audio) {\r\n      return audio;\r\n    }\r\n\r\n    audio = this.audio = new Audio();\r\n    audio.play();\r\n    return audio;\r\n  }\r\n\r\n  public stopSound() {\r\n    if(!this.audio) {\r\n      return;\r\n    }\r\n    \r\n    this.audio.pause();\r\n  }\r\n\r\n  public cancelDelayedPlay() {\r\n    ++this.tempId;\r\n  }\r\n\r\n  public playSoundWithTimeout(name: AssetName, loop: boolean, timeout: number) {\r\n    // timeout = 0;\r\n    const tempId = ++this.tempId;\r\n    setTimeout(() => {\r\n      if(this.tempId !== tempId) {\r\n        return;\r\n      }\r\n\r\n      this.playSound(name, loop);\r\n    }, timeout);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport AudioAssetPlayer from \"../../helpers/audioAssetPlayer\";\r\n\r\nexport type GroupCallAudioAssetName = \"group_call_connect.mp3\" | \"group_call_end.mp3\" | \"group_call_start.mp3\" | \"voip_onallowtalk.mp3\";\r\n\r\nlet audioAsset: AudioAssetPlayer<GroupCallAudioAssetName>;\r\nexport default function getGroupCallAudioAsset() {\r\n  return audioAsset ??= new AudioAssetPlayer([\r\n    'group_call_connect.mp3',\r\n    'group_call_end.mp3',\r\n    'group_call_start.mp3',\r\n    'voip_onallowtalk.mp3'\r\n  ]);\r\n}\r\n","import constraintSupported, { MyMediaTrackSupportedConstraints } from \"../../../environment/constraintSupport\";\r\n\r\nexport default function getAudioConstraints(): MediaTrackConstraints {\r\n  const constraints: MediaTrackConstraints = {\r\n    channelCount: 2\r\n  };\r\n\r\n  const desirable: (keyof MyMediaTrackSupportedConstraints)[] = [\r\n    'noiseSuppression',\r\n    'echoCancellation',\r\n    'autoGainControl'\r\n  ];\r\n\r\n  desirable.forEach((constraint) => {\r\n    if(constraintSupported(constraint)) {\r\n      // @ts-ignore\r\n      constraints[constraint] = true;\r\n    }\r\n  });\r\n\r\n  return constraints;\r\n}\r\n","export type MyMediaTrackSupportedConstraints = MediaTrackSupportedConstraints & {\r\n  noiseSuppression?: boolean, \r\n  autoGainControl?: boolean\r\n};\r\n\r\nexport default function constraintSupported(constraint: keyof MyMediaTrackSupportedConstraints) {\r\n  return (!!navigator?.mediaDevices?.getSupportedConstraints() as any as MyMediaTrackSupportedConstraints)[constraint];\r\n}\r\n","export default function getScreenConstraints(skipAudio?: boolean) {\r\n  const constraints: DisplayMediaStreamConstraints = {\r\n   video: {\r\n      // @ts-ignore\r\n      // cursor: 'always',\r\n      width: {max: 1920},\r\n      height: {max: 1080},\r\n      frameRate: {max: 30}\r\n    }\r\n  };\r\n\r\n  if(!skipAudio) {\r\n    constraints.audio = true;\r\n  }\r\n\r\n  return constraints;\r\n}\r\n","export default async function getScreenStream(constraints: DisplayMediaStreamConstraints) {\r\n  const screenStream = await navigator.mediaDevices.getDisplayMedia(constraints);\r\n  const track = screenStream.getVideoTracks()[0];\r\n  track.contentHint = 'text';\r\n  return screenStream;\r\n}\r\n","export default async function getStream(constraints: MediaStreamConstraints, muted: boolean) {\r\n  // console.log('getStream', constraints);\r\n  \r\n\tconst stream = await navigator.mediaDevices.getUserMedia(constraints);\r\n\tstream.getTracks().forEach((x) => {\r\n\t\t/* x.onmute = x => {\r\n\t\t\tconsole.log('track.onmute', x);\r\n\t\t};\r\n\t\tx.onunmute = x => {\r\n\t\t\tconsole.log('track.onunmute', x);\r\n\t\t}; */\r\n\r\n\t\tx.enabled = !muted;\r\n\t});\r\n\r\n\t// console.log('getStream result', stream);\r\n\treturn stream;\r\n}\r\n\r\n(window as any).getStream = getStream;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getScreenStream from \"./getScreenStream\";\r\nimport getStream from \"./getStream\";\r\n\r\n/**\r\n * ! Use multiple constraints together only with first invoke\r\n */\r\nexport default function getStreamCached() {\r\n  const _cache: {\r\n    main: Partial<{\r\n      audio: Promise<MediaStream>,\r\n      video: Promise<MediaStream>\r\n    }>,\r\n    screen: Partial<{\r\n      audio: Promise<MediaStream>,\r\n      video: Promise<MediaStream>\r\n    }>\r\n  } = {\r\n    main: {},\r\n    screen: {}\r\n  };\r\n\r\n  return async(options: {\r\n    isScreen: true, \r\n    constraints: DisplayMediaStreamConstraints,\r\n  } | {\r\n    isScreen?: false,\r\n    constraints: MediaStreamConstraints, \r\n    muted: boolean\r\n  }) => {\r\n    const {isScreen, constraints} = options;\r\n    const cache = _cache[isScreen ? 'screen' : 'main'];\r\n    let promise: Promise<MediaStream> = cache[constraints.audio ? 'audio' : 'video'];\r\n\r\n    if(!promise) {\r\n      promise = (isScreen ? getScreenStream : getStream)(constraints, (options as any).muted);\r\n      if(constraints.audio && !cache.audio) cache.audio = promise.finally(() => cache.audio = undefined);\r\n      if(constraints.video && !cache.video) cache.video = promise.finally(() => cache.video = undefined);\r\n    }\r\n\r\n    try {\r\n      return await promise;\r\n      /* let out: Partial<{\r\n        audio: MediaStream,\r\n        video: MediaStream\r\n      }> = {};\r\n\r\n      await Promise.all([\r\n        constraints.audio && cache.audio.then((stream) => out.audio = stream),\r\n        constraints.video && cache.video.then((stream) => out.video = stream)\r\n      ].filter(Boolean));\r\n\r\n      return out; */\r\n    } catch(err) {\r\n      throw err;\r\n    }\r\n  };\r\n}\r\n\r\n(window as any).getStreamCached = getStreamCached;\r\n","import simulateEvent from \"../../../helpers/dom/dispatchEvent\";\r\n\r\nexport default function stopTrack(track: MediaStreamTrack) {\r\n  track.stop();\r\n  simulateEvent(track, 'ended');\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nexport default class StringFromLineBuilder {\r\n  private lines: string[];\r\n  private newLine: string[];\r\n\r\n  constructor(private joiner = '\\r\\n') {\r\n    this.lines = [];\r\n    this.newLine = [];\r\n  }\r\n\r\n  public add(...strs: string[]) {\r\n    this.lines.push(...strs);\r\n    return this;\r\n  }\r\n\r\n  public push(word: string) {\r\n    this.newLine.push(word);\r\n    return this;\r\n  }\r\n  \r\n  public addJoined(separator = '') {\r\n    this.add(this.newLine.join(separator));\r\n    this.newLine = [];\r\n    return this;\r\n  }\r\n\r\n  public join() {\r\n    return this.lines.join(this.joiner);\r\n  }\r\n\r\n  public finalize() {\r\n    return this.join() + this.joiner;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\n/// NOTE: telegram returns sign source, while webrtc uses unsign source internally\r\n/// unsign => sign\r\nexport function toTelegramSource(source: number) {\r\n\treturn source << 0;\r\n}\r\n\r\n/// NOTE: telegram returns sign source, while webrtc uses unsign source internally\r\n/// sign => unsign\r\nexport function fromTelegramSource(source: number) {\r\n\treturn source >>> 0;\r\n}\r\n\r\nexport function getAmplitude(array: Uint8Array, scale = 3) {\r\n\tif(!array) return 0;\r\n\r\n\tconst {length} = array;\r\n\tlet total = 0;\r\n\tfor(let i = 0; i < length; ++i) {\r\n\t\ttotal += array[i] * array[i];\r\n\t}\r\n\tconst rms = Math.sqrt(total / length) / 255;\r\n\r\n\treturn Math.min(1, rms * scale);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport { IS_FIREFOX } from '../../environment/userAgent';\r\nimport LocalConferenceDescription, { ConferenceEntry } from './localConferenceDescription';\r\nimport StringFromLineBuilder from './stringFromLineBuilder';\r\nimport { GroupCallConnectionTransport, PayloadType, UpdateGroupCallConnectionData } from './types';\r\nimport { fromTelegramSource } from './utils';\r\n\r\n// screencast is for Peer-to-Peer only\r\nexport type WebRTCLineTypeTrue = 'video' | 'audio' | 'application';\r\nexport type WebRTCLineType = WebRTCLineTypeTrue | 'screencast';\r\n\r\nexport const WEBRTC_MEDIA_PORT = '9';\r\n\r\nexport function fixMediaLineType(mediaType: WebRTCLineType) {\r\n  return mediaType === 'screencast' ? 'video' : mediaType;\r\n}\r\n\r\nexport function performCandidate(c: GroupCallConnectionTransport['candidates'][0]) {\r\n  const arr: string[] = [];\r\n  arr.push('a=candidate:');\r\n  arr.push(`${c.foundation} ${c.component} ${c.protocol.toUpperCase()} ${c.priority} ${c.ip} ${c.port} typ ${c.type}`);\r\n  if(c['rel-addr'] !== undefined) {\r\n    arr.push(` raddr ${c['rel-addr']} rport ${c['rel-port']}`);\r\n  }\r\n  arr.push(` generation ${c.generation}`);\r\n  return arr.join('');\r\n}\r\n\r\nexport function getConnectionTypeForMediaType(mediaType: WebRTCLineType) {\r\n  // return mediaType === 'application' ? 'DTLS/SCTP' : 'RTP/SAVPF';\r\n  return mediaType === 'application' ? 'DTLS/SCTP' : 'UDP/TLS/RTP/SAVPF';\r\n}\r\n\r\nexport function generateMediaFirstLine(mediaType: WebRTCLineType, port = WEBRTC_MEDIA_PORT, payloadIds: (string | number)[]) {\r\n  const connectionType = getConnectionTypeForMediaType(mediaType);\r\n  return `m=${fixMediaLineType(mediaType)} ${port} ${connectionType} ${payloadIds.join(' ')}`;\r\n}\r\n\r\ntype ConferenceData = UpdateGroupCallConnectionData | LocalConferenceDescription;\r\n\r\n// https://tools.ietf.org/id/draft-ietf-rtcweb-sdp-08.html\r\n// https://datatracker.ietf.org/doc/html/draft-roach-mmusic-unified-plan-00\r\nexport class SDPBuilder extends StringFromLineBuilder {\r\n  public addCandidate(c: GroupCallConnectionTransport['candidates'][0]) {\r\n    return this.add(performCandidate(c));\r\n  }\r\n\r\n  /* public addDataChannel(mid: string, transport: GroupCallConnectionTransport, isAnswer?: boolean) {\r\n    this.add(\r\n      'm=application 9 UDP/DTLS/SCTP webrtc-datachannel',\r\n      'c=IN IP4 0.0.0.0',\r\n      'a=ice-options:trickle',\r\n      `a=mid:${mid}`\r\n    );\r\n\r\n    // if(!isAnswer) {\r\n      this.add('a=sendrecv');\r\n    // }\r\n\r\n    this.addTransport(transport, isAnswer);\r\n\r\n    return this.add(\r\n      'a=sctp-port:5000',\r\n      'a=max-message-size:262144'\r\n    );\r\n  } */\r\n  \r\n  public addHeader(sId: string, bundleMids: string[]) {\r\n    const bundle = bundleMids.join(' ');\r\n    return this.add(\r\n      'v=0',                          // version\r\n      `o=- ${sId} 2 IN IP4 0.0.0.0`,  // sessionId, 2=sessionVersion\r\n      's=-',                          // name of the session\r\n      't=0 0',                        // time when session is valid\r\n      'a=extmap-allow-mixed',\r\n      `a=group:BUNDLE ${bundle}`,\r\n      'a=ice-options:trickle',\r\n      // 'a=ice-lite',                   // ice-lite: is a minimal version of the ICE specification, intended for servers running on a public IP address.\r\n      'a=msid-semantic:WMS *'\r\n    );\r\n  }\r\n  \r\n  public addTransport(transport: GroupCallConnectionTransport, skipCandidates?: boolean) {\r\n    this.add(\r\n      `a=ice-ufrag:${transport.ufrag}`,\r\n      `a=ice-pwd:${transport.pwd}`,\r\n      'a=ice-options:trickle'           // ! test\r\n    );\r\n\r\n    for(const fingerprint of transport.fingerprints) {\r\n      this.add(\r\n        `a=fingerprint:${fingerprint.hash} ${fingerprint.fingerprint}`,\r\n        `a=setup:${fingerprint.setup}`\r\n      );\r\n    }\r\n\r\n    if(!skipCandidates && transport.candidates) {\r\n      for(const candidate of transport.candidates) {\r\n        this.addCandidate(candidate);\r\n      }\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  public addSsrc(entry: ConferenceEntry) {\r\n    let streamName = 'stream';\r\n    let {type, sourceGroups} = entry;\r\n\r\n    // let source = ssrc.source ?? ssrc.sourceGroups[0].sources[0];\r\n    // source = fromTelegramSource(source);\r\n    const source = fromTelegramSource(entry.source);\r\n\r\n    streamName += source;\r\n    type += source as any;\r\n\r\n    // streamName += mid;\r\n    // type += mid as any;\r\n\r\n    // streamName = type = entry.transceiver.receiver.track.id as any;\r\n\r\n    const addMsid = () => {\r\n      this.add(`a=msid:${streamName} ${type}`);\r\n    };\r\n\r\n    const addSource = (ssrc: number) => {\r\n      this.add(\r\n        `a=ssrc:${ssrc} cname:${streamName}`,\r\n        `a=ssrc:${ssrc} msid:${streamName} ${type}`,\r\n        `a=ssrc:${ssrc} mslabel:${streamName}`,\r\n        `a=ssrc:${ssrc} label:${type}`\r\n      );\r\n    };\r\n\r\n    addMsid();\r\n    if(sourceGroups?.length) {\r\n      sourceGroups.forEach((ssrcGroup) => {\r\n        if(ssrcGroup.sources.length) {\r\n          const sources = ssrcGroup.sources.map(fromTelegramSource);\r\n          this.add(`a=ssrc-group:${ssrcGroup.semantics} ${sources.join(' ')}`);\r\n          sources.forEach(addSource);\r\n        }\r\n      });\r\n    } else {\r\n      addSource(source);\r\n    }\r\n  \r\n    return this;\r\n  }\r\n\r\n  public addSsrcEntry(entry: ConferenceEntry, data: ConferenceData, isAnswer?: boolean) {\r\n    const add = (...x: string[]) => this.add(...x);\r\n    \r\n    const {type, mid, direction, port} = entry;\r\n    const transport = data.transport;\r\n\r\n    /* if(type === 'application') {\r\n      return this.addDataChannel(mid, transport, isAnswer);\r\n    } */\r\n\r\n    const isApplication = type === 'application';\r\n    const codec = isApplication ? undefined : data[type];\r\n\r\n    const isInactive = direction === 'inactive';\r\n    if(entry.shouldBeSkipped(isAnswer)) {\r\n      return add(\r\n        `m=${fixMediaLineType(type)} 0 ${getConnectionTypeForMediaType(type)} 0`,\r\n        `c=IN IP4 0.0.0.0`,\r\n        `a=inactive`,\r\n        `a=mid:${mid}`\r\n      );\r\n    }\r\n    \r\n    const payloadTypes = !isApplication ? codec['payload-types'] : [{id: 5000} as PayloadType];\r\n    const ids = payloadTypes.map((type) => type.id);\r\n    add(\r\n      generateMediaFirstLine(type, port, ids),\r\n      'c=IN IP4 0.0.0.0',\r\n      `a=rtcp:${port} IN IP4 0.0.0.0`,\r\n    );\r\n\r\n    if(transport['rtcp-mux']) {\r\n      add('a=rtcp-mux');\r\n    }\r\n\r\n    add(`a=mid:${mid}`);\r\n    /* if(type === 'video') {\r\n      add('b=AS:2500');\r\n    } */\r\n\r\n    let setDirection = direction;\r\n    if(direction !== 'sendrecv' && isAnswer && !(isInactive || isApplication)) {\r\n      setDirection = direction === 'sendonly' ? 'recvonly' : 'sendonly';\r\n    }\r\n\r\n    // a=bundle-only\r\n    add(`a=${setDirection}`);\r\n    \r\n    // this.addTransport(transport, isAnswer);\r\n    this.addTransport(transport);\r\n\r\n    if(!isApplication) {\r\n      const hdrexts = codec['rtp-hdrexts'];\r\n      if(hdrexts?.length) {\r\n        hdrexts.forEach((hdrext) => {\r\n          add(`a=extmap:${hdrext.id} ${hdrext.uri}`);\r\n        });\r\n      }\r\n  \r\n      payloadTypes.forEach((type) => {\r\n        add(`a=rtpmap:${type.id} ${type.name}/${type.clockrate}${type.channels && type.channels > 1 ? `/${type.channels}` : ''}`);\r\n  \r\n        const parameters = type.parameters;\r\n        if(Array.isArray(parameters)) {\r\n          if(parameters.length) {\r\n            console.error('parameters is array???', parameters);\r\n          }\r\n        } else if(parameters && Object.keys(parameters).length) {\r\n          const p: string[] = [];\r\n          for(const i in parameters) {\r\n            p.push(`${i}=${parameters[i]}`);\r\n          }\r\n          add(`a=fmtp:${type.id} ${p.join(';')}`);\r\n        }\r\n  \r\n        const fbs = type['rtcp-fbs'];\r\n        if(fbs?.length) {\r\n          fbs.forEach((fb) => {\r\n            add(`a=rtcp-fb:${type.id} ${fb.type}${fb.subtype ? ' ' + fb.subtype : ''}`);\r\n          });\r\n        }\r\n      });\r\n    } else {\r\n      add(`a=sctpmap:${payloadTypes[0].id} webrtc-datachannel 256`);\r\n    }\r\n\r\n    if(entry.source && (setDirection === 'sendonly' || setDirection === 'sendrecv')) {\r\n      this.addSsrc(entry);\r\n    }\r\n\r\n    return this;\r\n  }\r\n  \r\n  public addConference(options: {\r\n    conference: LocalConferenceDescription, \r\n    bundle: string[],\r\n    entries: ConferenceEntry[],\r\n    isAnswer?: boolean, \r\n  }) {\r\n    const {conference, entries, bundle, isAnswer} = options;\r\n    this.addHeader(conference.sessionId, bundle);\r\n\r\n    if(IS_FIREFOX) {\r\n      this.addTransport(conference.transport); // support Firefox\r\n    }\r\n\r\n    for(const entry of entries) {\r\n      // this.addSsrcEntry(entry, conference, isAnswer);\r\n      this.addSsrcEntry((isAnswer ? entry.recvEntry || entry.sendEntry : entry.sendEntry || entry.recvEntry) || entry, conference, isAnswer);\r\n    }\r\n\r\n    return this;\r\n  }\r\n  \r\n  public static fromConference(options: Parameters<SDPBuilder['addConference']>[0]) {\r\n    return new SDPBuilder().addConference(options).finalize();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport EventListenerBase from '../../helpers/eventListenerBase';\r\nimport { logger } from '../logger';\r\nimport rootScope from '../rootScope';\r\nimport { GROUP_CALL_AMPLITUDE_ANALYSE_COUNT_MAX } from './constants';\r\nimport stopTrack from './helpers/stopTrack';\r\nimport LocalConferenceDescription from './localConferenceDescription';\r\nimport { fixMediaLineType, WebRTCLineType } from './sdpBuilder';\r\nimport { getAmplitude, toTelegramSource } from './utils';\r\n\r\nexport type StreamItemBase = {\r\n  type: 'input' | 'output',\r\n  track: MediaStreamTrack,\r\n  source: string,\r\n  stream: MediaStream\r\n};\r\n\r\nexport type StreamItem = StreamAudioItem | StreamVideoItem;\r\n\r\nexport type StreamAudioItem = StreamItemBase & {kind: 'audio', streamAnalyser: AudioStreamAnalyser};\r\nexport type StreamVideoItem = StreamItemBase & {kind: 'video'};\r\n\r\nexport type StreamAmplitude = {\r\n  type: \"input\" | \"output\";\r\n  source: string;\r\n  stream: MediaStream;\r\n  track: MediaStreamTrack;\r\n  value: number;\r\n};\r\n\r\nclass AudioStreamAnalyser {\r\n  public analyser: AnalyserNode;\r\n  public gain: GainNode;\r\n  public streamSource: MediaStreamAudioSourceNode;\r\n\r\n  constructor(context: AudioContext, stream: MediaStream) {\r\n    const streamSource = this.streamSource = context.createMediaStreamSource(stream);\r\n    const analyser = this.analyser = context.createAnalyser();\r\n    const gain = this.gain = context.createGain();\r\n    // const streamDestination = context.createMediaStreamDestination();\r\n    \r\n    analyser.minDecibels = -100;\r\n    analyser.maxDecibels = -30;\r\n    analyser.smoothingTimeConstant = 0.05;\r\n    analyser.fftSize = 1024;\r\n    \r\n    // connect Web Audio API\r\n    streamSource.connect(analyser);\r\n    // analyser.connect(context.destination);\r\n  }\r\n}\r\n\r\nexport default class StreamManager {\r\n  public static ANALYSER_LISTENER = new EventListenerBase<{amplitude: (details: {amplitudes: StreamAmplitude[], type: 'all' | 'input'}) => void}>();\r\n  private context: AudioContext;\r\n  public outputStream: MediaStream;\r\n  public inputStream: MediaStream;\r\n\r\n  private timer: number;\r\n  private counter: number;\r\n\r\n  private items: StreamItem[];\r\n\r\n  private log: ReturnType<typeof logger>;\r\n\r\n  public direction: RTCRtpTransceiver['direction'];\r\n  public canCreateConferenceEntry: boolean;\r\n  public locked: boolean;\r\n  public types: WebRTCLineType[];\r\n  \r\n  constructor(private interval?: number) {\r\n    this.context = new (window.AudioContext || (window as any).webkitAudioContext)();\r\n    this.items = [];\r\n    this.outputStream = new MediaStream();\r\n    this.inputStream = new MediaStream();\r\n    this.counter = 0;\r\n    this.log = logger('SM');\r\n    this.direction = 'sendonly';\r\n    this.canCreateConferenceEntry = true;\r\n    // this.lol = true;\r\n    this.types = ['audio', 'video'];\r\n  }\r\n\r\n  public addStream(stream: MediaStream, type: StreamItem['type']) {\r\n    stream.getTracks().forEach((track) => {\r\n      this.addTrack(stream, track, type);\r\n    });\r\n  }\r\n\r\n  public addTrack(stream: MediaStream, track: MediaStreamTrack, type: StreamItem['type']) {\r\n    this.log('addTrack', type, track, stream);\r\n\r\n    const {context, items, inputStream, outputStream} = this;\r\n    const kind: StreamItem['kind'] = track.kind as any;\r\n    const source = StreamManager.getSource(stream, type);\r\n    \r\n    // this.removeTrack(track);\r\n    switch(type) {\r\n      case 'input': {\r\n        if(!inputStream) {\r\n          this.inputStream = stream;\r\n        } else {\r\n          inputStream.addTrack(track);\r\n        }\r\n\r\n        break;\r\n      }\r\n\r\n      case 'output': {\r\n        for(let i = 0; i < items.length; ++i) {\r\n          const {track: t, type, source: itemSource} = items[i];\r\n          if(itemSource === source && type === 'input') {\r\n            items.splice(i, 1);\r\n            outputStream.removeTrack(t);\r\n            break;\r\n          }\r\n        }\r\n        \r\n        if(kind !== 'video') {\r\n          outputStream.addTrack(track);\r\n        }\r\n        \r\n        break;\r\n      }\r\n    }\r\n\r\n    this.finalizeAddingTrack({\r\n      type,\r\n      source,\r\n      stream,\r\n      track,\r\n      kind,\r\n      streamAnalyser: kind === 'audio' ? new AudioStreamAnalyser(context, stream) : undefined\r\n    });\r\n\r\n    if(kind === 'audio' && this.interval) {\r\n      this.changeTimer();\r\n    }\r\n  }\r\n\r\n  private finalizeAddingTrack(item: StreamItem) {\r\n    const {track} = item;\r\n    track.addEventListener('ended', () => {\r\n      this.removeTrack(track);\r\n    }, {once: true});\r\n\r\n    this.items.push(item);\r\n  }\r\n\r\n  public hasInputTrackKind(kind: StreamItem['kind']) {\r\n    return this.items.find((item) => item.type === 'input' && item.kind === kind);\r\n  }\r\n\r\n  public static getSource(stream: MediaStream, type: StreamItem['type']) {\r\n    return type === 'input' ? (stream.source || stream.id) : '' + toTelegramSource(+stream.id.substring(6));\r\n  }\r\n  \r\n  public removeTrack(track: MediaStreamTrack) {\r\n    this.log('removeTrack', track);\r\n\r\n    const {items} = this;\r\n    \r\n    let handled = false;\r\n    for(let i = 0, length = items.length; !handled && i < length; ++i) {\r\n      const {track: t, type} = items[i];\r\n      switch(type) {\r\n        case 'output': {\r\n          if(t === track) {\r\n            items.splice(i, 1);\r\n            this.outputStream.removeTrack(track);\r\n            handled = true;\r\n          }\r\n\r\n          break;\r\n        }\r\n\r\n        case 'input': {\r\n          if(t === track) {\r\n            items.splice(i, 1);\r\n            this.inputStream.removeTrack(track);\r\n            handled = true;\r\n          }\r\n\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    \r\n    if(track.kind === 'audio' && this.interval) {\r\n      this.changeTimer();\r\n    }\r\n  }\r\n  \r\n  public replaceInputAudio(stream: MediaStream, oldTrack: MediaStreamTrack) {\r\n    this.removeTrack(oldTrack);\r\n    this.addStream(stream, 'input');\r\n  }\r\n  \r\n  private changeTimer() {\r\n    if(this.timer !== undefined) {\r\n      clearInterval(this.timer);\r\n    }\r\n    \r\n    if(this.items.length) {\r\n      this.timer = window.setInterval(this.analyse, this.interval);\r\n    }\r\n  }\r\n  \r\n  public getAmplitude = (item: StreamAudioItem): StreamAmplitude => {\r\n    const {streamAnalyser, stream, track, source, type} = item;\r\n    const analyser = streamAnalyser.analyser;\r\n    if(!analyser) return;\r\n    \r\n    const array = new Uint8Array(analyser.frequencyBinCount);\r\n    analyser.getByteFrequencyData(array);\r\n    const value = getAmplitude(array);\r\n    \r\n    return {\r\n      type,\r\n      source,\r\n      stream,\r\n      track,\r\n      value\r\n    };\r\n  };\r\n  \r\n  public analyse = () => {\r\n    const all = this.counter % 3 === 0;\r\n    const filteredItems = all ? this.items : this.items.filter((x) => x.type === 'input');\r\n    const audioItems = filteredItems.filter((x) => x.kind === 'audio') as StreamAudioItem[];\r\n    const amplitudes = audioItems.slice(0, GROUP_CALL_AMPLITUDE_ANALYSE_COUNT_MAX).map(this.getAmplitude);\r\n    if(++this.counter >= 1000) {\r\n      this.counter = 0;\r\n    }\r\n    \r\n    StreamManager.ANALYSER_LISTENER.dispatchEvent('amplitude', {\r\n      amplitudes,\r\n      type: all ? 'all' : 'input'\r\n    });\r\n  };\r\n\r\n  /* public appendToConnection(connection: RTCPeerConnection) {\r\n    if(this.inputStream) {\r\n      this.inputStream.getTracks().forEach((track) => {\r\n        connection.log('addTrack', track);\r\n        connection.addTrack(track, this.inputStream);\r\n\r\n        if(track.kind === 'video') {\r\n          track.enabled = true;\r\n        }\r\n      });\r\n    }\r\n  } */\r\n\r\n  public appendToConference(conference: LocalConferenceDescription) {\r\n    if(this.locked) {\r\n      return;\r\n    }\r\n    \r\n    const {inputStream, direction, canCreateConferenceEntry} = this;\r\n    const transceiverInit: RTCRtpTransceiverInit = {direction, streams: [inputStream]};\r\n    const types = this.types.map((type) => {\r\n      return [\r\n        type, \r\n        /* type === 'video' || type === 'screencast' ? \r\n          {sendEncodings: [{maxBitrate: 2500000}], ...transceiverInit} :  */\r\n          transceiverInit\r\n      ] as const;\r\n    });\r\n\r\n    const tracks = inputStream.getTracks();\r\n    // const transceivers = conference.connection.getTransceivers();\r\n    for(const [type, transceiverInit] of types) {\r\n      let entry = conference.findEntry((entry) => entry.direction === direction && entry.type === type);\r\n      if(!entry) {\r\n        if(!canCreateConferenceEntry) {\r\n          continue;\r\n        }\r\n\r\n        entry = conference.createEntry(type);\r\n      }\r\n      /* const entry = conference.findFreeSendRecvEntry(type, true);\r\n      if(!entry.transceiver) {\r\n        entry.transceiver = transceivers.find((transceiver) => transceiver.mid === entry.mid);\r\n      } */\r\n\r\n      let {transceiver} = entry;\r\n      if(!transceiver) {\r\n        transceiver = entry.createTransceiver(conference.connection, transceiverInit);\r\n\r\n        /* if(this.isScreenSharingManager) {\r\n          transceiver.sender.setParameters({\r\n            ...transceiver.sender.getParameters(),\r\n            degradationPreference: 'maintain-resolution'\r\n          });\r\n        } */\r\n      }\r\n\r\n      if(entry.direction !== transceiver.direction) {\r\n        transceiver.direction = entry.direction;\r\n      }\r\n\r\n      const mediaTrackType = fixMediaLineType(type);\r\n      const trackIdx = tracks.findIndex((track) => track.kind === mediaTrackType);\r\n      const track = trackIdx !== -1 ? tracks.splice(trackIdx, 1)[0] : undefined;\r\n      const sender = transceiver.sender;\r\n      if(sender.track === track) {\r\n        continue;\r\n      }\r\n\r\n      // try { // ! don't use await here. it will wait for adding track and fake one won't be visible in startNegotiation.\r\n        /* await  */sender.replaceTrack(track).catch((err) => {\r\n          this.log.error(err);\r\n        });\r\n      // } catch(err) {\r\n\r\n      // }\r\n    }\r\n  }\r\n\r\n  public stop() {\r\n    try {\r\n      const tracks = this.inputStream.getTracks().concat(this.outputStream.getTracks());\r\n      tracks.forEach((track) => {\r\n        stopTrack(track);\r\n      });\r\n    } catch(e) {\r\n      this.log.error(e);\r\n    }\r\n  }\r\n}\r\n","export const GROUP_CALL_AMPLITUDE_ANALYSE_COUNT_MAX = 50;\r\nexport const GROUP_CALL_AMPLITUDE_ANALYSE_INTERVAL_MS = 100;\r\nexport const GROUP_CALL_PARTICIPANTS_LOAD_LIMIT = 100;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport EventListenerBase, { EventListenerListeners } from \"../../helpers/eventListenerBase\";\r\nimport noop from \"../../helpers/noop\";\r\nimport { logger } from \"../logger\";\r\nimport getAudioConstraints from \"./helpers/getAudioConstraints\";\r\nimport getScreenConstraints from \"./helpers/getScreenConstraints\";\r\nimport getStreamCached from \"./helpers/getStreamCached\";\r\nimport getVideoConstraints from \"./helpers/getVideoConstraints\";\r\nimport stopTrack from \"./helpers/stopTrack\";\r\nimport LocalConferenceDescription from \"./localConferenceDescription\";\r\nimport StreamManager, { StreamItem } from \"./streamManager\";\r\n\r\nexport type TryAddTrackOptions = {\r\n  stream: MediaStream, \r\n  track: MediaStreamTrack, \r\n  type: StreamItem['type'], \r\n  source?: string\r\n};\r\n\r\nexport default abstract class CallInstanceBase<E extends EventListenerListeners> extends EventListenerBase<E> {\r\n  protected log: ReturnType<typeof logger>;\r\n  protected outputDeviceId: string;\r\n\r\n  protected player: HTMLElement;\r\n  protected elements: Map<string, HTMLMediaElement>;\r\n\r\n  protected audio: HTMLAudioElement;\r\n  // protected fixedSafariAudio: boolean;\r\n\r\n  protected getStream: ReturnType<typeof getStreamCached>;\r\n\r\n  constructor() {\r\n    super(false);\r\n\r\n    const player = this.player = document.createElement('div');\r\n    player.classList.add('call-player');\r\n    player.style.display = 'none';\r\n    document.body.append(player);\r\n\r\n    this.elements = new Map();\r\n\r\n    // possible Safari fix\r\n    const audio = this.audio = new Audio();\r\n    audio.autoplay = true;\r\n    audio.volume = 1.0;\r\n    this.player.append(audio);\r\n    this.elements.set('audio', audio);\r\n\r\n    this.fixSafariAudio();\r\n\r\n    this.getStream = getStreamCached();\r\n  }\r\n\r\n  public get isSharingAudio() {\r\n    return !!this.streamManager.hasInputTrackKind('audio');\r\n  }\r\n\r\n  public get isSharingVideo() {\r\n    return !!this.streamManager.hasInputTrackKind('video');\r\n  }\r\n\r\n  public abstract get isMuted(): boolean;\r\n  public abstract get isClosing(): boolean;\r\n\r\n  public fixSafariAudio() {\r\n    // if(this.fixedSafariAudio) return;\r\n    this.audio.play().catch(noop);\r\n    // this.fixedSafariAudio = true;\r\n  }\r\n\r\n  public requestAudioSource(muted: boolean) {\r\n    return this.requestInputSource(true, false, muted);\r\n  }\r\n\r\n  public requestInputSource(audio: boolean, video: boolean, muted: boolean) {\r\n    const {streamManager} = this;\r\n    if(streamManager) {\r\n      const isAudioGood = !audio || this.isSharingAudio;\r\n      const isVideoGood = !video || this.isSharingVideo;\r\n      if(isAudioGood && isVideoGood) {\r\n        return Promise.resolve();\r\n      }\r\n    }\r\n\r\n    const constraints: MediaStreamConstraints = {\r\n      audio: audio && getAudioConstraints(),\r\n      video: video && getVideoConstraints()\r\n    };\r\n    \r\n    return this.getStream({\r\n      constraints, \r\n      muted\r\n    }).then((stream) => {\r\n      this.onInputStream(stream);\r\n    });\r\n  }\r\n\r\n  public requestScreen() {\r\n    return this.getStream({\r\n      isScreen: true,\r\n      constraints: getScreenConstraints(true)\r\n    }).then((stream) => {\r\n      this.onInputStream(stream);\r\n    });\r\n  }\r\n\r\n  public getElement(endpoint: number | string) {\r\n    return this.elements.get('' + endpoint);\r\n  }\r\n\r\n  public abstract get streamManager(): StreamManager;\r\n  public abstract get description(): LocalConferenceDescription;\r\n  public abstract toggleMuted(): Promise<void>;\r\n\r\n  public cleanup() {\r\n    this.player.textContent = '';\r\n    this.player.remove();\r\n    this.elements.clear();\r\n\r\n    // can have no connectionInstance but streamManager with input stream\r\n    this.streamManager.stop();\r\n\r\n    super.cleanup();\r\n  }\r\n\r\n  public onTrack(event: RTCTrackEvent) {\r\n    this.tryAddTrack({\r\n      stream: event.streams[0], \r\n      track: event.track, \r\n      type: 'output'\r\n    });\r\n  }\r\n\r\n  public saveInputVideoStream(stream: MediaStream, type?: string) {\r\n    const track = stream.getVideoTracks()[0];\r\n    this.tryAddTrack({\r\n      stream, \r\n      track, \r\n      type: 'input', \r\n      source: type || 'main'\r\n    });\r\n  }\r\n  \r\n  public tryAddTrack({stream, track, type, source}: TryAddTrackOptions) {\r\n    if(!source) {\r\n      source = StreamManager.getSource(stream, type);\r\n    }\r\n\r\n    this.log('tryAddTrack', stream, track, type, source);\r\n\r\n    const isOutput = type === 'output';\r\n\r\n    const {player, elements, streamManager} = this;\r\n    \r\n    const tagName = track.kind as StreamItem['kind'];\r\n    const isVideo = tagName === 'video';\r\n\r\n    const elementEndpoint = isVideo ? source : tagName;\r\n    let element = elements.get(elementEndpoint);\r\n\r\n    if(isVideo) {\r\n      track.addEventListener('ended', () => {\r\n        this.log('[track] onended');\r\n        elements.delete(elementEndpoint);\r\n        // element.remove();\r\n      }, {once: true});\r\n    }\r\n    \r\n    if(isOutput) {\r\n      streamManager.addTrack(stream, track, type);\r\n    }\r\n\r\n    const useStream = isVideo ? stream : streamManager.outputStream;\r\n    if(!element) {\r\n      element = document.createElement(tagName);\r\n      element.autoplay = true;\r\n      element.srcObject = useStream;\r\n      element.volume = 1.0;\r\n\r\n      if((element as any).sinkId !== 'undefined') {\r\n        const {outputDeviceId} = this;\r\n        if(outputDeviceId) {\r\n          (element as any).setSinkId(outputDeviceId);\r\n        }\r\n      }\r\n      \r\n      if(!isVideo) {\r\n        player.appendChild(element);\r\n      } else {\r\n        element.setAttribute('playsinline', 'true');\r\n        element.muted = true;\r\n      }\r\n      // audio.play();\r\n\r\n      elements.set(elementEndpoint, element);\r\n    } else {\r\n      if(element.paused) {\r\n        element.play().catch(noop);\r\n      }\r\n\r\n      // ! EVEN IF MEDIASTREAM IS THE SAME NEW TRACK WON'T PLAY WITHOUT REPLACING IT WHEN NEW PARTICIPANT IS ENTERING !\r\n      // if(element.srcObject !== useStream) {\r\n        element.srcObject = useStream;\r\n      // }\r\n    }\r\n\r\n    return source;\r\n  }\r\n\r\n  public setMuted(muted?: boolean) {\r\n    this.streamManager.inputStream.getAudioTracks().forEach((track) => {\r\n      if(track?.kind === 'audio') {\r\n        track.enabled = muted === undefined ? !track.enabled : !muted;\r\n      }\r\n    });\r\n  }\r\n\r\n  protected onInputStream(stream: MediaStream): void {\r\n    if(!this.isClosing) {\r\n      const videoTracks = stream.getVideoTracks();\r\n      if(videoTracks.length) {\r\n        this.saveInputVideoStream(stream, 'main');\r\n      }\r\n\r\n      const {streamManager, description} = this;\r\n      streamManager.addStream(stream, 'input');\r\n      \r\n      if(description) {\r\n        streamManager.appendToConference(description);\r\n      }\r\n    } else { // if call is declined earlier than stream appears\r\n      stream.getTracks().forEach((track) => {\r\n        stopTrack(track);\r\n      });\r\n    }\r\n  }\r\n}\r\n","export default function getVideoConstraints(): MediaTrackConstraints {\r\n  return {\r\n    width: {min: 1280, max: 1920/* , ideal: 1920 */},\r\n    height: {min: 720, max: 1080/* , ideal: 1080 */},\r\n    frameRate: {min: 24, max: 30}\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport indexOfAndSplice from '../../helpers/array/indexOfAndSplice';\r\nimport safeAssign from '../../helpers/object/safeAssign';\r\nimport { GroupCallParticipantVideoSourceGroup } from '../../layer';\r\nimport { fixMediaLineType, SDPBuilder, WebRTCLineType, WEBRTC_MEDIA_PORT } from './sdpBuilder';\r\nimport { AudioCodec, GroupCallConnectionTransport, Ssrc, UpdateGroupCallConnectionData, VideoCodec } from './types';\r\n\r\nexport class ConferenceEntry {\r\n  public source: number;\r\n  public sourceGroups: GroupCallParticipantVideoSourceGroup[];\r\n  public transceiver: RTCRtpTransceiver;\r\n  public originalDirection: RTCRtpTransceiverDirection;\r\n  public direction: RTCRtpTransceiverDirection;\r\n  public port: string;\r\n  public endpoint: string;\r\n  public peerId: PeerId;\r\n  \r\n  public sendEntry: ConferenceEntry;\r\n  public recvEntry: ConferenceEntry;\r\n\r\n  constructor(public mid: string, public type: WebRTCLineType) {\r\n    this.port = WEBRTC_MEDIA_PORT;\r\n  }\r\n\r\n  public setDirection(direction: RTCRtpTransceiverDirection) {\r\n    if(!this.originalDirection) {\r\n      this.originalDirection = direction;\r\n    }\r\n\r\n    return this.direction = direction;\r\n  }\r\n\r\n  public setPort(port: string) {\r\n    return this.port = port;\r\n  }\r\n\r\n  public setEndpoint(endpoint: string) {\r\n    return this.endpoint = endpoint;\r\n  }\r\n\r\n  public setPeerId(peerId: PeerId) {\r\n    return this.peerId = peerId;\r\n  }\r\n\r\n  public createTransceiver(connection: RTCPeerConnection, init?: RTCRtpTransceiverInit) {\r\n    if(init?.direction) {\r\n      this.setDirection(init.direction);\r\n    }\r\n\r\n    return this.transceiver = connection.addTransceiver(fixMediaLineType(this.type), init);\r\n  }\r\n\r\n  public setSource(source: number | GroupCallParticipantVideoSourceGroup[]) {\r\n    let sourceGroups: GroupCallParticipantVideoSourceGroup[];\r\n    if(Array.isArray(source)) {\r\n      if(!source[0]) return;\r\n      sourceGroups = source;\r\n      source = sourceGroups[0].sources[0];\r\n    }\r\n\r\n    this.sourceGroups = sourceGroups;\r\n    return this.source = source;\r\n  }\r\n\r\n  public shouldBeSkipped(isAnswer?: boolean) {\r\n    return isAnswer && this.direction === 'inactive';\r\n  }\r\n}\r\n\r\nexport function generateSsrc(type: WebRTCLineType, source: number | GroupCallParticipantVideoSourceGroup[], endpoint?: string): Ssrc {\r\n  let sourceGroups: GroupCallParticipantVideoSourceGroup[];\r\n  if(Array.isArray(source)) {\r\n    if(!source[0]) return;\r\n    sourceGroups = source;\r\n    source = sourceGroups[0].sources[0];\r\n  }\r\n  \r\n  return {\r\n    endpoint,\r\n    type,\r\n    source,\r\n    sourceGroups,\r\n  };\r\n}\r\n\r\nexport default class LocalConferenceDescription implements UpdateGroupCallConnectionData {\r\n  public readonly sessionId: string;\r\n  // public ssrcs: Ssrc[];\r\n  public readonly transport: GroupCallConnectionTransport;\r\n  public readonly audio?: AudioCodec;\r\n  public readonly video: VideoCodec;\r\n  public readonly screencast?: VideoCodec;\r\n  \r\n  private maxSeenId: number;\r\n  public readonly entries: ConferenceEntry[];\r\n  private entriesByMid: Map<ConferenceEntry['mid'], ConferenceEntry>;\r\n  private entriesBySource: Map<ConferenceEntry['source'], ConferenceEntry>;\r\n  private entriesByPeerId: Map<ConferenceEntry['peerId'], Set<ConferenceEntry>>;\r\n  \r\n  constructor(public connection: RTCPeerConnection) {\r\n    this.sessionId = '' + Date.now();\r\n    // this.ssrcs = [];\r\n    this.maxSeenId = -1;\r\n    this.entries = [];\r\n    this.entriesByMid = new Map();\r\n    this.entriesBySource = new Map();\r\n    this.entriesByPeerId = new Map();\r\n  }\r\n\r\n  public setData(data: UpdateGroupCallConnectionData) {\r\n    return safeAssign(this, data);\r\n  }\r\n\r\n  public createEntry(type: WebRTCLineType) {\r\n    const mid = '' + ++this.maxSeenId;\r\n    const entry = new ConferenceEntry(mid, type);\r\n    this.entries.push(entry);\r\n    this.entriesByMid.set(mid, entry);\r\n    return entry;\r\n  }\r\n\r\n  public deleteEntry(entry: ConferenceEntry) {\r\n    indexOfAndSplice(this.entries, entry);\r\n    this.entriesByMid.delete(entry.mid);\r\n    this.entriesBySource.delete(entry.source);\r\n\r\n    const set = this.entriesByPeerId.get(entry.peerId);\r\n    if(set) {\r\n      set.delete(entry);\r\n      if(!set.size) {\r\n        this.entriesByPeerId.delete(entry.peerId);\r\n      }\r\n    }\r\n  }\r\n\r\n  public setEntrySource(entry: ConferenceEntry, source: Parameters<ConferenceEntry['setSource']>[0]) {\r\n    entry.setSource(source);\r\n    this.entriesBySource.set(entry.source, entry);\r\n  }\r\n\r\n  public setEntryPeerId(entry: ConferenceEntry, peerId: ConferenceEntry['peerId']) {\r\n    entry.setPeerId(peerId);\r\n    let set = this.entriesByPeerId.get(peerId);\r\n    if(!set) {\r\n      this.entriesByPeerId.set(peerId, set = new Set());\r\n    }\r\n\r\n    set.add(entry);\r\n  }\r\n  \r\n  public findEntry(verify: Parameters<LocalConferenceDescription['entries']['find']>[0]) {\r\n    return this.entries.find(verify);\r\n  }\r\n\r\n  public findFreeSendRecvEntry(type: WebRTCLineType, isSending: boolean) {\r\n    let entry = this.entries.find((entry) => {\r\n      return entry.direction === 'sendrecv' && entry.type === type && !(isSending ? entry.sendEntry : entry.recvEntry);\r\n    });\r\n\r\n    if(!entry) {\r\n      entry = this.createEntry(type);\r\n      entry.setDirection('sendrecv');\r\n    }\r\n\r\n    return entry;\r\n  }\r\n  \r\n  public getEntryByMid(mid: ConferenceEntry['mid']) {\r\n    return this.entriesByMid.get(mid);\r\n  }\r\n\r\n  public getEntryBySource(source: ConferenceEntry['source']) {\r\n    return this.entriesBySource.get(source);\r\n  }\r\n\r\n  public getEntriesByPeerId(peerId: ConferenceEntry['peerId']) {\r\n    return this.entriesByPeerId.get(peerId);\r\n  }\r\n\r\n  public generateSdp(options: Omit<Parameters<SDPBuilder['addConference']>[0], 'conference'>) {\r\n    return SDPBuilder.fromConference({\r\n      conference: this,\r\n      ...options\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport { logger } from \"../logger\";\r\nimport createDataChannel from \"./helpers/createDataChannel\";\r\nimport createPeerConnection from \"./helpers/createPeerConnection\";\r\nimport LocalConferenceDescription from \"./localConferenceDescription\";\r\nimport StreamManager from \"./streamManager\";\r\nimport { Ssrc } from \"./types\";\r\n\r\nexport type CallConnectionInstanceOptions = {\r\n  streamManager: StreamManager,\r\n  connection?: RTCPeerConnection,\r\n  log?: ReturnType<typeof logger>\r\n};\r\n\r\nexport default abstract class CallConnectionInstanceBase {\r\n  public connection: RTCPeerConnection;\r\n  public streamManager: StreamManager;\r\n  public dataChannel: RTCDataChannel;\r\n  public description: LocalConferenceDescription;\r\n  public sources: {\r\n    audio: Ssrc,\r\n    video?: Ssrc,\r\n  };\r\n  protected negotiating: Promise<void>;\r\n  protected log: ReturnType<typeof logger>;\r\n\r\n  constructor(options: CallConnectionInstanceOptions) {\r\n    safeAssign(this, options);\r\n\r\n    if(!this.log) {\r\n      this.log = this.connection?.log || logger('CALL-CONNECTION-BASE');\r\n    }\r\n\r\n    this.sources = {} as any;\r\n  }\r\n\r\n  public createPeerConnection(config?: RTCConfiguration) {\r\n    return this.connection || (this.connection = createPeerConnection(config, this.log.bindPrefix('connection')).connection);\r\n  }\r\n\r\n  public createDataChannel(dict?: RTCDataChannelInit) {\r\n    return this.dataChannel || (this.dataChannel = createDataChannel(this.connection, dict, this.log.bindPrefix('data')));\r\n  }\r\n\r\n  public createDescription() {\r\n    return this.description || (this.description = new LocalConferenceDescription(this.connection));\r\n  }\r\n\r\n  public appendStreamToConference() {\r\n    return this.streamManager.appendToConference(this.description);\r\n  }\r\n\r\n  public closeConnection() {\r\n    const {connection} = this;\r\n    if(!connection) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      connection.log('close');\r\n      connection.close();\r\n    } catch(e) {\r\n      this.log.error(e);\r\n    }\r\n  }\r\n\r\n  public closeConnectionAndStream(stopStream: boolean) {\r\n    this.closeConnection();\r\n    stopStream && this.streamManager.stop();\r\n  }\r\n\r\n  protected abstract negotiateInternal(): CallConnectionInstanceBase['negotiating'];\r\n\r\n  public negotiate() {\r\n    let promise = this.negotiating;\r\n    if(promise) {\r\n      return promise;\r\n    }\r\n\r\n    return this.negotiating = this.negotiateInternal().finally(() => {\r\n      this.negotiating = undefined;\r\n    });\r\n  }\r\n\r\n  public sendDataChannelData(data: any) {\r\n    if(this.dataChannel.readyState !== 'open') {\r\n      return;\r\n    }\r\n\r\n    this.dataChannel.send(JSON.stringify(data));\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Logger, logger } from \"../../logger\";\r\n\r\nexport default function createPeerConnection(config: RTCConfiguration, log?: Logger) {\r\n  if(!log) {\r\n    log = logger('RTCPeerConnection');\r\n  }\r\n\r\n  log('constructor');\r\n\r\n  // @ts-ignore\r\n  const connection = new RTCPeerConnection(config);\r\n  connection.addEventListener('track', (event) => {\r\n    log('ontrack', event);\r\n  });\r\n  connection.addEventListener('signalingstatechange', () => {\r\n    log('onsignalingstatechange', connection.signalingState);\r\n  });\r\n  connection.addEventListener('connectionstatechange', () => {\r\n    log('onconnectionstatechange', connection.connectionState);\r\n  });\r\n  connection.addEventListener('negotiationneeded', () => { // * will be fired every time input device changes\r\n    log('onnegotiationneeded', connection.signalingState);\r\n  });\r\n  connection.addEventListener('icecandidate', (event) => {\r\n    log('onicecandidate', event);\r\n  });\r\n  connection.addEventListener('iceconnectionstatechange', () => {\r\n    log('oniceconnectionstatechange', connection.iceConnectionState);\r\n  });\r\n  connection.addEventListener('datachannel', () => {\r\n    log('ondatachannel');\r\n  });\r\n\r\n  connection.log = log;\r\n\r\n  return {connection};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Logger, logger } from \"../../logger\";\r\n\r\nexport default function createDataChannel(connection: RTCPeerConnection, dict?: RTCDataChannelInit, log?: Logger) {\r\n  // return;\r\n\r\n  if(!log) {\r\n    log = logger('RTCDataChannel');\r\n  }\r\n\r\n  const channel = connection.createDataChannel('data', dict);\r\n\r\n  channel.addEventListener('message', (e) => {\r\n    log('onmessage', e);\r\n  });\r\n  channel.addEventListener('open', () => {\r\n    log('onopen');\r\n  });\r\n  channel.addEventListener('close', () => {\r\n    log('onclose');\r\n  });\r\n\r\n  channel.log = log;\r\n\r\n  return channel;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SDPMediaSection from \"./mediaSection\";\r\nimport SDPSessionSection from \"./sessionSection\";\r\n\r\nexport type AttributeKey = 'group' | 'rtcp' | 'ice-ufrag' | \r\n  'ice-pwd' | 'ice-options' | 'fingerprint' | 'setup' | \r\n  'mid' | 'extmap' | 'sendonly' | 'msid' | 'rtcp-mux' | \r\n  'rtpmap' | 'rtcp-fb' | 'fmtp' | 'ssrc' | 'ssrc-group' |\r\n  'extmap-allow-mixed' | 'msid-semantic';\r\n\r\nexport type AttributeMap = {[k in AttributeKey]?: boolean};\r\n\r\nexport default class SDP {\r\n  #session: SDPSessionSection;\r\n  #media: SDPMediaSection[];\r\n\r\n  constructor(session: SDP['session'], mediaSections: SDP['media']) {\r\n    this.#session = session;\r\n    this.#media = mediaSections;\r\n  }\r\n\r\n  public get session() {\r\n    return this.#session;\r\n  }\r\n\r\n  public get media() {\r\n    return this.#media;\r\n  }\r\n\r\n  public get bundle() {\r\n    const bundleLine = this.session.lines.find((line) => line.parsed?.key === 'group');\r\n    return bundleLine.value.split(' ').slice(1);\r\n  }\r\n\r\n  toString() {\r\n    return this.session.lines\r\n    .concat(...this.media.map((section) => section.lines))\r\n    .map((line) => line.toString()).join('\\r\\n') + '\\r\\n';\r\n  }\r\n\r\n  /* get buggedMedia() {\r\n    const bundle = this.bundle;\r\n    type A = {\r\n      mid: SDPMediaSection['mid'],\r\n      mediaType: SDPMediaSection['mediaType'],\r\n      direction: SDPMediaSection['direction']\r\n    };\r\n    const out: A[] = [];\r\n    for(let i = 0, length = this.media.length; i < length; ++i) {\r\n      const section = this.media[i];\r\n      const mid = section.mid;\r\n      if(!bundle.includes(mid)) {\r\n        out.push(section);\r\n      }\r\n    }\r\n\r\n    return out;\r\n  } */\r\n\r\n  /* get mediaTypes() {\r\n    return this.media.map((section) => {\r\n      return {mid: section.oa.get('mid').oa, type: section.mediaType, direction: section.direction};\r\n    });\r\n  } */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function splitStringByLimitWithRest(str: string, separator: string, limit: number) {\r\n  const splitted = str.split(separator);\r\n  const out: string[] = [];\r\n\r\n  while(limit > 0 && splitted.length) {\r\n    out.push(splitted.shift());\r\n    --limit;\r\n  }\r\n\r\n  if(splitted.length) {\r\n    out.push(splitted.join(separator));\r\n  }\r\n\r\n  return out;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default class UniqueNumberGenerator {\r\n  #set: Set<number>;\r\n  #min: number;\r\n  #max: number;\r\n\r\n  constructor(min: number, max: number) {\r\n    this.#set = new Set();\r\n    this.#min = min;\r\n    this.#max = max;\r\n  }\r\n\r\n  public generate() {\r\n    const min = this.#min;\r\n    const max = this.#max;\r\n    const set = this.#set;\r\n\r\n    const maxTries = max - min + 1;\r\n    let value = Math.floor(min + maxTries * Math.random()), _try = 0;\r\n    while(set.has(value)) {\r\n      if(value < max) {\r\n        ++value;\r\n      } else {\r\n        value = min;\r\n      }\r\n\r\n      if(++_try >= maxTries) {\r\n        return null;\r\n      }\r\n    }\r\n\r\n    set.add(value);\r\n    return value;\r\n  }\r\n\r\n  public add(value: number) {\r\n    this.#set.add(value);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { AttributeKey } from \".\";\r\n\r\nexport default class SDPAttributeSplitted {\r\n  #key: AttributeKey;\r\n  #value: string;\r\n\r\n  // key = 'ssrc-group', value = 'SIM 1 2 3'\r\n  constructor(key: AttributeKey, value: string) {\r\n    this.#key = key;\r\n    this.#value = value;\r\n  }\r\n\r\n  public get key() {\r\n    return this.#key;\r\n  }\r\n\r\n  public get value() {\r\n    return this.#value;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default class SDPMediaLineParts {\r\n  #type: 'audio' | 'video' | 'application';\r\n  #port: string;\r\n  #protocol: string;\r\n  #ids: string[];\r\n\r\n  constructor(\r\n    type: SDPMediaLineParts['type'], \r\n    port: SDPMediaLineParts['port'], \r\n    protocol: SDPMediaLineParts['protocol'], \r\n    ids: SDPMediaLineParts['ids']\r\n  ) {\r\n    this.#type = type;\r\n    this.#port = port;\r\n    this.#protocol = protocol;\r\n    this.#ids = ids;\r\n  }\r\n\r\n  public get type() {\r\n    return this.#type;\r\n  }\r\n  \r\n  public get port() {\r\n    return this.#port;\r\n  }\r\n\r\n  public get protocol() {\r\n    return this.#protocol;\r\n  }\r\n\r\n  public get ids() {\r\n    return this.#ids;\r\n  }\r\n\r\n  toString() {\r\n    return this.type + ' ' + this.port + ' ' + this.protocol + ' ' + this.ids.join(' ');\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport splitStringByLimitWithRest from \"../../../helpers/string/splitStringByLimitWithRest\";\r\nimport SDPAttributeSplitted from \"./attributeSplitted\";\r\nimport SDPMediaLineParts from \"./mediaLineParts\";\r\n\r\nexport default class SDPLine {\r\n  #key: 'm' | 'a' | 'o' | 'v' | 's' | 't' | 'c';\r\n  #value: string;\r\n  #mediaLineParts: SDPMediaLineParts;\r\n  #parsed?: SDPAttributeSplitted;\r\n\r\n  // key = 'a', value = 'ssrc-group:SIM 1 2 3'\r\n  constructor(key: SDPLine['key'], value: string | SDPMediaLineParts | SDPAttributeSplitted) {\r\n    this.#key = key;\r\n\r\n    if(typeof(value) === 'string') {\r\n      this.#value = value;\r\n\r\n      if(key === 'm') {\r\n        const splitted = value.split(' ');\r\n        this.#mediaLineParts = new SDPMediaLineParts(splitted[0] as any, splitted[1], splitted[2], splitted.slice(3));\r\n      } else {\r\n        if(key === 'a') {\r\n          const result = splitStringByLimitWithRest(value, ':', 1);\r\n          value = result[0];\r\n          this.#parsed = result.length === 1 ? new SDPAttributeSplitted(value as any, null) : new SDPAttributeSplitted(value as any, result[1]);\r\n        }\r\n      }\r\n    } else {\r\n      if(value instanceof SDPMediaLineParts) {\r\n        this.#mediaLineParts = value;\r\n        this.#value = value.toString();\r\n      } else if(value instanceof SDPAttributeSplitted) {\r\n        this.#parsed = value;\r\n        this.#value = value.value ? `${value.key}:${value.value}` : value.key;\r\n      }\r\n    }\r\n  }\r\n\r\n  public get key() {\r\n    return this.#key;\r\n  }\r\n\r\n  public get value() {\r\n    return this.#value;\r\n  }\r\n\r\n  public get parsed() {\r\n    return this.#parsed;\r\n  }\r\n\r\n  public get mediaLineParts() {\r\n    return this.#mediaLineParts;\r\n  }\r\n\r\n  toString() {\r\n    return `${this.key}=${this.value}`;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport splitStringByLimitWithRest from \"../../../helpers/string/splitStringByLimitWithRest\";\r\n\r\nexport default class SDPAttributeInner {\r\n  #key: string;\r\n  #lines: Array<string>;\r\n  #prefix: string;\r\n  #nestedMap: Map<string, SDPAttributeInner>;\r\n  #missed: boolean;\r\n  #keys: Array<string>;\r\n\r\n  constructor(key: SDPAttributeInner['key'], lines: SDPAttributeInner['lines'], prefix: string = ':', missed = false) {\r\n    this.#key = key;\r\n    this.#lines = lines;\r\n    this.#prefix = prefix;\r\n    this.#missed = missed;\r\n    this.#nestedMap = missed ? new Map() : null;\r\n    this.#keys = missed ? [] : null;\r\n  }\r\n\r\n  public get lines() {\r\n    return this.#lines;\r\n  }\r\n\r\n  public get value() {\r\n    return this.#missed || !this.lines.length ? null : this.lines[0];\r\n  }\r\n\r\n  public get exists() {\r\n    return !this.#missed;\r\n  }\r\n\r\n  public get key() {\r\n    return this.#key;\r\n  }\r\n\r\n  public get keys() {\r\n    SDPAttributeInner.fill(this);\r\n    return this.#keys;\r\n  }\r\n\r\n  public forEach(callback: Parameters<Map<string, SDPAttributeInner>['forEach']>[0]) {\r\n    SDPAttributeInner.fill(this);\r\n    this.#nestedMap.forEach(callback);\r\n  }\r\n\r\n  public get(key: string) {\r\n    SDPAttributeInner.fill(this);\r\n    return this.#nestedMap.get(key) || new SDPAttributeInner(key, [], ':', true);\r\n  }\r\n  \r\n  private static fill(attribute: SDPAttributeInner) {\r\n    if(attribute.#nestedMap !== null) {\r\n      return;\r\n    }\r\n\r\n    const map: Map<string, Array<string>> = new Map();\r\n    attribute.lines.forEach((str) => {\r\n      const [key, rest] = splitStringByLimitWithRest(str, attribute.#prefix, 1);\r\n      const values = map.get(key) || [];\r\n      map.set(key, [...values, rest || '']);\r\n    });\r\n  \r\n    const nestedMap = attribute.#nestedMap = SDPAttributeInner.makeAttributes(map);\r\n    attribute.#keys = Array.from(nestedMap.keys());\r\n  }\r\n\r\n  private static makeAttributes(innerParts: Map<string, Array<string>>) {\r\n    const out: Map<string, SDPAttributeInner> = new Map();\r\n  \r\n    innerParts.forEach((lines, key) => {\r\n      out.set(key, new SDPAttributeInner(key, lines));\r\n    });\r\n  \r\n    return out;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SDPAttributeInner from \"./attributeInner\";\r\nimport SDPLine from \"./line\";\r\n\r\nexport default class SDPAttributes {\r\n  #lines: SDPLine[];\r\n  #attributes: Map<string, SDPAttributeInner>;\r\n\r\n  constructor(lines: SDPLine[]) {\r\n    this.#lines = lines;\r\n    this.#attributes = new Map();\r\n    SDPAttributes.fillAttributes(this);\r\n  }\r\n\r\n  public get(key: string) {\r\n    return this.#attributes.get(key) || new SDPAttributeInner(key, [], ' ', true);\r\n  }\r\n\r\n  private static fillAttributes(attributes: SDPAttributes) {\r\n    const attributesMap: Map<string, Array<string>> = new Map();\r\n    attributes.#lines.forEach((line) => {\r\n      if(line.key === 'a') {\r\n        const {key, value} = line.parsed;\r\n\r\n        let linesArray = attributesMap.get(key);\r\n        if(!linesArray) {\r\n          linesArray = [];\r\n          attributesMap.set(key, linesArray);\r\n        }\r\n        \r\n        linesArray.push(value || '');\r\n      }\r\n    });\r\n\r\n    attributesMap.forEach((linesArray, key) => {\r\n      attributes.#attributes.set(key, new SDPAttributeInner(key, linesArray, ' ', false));\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { AttributeMap } from \".\";\r\nimport { NoExtraProperties } from \"../../../types\";\r\nimport SDPAttributes from \"./attributes\";\r\nimport SDPLine from \"./line\";\r\n\r\nexport type SDPMediaDirection = 'sendonly' | 'recvonly' | 'inactive' | 'sendrecv';\r\nexport default class SDPMediaSection {\r\n  #lines: Array<SDPLine>;\r\n  #mediaLine: SDPLine;\r\n  #attributes: SDPAttributes;\r\n  #direction: SDPMediaDirection;\r\n\r\n  constructor(lines: Array<SDPLine>) {\r\n    this.#lines = lines;\r\n    this.#mediaLine = lines[0];\r\n    this.#attributes = this.#direction = null;\r\n  }\r\n\r\n  public get lines() {\r\n    return this.#lines;\r\n  }\r\n\r\n  public get mediaLine() {\r\n    return this.#mediaLine;\r\n  }\r\n\r\n  public get mediaLineParts() {\r\n    return this.#mediaLine.mediaLineParts;\r\n  }\r\n\r\n  public get mediaType() {\r\n    return this.mediaLineParts.type;\r\n  }\r\n\r\n  public get direction() {\r\n    if(!this.#direction) {\r\n      const attributes = this.attributes;\r\n\r\n      let direction: SDPMediaDirection;\r\n      if(attributes.get('sendonly').exists) direction = 'sendonly';\r\n      else if(attributes.get('recvonly').exists) direction = 'recvonly';\r\n      else if(attributes.get('inactive').exists) direction = 'inactive';\r\n      else direction = 'sendrecv';\r\n\r\n      this.#direction = direction;\r\n    }\r\n\r\n    return this.#direction;\r\n  }\r\n\r\n  public get isSending() {\r\n    return this.direction === 'sendrecv' || this.direction === 'sendonly';\r\n  }\r\n\r\n  public get isReceiving() {\r\n    return this.direction === 'sendrecv' || this.direction === 'recvonly';\r\n  }\r\n\r\n  public get attributes() {\r\n    this.#attributes || (this.#attributes = new SDPAttributes(this.lines));\r\n    return this.#attributes;\r\n  }\r\n\r\n  public get mid() {\r\n    return this.attributes.get('mid').value;\r\n  }\r\n\r\n  public lookupAttributeKeys<T extends AttributeMap>(keys: NoExtraProperties<AttributeMap, T>): {[k in keyof T]: T[k] extends true ? string : string[]} {\r\n    const out: any = {};\r\n\r\n    for(const key in keys) {\r\n      const result = this.attributes.get(key);\r\n      // @ts-ignore\r\n      const resultShouldBeArray = !keys[key];\r\n      if(!result) {\r\n        out[key] = resultShouldBeArray ? [] : undefined;\r\n      } else {\r\n        out[key] = resultShouldBeArray ? result.lines : result.value;\r\n      }\r\n    }\r\n\r\n    return out;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SDPLine from \"./line\";\r\n\r\nexport default class SDPSessionSection {\r\n  #lines: SDPLine[];\r\n  #sessionId: string;\r\n\r\n  constructor(lines: SDPLine[]) {\r\n    this.#lines = lines;\r\n    this.#sessionId = lines.filter((line) => line.key === 'o').map((line) => line.value.split(' ')[1])[0];\r\n  }\r\n\r\n  public get lines() {\r\n    return this.#lines;\r\n  }\r\n\r\n  public get sessionId() {\r\n    return this.#sessionId;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SDP from \".\";\r\nimport splitStringByLimitWithRest from \"../../../helpers/string/splitStringByLimitWithRest\";\r\nimport UniqueNumberGenerator from \"../../../helpers/uniqueNumberGenerator\";\r\nimport SDPLine from \"./line\";\r\nimport SDPMediaSection from \"./mediaSection\";\r\nimport SDPSessionSection from \"./sessionSection\";\r\n\r\nexport function parseSdp(str: string) {\r\n  function createSection() {\r\n    if(sessionSection) {\r\n      mediaSections.push(new SDPMediaSection(lines));\r\n    } else {\r\n      sessionSection = new SDPSessionSection(lines);\r\n    }\r\n  }\r\n\r\n  let sessionSection: SDPSessionSection = null, mediaSections: SDPMediaSection[] = [], lines: SDPLine[] = [];\r\n  str.split(/\\r?\\n/).forEach((lineStr) => {\r\n    if(!isIncorrectSdpLine(lineStr)) {\r\n      const line = parseSdpLine(lineStr);\r\n      if(line.key === 'm') {\r\n        createSection();\r\n        lines = [];\r\n      }\r\n\r\n      lines.push(line);\r\n    }\r\n  });\r\n\r\n  createSection();\r\n  return new SDP(sessionSection, mediaSections);\r\n}\r\n\r\nexport function isIncorrectSdpLine(str: string) {\r\n  return /^[\\s\\xa0]*$/.test(str);\r\n}\r\n\r\nexport function parseSdpLine(str: string) {\r\n  const splitted = splitStringByLimitWithRest(str, '=', 1);\r\n  return new SDPLine(splitted[0] as any, splitted[1]);\r\n}\r\n\r\nexport function addSimulcast(sdp: SDP) {\r\n  let generator: UniqueNumberGenerator;\r\n  sdp.media.forEach((section, idx) => {\r\n    if(section.mediaType === 'video' && section.isSending && !section.attributes.get('ssrc-group').get('SIM').exists) {\r\n      if(!generator) {\r\n        generator = new UniqueNumberGenerator(2, 4294967295);\r\n      }\r\n\r\n      const originalSsrcs = section.attributes.get('ssrc-group').get('FID').value.split(' ');\r\n      const lines = section.lines;\r\n      originalSsrcs.forEach((ssrc) => generator.add(+ssrc)); // fix possible duplicates\r\n      const ssrcs = [originalSsrcs[0], generator.generate(), generator.generate()];\r\n      const ssrcs2 = [originalSsrcs[1], generator.generate(), generator.generate()];\r\n\r\n      lines.push(parseSdpLine('a=ssrc-group:SIM ' + ssrcs.join(' ')));\r\n\r\n      const ssrcsStrLines = section.attributes.get('ssrc').get(originalSsrcs[0]).lines;\r\n\r\n      ssrcs.forEach((ssrc, idx) => {\r\n        const ssrc2 = ssrcs2[idx];\r\n        if(idx > 0) {\r\n          lines.push(parseSdpLine('a=ssrc-group:FID ' + ssrc + ' ' + ssrc2));\r\n\r\n          ssrcsStrLines.forEach((v) => {\r\n            lines.push(parseSdpLine('a=ssrc:' + ssrc + ' ' + v));\r\n          });\r\n\r\n          ssrcsStrLines.forEach((v) => {\r\n            lines.push(parseSdpLine('a=ssrc:' + ssrc2 + ' ' + v));\r\n          });\r\n        }\r\n      });\r\n\r\n      sdp.media[idx] = new SDPMediaSection(lines);\r\n    }\r\n  });\r\n\r\n  return !!generator;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SDP from \"../sdp\";\r\nimport SDPMediaSection from \"../sdp/mediaSection\";\r\nimport { toTelegramSource } from \"../utils\";\r\nimport { parseSourceGroups } from \"./parseSourceGroups\";\r\n\r\nexport default function parseMediaSectionInfo(sdp: SDP, channel: SDPMediaSection) {\r\n  const clientInfo = channel.lookupAttributeKeys({\r\n    'ice-ufrag': true,\r\n    'ice-pwd': true,\r\n    fingerprint: true,\r\n    setup: true,\r\n    ssrc: true,\r\n    mid: true,\r\n    'ssrc-group': false\r\n  });\r\n\r\n  if(!clientInfo.fingerprint) { // support Firefox\r\n    const line = sdp.session.lines.find((line) => line.parsed?.key === 'fingerprint');\r\n    clientInfo.fingerprint = line.parsed.value;\r\n  }\r\n\r\n  const telegramSourceGroups = parseSourceGroups(clientInfo['ssrc-group']);\r\n  const [hash, fingerprint] = clientInfo.fingerprint.split(' ', 2);\r\n  const ssrc = clientInfo.ssrc && toTelegramSource(+clientInfo.ssrc.split(' ', 1)[0]);\r\n  // ssrc = telegramSourceGroups ? telegramSourceGroups[0].sources[0] : ssrc;\r\n\r\n  return {\r\n    raw: clientInfo,\r\n    ufrag: clientInfo['ice-ufrag'],\r\n    pwd: clientInfo['ice-pwd'],\r\n    fingerprint: {\r\n      fingerprint,\r\n      setup: clientInfo.setup,\r\n      hash\r\n    },\r\n    source: ssrc,\r\n    sourceGroups: telegramSourceGroups,\r\n    mid: clientInfo.mid\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { GroupCallParticipantVideoSourceGroup } from \"../../../layer\";\r\nimport { toTelegramSource } from \"../utils\";\r\n\r\nexport function parseSourceGroups(sdpLines: string[]) {\r\n  const telegramSourceGroups = sdpLines.map((str) => {\r\n    const [semantics, ...rest] = str.split(' ');\r\n\r\n    const sourceGroup: GroupCallParticipantVideoSourceGroup = {\r\n      _: 'groupCallParticipantVideoSourceGroup',\r\n      semantics,\r\n      // sources: rest.map((ssrc) => +ssrc)\r\n      sources: rest.map((ssrc) => toTelegramSource(+ssrc))\r\n    };\r\n\r\n    return sourceGroup;\r\n  });\r\n\r\n  /* const simIndex = telegramSourceGroups.findIndex((g) => g.semantics === 'SIM');\r\n  if(simIndex !== -1) {\r\n    const sourceGroup = telegramSourceGroups.splice(simIndex, 1)[0];\r\n    telegramSourceGroups.unshift(sourceGroup);\r\n  } */\r\n\r\n  return telegramSourceGroups.length ? telegramSourceGroups : undefined;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nenum GROUP_CALL_STATE {\r\n  UNMUTED,\r\n  MUTED,\r\n  MUTED_BY_ADMIN,\r\n  CONNECTING,\r\n  CLOSED\r\n}\r\n\r\nexport default GROUP_CALL_STATE;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport forEachReverse from \"../../helpers/array/forEachReverse\";\r\nimport throttle from \"../../helpers/schedulers/throttle\";\r\nimport { GroupCallConnectionType, JoinGroupCallJsonPayload } from \"../appManagers/appGroupCallsManager\";\r\nimport { AppManagers } from \"../appManagers/managers\";\r\nimport rootScope from \"../rootScope\";\r\nimport CallConnectionInstanceBase, { CallConnectionInstanceOptions } from \"./callConnectionInstanceBase\";\r\nimport GroupCallInstance from \"./groupCallInstance\";\r\nimport filterServerCodecs from \"./helpers/filterServerCodecs\";\r\nimport fixLocalOffer from \"./helpers/fixLocalOffer\";\r\nimport processMediaSection from \"./helpers/processMediaSection\";\r\nimport { ConferenceEntry } from \"./localConferenceDescription\";\r\nimport SDP from \"./sdp\";\r\nimport SDPMediaSection from \"./sdp/mediaSection\";\r\nimport { WebRTCLineType } from \"./sdpBuilder\";\r\nimport { UpdateGroupCallConnectionData } from \"./types\";\r\n\r\nexport default class GroupCallConnectionInstance extends CallConnectionInstanceBase {\r\n  private groupCall: GroupCallInstance;\r\n  public updateConstraints?: boolean;\r\n  private type: GroupCallConnectionType;\r\n  private options: {\r\n    type: Extract<GroupCallConnectionType, 'main'>, \r\n    isMuted?: boolean, \r\n    joinVideo?: boolean, \r\n    rejoin?: boolean\r\n  } | {\r\n    type: Extract<GroupCallConnectionType, 'presentation'>,\r\n  };\r\n\r\n  private updateConstraintsInterval: number;\r\n  public negotiateThrottled: () => void;\r\n\r\n  private managers: AppManagers;\r\n\r\n  constructor(options: CallConnectionInstanceOptions & {\r\n    groupCall: GroupCallConnectionInstance['groupCall'],\r\n    type: GroupCallConnectionInstance['type'],\r\n    options: GroupCallConnectionInstance['options'],\r\n    managers: AppManagers\r\n  }) {\r\n    super(options);\r\n\r\n    this.negotiateThrottled = throttle(this.negotiate.bind(this), 0, false);\r\n  }\r\n\r\n  public createPeerConnection() {\r\n    return this.connection || super.createPeerConnection({ \r\n      iceServers: [], \r\n      iceTransportPolicy: 'all', \r\n      bundlePolicy: 'max-bundle', \r\n      rtcpMuxPolicy: 'require', \r\n      iceCandidatePoolSize: 0, \r\n      // sdpSemantics: \"unified-plan\", \r\n      // extmapAllowMixed: true,\r\n    });\r\n  }\r\n\r\n  public createDataChannel() {\r\n    if(this.dataChannel) {\r\n      return this.dataChannel;\r\n    }\r\n\r\n    const dataChannel = super.createDataChannel();\r\n\r\n    dataChannel.addEventListener('open', () => {\r\n      this.maybeUpdateRemoteVideoConstraints();\r\n    });\r\n\r\n    dataChannel.addEventListener('close', () => {\r\n      if(this.updateConstraintsInterval) {\r\n        clearInterval(this.updateConstraintsInterval);\r\n        this.updateConstraintsInterval = undefined;\r\n      }\r\n    });\r\n\r\n    return dataChannel;\r\n  }\r\n\r\n  public createDescription() {\r\n    if(this.description) {\r\n      return this.description;\r\n    }\r\n\r\n    const description = super.createDescription();\r\n\r\n    /* const perType = 0;\r\n    const types = ['audio' as const, 'video' as const];\r\n    const count = types.length * perType;\r\n    const init: RTCRtpTransceiverInit = {direction: 'recvonly'};\r\n    types.forEach((type) => {\r\n      for(let i = 0; i < perType; ++i) {\r\n        description.createEntry(type).createTransceiver(connection, init);\r\n      }\r\n    }); */\r\n\r\n    return description;\r\n  }\r\n\r\n  public appendStreamToConference() {\r\n    super.appendStreamToConference();/* .then(() => {\r\n      currentGroupCall.connections.main.negotiating = false;\r\n      this.startNegotiation({\r\n        type: type,\r\n        isMuted: muted,\r\n        rejoin\r\n      });\r\n    }); */\r\n  }\r\n\r\n  private async invokeJoinGroupCall(localSdp: SDP, mainChannels: SDPMediaSection[], options: GroupCallConnectionInstance['options']) {\r\n    const {groupCall, description} = this;\r\n    const groupCallId = groupCall.id;\r\n\r\n    const processedChannels = mainChannels.map((section) => {\r\n      const processed = processMediaSection(localSdp, section);\r\n\r\n      this.sources[processed.entry.type as 'video' | 'audio'] = processed.entry;\r\n      \r\n      return processed;\r\n    });\r\n\r\n    const audioChannel = processedChannels.find((channel) => channel.media.mediaType === 'audio');\r\n    const videoChannel = processedChannels.find((channel) => channel.media.mediaType === 'video');\r\n    let {source, params} = audioChannel || {};\r\n    const useChannel = videoChannel || audioChannel;\r\n\r\n    const channels: {[type in WebRTCLineType]?: typeof audioChannel} = {\r\n      audio: audioChannel,\r\n      video: videoChannel\r\n    };\r\n\r\n    description.entries.forEach((entry) => {\r\n      if(entry.direction === 'sendonly') {\r\n        const channel = channels[entry.type];\r\n        if(!channel) return;\r\n\r\n        description.setEntrySource(entry, channel.sourceGroups || channel.source);\r\n        description.setEntryPeerId(entry, rootScope.myId);\r\n      }\r\n    });\r\n\r\n    // overwrite ssrc with audio in video params\r\n    if(params !== useChannel.params) {\r\n      const data: JoinGroupCallJsonPayload = JSON.parse(useChannel.params.data);\r\n      // data.ssrc = source || data.ssrc - 1; // audio channel can be missed in screensharing\r\n      if(source) data.ssrc = source;\r\n      else delete data.ssrc;\r\n      params = {\r\n        _: 'dataJSON',\r\n        data: JSON.stringify(data)\r\n      };\r\n    }\r\n\r\n    const update = await this.managers.appGroupCallsManager.joinGroupCall(groupCallId, params, options);\r\n\r\n    const data: UpdateGroupCallConnectionData = JSON.parse(update.params.data);\r\n\r\n    data.audio = data.audio || groupCall.connections.main.description.audio;\r\n    description.setData(data);\r\n    filterServerCodecs(mainChannels, data);\r\n\r\n    return data;\r\n  }\r\n\r\n  protected async negotiateInternal() {\r\n    const {connection, description} = this;\r\n    const isNewConnection = connection.iceConnectionState === 'new' && !description.getEntryByMid('0').source;\r\n    const log = this.log.bindPrefix('startNegotiation');\r\n    log('start');\r\n    \r\n    const originalOffer = await connection.createOffer({iceRestart: false});\r\n\r\n    if(isNewConnection && this.dataChannel) {\r\n      const dataChannelEntry = description.createEntry('application');\r\n      dataChannelEntry.setDirection('sendrecv');\r\n    }\r\n\r\n    const {sdp: localSdp, offer} = fixLocalOffer({\r\n      offer: originalOffer, \r\n      data: description\r\n    });\r\n\r\n    log('[sdp] setLocalDescription', offer.sdp);\r\n    await connection.setLocalDescription(offer);\r\n\r\n    const mainChannels = localSdp.media.filter((media) => {\r\n      return media.mediaType !== 'application' && media.isSending;\r\n    });\r\n\r\n    if(isNewConnection) {\r\n      try {\r\n        await this.invokeJoinGroupCall(localSdp, mainChannels, this.options);\r\n      } catch(e) {\r\n        this.log.error('[tdweb] joinGroupCall error', e);\r\n      }\r\n    }\r\n    \r\n    /* if(!data) {\r\n      log('abort 0');\r\n      this.closeConnectionAndStream(connection, streamManager);\r\n      return;\r\n    } */\r\n\r\n    /* if(connection.iceConnectionState !== 'new') {\r\n      log(`abort 1 connectionState=${connection.iceConnectionState}`);\r\n      this.closeConnectionAndStream(connection, streamManager);\r\n      return;\r\n    } */\r\n    /* if(this.currentGroupCall !== currentGroupCall || connectionHandler.connection !== connection) {\r\n      log('abort', this.currentGroupCall, currentGroupCall);\r\n      this.closeConnectionAndStream(connection, streamManager);\r\n      return;\r\n    } */\r\n    \r\n    const isAnswer = true;\r\n    // const _bundleMids = bundleMids.slice();\r\n    const entriesToDelete: ConferenceEntry[] = [];\r\n    const bundle = localSdp.bundle;\r\n    forEachReverse(bundle, (mid, idx, arr) => {\r\n      const entry = description.getEntryByMid(mid);\r\n      if(entry.shouldBeSkipped(isAnswer)) {\r\n        arr.splice(idx, 1);\r\n        entriesToDelete.push(entry);\r\n      }\r\n    });\r\n\r\n    /* forEachReverse(description.entries, (entry, idx, arr) => {\r\n      const mediaSection = _parsedSdp.media.find((section) => section.oa.get('mid').oa === entry.mid);\r\n      const deleted = !mediaSection;\r\n      // const deleted = !_bundleMids.includes(entry.mid); // ! can't use it because certain mid can be missed in bundle\r\n      if(deleted) {\r\n        arr.splice(idx, 1);\r\n      }\r\n    }); */\r\n\r\n    const entries = localSdp.media.map((section) => {\r\n      const mid = section.mid;\r\n      let entry = description.getEntryByMid(mid);\r\n      if(!entry) {\r\n        entry = new ConferenceEntry(mid, section.mediaType);\r\n        entry.setDirection('inactive');\r\n      }\r\n\r\n      return entry;\r\n    });\r\n\r\n    const answerDescription: RTCSessionDescriptionInit = {\r\n      type: 'answer',\r\n      sdp: description.generateSdp({\r\n        bundle, \r\n        entries, \r\n        isAnswer\r\n      })\r\n    };\r\n\r\n    entriesToDelete.forEach((entry) => {\r\n      description.deleteEntry(entry);\r\n    });\r\n\r\n    log(`[sdp] setRemoteDescription signaling=${connection.signalingState} ice=${connection.iceConnectionState} gathering=${connection.iceGatheringState} connection=${connection.connectionState}`, answerDescription.sdp);\r\n    await connection.setRemoteDescription(answerDescription);\r\n\r\n    log('end');\r\n  }\r\n\r\n  public negotiate() {\r\n    let promise = this.negotiating;\r\n    if(promise) {\r\n      return promise;\r\n    }\r\n\r\n    promise = super.negotiate();\r\n\r\n    if(this.updateConstraints) {\r\n      promise.then(() => {\r\n        this.maybeUpdateRemoteVideoConstraints();\r\n        this.updateConstraints = false;\r\n      });\r\n    }\r\n\r\n    if(this.options.type === 'presentation') {\r\n      promise.then(() => {\r\n        this.connection.getTransceivers().find((transceiver) => {\r\n          if(transceiver.sender?.track?.kind === 'video') {\r\n            transceiver.sender.setParameters({\r\n              ...transceiver.sender.getParameters(),\r\n              degradationPreference: 'maintain-resolution'\r\n            });\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  public maybeUpdateRemoteVideoConstraints() {\r\n    if(this.dataChannel.readyState !== 'open') {\r\n      return;\r\n    }\r\n\r\n    this.log('maybeUpdateRemoteVideoConstraints');\r\n    \r\n    // * https://github.com/TelegramMessenger/tgcalls/blob/6f2746e04c9b040f8c8dfc64d916a1853d09c4ce/tgcalls/group/GroupInstanceCustomImpl.cpp#L2549\r\n    type VideoConstraints = {minHeight?: number, maxHeight: number};\r\n    const obj: {\r\n      colibriClass: 'ReceiverVideoConstraints',\r\n      constraints: {[endpoint: string]: VideoConstraints},\r\n      defaultConstraints: VideoConstraints,\r\n      onStageEndpoints: string[]\r\n    } = {\r\n      colibriClass: 'ReceiverVideoConstraints',\r\n      constraints: {},\r\n      defaultConstraints: {maxHeight: 0},\r\n      onStageEndpoints: []\r\n    };\r\n\r\n    for(const entry of this.description.entries) {\r\n      if(entry.direction !== 'recvonly' || entry.type !== 'video') {\r\n        continue;\r\n      }\r\n\r\n      const {endpoint} = entry;\r\n      obj.onStageEndpoints.push(endpoint);\r\n      obj.constraints[endpoint] = {\r\n        minHeight: 180,\r\n        maxHeight: 720\r\n      };\r\n    }\r\n\r\n    this.sendDataChannelData(obj);\r\n\r\n    if(!obj.onStageEndpoints.length) {\r\n      if(this.updateConstraintsInterval) {\r\n        clearInterval(this.updateConstraintsInterval);\r\n        this.updateConstraintsInterval = undefined;\r\n      }\r\n    } else if(!this.updateConstraintsInterval) {\r\n      this.updateConstraintsInterval = window.setInterval(this.maybeUpdateRemoteVideoConstraints.bind(this), 5000);\r\n    }\r\n  }\r\n  \r\n  public addInputVideoStream(stream: MediaStream) {\r\n    // const {sources} = this;\r\n    // if(sources?.video) {\r\n      // const source = this.sources.video.source;\r\n      // stream.source = '' + source;\r\n      this.groupCall.saveInputVideoStream(stream, this.type);\r\n    // }\r\n\r\n    this.streamManager.addStream(stream, 'input');\r\n    this.appendStreamToConference(); // replace sender track\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { DataJSON } from \"../../../layer\";\r\nimport { JoinGroupCallJsonPayload } from \"../../appManagers/appGroupCallsManager\";\r\nimport SDP from \"../sdp\";\r\nimport { Ssrc } from \"../types\";\r\nimport parseMediaSectionInfo from \"./parseMediaSectionInfo\";\r\n\r\nexport default function processMediaSection(sdp: SDP, media: SDP['media'][0]) {\r\n  const sectionInfo = parseMediaSectionInfo(sdp, media);\r\n\r\n  const mediaType: Exclude<typeof media['mediaType'], 'application'> = media.mediaType as any;\r\n  const entry: Ssrc = {\r\n    source: sectionInfo.source,\r\n    sourceGroups: sectionInfo.sourceGroups,\r\n    type: mediaType\r\n  };\r\n\r\n  // do not change this value, otherwise onconnectionstatechange won't fire\r\n  sectionInfo.fingerprint.setup = 'active';\r\n  const payload: JoinGroupCallJsonPayload = {\r\n    fingerprints: [sectionInfo.fingerprint],\r\n    pwd: sectionInfo.pwd,\r\n    ssrc: sectionInfo.source,\r\n    'ssrc-groups': sectionInfo.sourceGroups || [],\r\n    ufrag: sectionInfo.ufrag\r\n  };\r\n  const paramsDataJson = JSON.stringify(payload);\r\n\r\n  const params: DataJSON = {\r\n    _: 'dataJSON',\r\n    data: paramsDataJson\r\n  };\r\n\r\n  return {\r\n    params, \r\n    source: sectionInfo.source, \r\n    media, \r\n    sourceGroups: sectionInfo.sourceGroups, \r\n    entry\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport forEachReverse from \"../../../helpers/array/forEachReverse\";\r\nimport SDPMediaSection from \"../sdp/mediaSection\";\r\nimport { UpdateGroupCallConnectionData, Codec } from \"../types\";\r\n\r\nexport default function filterServerCodecs(mainChannels: SDPMediaSection[], data: UpdateGroupCallConnectionData) {\r\n  // ! Need to filter server's extmap for Firefox\r\n  const performExtmap = (channel: typeof mainChannels[0]) => {\r\n    const out: {[id: string]: string} = {};\r\n    const extmap = channel.attributes.get('extmap');\r\n    extmap.forEach((extmap) => {\r\n      const id = extmap.key.split('/', 1)[0];\r\n      out[id] = extmap.value;\r\n    });\r\n\r\n    return out;\r\n  };\r\n\r\n  const codecsToPerform: [Codec, 'audio' | 'video'][] = /* flatten([data, dataPresentation].filter(Boolean).map((data) => {\r\n    return  */['audio' as const, 'video' as const].filter((type) => data[type]).map((type) => ([data[type], type]));\r\n  // }));\r\n\r\n  codecsToPerform.forEach(([codec, type]) => {\r\n    const channel = mainChannels.find((line) => line.mediaType === type);\r\n    if(!channel) {\r\n      return;\r\n    }\r\n\r\n    const extmap = performExtmap(channel);\r\n    forEachReverse(codec[\"rtp-hdrexts\"], (value, index, arr) => {\r\n      if(extmap[value.id] !== value.uri) {\r\n        arr.splice(index, 1);\r\n        console.log(`[sdp] filtered extmap:`, value, index, type);\r\n      }\r\n    });\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport forEachReverse from \"../../../helpers/array/forEachReverse\";\r\nimport copy from \"../../../helpers/object/copy\";\r\nimport { ConferenceEntry } from \"../localConferenceDescription\";\r\nimport { parseSdp, addSimulcast } from \"../sdp/utils\";\r\nimport { generateMediaFirstLine, SDPBuilder } from \"../sdpBuilder\";\r\nimport { UpdateGroupCallConnectionData } from \"../types\";\r\nimport parseMediaSectionInfo from \"./parseMediaSectionInfo\";\r\n\r\nexport default function fixLocalOffer(options: {\r\n  offer: RTCSessionDescriptionInit, \r\n  data: UpdateGroupCallConnectionData,\r\n  skipAddingMulticast?: boolean\r\n  // mids?: string[]\r\n}) {\r\n  const {offer, data} = options;\r\n  const sdp = parseSdp(offer.sdp);\r\n  let hasMunged = false;\r\n\r\n  if(!options.skipAddingMulticast) {\r\n    hasMunged = addSimulcast(sdp) || hasMunged;\r\n  }\r\n\r\n  // const bundleLine = parsedSdp.session.lines.find((line) => line.Ha?.key === 'group');\r\n  // const bundleMids = bundleLine.value.split(' ').slice(1);\r\n\r\n  forEachReverse(sdp.media, (section, idx, arr) => {\r\n    // const mid = section.oa.get('mid').oa;\r\n\r\n    //        . -    \r\n    // !     ,  \r\n    /* if(mids && !mids.includes(mid) && !bundleMids.includes(mid)) {\r\n      console.error('wtf');\r\n      hasMunged = true;\r\n      arr.splice(idx, 1);\r\n      return;\r\n    } */\r\n\r\n    if(/* section.mediaType !== 'video' ||  */section.isSending) {\r\n      return;\r\n    }\r\n\r\n    if(section.mediaType === 'application') {\r\n      return;\r\n    }\r\n\r\n    const mediaLine = section.mediaLine;\r\n    const mediaLineParts = mediaLine.mediaLineParts;\r\n    const mediaCodecIds = mediaLineParts.ids;\r\n    const localMLine = mediaLine.toString();\r\n\r\n    const codec = data[section.mediaType];\r\n    const payloadTypes = codec['payload-types'];\r\n\r\n    /* forEachReverse(payloadTypes, (payloadType, idx, arr) => {\r\n      if(!mediaCodecIds.includes('' + payloadType.id) && section.mediaType === 'video') {\r\n      // if(payloadType.name === 'H265') {\r\n        console.warn('[sdp] filtered unsupported codec', payloadType, mediaCodecIds, section.mediaType);\r\n        arr.splice(idx, 1);\r\n      }\r\n    }); */\r\n\r\n    const codecIds = payloadTypes.map((payload) => '' + payload.id);\r\n    const correctMLine = generateMediaFirstLine(section.mediaType, undefined, codecIds);\r\n    \r\n    if(localMLine !== correctMLine) {\r\n      const sectionInfo = parseMediaSectionInfo(sdp, section);\r\n\r\n      let newData = {...data};\r\n      newData.transport = copy(newData.transport);\r\n      newData.transport.ufrag = sectionInfo.ufrag;\r\n      newData.transport.pwd = sectionInfo.pwd;\r\n      newData.transport.fingerprints = [sectionInfo.fingerprint];\r\n      newData.transport.candidates = [];\r\n\r\n      const entry = new ConferenceEntry(sectionInfo.mid, mediaLineParts.type);\r\n      entry.setPort(mediaLineParts.port);\r\n      sectionInfo.source && entry.setSource(sectionInfo.sourceGroups || sectionInfo.source);\r\n      entry.setDirection(section.direction);\r\n\r\n      const newSdp = new SDPBuilder().addSsrcEntry(entry, newData).finalize();\r\n\r\n      const newChannel = parseSdp(newSdp).media[0];\r\n      arr[idx] = newChannel;\r\n\r\n      hasMunged = true;\r\n    }\r\n  });\r\n\r\n  if(hasMunged) {\r\n    const mungedSdp = sdp.toString();\r\n    offer.sdp = mungedSdp;\r\n  }\r\n\r\n  return {offer, sdp/* , bundleMids */};\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { GroupCallConnectionType, GroupCallId, GroupCallOutputSource } from \"../appManagers/appGroupCallsManager\";\r\nimport { IS_SAFARI } from \"../../environment/userAgent\";\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport throttle from \"../../helpers/schedulers/throttle\";\r\nimport { GroupCall, GroupCallParticipant } from \"../../layer\";\r\nimport { logger } from \"../logger\";\r\nimport { NULL_PEER_ID } from \"../mtproto/mtproto_config\";\r\nimport rootScope from \"../rootScope\";\r\nimport CallInstanceBase, { TryAddTrackOptions } from \"./callInstanceBase\";\r\nimport GroupCallConnectionInstance from \"./groupCallConnectionInstance\";\r\nimport GROUP_CALL_STATE from \"./groupCallState\";\r\nimport getScreenConstraints from \"./helpers/getScreenConstraints\";\r\nimport getScreenStream from \"./helpers/getScreenStream\";\r\nimport getStream from \"./helpers/getStream\";\r\nimport getVideoConstraints from \"./helpers/getVideoConstraints\";\r\nimport stopTrack from \"./helpers/stopTrack\";\r\nimport localConferenceDescription from \"./localConferenceDescription\";\r\nimport { WebRTCLineType } from \"./sdpBuilder\";\r\nimport StreamManager from \"./streamManager\";\r\nimport { Ssrc } from \"./types\";\r\nimport getPeerId from \"../appManagers/utils/peers/getPeerId\";\r\nimport { AppManagers } from \"../appManagers/managers\";\r\nimport { generateSelfVideo, makeSsrcFromParticipant, makeSsrcsFromParticipant } from \"./groupCallsController\";\r\n\r\nexport default class GroupCallInstance extends CallInstanceBase<{\r\n  state: (state: GROUP_CALL_STATE) => void,\r\n  pinned: (source?: GroupCallOutputSource) => void,\r\n}> {\r\n  public id: GroupCallId;\r\n  public chatId: ChatId;\r\n  public handleUpdateGroupCallParticipants: boolean;\r\n  public updatingSdp: boolean;\r\n  public isSpeakingMap: Map<any, any>;\r\n  public connections: {[k in GroupCallConnectionType]?: GroupCallConnectionInstance};\r\n  public groupCall: GroupCall;\r\n  public participant: GroupCallParticipant;\r\n  \r\n  // will be set with negotiation\r\n  public joined: boolean;\r\n  \r\n  private pinnedSources: Array<GroupCallOutputSource>;\r\n  private participantsSsrcs: Map<PeerId, Ssrc[]>;\r\n  private hadAutoPinnedSources: Set<GroupCallOutputSource>;\r\n  private dispatchPinnedThrottled: () => void;\r\n  private startVideoSharingPromise: Promise<void>;\r\n  private startScreenSharingPromise: Promise<void>;\r\n\r\n  private managers: AppManagers;\r\n\r\n  constructor(options: {\r\n    id: GroupCallInstance['id'],\r\n    chatId: GroupCallInstance['chatId'],\r\n    isSpeakingMap?: GroupCallInstance['isSpeakingMap'],\r\n    connections?: GroupCallInstance['connections'],\r\n    managers: AppManagers\r\n  }) {\r\n    super();\r\n\r\n    safeAssign(this, options);\r\n\r\n    if(!this.log) {\r\n      this.log = logger('GROUP-CALL');\r\n    }\r\n\r\n    if(!this.connections) {\r\n      this.connections = {};\r\n    }\r\n\r\n    if(!this.isSpeakingMap) {\r\n      this.isSpeakingMap = new Map();\r\n    }\r\n\r\n    this.pinnedSources = [];\r\n    this.participantsSsrcs = new Map();\r\n    this.hadAutoPinnedSources = new Set();\r\n    this.dispatchPinnedThrottled = throttle(() => {\r\n      this.dispatchEvent('pinned', this.pinnedSource);\r\n    }, 0, false);\r\n\r\n    this.addEventListener('state', (state) => {\r\n      if(state === GROUP_CALL_STATE.CLOSED) {\r\n        this.cleanup();\r\n      }\r\n    });\r\n  }\r\n\r\n  get connectionState() {\r\n    return this.connections.main.connection.iceConnectionState;\r\n  }\r\n\r\n  get state() {\r\n    const {connectionState} = this;\r\n    if(connectionState === 'closed') {\r\n      return GROUP_CALL_STATE.CLOSED;\r\n    } else if(connectionState !== 'connected' && (!IS_SAFARI || connectionState !== 'completed')) {\r\n      return GROUP_CALL_STATE.CONNECTING;\r\n    } else {\r\n      const {participant} = this;\r\n      if(!participant.pFlags.can_self_unmute) {\r\n        return GROUP_CALL_STATE.MUTED_BY_ADMIN;\r\n      } else if(participant.pFlags.muted) {\r\n        return GROUP_CALL_STATE.MUTED;\r\n      } else {\r\n        return GROUP_CALL_STATE.UNMUTED;\r\n      }\r\n    }\r\n  }\r\n\r\n  get participants() {\r\n    return this.managers.appGroupCallsManager.getCachedParticipants(this.id);\r\n  }\r\n\r\n  get isSharingScreen() {\r\n    return !!this.connections.presentation;\r\n  }\r\n\r\n  get pinnedSource() {\r\n    return this.pinnedSources[this.pinnedSources.length - 1];\r\n  }\r\n\r\n  public get isMuted() {\r\n    return this.state !== GROUP_CALL_STATE.UNMUTED;\r\n  }\r\n\r\n  public get isClosing() {\r\n    const {state} = this;\r\n    return state === GROUP_CALL_STATE.CLOSED;\r\n  }\r\n\r\n  public get streamManager(): StreamManager {\r\n    return this.connections.main.streamManager;\r\n  }\r\n\r\n  public get description(): localConferenceDescription {\r\n    return this.connections.main.description;\r\n  }\r\n\r\n  public pinSource(source: GroupCallOutputSource) {\r\n    indexOfAndSplice(this.pinnedSources, source);\r\n    this.pinnedSources.push(source);\r\n    this.dispatchPinnedThrottled();\r\n  }\r\n\r\n  public unpinSource(source: GroupCallOutputSource) {\r\n    this.hadAutoPinnedSources.delete(source);\r\n    indexOfAndSplice(this.pinnedSources, source);\r\n    this.dispatchPinnedThrottled();\r\n  }\r\n\r\n  public unpinAll() {\r\n    this.pinnedSources.length = 0;\r\n    this.dispatchPinnedThrottled();\r\n  }\r\n\r\n  public async getParticipantByPeerId(peerId: PeerId) {\r\n    return NULL_PEER_ID === peerId ? this.participant : (await this.participants).get(peerId);\r\n  }\r\n\r\n  public toggleMuted() {\r\n    return this.requestAudioSource(true).then(() => this.changeUserMuted(NULL_PEER_ID));\r\n  }\r\n\r\n  public async changeUserMuted(peerId: PeerId, muted?: boolean) {\r\n    const participant = await this.getParticipantByPeerId(peerId);\r\n    if(NULL_PEER_ID === peerId && participant.pFlags.can_self_unmute) {\r\n      muted = muted === undefined ? !participant.pFlags.muted : muted;\r\n    }\r\n\r\n    return this.editParticipant(participant, {muted});\r\n  }\r\n\r\n  public getElement(endpoint: GroupCallOutputSource) {\r\n    return super.getElement(endpoint);\r\n  }\r\n\r\n  public getVideoElementFromParticipantByType(participant: GroupCallParticipant, type: 'video' | 'presentation') {\r\n    let source: GroupCallOutputSource;\r\n    if(participant.pFlags.self) {\r\n      const connectionType: GroupCallConnectionType = type === 'video' ? 'main' : 'presentation';\r\n      source = connectionType;\r\n    } else {\r\n      const codec = participant[type];\r\n      source = codec.source_groups[0].sources[0];\r\n    }\r\n\r\n    const element = this.getElement(source) as HTMLVideoElement;\r\n    if(!element) return;\r\n\r\n    const clone = element.cloneNode() as typeof element;\r\n    clone.srcObject = element.srcObject;\r\n    return {video: clone, source};\r\n  }\r\n\r\n  public createConnectionInstance(options: {\r\n    streamManager: StreamManager,\r\n    type: GroupCallConnectionType,\r\n    options: GroupCallConnectionInstance['options'],\r\n  }) {\r\n    return this.connections[options.type] = new GroupCallConnectionInstance({\r\n      groupCall: this,\r\n      log: this.log.bindPrefix(options.type),\r\n      managers: this.managers,\r\n      ...options\r\n    });\r\n  }\r\n\r\n  public changeRaiseHand(raise: boolean) {\r\n    return this.editParticipant(this.participant, {raiseHand: raise});\r\n  }\r\n\r\n  public async startScreenSharingInternal() {\r\n    try {\r\n      const type: GroupCallConnectionType = 'presentation';\r\n\r\n      const stream = await getScreenStream(getScreenConstraints());\r\n      const streamManager = new StreamManager();\r\n      \r\n      const connectionInstance = this.createConnectionInstance({\r\n        streamManager,\r\n        type,\r\n        options: {\r\n          type\r\n        }\r\n      });\r\n      \r\n      const connection = connectionInstance.createPeerConnection();\r\n      connection.addEventListener('negotiationneeded', () => {\r\n        connectionInstance.negotiate();\r\n      });\r\n\r\n      stream.getVideoTracks()[0].addEventListener('ended', () => {\r\n        if(this.connections.presentation) { // maybe user has stopped screensharing through browser's ui\r\n          this.stopScreenSharing();\r\n        }\r\n      }, {once: true});\r\n      \r\n      connectionInstance.createDescription();\r\n      connectionInstance.addInputVideoStream(stream);\r\n    } catch(err) {\r\n      this.log.error('start screen sharing error', err);\r\n    }\r\n  }\r\n\r\n  public startScreenSharing() {\r\n    return this.startScreenSharingPromise ??= this.startScreenSharingInternal().finally(() => {\r\n      this.startScreenSharingPromise = undefined;\r\n    });\r\n  }\r\n\r\n  public stopScreenSharing() {\r\n    const connectionInstance = this.connections.presentation;\r\n    if(!connectionInstance) {\r\n      return Promise.resolve();\r\n    }\r\n\r\n    delete this.connections.presentation;\r\n    this.unpinSource('presentation');\r\n    connectionInstance.closeConnectionAndStream(true);\r\n\r\n    delete this.participant.presentation;\r\n    this.managers.appGroupCallsManager.saveApiParticipant(this.id, this.participant);\r\n\r\n    return this.managers.appGroupCallsManager.leaveGroupCallPresentation(this.id);\r\n  }\r\n\r\n  public toggleScreenSharing() {\r\n    if(this.isSharingScreen) {\r\n      return this.stopScreenSharing();\r\n    } else {\r\n      return this.startScreenSharing();\r\n    }\r\n  }\r\n\r\n  public async startVideoSharingInternal() {\r\n    const constraints: MediaStreamConstraints = {\r\n      video: getVideoConstraints()\r\n    };\r\n\r\n    try {\r\n      const stream = await getStream(constraints, false);\r\n      const connectionInstance = this.connections.main;\r\n      connectionInstance.addInputVideoStream(stream);\r\n\r\n      await this.editParticipant(this.participant, {\r\n        videoPaused: false,\r\n        videoStopped: false\r\n      });\r\n    } catch(err) {\r\n      this.log.error('startVideoSharing error', err, constraints);\r\n    }\r\n  }\r\n\r\n  public startVideoSharing() {\r\n    return this.startVideoSharingPromise ??= this.startVideoSharingInternal().finally(() => {\r\n      this.startVideoSharingPromise = undefined;\r\n    });\r\n  }\r\n\r\n  public async stopVideoSharing() {\r\n    const connectionInstance = this.connections.main;\r\n    const track = connectionInstance.streamManager.inputStream.getVideoTracks()[0];\r\n    if(!track) {\r\n      return;\r\n    }\r\n\r\n    stopTrack(track);\r\n    connectionInstance.streamManager.appendToConference(connectionInstance.description); // clear sender track\r\n\r\n    await this.editParticipant(this.participant, {\r\n      videoStopped: true\r\n    });\r\n  }\r\n\r\n  public toggleVideoSharing() {\r\n    if(this.isSharingVideo) {\r\n      return this.stopVideoSharing();\r\n    } else {\r\n      return this.startVideoSharing();\r\n    }\r\n  }\r\n\r\n  public async hangUp(discard = false, rejoin = false, isDiscarded = false) {\r\n    for(const type in this.connections) {\r\n      const connection = this.connections[type as GroupCallConnectionType];\r\n      connection.closeConnectionAndStream(!rejoin);\r\n    }\r\n\r\n    this.dispatchEvent('state', this.state);\r\n\r\n    if(isDiscarded) {\r\n      return;\r\n    }\r\n    \r\n    if(!rejoin) {\r\n      let d = discard || (this.joined ? this.connections.main.sources.audio.source : undefined);\r\n      this.managers.appGroupCallsManager.hangUp(this.id, d);\r\n    }\r\n  }\r\n\r\n  public tryAddTrack(options: Omit<TryAddTrackOptions, 'streamManager'>) {\r\n    const {description} = this;\r\n    const source = super.tryAddTrack(options);\r\n    \r\n    if(options.type === 'output') {\r\n      const entry = description.getEntryBySource(+source);\r\n      this.getParticipantByPeerId(entry.peerId).then((participant) => {\r\n        if(participant) {\r\n          rootScope.dispatchEvent('group_call_participant', {groupCallId: this.id, participant});\r\n        }\r\n      });\r\n    }\r\n\r\n    return source;\r\n  }\r\n\r\n  public async editParticipant(participant: GroupCallParticipant, options: Partial<{\r\n    muted: boolean,\r\n    volume: number,\r\n    raiseHand: boolean,\r\n    videoStopped: boolean,\r\n    videoPaused: boolean,\r\n    presentationPaused: boolean\r\n  }>) {\r\n    if(!Object.keys(options).length) {\r\n      return;\r\n    }\r\n\r\n    // let processUpdate = true;\r\n    if(participant) {\r\n      // const {currentGroupCall} = this;\r\n      // const isCurrentCall = currentGroupCall?.id === groupCallId;\r\n      const isCurrentCall = true;\r\n      const isUpdatingMeInCurrentCall = isCurrentCall && participant.pFlags.self;\r\n\r\n      if(isUpdatingMeInCurrentCall) {\r\n        if(options.muted !== undefined && !this.isSharingAudio) {\r\n          delete options.muted;\r\n\r\n          if(!Object.keys(options).length) {\r\n            return;\r\n          }\r\n        }\r\n      }\r\n\r\n      // if(isCurrentCall) {\r\n        const muted = options.muted;\r\n        if(muted !== undefined) {\r\n          /* const isAdmin = appChatsManager.hasRights(currentGroupCall.chatId, 'manage_call');\r\n          if(isAdmin) {\r\n            if(muted) {\r\n              participant.pFlags.muted = true;\r\n              delete participant.pFlags.can_self_unmute;\r\n            } else {\r\n              participant.pFlags.can_self_unmute = true;\r\n            }\r\n          } else  */if(participant.pFlags.self) {\r\n            if(muted) {\r\n              participant.pFlags.muted = true;\r\n            } else if(participant.pFlags.can_self_unmute) {\r\n              delete participant.pFlags.muted;\r\n            }\r\n          }/*  else {\r\n            if(muted) {\r\n              participant.pFlags.muted_by_you = true;\r\n            } else {\r\n              delete participant.pFlags.muted_by_you;\r\n            }\r\n          } */\r\n        }\r\n      // }\r\n\r\n      /* const a: [keyof GroupCallParticipant['pFlags'], keyof typeof options][] = [\r\n        ['muted', 'muted']\r\n      ];\r\n\r\n      a.forEach(([key, optionKey]) => {\r\n        const value = options[optionKey];\r\n        if(value === undefined) {\r\n          return;\r\n        }\r\n\r\n        if(value) {\r\n          participant.pFlags[key] = true;\r\n        } else {\r\n          delete participant.pFlags[key];\r\n        }\r\n      }); */\r\n\r\n      if(options.raiseHand !== undefined) {\r\n        if(options.raiseHand) participant.raise_hand_rating = '1';\r\n        else delete participant.raise_hand_rating;\r\n      }\r\n\r\n      if(isUpdatingMeInCurrentCall) {\r\n        if(options.videoStopped !== undefined) {\r\n          if(options.videoStopped) delete participant.video;\r\n          else participant.video = generateSelfVideo(this.connections.main.sources.video);\r\n        }\r\n\r\n        if(!participant.pFlags.muted && participant.pFlags.can_self_unmute) {\r\n          this.setMuted(false);\r\n        }\r\n\r\n        this.dispatchEvent('state', this.state);\r\n      }\r\n\r\n      // rootScope.dispatchEvent('group_call_participant', {groupCallId, participant});\r\n\r\n      /* if(participant.pFlags.self) {\r\n        processUpdate = false;\r\n      } */\r\n    }\r\n\r\n    return this.managers.appGroupCallsManager.editParticipant(this.id, participant, options);\r\n  }\r\n\r\n  public onParticipantUpdate(participant: GroupCallParticipant, doNotDispatchParticipantUpdate?: PeerId) {\r\n    const connectionInstance = this.connections.main;\r\n    const {connection, description} = connectionInstance;\r\n\r\n    const peerId = getPeerId(participant.peer);\r\n    const hasLeft = !!participant.pFlags.left;\r\n    const oldSsrcs = this.participantsSsrcs.get(peerId) || [];\r\n\r\n    if(participant.presentation && !hasLeft) {\r\n      const {source} = makeSsrcFromParticipant(participant, 'video', participant.presentation.source_groups, participant.presentation.endpoint);\r\n      if(!this.hadAutoPinnedSources.has(source)) {\r\n        this.hadAutoPinnedSources.add(source);\r\n        this.pinSource(participant.pFlags.self ? 'presentation' : source);\r\n      }\r\n    }\r\n\r\n    if(participant.pFlags.self) {\r\n      this.participant = participant;\r\n\r\n      if(connectionInstance.sources.audio.source !== participant.source) {\r\n        this.hangUp();\r\n      }\r\n\r\n      let mute = false;\r\n      if(!participant.pFlags.can_self_unmute) {\r\n        this.stopScreenSharing();\r\n        this.stopVideoSharing();\r\n        mute = true;\r\n      } else if(participant.pFlags.muted) {\r\n        mute = true;\r\n      }\r\n\r\n      if(mute) {\r\n        this.setMuted(true);\r\n      }\r\n\r\n      if(doNotDispatchParticipantUpdate !== peerId) {\r\n        this.dispatchEvent('state', this.state);\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    const ssrcs = hasLeft ? [] : makeSsrcsFromParticipant(participant);\r\n\r\n    if(!hasLeft) {\r\n      this.participantsSsrcs.set(peerId, ssrcs);\r\n    } else {\r\n      this.participantsSsrcs.delete(peerId);\r\n    }\r\n\r\n    // const TEST_OLD = false;\r\n\r\n    const modifiedTypes: Set<WebRTCLineType> = new Set();\r\n    oldSsrcs.forEach((oldSsrc) => {\r\n      const oldSource = oldSsrc.source;\r\n      const newSsrc = ssrcs.find((ssrc) => ssrc.source === oldSource);\r\n      if(!newSsrc) {\r\n        this.unpinSource(oldSource);\r\n\r\n        const oldEntry = description.getEntryBySource(oldSource);\r\n        if(oldEntry && oldEntry.direction !== 'inactive') {\r\n          oldEntry.setDirection('inactive');\r\n          modifiedTypes.add(oldEntry.type);\r\n        }\r\n      }\r\n    });\r\n\r\n    ssrcs.forEach((ssrc) => {\r\n      let entry = description.getEntryBySource(ssrc.source);\r\n      if(entry) {\r\n        if(entry.direction === 'inactive') {\r\n          entry.setDirection(entry.originalDirection);\r\n          modifiedTypes.add(entry.type);\r\n        }\r\n\r\n        return;\r\n      }\r\n\r\n      entry = description.createEntry(ssrc.type);\r\n      description.setEntrySource(entry, ssrc.sourceGroups || ssrc.source);\r\n      description.setEntryPeerId(entry, peerId);\r\n\r\n      // if(TEST_OLD) {\r\n      //   description.bundleMids.push(entry.mid);\r\n      //   entry.setDirection('recvonly');\r\n      // } else {\r\n        ssrc.type === 'video' && entry.setEndpoint(ssrc.endpoint);\r\n        entry.createTransceiver(connection, {direction: 'recvonly'});\r\n      // }\r\n\r\n      modifiedTypes.add(entry.type);\r\n    });\r\n\r\n    /* if(TEST_OLD) {\r\n      this.setRemoteOffer({\r\n        connection,\r\n        description,\r\n        ssrcs\r\n      });\r\n    } else  */if(modifiedTypes.size) {\r\n      if(modifiedTypes.has('video')) {\r\n        connectionInstance.updateConstraints = true;\r\n      }\r\n\r\n      connectionInstance.negotiateThrottled();\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getGroupCallAudioAsset from \"../../components/groupCall/getAudioAsset\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport EventListenerBase from \"../../helpers/eventListenerBase\";\r\nimport { GroupCallParticipant, GroupCallParticipantVideo, GroupCallParticipantVideoSourceGroup } from \"../../layer\";\r\nimport { GroupCallId, GroupCallConnectionType } from \"../appManagers/appGroupCallsManager\";\r\nimport { AppManagers } from \"../appManagers/managers\";\r\nimport { logger } from \"../logger\";\r\nimport rootScope from \"../rootScope\";\r\nimport GroupCallInstance from \"./groupCallInstance\";\r\nimport GROUP_CALL_STATE from \"./groupCallState\";\r\nimport createMainStreamManager from \"./helpers/createMainStreamManager\";\r\nimport { generateSsrc } from \"./localConferenceDescription\";\r\nimport { WebRTCLineType } from \"./sdpBuilder\";\r\nimport StreamManager from \"./streamManager\";\r\nimport { Ssrc } from \"./types\";\r\n\r\nlet IS_MUTED = true;\r\n\r\nexport function makeSsrcsFromParticipant(participant: GroupCallParticipant) {\r\n  return [\r\n    makeSsrcFromParticipant(participant, 'audio', participant.source),\r\n    participant.video?.audio_source && makeSsrcFromParticipant(participant, 'audio', participant.video.audio_source),\r\n    participant.video && makeSsrcFromParticipant(participant, 'video', participant.video.source_groups, participant.video.endpoint),\r\n    participant.presentation?.audio_source && makeSsrcFromParticipant(participant, 'audio', participant.presentation.audio_source),\r\n    participant.presentation && makeSsrcFromParticipant(participant, 'video', participant.presentation.source_groups, participant.presentation.endpoint)\r\n  ].filter(Boolean);\r\n};\r\n\r\nexport function makeSsrcFromParticipant(participant: GroupCallParticipant, type: WebRTCLineType, source?: number | GroupCallParticipantVideoSourceGroup[], endpoint?: string): Ssrc {\r\n  return generateSsrc(type, source, endpoint);\r\n}\r\n\r\nexport function generateSelfVideo(source: Ssrc, audioSource?: number): GroupCallParticipantVideo {\r\n  return source && {\r\n    _: 'groupCallParticipantVideo',\r\n    pFlags: {},\r\n    endpoint: '',\r\n    source_groups: source.sourceGroups,\r\n    audio_source: audioSource\r\n  };\r\n}\r\n\r\nexport class GroupCallsController extends EventListenerBase<{\r\n  instance: (instance: GroupCallInstance) => void\r\n}> {\r\n  private audioAsset: ReturnType<typeof getGroupCallAudioAsset>;\r\n  private log: ReturnType<typeof logger>;\r\n  private currentGroupCall: GroupCallInstance;\r\n  private managers: AppManagers;\r\n\r\n  public construct(managers: AppManagers) {\r\n    this.managers = managers;\r\n    this.audioAsset = getGroupCallAudioAsset();\r\n    this.log = logger('GCC');\r\n\r\n    rootScope.addEventListener('group_call_update', (groupCall) => {\r\n      const {currentGroupCall} = this;\r\n      if(currentGroupCall?.id === groupCall.id) {\r\n        currentGroupCall.groupCall = groupCall;\r\n        \r\n        if(groupCall._ === 'groupCallDiscarded') {\r\n          currentGroupCall.hangUp(false, false, true);\r\n        }\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('group_call_participant', ({groupCallId, participant}) => {\r\n      const {currentGroupCall} = this;\r\n      if(currentGroupCall?.id === groupCallId) {\r\n        currentGroupCall.onParticipantUpdate(participant/* , this.doNotDispatchParticipantUpdate */);\r\n      }\r\n    });\r\n  }\r\n\r\n  get groupCall() {\r\n    return this.currentGroupCall;\r\n  }\r\n\r\n  public setCurrentGroupCall(groupCall: GroupCallInstance) {\r\n    this.currentGroupCall = groupCall;\r\n\r\n    if(groupCall) {\r\n      this.dispatchEvent('instance', groupCall);\r\n    }\r\n  }\r\n\r\n  public startConnectingSound() {\r\n    this.stopConnectingSound();\r\n    this.audioAsset.playSoundWithTimeout('group_call_connect.mp3', true, 2500);\r\n  }\r\n  \r\n  public stopConnectingSound() {\r\n    this.audioAsset.stopSound();\r\n    this.audioAsset.cancelDelayedPlay();\r\n  }\r\n\r\n  public async joinGroupCall(chatId: ChatId, groupCallId: GroupCallId, muted = IS_MUTED, rejoin?: boolean, joinVideo?: boolean) {\r\n    this.audioAsset.createAudio();\r\n\r\n    this.log(`joinGroupCall chatId=${chatId} id=${groupCallId} muted=${muted} rejoin=${rejoin}`);\r\n    \r\n    let streamManager: StreamManager;\r\n    if(rejoin) {\r\n      streamManager = this.currentGroupCall.connections.main.streamManager;\r\n    } else {\r\n      streamManager = await createMainStreamManager(muted, joinVideo);\r\n    }\r\n\r\n    return this.joinGroupCallInternal(chatId, groupCallId, streamManager, muted, rejoin, joinVideo);\r\n  }\r\n\r\n  public async joinGroupCallInternal(chatId: ChatId, groupCallId: GroupCallId, streamManager: StreamManager, muted: boolean, rejoin = false, joinVideo?: boolean) {\r\n    const log = this.log.bindPrefix('joinGroupCallInternal');\r\n    log('start', groupCallId);\r\n\r\n    const type: GroupCallConnectionType = 'main';\r\n\r\n    let {currentGroupCall} = this;\r\n    if(currentGroupCall && rejoin) {\r\n      // currentGroupCall.connections.main.connection = connection;\r\n      currentGroupCall.handleUpdateGroupCallParticipants = false;\r\n      currentGroupCall.updatingSdp = false;\r\n      log('update currentGroupCall', groupCallId, currentGroupCall);\r\n    } else {\r\n      currentGroupCall = new GroupCallInstance({\r\n        chatId,\r\n        id: groupCallId,\r\n        managers: this.managers\r\n      });\r\n\r\n      currentGroupCall.fixSafariAudio();\r\n\r\n      currentGroupCall.addEventListener('state', (state) => {\r\n        if(this.currentGroupCall === currentGroupCall && state === GROUP_CALL_STATE.CLOSED) {\r\n          this.setCurrentGroupCall(null);\r\n          this.stopConnectingSound();\r\n          this.audioAsset.playSound('group_call_end.mp3');\r\n          rootScope.dispatchEvent('chat_update', currentGroupCall.chatId);\r\n        }\r\n      });\r\n\r\n      currentGroupCall.groupCall = await this.managers.appGroupCallsManager.getGroupCallFull(groupCallId);\r\n\r\n      const connectionInstance = currentGroupCall.createConnectionInstance({\r\n        streamManager,\r\n        type,\r\n        options: {\r\n          type,\r\n          isMuted: muted,\r\n          joinVideo,\r\n          rejoin\r\n        }\r\n      });\r\n\r\n      const connection = connectionInstance.createPeerConnection();\r\n      connection.addEventListener('negotiationneeded', () => {\r\n        connectionInstance.negotiate();\r\n      });\r\n\r\n      connection.addEventListener('track', (event) => {\r\n        log('ontrack', event);\r\n        currentGroupCall.onTrack(event);\r\n      });\r\n  \r\n      connection.addEventListener('iceconnectionstatechange', () => {\r\n        currentGroupCall.dispatchEvent('state', currentGroupCall.state);\r\n        \r\n        const {iceConnectionState} = connection;\r\n        if(iceConnectionState === 'disconnected' || iceConnectionState === 'checking' || iceConnectionState === 'new') {\r\n          this.startConnectingSound();\r\n        } else {\r\n          this.stopConnectingSound();\r\n        }\r\n        \r\n        switch(iceConnectionState) {\r\n          case 'checking': {\r\n            break;\r\n          }\r\n          \r\n          case 'closed': {\r\n            currentGroupCall.hangUp();\r\n            break;\r\n          }\r\n          \r\n          case 'completed': {\r\n            break;\r\n          }\r\n          \r\n          case 'connected': {\r\n            if(!currentGroupCall.joined) {\r\n              currentGroupCall.joined = true;\r\n              this.audioAsset.playSound('group_call_start.mp3');\r\n              this.managers.appGroupCallsManager.getGroupCallParticipants(groupCallId);\r\n            }\r\n            \r\n            break;\r\n          }\r\n          \r\n          case 'disconnected': {\r\n            break;\r\n          }\r\n          \r\n          case 'failed': {\r\n            //TODO: replace with ICE restart\r\n            currentGroupCall.hangUp();\r\n            // connection.restartIce();\r\n            break;\r\n          }\r\n          \r\n          case 'new': {\r\n            break;\r\n          }\r\n        }\r\n      });\r\n\r\n      connectionInstance.createDescription();\r\n      connectionInstance.createDataChannel();\r\n\r\n      connectionInstance.appendStreamToConference();\r\n\r\n      this.setCurrentGroupCall(currentGroupCall);\r\n      log('set currentGroupCall', groupCallId, currentGroupCall);\r\n\r\n      this.startConnectingSound();\r\n\r\n      return connectionInstance.negotiate();\r\n    }\r\n  }\r\n}\r\n\r\nconst groupCallsController = new GroupCallsController();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.groupCallController = groupCallsController);\r\nexport default groupCallsController;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { GROUP_CALL_AMPLITUDE_ANALYSE_INTERVAL_MS } from \"../constants\";\r\nimport StreamManager from \"../streamManager\";\r\nimport getAudioConstraints from \"./getAudioConstraints\";\r\nimport getStream from \"./getStream\";\r\nimport getVideoConstraints from \"./getVideoConstraints\";\r\n\r\nexport default async function createMainStreamManager(muted?: boolean, joinVideo?: boolean) {\r\n  const constraints: MediaStreamConstraints = {\r\n    audio: getAudioConstraints(),\r\n    video: joinVideo && getVideoConstraints()\r\n  };\r\n\r\n  const streamManager = new StreamManager(GROUP_CALL_AMPLITUDE_ANALYSE_INTERVAL_MS);\r\n  \r\n  try {\r\n    const stream = await getStream(constraints, muted);\r\n    streamManager.addStream(stream, 'input');\r\n  } catch(err) {\r\n    console.error('joinGroupCall getStream error', err, constraints);\r\n    streamManager.inputStream = new MediaStream();\r\n  }\r\n\r\n  return streamManager;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { Channel } from \"../../lib/appManagers/appChatsManager\";\r\nimport type { AppSidebarRight } from \"../sidebarRight\";\r\nimport type Chat from \"./chat\";\r\nimport { RIGHT_COLUMN_ACTIVE_CLASSNAME } from \"../sidebarRight\";\r\nimport mediaSizes, { ScreenSize } from \"../../helpers/mediaSizes\";\r\nimport { IS_SAFARI } from \"../../environment/userAgent\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport AvatarElement from \"../avatar\";\r\nimport Button from \"../button\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport ButtonMenuToggle from \"../buttonMenuToggle\";\r\nimport ChatAudio from \"./audio\";\r\nimport ChatPinnedMessage from \"./pinnedMessage\";\r\nimport { ButtonMenuItemOptions } from \"../buttonMenu\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport PopupDeleteDialog from \"../popups/deleteDialog\";\r\nimport appNavigationController from \"../appNavigationController\";\r\nimport { LEFT_COLUMN_ACTIVE_CLASSNAME } from \"../sidebarLeft\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport blurActiveElement from \"../../helpers/dom/blurActiveElement\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport { toast, toastNew } from \"../toast\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport { ChatFull, Chat as MTChat, GroupCall } from \"../../layer\";\r\nimport PopupPickUser from \"../popups/pickUser\";\r\nimport PopupPeer from \"../popups/peer\";\r\nimport { fastRaf } from \"../../helpers/schedulers\";\r\nimport AppEditContactTab from \"../sidebarRight/tabs/editContact\";\r\nimport appMediaPlaybackController from \"../appMediaPlaybackController\";\r\nimport IS_GROUP_CALL_SUPPORTED from \"../../environment/groupCallSupport\";\r\nimport IS_CALL_SUPPORTED from \"../../environment/callSupport\";\r\nimport { CallType } from \"../../lib/calls/types\";\r\nimport PopupMute from \"../popups/mute\";\r\nimport generateTitleIcons from \"../generateTitleIcons\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport hasRights from \"../../lib/appManagers/utils/chats/hasRights\";\r\nimport wrapPeerTitle from \"../wrappers/peerTitle\";\r\nimport groupCallsController from \"../../lib/calls/groupCallsController\";\r\nimport apiManagerProxy from \"../../lib/mtproto/mtprotoworker\";\r\n\r\ntype ButtonToVerify = {element?: HTMLElement, verify: () => boolean | Promise<boolean>};\r\n\r\nexport default class ChatTopbar {\r\n  public container: HTMLDivElement;\r\n  private btnBack: HTMLButtonElement;\r\n  private chatInfo: HTMLDivElement;\r\n  private avatarElement: AvatarElement;\r\n  private title: HTMLDivElement;\r\n  private subtitle: HTMLDivElement;\r\n  private chatUtils: HTMLDivElement;\r\n  private btnJoin: HTMLButtonElement;\r\n  private btnPinned: HTMLButtonElement;\r\n  private btnCall: HTMLButtonElement;\r\n  private btnGroupCall: HTMLButtonElement;\r\n  private btnMute: HTMLButtonElement;\r\n  private btnSearch: HTMLButtonElement;\r\n  private btnMore: HTMLElement;\r\n  \r\n  private chatAudio: ChatAudio;\r\n  public pinnedMessage: ChatPinnedMessage;\r\n\r\n  private setUtilsRAF: number;\r\n  private setPeerStatusInterval: number;\r\n\r\n  public listenerSetter: ListenerSetter;\r\n\r\n  private menuButtons: (ButtonMenuItemOptions & {verify: ButtonToVerify['verify']})[];\r\n  private buttonsToVerify: ButtonToVerify[];\r\n  private chatInfoContainer: HTMLDivElement;\r\n\r\n  constructor(\r\n    private chat: Chat, \r\n    private appSidebarRight: AppSidebarRight, \r\n    private managers: AppManagers\r\n  ) {\r\n    this.listenerSetter = new ListenerSetter();\r\n\r\n    this.menuButtons = [];\r\n    this.buttonsToVerify = [];\r\n  }\r\n\r\n  public construct() {\r\n    //this.chat.log.error('Topbar construction');\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('sidebar-header', 'topbar', 'hide');\r\n    this.container.dataset.floating = '0';\r\n\r\n    this.btnBack = ButtonIcon('left sidebar-close-button', {noRipple: true});\r\n\r\n    // * chat info section\r\n    this.chatInfoContainer = document.createElement('div');\r\n    this.chatInfoContainer.classList.add('chat-info-container');\r\n\r\n    this.chatInfo = document.createElement('div');\r\n    this.chatInfo.classList.add('chat-info');\r\n\r\n    const person = document.createElement('div');\r\n    person.classList.add('person');\r\n\r\n    const content = document.createElement('div');\r\n    content.classList.add('content');\r\n\r\n    const top = document.createElement('div');\r\n    top.classList.add('top');\r\n\r\n    this.title = document.createElement('div');\r\n    this.title.classList.add('user-title');\r\n\r\n    top.append(this.title);\r\n\r\n    const bottom = document.createElement('div');\r\n    bottom.classList.add('bottom');\r\n\r\n    if(this.subtitle) {\r\n      bottom.append(this.subtitle);\r\n    }\r\n\r\n    content.append(top, bottom);\r\n    if(this.avatarElement) {\r\n      person.append(this.avatarElement);\r\n    }\r\n\r\n    person.append(content);\r\n    this.chatInfo.append(person);\r\n\r\n    // * chat utils section\r\n    this.chatUtils = document.createElement('div');\r\n    this.chatUtils.classList.add('chat-utils');\r\n\r\n    this.chatAudio = new ChatAudio(this, this.chat, this.managers);\r\n\r\n    if(this.menuButtons.length) {\r\n      this.btnMore = ButtonMenuToggle({listenerSetter: this.listenerSetter}, 'bottom-left', this.menuButtons, this.verifyButtons);\r\n    }\r\n\r\n    this.chatUtils.append(...[\r\n      // this.chatAudio ? this.chatAudio.divAndCaption.container : null, \r\n      this.pinnedMessage ? this.pinnedMessage.pinnedMessageContainer.divAndCaption.container : null, \r\n      this.btnJoin, \r\n      this.btnPinned, \r\n      this.btnCall, \r\n      this.btnGroupCall, \r\n      this.btnMute, \r\n      this.btnSearch, \r\n      this.btnMore\r\n    ].filter(Boolean));\r\n\r\n    this.pushButtonToVerify(this.btnCall, this.verifyCallButton.bind(this, 'voice'));\r\n    this.pushButtonToVerify(this.btnGroupCall, this.verifyVideoChatButton);\r\n\r\n    this.chatInfoContainer.append(this.btnBack, this.chatInfo, this.chatUtils);\r\n    this.container.append(this.chatInfoContainer);\r\n\r\n    if(this.chatAudio) {\r\n      // this.container.append(this.chatAudio.divAndCaption.container, this.chatUtils);\r\n      this.container.append(this.chatAudio.divAndCaption.container);\r\n    }\r\n\r\n    // * construction end\r\n\r\n    // * fix topbar overflow section\r\n\r\n    this.listenerSetter.add(window)('resize', this.onResize);\r\n    this.listenerSetter.add(mediaSizes)('changeScreen', this.onChangeScreen);\r\n\r\n    attachClickEvent(this.container, (e) => {\r\n      const container = findUpClassName(e.target, 'pinned-container');\r\n      blurActiveElement();\r\n      if(container) {\r\n        cancelEvent(e);\r\n\r\n        if(findUpClassName(e.target, 'progress-line')) {\r\n          return;\r\n        }\r\n        \r\n        const mid = +container.dataset.mid;\r\n        if(container.classList.contains('pinned-message')) {\r\n          //if(!this.pinnedMessage.locked) {\r\n            this.pinnedMessage.followPinnedMessage(mid);\r\n          //}\r\n        } else {\r\n          const peerId = container.dataset.peerId.toPeerId();\r\n          const searchContext = appMediaPlaybackController.getSearchContext();\r\n          this.chat.appImManager.setInnerPeer({\r\n            peerId, \r\n            lastMsgId: mid, \r\n            type: searchContext.isScheduled ? 'scheduled' : (searchContext.threadId ? 'discussion' : undefined), \r\n            threadId: searchContext.threadId\r\n          });\r\n        }\r\n      } else {\r\n        if(mediaSizes.activeScreen === ScreenSize.medium && document.body.classList.contains(LEFT_COLUMN_ACTIVE_CLASSNAME)) {\r\n          onBtnBackClick();\r\n        } else if(findUpTag(e.target, 'AVATAR-ELEMENT')) {\r\n          this.appSidebarRight.toggleSidebar(!document.body.classList.contains(RIGHT_COLUMN_ACTIVE_CLASSNAME));\r\n        } else {\r\n          this.appSidebarRight.toggleSidebar(true);\r\n        }\r\n      }\r\n    }, {listenerSetter: this.listenerSetter});\r\n\r\n    const onBtnBackClick = (e?: Event) => {\r\n      if(e) {\r\n        cancelEvent(e);\r\n      }\r\n\r\n      //const item = appNavigationController.findItemByType('chat');\r\n      // * return manually to chat by arrow, since can't get back to\r\n      if(mediaSizes.activeScreen === ScreenSize.medium && document.body.classList.contains(LEFT_COLUMN_ACTIVE_CLASSNAME)) {\r\n        this.chat.appImManager.setPeer({peerId: this.peerId});\r\n      } else {\r\n        const isFirstChat = this.chat.appImManager.chats.indexOf(this.chat) === 0;\r\n        appNavigationController.back(isFirstChat ? 'im' : 'chat');\r\n        /* return;\r\n\r\n        if(mediaSizes.activeScreen === ScreenSize.medium && !appNavigationController.findItemByType('chat')) {\r\n          this.chat.appImManager.setPeer(0);\r\n          blurActiveElement();\r\n        } else {\r\n          appNavigationController.back('chat');\r\n        } */\r\n      }\r\n    };\r\n\r\n    attachClickEvent(this.btnBack, onBtnBackClick, {listenerSetter: this.listenerSetter});\r\n  }\r\n\r\n  private pushButtonToVerify(element: HTMLElement, verify: ButtonToVerify['verify']) {\r\n    if(!element) {\r\n      return;\r\n    }\r\n    \r\n    this.buttonsToVerify.push({element, verify});\r\n  }\r\n\r\n  private verifyButtons = (e?: Event) => {\r\n    const isMenuOpen = !!e || !!(this.btnMore && this.btnMore.classList.contains('menu-open'));\r\n\r\n    e && cancelEvent(e);\r\n\r\n    const r = async() => {\r\n      const deleteButtonText = await this.managers.appPeersManager.getDeleteButtonText(this.peerId);\r\n      if(isMenuOpen) {\r\n        // delete button\r\n        this.menuButtons[this.menuButtons.length - 1].element.lastChild.replaceWith(i18n(deleteButtonText));\r\n      }\r\n  \r\n      const buttons = this.buttonsToVerify.concat(isMenuOpen ? this.menuButtons : []);\r\n      const results = await Promise.all(buttons.map(async(button) => {\r\n        return {\r\n          result: await button.verify(),\r\n          button\r\n        }\r\n      }));\r\n\r\n      results.forEach(({button, result}) => {\r\n        button.element.classList.toggle('hide', !result);\r\n      });\r\n    };\r\n\r\n    r();\r\n  };\r\n\r\n  private verifyVideoChatButton = async(type?: 'group' | 'broadcast') => {\r\n    if(!IS_GROUP_CALL_SUPPORTED || this.peerId.isUser()) return false;\r\n\r\n    const currentGroupCall = groupCallsController.groupCall;\r\n    const chatId = this.peerId.toChatId();\r\n    if(currentGroupCall?.chatId === chatId) {\r\n      return false;\r\n    }\r\n\r\n    if(type) {\r\n      if(((await this.managers.appPeersManager.isBroadcast(this.peerId)) && type === 'group') || \r\n        ((await this.managers.appPeersManager.isAnyGroup(this.peerId)) && type === 'broadcast')) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    const chat = await this.managers.appChatsManager.getChatTyped(chatId);\r\n    return (chat as MTChat.chat).pFlags?.call_active || hasRights(chat, 'manage_call');\r\n  };\r\n\r\n  private verifyCallButton = async(type?: CallType) => {\r\n    if(!IS_CALL_SUPPORTED || !this.peerId.isUser()) return false;\r\n    const userId = this.peerId.toUserId();\r\n    const userFull = await this.managers.appProfileManager.getCachedFullUser(userId);\r\n\r\n    return !!userFull && !!(type === 'voice' ? userFull.pFlags.phone_calls_available : userFull.pFlags.video_calls_available);\r\n  };\r\n\r\n  public constructUtils() {\r\n    this.menuButtons = [{\r\n      icon: 'search',\r\n      text: 'Search',\r\n      onClick: () => {\r\n        this.chat.initSearch();\r\n      },\r\n      verify: () => mediaSizes.isMobile\r\n    }, /* {\r\n      icon: 'pinlist',\r\n      text: 'Pinned Messages',\r\n      onClick: () => this.openPinned(false),\r\n      verify: () => mediaSizes.isMobile\r\n    }, */{\r\n      icon: 'mute',\r\n      text: 'ChatList.Context.Mute',\r\n      onClick: this.onMuteClick,\r\n      verify: async() => this.chat.type === 'chat' && rootScope.myId !== this.peerId && !(await this.managers.appNotificationsManager.isPeerLocalMuted(this.peerId, false))\r\n    }, {\r\n      icon: 'unmute',\r\n      text: 'ChatList.Context.Unmute',\r\n      onClick: () => {\r\n        this.managers.appMessagesManager.togglePeerMute(this.peerId);\r\n      },\r\n      verify: async() => this.chat.type === 'chat' && rootScope.myId !== this.peerId && (await this.managers.appNotificationsManager.isPeerLocalMuted(this.peerId, false))\r\n    }, {\r\n      icon: 'comments',\r\n      text: 'ViewDiscussion',\r\n      onClick: () => {\r\n        const middleware = this.chat.bubbles.getMiddleware();\r\n        Promise.resolve(this.managers.appProfileManager.getChannelFull(this.peerId.toChatId())).then((channelFull) => {\r\n          if(middleware() && channelFull.linked_chat_id) {\r\n            this.chat.appImManager.setInnerPeer({\r\n              peerId: channelFull.linked_chat_id.toPeerId(true)\r\n            });\r\n          }\r\n        });\r\n      },\r\n      verify: async() => {\r\n        const chatFull = await this.managers.appProfileManager.getCachedFullChat(this.peerId.toChatId());\r\n        return this.chat.type === 'chat' && !!(chatFull as ChatFull.channelFull)?.linked_chat_id;\r\n      }\r\n    }, {\r\n      icon: 'phone',\r\n      text: 'Call',\r\n      onClick: this.onCallClick.bind(this, 'voice'),\r\n      verify: this.verifyCallButton.bind(this, 'voice')\r\n    }, {\r\n      icon: 'videocamera',\r\n      text: 'VideoCall',\r\n      onClick: this.onCallClick.bind(this, 'video'),\r\n      verify: this.verifyCallButton.bind(this, 'video')\r\n    }, {\r\n      icon: 'videochat',\r\n      text: 'PeerInfo.Action.LiveStream',\r\n      onClick: this.onJoinGroupCallClick,\r\n      verify: this.verifyVideoChatButton.bind(this, 'broadcast')\r\n    }, {\r\n      icon: 'videochat',\r\n      text: 'PeerInfo.Action.VoiceChat',\r\n      onClick: this.onJoinGroupCallClick,\r\n      verify: this.verifyVideoChatButton.bind(this, 'group')\r\n    }, {\r\n      icon: 'select',\r\n      text: 'Chat.Menu.SelectMessages',\r\n      onClick: () => {\r\n        const selection = this.chat.selection;\r\n        selection.toggleSelection(true, true);\r\n        apiManagerProxy.getState().then((state) => {\r\n          if(state.chatContextMenuHintWasShown) {\r\n            return;\r\n          }\r\n\r\n          const original = selection.toggleByElement.bind(selection);\r\n          selection.toggleByElement = async(bubble) => {\r\n            this.managers.appStateManager.pushToState('chatContextMenuHintWasShown', true);\r\n            toast(i18n('Chat.Menu.Hint'));\r\n\r\n            selection.toggleByElement = original;\r\n            selection.toggleByElement(bubble);\r\n          };\r\n        });\r\n      },\r\n      verify: () => !this.chat.selection.isSelecting && !!this.chat.bubbles.getRenderedLength()\r\n    }, {\r\n      icon: 'select',\r\n      text: 'Chat.Menu.ClearSelection',\r\n      onClick: () => {\r\n        this.chat.selection.cancelSelection();\r\n      },\r\n      verify: () => this.chat.selection.isSelecting\r\n    }, {\r\n      icon: 'adduser',\r\n      text: 'AddContact',\r\n      onClick: () => {\r\n        if(!this.appSidebarRight.isTabExists(AppEditContactTab)) {\r\n          const tab = this.appSidebarRight.createTab(AppEditContactTab);\r\n          tab.peerId = this.peerId;\r\n          tab.open();\r\n\r\n          this.appSidebarRight.toggleSidebar(true);\r\n        }\r\n      },\r\n      verify: async() => this.peerId.isUser() && !(await this.managers.appPeersManager.isContact(this.peerId))\r\n    }, {\r\n      icon: 'forward',\r\n      text: 'ShareContact',\r\n      onClick: () => {\r\n        const contactPeerId = this.peerId;\r\n        new PopupPickUser({\r\n          peerTypes: ['dialogs', 'contacts'],\r\n          onSelect: (peerId) => {\r\n            return new Promise((resolve, reject) => {\r\n              new PopupPeer('', {\r\n                titleLangKey: 'SendMessageTitle',\r\n                descriptionLangKey: 'SendContactToGroupText',\r\n                descriptionLangArgs: [new PeerTitle({peerId, dialog: true}).element],\r\n                buttons: [{\r\n                  langKey: 'Send',\r\n                  callback: () => {\r\n                    resolve();\r\n\r\n                    this.managers.appMessagesManager.sendContact(peerId, contactPeerId);\r\n                    this.chat.appImManager.setInnerPeer({peerId});\r\n                  }\r\n                }, {\r\n                  langKey: 'Cancel',\r\n                  callback: () => {\r\n                    reject();\r\n                  },\r\n                  isCancel: true,\r\n                }],\r\n                peerId,\r\n                overlayClosable: true\r\n              }).show();\r\n            });\r\n          },\r\n          placeholder: 'ShareModal.Search.Placeholder',\r\n          chatRightsAction: 'send_messages',\r\n          selfPresence: 'ChatYourSelf'\r\n        });\r\n      },\r\n      verify: async() => rootScope.myId !== this.peerId && this.peerId.isUser() && (await this.managers.appPeersManager.isContact(this.peerId)) && !!(await this.managers.appUsersManager.getUser(this.peerId.toUserId())).phone\r\n    }, {\r\n      icon: 'lock',\r\n      text: 'BlockUser',\r\n      onClick: () => {\r\n        new PopupPeer('', {\r\n          peerId: this.peerId,\r\n          titleLangKey: 'BlockUser',\r\n          descriptionLangKey: 'AreYouSureBlockContact2',\r\n          descriptionLangArgs: [new PeerTitle({peerId: this.peerId}).element],\r\n          buttons: [{\r\n            langKey: 'BlockUser',\r\n            isDanger: true,\r\n            callback: () => {\r\n              this.managers.appUsersManager.toggleBlock(this.peerId, true).then((value) => {\r\n                if(value) {\r\n                  toastNew({langPackKey: 'UserBlocked'});\r\n                }\r\n              });\r\n            }\r\n          }]\r\n        }).show();\r\n      },\r\n      verify: async() => {\r\n        if(!this.peerId.isUser()) return false;\r\n        const userFull = await this.managers.appProfileManager.getCachedFullUser(this.peerId.toUserId());\r\n        return this.peerId !== rootScope.myId && userFull && !userFull.pFlags?.blocked;\r\n      }\r\n    }, {\r\n      icon: 'lockoff',\r\n      text: 'Unblock',\r\n      onClick: () => {\r\n        this.managers.appUsersManager.toggleBlock(this.peerId, false).then((value) => {\r\n          if(value) {\r\n            toastNew({langPackKey: 'UserUnblocked'});\r\n          }\r\n        });\r\n      },\r\n      verify: async() => {\r\n        const userFull = await this.managers.appProfileManager.getCachedFullUser(this.peerId.toUserId());\r\n        return !!userFull?.pFlags?.blocked;\r\n      }\r\n    }, {\r\n      icon: 'delete danger',\r\n      text: 'Delete',\r\n      onClick: () => {\r\n        new PopupDeleteDialog(this.peerId/* , 'leave' */);\r\n      },\r\n      verify: async() => this.chat.type === 'chat' && !!(await this.managers.appMessagesManager.getDialogOnly(this.peerId))\r\n    }];\r\n\r\n    this.btnSearch = ButtonIcon('search');\r\n    this.attachClickEvent(this.btnSearch, (e) => {\r\n      this.chat.initSearch();\r\n    }, true);\r\n  }\r\n\r\n  public attachClickEvent(el: HTMLElement, cb: (e: MouseEvent) => void, noBlur?: boolean) {\r\n    attachClickEvent(el, (e) => {\r\n      cancelEvent(e);\r\n      !noBlur && blurActiveElement();\r\n      cb(e);\r\n    }, {listenerSetter: this.listenerSetter});\r\n  }\r\n\r\n  private onCallClick(type: CallType) {\r\n    this.chat.appImManager.callUser(this.peerId.toUserId(), type);\r\n  }\r\n\r\n  private onJoinGroupCallClick = () => {\r\n    this.chat.appImManager.joinGroupCall(this.peerId);\r\n  };\r\n\r\n  private constructAvatar() {\r\n    const avatarElement = new AvatarElement();\r\n    avatarElement.isDialog = true;\r\n    avatarElement.classList.add('avatar-42', 'person-avatar');\r\n    return avatarElement;\r\n  }\r\n\r\n  private get peerId() {\r\n    return this.chat.peerId;\r\n  }\r\n\r\n  public constructPeerHelpers() {\r\n    this.avatarElement = this.constructAvatar();\r\n    \r\n    this.subtitle = document.createElement('div');\r\n    this.subtitle.classList.add('info');\r\n\r\n    this.pinnedMessage = new ChatPinnedMessage(this, this.chat, this.managers);\r\n\r\n    this.btnJoin = Button('btn-primary btn-color-primary chat-join hide');\r\n    this.btnCall = ButtonIcon('phone');\r\n    this.btnGroupCall = ButtonIcon('videochat');\r\n    this.btnPinned = ButtonIcon('pinlist');\r\n    this.btnMute = ButtonIcon('mute');\r\n\r\n    this.attachClickEvent(this.btnCall, this.onCallClick.bind(this, 'voice'));\r\n    this.attachClickEvent(this.btnGroupCall, this.onJoinGroupCallClick);\r\n\r\n    this.attachClickEvent(this.btnPinned, () => {\r\n      this.openPinned(true);\r\n    });\r\n\r\n    this.attachClickEvent(this.btnMute, this.onMuteClick);\r\n\r\n    this.attachClickEvent(this.btnJoin, async() => {\r\n      const middleware = this.chat.bubbles.getMiddleware();\r\n      this.btnJoin.setAttribute('disabled', 'true');\r\n\r\n      const chatId = this.peerId.toChatId();\r\n      let promise: Promise<any>;\r\n      if(await this.managers.appChatsManager.isChannel(chatId)) {\r\n        promise = this.managers.appChatsManager.joinChannel(chatId);\r\n      } else {\r\n        promise = this.managers.appChatsManager.addChatUser(chatId, rootScope.myId);\r\n      }\r\n\r\n      promise.finally(() => {\r\n        if(!middleware()) {\r\n          return;\r\n        }\r\n\r\n        this.btnJoin.removeAttribute('disabled');\r\n      });\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('chat_update', async(chatId) => {\r\n      if(this.peerId === chatId.toPeerId(true)) {\r\n        const chat = await this.managers.appChatsManager.getChat(chatId) as Channel/*  | Chat */;\r\n        \r\n        this.btnJoin.classList.toggle('hide', !(chat as Channel)?.pFlags?.left);\r\n        this.setUtilsWidth();\r\n        this.verifyButtons();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('dialog_notify_settings', (dialog) => {\r\n      if(dialog.peerId === this.peerId) {\r\n        this.setMutedState();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('peer_typings', ({peerId}) => {\r\n      if(this.peerId === peerId) {\r\n        this.setPeerStatus();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('user_update', (userId) => {\r\n      if(this.peerId === userId.toPeerId()) {\r\n        this.setPeerStatus();\r\n      }\r\n    });\r\n\r\n    this.listenerSetter.add(rootScope)('peer_full_update', (peerId) => {\r\n      if(this.peerId === peerId) {\r\n        this.verifyButtons();\r\n      }\r\n    });\r\n\r\n    if(this.pinnedMessage) {\r\n      this.chat.addEventListener('setPeer', (mid, isTopMessage) => {\r\n        const middleware = this.chat.bubbles.getMiddleware();\r\n        apiManagerProxy.getState().then((state) => {\r\n          if(!middleware()) return;\r\n  \r\n          this.pinnedMessage.hidden = !!state.hiddenPinnedMessages[this.chat.peerId];\r\n  \r\n          if(isTopMessage) {\r\n            this.pinnedMessage.unsetScrollDownListener();\r\n            this.pinnedMessage.testMid(mid, 0); // * because slider will not let get bubble by document.elementFromPoint\r\n          } else if(!this.pinnedMessage.locked) {\r\n            this.pinnedMessage.handleFollowingPinnedMessage();\r\n            this.pinnedMessage.testMid(mid);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    this.setPeerStatusInterval = window.setInterval(this.setPeerStatus, 60e3);\r\n\r\n    return this;\r\n  }\r\n\r\n  public constructPinnedHelpers() {\r\n    this.listenerSetter.add(rootScope)('peer_pinned_messages', ({peerId, mids}) => {\r\n      if(peerId !== this.peerId) return;\r\n\r\n      if(mids) {\r\n        this.setTitle();\r\n      }\r\n    });\r\n  }\r\n  \r\n  public constructDiscussionHelpers() {\r\n    this.pinnedMessage = new ChatPinnedMessage(this, this.chat, this.managers);\r\n  }\r\n\r\n  public openPinned(byCurrent: boolean) {\r\n    this.chat.appImManager.setInnerPeer({\r\n      peerId: this.peerId, \r\n      lastMsgId: byCurrent ? +this.pinnedMessage.pinnedMessageContainer.divAndCaption.container.dataset.mid : 0, \r\n      type: 'pinned'\r\n    });\r\n  }\r\n\r\n  private onMuteClick = () => {\r\n    new PopupMute(this.peerId);\r\n  };\r\n\r\n  private onResize = () => {\r\n    this.setUtilsWidth(true);\r\n    this.setFloating();\r\n  };\r\n\r\n  private onChangeScreen = (from: ScreenSize, to: ScreenSize) => {\r\n    this.container.classList.toggle('is-pinned-floating', mediaSizes.isMobile);\r\n    // this.chatAudio && this.chatAudio.divAndCaption.container.classList.toggle('is-floating', to === ScreenSize.mobile);\r\n    this.pinnedMessage && this.pinnedMessage.pinnedMessageContainer.divAndCaption.container.classList.toggle('is-floating', to === ScreenSize.mobile);\r\n    this.onResize();\r\n  };\r\n\r\n  public destroy() {\r\n    //this.chat.log.error('Topbar destroying');\r\n    this.listenerSetter.removeAll();\r\n    window.clearInterval(this.setPeerStatusInterval);\r\n    \r\n    if(this.pinnedMessage) {\r\n      this.pinnedMessage.destroy(); // *     \r\n    }\r\n\r\n    if(this.chatAudio) {\r\n      this.chatAudio.destroy();\r\n    }\r\n\r\n    delete this.chatAudio;\r\n    delete this.pinnedMessage;\r\n  }\r\n\r\n  public cleanup() {\r\n    if(!this.chat.peerId) {\r\n      this.container.classList.add('hide');\r\n    }\r\n  }\r\n\r\n  public async finishPeerChange(isTarget: boolean) {\r\n    const peerId = this.peerId;\r\n\r\n    let newAvatar: AvatarElement;\r\n    if(this.avatarElement) {\r\n      newAvatar = this.constructAvatar();\r\n    }\r\n\r\n    const [isBroadcast, isAnyChat, chat, _, setTitleCallback, setStatusCallback, state] = await Promise.all([\r\n      this.managers.appPeersManager.isBroadcast(peerId),\r\n      this.managers.appPeersManager.isAnyChat(peerId),\r\n      peerId.isAnyChat() ? this.managers.appChatsManager.getChat(peerId.toChatId()) : undefined,\r\n      newAvatar ? newAvatar.updateWithOptions({peerId}) : undefined,\r\n      this.setTitleManual(),\r\n      this.setPeerStatusManual(true),\r\n      apiManagerProxy.getState()\r\n    ]);\r\n\r\n    return () => {\r\n      this.btnMute && this.btnMute.classList.toggle('hide', !isBroadcast);\r\n      if(this.btnJoin) {\r\n        if(isAnyChat) {\r\n          replaceContent(this.btnJoin, i18n(isBroadcast ? 'Chat.Subscribe' : 'ChannelJoin'));\r\n          this.btnJoin.classList.toggle('hide', !chat?.pFlags?.left);\r\n        } else {\r\n          this.btnJoin.classList.add('hide');\r\n        }\r\n      }\r\n\r\n      if(newAvatar) {\r\n        this.avatarElement.replaceWith(newAvatar);\r\n        this.avatarElement = newAvatar;\r\n      }\r\n  \r\n      this.setUtilsWidth();\r\n  \r\n      this.verifyButtons();\r\n  \r\n      if(this.pinnedMessage) { // * replace with new one\r\n        if(this.chat.type === 'chat') {\r\n          if(this.chat.wasAlreadyUsed) { // * change\r\n            const newPinnedMessage = new ChatPinnedMessage(this, this.chat, this.managers);\r\n            this.pinnedMessage.pinnedMessageContainer.divAndCaption.container.replaceWith(newPinnedMessage.pinnedMessageContainer.divAndCaption.container);\r\n            this.pinnedMessage.destroy();\r\n            //this.pinnedMessage.pinnedMessageContainer.toggle(true);\r\n            this.pinnedMessage = newPinnedMessage;\r\n          }\r\n          \r\n          this.pinnedMessage.hidden = !!state.hiddenPinnedMessages[peerId];\r\n        } else if(this.chat.type === 'discussion') {\r\n          this.pinnedMessage.pinnedMid = this.chat.threadId;\r\n          this.pinnedMessage.count = 1;\r\n          this.pinnedMessage.pinnedIndex = 0;\r\n          this.pinnedMessage._setPinnedMessage();\r\n        }\r\n      }\r\n  \r\n      setTitleCallback();\r\n      setStatusCallback && setStatusCallback();\r\n      this.setMutedState();\r\n\r\n      this.container.classList.remove('hide');\r\n    };\r\n  }\r\n\r\n  public async setTitleManual(count?: number) {\r\n    const peerId = this.peerId;\r\n    const middleware = () => this.peerId === peerId;\r\n    let titleEl: HTMLElement, icons: Element[];\r\n    if(this.chat.type === 'pinned') {\r\n      if(count === undefined) titleEl = i18n('Loading');\r\n      else titleEl = i18n('PinnedMessagesCount', [count]);\r\n\r\n      if(count === undefined) {\r\n        this.managers.appMessagesManager.getSearchCounters(peerId, [{_: 'inputMessagesFilterPinned'}], false).then((result) => {\r\n          if(!middleware()) return;\r\n          const count = result[0].count;\r\n          this.setTitle(count);\r\n\r\n          // !  2,      \r\n          if(!count) {\r\n            this.chat.appImManager.setPeer(); // * close tab\r\n\r\n            // ! ,     ,  ,      \r\n            const originalChat = this.chat.appImManager.chat;\r\n            if(originalChat.topbar.pinnedMessage) {\r\n              originalChat.topbar.pinnedMessage.pinnedMessageContainer.toggle(true);\r\n            }\r\n          }\r\n        });\r\n      }\r\n    } else if(this.chat.type === 'scheduled') {\r\n      titleEl = i18n(peerId === rootScope.myId ? 'Reminders' : 'ScheduledMessages');\r\n    } else if(this.chat.type === 'discussion') {\r\n      if(count === undefined) {\r\n        const result = await this.managers.acknowledged.appMessagesManager.getHistory(peerId, 0, 1, 0, this.chat.threadId);\r\n        if(result.cached) {\r\n          const historyResult = await result.result;\r\n          count = historyResult.count;\r\n        } else result.result.then((historyResult) => this.setTitle(historyResult.count));\r\n      }\r\n\r\n      if(count === undefined) titleEl = i18n('Loading');\r\n      else titleEl = i18n('Chat.Title.Comments', [count]);\r\n    } else if(this.chat.type === 'chat') {\r\n      [titleEl, icons] = await Promise.all([\r\n        wrapPeerTitle({\r\n          peerId,\r\n          dialog: true\r\n        }),\r\n        generateTitleIcons(peerId)\r\n      ]);\r\n\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    return () => {\r\n      replaceContent(this.title, titleEl);\r\n      if(icons) {\r\n        this.title.append(...icons);\r\n      }\r\n    };\r\n  }\r\n\r\n  public setTitle(count?: number) {\r\n    this.setTitleManual(count).then((setTitleCallback) => setTitleCallback());\r\n  }\r\n\r\n  public async setMutedState() {\r\n    if(!this.btnMute) return;\r\n\r\n    const peerId = this.peerId;\r\n    let muted = await this.managers.appNotificationsManager.isPeerLocalMuted(peerId, false);\r\n    if(await this.managers.appPeersManager.isBroadcast(peerId)) { // not human\r\n      this.btnMute.classList.remove('tgico-mute', 'tgico-unmute');\r\n      this.btnMute.classList.add(muted ? 'tgico-unmute' : 'tgico-mute');\r\n      this.btnMute.style.display = '';\r\n    } else {\r\n      this.btnMute.style.display = 'none';\r\n    }\r\n  }\r\n\r\n  // !    ,    -    ,          ,    !\r\n  public setUtilsWidth = (resize = false) => {\r\n    //return;\r\n    if(this.setUtilsRAF) window.cancelAnimationFrame(this.setUtilsRAF);\r\n\r\n    if(IS_SAFARI && resize) {\r\n      this.chatUtils.classList.add('hide');\r\n    }\r\n\r\n    //mutationObserver.disconnect();\r\n    this.setUtilsRAF = window.requestAnimationFrame(() => {\r\n      \r\n      //mutationRAF = window.requestAnimationFrame(() => {\r\n        \r\n        //setTimeout(() => {\r\n          if(IS_SAFARI && resize) {\r\n            this.chatUtils.classList.remove('hide');\r\n          }\r\n          /* this.chatInfo.style.removeProperty('--utils-width');\r\n          void this.chatInfo.offsetLeft; // reflow */\r\n          const width = /* chatUtils.scrollWidth */this.chatUtils.getBoundingClientRect().width;\r\n          this.chat.log('utils width:', width);\r\n          this.container.style.setProperty('--utils-width', width + 'px');\r\n          //this.chatInfo.classList.toggle('have-utils-width', !!width);\r\n        //}, 0);\r\n        \r\n        this.setUtilsRAF = 0;\r\n\r\n        //mutationObserver.observe(chatUtils, observeOptions);\r\n      //});\r\n    });\r\n  };\r\n\r\n  public setFloating = () => {\r\n    const containers = [this.chatAudio, this.pinnedMessage && this.pinnedMessage.pinnedMessageContainer].filter(Boolean);\r\n    const count = containers.reduce((acc, container) => {\r\n      const isFloating = container.isFloating();\r\n      this.container.classList.toggle(`is-pinned-${container.className}-floating`, isFloating);\r\n\r\n      if(!container.isVisible()) {\r\n        return acc;\r\n      }\r\n\r\n      return acc + +isFloating;\r\n    }, 0);\r\n    this.container.dataset.floating = '' + count;\r\n  };\r\n\r\n  public setPeerStatusManual = async(needClear = false) => {\r\n    if(!this.subtitle) return;\r\n\r\n    const peerId = this.peerId;\r\n    return this.chat.appImManager.setPeerStatus(\r\n      peerId, \r\n      this.subtitle, \r\n      needClear, \r\n      false, \r\n      () => peerId === this.peerId\r\n    );\r\n  };\r\n\r\n  public setPeerStatus = (needClear?: boolean) => {\r\n    return this.setPeerStatusManual(needClear).then((callback) => {\r\n      if(callback) {\r\n        callback();\r\n      }\r\n    });\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appSidebarRight from \"..\";\r\nimport { attachClickEvent } from \"../../../helpers/dom/clickEvent\";\r\nimport AppSearch, { SearchGroup } from \"../../appSearch\";\r\nimport ButtonIcon from \"../../buttonIcon\";\r\nimport InputSearch from \"../../inputSearch\";\r\nimport PopupElement from \"../../popups\";\r\nimport PopupDatePicker from \"../../popups/datePicker\";\r\nimport { SliderSuperTab } from \"../../slider\";\r\n\r\nexport default class AppPrivateSearchTab extends SliderSuperTab {\r\n  private inputSearch: InputSearch;\r\n  private appSearch: AppSearch;\r\n  private btnPickDate: HTMLElement;\r\n\r\n  private peerId: PeerId;\r\n  private threadId = 0;\r\n  private query = '';\r\n  private onDatePick: (timestamp: number) => void;\r\n\r\n  onOpenAfterTimeout() {\r\n    this.appSearch.beginSearch(this.peerId, this.threadId, this.query);\r\n  }\r\n\r\n  protected init() {\r\n    this.container.id = 'search-private-container';\r\n    this.container.classList.add('chatlist-container');\r\n    this.inputSearch = new InputSearch('Search');\r\n    this.title.replaceWith(this.inputSearch.container);\r\n\r\n    this.btnPickDate = ButtonIcon('calendar sidebar-header-right');\r\n    this.header.append(this.btnPickDate);\r\n\r\n    const c = document.createElement('div');\r\n    c.classList.add('chatlist-container');\r\n    this.scrollable.container.replaceWith(c);\r\n    this.appSearch = new AppSearch(c, this.inputSearch, {\r\n      messages: new SearchGroup('Chat.Search.PrivateSearch', 'messages')\r\n    });\r\n  }\r\n\r\n  open(peerId: PeerId, threadId?: number, onDatePick?: AppPrivateSearchTab['onDatePick'], query?: string) {\r\n    const ret = super.open();\r\n\r\n    if(!this.peerId) {\r\n      this.query = query;\r\n      this.peerId = peerId;\r\n      this.threadId = threadId;\r\n      this.onDatePick = onDatePick;\r\n  \r\n      this.btnPickDate.classList.toggle('hide', !this.onDatePick);\r\n      if(this.onDatePick) {\r\n        attachClickEvent(this.btnPickDate, () => {\r\n          PopupElement.createPopup(PopupDatePicker, new Date(), this.onDatePick).show();\r\n        });\r\n      }\r\n\r\n      query && this.appSearch.searchInput.inputField.setValueSilently(query);\r\n  \r\n      appSidebarRight.toggleSidebar(true);\r\n    } else {\r\n      this.appSearch.beginSearch(this.peerId, this.threadId, query);\r\n    }\r\n\r\n    return ret;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type ChatTopbar from \"./topbar\";\r\nimport AppSearch, { SearchGroup } from \"../appSearch\";\r\nimport PopupDatePicker from \"../popups/datePicker\";\r\nimport ripple from \"../ripple\";\r\nimport InputSearch from \"../inputSearch\";\r\nimport type Chat from \"./chat\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport whichChild from \"../../helpers/dom/whichChild\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport appNavigationController, { NavigationItem } from \"../appNavigationController\";\r\nimport { IS_MOBILE_SAFARI } from \"../../environment/userAgent\";\r\nimport PopupElement from \"../popups\";\r\nimport { DIALOG_LIST_ELEMENT_TAG } from \"../../lib/appManagers/appDialogsManager\";\r\n\r\nexport default class ChatSearch {\r\n  private element: HTMLElement;\r\n  private backBtn: HTMLElement;\r\n  private inputSearch: InputSearch;\r\n\r\n  private results: HTMLElement;\r\n\r\n  private footer: HTMLElement;\r\n  private dateBtn: HTMLElement;\r\n  private foundCountEl: HTMLElement;\r\n  private controls: HTMLElement;\r\n  private downBtn: HTMLElement;\r\n  private upBtn: HTMLElement;\r\n\r\n  private appSearch: AppSearch;\r\n  private searchGroup: SearchGroup;\r\n\r\n  private foundCount = 0;\r\n  private selectedIndex = 0;\r\n  private setPeerPromise: Promise<any>;\r\n  private listenerSetter: ListenerSetter;\r\n  private navigationItem: NavigationItem;\r\n\r\n  constructor(private topbar: ChatTopbar, private chat: Chat, query?: string) {\r\n    this.element = document.createElement('div');\r\n    this.element.classList.add('sidebar-header', 'chat-search', 'chatlist-container');\r\n\r\n    this.backBtn = document.createElement('button');\r\n    this.backBtn.classList.add('btn-icon', 'tgico-left', 'sidebar-close-button');\r\n    ripple(this.backBtn);\r\n\r\n    const listenerSetter = this.listenerSetter = new ListenerSetter();\r\n\r\n    const attachClick = (element: HTMLElement, callback: (e: MouseEvent) => void) => {\r\n      attachClickEvent(element, callback, {listenerSetter});\r\n    };\r\n    \r\n    attachClick(this.backBtn, () => {\r\n      this.destroy();\r\n    });\r\n\r\n    this.inputSearch = new InputSearch('Search');\r\n    \r\n    // Results\r\n    this.results = document.createElement('div');\r\n    this.results.classList.add('chat-search-results', 'chatlist-container');\r\n\r\n    this.searchGroup = new SearchGroup(false, 'messages', undefined, '', false);\r\n    attachClick(this.searchGroup.list, this.onResultsClick);\r\n\r\n    this.appSearch = new AppSearch(this.results, this.inputSearch, {\r\n      messages: this.searchGroup\r\n    }, (count) => {\r\n      this.foundCount = count;\r\n\r\n      if(!this.foundCount) {\r\n        replaceContent(this.foundCountEl, this.inputSearch.value ? i18n('NoResult') : '');\r\n        this.results.classList.remove('active');\r\n        this.chat.bubbles.container.classList.remove('search-results-active');\r\n        this.upBtn.setAttribute('disabled', 'true');\r\n        this.downBtn.setAttribute('disabled', 'true');\r\n      } else {\r\n        this.selectResult(this.searchGroup.list.children[0] as HTMLElement);\r\n      }\r\n    });\r\n    this.appSearch.beginSearch(this.chat.peerId, this.chat.threadId);\r\n\r\n    //appImManager.topbar.parentElement.insertBefore(this.results, appImManager.bubblesContainer);\r\n    this.chat.bubbles.container.append(this.results);\r\n\r\n    // Footer\r\n    this.footer = document.createElement('div');\r\n    this.footer.classList.add('chat-search-footer');\r\n\r\n    attachClick(this.footer, this.onFooterClick);\r\n    ripple(this.footer);\r\n\r\n    this.foundCountEl = document.createElement('span');\r\n    this.foundCountEl.classList.add('chat-search-count');\r\n\r\n    this.dateBtn = document.createElement('button');\r\n    this.dateBtn.classList.add('btn-icon', 'tgico-calendar');\r\n\r\n    this.controls = document.createElement('div');\r\n    this.controls.classList.add('chat-search-controls');\r\n\r\n    this.upBtn = document.createElement('button');\r\n    this.upBtn.classList.add('btn-icon', 'tgico-up');\r\n    this.downBtn = document.createElement('button');\r\n    this.downBtn.classList.add('btn-icon', 'tgico-down');\r\n\r\n    this.upBtn.setAttribute('disabled', 'true');\r\n    this.downBtn.setAttribute('disabled', 'true');\r\n\r\n    attachClick(this.dateBtn, this.onDateClick);\r\n    attachClick(this.upBtn, this.onUpClick);\r\n    attachClick(this.downBtn, this.onDownClick);\r\n    this.controls.append(this.upBtn, this.downBtn);\r\n\r\n    this.footer.append(this.foundCountEl, this.dateBtn, this.controls);\r\n    \r\n    this.topbar.container.parentElement.insertBefore(this.footer, chat.input.chatInput);\r\n\r\n    // Append container\r\n    this.element.append(this.backBtn, this.inputSearch.container);\r\n\r\n    this.topbar.container.classList.add('hide-pinned');\r\n    this.topbar.container.parentElement.append(this.element);\r\n\r\n    this.inputSearch.input.focus();\r\n\r\n    if(query) {\r\n      this.setQuery(query);\r\n    }\r\n\r\n    if(!IS_MOBILE_SAFARI) {\r\n      this.navigationItem = {\r\n        type: 'mobile-search',\r\n        onPop: () => {\r\n          this.destroy();\r\n        }\r\n      };\r\n  \r\n      appNavigationController.pushItem(this.navigationItem);\r\n    }\r\n  }\r\n\r\n  public destroy() {\r\n    this.topbar.container.classList.remove('hide-pinned');\r\n    this.element.remove();\r\n    this.inputSearch.remove();\r\n    this.results.remove();\r\n    this.footer.remove();\r\n    this.listenerSetter.removeAll();\r\n    this.chat.bubbles.container.classList.remove('search-results-active');\r\n    this.chat.search = undefined;\r\n    appNavigationController.removeItem(this.navigationItem);\r\n  }\r\n\r\n  public setQuery(query: string) {\r\n    this.inputSearch.inputField.value = query;\r\n  }\r\n\r\n  private onDateClick = (e: MouseEvent) => {\r\n    cancelEvent(e);\r\n    PopupElement.createPopup(PopupDatePicker, new Date(), this.chat.bubbles.onDatePick).show();\r\n  };\r\n\r\n  private selectResult(elem: HTMLElement) {\r\n    if(this.setPeerPromise) return this.setPeerPromise;\r\n\r\n    const peerId = elem.dataset.peerId.toPeerId();\r\n    const lastMsgId = +elem.dataset.mid || undefined;\r\n\r\n    const index = whichChild(elem);\r\n\r\n    if(index === (this.foundCount - 1)) {\r\n      this.upBtn.setAttribute('disabled', 'true');\r\n    } else {\r\n      this.upBtn.removeAttribute('disabled');\r\n    }\r\n\r\n    if(!index) {\r\n      this.downBtn.setAttribute('disabled', 'true');\r\n    } else {\r\n      this.downBtn.removeAttribute('disabled');\r\n    }\r\n\r\n    this.results.classList.remove('active');\r\n    this.chat.bubbles.container.classList.remove('search-results-active');\r\n\r\n    const res = this.chat.setPeer(peerId, lastMsgId);\r\n    this.setPeerPromise = ((res instanceof Promise ? res : Promise.resolve(res)) as Promise<any>).then(() => {\r\n      this.selectedIndex = index;\r\n      replaceContent(this.foundCountEl, i18n('Of', [index + 1, this.foundCount]));\r\n\r\n      const renderedCount = this.searchGroup.list.childElementCount;\r\n      if(this.selectedIndex >= (renderedCount - 6)) {\r\n        this.appSearch.searchMore();\r\n      }\r\n    }).finally(() => {\r\n      this.setPeerPromise = null;\r\n    });\r\n  }\r\n\r\n  private onResultsClick = (e: MouseEvent) => {\r\n    const target = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG);\r\n    if(target) {\r\n      this.selectResult(target);\r\n    }\r\n  };\r\n\r\n  private onFooterClick = (e: MouseEvent) => {\r\n    if(this.foundCount) {\r\n      this.chat.bubbles.container.classList.toggle('search-results-active');\r\n      this.results.classList.toggle('active');\r\n    }\r\n  };\r\n\r\n  private onUpClick = (e: MouseEvent) => {\r\n    cancelEvent(e);\r\n    this.selectResult(this.searchGroup.list.children[this.selectedIndex + 1] as HTMLElement);\r\n  };\r\n\r\n  private onDownClick = (e: MouseEvent) => {\r\n    cancelEvent(e);\r\n    this.selectResult(this.searchGroup.list.children[this.selectedIndex - 1] as HTMLElement);\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport deepEqual from \"../../helpers/object/deepEqual\";\r\nimport { renderImageFromUrlPromise } from \"../../helpers/dom/renderImageFromUrl\";\r\nimport mediaSizes, { ScreenSize } from \"../../helpers/mediaSizes\";\r\n\r\ntype ChatBackgroundPatternRendererInitOptions = {\r\n  url: string,\r\n  width: number,\r\n  height: number,\r\n  mask?: boolean\r\n};\r\n\r\nexport default class ChatBackgroundPatternRenderer {\r\n  private static INSTANCES: ChatBackgroundPatternRenderer[] = [];\r\n\r\n  // private pattern: CanvasPattern;\r\n  private objectUrl: string;\r\n  private options: ChatBackgroundPatternRendererInitOptions;\r\n  private canvases: Set<HTMLCanvasElement>;\r\n  // private createCanvasPatternPromise: Promise<CanvasPattern>;\r\n  // private exportCanvasPatternToImagePromise: Promise<string>;\r\n  private renderImageFromUrlPromise: Promise<HTMLImageElement>;\r\n  private img: HTMLImageElement;\r\n\r\n  constructor() {\r\n    this.canvases = new Set();\r\n  }\r\n\r\n  public static getInstance(options: ChatBackgroundPatternRendererInitOptions) {\r\n    let instance = this.INSTANCES.find((instance) => {\r\n      return deepEqual(instance.options, options);\r\n    });\r\n\r\n    if(!instance) {\r\n      instance = new ChatBackgroundPatternRenderer();\r\n      instance.init(options);\r\n      this.INSTANCES.push(instance);\r\n    }\r\n\r\n    return instance;\r\n  }\r\n\r\n  public init(options: ChatBackgroundPatternRendererInitOptions) {\r\n    // if(this.options) {\r\n    //   if(this.options.width !== options.width || this.options.height !== options.height) {\r\n    //     this.createCanvasPatternPromise = \r\n    //       this.pattern = \r\n    //       this.exportCanvasPatternToImagePromise = \r\n    //       undefined;\r\n    //   }\r\n    // }\r\n\r\n    this.options = options;\r\n  }\r\n\r\n  public renderToCanvas(canvas: HTMLCanvasElement) {\r\n    // return this.createCanvasPattern(canvas).then(() => {\r\n      // return this.fillCanvas(canvas);\r\n    // });\r\n\r\n    return this.renderImageFromUrl(this.options.url).then(() => {\r\n      return this.fillCanvas(canvas);\r\n    });\r\n  }\r\n\r\n  private renderImageFromUrl(url: string) {\r\n    if(this.renderImageFromUrlPromise) return this.renderImageFromUrlPromise;\r\n    const img = this.img = document.createElement('img');\r\n    img.crossOrigin = 'anonymous';\r\n    return this.renderImageFromUrlPromise = renderImageFromUrlPromise(img, url, false).then(() => img);\r\n  }\r\n\r\n  /* private createCanvasPattern(canvas: HTMLCanvasElement) {\r\n    if(this.createCanvasPatternPromise) return this.createCanvasPatternPromise;\r\n    return this.createCanvasPatternPromise = this.renderImageFromUrl(this.options.url).then((img) => {\r\n      let createPatternFrom: HTMLImageElement | HTMLCanvasElement;\r\n      if(IS_SAFARI) {\r\n        const canvas = createPatternFrom = document.createElement('canvas');\r\n        canvas.width = img.naturalWidth;\r\n        canvas.height = img.naturalHeight;\r\n        const ctx = canvas.getContext('2d');\r\n        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\r\n      } else {\r\n        createPatternFrom = img;\r\n      }\r\n      \r\n      const perf = performance.now();\r\n      this.pattern = canvas.getContext('2d').createPattern(createPatternFrom, 'repeat-x');\r\n      console.warn('creating pattern time:', performance.now() - perf);\r\n\r\n      return this.pattern;\r\n    });\r\n  }\r\n\r\n  public exportCanvasPatternToImage(canvas: HTMLCanvasElement) {\r\n    if(this.exportCanvasPatternToImagePromise) return this.exportCanvasPatternToImagePromise;\r\n    return this.exportCanvasPatternToImagePromise = new Promise<string>((resolve) => {\r\n      canvas.toBlob((blob) => {\r\n        const newUrl = this.objectUrl = URL.createObjectURL(blob);\r\n        resolve(newUrl);\r\n      }, 'image/png');\r\n    });\r\n  } */\r\n\r\n  public cleanup(canvas: HTMLCanvasElement) {\r\n    this.canvases.delete(canvas);\r\n\r\n    if(!this.canvases.size) {\r\n      indexOfAndSplice(ChatBackgroundPatternRenderer.INSTANCES, this);\r\n\r\n      if(this.objectUrl) {\r\n        URL.revokeObjectURL(this.objectUrl);\r\n      }\r\n    }\r\n  }\r\n\r\n  public fillCanvas(canvas: HTMLCanvasElement) {\r\n    const context = canvas.getContext('2d');\r\n    const {width, height} = canvas;\r\n    // const perf = performance.now();\r\n    // if(context.fillStyle instanceof CanvasPattern) {\r\n    //   context.clearRect(0, 0, width, height);\r\n    // }\r\n\r\n    const img = this.img;\r\n\r\n    let imageWidth = img.width, imageHeight = img.height;\r\n    // if(imageHeight < height) {\r\n      let patternHeight = 1480 * canvas.dpr;\r\n      // * correct\r\n      // if(+canvas.dataset.originalHeight !== height) hhh *= 2 / 3;\r\n      // * but have to make it good\r\n      if(+canvas.dataset.originalHeight !== height) patternHeight *= .875;\r\n      const ratio = patternHeight / imageHeight;\r\n      imageWidth *= ratio;\r\n      imageHeight = patternHeight;\r\n    // }\r\n\r\n    if(this.options.mask) {\r\n      context.fillStyle = '#000';\r\n      context.fillRect(0, 0, width, height);\r\n      context.globalCompositeOperation = 'destination-out';\r\n    } else {\r\n      context.globalCompositeOperation = 'source-over';\r\n    }\r\n\r\n    const d = (y: number) => {\r\n      for(let x = 0; x < width; x += imageWidth) {\r\n        context.drawImage(img, x, y, imageWidth, imageHeight);\r\n      }\r\n    };\r\n\r\n    const centerY = height / 2 - imageHeight / 2;\r\n    d(centerY);\r\n\r\n    if(centerY > 0) {\r\n      let topY = centerY;\r\n      do {\r\n        d(topY -= imageHeight);\r\n      } while(topY >= 0);\r\n    }\r\n\r\n    const endY = height - 1;\r\n    for(let bottomY = centerY + imageHeight; bottomY < endY; bottomY += imageHeight) {\r\n      d(bottomY);\r\n    }\r\n\r\n    // for(let x = 0; x < width; x += imageWidth) {\r\n    //   for(let y = 0; y < height; y += imageHeight) {\r\n    //     context.drawImage(img, x, y, imageWidth, imageHeight);\r\n    //   }\r\n    // }\r\n    // context.fillStyle = this.pattern;\r\n    // context.fillRect(0, 0, width, height);\r\n    // console.warn('fill canvas time', performance.now() - perf);\r\n  }\r\n\r\n  public setCanvasDimensions(canvas: HTMLCanvasElement) {\r\n    const devicePixelRatio = Math.min(2, window.devicePixelRatio);\r\n    let width = this.options.width * devicePixelRatio, \r\n      height = this.options.height * devicePixelRatio;\r\n\r\n    canvas.dpr = devicePixelRatio;\r\n    canvas.dataset.originalHeight = '' + height;\r\n    if(mediaSizes.activeScreen === ScreenSize.large) height *= 1.5;\r\n    canvas.width = width;\r\n    canvas.height = height;\r\n\r\n  }\r\n\r\n  public createCanvas() {\r\n    const canvas = document.createElement('canvas');\r\n    this.canvases.add(canvas);\r\n    this.setCanvasDimensions(canvas);\r\n    return canvas;\r\n  }\r\n\r\n  public resize(width: number, height: number) {\r\n    this.init({\r\n      ...this.options,\r\n      width,\r\n      height\r\n    });\r\n\r\n    const promises: Promise<any>[] = [];\r\n    for(const canvas of this.canvases) {\r\n      this.setCanvasDimensions(canvas);\r\n      promises.push(this.renderToCanvas(canvas));\r\n    }\r\n\r\n    return Promise.all(promises);\r\n  }\r\n\r\n  public static resizeInstances(width: number, height: number) {\r\n    return Promise.all(this.INSTANCES.map((instance) => instance.resize(width, height)));\r\n  }\r\n\r\n  /* public setResizeMode(resizing: boolean) {\r\n    const canvases = Array.from(this.canvases);\r\n    const canvas = canvases[canvases.length - 1];\r\n    canvas.style.display = resizing ? 'none' : '';\r\n    const img = this.img;\r\n    img.style.display = resizing ? '' : 'none';\r\n\r\n    return {img, canvas};\r\n  } */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { ChatRights } from \"../../lib/appManagers/appChatsManager\";\r\nimport type { AppImManager } from \"../../lib/appManagers/appImManager\";\r\nimport type { MessagesStorageKey } from \"../../lib/appManagers/appMessagesManager\";\r\n// import type AppMediaViewerBase from \"../appMediaViewerBase\";\r\nimport EventListenerBase from \"../../helpers/eventListenerBase\";\r\nimport { logger, LogTypes } from \"../../lib/logger\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport appSidebarRight from \"../sidebarRight\";\r\nimport ChatBubbles from \"./bubbles\";\r\nimport ChatContextMenu from \"./contextMenu\";\r\nimport ChatInput from \"./input\";\r\nimport ChatSelection from \"./selection\";\r\nimport ChatTopbar from \"./topbar\";\r\nimport { NULL_PEER_ID, REPLIES_PEER_ID } from \"../../lib/mtproto/mtproto_config\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport AppPrivateSearchTab from \"../sidebarRight/tabs/search\";\r\nimport renderImageFromUrl from \"../../helpers/dom/renderImageFromUrl\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport ChatSearch from \"./search\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport getAutoDownloadSettingsByPeerId, { ChatAutoDownloadSettings } from \"../../helpers/autoDownload\";\r\nimport ChatBackgroundGradientRenderer from \"./gradientRenderer\";\r\nimport ChatBackgroundPatternRenderer from \"./patternRenderer\";\r\nimport pause from \"../../helpers/schedulers/pause\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport SlicedArray from \"../../helpers/slicedArray\";\r\nimport themeController from \"../../helpers/themeController\";\r\nimport AppSharedMediaTab from \"../sidebarRight/tabs/sharedMedia\";\r\nimport noop from \"../../helpers/noop\";\r\nimport middlewarePromise from \"../../helpers/middlewarePromise\";\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport { Message } from \"../../layer\";\r\n\r\nexport type ChatType = 'chat' | 'pinned' | 'replies' | 'discussion' | 'scheduled';\r\n\r\nexport default class Chat extends EventListenerBase<{\r\n  setPeer: (mid: number, isTopMessage: boolean) => void\r\n}> {\r\n  public container: HTMLElement;\r\n  public backgroundEl: HTMLElement;\r\n\r\n  public topbar: ChatTopbar;\r\n  public bubbles: ChatBubbles;\r\n  public input: ChatInput;\r\n  public selection: ChatSelection;\r\n  public contextMenu: ChatContextMenu;\r\n  public search: ChatSearch;\r\n\r\n  public wasAlreadyUsed: boolean;\r\n  // public initPeerId = 0;\r\n  public peerId: PeerId;\r\n  public threadId: number;\r\n  public setPeerPromise: Promise<void>;\r\n  public peerChanged: boolean;\r\n\r\n  public log: ReturnType<typeof logger>;\r\n\r\n  public type: ChatType;\r\n  public messagesStorageKey: MessagesStorageKey;\r\n\r\n  public noForwards: boolean;\r\n\r\n  public inited: boolean;\r\n\r\n  public isRestricted: boolean;\r\n  public autoDownload: ChatAutoDownloadSettings;\r\n\r\n  public gradientRenderer: ChatBackgroundGradientRenderer;\r\n  public patternRenderer: ChatBackgroundPatternRenderer;\r\n  public gradientCanvas: HTMLCanvasElement;\r\n  public patternCanvas: HTMLCanvasElement;\r\n  public backgroundTempId: number;\r\n  public setBackgroundPromise: Promise<void>;\r\n  public sharedMediaTab: AppSharedMediaTab;\r\n  public sharedMediaTabs: AppSharedMediaTab[];\r\n  // public renderDarkPattern: () => Promise<void>;\r\n\r\n  public isAnyGroup: boolean;\r\n  public isMegagroup: boolean;\r\n  \r\n  constructor(\r\n    public appImManager: AppImManager,\r\n    public managers: AppManagers\r\n  ) {\r\n    super();\r\n\r\n    this.type = 'chat';\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('chat', 'tabs-tab');\r\n\r\n    this.backgroundEl = document.createElement('div');\r\n    this.backgroundEl.classList.add('chat-background');\r\n\r\n    // * constructor end\r\n\r\n    this.log = logger('CHAT', LogTypes.Log | LogTypes.Warn | LogTypes.Debug | LogTypes.Error);\r\n    //this.log.error('Chat construction');\r\n\r\n    this.peerId = NULL_PEER_ID;\r\n\r\n    this.container.append(this.backgroundEl);\r\n    this.appImManager.chatsContainer.append(this.container);\r\n\r\n    this.backgroundTempId = 0;\r\n    this.sharedMediaTabs = [];\r\n  }\r\n\r\n  public setBackground(url: string, skipAnimation?: boolean): Promise<void> {\r\n    const theme = themeController.getTheme();\r\n\r\n    let item: HTMLElement;\r\n    const isColorBackground = !!theme.background.color && !theme.background.slug && !theme.background.intensity;\r\n    if(\r\n      isColorBackground && \r\n      document.documentElement.style.cursor === 'grabbing' && \r\n      this.gradientRenderer && \r\n      !this.patternRenderer\r\n    ) {\r\n      this.gradientCanvas.dataset.colors = theme.background.color;\r\n      this.gradientRenderer.init(this.gradientCanvas);\r\n      return Promise.resolve();\r\n    }\r\n\r\n    const tempId = ++this.backgroundTempId;\r\n\r\n    const previousGradientRenderer = this.gradientRenderer;\r\n    const previousPatternRenderer = this.patternRenderer;\r\n    const previousGradientCanvas = this.gradientCanvas;\r\n    const previousPatternCanvas = this.patternCanvas;\r\n\r\n    this.gradientRenderer = \r\n      this.patternRenderer = \r\n      this.gradientCanvas = \r\n      this.patternCanvas = \r\n      // this.renderDarkPattern = \r\n      undefined;\r\n\r\n    const intensity = theme.background.intensity && theme.background.intensity / 100;\r\n    const isDarkPattern = !!intensity && intensity < 0;\r\n    \r\n    let patternRenderer: ChatBackgroundPatternRenderer;\r\n    let patternCanvas = item?.firstElementChild as HTMLCanvasElement;\r\n    let gradientCanvas: HTMLCanvasElement;\r\n    if(!item) {\r\n      item = document.createElement('div');\r\n      item.classList.add('chat-background-item');\r\n\r\n      if(url) {\r\n        if(intensity) {\r\n          item.classList.add('is-pattern');\r\n\r\n          const rect = this.appImManager.chatsContainer.getBoundingClientRect();\r\n          patternRenderer = this.patternRenderer = ChatBackgroundPatternRenderer.getInstance({\r\n            url,\r\n            width: rect.width,\r\n            height: rect.height,\r\n            mask: isDarkPattern\r\n          });\r\n\r\n          patternCanvas = this.patternCanvas = patternRenderer.createCanvas();\r\n          patternCanvas.classList.add('chat-background-item-canvas', 'chat-background-item-pattern-canvas');\r\n\r\n          if(isDarkPattern) {\r\n            item.classList.add('is-dark');\r\n          }\r\n\r\n          // if(isDarkPattern) {\r\n          //   this.renderDarkPattern = () => {\r\n          //     return patternRenderer.exportCanvasPatternToImage(patternCanvas).then((url) => {\r\n          //       if(this.backgroundTempId !== tempId) {\r\n          //         return;\r\n          //       }\r\n                \r\n          //       gradientCanvas.style.webkitMaskImage = `url(${url})`;\r\n          //     });\r\n          //   };\r\n          // }\r\n        } else if(theme.background.slug) {\r\n          item.classList.add('is-image');\r\n        }\r\n      } else if(theme.background.color) {\r\n        item.classList.add('is-color');\r\n      }\r\n    }\r\n\r\n    let gradientRenderer: ChatBackgroundGradientRenderer;\r\n    const color = theme.background.color;\r\n    if(color) {\r\n      // if(color.includes(',')) {\r\n      const {canvas, gradientRenderer: _gradientRenderer} = ChatBackgroundGradientRenderer.create(color);\r\n      gradientRenderer = this.gradientRenderer = _gradientRenderer;\r\n      gradientCanvas = this.gradientCanvas = canvas;\r\n      gradientCanvas.classList.add('chat-background-item-canvas', 'chat-background-item-color-canvas');\r\n\r\n      if(rootScope.settings.animationsEnabled) {\r\n        gradientRenderer.scrollAnimate(true);\r\n      }\r\n      // } else {\r\n      //   item.style.backgroundColor = color;\r\n      //   item.style.backgroundImage = 'none';\r\n      // }\r\n    }\r\n\r\n    if(patternRenderer) {\r\n      const setOpacityTo = isDarkPattern ? gradientCanvas : patternCanvas;\r\n      setOpacityTo.style.setProperty('--opacity-max', '' + Math.abs(intensity));\r\n    }\r\n\r\n    const promise = new Promise<void>((resolve) => {\r\n      const cb = () => {\r\n        if(this.backgroundTempId !== tempId) {\r\n          if(patternRenderer) {\r\n            patternRenderer.cleanup(patternCanvas);\r\n          }\r\n\r\n          if(gradientRenderer) {\r\n            gradientRenderer.cleanup();\r\n          }\r\n\r\n          return;\r\n        }\r\n\r\n        const prev = this.backgroundEl.lastElementChild as HTMLElement;\r\n\r\n        if(prev === item) {\r\n          resolve();\r\n          return;\r\n        }\r\n\r\n        const append = [\r\n          gradientCanvas, \r\n          // isDarkPattern && this.renderDarkPattern ? undefined : patternCanvas\r\n          patternCanvas\r\n        ].filter(Boolean);\r\n        if(append.length) {\r\n          item.append(...append);\r\n        }\r\n\r\n        this.backgroundEl.append(item);\r\n\r\n        SetTransition(item, 'is-visible', true, !skipAnimation ? 200 : 0, prev ? () => {\r\n          if(previousPatternRenderer) {\r\n            previousPatternRenderer.cleanup(previousPatternCanvas);\r\n          }\r\n\r\n          if(previousGradientRenderer) {\r\n            previousGradientRenderer.cleanup();\r\n          }\r\n\r\n          prev.remove();\r\n        } : null, 2);\r\n\r\n        resolve();\r\n      };\r\n\r\n      if(patternRenderer) {\r\n        const renderPatternPromise = patternRenderer.renderToCanvas(patternCanvas);\r\n        renderPatternPromise.then(() => {\r\n          if(this.backgroundTempId !== tempId) {\r\n            return;\r\n          }\r\n\r\n          let promise: Promise<any>;\r\n          // if(isDarkPattern && this.renderDarkPattern) {\r\n          //   promise = this.renderDarkPattern();\r\n          // } else {\r\n            promise = Promise.resolve();\r\n          // }\r\n          \r\n          promise.then(cb);\r\n        });\r\n      } else if(url) {\r\n        renderImageFromUrl(item, url, cb);\r\n      } else {\r\n        cb();\r\n      }\r\n    });\r\n\r\n    return this.setBackgroundPromise = Promise.race([\r\n      pause(500),\r\n      promise\r\n    ]);\r\n  }\r\n\r\n  public setType(type: ChatType) {\r\n    this.type = type;\r\n  }\r\n\r\n  public init(/* peerId: PeerId */) {\r\n    // this.initPeerId = peerId;\r\n\r\n    this.topbar = new ChatTopbar(this, appSidebarRight, this.managers);\r\n    this.bubbles = new ChatBubbles(this, this.managers);\r\n    this.input = new ChatInput(this, this.appImManager, this.managers);\r\n    this.contextMenu = new ChatContextMenu(this, this.managers);\r\n    this.selection = new ChatSelection(this, this.bubbles, this.input, this.managers);\r\n\r\n    if(this.type === 'chat') {\r\n      this.topbar.constructUtils();\r\n      this.topbar.constructPeerHelpers();\r\n    } else if(this.type === 'pinned') {\r\n      this.topbar.constructPinnedHelpers();\r\n    } else if(this.type === 'discussion') {\r\n      this.topbar.constructUtils();\r\n      this.topbar.constructDiscussionHelpers();\r\n    }\r\n\r\n    this.topbar.construct();\r\n    this.input.construct();\r\n\r\n    if(this.type === 'chat') { // *   ,   -   \r\n      this.bubbles.constructPeerHelpers();\r\n      this.input.constructPeerHelpers();\r\n    } else if(this.type === 'pinned') {\r\n      this.bubbles.constructPinnedHelpers();\r\n      this.input.constructPinnedHelpers();\r\n    } else if(this.type === 'scheduled') {\r\n      this.bubbles.constructScheduledHelpers();\r\n      this.input.constructPeerHelpers();\r\n    } else if(this.type === 'discussion') {\r\n      this.bubbles.constructPeerHelpers();\r\n      this.input.constructPeerHelpers();\r\n    }\r\n\r\n    if(this.type !== 'scheduled' && !IS_TOUCH_SUPPORTED) {\r\n      this.bubbles.setReactionsHoverListeners();\r\n    }\r\n\r\n    this.bubbles.attachContainerListeners();\r\n\r\n    this.container.classList.add('type-' + this.type);\r\n    this.container.append(this.topbar.container, this.bubbles.container, this.input.chatInput);\r\n\r\n    this.bubbles.listenerSetter.add(rootScope)('dialog_migrate', ({migrateFrom, migrateTo}) => {\r\n      if(this.peerId === migrateFrom) {\r\n        this.setPeer(migrateTo);\r\n      }\r\n    });\r\n\r\n    this.bubbles.listenerSetter.add(rootScope)('dialog_drop', (e) => {\r\n      if(e.peerId === this.peerId) {\r\n        this.appImManager.setPeer();\r\n      }\r\n    });\r\n  }\r\n\r\n  public beforeDestroy() {\r\n    this.bubbles.cleanup();\r\n  }\r\n\r\n  private cleanupBackground() {\r\n    ++this.backgroundTempId;\r\n    if(this.patternRenderer) {\r\n      this.patternRenderer.cleanup(this.patternCanvas);\r\n      this.patternRenderer = undefined;\r\n    }\r\n\r\n    if(this.gradientRenderer) {\r\n      this.gradientRenderer.cleanup();\r\n      this.gradientRenderer = undefined;\r\n    }\r\n  }\r\n\r\n  public destroy() {\r\n    //const perf = performance.now();\r\n\r\n    this.topbar.destroy();\r\n    this.bubbles.destroy();\r\n    this.input.destroy();\r\n    this.contextMenu && this.contextMenu.destroy();\r\n    this.selection && this.selection.attachListeners(undefined, undefined);\r\n\r\n    this.cleanupBackground();\r\n\r\n    delete this.topbar;\r\n    delete this.bubbles;\r\n    delete this.input;\r\n    delete this.selection;\r\n    delete this.contextMenu;\r\n\r\n    this.container.remove();\r\n\r\n    //this.log.error('Chat destroy time:', performance.now() - perf);\r\n  }\r\n\r\n  public cleanup(helperToo = true) {\r\n    this.input.cleanup(helperToo);\r\n    this.topbar.cleanup();\r\n    this.selection.cleanup();\r\n  }\r\n  \r\n  public async onChangePeer(m: ReturnType<typeof middlewarePromise>) {\r\n    const {peerId} = this;\r\n\r\n    const searchTab = appSidebarRight.getTab(AppPrivateSearchTab);\r\n    if(searchTab) {\r\n      searchTab.close();\r\n    }\r\n\r\n    const [noForwards, isRestricted, isAnyGroup, _, isMegagroup] = await m(Promise.all([\r\n      this.managers.appPeersManager.noForwards(peerId),\r\n      this.managers.appPeersManager.isRestricted(peerId),\r\n      this._isAnyGroup(peerId),\r\n      this.setAutoDownloadMedia(),\r\n      this.managers.appPeersManager.isMegagroup(peerId)\r\n    ]));\r\n\r\n    this.noForwards = noForwards;\r\n    this.isRestricted = isRestricted;\r\n    this.isAnyGroup = isAnyGroup;\r\n    this.isMegagroup = isMegagroup;\r\n\r\n    this.container.classList.toggle('no-forwards', this.noForwards);\r\n\r\n    this.sharedMediaTab = appSidebarRight.createSharedMediaTab();\r\n    this.sharedMediaTabs.push(this.sharedMediaTab);\r\n\r\n    this.sharedMediaTab.setPeer(peerId, this.threadId);\r\n    this.input.clearHelper(); // \r\n    this.selection.cleanup(); // TODO: REFACTOR !!!!!!\r\n  }\r\n\r\n  public setPeer(peerId: PeerId, lastMsgId?: number, startParam?: string) {\r\n    if(!peerId) {\r\n      this.inited = undefined;\r\n    } else if(!this.inited) {\r\n      if(this.init) {\r\n        this.init(/* peerId */);\r\n        this.init = null;\r\n      }\r\n\r\n      this.inited = true;\r\n    }\r\n\r\n    // const appMediaViewer = (window as any).appMediaViewer as AppMediaViewerBase<any, any, any>;\r\n    // if(appMediaViewer) {\r\n    //   appMediaViewer.close();\r\n    // }\r\n\r\n    const samePeer = this.peerId === peerId;\r\n    if(!samePeer) {\r\n      this.appImManager.dispatchEvent('peer_changing', this);\r\n      this.peerId = peerId || NULL_PEER_ID;\r\n      this.messagesStorageKey = `${this.peerId}_${this.type === 'scheduled' ? 'scheduled' : 'history'}`;\r\n    } else if(this.setPeerPromise) {\r\n      return;\r\n    }\r\n\r\n    if(!peerId) {\r\n      appSidebarRight.toggleSidebar(false);\r\n      this.cleanup(true);\r\n      this.bubbles.setPeer(false, peerId);\r\n      this.appImManager.dispatchEvent('peer_changed', peerId);\r\n\r\n      appSidebarRight.replaceSharedMediaTab();\r\n      this.destroySharedMediaTab();\r\n      this.sharedMediaTab = undefined;\r\n\r\n      return;\r\n    }\r\n\r\n    this.peerChanged = samePeer;\r\n\r\n    const bubblesSetPeerPromise = this.bubbles.setPeer(samePeer, peerId, lastMsgId, startParam);\r\n    const setPeerPromise = this.setPeerPromise = bubblesSetPeerPromise.then((result) => {\r\n      return result.promise;\r\n    }).catch(noop).finally(() => {\r\n      if(this.setPeerPromise === setPeerPromise) {\r\n        this.setPeerPromise = null;\r\n      }\r\n    });\r\n\r\n    return bubblesSetPeerPromise;\r\n  }\r\n\r\n  public destroySharedMediaTab(tab = this.sharedMediaTab) {\r\n    indexOfAndSplice(this.sharedMediaTabs, tab);\r\n    tab.destroy();\r\n  }\r\n\r\n  public async setAutoDownloadMedia() {\r\n    this.autoDownload = await getAutoDownloadSettingsByPeerId(this.peerId);\r\n  }\r\n\r\n  public setMessageId(messageId?: number) {\r\n    return this.setPeer(this.peerId, messageId);\r\n  }\r\n\r\n  public async finishPeerChange(isTarget: boolean, isJump: boolean, lastMsgId: number, startParam?: string) {\r\n    if(this.peerChanged) return;\r\n\r\n    const peerId = this.peerId;\r\n    this.peerChanged = true;\r\n    this.wasAlreadyUsed = true;\r\n\r\n    const middleware = this.bubbles.getMiddleware();\r\n\r\n    this.cleanup(false);\r\n\r\n    const sharedMediaTab = this.sharedMediaTab;\r\n    sharedMediaTab.loadSidebarMedia(true);\r\n\r\n    const callbacksPromise = Promise.all([\r\n      this.topbar.finishPeerChange(isTarget),\r\n      this.bubbles.finishPeerChange(),\r\n      this.input.finishPeerChange(startParam),\r\n    ]);\r\n\r\n    const [callbacks] = await Promise.all([\r\n      callbacksPromise,\r\n      sharedMediaTab.fillProfileElements()\r\n    ]);\r\n\r\n    if(!middleware()) {\r\n      return;\r\n    }\r\n\r\n    callbacks.forEach((callback) => {\r\n      callback();\r\n    });\r\n\r\n    appSidebarRight.replaceSharedMediaTab(sharedMediaTab);\r\n\r\n    this.sharedMediaTabs.filter((tab) => tab !== sharedMediaTab).forEach((tab) => this.destroySharedMediaTab(tab));\r\n\r\n    this.log.setPrefix('CHAT-' + peerId + '-' + this.type);\r\n\r\n    this.appImManager.dispatchEvent('peer_changed', peerId);\r\n  }\r\n\r\n  public getMessage(mid: number) {\r\n    return this.managers.appMessagesManager.getMessageFromStorage(this.messagesStorageKey, mid);\r\n  }\r\n\r\n  public async getMidsByMid(mid: number) {\r\n    return this.managers.appMessagesManager.getMidsByMessage(await this.getMessage(mid));\r\n  }\r\n\r\n  public getHistoryStorage(ignoreThreadId?: boolean) {\r\n    return this.managers.appMessagesManager.getHistoryStorageTransferable(this.peerId, ignoreThreadId ? undefined : this.threadId)\r\n    .then((historyStorageTransferable) => {\r\n      return {\r\n        ...historyStorageTransferable,\r\n        history: SlicedArray.fromJSON<number>(historyStorageTransferable.historySerialized)\r\n      }\r\n    });\r\n  }\r\n\r\n  public getHistoryMaxId() {\r\n    return this.getHistoryStorage().then((historyStorage) => historyStorage.maxId);\r\n  }\r\n\r\n  public async _isAnyGroup(peerId: PeerId) {\r\n    return peerId === rootScope.myId || peerId === REPLIES_PEER_ID || (await this.managers.appPeersManager.isAnyGroup(peerId));\r\n  }\r\n\r\n  public initSearch(query?: string) {\r\n    if(!this.peerId) return;\r\n\r\n    if(mediaSizes.isMobile) {\r\n      if(!this.search) {\r\n        this.search = new ChatSearch(this.topbar, this, query);\r\n      } else {\r\n        this.search.setQuery(query);\r\n      }\r\n    } else {\r\n      let tab = appSidebarRight.getTab(AppPrivateSearchTab);\r\n      if(!tab) {\r\n        tab = appSidebarRight.createTab(AppPrivateSearchTab);\r\n      }\r\n\r\n      tab.open(this.peerId, this.threadId, this.bubbles.onDatePick, query);\r\n    }\r\n  }\r\n\r\n  public canSend(action?: ChatRights) {\r\n    return this.managers.appMessagesManager.canSendToPeer(this.peerId, this.threadId, action);\r\n  }\r\n\r\n  public isStartButtonNeeded() {\r\n    return Promise.all([\r\n      this.managers.appPeersManager.isBot(this.peerId),\r\n      this.managers.appMessagesManager.getDialogOnly(this.peerId),\r\n      this.getHistoryStorage(true)\r\n    ]).then(([isBot, dialog, historyStorage]) => {\r\n      return isBot && !dialog && !historyStorage.history.length;\r\n    });\r\n  }\r\n\r\n  public getMessageSendingParams() {\r\n    return {\r\n      threadId: this.threadId,\r\n      replyToMsgId: this.input.replyToMsgId,\r\n      scheduleDate: this.input.scheduleDate,\r\n      sendSilent: this.input.sendSilent,\r\n      sendAsPeerId: this.input.sendAsPeerId\r\n    };\r\n  }\r\n\r\n  public isOurMessage(message: Message.message | Message.messageService) {\r\n    return message.fromId === rootScope.myId || (message.pFlags.out && this.isMegagroup);\r\n  }\r\n\r\n  public isOutMessage(message: Message.message | Message.messageService) {\r\n    const fwdFrom = (message as Message.message).fwd_from;\r\n    const isOut = this.isOurMessage(message) && (!fwdFrom || this.peerId !== rootScope.myId);\r\n    return isOut;\r\n  }\r\n\r\n  public isAvatarNeeded(message: Message.message | Message.messageService) {\r\n    return this.isAnyGroup && !this.isOutMessage(message);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { State } from \"../config/state\";\r\nimport rootScope from \"../lib/rootScope\";\r\n\r\nexport type ChatAutoDownloadSettings = {\r\n  photo: number,\r\n  video: number,\r\n  file: number\r\n};\r\n\r\nexport default async function getAutoDownloadSettingsByPeerId(peerId: PeerId): Promise<ChatAutoDownloadSettings> {\r\n  let type: keyof State['settings']['autoDownload'];\r\n\r\n  let photoSizeMax = 0, videoSizeMax = 0, fileSizeMax = 0;\r\n  const settings = rootScope.settings;\r\n  const appPeersManager = rootScope.managers.appPeersManager;\r\n  if(!settings.autoDownloadNew.pFlags.disabled && peerId) {\r\n    if(peerId.isUser()) {\r\n      if(await appPeersManager.isContact(peerId)) {\r\n        type = 'contacts';\r\n      } else {\r\n        type = 'private';\r\n      }\r\n    } else if(await appPeersManager.isBroadcast(peerId)) {\r\n      type = 'channels';\r\n    } else {\r\n      type = 'groups';\r\n    }\r\n    \r\n    if(settings.autoDownload.photo[type]) photoSizeMax = settings.autoDownloadNew.photo_size_max;\r\n    if(settings.autoDownload.video[type]) videoSizeMax = settings.autoDownloadNew.video_size_max;\r\n    if(settings.autoDownload.file[type]) fileSizeMax = settings.autoDownloadNew.file_size_max;\r\n  }\r\n\r\n  return {\r\n    photo: photoSizeMax,\r\n    video: videoSizeMax,\r\n    file: fileSizeMax\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { AppImManager } from \"../../lib/appManagers/appImManager\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport { IS_APPLE, IS_MOBILE } from \"../../environment/userAgent\";\r\nimport appNavigationController from \"../appNavigationController\";\r\nimport { _i18n } from \"../../lib/langPack\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport getSelectedNodes from \"../../helpers/dom/getSelectedNodes\";\r\nimport isSelectionEmpty from \"../../helpers/dom/isSelectionEmpty\";\r\nimport { MarkdownType, markdownTags } from \"../../helpers/dom/getRichElementValue\";\r\nimport getVisibleRect from \"../../helpers/dom/getVisibleRect\";\r\nimport clamp from \"../../helpers/number/clamp\";\r\nimport matchUrl from \"../../lib/richTextProcessor/matchUrl\";\r\nimport matchUrlProtocol from \"../../lib/richTextProcessor/matchUrlProtocol\";\r\n//import { logger } from \"../../lib/logger\";\r\n\r\nexport default class MarkupTooltip {\r\n  public container: HTMLElement;\r\n  private wrapper: HTMLElement;\r\n  private buttons: {[type in MarkdownType]: HTMLElement} = {} as any;\r\n  private linkBackButton: HTMLElement;\r\n  private linkApplyButton: HTMLButtonElement;\r\n  private hideTimeout: number;\r\n  private addedListener = false;\r\n  private waitingForMouseUp = false;\r\n  private linkInput: HTMLInputElement;\r\n  private savedRange: Range;\r\n  private mouseUpCounter: number = 0;\r\n  //private log: ReturnType<typeof logger>;\r\n\r\n  constructor(private appImManager: AppImManager) {\r\n    //this.log = logger('MARKUP');\r\n  }\r\n\r\n  private init() {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('markup-tooltip', 'z-depth-1', 'hide');\r\n\r\n    this.wrapper = document.createElement('div');\r\n    this.wrapper.classList.add('markup-tooltip-wrapper');\r\n    \r\n    const tools1 = document.createElement('div');\r\n    const tools2 = document.createElement('div');\r\n    tools1.classList.add('markup-tooltip-tools');\r\n    tools2.classList.add('markup-tooltip-tools');\r\n\r\n    const arr = ['bold', 'italic', 'underline', 'strikethrough', 'monospace', 'spoiler', 'link'] as (keyof MarkupTooltip['buttons'])[];\r\n    arr.forEach((c) => {\r\n      const button = ButtonIcon(c, {noRipple: true});\r\n      tools1.append(this.buttons[c] = button);\r\n\r\n      if(c !== 'link') {\r\n        button.addEventListener('mousedown', (e) => {\r\n          cancelEvent(e); \r\n          this.appImManager.chat.input.applyMarkdown(c);\r\n          this.cancelClosening();\r\n          \r\n          /* this.mouseUpCounter = 0;\r\n          this.setMouseUpEvent(); */\r\n          //this.hide();\r\n        });\r\n      } else {\r\n        attachClickEvent(button, (e) => {\r\n          cancelEvent(e);\r\n          this.showLinkEditor();\r\n          this.cancelClosening();\r\n        });\r\n      }\r\n    });\r\n\r\n    this.linkBackButton = ButtonIcon('left', {noRipple: true});\r\n    this.linkInput = document.createElement('input');\r\n    _i18n(this.linkInput, 'MarkupTooltip.LinkPlaceholder', undefined, 'placeholder');\r\n    this.linkInput.classList.add('input-clear');\r\n    this.linkInput.addEventListener('keydown', (e) => {\r\n      const valid = !this.linkInput.value.length || !!matchUrl(this.linkInput.value);///^(http)|(https):\\/\\//i.test(this.linkInput.value);\r\n\r\n      if(e.key === 'Enter') {\r\n        if(!valid) {\r\n          if(this.linkInput.classList.contains('error')) {\r\n            this.linkInput.classList.remove('error');\r\n            void this.linkInput.offsetLeft; // reflow\r\n          }\r\n\r\n          this.linkInput.classList.add('error');\r\n        } else {\r\n          this.applyLink(e);\r\n        }\r\n      }\r\n    });\r\n\r\n    this.linkInput.addEventListener('input', (e) => {\r\n      const valid = this.isLinkValid();\r\n\r\n      this.linkInput.classList.toggle('is-valid', valid);\r\n      this.linkInput.classList.remove('error');\r\n    });\r\n\r\n    this.linkBackButton.addEventListener('mousedown', (e) => {\r\n      //this.log('linkBackButton click');\r\n      cancelEvent(e);\r\n      this.container.classList.remove('is-link');\r\n      //input.value = '';\r\n      this.resetSelection();\r\n      this.setTooltipPosition();\r\n      this.cancelClosening();\r\n    });\r\n\r\n    this.linkApplyButton = ButtonIcon('check markup-tooltip-link-apply', {noRipple: true});\r\n    this.linkApplyButton.addEventListener('mousedown', (e) => {\r\n      //this.log('linkApplyButton click');\r\n      this.applyLink(e);\r\n    });\r\n\r\n    const applyDiv = document.createElement('div');\r\n    applyDiv.classList.add('markup-tooltip-link-apply-container');\r\n    \r\n    const delimiter1 = document.createElement('span');\r\n    const delimiter2 = document.createElement('span');\r\n    const delimiter3 = document.createElement('span');\r\n    delimiter1.classList.add('markup-tooltip-delimiter');\r\n    delimiter2.classList.add('markup-tooltip-delimiter');\r\n    delimiter3.classList.add('markup-tooltip-delimiter');\r\n    tools1.insertBefore(delimiter1, this.buttons.link);\r\n    applyDiv.append(delimiter3, this.linkApplyButton);\r\n    tools2.append(this.linkBackButton, delimiter2, this.linkInput, applyDiv);\r\n    //tools1.insertBefore(delimiter2, this.buttons.link.nextSibling);\r\n\r\n    this.wrapper.append(tools1, tools2);\r\n    this.container.append(this.wrapper);\r\n    document.body.append(this.container);\r\n    \r\n    window.addEventListener('resize', () => {\r\n      this.hide();\r\n    });\r\n  }\r\n\r\n  public showLinkEditor() {\r\n    if(!this.container || !this.container.classList.contains('is-visible')) { // * if not inited yet (Ctrl+A + Ctrl+K)\r\n      this.show();\r\n    }\r\n\r\n    const button = this.buttons.link;\r\n    this.container.classList.add('is-link');\r\n\r\n    const selection = document.getSelection();\r\n    this.savedRange = selection.getRangeAt(0);\r\n    \r\n    if(button.classList.contains('active')) {\r\n      const startContainer = this.savedRange.startContainer;\r\n      const anchor = startContainer.parentElement as HTMLAnchorElement;\r\n      this.linkInput.value = anchor.href;\r\n    } else {\r\n      this.linkInput.value = '';\r\n    }\r\n\r\n    this.setTooltipPosition(true);\r\n\r\n    setTimeout(() => {\r\n      this.linkInput.focus(); // !!! instant focus will break animation\r\n    }, 200);\r\n    this.linkInput.classList.toggle('is-valid', this.isLinkValid());\r\n  }\r\n\r\n  private applyLink(e: Event) {\r\n    cancelEvent(e);\r\n    this.resetSelection();\r\n    let url = this.linkInput.value;\r\n    if(url && !matchUrlProtocol(url)) {\r\n      url = 'https://' + url;\r\n    }\r\n    this.appImManager.chat.input.applyMarkdown('link', url);\r\n    setTimeout(() => {\r\n      this.hide();\r\n    }, 0);\r\n  }\r\n\r\n  private isLinkValid() {\r\n    return !this.linkInput.value.length || !!matchUrl(this.linkInput.value);\r\n  }\r\n\r\n  private resetSelection(range: Range = this.savedRange) {\r\n    const selection = window.getSelection();\r\n    selection.removeAllRanges();\r\n    selection.addRange(range);\r\n    this.appImManager.chat.input.messageInput.focus();\r\n  }\r\n\r\n  public hide() {\r\n    //return;\r\n\r\n    if(this.init) return;\r\n\r\n    this.container.classList.remove('is-visible');\r\n    //document.removeEventListener('mouseup', this.onMouseUp);\r\n    document.removeEventListener('mouseup', this.onMouseUpSingle);\r\n    this.waitingForMouseUp = false;\r\n\r\n    appNavigationController.removeByType('markup');\r\n\r\n    if(this.hideTimeout) clearTimeout(this.hideTimeout);\r\n    this.hideTimeout = window.setTimeout(() => {\r\n      this.hideTimeout = undefined;\r\n      this.container.classList.add('hide');\r\n      this.container.classList.remove('is-link');\r\n    }, 200);\r\n  }\r\n\r\n  public getActiveMarkupButton() {\r\n    const nodes = getSelectedNodes();\r\n    const parents = [...new Set(nodes.map((node) => node.parentNode))];\r\n    //if(parents.length > 1 && parents) return [];\r\n\r\n    const currentMarkups: Set<HTMLElement> = new Set();\r\n    (parents as HTMLElement[]).forEach((node) => {\r\n      for(const type in markdownTags) {\r\n        const tag = markdownTags[type as MarkdownType];\r\n        const closest = node.closest(tag.match + ', [contenteditable]');\r\n        if(closest !== this.appImManager.chat.input.messageInput) {\r\n          currentMarkups.add(this.buttons[type as MarkdownType]);\r\n        }\r\n      }\r\n    });\r\n    \r\n\r\n    return [...currentMarkups];\r\n  }\r\n\r\n  public setActiveMarkupButton() {\r\n    const activeButtons = this.getActiveMarkupButton();\r\n\r\n    for(const i in this.buttons) {\r\n      // @ts-ignore\r\n      const button = this.buttons[i];\r\n      button.classList.toggle('active', activeButtons.includes(button));\r\n    }\r\n  }\r\n\r\n  private setTooltipPosition(isLinkToggle = false) {\r\n    const selection = document.getSelection();\r\n    const range = selection.getRangeAt(0);\r\n\r\n    const bodyRect = document.body.getBoundingClientRect();\r\n    const selectionRect = range.getBoundingClientRect();\r\n    const inputRect = this.appImManager.chat.input.rowsWrapper.getBoundingClientRect();\r\n\r\n    this.container.style.maxWidth = inputRect.width + 'px';\r\n\r\n    const visibleRect = getVisibleRect(undefined, this.appImManager.chat.input.messageInput, false, selectionRect);\r\n\r\n    const selectionTop = visibleRect.rect.top/* selectionRect.top */ + (bodyRect.top * -1);\r\n    \r\n    const currentTools = this.container.classList.contains('is-link') ? this.wrapper.lastElementChild : this.wrapper.firstElementChild;\r\n\r\n    const sizesRect = currentTools.getBoundingClientRect();\r\n    const top = selectionTop - sizesRect.height - 8;\r\n    \r\n    const minX = inputRect.left;\r\n    const maxX = (inputRect.left + inputRect.width) - Math.min(inputRect.width, sizesRect.width);\r\n    let left: number;\r\n    if(isLinkToggle) {\r\n      const containerRect = this.container.getBoundingClientRect();\r\n      left = clamp(containerRect.left, minX, maxX);\r\n    } else {\r\n      const x = selectionRect.left + (selectionRect.width - sizesRect.width) / 2;\r\n      left = clamp(x, minX, maxX);\r\n    }\r\n\r\n    /* const isClamped = x !== minX && x !== maxX && (left === minX || left === maxX || this.container.getBoundingClientRect().left >= maxX);\r\n\r\n    if(isLinkToggle && this.container.classList.contains('is-link') && !isClamped) return; */\r\n    \r\n    this.container.style.transform = `translate3d(${left}px, ${top}px, 0)`;\r\n  }\r\n\r\n  public show() {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    if(isSelectionEmpty()) {\r\n      this.hide();\r\n      return;\r\n    }\r\n\r\n    if(this.hideTimeout !== undefined) {\r\n      clearTimeout(this.hideTimeout);\r\n    }\r\n\r\n    if(this.container.classList.contains('is-visible')) {\r\n      return;\r\n    }\r\n\r\n    this.setActiveMarkupButton();\r\n    \r\n    this.container.classList.remove('is-link');\r\n    const isFirstShow = this.container.classList.contains('hide');\r\n    if(isFirstShow) {\r\n      this.container.classList.remove('hide');\r\n      this.container.classList.add('no-transition');\r\n    }\r\n    \r\n    this.setTooltipPosition();\r\n    \r\n    if(isFirstShow) {\r\n      void this.container.offsetLeft; // reflow\r\n      this.container.classList.remove('no-transition');\r\n    }\r\n    \r\n    this.container.classList.add('is-visible');\r\n\r\n    if(!IS_MOBILE) {\r\n      appNavigationController.pushItem({\r\n        type: 'markup',\r\n        onPop: () => {\r\n          this.hide();\r\n        }\r\n      });\r\n    }\r\n\r\n    //this.log('selection', selectionRect, activeButton);\r\n  }\r\n\r\n  /* private onMouseUp = (e: Event) => {\r\n    this.log('onMouseUp');\r\n    if(findUpClassName(e.target, 'markup-tooltip')) return;\r\n\r\n    this.hide();\r\n    //document.removeEventListener('mouseup', this.onMouseUp);\r\n  }; */\r\n\r\n  private onMouseUpSingle = (e?: Event) => {\r\n    //this.log('onMouseUpSingle');\r\n    this.waitingForMouseUp = false;\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      e && cancelEvent(e);\r\n      if(this.mouseUpCounter++ === 0) {\r\n        this.resetSelection(this.savedRange);\r\n      } else {\r\n        this.hide();\r\n        return;\r\n      }\r\n    }\r\n\r\n    this.show();\r\n\r\n    /* !isTouchSupported && document.addEventListener('mouseup', this.onMouseUp); */\r\n  };\r\n\r\n  public setMouseUpEvent() {\r\n    if(this.waitingForMouseUp) return;\r\n    this.waitingForMouseUp = true;\r\n\r\n    //this.log('setMouseUpEvent');\r\n\r\n    document.addEventListener('mouseup', this.onMouseUpSingle, {once: true});\r\n  }\r\n\r\n  public cancelClosening() {\r\n    if(IS_TOUCH_SUPPORTED && !IS_APPLE) {\r\n      document.removeEventListener('mouseup', this.onMouseUpSingle);\r\n      document.addEventListener('mouseup', (e) => {\r\n        cancelEvent(e);\r\n        this.mouseUpCounter = 1;\r\n        this.waitingForMouseUp = false;\r\n        this.setMouseUpEvent();\r\n      }, {once: true});\r\n    }\r\n  }\r\n\r\n  public handleSelection() {\r\n    if(this.addedListener) return;\r\n    this.addedListener = true;\r\n    document.addEventListener('selectionchange', (e) => {\r\n      //this.log('selectionchange');\r\n\r\n      if(document.activeElement === this.linkInput) {\r\n        return;\r\n      }\r\n\r\n      const messageInput = this.appImManager.chat.input.messageInput;\r\n      if(document.activeElement !== messageInput) {\r\n        this.hide();\r\n        return;\r\n      }\r\n\r\n      const selection = document.getSelection();\r\n      if(isSelectionEmpty(selection)) {\r\n        this.hide();\r\n        return;\r\n      }\r\n\r\n      if(IS_TOUCH_SUPPORTED) {\r\n        if(IS_APPLE) {\r\n          this.show();\r\n          this.setTooltipPosition(); // * because can skip this in .show();\r\n        } else {\r\n          if(this.mouseUpCounter === 2) {\r\n            this.mouseUpCounter = 0;\r\n            return;\r\n          }\r\n\r\n          this.savedRange = selection.getRangeAt(0);\r\n          this.setMouseUpEvent();\r\n          /* document.addEventListener('touchend', (e) => {\r\n            cancelEvent(e);\r\n            this.resetSelection(range);\r\n            this.show();\r\n          }, {once: true, passive: false}); */\r\n        }\r\n      } else if(this.container && this.container.classList.contains('is-visible')) {\r\n        this.setTooltipPosition();\r\n      } else if(messageInput.matches(':active')) {\r\n        this.setMouseUpEvent();\r\n      } else {\r\n        this.show();\r\n      }\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function getSelectedNodes() {\r\n  const nodes: Node[] = [];\r\n  const selection = window.getSelection();\r\n  for(let i = 0; i < selection.rangeCount; ++i) {\r\n    const range = selection.getRangeAt(i);\r\n    let {startContainer, endContainer} = range;\r\n    if(endContainer.nodeType !== 3) endContainer = endContainer.firstChild;\r\n    \r\n    while(startContainer && startContainer !== endContainer) {\r\n      nodes.push(startContainer.nodeType === 3 ? startContainer : startContainer.firstChild);\r\n      startContainer = startContainer.nextSibling;\r\n    }\r\n    \r\n    if(nodes[nodes.length - 1] !== endContainer) {\r\n      nodes.push(endContainer);\r\n    }\r\n  }\r\n\r\n  // * filter null's due to <br>\r\n  return nodes.filter((node) => !!node);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n// generate a path's arc data parameter\r\n\r\nimport { MOUNT_CLASS_TO } from \"../config/debug\";\r\n\r\n// http://www.w3.org/TR/SVG/paths.html#PathDataEllipticalArcCommands\r\nfunction arcParameter(rx: number, ry: number, xAxisRotation: number, largeArcFlag: number, sweepFlag: number, x: number, y: number) {\r\n  return [rx, ',', ry, ' ',\r\n          xAxisRotation, ' ',\r\n          largeArcFlag, ',',\r\n          sweepFlag, ' ',\r\n          x, ',', y ].join('');\r\n}\r\n\r\nexport default function generatePathData(x: number, y: number, width: number, height: number, tl: number, tr: number, br: number, bl: number) {\r\n  const data: string[] = [];\r\n\r\n  // start point in top-middle of the rectangle\r\n  data.push('M' + (x + width / 2) + ',' + y);\r\n\r\n  // next we go to the right\r\n  data.push('H' + (x + width - tr));\r\n\r\n  if(tr > 0) {\r\n    // now we draw the arc in the top-right corner\r\n    data.push('A' + arcParameter(tr, tr, 0, 0, 1, (x + width), (y + tr)));\r\n  }\r\n\r\n  // next we go down\r\n  data.push('V' + (y + height - br));\r\n\r\n  if(br > 0) {\r\n    // now we draw the arc in the lower-right corner\r\n    data.push('A' + arcParameter(br, br, 0, 0, 1, (x + width - br), (y + height)));\r\n  }\r\n\r\n  // now we go to the left\r\n  data.push('H' + (x + bl));\r\n\r\n  if(bl > 0) {\r\n    // now we draw the arc in the lower-left corner\r\n    data.push('A' + arcParameter(bl, bl, 0, 0, 1, (x + 0), (y + height - bl)));\r\n  }\r\n\r\n  // next we go up\r\n  data.push('V' + (y + tl));\r\n\r\n  if(tl > 0) {\r\n    // now we draw the arc in the top-left corner\r\n    data.push('A' + arcParameter(tl, tl, 0, 0, 1, (x + tl), (y + 0)));\r\n  }\r\n\r\n  // and we close the path\r\n  data.push('Z');\r\n\r\n  return data.join(' ');\r\n}\r\n\r\nMOUNT_CLASS_TO.generatePathData = generatePathData;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport generatePathData from \"../../helpers/generatePathData\";\r\nimport { FormatterArguments, i18n, LangPackKey } from \"../../lib/langPack\";\r\n\r\nexport default class ChatDragAndDrop {\r\n  container: HTMLDivElement;\r\n  svg: SVGSVGElement;\r\n  outlineWrapper: HTMLDivElement;\r\n  path: SVGPathElement;\r\n\r\n  constructor(appendTo: HTMLElement, private options: {\r\n    icon?: string,\r\n    header: LangPackKey,\r\n    headerArgs?: FormatterArguments,\r\n    subtitle?: LangPackKey,\r\n    onDrop: (e: DragEvent) => void\r\n  }) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('drop', 'z-depth-1');\r\n\r\n    this.outlineWrapper = document.createElement('div');\r\n    this.outlineWrapper.classList.add('drop-outline-wrapper');\r\n\r\n    this.svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\r\n    this.svg.classList.add('drop-outline');\r\n\r\n    this.path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n    this.path.classList.add('drop-outline-path');\r\n\r\n    let dropIcon: HTMLElement;\r\n    if(options.icon) {\r\n      dropIcon = document.createElement('div');\r\n      dropIcon.classList.add('drop-icon', 'tgico-' + options.icon);\r\n    }\r\n\r\n    const dropHeader = document.createElement('div');\r\n    dropHeader.classList.add('drop-header');\r\n    dropHeader.append(i18n(options.header, options.headerArgs));\r\n\r\n    let dropSubtitle: HTMLElement;\r\n    if(options.subtitle) {\r\n      dropSubtitle = document.createElement('div');\r\n      dropSubtitle.classList.add('drop-subtitle');\r\n      dropSubtitle.append(i18n(options.subtitle));\r\n    }\r\n\r\n    this.svg.append(this.path);\r\n    this.outlineWrapper.append(this.svg);\r\n\r\n    this.container.append(...[this.outlineWrapper, dropIcon, dropHeader, dropSubtitle].filter(Boolean));\r\n    appendTo.append(this.container);\r\n\r\n    this.container.addEventListener('dragover', this.onDragOver);\r\n    this.container.addEventListener('dragleave', this.onDragLeave);\r\n    this.container.addEventListener('drop', this.onDrop);\r\n  }\r\n\r\n  onDragOver = (e: DragEvent) => {\r\n    this.container.classList.add('is-dragover');\r\n    //SetTransition(this.container, 'is-dragover', true, 500);\r\n  };\r\n\r\n  onDragLeave = (e: DragEvent) => {\r\n    this.container.classList.remove('is-dragover');\r\n    //SetTransition(this.container, 'is-dragover', false, 500);\r\n  };\r\n\r\n  onDrop = (e: DragEvent) => {\r\n    this.options.onDrop(e);\r\n  };\r\n\r\n  destroy() {\r\n    delete this.options;\r\n    this.container.remove();\r\n    this.container.removeEventListener('dragover', this.onDragOver);\r\n    this.container.removeEventListener('dragleave', this.onDragLeave);\r\n    this.container.removeEventListener('drop', this.onDrop);\r\n  }\r\n\r\n  setPath() {\r\n    const rect = this.outlineWrapper.getBoundingClientRect();\r\n    this.svg.setAttributeNS(null, 'preserveAspectRatio', 'none');\r\n    this.svg.setAttributeNS(null, 'viewBox', `0 0 ${rect.width} ${rect.height}`);\r\n    this.svg.setAttributeNS(null, 'width', `${rect.width}`);\r\n    this.svg.setAttributeNS(null, 'height', `${rect.height}`);\r\n\r\n    const radius = 10;\r\n    //const strokeWidth = 2;\r\n    const sizeX = rect.width - radius;\r\n    const sizeY = rect.height - radius;\r\n    const pos = radius / 2;\r\n    const d = generatePathData(pos, pos, sizeX, sizeY, radius, radius, radius, radius);\r\n    this.path.setAttributeNS(null, 'd', d);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { doubleRaf } from \"../schedulers\";\r\n\r\nexport default function disableTransition(elements: HTMLElement[]) {\r\n  elements.forEach((el) => el.classList.add('no-transition'));\r\n\r\n  doubleRaf().then(() => {\r\n    elements.forEach((el) => el.classList.remove('no-transition'));\r\n  });\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nexport const MAX_SPEED = 8.2;\r\nexport const MIN_SPEED = 0.8;\r\n\r\n// import { MIN_SPEED, MAX_SPEED } from './BlobDrawable';\r\n\r\ntype Radius = number[];\r\n\r\nexport default class LineBlobDrawable {\r\n  public maxRadius: number;\r\n  public minRadius: number;\r\n  private N: number;\r\n  private radius: Radius;\r\n  private radiusNext: Radius;\r\n  private progress: number[];\r\n  private speed: number[];\r\n  \r\n  constructor(n: number) {\r\n    this.maxRadius = 10;\r\n    this.minRadius = 0;\r\n    \r\n    this.N = n;\r\n    this.radius = new Array(n + 1);\r\n    \r\n    this.radiusNext = new Array(n + 1);\r\n    this.progress = new Array(n + 1);\r\n    this.speed = new Array(n + 1);\r\n    \r\n    for(let i = 0; i <= n; i++) {\r\n      this.generateBlob(this.radius, i);\r\n      this.generateBlob(this.radiusNext, i);\r\n      this.progress[i] = 0;\r\n    }\r\n  }\r\n  \r\n  private generateBlob(radius: Radius, i: number) {\r\n    const {maxRadius, minRadius, speed} = this;\r\n    \r\n    const radDif = maxRadius - minRadius;\r\n    radius[i] = minRadius + Math.random() * radDif;\r\n    speed[i] = 0.017 + 0.003 * Math.random();\r\n  }\r\n  \r\n  private generateNextBlob() {\r\n    const {radius, radiusNext, progress, N} = this;\r\n    for(let i = 0; i < N; i++) {\r\n      this.generateBlob(radius, i);\r\n      this.generateBlob(radiusNext, i);\r\n      progress[i] = 0.0;\r\n    }\r\n  }\r\n  \r\n  public update(amplitude: number, speedScale: number) {\r\n    const {N, progress, speed, radius, radiusNext} = this;\r\n    for(let i = 0; i <= N; i++) {\r\n      progress[i] += (speed[i] * MIN_SPEED) + amplitude * speed[i] * MAX_SPEED * speedScale;\r\n      if(progress[i] >= 1.0) {\r\n        progress[i] = 0.0;\r\n        radius[i] = radiusNext[i];\r\n        this.generateBlob(radiusNext, i);\r\n      }\r\n    }\r\n  }\r\n  \r\n  public draw(left: number, top: number, right: number, bottom: number, canvas: HTMLCanvasElement, paint: (ctx: CanvasRenderingContext2D) => void, pinnedTop: number, progressToPinned: number) {\r\n    if(canvas.getContext) {\r\n      const ctx = canvas.getContext('2d');\r\n      // ctx.globalAlpha = 0.5;\r\n      // ctx.lineWidth = 1;\r\n      \r\n      ctx.beginPath();\r\n      ctx.moveTo(right, bottom);\r\n      ctx.lineTo(left, bottom);\r\n      \r\n      const {radius, radiusNext, N} = this;\r\n      for(let i = 0; i <= N; i++) {\r\n        if(i === 0) {\r\n          const progress = this.progress[i];\r\n          const r1 = radius[i] * (1.0 - progress) + radiusNext[i] * progress;\r\n          const y = (top - r1) * progressToPinned + pinnedTop * (1.0 - progressToPinned);\r\n          ctx.lineTo(left, y);\r\n        } else {\r\n          const progress = this.progress[i - 1];\r\n          const r1 = radius[i - 1] * (1.0 - progress) + radiusNext[i - 1] * progress;\r\n          const progressNext = this.progress[i];\r\n          const r2 = radius[i] * (1.0 - progressNext) + radiusNext[i] * progressNext;\r\n          const x1 = (right - left) / N * (i - 1);\r\n          const x2 = (right - left) / N * i;\r\n          const cx = x1 + (x2 - x1) / 2;\r\n          \r\n          const y1 = (top - r1) * progressToPinned + pinnedTop * (1.0 - progressToPinned);\r\n          const y2 = (top - r2) * progressToPinned + pinnedTop * (1.0 - progressToPinned);\r\n          ctx.bezierCurveTo(cx, y1, cx, y2, x2, y2);\r\n          if(i === N) {\r\n            ctx.lineTo(right, bottom);\r\n          }\r\n        }\r\n      }\r\n      \r\n      // ctx.scale(1.0, 1.0);\r\n      paint(ctx);\r\n      ctx.fill();\r\n      ctx.closePath();\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport GROUP_CALL_STATE from '../lib/calls/groupCallState';\r\nimport LineBlobDrawable from './lineBlobDrawable';\r\n\r\nexport class WeavingState {\r\n  public shader: (ctx: CanvasRenderingContext2D, left: number, top: number, right: number, bottom: number) => void;\r\n  \r\n  constructor(public stateId: GROUP_CALL_STATE) {\r\n    this.createGradient(stateId);\r\n  }\r\n  \r\n  public createGradient(stateId: GROUP_CALL_STATE) {\r\n    this.shader = (ctx, left, top, right, bottom) => {\r\n      ctx.fillStyle = WeavingState.getGradientFromType(ctx, stateId, left, top, right, bottom);\r\n    };\r\n  }\r\n  \r\n  // Android colors\r\n  static getGradientFromType(ctx: CanvasRenderingContext2D, type: GROUP_CALL_STATE, x0: number, y0: number, x1: number, y1: number) {\r\n    const gradient = ctx.createLinearGradient(x0, y0, x1, y1);\r\n    if(type === GROUP_CALL_STATE.MUTED_BY_ADMIN) {\r\n      gradient.addColorStop(0, '#F05459');\r\n      gradient.addColorStop(.4, '#766EE9');\r\n      gradient.addColorStop(1, '#57A4FE');\r\n    } else if(type === GROUP_CALL_STATE.UNMUTED) {\r\n      gradient.addColorStop(0, '#52CE5D');\r\n      gradient.addColorStop(1, '#00B1C0');\r\n    } else if(type === GROUP_CALL_STATE.MUTED) {\r\n      gradient.addColorStop(0, '#0976E3');\r\n      gradient.addColorStop(1, '#2BCEFF');\r\n    } else if(type === GROUP_CALL_STATE.CONNECTING) {\r\n      gradient.addColorStop(0, '#8599aa');\r\n      gradient.addColorStop(1, '#8599aa');\r\n    }\r\n    \r\n    return gradient;\r\n  }\r\n  \r\n  update(height: number, width: number, dt: number, amplitude: number) {\r\n    // TODO: move gradient here\r\n  }\r\n}\r\n\r\nexport default class TopbarWeave {\r\n  private focused: boolean;\r\n  private resizing: boolean;\r\n  private lastUpdateTime: number;\r\n  private amplitude: number;\r\n  private amplitude2: number;\r\n  \r\n  private states: Map<GROUP_CALL_STATE, WeavingState>;\r\n  private previousState: WeavingState;\r\n  private currentState: WeavingState;\r\n  private progressToState: number;\r\n  \r\n  private scale: number;\r\n  private left: number;\r\n  private top: number;\r\n  private right: number;\r\n  private bottom: number;\r\n  \r\n  private mounted: boolean;\r\n  private media: MediaQueryList;\r\n  \r\n  private container: HTMLDivElement;\r\n  private canvas: HTMLCanvasElement;\r\n  \r\n  private resizeHandler: number;\r\n  private raf: number;\r\n\r\n  private lbd: LineBlobDrawable;\r\n  private lbd1: LineBlobDrawable;\r\n  private lbd2: LineBlobDrawable;\r\n\r\n  private animateToAmplitude: number;\r\n  private animateAmplitudeDiff: number;\r\n  private animateAmplitudeDiff2: number;\r\n  \r\n  constructor() {\r\n    this.focused = true;\r\n    this.resizing = false;\r\n    this.lastUpdateTime = Date.now();\r\n    this.amplitude = 0.0;\r\n    this.amplitude2 = 0.0;\r\n    \r\n    this.states = new Map([\r\n      [GROUP_CALL_STATE.UNMUTED, new WeavingState(GROUP_CALL_STATE.UNMUTED)],\r\n      [GROUP_CALL_STATE.MUTED, new WeavingState(GROUP_CALL_STATE.MUTED)],\r\n      [GROUP_CALL_STATE.MUTED_BY_ADMIN, new WeavingState(GROUP_CALL_STATE.MUTED_BY_ADMIN)],\r\n      [GROUP_CALL_STATE.CONNECTING, new WeavingState(GROUP_CALL_STATE.CONNECTING)],\r\n    ]);\r\n    this.previousState = null;\r\n    this.currentState = this.states.get(GROUP_CALL_STATE.CONNECTING);\r\n    this.progressToState = 1.0;\r\n  }\r\n  \r\n  public componentDidMount() {\r\n    if(this.mounted) {\r\n      return;\r\n    }\r\n\r\n    this.mounted = true;\r\n    // window.addEventListener('blur', this.handleBlur);\r\n    // window.addEventListener('focus', this.handleFocus);\r\n    window.addEventListener('resize', this.handleResize);\r\n    this.media = window.matchMedia('screen and (min-resolution: 2dppx)');\r\n    this.media.addEventListener('change', this.handleDevicePixelRatioChanged);\r\n    \r\n    this.setSize();\r\n    this.forceUpdate();\r\n    \r\n    this.lbd = new LineBlobDrawable(3);\r\n    this.lbd1 = new LineBlobDrawable(7);\r\n    this.lbd2 = new LineBlobDrawable(8);\r\n    this.setAmplitude(this.amplitude);\r\n    \r\n    this.draw();\r\n  }\r\n  \r\n  public componentWillUnmount() {\r\n    this.mounted = false;\r\n    // window.removeEventListener('blur', this.handleBlur);\r\n    // window.removeEventListener('focus', this.handleFocus);\r\n    window.removeEventListener('resize', this.handleResize);\r\n    this.media.addEventListener('change', this.handleDevicePixelRatioChanged);\r\n\r\n    const {canvas} = this;\r\n    const ctx = canvas.getContext('2d');\r\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n  }\r\n\r\n  private setSize() {\r\n    this.scale = window.devicePixelRatio;\r\n    this.top = 20 * this.scale;\r\n    this.right = (this.mounted ? this.container.offsetWidth : 1261) * this.scale;\r\n    this.bottom = (this.mounted ? this.container.offsetHeight : 68) * this.scale;\r\n    this.left = 0 * this.scale;\r\n    this.setCanvasSize();\r\n  }\r\n\r\n  private setCanvasSize() {\r\n    this.canvas.width = this.right;\r\n    this.canvas.height = this.bottom;\r\n  }\r\n  \r\n  private handleDevicePixelRatioChanged = (e: Event) => {\r\n    this.setSize();\r\n    this.forceUpdate();\r\n  }\r\n  \r\n  private handleResize = () => {\r\n    if(this.resizeHandler) {\r\n      clearTimeout(this.resizeHandler);\r\n      this.resizeHandler = null;\r\n    }\r\n    \r\n    this.resizing = true;\r\n    this.resizeCanvas();\r\n    this.resizeHandler = window.setTimeout(() => {\r\n      this.resizing = false;\r\n      this.invokeDraw();\r\n    }, 250);\r\n  }\r\n  \r\n  private resizeCanvas() {\r\n    this.scale = window.devicePixelRatio;\r\n    this.right = this.container.offsetWidth * this.scale;\r\n    \r\n    this.forceUpdate();\r\n    this.invokeDraw();\r\n  }\r\n  \r\n  public handleFocus = () => {\r\n    this.focused = true;\r\n    this.invokeDraw();\r\n  }\r\n  \r\n  public handleBlur = () => {\r\n    this.focused = false;\r\n  }\r\n  \r\n  private invokeDraw = () => {\r\n    if(this.raf) return;\r\n    \r\n    this.draw();\r\n  }\r\n  \r\n  private draw = (force = false) => {\r\n    this.raf = null;\r\n    if(!this.mounted) {\r\n      return;\r\n    }\r\n    const {lbd, lbd1, lbd2, scale, left, top, right, bottom, currentState, previousState, focused, resizing, canvas} = this;\r\n    if(!focused && !resizing && this.progressToState >= 1.0) {\r\n      return;\r\n    }\r\n    \r\n    // console.log('[top] draw', [focused, resizing, this.mounted]);\r\n    \r\n    const newTime = Date.now();\r\n    let dt = (newTime - this.lastUpdateTime);\r\n    if(dt > 20) {\r\n      dt = 17;\r\n    }\r\n    \r\n    // console.log('draw start', this.amplitude, this.animateToAmplitude);\r\n    if(this.animateToAmplitude !== this.amplitude) {\r\n      this.amplitude += this.animateAmplitudeDiff * dt;\r\n      if(this.animateAmplitudeDiff > 0) {\r\n        if(this.amplitude > this.animateToAmplitude) {\r\n          this.amplitude = this.animateToAmplitude;\r\n        }\r\n      } else {\r\n        if(this.amplitude < this.animateToAmplitude) {\r\n          this.amplitude = this.animateToAmplitude;\r\n        }\r\n      }\r\n    }\r\n    \r\n    if(this.animateToAmplitude !== this.amplitude2) {\r\n      this.amplitude2 += this.animateAmplitudeDiff2 * dt;\r\n      if(this.animateAmplitudeDiff2 > 0) {\r\n        if(this.amplitude2 > this.animateToAmplitude) {\r\n          this.amplitude2 = this.animateToAmplitude;\r\n        }\r\n      } else {\r\n        if(this.amplitude2 < this.animateToAmplitude) {\r\n          this.amplitude2 = this.animateToAmplitude;\r\n        }\r\n      }\r\n    }\r\n    \r\n    if(previousState) {\r\n      this.progressToState += dt / 250;\r\n      if(this.progressToState > 1) {\r\n        this.progressToState = 1;\r\n        this.previousState = null;\r\n      }\r\n    }\r\n\r\n    const {amplitude, amplitude2, progressToState} = this;\r\n    \r\n    const top1 = 6 * amplitude2 * scale;\r\n    const top2 = 6 * amplitude2 * scale;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n    \r\n    lbd.minRadius = 0;\r\n    lbd.maxRadius = (2 + 2 * amplitude) * scale;\r\n    lbd1.minRadius = 0;\r\n    lbd1.maxRadius = (3 + 9 * amplitude) * scale;\r\n    lbd2.minRadius = 0;\r\n    lbd2.maxRadius = (3 + 9 * amplitude) * scale;\r\n    \r\n    lbd.update(amplitude, 0.3);\r\n    lbd1.update(amplitude, 0.7);\r\n    lbd2.update(amplitude, 0.7);\r\n    \r\n    for(let i = 0; i < 2; i++) {\r\n      if(i === 0 && !previousState) {\r\n        continue;\r\n      }\r\n      \r\n      let alpha = 1;\r\n      let state: WeavingState = null;\r\n      if(i === 0) {\r\n        alpha = 1 - progressToState;\r\n        state = previousState;\r\n        // previousState.setToPaint(paint);\r\n      } else {\r\n        alpha = previousState ? progressToState : 1;\r\n        currentState.update(bottom - top, right - left, dt, amplitude);\r\n        state = currentState;\r\n        // currentState.setToPaint(paint);\r\n      }\r\n      \r\n      const paint1 = (ctx: CanvasRenderingContext2D) => {\r\n        ctx.globalAlpha = 0.3 * alpha;\r\n        state.shader(ctx, left, top, right, bottom);\r\n      };\r\n      const paint = (ctx: CanvasRenderingContext2D) => {\r\n        ctx.globalAlpha = i === 0 ? 1 : alpha;\r\n        state.shader(ctx, left, top, right, bottom);\r\n      };\r\n      \r\n      lbd1.draw(left, top - top1, right, bottom, canvas, paint1, top, 1.0);\r\n      lbd2.draw(left, top - top2, right, bottom, canvas, paint1, top, 1.0);\r\n      lbd.draw(left, top, right, bottom, canvas, paint, top, 1.0);\r\n    }\r\n    \r\n    if(!force) {\r\n      this.raf = requestAnimationFrame(() => this.draw());\r\n    }\r\n  };\r\n  \r\n  public setCurrentState = (stateId: GROUP_CALL_STATE, animated: boolean) => {\r\n    const {currentState, states} = this;\r\n    \r\n    if(currentState?.stateId === stateId) {\r\n      return;\r\n    }\r\n    \r\n    this.previousState = animated ? currentState : null;\r\n    this.currentState = states.get(stateId);\r\n    this.progressToState = this.previousState ? 0.0 : 1.0;\r\n  };\r\n  \r\n  public setAmplitude(value: number) {\r\n    const {amplitude} = this;\r\n    this.animateToAmplitude = value;\r\n    this.animateAmplitudeDiff = (value - amplitude) / 250;\r\n    this.animateAmplitudeDiff2 = (value - amplitude) / 120;\r\n  }\r\n\r\n  private forceUpdate() {\r\n    this.setCanvasSize();\r\n  }\r\n  \r\n  public render(className: string) {\r\n    const container = this.container = document.createElement('div');\r\n    container.classList.add(className);\r\n\r\n    const canvas = this.canvas = document.createElement('canvas');\r\n    canvas.classList.add(className + '-canvas');\r\n\r\n    container.append(canvas);\r\n\r\n    return container;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../../lib/rootScope\";\r\n\r\nexport type CustomProperty = string;\r\n\r\nexport class CustomProperties {\r\n  private cache: {[k in CustomProperty]?: string};\r\n  private computedStyle: CSSStyleDeclaration;\r\n\r\n  constructor() {\r\n    this.cache = {};\r\n\r\n    rootScope.addEventListener('theme_change', () => {\r\n      this.computedStyle = undefined;\r\n      const cache = this.cache;\r\n      this.cache = {};\r\n\r\n      for(let i in cache) {\r\n        this.getProperty(i);\r\n      }\r\n    });\r\n  }\r\n\r\n  public getProperty(name: CustomProperty) {\r\n    let value = this.cache[name];\r\n    if(value) {\r\n      return value;\r\n    }\r\n\r\n    if(!this.computedStyle) {\r\n      this.computedStyle = window.getComputedStyle(document.documentElement);\r\n    }\r\n\r\n    value = this.computedStyle.getPropertyValue('--' + name).trim();\r\n    return this.cache[name] = value;\r\n  }\r\n}\r\n\r\nconst customProperties = new CustomProperties();\r\nexport default customProperties;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport noop from \"../../helpers/noop\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport rootScope from \"../rootScope\";\r\nimport lottieLoader, { LottieAssetName } from \"./lottieLoader\";\r\nimport type RLottiePlayer from \"./rlottiePlayer\";\r\nimport { RLottieColor } from \"./rlottiePlayer\";\r\n\r\nexport type RLottieIconOptions = {\r\n  width: number,\r\n  height: number,\r\n  container?: HTMLElement,\r\n  skipAnimation?: boolean\r\n};\r\n\r\nexport type RLottieIconItemPartOptions = {\r\n  startFrame: number,\r\n  endFrame: number,\r\n  name?: string\r\n};\r\n\r\nexport type RLottieIconItemOptions = {\r\n  name: LottieAssetName,\r\n  parts: RLottieIconItemPartOptions[],\r\n  initFrame?: number,\r\n  player?: RLottiePlayer,\r\n  autoplay?: boolean,\r\n  color?: RLottieColor,\r\n  inverseColor?: RLottieColor,\r\n};\r\n\r\nexport class RLottieIconItemPart implements RLottieIconItemPartOptions {\r\n  public startFrame: number;\r\n  public endFrame: number;\r\n  public name?: string;\r\n  \r\n  constructor(public item: RLottieIconItem, options: RLottieIconItemPartOptions) {\r\n    safeAssign(this, options);\r\n  }\r\n\r\n  public play(callback?: () => void) {\r\n    return this.item.playPart(this, callback);\r\n  }\r\n}\r\n\r\n// export type RLottieIconItemPart = RLottieIconItemPartOptions;\r\n\r\nexport class RLottieIconItem implements RLottieIconItemOptions {\r\n  public name: LottieAssetName;\r\n  public parts: RLottieIconItemPart[];\r\n  public player: RLottiePlayer;\r\n  public initFrame: number;\r\n  public autoplay: boolean;\r\n  public color: RLottieColor;\r\n  public inverseColor: RLottieColor;\r\n  public loadPromise: Promise<void>;\r\n  public onLoadForPart: () => void;\r\n  public onLoadForColor: () => void;\r\n\r\n  constructor(public icon: RLottieIcon, options: RLottieIconItemOptions) {\r\n    this.autoplay = false;\r\n\r\n    safeAssign(this, options);\r\n\r\n    this.parts = this.parts.map((options) => this.createPart(options));\r\n  }\r\n\r\n  public load() {\r\n    let loadPromise = this.loadPromise;\r\n    if(loadPromise) {\r\n      return loadPromise;\r\n    }\r\n\r\n    const {container, canvas, width, height} = this.icon;\r\n    loadPromise = lottieLoader.loadAnimationAsAsset({\r\n      container,\r\n      canvas,\r\n      width,\r\n      height,\r\n      group: 'none',\r\n      loop: false,\r\n      autoplay: this.autoplay ?? false,\r\n      initFrame: this.initFrame,\r\n      skipFirstFrameRendering: this.initFrame === undefined,\r\n      color: this.color,\r\n      inverseColor: this.inverseColor\r\n    }, this.name).then((player) => {\r\n      return lottieLoader.waitForFirstFrame(player);\r\n    }).then((player) => {\r\n      this.player = player;\r\n\r\n      if(this.onLoadForColor) {\r\n        this.onLoadForColor();\r\n        this.onLoadForColor = undefined;\r\n      }\r\n\r\n      if(this.onLoadForPart) {\r\n        this.onLoadForPart();\r\n        this.onLoadForPart = undefined;\r\n      }\r\n    });\r\n\r\n    this.loadPromise = loadPromise;\r\n    this.icon.loadPromises.set(this.name, loadPromise);\r\n    return loadPromise;\r\n  }\r\n\r\n  public createPart(options: RLottieIconItemPartOptions) {\r\n    return new RLottieIconItemPart(this, options);\r\n  }\r\n\r\n  public getPart(index: string | number | RLottieIconItemPart) {\r\n    if(index instanceof RLottieIconItemPart) return index;\r\n    else if(typeof(index) === 'string') return this.parts.find((part) => part.name === index);\r\n    else return this.parts[index];\r\n  }\r\n\r\n  public playPart(part: RLottieIconItemPart, callback?: () => void) {\r\n    return this.icon.playPart(this, part, callback);\r\n  }\r\n}\r\n\r\nexport default class RLottieIcon {\r\n  public container: HTMLElement;\r\n  public canvas: HTMLCanvasElement;\r\n  public width: number;\r\n  public height: number;\r\n\r\n  protected items: Map<LottieAssetName, RLottieIconItem>;\r\n  public loadPromises: Map<LottieAssetName, Promise<void>>;\r\n\r\n  protected skipAnimation: boolean;\r\n\r\n  constructor(options: RLottieIconOptions) {\r\n    safeAssign(this, options);\r\n\r\n    if(!this.container) this.container = document.createElement('div');\r\n    this.container.classList.add('rlottie-icon');\r\n\r\n    const {width, height} = this;\r\n    this.container.style.width = width + 'px';\r\n    this.container.style.height = height + 'px';\r\n\r\n    const canvas = this.canvas = document.createElement('canvas');\r\n    canvas.classList.add('rlottie');\r\n    canvas.width = width;\r\n    canvas.height = height;\r\n\r\n    this.items = new Map();\r\n    this.loadPromises = new Map();\r\n  }\r\n\r\n  public get loadPromise() {\r\n    return Promise.all([...this.loadPromises.values()]).then(noop);\r\n  }\r\n\r\n  public getItem(name?: LottieAssetName): RLottieIconItem {\r\n    return !name && this.items.size === 1 ? this.items.values().next().value : this.items.get(name);\r\n  }\r\n\r\n  public add(options: Omit<RLottieIconItemOptions, 'player'>) {\r\n    const item = new RLottieIconItem(this, options);\r\n    this.items.set(options.name, item);\r\n\r\n    return item;\r\n  }\r\n\r\n  public playPart(item: RLottieIconItem, index: Parameters<RLottieIconItem['getPart']>[0], callback?: () => void) {\r\n    if(!item.player) {\r\n      item.onLoadForPart = () => {\r\n        this.playPart(item, index, callback);\r\n      };\r\n\r\n      return;\r\n    }\r\n    \r\n    const part = item.getPart(index);\r\n    item.player.playPart({\r\n      from: rootScope.settings.animationsEnabled && !this.skipAnimation ? part.startFrame : part.endFrame, \r\n      to: part.endFrame,\r\n      callback\r\n    });\r\n  }\r\n\r\n  /* public playToPart(item: RLottieIconItem, index: Parameters<RLottieIconItem['getPart']>[0], toEnd: boolean) {\r\n    if(!item.player) return;\r\n    const part = item.getPart(index);\r\n    const toFrame = toEnd ? part.endFrame : part.startFrame;\r\n    item.player.playToFrame({\r\n      frame: toFrame\r\n    });\r\n  } */\r\n  \r\n  public static generateEqualParts(length: number, frameCount: number): RLottieIconItemPartOptions[] {\r\n    return new Array(length).fill(0).map((_, idx) => {\r\n      const startFrame = idx * frameCount;\r\n      return {startFrame, endFrame: startFrame + frameCount - 1};\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport noop from \"../helpers/noop\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport { LottieAssetName } from \"../lib/rlottie/lottieLoader\";\r\nimport RLottieIcon, { RLottieIconItemPartOptions, RLottieIconItemPart } from \"../lib/rlottie/rlottieIcon\";\r\nimport { RLottieColor } from \"../lib/rlottie/rlottiePlayer\";\r\n\r\nexport type SuperRLottieIconAddItemOptions = {name: LottieAssetName, parts: RLottieIconItemPartOptions};\r\nexport type SuperRLottieIconGetInfoResult = RLottieIconItemPart;\r\nexport class SuperRLottieIcon<Options extends {\r\n  PartState: any,\r\n  ColorState?: any,\r\n  Items?: {\r\n    name: string\r\n  }[]\r\n}> extends RLottieIcon {\r\n  protected getPart: (state: Options['PartState'], prevState?: Options['PartState']) => SuperRLottieIconGetInfoResult;\r\n  protected getColor?: (state: Options['ColorState'], prevState?: Options['ColorState']) => RLottieColor;\r\n\r\n  protected partState: Options['PartState'];\r\n  protected colorState: Options['ColorState'];\r\n  protected loaded: boolean;\r\n\r\n  constructor(options: {\r\n    width: number,\r\n    height: number,\r\n    skipAnimation?: boolean,\r\n    getPart: (state: Options['PartState'], prevState?: Options['PartState']) => SuperRLottieIconGetInfoResult,\r\n    getColor?: (state: Options['ColorState'], prevState?: Options['ColorState']) => RLottieColor,\r\n  }) {\r\n    super({\r\n      width: options.width,\r\n      height: options.height\r\n    });\r\n\r\n    safeAssign(this, options);\r\n\r\n    // hook the first call\r\n    /* const originalFunction = this.setState.bind(this);\r\n    this.setState = (partState, colorState) => {\r\n      this.setState = originalFunction;\r\n      this.load(partState, colorState);\r\n      return originalFunction(partState, colorState);\r\n    }; */\r\n  }\r\n\r\n  public load(partState: Options['PartState'], colorState?: Options['ColorState']) {\r\n    if(this.loaded) {\r\n      return this.loadPromise;\r\n    }\r\n\r\n    this.loaded = true;\r\n    this.partState = partState;\r\n    this.colorState = colorState;\r\n\r\n    const part = this.getPart(partState);\r\n    const color = colorState !== undefined && this.getColor && this.getColor(colorState);\r\n\r\n    const item = part.item;\r\n    item.initFrame = part.endFrame;\r\n    item.color = color;\r\n\r\n    const promises = [...this.items.values()].map((item) => item.load());\r\n    return Promise.all(promises).then(noop);\r\n  }\r\n\r\n  /**\r\n   * Will redirect setting color state to part callback to synchronize the rendering\r\n   */\r\n  public setState(partState: Options['PartState'], colorState?: Options['ColorState'], partCallback?: () => void) {\r\n    if(!this.loaded) this.load(partState, colorState);\r\n\r\n    let changedPartState = false, changedColorState = false;\r\n    if(partState !== undefined) changedPartState = this.setPartState(partState, colorState, partCallback);\r\n    else if(colorState !== undefined) changedColorState = this.setColorState(colorState);\r\n\r\n    return changedPartState || changedColorState;\r\n  }\r\n\r\n  public setPartState(state: Options['PartState'], colorState?: Options['ColorState'], callback?: () => void) {\r\n    const {partState: prevState} = this;\r\n    if(prevState === state) {\r\n      return colorState !== undefined ? this.setColorState(colorState) : false;\r\n    }\r\n\r\n    if(colorState !== undefined) {\r\n      this.setColorState(colorState, false);\r\n    }\r\n\r\n    this.partState = state;\r\n\r\n    const part = this.getPart(state, prevState);\r\n    part.play(callback);\r\n\r\n    return true;\r\n  }\r\n\r\n  public setColorState(state: Options['ColorState'], renderIfPaused = true) {\r\n    const {colorState: prevState} = this;\r\n    if(prevState === state || !this.getColor) {\r\n      return false;\r\n    }\r\n\r\n    this.colorState = state;\r\n    \r\n    const item = this.getItem();\r\n    const color = this.getColor(state, prevState);\r\n    const invoke = () => {\r\n      item.player.setColor(color, renderIfPaused);\r\n    };\r\n    \r\n    if(item.player) {\r\n      invoke();\r\n    } else {\r\n      item.onLoadForColor = invoke;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public destroy() {\r\n    this.items.forEach((item) => {\r\n      item.loadPromise.then(() => {\r\n        item.player.remove();\r\n      });\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { RLottieIconItemPartOptions } from \"../../lib/rlottie/rlottieIcon\";\r\nimport { GROUP_CALL_MICROPHONE_BUTTON_STATE } from \".\";\r\nimport { SuperRLottieIcon } from \"../superIcon\";\r\n\r\nexport default class GroupCallMicrophoneIcon extends SuperRLottieIcon<{\r\n  PartState: GROUP_CALL_MICROPHONE_BUTTON_STATE\r\n}> {\r\n  constructor() {\r\n    super({\r\n      width: 36,\r\n      height: 36,\r\n      getPart: (state, prevState) => {\r\n        const states = GROUP_CALL_MICROPHONE_BUTTON_STATE;\r\n        let partName: string;\r\n        switch(state) {\r\n          case states.HAND:\r\n            partName = prevState === states.MUTED ? 'muted-to-hand' : 'unmuted-to-hand';\r\n            break;\r\n          case states.MUTED:\r\n            partName = prevState === states.HAND ? 'hand-to-muted' : 'mute';\r\n            break;\r\n          case states.UNMUTED:\r\n            partName = 'unmute';\r\n            break;\r\n        }\r\n\r\n        return this.getItem().getPart(partName);\r\n      }\r\n    });\r\n\r\n    const className = 'group-call-microphone-icon';\r\n    this.container.classList.add(className + '-container');\r\n\r\n    const parts: RLottieIconItemPartOptions[] = [{\r\n      startFrame: 0,\r\n      endFrame: 35,\r\n      name: 'hand-to-muted'\r\n    }, {\r\n      startFrame: 36,\r\n      endFrame: 68,\r\n      name: 'unmute'\r\n    }, {\r\n      startFrame: 69,\r\n      endFrame: 98,\r\n      name: 'mute'\r\n    }, {\r\n      startFrame: 99,\r\n      endFrame: 135,\r\n      name: 'muted-to-hand'\r\n    }, {\r\n      startFrame: 136,\r\n      endFrame: 172,\r\n      name: 'unmuted-to-hand'\r\n    }, {\r\n      startFrame: 173,\r\n      endFrame: 201,\r\n      name: 'scheduled-crossing'\r\n    }, {\r\n      startFrame: 202,\r\n      endFrame: 236,\r\n      name: 'scheduled-to-muted'\r\n    }, {\r\n      startFrame: 237,\r\n      endFrame: 273,\r\n      name: 'scheduled-to-hand'\r\n    }, {\r\n      startFrame: 274,\r\n      endFrame: 310,\r\n      name: 'scheduled-crossed-to-hand'\r\n    }, {\r\n      startFrame: 311,\r\n      endFrame: 343,\r\n      name: 'scheduled-uncrossing'\r\n    }, {\r\n      startFrame: 344,\r\n      endFrame: 375,\r\n      name: 'scheduled-to-muted'\r\n    }, {\r\n      startFrame: 376,\r\n      endFrame: 403,\r\n      name: 'play-to-muted'\r\n    }];\r\n\r\n    this.add({\r\n      name: 'voip_filled',\r\n      parts\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport RLottieIcon from \"../../lib/rlottie/rlottieIcon\";\r\nimport { GROUP_CALL_PARTICIPANT_CLEARED_MUTED_STATE, GROUP_CALL_PARTICIPANT_MUTED_STATE, getColorByMutedState, clearMutedStateModifier } from \".\";\r\nimport { SuperRLottieIcon } from \"../superIcon\";\r\n\r\nexport default class GroupCallParticipantMutedIcon extends SuperRLottieIcon<{\r\n  PartState: GROUP_CALL_PARTICIPANT_CLEARED_MUTED_STATE, \r\n  ColorState: GROUP_CALL_PARTICIPANT_MUTED_STATE\r\n}> {\r\n  constructor(private colored: boolean) {\r\n    super({\r\n      width: 32,\r\n      height: 32,\r\n      getPart: (state, prevState) => {\r\n        const states = GROUP_CALL_PARTICIPANT_MUTED_STATE;\r\n\r\n        let index: number;\r\n        switch(state) {\r\n          case states.HAND:\r\n            index = 3;\r\n            break;\r\n          case states.MUTED:\r\n            index = prevState === states.HAND ? 0 : 2;\r\n            break;\r\n          case states.UNMUTED:\r\n            index = 1;\r\n            break;\r\n        }\r\n\r\n        return this.getItem().getPart(index);\r\n      },\r\n      getColor: colored ? (state, prevState) => {\r\n        return getColorByMutedState(state);\r\n      } : undefined\r\n    });\r\n\r\n    const className = 'group-call-participant-muted-icon';\r\n    this.container.classList.add(className + '-container');\r\n\r\n    const parts = RLottieIcon.generateEqualParts(4, 21);\r\n    this.add({\r\n      name: 'voice_outlined2',\r\n      parts\r\n    });\r\n  }\r\n\r\n  public setState(state: GROUP_CALL_PARTICIPANT_MUTED_STATE) {\r\n    return super.setState(clearMutedStateModifier(state), state);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupElement from \"../popups\";\r\nimport { hexToRgb } from \"../../helpers/color\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport customProperties from \"../../helpers/dom/customProperties\";\r\nimport { GroupCall, GroupCallParticipant } from \"../../layer\";\r\nimport type { AppChatsManager } from \"../../lib/appManagers/appChatsManager\";\r\nimport type { AppGroupCallsManager } from \"../../lib/appManagers/appGroupCallsManager\";\r\nimport type { AppPeersManager } from \"../../lib/appManagers/appPeersManager\";\r\nimport GROUP_CALL_STATE from \"../../lib/calls/groupCallState\";\r\nimport { RLottieColor } from \"../../lib/rlottie/rlottiePlayer\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport GroupCallMicrophoneIcon from \"./microphoneIcon\";\r\nimport GroupCallParticipantsElement from \"./participants\";\r\nimport GroupCallParticipantsVideoElement from \"./participantVideos\";\r\nimport PopupPeer from \"../popups/peer\";\r\nimport GroupCallDescriptionElement from \"./description\";\r\nimport GroupCallTitleElement from \"./title\";\r\nimport { addFullScreenListener, cancelFullScreen, isFullScreen, requestFullScreen } from \"../../helpers/dom/fullScreen\";\r\nimport Scrollable from \"../scrollable\";\r\nimport { MovableState } from \"../movableElement\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport { IS_APPLE_MOBILE } from \"../../environment/userAgent\";\r\nimport throttle from \"../../helpers/schedulers/throttle\";\r\nimport IS_SCREEN_SHARING_SUPPORTED from \"../../environment/screenSharingSupport\";\r\nimport GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport makeButton from \"../call/button\";\r\nimport MovablePanel from \"../../helpers/movablePanel\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport toggleClassName from \"../../helpers/toggleClassName\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport themeController from \"../../helpers/themeController\";\r\nimport groupCallsController from \"../../lib/calls/groupCallsController\";\r\n\r\nexport enum GROUP_CALL_PARTICIPANT_MUTED_STATE {\r\n  UNMUTED,\r\n  MUTED,\r\n  MUTED_FOR_ME,\r\n  MUTED_BY_ADMIN,\r\n  HAND\r\n}\r\n\r\nexport type GROUP_CALL_PARTICIPANT_CLEARED_MUTED_STATE = Exclude<GROUP_CALL_PARTICIPANT_MUTED_STATE, GROUP_CALL_PARTICIPANT_MUTED_STATE.MUTED_BY_ADMIN | GROUP_CALL_PARTICIPANT_MUTED_STATE.MUTED_FOR_ME>;\r\n\r\nexport function getGroupCallParticipantMutedState(participant: GroupCallParticipant) {\r\n  const states = GROUP_CALL_PARTICIPANT_MUTED_STATE;\r\n  if(participant.pFlags.muted_by_you) {\r\n    return states.MUTED_FOR_ME;\r\n  } else if(participant.raise_hand_rating !== undefined) {\r\n    return states.HAND;\r\n  } else if(participant.pFlags.muted) {\r\n    return participant.pFlags.can_self_unmute ? states.MUTED : states.MUTED_BY_ADMIN;\r\n  } else {\r\n    return states.UNMUTED;\r\n  }\r\n}\r\n\r\nexport function clearMutedStateModifier(state: GROUP_CALL_PARTICIPANT_MUTED_STATE): GROUP_CALL_PARTICIPANT_CLEARED_MUTED_STATE {\r\n  const states = GROUP_CALL_PARTICIPANT_MUTED_STATE;\r\n  switch(state) {\r\n    case states.MUTED_BY_ADMIN:\r\n    case states.MUTED_FOR_ME:\r\n      return states.MUTED;\r\n    default:\r\n      return state;\r\n  }\r\n}\r\n\r\nexport function getColorByMutedState(state: GROUP_CALL_PARTICIPANT_MUTED_STATE) {\r\n  const states = GROUP_CALL_PARTICIPANT_MUTED_STATE;\r\n  let color: RLottieColor, colorStr: 'blue' | 'green' | 'secondary' | 'red';\r\n  switch(state) {\r\n    case states.HAND:\r\n      colorStr = 'blue';\r\n      break;\r\n    case states.MUTED:\r\n    case states.MUTED_FOR_ME:\r\n    case states.MUTED_BY_ADMIN:\r\n      colorStr = state === states.MUTED ? 'secondary' : 'red';\r\n      break;\r\n    case states.UNMUTED:\r\n      colorStr = 'green';\r\n      break;\r\n  }\r\n\r\n  const propertyValue = customProperties.getProperty('gc-' + colorStr + '-text-color');\r\n  color = hexToRgb(propertyValue);\r\n\r\n  return color;\r\n}\r\n\r\nexport enum GROUP_CALL_MICROPHONE_BUTTON_STATE {\r\n  HAND,\r\n  MUTED,\r\n  UNMUTED,\r\n}\r\n\r\nexport function getGroupCallMicrophoneButtonState(groupCall: GroupCall.groupCall, participant: GroupCallParticipant) {\r\n  const states = GROUP_CALL_MICROPHONE_BUTTON_STATE;\r\n  if(!participant.pFlags.can_self_unmute) {\r\n    return states.HAND;\r\n  } else if(participant.pFlags.muted) {\r\n    return states.MUTED\r\n  } else {\r\n    return states.UNMUTED;\r\n  }\r\n}\r\n\r\nlet previousState: MovableState = {\r\n  width: 420,\r\n  height: 640\r\n};\r\n\r\nconst className = 'group-call';\r\n\r\nexport default class PopupGroupCall extends PopupElement {\r\n  private instance: GroupCallInstance;\r\n  private groupCallTitle: GroupCallTitleElement;\r\n  private groupCallDescription: GroupCallDescriptionElement;\r\n  private groupCallBodyHeaderDescription: GroupCallDescriptionElement;\r\n  private groupCallParticipants: GroupCallParticipantsElement;\r\n  private groupCallParticipantsVideo: GroupCallParticipantsVideoElement;\r\n  private groupCallMicrophoneIcon: GroupCallMicrophoneIcon;\r\n  private videosCount: number;\r\n  private btnFullScreen: HTMLButtonElement;\r\n  private btnExitFullScreen: HTMLButtonElement;\r\n  private btnInvite: HTMLButtonElement;\r\n  private btnShowColumn: HTMLButtonElement;\r\n  private movablePanel: MovablePanel;\r\n  private buttonsContainer: HTMLDivElement;\r\n  private btnFullScreen2: HTMLButtonElement;\r\n  private btnVideo: HTMLDivElement;\r\n  private btnScreen: HTMLDivElement;\r\n\r\n  constructor() {\r\n    super('popup-group-call', {\r\n      body: true,\r\n      withoutOverlay: true,\r\n      closable: true,\r\n      title: true\r\n    });\r\n\r\n    this.videosCount = 0;\r\n    this.container.classList.add(className, 'night');\r\n\r\n    const instance = this.instance = groupCallsController.groupCall;\r\n    const {listenerSetter} = this;\r\n\r\n    if(!IS_APPLE_MOBILE) {\r\n      const btnFullScreen = this.btnFullScreen = ButtonIcon('fullscreen');\r\n      const btnFullScreen2 = this.btnFullScreen2 = ButtonIcon('fullscreen ' + className + '-cfs');\r\n      const btnExitFullScreen = this.btnExitFullScreen = ButtonIcon('smallscreen');\r\n  \r\n      attachClickEvent(btnFullScreen, this.onFullScreenClick, {listenerSetter});\r\n      attachClickEvent(btnFullScreen2, this.onFullScreenClick, {listenerSetter});\r\n  \r\n      attachClickEvent(btnExitFullScreen, () => {\r\n        cancelFullScreen();\r\n      }, {listenerSetter});\r\n  \r\n      addFullScreenListener(this.container, this.onFullScreenChange, listenerSetter);\r\n    }\r\n\r\n    const btnInvite = this.btnInvite = ButtonIcon('adduser');\r\n    const btnShowColumn = this.btnShowColumn = ButtonIcon('rightpanel ' + className + '-only-big');\r\n\r\n    attachClickEvent(btnShowColumn, this.toggleRightColumn, {listenerSetter});\r\n\r\n    const headerInfo = document.createElement('div');\r\n    headerInfo.classList.add(className + '-header-info');\r\n\r\n    this.title.classList.add(className + '-header-title');\r\n\r\n    const subtitle = document.createElement('div');\r\n    subtitle.classList.add(className + '-header-subtitle');\r\n\r\n    headerInfo.append(this.title, subtitle);\r\n\r\n    this.header.classList.add(className + '-header');\r\n    this.header.append(...[this.btnExitFullScreen, headerInfo/* , btnInvite */, this.btnFullScreen, btnShowColumn].filter(Boolean));\r\n\r\n    const newHeader = this.header.cloneNode(false) as HTMLElement;\r\n    const newHeaderInfo = headerInfo.cloneNode(false) as HTMLElement;\r\n    const newHeaderTitle = this.title.cloneNode(false) as HTMLElement;\r\n\r\n    newHeaderInfo.append(newHeaderTitle);\r\n\r\n    const btnHideColumn = ButtonIcon('rightpanel');\r\n    newHeader.append(...[btnHideColumn, newHeaderInfo, this.btnFullScreen2].filter(Boolean));\r\n\r\n    attachClickEvent(btnHideColumn, this.toggleRightColumn, {listenerSetter});\r\n\r\n    this.body.prepend(newHeader);\r\n\r\n    const videosScrollable = new Scrollable(undefined);\r\n    videosScrollable.container.classList.add('group-call-big-video-container');\r\n    this.container.append(videosScrollable.container);\r\n\r\n    this.groupCallTitle = new GroupCallTitleElement(this.title);\r\n    this.groupCallDescription = new GroupCallDescriptionElement(subtitle);\r\n    this.groupCallBodyHeaderDescription = new GroupCallDescriptionElement(newHeaderTitle);\r\n    this.constructButtons();\r\n\r\n    this.groupCallParticipantsVideo = new GroupCallParticipantsVideoElement({\r\n      appendTo: videosScrollable.container,\r\n      instance,\r\n      listenerSetter,\r\n      displayPinned: true,\r\n      onLengthChange: (length) => {\r\n        this.videosCount = length;\r\n        this.toggleBigLayout();\r\n      },\r\n      managers: this.managers\r\n    });\r\n    this.groupCallParticipants = new GroupCallParticipantsElement({\r\n      appendTo: this.body,\r\n      instance,\r\n      listenerSetter,\r\n      managers: this.managers\r\n    });\r\n\r\n    this.movablePanel = new MovablePanel({\r\n      listenerSetter,\r\n      movableOptions: {\r\n        minWidth: 400,\r\n        minHeight: 480,\r\n        element: this.element,\r\n        verifyTouchTarget: (e) => {\r\n          const target = e.target;\r\n          if(findUpClassName(target, 'chatlist') || \r\n            findUpClassName(target, 'group-call-button') || \r\n            findUpClassName(target, 'btn-icon') ||\r\n            findUpClassName(target, 'group-call-participants-video-container') ||\r\n            isFullScreen()) {\r\n            return false;\r\n          }\r\n\r\n          return true;\r\n        }\r\n      },\r\n      onResize: () => this.toggleBigLayout(),\r\n      previousState\r\n    });\r\n\r\n    listenerSetter.add(instance)('state', () => {\r\n      this.updateInstance();\r\n    });\r\n\r\n    listenerSetter.add(rootScope)('group_call_update', (groupCall) => {\r\n      if(this.instance?.id === groupCall.id) {\r\n        this.updateInstance();\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(instance)('pinned', () => {\r\n      this.setHasPinned();\r\n    });\r\n\r\n    listenerSetter.add(this.groupCallParticipantsVideo)('toggleControls', this.onToggleControls);\r\n\r\n    this.addEventListener('close', () => {\r\n      const {movablePanel} = this;\r\n      previousState = movablePanel.state;\r\n\r\n      this.groupCallParticipantsVideo.destroy();\r\n      this.groupCallParticipants.destroy();\r\n      this.groupCallMicrophoneIcon.destroy();\r\n\r\n      movablePanel.destroy();\r\n    });\r\n\r\n    this.toggleRightColumn();\r\n    this.onFullScreenChange();\r\n\r\n    this.updateInstance();\r\n  }\r\n\r\n  private constructButtons() {\r\n    const buttons = this.buttonsContainer = document.createElement('div');\r\n    buttons.classList.add(className + '-buttons');\r\n\r\n    const _makeButton = makeButton.bind(null, className, this.listenerSetter);\r\n\r\n    const btnVideo = this.btnVideo = _makeButton({\r\n      // text: 'VoiceChat.Video.Stream.Video',\r\n      callback: this.onVideoClick,\r\n      icon: 'videocamera_filled'\r\n    });\r\n\r\n    const btnScreen = this.btnScreen = _makeButton({\r\n      // text: 'VoiceChat.Video.Stream.Screencast',\r\n      callback: this.onScreenClick,\r\n      icon: 'sharescreen_filled'\r\n    });\r\n\r\n    btnScreen.classList.toggle('hide', !IS_SCREEN_SHARING_SUPPORTED);\r\n\r\n    const btnMute = _makeButton({\r\n      noRipple: true,\r\n      callback: throttle(this.onMuteClick, 600, true)\r\n    });\r\n    btnMute.classList.add(className + '-microphone-button');\r\n\r\n    const microphoneIcon = this.groupCallMicrophoneIcon = new GroupCallMicrophoneIcon();\r\n    btnMute.append(microphoneIcon.container);\r\n\r\n    const btnMore = _makeButton({\r\n      // text: 'VoiceChat.Video.Stream.More'\r\n      icon: 'settings_filled'\r\n    });\r\n\r\n    btnMore.classList.add('btn-disabled');\r\n    btnMore.classList.toggle('hide', !IS_SCREEN_SHARING_SUPPORTED);\r\n\r\n    const btnLeave = _makeButton({\r\n      // text: 'VoiceChat.Leave',\r\n      isDanger: true,\r\n      callback: this.onLeaveClick,\r\n      icon: 'close'\r\n    });\r\n\r\n    buttons.append(btnVideo, btnScreen, btnMute, btnMore, btnLeave);\r\n\r\n    this.container.append(buttons);\r\n  }\r\n\r\n  private onFullScreenClick = () => {\r\n    requestFullScreen(this.container);\r\n  };\r\n\r\n  private onToggleControls = (show: boolean) => {\r\n    this.container.classList.toggle('show-controls', show);\r\n    this.buttonsContainer.classList.toggle('show-controls', show);\r\n  };\r\n\r\n  private toggleDisability = toggleClassName.bind(null, 'btn-disabled');\r\n\r\n  private onVideoClick = () => {\r\n    const toggle = this.toggleDisability([this.btnVideo], true);\r\n    this.instance.toggleVideoSharing().finally(() => {\r\n      toggle();\r\n    });\r\n  };\r\n\r\n  private onScreenClick = () => {\r\n    const toggle = this.toggleDisability([this.btnScreen], true);\r\n    this.instance.toggleScreenSharing().finally(() => {\r\n      toggle();\r\n    });\r\n  };\r\n\r\n  private onMuteClick = () => {\r\n    const participant = this.instance.participant;\r\n    if(!participant.pFlags.can_self_unmute) {\r\n      if(participant.raise_hand_rating === undefined) {\r\n        this.instance.changeRaiseHand(true);\r\n      }\r\n    } else {\r\n      this.instance.toggleMuted();\r\n    }\r\n  };\r\n  \r\n  private onLeaveClick = async() => {\r\n    const hangUp = (discard: boolean) => {\r\n      this.instance.hangUp(discard);\r\n    };\r\n\r\n    if(await this.managers.appChatsManager.hasRights(this.instance.chatId, 'manage_call')) {\r\n      new PopupPeer('popup-end-video-chat', {\r\n        titleLangKey: 'VoiceChat.End.Title',\r\n        descriptionLangKey: 'VoiceChat.End.Text',\r\n        checkboxes: [{\r\n          text: 'VoiceChat.End.Third'\r\n        }],\r\n        buttons: [{\r\n          langKey: 'VoiceChat.End.OK',\r\n          callback: (checkboxes) => {\r\n            hangUp(!!checkboxes.size);\r\n          },\r\n          isDanger: true,\r\n        }]\r\n      }).show();\r\n    } else {\r\n      hangUp(false);\r\n    }\r\n  };\r\n\r\n  public getContainer() {\r\n    return this.container;\r\n  }\r\n\r\n  private onFullScreenChange = () => {\r\n    this.toggleBigLayout();\r\n    const isFull = isFullScreen();\r\n\r\n    const {btnFullScreen, btnExitFullScreen} = this;\r\n\r\n    const wasFullScreen = this.container.classList.contains('is-full-screen');\r\n    this.container.classList.toggle('is-full-screen', isFull);\r\n    btnFullScreen && btnFullScreen.classList.toggle('hide', isFull);\r\n    btnExitFullScreen && btnExitFullScreen.classList.toggle('hide', !isFull);\r\n    this.btnClose.classList.toggle('hide', isFull);\r\n\r\n    if(isFull !== wasFullScreen) {\r\n      animationIntersector.checkAnimations(isFull);\r\n\r\n      themeController.setThemeColor(isFull ? '#000000' : undefined);\r\n    }\r\n  };\r\n\r\n  private toggleBigLayout = () => {\r\n    const isFull = isFullScreen();\r\n    const movable = this.movablePanel?.movable;\r\n    const isBig = (isFull || !!(movable && movable.width >= 680)) && !!this.videosCount;\r\n\r\n    /* if(!isBig && isFull) {\r\n      cancelFullScreen();\r\n      return;\r\n    } */\r\n\r\n    const wasBig = this.container.classList.contains('is-big-layout');\r\n    let buttons: HTMLElement[];\r\n    if(isBig && !wasBig) { // fix buttons transition to 0 opacity\r\n      buttons = Array.from(this.buttonsContainer.children) as HTMLElement[];\r\n      buttons.forEach((element) => {\r\n        element.style.opacity = '0';\r\n      });\r\n\r\n      void this.buttonsContainer.offsetLeft;\r\n    }\r\n\r\n    this.container.classList.toggle('is-big-layout', isBig);\r\n    this.btnInvite.classList.toggle('hide', isBig);\r\n    this.btnShowColumn.classList.toggle('hide', !isBig);\r\n\r\n    if(buttons) {\r\n      // window.requestAnimationFrame(() => {\r\n        buttons.forEach((element) => {\r\n          element.style.opacity = '';\r\n        });\r\n      // });\r\n    }\r\n  };\r\n\r\n  private toggleRightColumn = () => {\r\n    this.container.classList.toggle('is-right-column-shown');\r\n  };\r\n\r\n  private setHasPinned() {\r\n    this.container.classList.toggle('has-pinned', !!this.instance.pinnedSource);\r\n  }\r\n\r\n  private updateInstance() {\r\n    if(this.instance.state === GROUP_CALL_STATE.CLOSED) {\r\n      if(this.container.classList.contains('is-full-screen')) {\r\n        cancelFullScreen();\r\n      }\r\n\r\n      this.hide();\r\n      return;\r\n    }\r\n\r\n    const {participant, groupCall} = this.instance;\r\n    if(!participant) {\r\n      return;\r\n    }\r\n\r\n    this.setTitle();\r\n    this.setDescription();\r\n    this.setHasPinned();\r\n\r\n    const microphoneButtonState = getGroupCallMicrophoneButtonState(groupCall as any, participant);\r\n    this.container.dataset.micState = microphoneButtonState === GROUP_CALL_MICROPHONE_BUTTON_STATE.HAND ? 'hand' : (microphoneButtonState === GROUP_CALL_MICROPHONE_BUTTON_STATE.MUTED ? 'muted' : 'unmuted');\r\n    this.groupCallMicrophoneIcon.setState(microphoneButtonState);\r\n  }\r\n\r\n  private setTitle() {\r\n    this.groupCallTitle.update(this.instance);\r\n  }\r\n\r\n  private setDescription() {\r\n    this.groupCallDescription.update(this.instance);\r\n    this.groupCallBodyHeaderDescription.update(this.instance);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport { GroupCallParticipant } from \"../../layer\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport { GROUP_CALL_PARTICIPANT_MUTED_STATE } from \".\";\r\nimport { GroupCallParticipantVideoType } from \"./participantVideo\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\n\r\nconst className = 'group-call-participant-status';\r\nexport default class GroupCallParticipantStatusElement {\r\n  public container: HTMLElement;\r\n\r\n  constructor(private withIcons: GroupCallParticipantVideoType[]) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add(className + '-container');\r\n  }\r\n\r\n  public setState(state: GROUP_CALL_PARTICIPANT_MUTED_STATE, participant: GroupCallParticipant) {\r\n    const states = GROUP_CALL_PARTICIPANT_MUTED_STATE;\r\n    const icons = this.withIcons.filter((type) => !!participant[type]).map((type) => {\r\n      const iconClassName = `tgico-${type === 'presentation' ? 'listscreenshare' : 'videocamera_filled'}`;\r\n      const i = document.createElement('i');\r\n      i.classList.add(className + '-icon', className + '-icon-' + type, iconClassName);\r\n      return i;\r\n    });\r\n\r\n    let element2: HTMLElement, actionClassName: string;\r\n    if(state === states.MUTED_FOR_ME) {\r\n      element2 = i18n('VoiceChat.Status.MutedForYou');\r\n      actionClassName = 'is-muted';\r\n    } else if(state === states.UNMUTED) {\r\n      element2 = i18n('VoiceChat.Status.Speaking');\r\n      actionClassName = 'is-speaking';\r\n    } else if(state === states.HAND) {\r\n      element2 = i18n('VoiceChat.Status.WantsSpeak');\r\n      actionClassName = 'is-waiting';\r\n    } else if(participant.about && !icons.length) {\r\n      setInnerHTML(this.container, wrapEmojiText(participant.about));\r\n      return;\r\n    } else {\r\n      element2 = i18n('VoiceChat.Status.Listening');\r\n      actionClassName = 'is-listening';\r\n    }\r\n\r\n    const span = document.createElement('span');\r\n    span.classList.add(className, actionClassName);\r\n    span.append(...icons, element2);\r\n    \r\n    replaceContent(this.container, span);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport positionElementByIndex from \"../../helpers/dom/positionElementByIndex\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport { fastRaf } from \"../../helpers/schedulers\";\r\nimport SortedList, { SortedElementBase } from \"../../helpers/sortedList\";\r\nimport { GroupCallParticipant } from \"../../layer\";\r\nimport appDialogsManager, { DialogDom, AppDialogsManager } from \"../../lib/appManagers/appDialogsManager\";\r\nimport { getGroupCallParticipantMutedState } from \".\";\r\nimport GroupCallParticipantMutedIcon from \"./participantMutedIcon\";\r\nimport GroupCallParticipantStatusElement from \"./participantStatus\";\r\nimport type GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport type LazyLoadQueue from \"../lazyLoadQueue\";\r\n\r\ninterface SortedParticipant extends SortedElementBase {\r\n  dom: DialogDom,\r\n  mutedIcon: GroupCallParticipantMutedIcon,\r\n  status: GroupCallParticipantStatusElement\r\n}\r\n\r\nexport default class GroupCallParticipantsList extends SortedList<SortedParticipant> {\r\n  public list: HTMLUListElement;\r\n  \r\n  protected lazyLoadQueue: LazyLoadQueue;\r\n  protected avatarSize = 54;\r\n  protected rippleEnabled = true;\r\n  protected autonomous = true;\r\n  protected createChatListOptions: Parameters<AppDialogsManager['createChatList']>[0] = {/* new: true,  */dialogSize: 72};\r\n\r\n  constructor(private instance: GroupCallInstance) {\r\n    super({\r\n      getIndex: async(element) => (await this.instance.getParticipantByPeerId(element.id)).date,\r\n      onDelete: (element) => {\r\n        element.dom.listEl.remove();\r\n        this.onElementDestroy(element);\r\n      },\r\n      onUpdate: async(element) => {\r\n        const participant = await this.instance.getParticipantByPeerId(element.id);\r\n        const state = getGroupCallParticipantMutedState(participant);\r\n\r\n        element.mutedIcon.setState(state);\r\n        element.status.setState(state, participant);\r\n      },\r\n      onSort: (element, idx) => {\r\n        positionElementByIndex(element.dom.listEl, this.list, idx);\r\n      },\r\n      onElementCreate: (base) => {\r\n        const {dom} = appDialogsManager.addDialogNew({\r\n          peerId: base.id,\r\n          container: false,\r\n          avatarSize: this.avatarSize,\r\n          autonomous: this.autonomous,\r\n          meAsSaved: false,\r\n          rippleEnabled: this.rippleEnabled,\r\n          lazyLoadQueue: this.lazyLoadQueue\r\n        });\r\n\r\n        const className = 'group-call-participant';\r\n        dom.listEl.classList.add(className);\r\n\r\n        const mutedIcon = new GroupCallParticipantMutedIcon(true);\r\n        const status = new GroupCallParticipantStatusElement(['presentation', 'video']);\r\n        replaceContent(dom.lastMessageSpan, status.container);\r\n        dom.listEl.append(mutedIcon.container);\r\n        (base as SortedParticipant).mutedIcon = mutedIcon;\r\n        (base as SortedParticipant).status = status;\r\n\r\n        /* instance.getParticipantByPeerId(base.id).then((participant) => {\r\n          const mutedState = getGroupCallParticipantMutedState(participant);\r\n\r\n          mutedIcon.setState(mutedState);\r\n          status.setState(mutedState, participant);\r\n        }); */\r\n        \r\n        (base as SortedParticipant).dom = dom;\r\n\r\n        return base as SortedParticipant;\r\n      },\r\n      updateElementWith: fastRaf\r\n    });\r\n\r\n    this.list = appDialogsManager.createChatList(this.createChatListOptions);\r\n  }\r\n\r\n  public destroy() {\r\n    this.elements.forEach((element) => {\r\n      this.onElementDestroy(element);\r\n    });\r\n  }\r\n\r\n  protected onElementDestroy(element: SortedParticipant) {\r\n    element.mutedIcon.destroy();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport EventListenerBase from \"../eventListenerBase\";\r\nimport ListenerSetter from \"../listenerSetter\";\r\nimport safeAssign from \"../object/safeAssign\";\r\nimport findUpClassName from \"./findUpClassName\";\r\n\r\nexport default class ControlsHover extends EventListenerBase<{\r\n  toggleControls: (show: boolean) => void\r\n}> {\r\n  protected hideControlsTimeout: number;\r\n  protected controlsLocked: boolean;\r\n\r\n  protected canHideControls: () => boolean;\r\n  protected element: HTMLElement;\r\n  protected listenerSetter: ListenerSetter;\r\n  protected showOnLeaveToClassName: string;\r\n  protected ignoreClickClassName: string;\r\n\r\n  constructor() {\r\n    super(false);\r\n    this.hideControlsTimeout = 0;\r\n  }\r\n  \r\n  public setup(options: {\r\n    element: HTMLElement, \r\n    listenerSetter: ListenerSetter, \r\n    canHideControls?: () => boolean,\r\n    showOnLeaveToClassName?: string,\r\n    ignoreClickClassName?: string\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    const {listenerSetter, element} = this;\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      listenerSetter.add(element)('click', (e) => {\r\n        if(this.ignoreClickClassName && findUpClassName(e.target, this.ignoreClickClassName)) {\r\n          return;\r\n        }\r\n\r\n        this.toggleControls();\r\n      });\r\n\r\n      /* listenerSetter.add(player)('touchstart', () => {\r\n        showControls(false);\r\n      });\r\n\r\n      listenerSetter.add(player)('touchend', () => {\r\n        if(player.classList.contains('is-playing')) {\r\n          showControls();\r\n        }\r\n      }); */\r\n    } else {\r\n      listenerSetter.add(element)('mousemove', () => {\r\n        this.showControls();\r\n      });\r\n\r\n      listenerSetter.add(element)('mouseenter', () => {\r\n        this.showControls(false);\r\n      });\r\n\r\n      listenerSetter.add(element)('mouseleave', (e) => {\r\n        if(e.relatedTarget && this.showOnLeaveToClassName && findUpClassName(e.relatedTarget, this.showOnLeaveToClassName)) {\r\n          this.showControls(false);\r\n          return;\r\n        }\r\n        \r\n        this.hideControls();\r\n      });\r\n    }\r\n  }\r\n\r\n  public hideControls = (setHideTimeout = false) => {\r\n    if(setHideTimeout) {\r\n      if(!this.hideControlsTimeout) {\r\n        this.hideControlsTimeout = window.setTimeout(this.hideControls, 3e3);\r\n      }\r\n\r\n      return;\r\n    }\r\n    \r\n    clearTimeout(this.hideControlsTimeout);\r\n    this.hideControlsTimeout = 0;\r\n\r\n    const isShown = this.element.classList.contains('show-controls');\r\n    if(this.controlsLocked !== false) {\r\n      if((this.canHideControls ? !this.canHideControls() : false) || !isShown || this.controlsLocked) {\r\n        return;\r\n      }\r\n    } else if(!isShown) {\r\n      return;\r\n    }\r\n    \r\n    this.dispatchEvent('toggleControls', false);\r\n    this.element.classList.remove('show-controls');\r\n  };\r\n  \r\n  public showControls = (setHideTimeout = true) => {\r\n    if(this.hideControlsTimeout) {\r\n      clearTimeout(this.hideControlsTimeout);\r\n      this.hideControlsTimeout = 0;\r\n    } else if(!this.element.classList.contains('show-controls') && this.controlsLocked !== false) {\r\n      this.dispatchEvent('toggleControls', true);\r\n      this.element.classList.add('show-controls');\r\n    }\r\n\r\n    if(!setHideTimeout || this.controlsLocked) {\r\n      return;\r\n    }\r\n\r\n    this.hideControlsTimeout = window.setTimeout(this.hideControls, 3e3);\r\n  };\r\n\r\n  public toggleControls = (show?: boolean) => {\r\n    const isShown = this.element.classList.contains('show-controls');\r\n\r\n    if(show === undefined) {\r\n      if(isShown) this.hideControls();\r\n      else this.showControls();\r\n    } else if(show === isShown) return;\r\n    else if(show === false) this.hideControls();\r\n    else this.showControls();\r\n  };\r\n\r\n  public lockControls(visible: boolean) {\r\n    this.controlsLocked = visible;\r\n\r\n    this.element.classList.toggle('disable-hover', visible === false);\r\n    this.toggleControls(visible);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { animate } from \"../../helpers/animation\";\r\n\r\nexport default function callVideoCanvasBlur(video: HTMLVideoElement) {\r\n  const canvas = document.createElement('canvas');\r\n  canvas.classList.add('call-video-blur');\r\n  const size = 16;\r\n  canvas.width = size;\r\n  canvas.height = size;\r\n\r\n  const ctx = canvas.getContext('2d', {alpha: false});\r\n  ctx.filter = 'blur(2px)';\r\n  const renderFrame = () => {\r\n    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, 0, 0, canvas.width, canvas.height);\r\n  };\r\n\r\n  animate(() => {\r\n    renderFrame();\r\n    return canvas.isConnected;\r\n  });\r\n\r\n  renderFrame();\r\n\r\n  return canvas;\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { GroupCallParticipant } from \"../../layer\";\r\nimport type { GroupCallOutputSource } from \"../../lib/appManagers/appGroupCallsManager\";\r\nimport { i18n } from \"../../lib/langPack\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport { getGroupCallParticipantMutedState } from \".\";\r\nimport GroupCallParticipantMutedIcon from \"./participantMutedIcon\";\r\nimport GroupCallParticipantStatusElement from \"./participantStatus\";\r\nimport GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport callVideoCanvasBlur from \"../call/videoCanvasBlur\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\n\r\nconst className = 'group-call-participant-video';\r\n\r\nexport type GroupCallParticipantVideoType = 'video' | 'presentation';\r\nexport default class GroupCallParticipantVideoElement {\r\n  public container: HTMLElement;\r\n  private peerTitle: PeerTitle;\r\n  private subtitle: HTMLElement;\r\n  private info: HTMLElement;\r\n  private left: HTMLElement;\r\n  private right: HTMLElement;\r\n  private header: HTMLElement;\r\n  private groupCallParticipantMutedIcon: GroupCallParticipantMutedIcon;\r\n  private groupCallParticipantStatus: GroupCallParticipantStatusElement;\r\n\r\n  constructor(private managers: AppManagers, private instance: GroupCallInstance, public source: GroupCallOutputSource) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add(className + '-container');\r\n\r\n    this.info = document.createElement('div');\r\n    this.info.classList.add(className + '-info');\r\n\r\n    this.left = document.createElement('div');\r\n    this.left.classList.add(className + '-info-left');\r\n\r\n    this.right = document.createElement('div');\r\n    this.right.classList.add(className + '-info-right');\r\n\r\n    this.info.append(this.left, this.right);\r\n    \r\n    this.container.append(this.info);\r\n  }\r\n\r\n  public setPinned(value: boolean) {\r\n    if(!value) {\r\n      if(this.header) {\r\n        this.header.remove();\r\n        this.header = undefined;\r\n      }\r\n\r\n      return;\r\n    } else if(this.header) {\r\n      return;\r\n    }\r\n    \r\n    // if(!this.header) {\r\n      this.header = document.createElement('div');\r\n      this.header.classList.add(className + '-header');\r\n  \r\n      const icon = document.createElement('i');\r\n      icon.classList.add('group-call-pin-icon', 'tgico-pin');\r\n      this.header.append(icon);\r\n  \r\n      this.container.append(this.header);\r\n    // }\r\n    \r\n    // this.container.classList.toggle('is-pinned', value);\r\n  }\r\n\r\n  public setParticipant(participant: GroupCallParticipant, type: GroupCallParticipantVideoType, video: HTMLVideoElement) {\r\n    let peerTitleElement: HTMLElement;\r\n    if(participant.pFlags.self) {\r\n      peerTitleElement = i18n('VoiceChat.Status.You');\r\n      peerTitleElement.classList.add('peer-title');\r\n    } else {\r\n      this.peerTitle = new PeerTitle({\r\n        peerId: getPeerId(participant.peer)\r\n      });\r\n\r\n      peerTitleElement = this.peerTitle.element;\r\n    }\r\n\r\n    this.groupCallParticipantMutedIcon = new GroupCallParticipantMutedIcon(false);\r\n    this.groupCallParticipantStatus = new GroupCallParticipantStatusElement([type]);\r\n\r\n    this.left.append(peerTitleElement, this.groupCallParticipantStatus.container);\r\n\r\n    this.right.append(this.groupCallParticipantMutedIcon.container);\r\n\r\n    video.classList.add(className, 'call-video');\r\n\r\n    if(video.paused) {\r\n      video.play();\r\n    }\r\n\r\n    const canvas = callVideoCanvasBlur(video);\r\n    canvas.classList.add(className + '-blur');\r\n    \r\n    this.container.prepend(canvas, video);\r\n\r\n    this.updateParticipant(participant);\r\n  }\r\n\r\n  public updateParticipant(participant: GroupCallParticipant) {\r\n    const state = getGroupCallParticipantMutedState(participant);\r\n\r\n    this.groupCallParticipantMutedIcon.setState(state);\r\n    this.groupCallParticipantStatus.setState(state, participant);\r\n  }\r\n\r\n  public destroy() {\r\n    this.groupCallParticipantMutedIcon.destroy();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport ControlsHover from \"../../helpers/dom/controlsHover\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport { GroupCallParticipant } from \"../../layer\";\r\nimport { GroupCallOutputSource } from \"../../lib/appManagers/appGroupCallsManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport GroupCallParticipantVideoElement, { GroupCallParticipantVideoType } from \"./participantVideo\";\r\n\r\nexport default class GroupCallParticipantsVideoElement extends ControlsHover {\r\n  private container: HTMLDivElement;\r\n  private instance: GroupCallInstance;\r\n  private participantsElements: Map<PeerId, Map<GroupCallParticipantVideoType, GroupCallParticipantVideoElement>>;\r\n  private displayPinned: boolean;\r\n  private containers: Map<HTMLElement, GroupCallParticipantVideoElement>;\r\n  private onLengthChange: (length: number) => void;\r\n  private managers: AppManagers;\r\n\r\n  constructor(options: {\r\n    appendTo: HTMLElement,\r\n    instance: GroupCallInstance,\r\n    listenerSetter: ListenerSetter,\r\n    displayPinned: boolean,\r\n    onLengthChange?: GroupCallParticipantsVideoElement['onLengthChange'],\r\n    managers: AppManagers\r\n  }) {\r\n    super();\r\n    safeAssign(this, options);\r\n\r\n    const className = 'group-call-participants-video';\r\n    const container = this.container = document.createElement('div');\r\n    this.container.classList.add(className + '-container');\r\n    \r\n    options.appendTo.append(container);\r\n\r\n    this.participantsElements = new Map();\r\n    this.containers = new Map();\r\n\r\n    const {listenerSetter} = this;\r\n\r\n    listenerSetter.add(rootScope)('group_call_participant', ({groupCallId, participant}) => {\r\n      if(this.instance.id === groupCallId) {\r\n        this.updateParticipant(participant);\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(this.instance)('pinned', (source) => {\r\n      this.participantsElements.forEach((map) => {\r\n        map.forEach((element) => {\r\n          this.setElementDisplay(element, source);\r\n        });\r\n      });\r\n    });\r\n\r\n    attachClickEvent(this.container, (e) => {\r\n      const container = findUpClassName(e.target, 'group-call-participant-video-container');\r\n      if(!container) {\r\n        return;\r\n      }\r\n\r\n      const element = this.containers.get(container);\r\n      if(this.instance.pinnedSource === element.source) {\r\n        this.instance.unpinAll();\r\n        return;  \r\n      }\r\n      \r\n      this.instance.pinSource(element.source);\r\n    }, {listenerSetter});\r\n\r\n    this.setInstance(this.instance);\r\n\r\n    this.setup({\r\n      element: container,\r\n      listenerSetter: listenerSetter,\r\n      showOnLeaveToClassName: 'group-call-buttons'\r\n    });\r\n  }\r\n\r\n  private shouldDisplayElement(element: GroupCallParticipantVideoElement, pinnedSource: GroupCallOutputSource) {\r\n    return this.displayPinned ? !pinnedSource || element.source === pinnedSource : pinnedSource && element.source !== pinnedSource;\r\n  }\r\n\r\n  private setElementDisplay(element: GroupCallParticipantVideoElement, pinnedSource: GroupCallOutputSource) {\r\n    const shouldDisplay = this.shouldDisplayElement(element, pinnedSource);\r\n    element.container.classList.toggle('video-hidden', !shouldDisplay);\r\n\r\n    const isPinned = element.source === pinnedSource;\r\n    element.setPinned(isPinned);\r\n  }\r\n\r\n  private updateParticipant(participant: GroupCallParticipant) {\r\n    const peerId = getPeerId(participant.peer);\r\n    const types: GroupCallParticipantVideoType[] = ['video', 'presentation'];\r\n    const hasAnyVideo = types.some((type) => !!participant[type]);\r\n    let participantElements = this.participantsElements.get(peerId);\r\n    if(!hasAnyVideo && !participantElements) {\r\n      return;\r\n    }\r\n\r\n    if(!participantElements) {\r\n      this.participantsElements.set(peerId, participantElements = new Map());\r\n    }\r\n\r\n    types.forEach((type) => {\r\n      let element = participantElements.get(type);\r\n      const participantVideo = participant[type];\r\n      if(!!participantVideo === !!element) {\r\n        if(element) {\r\n          element.updateParticipant(participant);\r\n        }\r\n\r\n        return;\r\n      }\r\n\r\n      if(participantVideo) {\r\n        const result = this.instance.getVideoElementFromParticipantByType(participant, type);\r\n        if(!result) {\r\n          return;\r\n        }\r\n\r\n        const {video, source} = result;\r\n\r\n        element = new GroupCallParticipantVideoElement(this.managers, this.instance, source);\r\n\r\n        this.containers.set(element.container, element);\r\n\r\n        this.setElementDisplay(element, this.instance.pinnedSource);\r\n        participantElements.set(type, element);\r\n        element.setParticipant(participant, type, video);\r\n    \r\n        this.container.prepend(element.container);\r\n      } else {\r\n        participantElements.delete(type);\r\n        element.container.remove();\r\n        \r\n        if(!participantElements.size) {\r\n          this.participantsElements.delete(peerId);\r\n          this.containers.delete(element.container);\r\n          element.destroy();\r\n        }\r\n      }\r\n\r\n      this._onLengthChange();\r\n    });\r\n  }\r\n\r\n  private _onLengthChange() {\r\n    const length = this.container.childElementCount;\r\n    this.container.dataset.length = '' + length;\r\n    this.container.dataset.layout = length <= 2 ? '1' : (length === 3 ? '3' : '4');\r\n\r\n    this.onLengthChange && this.onLengthChange(length);\r\n  }\r\n\r\n  public async setInstance(instance: GroupCallInstance) {\r\n    (await instance.participants).forEach((participant) => {\r\n      this.updateParticipant(participant);\r\n    });\r\n  }\r\n\r\n  public destroy() {\r\n    this.containers.forEach((element) => {\r\n      element.destroy();\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport PopupGroupCall from \".\";\r\nimport filterAsync from \"../../helpers/array/filterAsync\";\r\nimport contextMenuController from \"../../helpers/contextMenuController\";\r\nimport { attachContextMenuListener } from \"../../helpers/dom/attachContextMenuListener\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport { addFullScreenListener, isFullScreen } from \"../../helpers/dom/fullScreen\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport noop from \"../../helpers/noop\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport positionMenu from \"../../helpers/positionMenu\";\r\nimport ScrollableLoader from \"../../helpers/scrollableLoader\";\r\nimport { GroupCallParticipant } from \"../../layer\";\r\nimport type { AppChatsManager } from \"../../lib/appManagers/appChatsManager\";\r\nimport type { AppGroupCallsManager } from \"../../lib/appManagers/appGroupCallsManager\";\r\nimport appImManager from \"../../lib/appManagers/appImManager\";\r\nimport type { AppPeersManager } from \"../../lib/appManagers/appPeersManager\";\r\nimport { AppManagers } from \"../../lib/appManagers/managers\";\r\nimport getPeerId from \"../../lib/appManagers/utils/peers/getPeerId\";\r\nimport GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport rootScope from \"../../lib/rootScope\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"../buttonMenu\";\r\nimport confirmationPopup from \"../confirmationPopup\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport PopupElement from \"../popups\";\r\nimport Scrollable from \"../scrollable\";\r\nimport GroupCallParticipantsList from \"./participantsList\";\r\nimport GroupCallParticipantsVideoElement from \"./participantVideos\";\r\n\r\nexport class GroupCallParticipantContextMenu {\r\n  private buttons: (ButtonMenuItemOptions & {verify: (peerId: PeerId) => boolean | Promise<boolean>})[];\r\n  private element: HTMLDivElement;\r\n  private chatId: ChatId;\r\n  private targetPeerId: PeerId;\r\n  private participant: GroupCallParticipant;\r\n  private instance: GroupCallInstance;\r\n  private canManageCall: boolean;\r\n  private managers: AppManagers;\r\n  \r\n  constructor(options: {\r\n    listenerSetter: ListenerSetter,\r\n    onContextElement: HTMLElement,\r\n    managers: AppManagers,\r\n    instance: GroupCallInstance,\r\n  }) {\r\n    this.buttons = [{\r\n      icon: 'gc_microphoneoff',\r\n      text: 'VoiceChat.MutePeer',\r\n      verify: () => this.canManageCall && this.participant.pFlags.can_self_unmute,\r\n      onClick: () => this.toggleParticipantMuted(true)\r\n    }, {\r\n      icon: 'gc_microphone',\r\n      text: 'VoiceChat.UnmutePeer',\r\n      verify: () => this.canManageCall && !this.participant.pFlags.can_self_unmute,\r\n      onClick: () => this.toggleParticipantMuted(false)\r\n    }, {\r\n      icon: 'gc_microphoneoff',\r\n      text: 'VoiceChat.MuteForMe',\r\n      verify: () => !this.canManageCall && !this.participant.pFlags.muted_by_you,\r\n      onClick: () => this.toggleParticipantMuted(true)\r\n    }, {\r\n      icon: 'gc_microphone',\r\n      text: 'VoiceChat.UnmuteForMe',\r\n      verify: () => !this.canManageCall && this.participant.pFlags.muted_by_you,\r\n      onClick: () => this.toggleParticipantMuted(false)\r\n    }, {\r\n      icon: 'newprivate',\r\n      text: 'VoiceChat.OpenProfile',\r\n      verify: () => true,\r\n      onClick: this.onOpenProfileClick\r\n    }, {\r\n      icon: 'deleteuser danger',\r\n      text: 'VoiceChat.RemovePeer',\r\n      verify: () => this.managers.appChatsManager.hasRights(this.chatId, 'ban_users'),\r\n      onClick: async() => {\r\n        confirmationPopup({\r\n          peerId: this.targetPeerId,\r\n          title: new PeerTitle({peerId: this.targetPeerId}).element,\r\n          descriptionLangKey: await this.managers.appChatsManager.isBroadcast(this.chatId) ? 'VoiceChat.RemovePeer.Confirm.Channel' : 'VoiceChat.RemovePeer.Confirm',\r\n          descriptionLangArgs: [new PeerTitle({peerId: this.targetPeerId}).element],\r\n          button: {\r\n            langKey: 'VoiceChat.RemovePeer.Confirm.OK',\r\n            isDanger: true\r\n          }\r\n        }).then(() => {\r\n          this.managers.appChatsManager.kickFromChat(this.chatId, this.targetPeerId);\r\n        }, noop);\r\n      }\r\n    }];\r\n\r\n    const {listenerSetter} = options;\r\n    this.managers = options.managers;\r\n    this.instance = options.instance;\r\n    this.chatId = this.instance.chatId;\r\n  \r\n    this.element = ButtonMenu(this.buttons, listenerSetter);\r\n    this.element.classList.add('group-call-participant-menu', 'night');\r\n\r\n    attachContextMenuListener(options.onContextElement, async(e: any) => {\r\n      const li = findUpClassName(e.target, 'group-call-participant');\r\n      if(!li) {\r\n        return;\r\n      }\r\n\r\n      if(this.element.parentElement !== appendTo) {\r\n        appendTo.append(this.element);\r\n      }\r\n\r\n      cancelEvent(e);\r\n\r\n      const peerId = this.targetPeerId = li.dataset.peerId.toPeerId();\r\n      this.participant = await this.instance.getParticipantByPeerId(peerId);\r\n      if(this.participant.pFlags.self) {\r\n        return;\r\n      }\r\n\r\n      this.canManageCall = await this.managers.appChatsManager.hasRights(this.chatId, 'manage_call');\r\n\r\n      await filterAsync(this.buttons, async(button) => {\r\n        const good = await button.verify(peerId);\r\n        button.element.classList.toggle('hide', !good);\r\n        return good;\r\n      });\r\n      \r\n      positionMenu((e as TouchEvent).touches ? (e as TouchEvent).touches[0] : e as MouseEvent, this.element, 'right');\r\n      contextMenuController.openBtnMenu(this.element);\r\n    }, listenerSetter);\r\n\r\n    listenerSetter.add(rootScope)('group_call_participant', ({groupCallId, participant}) => {\r\n      if(this.instance.id === groupCallId) {\r\n        const peerId = getPeerId(participant.peer);\r\n        if(this.targetPeerId === peerId) {\r\n          contextMenuController.closeBtnMenu();\r\n        }\r\n      }\r\n    });\r\n\r\n    let appendTo: HTMLElement = document.body;\r\n    addFullScreenListener(document.body, () => {\r\n      const isFull = isFullScreen();\r\n      appendTo = isFull ? PopupElement.getPopups(PopupGroupCall)[0].getContainer(): document.body;\r\n\r\n      if(!isFull) {\r\n        contextMenuController.closeBtnMenu();\r\n      }\r\n    }, listenerSetter);\r\n  }\r\n\r\n  private onOpenProfileClick = () => {\r\n    const popup = PopupElement.getPopups(PopupGroupCall)[0];\r\n    if(popup) {\r\n      popup.hide();\r\n    }\r\n\r\n    appImManager.setInnerPeer({peerId: this.targetPeerId});\r\n  };\r\n\r\n  private toggleParticipantMuted = (muted: boolean) => {\r\n    this.instance.editParticipant(this.participant, {\r\n      muted\r\n    });\r\n  };\r\n};\r\n\r\nexport default class GroupCallParticipantsElement {\r\n  private container: HTMLDivElement;\r\n  private sortedList: GroupCallParticipantsList;\r\n  private instance: GroupCallInstance;\r\n  private listenerSetter: ListenerSetter;\r\n  private groupCallParticipantsVideo: GroupCallParticipantsVideoElement;\r\n  private contextMenu: GroupCallParticipantContextMenu;\r\n  private managers: AppManagers;\r\n\r\n  constructor(options: {\r\n    appendTo: HTMLElement,\r\n    instance: GroupCallInstance,\r\n    listenerSetter: ListenerSetter,\r\n    managers: AppManagers\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    const className = 'group-call-participants';\r\n\r\n    const scrollable = new Scrollable(undefined);\r\n    scrollable.container.classList.add(className + '-scrollable');\r\n\r\n    const container = this.container = document.createElement('div');\r\n    container.classList.add(className);\r\n\r\n    // const invite = Button(`btn-primary btn-transparent ${className}-invite`, {icon: 'adduser', text: 'VoiceChat.Invite.InviteMembers'});\r\n\r\n    const sortedList = this.sortedList = new GroupCallParticipantsList(this.instance);\r\n    \r\n    const {instance, listenerSetter} = this;\r\n    this.contextMenu = new GroupCallParticipantContextMenu({\r\n      ...options,\r\n      onContextElement: sortedList.list,\r\n      listenerSetter,\r\n      instance\r\n    });\r\n\r\n    this.groupCallParticipantsVideo = new GroupCallParticipantsVideoElement({\r\n      ...options,\r\n      appendTo: scrollable.container,\r\n      displayPinned: false\r\n    });\r\n\r\n    scrollable.append(/* invite,  */sortedList.list);\r\n    container.append(scrollable.container);\r\n\r\n    options.appendTo.append(container);\r\n\r\n    listenerSetter.add(rootScope)('group_call_participant', ({groupCallId, participant}) => {\r\n      if(this.instance.id === groupCallId) {\r\n        this.updateParticipant(participant);\r\n      }\r\n    });\r\n\r\n    const scrollableLoader = new ScrollableLoader({\r\n      scrollable,\r\n      getPromise: () => {\r\n        return this.managers.appGroupCallsManager.getGroupCallParticipants(this.instance.id).then(({participants, isEnd}) => {\r\n          participants.forEach((participant) => {\r\n            this.updateParticipant(participant);\r\n          });\r\n          \r\n          return isEnd;\r\n        });\r\n      }\r\n    });\r\n\r\n    this.setInstance(instance);\r\n  }\r\n\r\n  private updateParticipant(participant: GroupCallParticipant) {\r\n    const peerId = getPeerId(participant.peer);\r\n    const has = this.sortedList.has(peerId);\r\n    if(participant.pFlags.left) {\r\n      if(has) {\r\n        this.sortedList.delete(peerId);\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    if(!has) {\r\n      this.sortedList.add(peerId);\r\n      return;\r\n    }\r\n\r\n    this.sortedList.update(peerId);\r\n  }\r\n\r\n  public async setInstance(instance: GroupCallInstance) {\r\n    // @ts-ignore\r\n    /* const users = appUsersManager.users;\r\n    for(const userId in users) {\r\n      const participant: GroupCallParticipant = {\r\n        _: 'groupCallParticipant',\r\n        date: 0,\r\n        peer: {_: 'peerUser', user_id: userId.toPeerId()},\r\n        pFlags: {\r\n          muted: true\r\n        },\r\n        source: 1\r\n      };\r\n\r\n      instance.participants.set(userId.toPeerId(), participant);\r\n      this.updateParticipant(participant);\r\n    } */\r\n    const participants = await instance.participants;\r\n    participants.forEach((participant) => {\r\n      this.updateParticipant(participant);\r\n    });\r\n  }\r\n  \r\n  public destroy() {\r\n    this.sortedList.destroy();\r\n    this.groupCallParticipantsVideo.destroy();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { GroupCall } from \"../../layer\";\r\nimport GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport GROUP_CALL_STATE from \"../../lib/calls/groupCallState\";\r\nimport I18n, { LangPackKey, FormatterArguments } from \"../../lib/langPack\";\r\n\r\nexport default class GroupCallDescriptionElement {\r\n  private descriptionIntl: I18n.IntlElement;\r\n\r\n  constructor(private appendTo: HTMLElement) {\r\n    this.descriptionIntl = new I18n.IntlElement({\r\n      key: 'VoiceChat.Status.Connecting'\r\n    });\r\n\r\n    this.descriptionIntl.element.classList.add('group-call-description');\r\n  }\r\n\r\n  public detach() {\r\n    this.descriptionIntl.element.remove();\r\n  }\r\n\r\n  public update(instance: GroupCallInstance) {\r\n    const {state} = instance;\r\n\r\n    let key: LangPackKey, args: FormatterArguments;\r\n    if(state === GROUP_CALL_STATE.CONNECTING) {\r\n      key = 'VoiceChat.Status.Connecting';\r\n    } else {\r\n      key = 'VoiceChat.Status.Members';\r\n      args = [(instance.groupCall as GroupCall.groupCall).participants_count];\r\n    }\r\n\r\n    const {descriptionIntl} = this;\r\n    descriptionIntl.compareAndUpdate({\r\n      key,\r\n      args\r\n    });\r\n\r\n    if(!this.descriptionIntl.element.parentElement) {\r\n      this.appendTo.append(this.descriptionIntl.element);\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport { GroupCall } from \"../../layer\";\r\nimport GroupCallInstance from \"../../lib/calls/groupCallInstance\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport PeerTitle from \"../peerTitle\";\r\n\r\nexport default class GroupCallTitleElement {\r\n  private peerTitle: PeerTitle;\r\n\r\n  constructor(private appendTo: HTMLElement) {\r\n    this.peerTitle = new PeerTitle({peerId: 0});\r\n  }\r\n\r\n  public update(instance: GroupCallInstance) {\r\n    const {peerTitle, appendTo} = this;\r\n    const groupCall = instance.groupCall as GroupCall.groupCall;\r\n    const peerId = instance.chatId.toPeerId(true);\r\n    if(groupCall.title) {\r\n      setInnerHTML(appendTo, wrapEmojiText(groupCall.title));\r\n    } else {\r\n      if(peerTitle.peerId !== peerId) {\r\n        peerTitle.peerId = peerId;\r\n        peerTitle.update();\r\n      }\r\n\r\n      if(peerTitle.element.parentElement !== appendTo) {\r\n        appendTo.append(peerTitle.element);\r\n      }\r\n    } \r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport ListenerSetter from \"../../helpers/listenerSetter\";\r\nimport { i18n, LangPackKey } from \"../../lib/langPack\";\r\nimport ripple from \"../ripple\";\r\n\r\nexport default function makeButton(className: string, listenerSetter: ListenerSetter, options: {\r\n  text?: LangPackKey | HTMLElement,\r\n  isDanger?: boolean,\r\n  noRipple?: boolean,\r\n  callback?: () => void,\r\n  icon?: string,\r\n  isConfirm?: boolean,\r\n}) {\r\n  const _className = className + '-button';\r\n  const buttonDiv = document.createElement('div');\r\n  buttonDiv.classList.add(_className, 'call-button', 'rp-overflow');\r\n\r\n  if(options.icon) {\r\n    buttonDiv.classList.add('tgico-' + options.icon);\r\n  }\r\n\r\n  if(!options.noRipple) {\r\n    ripple(buttonDiv);\r\n  }\r\n\r\n  if(options.isDanger) {\r\n    buttonDiv.classList.add(_className + '-red');\r\n  }\r\n\r\n  if(options.isConfirm) {\r\n    buttonDiv.classList.add(_className + '-green');\r\n  }\r\n\r\n  if(options.callback) {\r\n    attachClickEvent(buttonDiv, options.callback, {listenerSetter});\r\n  }\r\n\r\n  let ret = buttonDiv;\r\n  if(options.text) {\r\n    const div = document.createElement('div');\r\n    div.classList.add(_className + '-container', 'call-button-container');\r\n\r\n    const textEl = typeof(options.text) === 'string' ? i18n(options.text) : options.text;\r\n    textEl.classList.add(_className + '-text', 'call-button-text');\r\n\r\n    div.append(buttonDiv, textEl);\r\n\r\n    ret = div;\r\n  }\r\n\r\n  return ret;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport EventListenerBase from \"../helpers/eventListenerBase\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport clamp from \"../helpers/number/clamp\";\r\nimport safeAssign from \"../helpers/object/safeAssign\";\r\nimport windowSize from \"../helpers/windowSize\";\r\nimport SwipeHandler from \"./swipeHandler\";\r\n\r\ntype ResizeSide = 'n' | 'e' | 's' | 'w' | 'ne' | 'se' | 'sw' | 'nw';\r\nexport type MovableState = {\r\n  top?: number;\r\n  left?: number;\r\n  width: number;\r\n  height: number;\r\n};\r\n\r\nconst className = 'movable-element';\r\nconst resizeHandlerClassName = className + '-resize-handler';\r\n\r\nexport type MovableElementOptions = {\r\n  minWidth: MovableElement['minWidth'],\r\n  minHeight: MovableElement['minHeight'],\r\n  element: MovableElement['element'],\r\n  verifyTouchTarget?: MovableElement['verifyTouchTarget']\r\n};\r\n\r\nexport default class MovableElement extends EventListenerBase<{\r\n  resize: () => void\r\n}> {\r\n  private minWidth: number;\r\n  private minHeight: number;\r\n  private element: HTMLElement;\r\n  private verifyTouchTarget: (e: TouchEvent | MouseEvent) => boolean;\r\n\r\n  private top: number;\r\n  private left: number;\r\n  private _width: number;\r\n  private _height: number;\r\n\r\n  private swipeHandler: SwipeHandler;\r\n  private handlers: HTMLElement[];\r\n\r\n  constructor(options: MovableElementOptions) {\r\n    super(true);\r\n    safeAssign(this, options);\r\n    \r\n    this.top = this.left = this.width = this.height = 0;\r\n    this.element.classList.add(className);\r\n  \r\n    this.addResizeHandlers();\r\n    this.setSwipeHandler();\r\n\r\n    mediaSizes.addEventListener('resize', this.onResize);\r\n  }\r\n\r\n  private onResize = () => {\r\n    this.fixDimensions();\r\n    this.fixPosition();\r\n    this.setPosition();\r\n  };\r\n\r\n  public destroyElements() {\r\n    this.element.classList.remove(className);\r\n\r\n    if(this.handlers) {\r\n      this.handlers.forEach((handler) => {\r\n        handler.remove();\r\n      });\r\n    }\r\n  }\r\n\r\n  public destroy() {\r\n    mediaSizes.removeEventListener('resize', this.onResize);\r\n    this.swipeHandler.removeListeners();\r\n  }\r\n\r\n  private addResizeHandlers() {\r\n    const sides: ResizeSide[] = ['n', 'e', 's', 'w', 'ne', 'se', 'sw', 'nw'];\r\n    this.handlers = sides.map((side) => {\r\n      const div = document.createElement('div');\r\n      div.dataset.side = side;\r\n      div.classList.add(resizeHandlerClassName, resizeHandlerClassName + '-side-' + side);\r\n      this.element.append(div);\r\n      return div;\r\n    });\r\n  }\r\n\r\n  private setSwipeHandler() {\r\n    let startTop: number, startLeft: number, startWidth: number, startHeight: number, resizingSide: ResizeSide;\r\n    const swipeHandler = this.swipeHandler = new SwipeHandler({\r\n      element: this.element,\r\n      onSwipe: (xDiff, yDiff, e) => {\r\n        xDiff *= -1; // to right will be positive\r\n        yDiff *= -1; // to bottom will be positive\r\n        // console.log(xDiff, yDiff, e);\r\n\r\n        if(resizingSide) {\r\n          if(resizingSide.includes('e') || resizingSide.includes('w')) {\r\n            const isEnlarging = resizingSide.includes('e') && xDiff > 0 || resizingSide.includes('w') && xDiff < 0;\r\n            const resizeDiff = Math.abs(xDiff) * (isEnlarging ? 1 : -1);\r\n\r\n            const maxPossible = resizingSide.includes('e') ? windowSize.width - startLeft : startWidth + startLeft;\r\n            this.width = Math.min(maxPossible, startWidth + resizeDiff);\r\n          }\r\n\r\n          if(resizingSide.includes('n') || resizingSide.includes('s')) {\r\n            const isEnlarging = resizingSide.includes('s') && yDiff > 0 || resizingSide.includes('n') && yDiff < 0;\r\n            const resizeDiff = Math.abs(yDiff) * (isEnlarging ? 1 : -1);\r\n\r\n            const maxPossible = resizingSide.includes('s') ? windowSize.height - startTop : startHeight + startTop;\r\n            this.height = Math.min(maxPossible, startHeight + resizeDiff);\r\n          }\r\n\r\n          this.fixDimensions();\r\n\r\n          if(resizingSide.includes('w')) {\r\n            this.left = Math.min(startLeft + startWidth - this.minWidth, startLeft + xDiff);\r\n          }\r\n\r\n          if(resizingSide.includes('n')) {\r\n            this.top = Math.min(startTop + startHeight - this.minHeight, startTop + yDiff);\r\n          }\r\n        } else {\r\n          this.top = startTop + yDiff;\r\n          this.left = startLeft + xDiff;\r\n        }\r\n\r\n        this.fixPosition();\r\n        this.setPosition();\r\n      },\r\n      verifyTouchTarget: (e) => {\r\n        const target = e.target;\r\n        if(this.verifyTouchTarget && !this.verifyTouchTarget(e)) {\r\n          return false;\r\n        }\r\n\r\n        const resizeHandler = findUpClassName(target, resizeHandlerClassName);\r\n        if(resizeHandler) {\r\n          resizingSide = resizeHandler.dataset.side as ResizeSide;\r\n          swipeHandler.setCursor('');\r\n        } else {\r\n          resizingSide = undefined;\r\n          swipeHandler.setCursor('grabbing');\r\n        }\r\n\r\n        return true;\r\n      },\r\n      onFirstSwipe: () => {\r\n        startTop = this.top;\r\n        startLeft = this.left;\r\n        startWidth = this.width;\r\n        startHeight = this.height;\r\n      }\r\n    });\r\n  }\r\n\r\n  public setPositionToCenter() {\r\n    this.top = (windowSize.height / 2) - (this.height / 2);\r\n    this.left = (windowSize.width / 2) - (this.width / 2);\r\n    this.setPosition();\r\n  }\r\n\r\n  private fixDimensions() {\r\n    this.width = clamp(this.width, this.minWidth, windowSize.width);\r\n    this.height = clamp(this.height, this.minHeight, windowSize.height);\r\n  }\r\n\r\n  private fixPosition() {\r\n    this.top = clamp(this.top, 0, windowSize.height - this.height);\r\n    this.left = clamp(this.left, 0, windowSize.width - this.width);\r\n  }\r\n\r\n  private setPosition() {\r\n    this.element.style.top = this.top + 'px';\r\n    this.element.style.left = this.left + 'px';\r\n    this.element.style.right = 'auto';\r\n    this.element.style.bottom = 'auto';\r\n    this.element.style.width = this.width + 'px';\r\n    this.element.style.height = this.height + 'px';\r\n\r\n    this.dispatchEvent('resize');\r\n  }\r\n\r\n  public get width() {\r\n    return this._width;\r\n  }\r\n\r\n  public get height() {\r\n    return this._height;\r\n  }\r\n\r\n  private set width(value: number) {\r\n    this._width = value;\r\n  }\r\n\r\n  private set height(value: number) {\r\n    this._height = value;\r\n  }\r\n\r\n  public get state(): MovableState {\r\n    const {top, left, width, height} = this;\r\n    return {\r\n      top,\r\n      left,\r\n      width,\r\n      height\r\n    };\r\n  }\r\n\r\n  public set state(state: MovableState) {\r\n    const {top, left, width, height} = state;\r\n    this.top = top;\r\n    this.left = left;\r\n    this.width = width;\r\n    this.height = height;\r\n    this.onResize();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport MovableElement, { MovableElementOptions, MovableState } from \"../components/movableElement\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport ListenerSetter from \"./listenerSetter\";\r\nimport mediaSizes, { ScreenSize } from \"./mediaSizes\";\r\nimport safeAssign from \"./object/safeAssign\";\r\n\r\nexport default class MovablePanel {\r\n  #movable: MovableElement;\r\n  private listenerSetter: ListenerSetter;\r\n  private previousState: MovableState;\r\n  private onResize: () => void;\r\n  private movableOptions: MovableElementOptions;\r\n  \r\n  constructor(options: {\r\n    listenerSetter: ListenerSetter,\r\n    previousState: MovableState,\r\n    onResize?: () => void,\r\n    movableOptions: MovableElementOptions\r\n  }) {\r\n    safeAssign(this, options);\r\n\r\n    this.toggleMovable(!IS_TOUCH_SUPPORTED);\r\n\r\n    this.listenerSetter.add(mediaSizes)('changeScreen', (from, to) => {\r\n      if(to === ScreenSize.mobile || from === ScreenSize.mobile) {\r\n        this.toggleMovable(!IS_TOUCH_SUPPORTED);\r\n      }\r\n    });\r\n  }\r\n\r\n  public destroy() {\r\n    const movable = this.movable;\r\n    if(movable) {\r\n      movable.destroy();\r\n    }\r\n  }\r\n\r\n  public get movable() {\r\n    return this.#movable;\r\n  }\r\n\r\n  public get state() {\r\n    return this.movable ? this.movable.state : this.previousState;\r\n  }\r\n\r\n  public set state(state: MovableState) {\r\n    this.previousState = state;\r\n  }\r\n\r\n  private toggleMovable(enabled: boolean) {\r\n    let {movable} = this;\r\n    if(enabled) {\r\n      if(movable) {\r\n        return;\r\n      }\r\n\r\n      movable = this.#movable = new MovableElement(this.movableOptions);\r\n  \r\n      movable.state = this.previousState;\r\n      if(this.previousState.top === undefined) {\r\n        movable.setPositionToCenter();\r\n      }\r\n  \r\n      if(this.onResize) {\r\n        this.listenerSetter.add(movable)('resize', this.onResize);\r\n      }\r\n    } else {\r\n      if(!movable) {\r\n        return;\r\n      }\r\n\r\n      this.previousState = movable.state;\r\n      movable.destroyElements();\r\n      movable.destroy();\r\n      this.#movable = undefined;\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function toggleClassName(className: string, elements: HTMLElement[], disable: boolean) {\r\n  elements.forEach((element) => {\r\n    element.classList.toggle(className, disable);\r\n  });\r\n\r\n  return () => toggleClassName(className, elements, !disable);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nenum CALL_STATE {\r\n  CONNECTED,\r\n  CONNECTING,\r\n  EXCHANGING_KEYS,\r\n  PENDING,\r\n  REQUESTING,\r\n  CLOSING,\r\n  CLOSED\r\n}\r\n\r\nexport default CALL_STATE;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport toHHMMSS from \"../../helpers/string/toHHMMSS\";\r\nimport CALL_STATE from \"../../lib/calls/callState\";\r\nimport { i18n, LangPackKey } from \"../../lib/langPack\";\r\n\r\nexport default class CallDescriptionElement {\r\n  private container: HTMLElement;\r\n  private state: CALL_STATE;\r\n  private interval: number;\r\n\r\n  constructor(private appendTo: HTMLElement) {\r\n    this.container = document.createElement('div');\r\n    this.container.classList.add('call-description');\r\n  }\r\n\r\n  public detach() {\r\n    if(this.interval !== undefined) {\r\n      clearInterval(this.interval);\r\n      this.interval = undefined;\r\n    }\r\n\r\n    this.container.remove();\r\n    this.state = undefined;\r\n  }\r\n\r\n  public update(instance: any) {\r\n    const {connectionState} = instance;\r\n\r\n    if(this.state === connectionState) {\r\n      return;\r\n    }\r\n\r\n    this.state = connectionState;\r\n\r\n    let element: HTMLElement;\r\n    if(connectionState === CALL_STATE.CONNECTED) {\r\n      element = document.createElement('span');\r\n      element.classList.add('call-description-duration');\r\n\r\n      const setTime = () => {\r\n        element.innerText = toHHMMSS(instance.duration, true);\r\n      };\r\n\r\n      this.interval = window.setInterval(setTime, 1000);\r\n      setTime();\r\n    } else {\r\n      let langPackKey: LangPackKey;\r\n      switch(connectionState) {\r\n        case CALL_STATE.PENDING:\r\n          langPackKey = instance.isOutgoing ? 'Call.StatusRinging' : 'Call.StatusCalling';\r\n          break;\r\n        case CALL_STATE.REQUESTING:\r\n          langPackKey = 'Call.StatusRequesting';\r\n          break;\r\n        case CALL_STATE.EXCHANGING_KEYS:\r\n          langPackKey = 'VoipExchangingKeys';\r\n          break;\r\n        case CALL_STATE.CLOSED:\r\n          langPackKey = instance.connectedAt !== undefined ? 'Call.StatusEnded' : 'Call.StatusFailed';\r\n          break;\r\n        default:\r\n          langPackKey = 'Call.StatusConnecting';\r\n          break;\r\n      }\r\n\r\n      element = i18n(langPackKey);\r\n      if(this.interval !== undefined) {\r\n        clearInterval(this.interval);\r\n        this.interval = undefined;\r\n      }\r\n    }\r\n\r\n    this.container.classList.toggle('has-duration', connectionState === CALL_STATE.CONNECTED);\r\n    replaceContent(this.container, element);\r\n\r\n    if(!this.container.parentElement) {\r\n      this.appendTo.append(this.container);\r\n    }\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { SuperRLottieIcon } from \"../superIcon\";\r\n\r\nexport default class GroupCallMicrophoneIconMini extends SuperRLottieIcon<{\r\n  PartState: boolean,\r\n  ColorState: boolean,\r\n  Items: {\r\n    name: 'voice_mini'\r\n  }[]\r\n}> {\r\n  constructor(colored?: boolean, skipAnimation?: boolean) {\r\n    super({\r\n      width: 36,\r\n      height: 36,\r\n      getPart: (state) => {\r\n        return this.getItem().getPart(state ? 'unmute' : 'mute');\r\n      },\r\n      getColor: colored ? (state) => {\r\n        return state ? [255, 255, 255] : [158, 158, 158];\r\n      } : undefined,\r\n      skipAnimation\r\n    });\r\n\r\n    this.add({\r\n      name: 'voice_mini',\r\n      parts: [{\r\n        startFrame: 0,\r\n        endFrame: 35,\r\n        name: 'hand-to-muted'\r\n      }, {\r\n        startFrame: 36,\r\n        endFrame: 68,\r\n        name: 'unmute'\r\n      }, {\r\n        startFrame: 69,\r\n        endFrame: 98,\r\n        name: 'mute'\r\n      }, {\r\n        startFrame: 99,\r\n        endFrame: 135,\r\n        name: 'muted-to-hand'\r\n      }, {\r\n        startFrame: 136,\r\n        endFrame: 171,\r\n        name: 'unmuted-to-hand'\r\n      }]\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport IS_SCREEN_SHARING_SUPPORTED from \"../../environment/screenSharingSupport\";\r\nimport { IS_MOBILE } from \"../../environment/userAgent\";\r\nimport { attachClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport ControlsHover from \"../../helpers/dom/controlsHover\";\r\nimport findUpClassName from \"../../helpers/dom/findUpClassName\";\r\nimport { addFullScreenListener, cancelFullScreen, isFullScreen, requestFullScreen } from \"../../helpers/dom/fullScreen\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport MovablePanel from \"../../helpers/movablePanel\";\r\nimport onMediaLoad from \"../../helpers/onMediaLoad\";\r\nimport themeController from \"../../helpers/themeController\";\r\nimport toggleClassName from \"../../helpers/toggleClassName\";\r\nimport CallInstance from \"../../lib/calls/callInstance\";\r\nimport CALL_STATE from \"../../lib/calls/callState\";\r\nimport I18n, { i18n } from \"../../lib/langPack\";\r\nimport wrapEmojiText from \"../../lib/richTextProcessor/wrapEmojiText\";\r\nimport animationIntersector from \"../animationIntersector\";\r\nimport AvatarElement from \"../avatar\";\r\nimport ButtonIcon from \"../buttonIcon\";\r\nimport GroupCallMicrophoneIconMini from \"../groupCall/microphoneIconMini\";\r\nimport { MovableState } from \"../movableElement\";\r\nimport PeerTitle from \"../peerTitle\";\r\nimport PopupElement from \"../popups\";\r\nimport SetTransition from \"../singleTransition\";\r\nimport makeButton from \"./button\";\r\nimport CallDescriptionElement from \"./description\";\r\nimport callVideoCanvasBlur from \"./videoCanvasBlur\";\r\n\r\nconst className = 'call';\r\n\r\nconst MIN_WIDTH = 400;\r\nconst MIN_HEIGHT = 580;\r\n\r\nconst INIT_STATE: MovableState = {\r\n  width: MIN_WIDTH,\r\n  height: MIN_HEIGHT\r\n};\r\n\r\nlet previousState: MovableState = {...INIT_STATE};\r\n\r\nexport default class PopupCall extends PopupElement {\r\n  private peerId: PeerId;\r\n\r\n  private description: CallDescriptionElement;\r\n  private emojisSubtitle: HTMLElement;\r\n  \r\n  private partyStates: HTMLElement;\r\n  private partyMutedState: HTMLElement;\r\n\r\n  private firstButtonsRow: HTMLElement;\r\n  private secondButtonsRow: HTMLElement;\r\n\r\n  private declineI18nElement: I18n.IntlElement;\r\n\r\n  private makeButton: (options: Parameters<typeof makeButton>[2]) => HTMLElement;\r\n  private btnAccept: HTMLElement;\r\n  private btnDecline: HTMLElement;\r\n  private btnVideo: HTMLElement;\r\n  private btnScreen: HTMLElement;\r\n  private btnMute: HTMLElement;\r\n  private btnFullScreen: HTMLButtonElement;\r\n  private btnExitFullScreen: HTMLButtonElement;\r\n\r\n  private movablePanel: MovablePanel;\r\n  private microphoneIcon: GroupCallMicrophoneIconMini;\r\n  private muteI18nElement: I18n.IntlElement;\r\n\r\n  private videoContainers: {\r\n    input?: HTMLElement,\r\n    output?: HTMLElement\r\n  };\r\n\r\n  private controlsHover: ControlsHover;\r\n\r\n  constructor(private instance: CallInstance) {\r\n    super('popup-call', {\r\n      withoutOverlay: true,\r\n      closable: true\r\n    });\r\n\r\n    this.videoContainers = {};\r\n\r\n    const {container, listenerSetter} = this;\r\n    container.classList.add(className, 'night');\r\n\r\n    const avatarContainer = document.createElement('div');\r\n    avatarContainer.classList.add(className + '-avatar');\r\n\r\n    const peerId = this.peerId = this.instance.interlocutorUserId.toPeerId();\r\n    const avatar = new AvatarElement();\r\n    avatar.classList.add('avatar-full');\r\n    avatar.updateWithOptions({\r\n      isBig: true,\r\n      peerId: peerId\r\n    });\r\n    avatarContainer.append(avatar);\r\n\r\n    const title = new PeerTitle({\r\n      peerId\r\n    }).element;\r\n\r\n    title.classList.add(className + '-title');\r\n\r\n    const subtitle = document.createElement('div');\r\n    subtitle.classList.add(className + '-subtitle');\r\n\r\n    const description = this.description = new CallDescriptionElement(subtitle);\r\n\r\n    const emojisSubtitle = this.emojisSubtitle = document.createElement('div');\r\n    emojisSubtitle.classList.add(className + '-emojis');\r\n\r\n    container.append(avatarContainer, title, subtitle);\r\n    \r\n    if(!IS_MOBILE) {\r\n      this.btnFullScreen = ButtonIcon('fullscreen');\r\n      this.btnExitFullScreen = ButtonIcon('smallscreen hide');\r\n      attachClickEvent(this.btnFullScreen, this.onFullScreenClick, {listenerSetter});\r\n      attachClickEvent(this.btnExitFullScreen, () => cancelFullScreen(), {listenerSetter});\r\n      addFullScreenListener(this.container, this.onFullScreenChange, listenerSetter);\r\n      this.header.prepend(this.btnExitFullScreen);\r\n      this.header.append(this.btnFullScreen);\r\n\r\n      container.append(emojisSubtitle);\r\n    } else {\r\n      this.header.append(emojisSubtitle);\r\n    }\r\n\r\n    this.partyStates = document.createElement('div');\r\n    this.partyStates.classList.add(className + '-party-states');\r\n\r\n    this.partyMutedState = document.createElement('div');\r\n    this.partyMutedState.classList.add(className + '-party-state');\r\n    const stateText = i18n('VoipUserMicrophoneIsOff', [new PeerTitle({peerId, onlyFirstName: true, limitSymbols: 18}).element]);\r\n    stateText.classList.add(className + '-party-state-text');\r\n    const mutedIcon = new GroupCallMicrophoneIconMini(false, true);\r\n    mutedIcon.setState(false, false);\r\n    this.partyMutedState.append(\r\n      mutedIcon.container, \r\n      stateText\r\n    );\r\n\r\n    this.partyStates.append(this.partyMutedState);\r\n    this.container.append(this.partyStates);\r\n\r\n    this.makeButton = makeButton.bind(null, className, this.listenerSetter);\r\n    this.constructFirstButtons();\r\n    this.constructSecondButtons();\r\n\r\n    listenerSetter.add(instance)('state', () => {\r\n      this.updateInstance();\r\n    });\r\n\r\n    listenerSetter.add(instance)('mediaState', () => {\r\n      this.updateInstance();\r\n    });\r\n\r\n    this.movablePanel = new MovablePanel({\r\n      listenerSetter,\r\n      movableOptions: {\r\n        minWidth: MIN_WIDTH,\r\n        minHeight: MIN_HEIGHT,\r\n        element: this.element,\r\n        verifyTouchTarget: (e) => {\r\n          const target = e.target;\r\n          if(findUpClassName(target, 'call-button') || \r\n            findUpClassName(target, 'btn-icon') ||\r\n            isFullScreen()) {\r\n            return false;\r\n          }\r\n\r\n          return true;\r\n        }\r\n      },\r\n      // onResize: () => this.toggleBigLayout(),\r\n      previousState: !this.instance.wasTryingToJoin && !this.instance.isOutgoing ? {...INIT_STATE} : previousState\r\n    });\r\n\r\n    const movableElement = this.movablePanel.movable;\r\n    if(movableElement) {\r\n      this.listenerSetter.add(movableElement)('resize', () => {\r\n        this.resizeVideoContainers();\r\n      });\r\n    }\r\n\r\n    const controlsHover = this.controlsHover = new ControlsHover();\r\n    controlsHover.setup({\r\n      element: this.container,\r\n      listenerSetter: this.listenerSetter,\r\n      showOnLeaveToClassName: 'call-buttons'\r\n    });\r\n    controlsHover.showControls(false);\r\n\r\n    this.addEventListener('close', () => {\r\n      const {movablePanel} = this;\r\n      previousState = movablePanel.state;\r\n\r\n      this.microphoneIcon.destroy();\r\n\r\n      movablePanel.destroy();\r\n    });\r\n\r\n    this.updateInstance();\r\n  }\r\n\r\n  public getCallInstance() {\r\n    return this.instance;\r\n  }\r\n\r\n  private constructFirstButtons() {\r\n    const buttons = this.firstButtonsRow = document.createElement('div');\r\n    buttons.classList.add(className + '-buttons', 'is-first');\r\n\r\n    const toggleDisability = toggleClassName.bind(null, 'btn-disabled');\r\n    \r\n    const btnVideo = this.btnVideo = this.makeButton({\r\n      text: 'Call.Camera',\r\n      icon: 'videocamera_filled',\r\n      callback: () => {\r\n        const toggle = toggleDisability([btnVideo, btnScreen], true);\r\n        this.instance.toggleVideoSharing().finally(toggle);\r\n      }\r\n    });\r\n\r\n    const btnScreen = this.btnScreen = this.makeButton({\r\n      text: 'Call.Screen',\r\n      icon: 'sharescreen_filled',\r\n      callback: () => {\r\n        const toggle = toggleDisability([btnVideo, btnScreen], true);\r\n        this.instance.toggleScreenSharing().finally(toggle);\r\n      }\r\n    });\r\n\r\n    if(!IS_SCREEN_SHARING_SUPPORTED) {\r\n      btnScreen.classList.add('hide');\r\n      this.container.classList.add('no-screen');\r\n    }\r\n\r\n    this.muteI18nElement = new I18n.IntlElement({\r\n      key: 'Call.Mute'\r\n    });\r\n    const btnMute = this.btnMute = this.makeButton({\r\n      text: this.muteI18nElement.element,\r\n      callback: () => {\r\n        this.instance.toggleMuted();\r\n      }\r\n    });\r\n\r\n    const microphoneIcon = this.microphoneIcon = new GroupCallMicrophoneIconMini(true, true);\r\n    btnMute.firstElementChild.append(microphoneIcon.container);\r\n\r\n    // btnVideo.classList.add('disabled');\r\n    // btnScreen.classList.add('disabled');\r\n\r\n    buttons.append(btnVideo, btnScreen, btnMute);\r\n    this.container.append(buttons);\r\n  }\r\n\r\n  private constructSecondButtons() {\r\n    const buttons = this.secondButtonsRow = document.createElement('div');\r\n    buttons.classList.add(className + '-buttons', 'is-second');\r\n    \r\n    this.declineI18nElement = new I18n.IntlElement({\r\n      key: 'Call.Decline'\r\n    });\r\n    const btnDecline = this.btnDecline = this.makeButton({\r\n      text: this.declineI18nElement.element,\r\n      icon: 'endcall_filled',\r\n      callback: () => {\r\n        this.instance.hangUp('phoneCallDiscardReasonHangup');\r\n      },\r\n      isDanger: true\r\n    });\r\n\r\n    const btnAccept = this.btnAccept = this.makeButton({\r\n      text: 'Call.Accept',\r\n      icon: 'phone_filled',\r\n      callback: () => {\r\n        this.instance.acceptCall();\r\n      },\r\n      isConfirm: true,\r\n    });\r\n\r\n    buttons.append(btnDecline, btnAccept);\r\n    this.container.append(buttons);\r\n  }\r\n\r\n  private onFullScreenClick = () => {\r\n    requestFullScreen(this.container);\r\n  };\r\n\r\n  private onFullScreenChange = () => {\r\n    const isFull = isFullScreen();\r\n\r\n    const {btnFullScreen, btnExitFullScreen} = this;\r\n\r\n    const wasFullScreen = this.container.classList.contains('is-full-screen');\r\n    this.container.classList.toggle('is-full-screen', isFull);\r\n    btnFullScreen && btnFullScreen.classList.toggle('hide', isFull);\r\n    btnExitFullScreen && btnExitFullScreen.classList.toggle('hide', !isFull);\r\n    this.btnClose.classList.toggle('hide', isFull);\r\n\r\n    if(isFull !== wasFullScreen) {\r\n      animationIntersector.checkAnimations(isFull);\r\n\r\n      themeController.setThemeColor(isFull ? '#000000' : undefined);\r\n\r\n      this.resizeVideoContainers();\r\n    }\r\n  };\r\n\r\n  private createVideoContainer(video: HTMLVideoElement) {\r\n    const _className = className + '-video';\r\n    const container = document.createElement('div');\r\n    container.classList.add(_className + '-container');\r\n\r\n    video.classList.add(_className);\r\n    if(video.paused) {\r\n      video.play();\r\n    }\r\n\r\n    attachClickEvent(container, () => {\r\n      if(!container.classList.contains('small')) {\r\n        return;\r\n      }\r\n\r\n      const big = Object.values(this.videoContainers).find((container) => !container.classList.contains('small'));\r\n      big.classList.add('small');\r\n      big.style.cssText = container.style.cssText;\r\n      container.classList.remove('small');\r\n      container.style.cssText = '';\r\n\r\n      this.resizeVideoContainers();\r\n    });\r\n\r\n    const canvas = callVideoCanvasBlur(video);\r\n    canvas.classList.add(_className + '-blur');\r\n\r\n    container.append(canvas, video);\r\n\r\n    return container;\r\n  }\r\n\r\n  private updateInstance() {\r\n    const {instance} = this;\r\n    const {connectionState} = instance;\r\n    if(connectionState === CALL_STATE.CLOSED) {\r\n      if(this.container.classList.contains('is-full-screen')) {\r\n        cancelFullScreen();\r\n      }\r\n\r\n      this.btnVideo.classList.add('disabled');\r\n\r\n      this.hide();\r\n      return;\r\n    }\r\n\r\n    const isPendingIncoming = !instance.isOutgoing && connectionState === CALL_STATE.PENDING;\r\n    this.declineI18nElement.compareAndUpdate({\r\n      key: connectionState === CALL_STATE.PENDING ? 'Call.Decline' : 'Call.End'\r\n    });\r\n    this.btnAccept.classList.toggle('disable', !isPendingIncoming);\r\n    this.btnAccept.classList.toggle('hide-me', !isPendingIncoming);\r\n    this.container.classList.toggle('two-button-rows', isPendingIncoming);\r\n\r\n    const isMuted = instance.isMuted;\r\n    const onFrame = () => {\r\n      this.btnMute.firstElementChild.classList.toggle('active', isMuted);\r\n    };\r\n\r\n    const player = this.microphoneIcon.getItem().player;\r\n    this.microphoneIcon.setState(!isMuted, !isMuted, onFrame);\r\n    if(!player) {\r\n      onFrame();\r\n    }\r\n\r\n    this.muteI18nElement.compareAndUpdate({\r\n      key: isMuted ? 'VoipUnmute' : 'Call.Mute'\r\n    });\r\n\r\n    const isSharingVideo = instance.isSharingVideo;\r\n    this.btnVideo.firstElementChild.classList.toggle('active', isSharingVideo);\r\n\r\n    const isSharingScreen = instance.isSharingScreen;\r\n    this.btnScreen.firstElementChild.classList.toggle('active', isSharingScreen);\r\n\r\n    const outputState = instance.getMediaState('output');\r\n\r\n    SetTransition(this.partyMutedState, 'is-visible', !!outputState?.muted, 300);\r\n\r\n    const containers = this.videoContainers;\r\n    const oldContainers = {...containers};\r\n    ['input' as const, 'output' as const].forEach((type) => {\r\n      const mediaState = instance.getMediaState(type);\r\n      const video = instance.getVideoElement(type) as HTMLVideoElement;\r\n\r\n      const hasFrame = !!(video && video.videoWidth && video.videoHeight);\r\n      if(video && !hasFrame && !video.dataset.hasPromise) {\r\n        video.dataset.hasPromise = '1';\r\n        // container.classList.add('hide');\r\n        onMediaLoad(video).then(() => {\r\n          delete video.dataset.hasPromise;\r\n          this.updateInstance();\r\n          // this.resizeVideoContainers();\r\n          // container.classList.remove('hide');\r\n        });\r\n      }\r\n\r\n      const isActive = !!video && hasFrame && !!(mediaState && (mediaState.videoState === 'active' || mediaState.screencastState === 'active'));\r\n      let videoContainer = containers[type];\r\n\r\n      if(isActive && video && !videoContainer) {\r\n        videoContainer = containers[type] = this.createVideoContainer(video);\r\n        this.container.append(videoContainer);\r\n      }\r\n\r\n      if(!isActive && videoContainer) {\r\n        videoContainer.remove();\r\n        delete containers[type];\r\n      }\r\n    });\r\n\r\n    {\r\n      const input = containers.input;\r\n      const output = containers.output;\r\n      if(Object.keys(oldContainers).length !== Object.keys(containers).length && input) {\r\n        input.classList.toggle('small', !!output);\r\n      }\r\n\r\n      if(output && !input) {\r\n        output.classList.remove('small');\r\n      }\r\n    }\r\n\r\n    this.resizeVideoContainers();\r\n\r\n    this.container.classList.toggle('no-video', !Object.keys(containers).length);\r\n\r\n    if(!this.emojisSubtitle.textContent && connectionState < CALL_STATE.EXCHANGING_KEYS) {\r\n      Promise.resolve(instance.getEmojisFingerprint()).then((emojis) => {\r\n        replaceContent(this.emojisSubtitle, wrapEmojiText(emojis.join('')));\r\n      });\r\n    }\r\n\r\n    this.setDescription();\r\n  }\r\n\r\n  private resizeVideoContainers() {\r\n    Object.values(this.videoContainers).forEach((container) => {\r\n      const isSmall = container.classList.contains('small');\r\n      if(isSmall) {\r\n        const video = container.querySelector('video');\r\n        const popupWidth = this.movablePanel.state;\r\n        const MAX_WIDTH_PX = 240;\r\n        const MAX_HEIGHT_PX = 240;\r\n        \r\n        const isVertical = video.videoHeight > video.videoWidth;\r\n        const MAX_SIZE = isVertical ? MAX_HEIGHT_PX : MAX_WIDTH_PX;\r\n\r\n        const biggestSideSize = 1 / 3 * (isFullScreen() ? 0xFFFF : (isVertical ? popupWidth.height : popupWidth.width));\r\n        const widthRatio = isVertical ? video.videoWidth / video.videoHeight : 1;\r\n        const heightRatio = isVertical ? 1 : video.videoHeight / video.videoWidth;\r\n        container.style.width = biggestSideSize * widthRatio + 'px';\r\n        container.style.height = biggestSideSize * heightRatio + 'px';\r\n        container.style.maxWidth = MAX_SIZE * widthRatio + 'px';\r\n        container.style.maxHeight = MAX_SIZE * heightRatio + 'px';\r\n      } else {\r\n        container.style.cssText = '';\r\n      }\r\n    });\r\n  }\r\n\r\n  private setDescription() {\r\n    this.description.update(this.instance);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport SDP from \"../sdp\";\r\nimport { CallSignalingData, P2PVideoCodec } from \"../types\";\r\nimport parseMediaSectionInfo from \"./parseMediaSectionInfo\";\r\n\r\nexport default function parseSignalingData(sdp: SDP) {\r\n  const info = parseMediaSectionInfo(sdp, sdp.media[0]);\r\n  \r\n  const data: CallSignalingData.initialSetup = {\r\n    '@type': 'InitialSetup',\r\n    fingerprints: [info.fingerprint],\r\n    ufrag: info.ufrag,\r\n    pwd: info.pwd,\r\n    audio: undefined,\r\n    video: undefined,\r\n    screencast: undefined\r\n  };\r\n  \r\n  const convertNumber = (number: number) => '' + number;\r\n  \r\n  for(const section of sdp.media) {\r\n    const mediaType = section.mediaType;\r\n    if(mediaType === 'application' || !section.isSending) {\r\n      continue;\r\n    }\r\n    \r\n    const codec: P2PVideoCodec = data[mediaType === 'video' && data['video'] ? 'screencast' : mediaType] = {} as any;\r\n    const info = parseMediaSectionInfo(sdp, section);\r\n    codec.ssrc = convertNumber(info.source);\r\n    \r\n    if(info.sourceGroups) {\r\n      codec.ssrcGroups = info.sourceGroups.map((sourceGroup) => ({semantics: sourceGroup.semantics, ssrcs: sourceGroup.sources.map(convertNumber)}));\r\n    }\r\n    \r\n    const rtpExtensions: P2PVideoCodec['rtpExtensions'] = codec.rtpExtensions = [];\r\n    section.attributes.get('extmap').forEach((attribute) => {\r\n      rtpExtensions.push({\r\n        id: +attribute.key,\r\n        uri: attribute.value\r\n      });\r\n    });\r\n    \r\n    const payloadTypesMap: Map<number, P2PVideoCodec['payloadTypes'][0]> = new Map();\r\n    \r\n    const getPayloadType = (id: number) => {\r\n      let payloadType = payloadTypesMap.get(id);\r\n      if(!payloadType) {\r\n        payloadTypesMap.set(id, payloadType = {\r\n          id\r\n        } as any);\r\n      }\r\n      \r\n      return payloadType;\r\n    };\r\n    \r\n    section.attributes.get('rtpmap').forEach((attribute) => {\r\n      const id = +attribute.key;\r\n      const payloadType = getPayloadType(id);\r\n      const splitted = attribute.value.split('/');\r\n      const [name, clockrate, channels] = splitted;\r\n      payloadType.name = name;\r\n      payloadType.clockrate = +clockrate;\r\n      payloadType.channels = channels ? +channels : 0;\r\n    });\r\n    \r\n    section.attributes.get('rtcp-fb').forEach((attribute) => {\r\n      const id = +attribute.key;\r\n      const payloadType = getPayloadType(id);\r\n      payloadType.feedbackTypes = attribute.lines.map((line) => {\r\n        const splitted = line.split(' ');\r\n        const [type, subtype] = splitted;\r\n        return {\r\n          type,\r\n          subtype: subtype || ''\r\n        };\r\n      });\r\n    });\r\n    \r\n    section.attributes.get('fmtp').forEach((attribute) => {\r\n      const id = +attribute.key;\r\n      const payloadType = getPayloadType(id);\r\n      const parameters: P2PVideoCodec['payloadTypes'][0]['parameters'] = payloadType.parameters = {};\r\n      const splitted = attribute.value.split(';');\r\n      for(const str of splitted) {\r\n        const [key, value] = str.split('=');\r\n        parameters[key] = value;\r\n      }\r\n    });\r\n    \r\n    codec.payloadTypes = Array.from(payloadTypesMap.values());\r\n\r\n    /* if(codec.payloadTypes.length > 5) {\r\n      codec.payloadTypes.length = Math.min(codec.payloadTypes.length, 5);\r\n    } */\r\n  }\r\n  \r\n  return data;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport CallConnectionInstanceBase, { CallConnectionInstanceOptions } from \"./callConnectionInstanceBase\";\r\nimport CallInstance from \"./callInstance\";\r\nimport parseSignalingData from \"./helpers/parseSignalingData\";\r\nimport { parseSdp } from \"./sdp/utils\";\r\n\r\nexport default class CallConnectionInstance extends CallConnectionInstanceBase {\r\n  private call: CallInstance;\r\n\r\n  constructor(options: CallConnectionInstanceOptions & {\r\n    call: CallConnectionInstance['call']\r\n  }) {\r\n    super(options);\r\n  }\r\n\r\n  protected async negotiateInternal() {\r\n    const {connection, call} = this;\r\n\r\n    if(!connection.localDescription && !connection.remoteDescription && !call.isOutgoing) {\r\n      return;\r\n    }\r\n\r\n    let descriptionInit: RTCSessionDescriptionInit;\r\n    if(call.offerReceived) {\r\n      call.offerReceived = false;\r\n\r\n      const answer = descriptionInit = await connection.createAnswer();\r\n\r\n      this.log('[sdp] local', answer.type, answer.sdp);\r\n      await connection.setLocalDescription(answer);\r\n\r\n      this.log('[InitialSetup] send 2');\r\n    } else {\r\n      const offer = descriptionInit = await connection.createOffer();\r\n\r\n      this.log('[sdp] local', offer.sdp);\r\n      await connection.setLocalDescription(offer);\r\n\r\n      call.offerSent = true;\r\n\r\n      this.log('[InitialSetup] send 0');\r\n    }\r\n\r\n    const initialSetup = parseSignalingData(parseSdp(descriptionInit.sdp));\r\n    call.sendCallSignalingData(initialSetup);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport AudioAssetPlayer from \"../../helpers/audioAssetPlayer\";\r\n\r\nexport type CallAudioAssetName = \"call_busy.mp3\" | \"call_connect.mp3\" | \"call_end.mp3\" | \"call_incoming.mp3\" | \"call_outgoing.mp3\" | \"voip_failed.mp3\" | \"voip_connecting.mp3\";\r\n\r\nlet audioAsset: AudioAssetPlayer<CallAudioAssetName>;\r\nexport default function getCallAudioAsset() {\r\n  return audioAsset ??= new AudioAssetPlayer([\r\n    'call_busy.mp3',\r\n    'call_connect.mp3',\r\n    'call_end.mp3',\r\n    'call_incoming.mp3',\r\n    'call_outgoing.mp3',\r\n    'voip_failed.mp3'\r\n  ]);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getCallAudioAsset, { CallAudioAssetName } from \"../../components/call/getAudioAsset\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport IS_CALL_SUPPORTED from \"../../environment/callSupport\";\r\nimport indexOfAndSplice from \"../../helpers/array/indexOfAndSplice\";\r\nimport insertInDescendSortedArray from \"../../helpers/array/insertInDescendSortedArray\";\r\nimport AudioAssetPlayer from \"../../helpers/audioAssetPlayer\";\r\nimport bytesCmp from \"../../helpers/bytes/bytesCmp\";\r\nimport EventListenerBase from \"../../helpers/eventListenerBase\";\r\nimport tsNow from \"../../helpers/tsNow\";\r\nimport { PhoneCallProtocol } from \"../../layer\";\r\nimport { CallId } from \"../appManagers/appCallsManager\";\r\nimport { AppManagers } from \"../appManagers/managers\";\r\nimport { logger } from \"../logger\";\r\nimport apiManagerProxy from \"../mtproto/mtprotoworker\";\r\nimport { NULL_PEER_ID } from \"../mtproto/mtproto_config\";\r\nimport rootScope from \"../rootScope\";\r\nimport CallInstance from \"./callInstance\";\r\nimport CALL_STATE from \"./callState\";\r\n\r\nconst CALL_REQUEST_TIMEOUT = 45e3;\r\n\r\nexport class CallsController extends EventListenerBase<{\r\n  instance: (details: {hasCurrent: boolean, instance: CallInstance}) => void,\r\n  accepting: (instance: CallInstance) => void, //  .    ,     topbarCall\r\n  incompatible: (userId: UserId) => void,\r\n}> {\r\n  private log: ReturnType<typeof logger>;\r\n  private managers: AppManagers;\r\n  private audioAsset: AudioAssetPlayer<CallAudioAssetName>;\r\n  private instances: Map<CallId, CallInstance>;\r\n  private sortedInstances: Array<CallInstance>;\r\n  private tempId: number;\r\n\r\n  public construct(managers: AppManagers) {\r\n    this.managers = managers;\r\n    this.log = logger('CC');\r\n\r\n    if(!IS_CALL_SUPPORTED) {\r\n      return;\r\n    }\r\n\r\n    this.audioAsset = getCallAudioAsset();\r\n    this.tempId = 0;\r\n    this.instances = new Map();\r\n    this.sortedInstances = [];\r\n\r\n    rootScope.addEventListener('call_update', async(call) => {\r\n      let instance = this.instances.get(call.id);\r\n\r\n      if(instance) {\r\n        instance.setPhoneCall(call);\r\n      }\r\n    \r\n      switch(call._) {\r\n        case 'phoneCallDiscarded': {\r\n          if(instance) {\r\n            instance.hangUp(call.reason?._, true);\r\n          }\r\n\r\n          break;\r\n        }\r\n\r\n        case 'phoneCallAccepted': {\r\n          if(instance) {\r\n            /* if(!this.verifyProtocolCompatibility(call.protocol)) {\r\n              instance.hangUp('phoneCallDiscardReasonDisconnect');\r\n              rootScope.dispatchEvent('call_incompatible', instance.interlocutorUserId);\r\n              break;\r\n            } */\r\n\r\n            instance.confirmCall();\r\n          }\r\n\r\n          break;\r\n        }\r\n        \r\n        case 'phoneCallRequested': {\r\n          if(!instance) {\r\n            /* if(!this.verifyProtocolCompatibility(call.protocol)) {\r\n              rootScope.dispatchEvent('call_incompatible', call.admin_id);\r\n              break;\r\n            } */\r\n\r\n            instance = this.createCallInstance({\r\n              isOutgoing: false,\r\n              interlocutorUserId: call.admin_id\r\n            });\r\n        \r\n            instance.overrideConnectionState(CALL_STATE.PENDING);\r\n            instance.setPhoneCall(call);\r\n            instance.setHangUpTimeout(CALL_REQUEST_TIMEOUT, 'phoneCallDiscardReasonMissed');\r\n          }\r\n          \r\n          break;\r\n        }\r\n\r\n        case 'phoneCall': {\r\n          if(!instance || instance.encryptionKey) {\r\n            break;\r\n          }\r\n\r\n          const g_a = instance.dh.g_a = call.g_a_or_b;\r\n          const dh = instance.dh;\r\n          const g_a_hash = await apiManagerProxy.invokeCrypto('sha256', g_a);\r\n          if(!bytesCmp(dh.g_a_hash, g_a_hash)) {\r\n            this.log.error('Incorrect g_a_hash', dh.g_a_hash, g_a_hash);\r\n            break;\r\n          }\r\n\r\n          const {key, key_fingerprint} = await this.managers.appCallsManager.computeKey(g_a, dh.b, dh.p);\r\n          if(call.key_fingerprint !== key_fingerprint) {\r\n            this.log.error('Incorrect key fingerprint', call.key_fingerprint, key_fingerprint, g_a, dh);\r\n            instance.hangUp('phoneCallDiscardReasonDisconnect');\r\n            break;\r\n          }\r\n\r\n          instance.encryptionKey = key;\r\n          instance.joinCall();\r\n\r\n          break;\r\n        }\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('call_signaling', ({callId, data}) => {\r\n      const instance = this.instances.get(callId);\r\n      if(instance?.id !== callId) {\r\n        return;\r\n      }\r\n      \r\n      instance.onUpdatePhoneCallSignalingData(data);\r\n    });\r\n  }\r\n\r\n  public get currentCall() {\r\n    return this.sortedInstances[0];\r\n  }\r\n\r\n  public getCallByUserId(userId: UserId) {\r\n    for(const [callId, instance] of this.instances) {\r\n      if(instance.interlocutorUserId === userId) {\r\n        return instance;\r\n      }\r\n    }\r\n  }\r\n\r\n  private createCallInstance(options: {\r\n    isOutgoing: boolean,\r\n    interlocutorUserId: UserId,\r\n    protocol?: PhoneCallProtocol\r\n  }) {\r\n    const call = new CallInstance({\r\n      managers: this.managers,\r\n      ...options,\r\n    });\r\n\r\n    call.addEventListener('state', (state) => {\r\n      const currentCall = this.currentCall;\r\n      if(state === CALL_STATE.CLOSED) {\r\n        this.instances.delete(call.id);\r\n        indexOfAndSplice(this.sortedInstances, call);\r\n      } else {\r\n        insertInDescendSortedArray(this.sortedInstances, call, 'sortIndex');\r\n      }\r\n\r\n      if(state === CALL_STATE.EXCHANGING_KEYS) {\r\n        call.wasTryingToJoin = true;\r\n      }\r\n\r\n      const hasConnected = call.connectedAt !== undefined;\r\n      if(state === CALL_STATE.EXCHANGING_KEYS || (state === CALL_STATE.CONNECTING && hasConnected)) {\r\n        call.setHangUpTimeout(CALL_REQUEST_TIMEOUT, 'phoneCallDiscardReasonDisconnect');\r\n      } else {\r\n        call.clearHangUpTimeout();\r\n      }\r\n\r\n      if(currentCall === call || !currentCall) {\r\n        if(state === CALL_STATE.CLOSED) {\r\n          if(!call.isOutgoing && !call.wasTryingToJoin) { // incoming call has been accepted on other device or ended\r\n            this.audioAsset.stopSound();\r\n          } else if(call.wasTryingToJoin && !hasConnected) { // something has happened during the key exchanging\r\n            this.audioAsset.playSound('voip_failed.mp3');\r\n          } else {\r\n            this.audioAsset.playSound(call.discardReason === 'phoneCallDiscardReasonBusy' ? 'call_busy.mp3' : 'call_end.mp3');\r\n          }\r\n        } else if(state === CALL_STATE.PENDING) {\r\n          this.audioAsset.playSound(call.isOutgoing ? 'call_outgoing.mp3' : 'call_incoming.mp3', true);\r\n        } else if(state === CALL_STATE.EXCHANGING_KEYS) {\r\n          this.audioAsset.playSoundIfDifferent('call_connect.mp3');\r\n        } else if(state === CALL_STATE.CONNECTING) {\r\n          if(call.duration) {\r\n            this.audioAsset.playSound('voip_connecting.mp3', true);\r\n          }\r\n        } else {\r\n          this.audioAsset.stopSound();\r\n        }\r\n      }\r\n    });\r\n\r\n    call.addEventListener('id', (id, prevId) => {\r\n      if(prevId !== undefined) {\r\n        this.instances.delete(prevId);\r\n      }\r\n\r\n      const hasCurrent = !!this.currentCall;\r\n      this.instances.set(id, call);\r\n\r\n      if(prevId === undefined) {\r\n        this.dispatchEvent('instance', {instance: call, hasCurrent: hasCurrent});\r\n      }\r\n    });\r\n\r\n    return call;\r\n  }\r\n\r\n  public async startCallInternal(userId: UserId, isVideo: boolean) {\r\n    this.log('p2pStartCallInternal', userId, isVideo);\r\n    \r\n    const fullInfo = await this.managers.appProfileManager.getProfile(userId);\r\n    if(!fullInfo) return;\r\n    \r\n    const {video_calls_available} = fullInfo.pFlags;\r\n    \r\n    const call = this.createCallInstance({\r\n      isOutgoing: true,\r\n      interlocutorUserId: userId\r\n    });\r\n\r\n    call.requestInputSource(true, !!(isVideo && video_calls_available), false);\r\n\r\n    call.overrideConnectionState(CALL_STATE.REQUESTING);\r\n    call.setPhoneCall({\r\n      _: 'phoneCallWaiting',\r\n      access_hash: '',\r\n      admin_id: NULL_PEER_ID,\r\n      date: tsNow(true),\r\n      id: --this.tempId,\r\n      participant_id: userId,\r\n      protocol: call.protocol,\r\n      pFlags: {\r\n        video: isVideo || undefined\r\n      }\r\n    });\r\n\r\n    // return;\r\n    this.managers.appCallsManager.generateDh().then(async(dh) => {\r\n      call.dh = dh;\r\n\r\n      return this.managers.appCallsManager.requestCall(userId, call.protocol, call.dh.g_a_hash, isVideo && video_calls_available);\r\n    }).then((phoneCall) => {\r\n      call.overrideConnectionState(CALL_STATE.PENDING);\r\n      call.setPhoneCall(phoneCall);\r\n      call.setHangUpTimeout(CALL_REQUEST_TIMEOUT, 'phoneCallDiscardReasonHangup');\r\n    });\r\n  }\r\n}\r\n\r\nconst callsController = new CallsController();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.callsController = callsController);\r\nexport default callsController;\r\n","const subtle = typeof(window) !== 'undefined' && 'crypto' in window ? window.crypto.subtle : self.crypto.subtle;\r\n\r\nexport default subtle;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport bufferConcats from '../../../helpers/bytes/bufferConcats';\r\nimport subtle from '../../crypto/subtle';\r\nimport sha256 from '../../crypto/utils/sha256';\r\n\r\nconst kMaxIncomingPacketSize = 128 * 1024 * 1024;\r\n\r\nexport default class P2PEncryptor {\r\n  private type: 'Signaling';\r\n  private counter: number;\r\n  private seqMap: Map<number, number>;\r\n  \r\n  constructor(private isOutgoing: boolean, private p2pKey: Uint8Array) {\r\n    this.type = 'Signaling';\r\n    this.counter = 0;\r\n    this.seqMap = new Map();\r\n  }\r\n  \r\n  private concatSHA256(parts: Uint8Array[]) {\r\n    return sha256(bufferConcats(...parts));\r\n  }\r\n  \r\n  private async encryptPrepared(buffer: Uint8Array) {\r\n    const result = {\r\n      counter: 0, //this.counterFromSeq(this.readSeq(buffer)),\r\n      bytes: new Uint8Array(16 + buffer.length)\r\n    };\r\n    \r\n    const x = (this.isOutgoing ? 0 : 8) + (this.type === 'Signaling' ? 128 : 0);\r\n    const key = this.p2pKey;\r\n    \r\n    const msgKeyLarge = await this.concatSHA256([key.subarray(x + 88, x + 88 + 32), buffer]);\r\n    const msgKey = result.bytes;\r\n    for(let i = 0; i < 16; ++i) {\r\n      msgKey[i] = msgKeyLarge[i + 8];\r\n    }\r\n    \r\n    const aesKeyIv = await this.prepareAesKeyIv(key, msgKey, x);\r\n    \r\n    const bytes = await this.aesProcessCtr(buffer, buffer.length, aesKeyIv, true);\r\n    \r\n    result.bytes = new Uint8Array([...result.bytes.subarray(0, 16), ...bytes]);\r\n    \r\n    return result;\r\n  }\r\n  \r\n  public encryptRawPacket(buffer: Uint8Array) {\r\n    const seq = ++this.counter;\r\n    const arr = new ArrayBuffer(4);\r\n    const view = new DataView(arr);\r\n    view.setUint32(0, seq >>> 0, false); // byteOffset = 0; litteEndian = false\r\n    \r\n    const result = new Uint8Array([...new Uint8Array(arr), ...buffer]);\r\n    \r\n    return this.encryptPrepared(result);\r\n  }\r\n  \r\n  private async prepareAesKeyIv(key: Uint8Array, msgKey: Uint8Array, x: number) {\r\n    const [sha256a, sha256b] = await Promise.all([\r\n      this.concatSHA256([\r\n        msgKey.subarray(0, 16),\r\n        key.subarray(x, x + 36)\r\n      ]),\r\n\r\n      this.concatSHA256([\r\n        key.subarray(40 + x, 40 + x + 36),\r\n        msgKey.subarray(0, 16)\r\n      ])\r\n    ]);\r\n    \r\n    return {\r\n      key: new Uint8Array([\r\n        ...sha256a.subarray(0, 8),\r\n        ...sha256b.subarray(8, 8 + 16),\r\n        ...sha256a.subarray(24, 24 + 8)\r\n      ]),\r\n      iv: new Uint8Array([\r\n        ...sha256b.subarray(0, 4),\r\n        ...sha256a.subarray(8, 8 + 8),\r\n        ...sha256b.subarray(24, 24 + 4)\r\n      ])\r\n    };\r\n  }\r\n  \r\n  private async aesProcessCtr(encryptedData: Uint8Array, dataSize: number, aesKeyIv: {key: Uint8Array, iv: Uint8Array}, encrypt = true) {\r\n    const cryptoKey = await subtle.importKey(\r\n      'raw',\r\n      aesKeyIv.key,\r\n      {name: 'AES-CTR'},\r\n      false,\r\n      [encrypt ? 'encrypt' : 'decrypt']\r\n    );\r\n    \r\n    const buffer: ArrayBuffer = await subtle[encrypt ? 'encrypt' : 'decrypt']({\r\n        name: 'AES-CTR',\r\n        counter: aesKeyIv.iv,\r\n        length: aesKeyIv.iv.length * 8\r\n      },\r\n      cryptoKey,\r\n      encryptedData\r\n    );\r\n\r\n    return new Uint8Array(buffer);\r\n  }\r\n  \r\n  private constTimeIsDifferent(a: Uint8Array, b: Uint8Array, count: number) {\r\n    let msgKeyEquals = true;\r\n    for(let i = 0; i < count; ++i) {\r\n      if(a[i] !== b[i]) {\r\n        msgKeyEquals = false;\r\n      }\r\n    }\r\n    \r\n    return !msgKeyEquals;\r\n  }\r\n  \r\n  public async decryptRawPacket(buffer: Uint8Array) {\r\n    if(buffer.length < 21 || buffer.length > kMaxIncomingPacketSize) {\r\n      return;\r\n    }\r\n    \r\n    const {isOutgoing, type} = this;\r\n    \r\n    const x = (isOutgoing ? 8 : 0) + (type === 'Signaling' ? 128 : 0);\r\n    const key = this.p2pKey;\r\n    \r\n    const msgKey = buffer.subarray(0, 16);\r\n    const encryptedData = buffer.subarray(16);\r\n    const encryptedDataSize = buffer.length - 16;\r\n    \r\n    const aesKeyIv = await this.prepareAesKeyIv(key, msgKey, x);\r\n    \r\n    const decryptionBuffer = await this.aesProcessCtr(encryptedData, encryptedDataSize, aesKeyIv, false);\r\n    \r\n    const msgKeyLarge = await this.concatSHA256([\r\n      key.subarray(88 + x, 88 + x + 32),\r\n      decryptionBuffer\r\n    ]);\r\n    \r\n    if(this.constTimeIsDifferent(msgKeyLarge.subarray(8), msgKey, 16)) {\r\n      return;\r\n    }\r\n    \r\n    const dataView = new DataView(decryptionBuffer.buffer);\r\n    const seq = dataView.getUint32(0);\r\n    if(this.seqMap.has(seq)) {\r\n      return;\r\n    }\r\n    this.seqMap.set(seq, seq);\r\n    \r\n    return decryptionBuffer.slice(4);\r\n  }\r\n}\r\n","import convertToUint8Array from \"../../../helpers/bytes/convertToUint8Array\";\r\nimport subtle from \"../subtle\";\r\n//import sha256 from '@cryptography/sha256';\r\n\r\nexport default function sha256(bytes: Parameters<typeof convertToUint8Array>[0]) {\r\n  return subtle.digest('SHA-256', convertToUint8Array(bytes)).then((b) => {\r\n    //console.log('legacy', performance.now() - perfS);\r\n    return new Uint8Array(b);\r\n  });\r\n  /* //console.log('SHA-256 hash start');\r\n\r\n  let perfS = performance.now();\r\n  \r\n\r\n  let perfD = performance.now();\r\n  let words = typeof(bytes) === 'string' ? bytes : bytesToWordss(bytes as any);\r\n  let hash = sha256(words);\r\n  console.log('darutkin', performance.now() - perfD);\r\n\r\n  //console.log('SHA-256 hash finish', hash, sha256(words, 'hex'));\r\n\r\n  return bytesFromWordss(hash); */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport StringFromLineBuilder from '../stringFromLineBuilder';\r\nimport { addDataChannel, addExtmap, addPayloadTypes, addSsrc } from './p2PSdpBuilder';\r\n\r\nexport default class ChromeP2PSdpBuilder {\r\n  static generateOffer(info: any) {\r\n    const {fingerprints, ufrag, pwd, audio, video} = info;\r\n    audio.type = 'audio';\r\n    video.type = 'video';\r\n    const media = [audio, video];\r\n\r\n    const stringBuilder = new StringFromLineBuilder();\r\n    stringBuilder.add(\r\n      'v=0', \r\n      'o=- 1 2 IN IP4 127.0.0.1',\r\n      's=-',\r\n      't=0 0'\r\n    );\r\n\r\n    if(fingerprints) {\r\n      fingerprints.forEach((x: any) => {\r\n        const {hash, fingerprint, setup} = x;\r\n        stringBuilder.add(\r\n          `a=fingerprint:${hash} ${fingerprint}`, \r\n          `a=setup:${setup}`\r\n        );\r\n      });\r\n    }\r\n    if(ufrag && pwd) {\r\n      stringBuilder.add(\r\n        `a=ice-ufrag:${ufrag}`,\r\n        `a=ice-pwd:${pwd}`\r\n      );\r\n    }\r\n\r\n    stringBuilder.add(\r\n      'a=group:BUNDLE 0 1 2', \r\n      'a=extmap-allow-mixed', \r\n      'a=msid-semantic: WMS *'\r\n    );\r\n    const streamName = 'stream' + media.map((x) => x.ssrc).join('_');\r\n    for(let i = 0; i < media.length; i++) {\r\n      const m = media[i];\r\n      const {type, ssrc, ssrcGroups, payloadTypes, rtpExtensions} = m;\r\n      switch(type) {\r\n        case 'audio': {\r\n          stringBuilder.add(\r\n            `m=audio 56930 UDP/TLS/RTP/SAVPF ${payloadTypes.map((x: any) => x.id).join(' ')}`,\r\n            'c=IN IP4 0.0.0.0',\r\n            'a=rtcp:9 IN IP4 0.0.0.0',\r\n            'a=ice-options:trickle',\r\n            `a=mid:${i}`,\r\n            'a=sendrecv',\r\n            addExtmap(rtpExtensions)\r\n          );\r\n          if(ssrc) {\r\n            stringBuilder.add(`a=msid:${streamName} audio${ssrc}`);\r\n          }\r\n          stringBuilder.add(\r\n            'a=rtcp-mux',\r\n            addPayloadTypes(payloadTypes),\r\n            addSsrc(type, ssrc, ssrcGroups, streamName)\r\n          );\r\n\r\n          break;\r\n        }\r\n\r\n        case 'video': {\r\n          stringBuilder.add(\r\n            `m=video 61986 UDP/TLS/RTP/SAVPF ${payloadTypes.map((x: any) => x.id).join(' ')}`,\r\n            'c=IN IP4 0.0.0.0',\r\n            'a=rtcp:9 IN IP4 0.0.0.0',\r\n            'a=ice-options:trickle',\r\n            `a=mid:${i}`,\r\n            'a=sendrecv',\r\n            addExtmap(rtpExtensions)\r\n          );\r\n          if(ssrc) {\r\n            stringBuilder.add(`a=msid:${streamName} video${ssrc}`);\r\n          }\r\n          stringBuilder.add(\r\n            'a=rtcp-mux', \r\n            'a=rtcp-rsize',\r\n            addPayloadTypes(payloadTypes),\r\n            addSsrc(type, ssrc, ssrcGroups, streamName)\r\n          );\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    stringBuilder.add(addDataChannel(2));\r\n    return stringBuilder.finalize();\r\n  }\r\n\r\n  static generateAnswer(info: any) {\r\n    const {fingerprints, ufrag, pwd, audio, video} = info;\r\n    audio.type = 'audio';\r\n    video.type = 'video';\r\n    const media = [audio, video];\r\n\r\n    const stringBuilder = new StringFromLineBuilder();\r\n    stringBuilder.add(\r\n      'v=0',\r\n      'o=- 1 2 IN IP4 127.0.0.1',\r\n      's=-',\r\n      't=0 0',\r\n    );\r\n\r\n    if(fingerprints) {\r\n      fingerprints.forEach((x: any) => {\r\n        const {hash, fingerprint, setup} = x;\r\n        stringBuilder.add(\r\n          `a=fingerprint:${hash} ${fingerprint}`,\r\n          `a=setup:${setup}`\r\n        );\r\n      });\r\n    }\r\n    if(ufrag && pwd) {\r\n      stringBuilder.add(\r\n        `a=ice-ufrag:${ufrag}`,\r\n        `a=ice-pwd:${pwd}`\r\n      );\r\n    }\r\n\r\n    stringBuilder.add(\r\n      'a=group:BUNDLE 0 1 2',\r\n      'a=extmap-allow-mixed',\r\n      'a=msid-semantic: WMS *'\r\n    );\r\n    const streamName = 'stream' + media.map((x) => x.ssrc).join('_');\r\n    for(let i = 0; i < media.length; i++) {\r\n      const m = media[i];\r\n      const {type, ssrc, ssrcGroups, payloadTypes, rtpExtensions} = m;\r\n      switch(type) {\r\n        case 'audio': {\r\n          stringBuilder.add(\r\n            `m=audio 56930 UDP/TLS/RTP/SAVPF ${payloadTypes.map((x: any) => x.id).join(' ')}`,\r\n            'c=IN IP4 0.0.0.0',\r\n            'a=rtcp:9 IN IP4 0.0.0.0',\r\n            'a=ice-options:trickle',\r\n            `a=mid:${i}`,\r\n            'a=sendrecv',\r\n            addExtmap(rtpExtensions)\r\n          );\r\n          if(ssrc) {\r\n            stringBuilder.add(`a=msid:${streamName} audio${ssrc}`);\r\n          }\r\n          stringBuilder.add(\r\n            'a=rtcp-mux',\r\n            addPayloadTypes(payloadTypes),\r\n            addSsrc(type, ssrc, ssrcGroups, streamName)\r\n          );\r\n          break;\r\n        }\r\n\r\n        case 'video': {\r\n          stringBuilder.add(\r\n            `m=video 61986 UDP/TLS/RTP/SAVPF ${payloadTypes.map((x: any) => x.id).join(' ')}`,\r\n            'c=IN IP4 0.0.0.0',\r\n            'a=rtcp:9 IN IP4 0.0.0.0',\r\n            'a=ice-options:trickle',\r\n            `a=mid:${i}`,\r\n            'a=sendrecv',\r\n            addExtmap(rtpExtensions)\r\n          );\r\n          if(ssrc) {\r\n            stringBuilder.add(`a=msid:${streamName} video${ssrc}`);\r\n          }\r\n\r\n          stringBuilder.add(\r\n            'a=rtcp-mux',\r\n            'a=rtcp-rsize',\r\n            addPayloadTypes(payloadTypes),\r\n            addSsrc(type, ssrc, ssrcGroups, streamName)\r\n          );\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    stringBuilder.add(addDataChannel(2));\r\n    return stringBuilder.finalize();\r\n  }\r\n}\r\n","/*\r\n*  Copyright (c) 2018-present, Evgeny Nadymov\r\n*\r\n* This source code is licensed under the GPL v.3.0 license found in the\r\n* LICENSE file in the root directory of this source tree.\r\n*/\r\n\r\nimport ChromeP2PSdpBuilder from './chromeP2PSdpBuilder';\r\nimport { FirefoxP2PSdpBuilder } from './firefoxP2PSdpBuilder';\r\nimport { SafariP2PSdpBuilder } from './safariP2PSdpBuilder';\r\n// import { TG_CALLS_SDP_STRING } from '../../Stores/CallStore';\r\n\r\nexport function p2pParseCandidate(candidate) {\r\n  if(!candidate || !candidate.startsWith('candidate:')) {\r\n    return;\r\n  }\r\n  \r\n  const sdpString = candidate;\r\n  candidate = candidate.substr('candidate:'.length);\r\n  \r\n  const [foundation, component, protocol, priority, ip, port, ...other] = candidate.split(' ');\r\n  const c = {\r\n    sdpString,\r\n    foundation,\r\n    component,\r\n    protocol,\r\n    priority,\r\n    address: { ip, port }\r\n  };\r\n  \r\n  for(let i = 0; i < other.length; i += 2) {\r\n    switch(other[i]) {\r\n      case 'typ': {\r\n        c.type = other[i + 1];\r\n        break;\r\n      }\r\n      case 'raddr': {\r\n        if(!c.relAddress) {\r\n          c.relAddress = {};\r\n        }\r\n        \r\n        c.relAddress.ip = other[i + 1];\r\n        break;\r\n      }\r\n      case 'rport': {\r\n        if(!c.relAddress) {\r\n          c.relAddress = {};\r\n        }\r\n        \r\n        c.relAddress.port = other[i + 1];\r\n        break;\r\n      }\r\n      case 'generation': {\r\n        c.generation = other[i + 1];\r\n        break;\r\n      }\r\n      case 'tcptype': {\r\n        c.tcpType = other[i + 1];\r\n        break;\r\n      }\r\n      case 'network-id': {\r\n        c.networkId = other[i + 1];\r\n        break;\r\n      }\r\n      case 'network-cost': {\r\n        c.networkCost = other[i + 1];\r\n        break;\r\n      }\r\n      case 'ufrag': {\r\n        c.username = other[i + 1];\r\n        break;\r\n      }\r\n    }\r\n  }\r\n  \r\n  return c;\r\n}\r\n\r\nexport function p2pParseSdp(sdp) {\r\n  const lines = sdp.split('\\r\\n');\r\n  const lookup = (prefix, force = true, lineFrom = 0, lineTo = Number.MAX_VALUE) => {\r\n    if (lineTo === -1) {\r\n      lineTo = Number.MAX_VALUE;\r\n    }\r\n    for (let i = lineFrom; i < lines.length && i < lineTo; i++) {\r\n      const line = lines[i];\r\n      if (line.startsWith(prefix)) {\r\n        return line.substr(prefix.length);\r\n      }\r\n    }\r\n    \r\n    if (force) {\r\n      console.error(\"Can't find prefix\", prefix);\r\n    }\r\n    \r\n    return null;\r\n  };\r\n  const findIndex = (prefix, lineFrom = 0, lineTo = Number.MAX_VALUE) => {\r\n    if (lineTo === -1) {\r\n      lineTo = Number.MAX_VALUE;\r\n    }\r\n    for (let i = lineFrom; i < lines.length && i < lineTo; i++) {\r\n      const line = lines[i];\r\n      if (line.startsWith(prefix)) {\r\n        return i;\r\n      }\r\n    }\r\n    \r\n    return -1;\r\n  };\r\n  \r\n  const pwdIndex = findIndex('a=ice-pwd:');\r\n  const ufragIndex = findIndex('a=ice-ufrag:');\r\n  if (pwdIndex === -1 && ufragIndex === -1) {\r\n    return {\r\n      // sessionId: lookup('o=').split(' ')[1],\r\n      ufrag: null,\r\n      pwd: null,\r\n      fingerprints: []\r\n    };\r\n  }\r\n  \r\n  const info = {\r\n    // sessionId: lookup('o=').split(' ')[1],\r\n    ufrag: null,\r\n    pwd: null,\r\n    fingerprints: []\r\n  };\r\n  \r\n  let mediaIndex = findIndex('m=');\r\n  const fingerprint = lookup('a=fingerprint:', false);\r\n  const setup = lookup('a=setup:', false);\r\n  if (fingerprint && setup) {\r\n    info.fingerprints.push({\r\n      hash: fingerprint.split(' ')[0],\r\n      fingerprint: fingerprint.split(' ')[1],\r\n      setup\r\n    });\r\n  }\r\n  \r\n  const ufrag = lookup('a=ice-ufrag:', false);\r\n  const pwd = lookup('a=ice-pwd:', false);\r\n  if (ufrag && pwd) {\r\n    info.ufrag = ufrag;\r\n    info.pwd = pwd;\r\n  }\r\n  \r\n  while (mediaIndex !== -1) {\r\n    let nextMediaIndex = findIndex('m=', mediaIndex + 1);\r\n    \r\n    const extmap = [];\r\n    const types = [];\r\n    const mediaType = lookup('m=', true, mediaIndex, nextMediaIndex).split(' ')[0];\r\n    const media = {\r\n      // type: lookup('m=', true, mediaIndex, nextMediaIndex).split(' ')[0],\r\n      // mid: lookup('a=mid:', true, mediaIndex, nextMediaIndex),\r\n      // dir: findDirection(mediaIndex, nextMediaIndex),\r\n      rtpExtensions: extmap,\r\n      payloadTypes: types\r\n    }\r\n    \r\n    const lineTo = nextMediaIndex === -1 ? lines.length : nextMediaIndex;\r\n    const fmtp = new Map();\r\n    const rtcpFb = new Map();\r\n    for (let i = mediaIndex; i < lineTo; i++) {\r\n      const line = lines[i];\r\n      if (line.startsWith('a=extmap:')) {\r\n        const [ id, uri ] = line.substr('a=extmap:'.length).split(' ');\r\n        extmap.push({ id: parseInt(id), uri });\r\n      } else if (line.startsWith('a=fmtp:')) {\r\n        const [ id, str ] = line.substr('a=fmtp:'.length).split(' ');\r\n        const obj = { };\r\n        const arr =  str.split(';').map(x => {\r\n          const [ key, value ] = x.split('=');\r\n          obj[key] = value;\r\n          return { [key]: value };\r\n        });\r\n        fmtp.set(parseInt(id), obj);\r\n      } else if (line.startsWith('a=rtcp-fb:')) {\r\n        const [ id, type = '', subtype = '' ] = line.substr('a=rtcp-fb:'.length).split(' ');\r\n        if (rtcpFb.has(parseInt(id))) {\r\n          rtcpFb.get(parseInt(id)).push({ type, subtype });\r\n        } else {\r\n          rtcpFb.set(parseInt(id), [{ type, subtype }])\r\n        }\r\n      } else if (line.startsWith('a=rtpmap')) {\r\n        const [ id, str ] = line.substr('a=rtpmap:'.length).split(' ');\r\n        const [ name, clockrate, channels = '0' ] = str.split('/');\r\n        const obj = { id: parseInt(id), name, clockrate: parseInt(clockrate), channels: parseInt(channels) };\r\n        \r\n        types.push(obj);\r\n      }\r\n    }\r\n    \r\n    for (let i = 0; i < types.length; i++) {\r\n      const { id } = types[i];\r\n      if (rtcpFb.has(id)) {\r\n        types[i].feedbackTypes = rtcpFb.get(id);\r\n      }\r\n      if (fmtp.has(id)) {\r\n        types[i].parameters = fmtp.get(id);\r\n      }\r\n    }\r\n    \r\n    const ssrc = lookup('a=ssrc:', false, mediaIndex, nextMediaIndex);\r\n    if (ssrc) {\r\n      media.ssrc = ssrc.split(' ')[0];\r\n    }\r\n    \r\n    const ssrcGroup = lookup('a=ssrc-group:', false, mediaIndex, nextMediaIndex);\r\n    if (ssrcGroup) {\r\n      const [ semantics, ...ssrcs ] = ssrcGroup.split(' ');\r\n      media.ssrcGroups = [{\r\n        semantics,\r\n        ssrcs\r\n      }]\r\n    }\r\n    \r\n    switch (mediaType) {\r\n      case 'audio': {\r\n        info.audio = media;\r\n        break;\r\n      }\r\n      case 'video': {\r\n        info.video = media;\r\n        break;\r\n      }\r\n    }\r\n    \r\n    mediaIndex = nextMediaIndex;\r\n  }\r\n\r\n  if(!info.video.ssrcGroups) {\r\n    info.video.ssrcGroups = [];\r\n  }\r\n\r\n  info['@type'] = 'InitialSetup';\r\n  \r\n  // console.log('[p2pParseSdp]', sdp, info);\r\n  return info;\r\n}\r\n\r\nexport function isFirefox() {\r\n  return navigator.userAgent.toLowerCase().indexOf('firefox') > -1;\r\n}\r\n\r\nfunction isSafari() {\r\n  return navigator.userAgent.toLowerCase().indexOf('safari') > -1 && navigator.userAgent.toLowerCase().indexOf('chrome') === -1;\r\n}\r\n\r\nexport function addExtmap(extmap) {\r\n  let sdp = [];\r\n  // return sdp;\r\n  for (let j = 0; j < extmap.length; j++) {\r\n    const ext = extmap[j];\r\n    const { id, uri } = ext;\r\n    // if (isFirefox() && uri.indexOf(''))\r\n    console.log('[extmap] add', id, uri);\r\n    sdp.push(`a=extmap:${id} ${uri}`);\r\n  }\r\n  \r\n  return sdp.join('\\n');\r\n}\r\n\r\nexport function addPayloadTypes(types) {\r\n  let sdp = [];\r\n  console.log('[SDP] addPayloadTypes', types);\r\n  for (let i = 0; i < types.length; i++) {\r\n    const type = types[i];\r\n    const { id, name, clockrate, channels, feedbackTypes, parameters } = type;\r\n    sdp.push(`a=rtpmap:${id} ${name}/${clockrate}${channels ? '/' + channels : ''}`);\r\n    if (feedbackTypes) {\r\n      feedbackTypes.forEach(x => {\r\n        const { type, subtype } = x;\r\n        sdp.push(`a=rtcp-fb:${id} ${[type, subtype].join(' ')}`);\r\n      });\r\n    }\r\n    if (parameters) {\r\n      const fmtp = [];\r\n      Object.getOwnPropertyNames(parameters).forEach(pName => {\r\n        fmtp.push(`${pName}=${parameters[pName]}`);\r\n      });\r\n      \r\n      sdp.push(`a=fmtp:${id} ${fmtp.join(';')}`);\r\n    }\r\n  }\r\n  \r\n  return sdp.join('\\n');\r\n}\r\n\r\nexport function addSsrc(type, ssrc, ssrcGroups, streamName) {\r\n  let sdp = [];\r\n  \r\n  if (ssrcGroups && ssrcGroups.length > 0) {\r\n    ssrcGroups.forEach(ssrcGroup => {\r\n      if (ssrcGroup && ssrcGroup.ssrcs.length > 0) {\r\n        sdp.push(`a=ssrc-group:${ssrcGroup.semantics} ${ssrcGroup.ssrcs.join(' ')}`);\r\n        ssrcGroup.ssrcs.forEach(ssrc => {\r\n          sdp.push(\r\n            `a=ssrc:${ssrc} cname:stream${ssrc}`,\r\n            `a=ssrc:${ssrc} msid:${streamName} ${type}${ssrc}`,\r\n            `a=ssrc:${ssrc} mslabel:${type}${ssrc}`,\r\n            `a=ssrc:${ssrc} label:${type}${ssrc}`\r\n          );\r\n        });\r\n      }\r\n    });\r\n  } else if (ssrc) {\r\n    sdp.push(\r\n      `a=ssrc:${ssrc} cname:stream${ssrc}`,\r\n      `a=ssrc:${ssrc} msid:${streamName} ${type}${ssrc}`,\r\n      `a=ssrc:${ssrc} mslabel:${type}${ssrc}`,\r\n      `a=ssrc:${ssrc} label:${type}${ssrc}`\r\n    );\r\n  }\r\n  \r\n  return sdp.join('\\n');\r\n}\r\n\r\nexport function addDataChannel(mid) {\r\n  return `m=application 9 UDP/DTLS/SCTP webrtc-datachannel\r\nc=IN IP4 0.0.0.0\r\na=ice-options:trickle\r\na=mid:2\r\na=sctp-port:5000\r\na=max-message-size:262144`;\r\n}\r\n\r\nexport class P2PSdpBuilder {\r\n  static generateCandidate(info) {\r\n    if (!info) return null;\r\n    \r\n    const { sdpString, sdpMLineIndex, sdpMid, foundation, component, protocol, priority, address, type, relAddress, generation, tcpType, networkId, networkCost, username } = info;\r\n    if (/* TG_CALLS_SDP_STRING */true) {\r\n      if (sdpString) {\r\n        return {\r\n          candidate: sdpString,\r\n          sdpMLineIndex,\r\n          sdpMid\r\n        };\r\n      }\r\n    }\r\n    throw 'no sdpString';\r\n    \r\n    let candidate = `candidate:${foundation} ${component} ${protocol} ${priority} ${address.ip} ${address.port}`;\r\n    const attrs = []\r\n    if (type) {\r\n      attrs.push(`typ ${type}`);\r\n    }\r\n    if (relAddress) {\r\n      attrs.push(`raddr ${relAddress.ip}`);\r\n      attrs.push(`rport ${relAddress.port}`);\r\n    }\r\n    if (tcpType) {\r\n      attrs.push(`tcptype ${tcpType}`);\r\n    }\r\n    if (generation) {\r\n      attrs.push(`generation ${generation}`);\r\n    }\r\n    if (username) {\r\n      attrs.push(`ufrag ${username}`);\r\n    }\r\n    if (networkId) {\r\n      attrs.push(`network-id ${networkId}`);\r\n    }\r\n    if (networkCost) {\r\n      attrs.push(`network-cost ${networkCost}`);\r\n    }\r\n    if (attrs.length > 0) {\r\n      candidate += ` ${attrs.join(' ')}`;\r\n    }\r\n    \r\n    return { candidate, sdpMid, sdpMLineIndex };\r\n  }\r\n  \r\n  static generateOffer(info) {\r\n    if (isFirefox()) {\r\n      return FirefoxP2PSdpBuilder.generateOffer(info);\r\n    } else if (isSafari()) {\r\n      return SafariP2PSdpBuilder.generateOffer(info);\r\n    }\r\n    \r\n    return ChromeP2PSdpBuilder.generateOffer(info);\r\n  }\r\n  \r\n  static generateAnswer(info) {\r\n    if (isFirefox()) {\r\n      return FirefoxP2PSdpBuilder.generateAnswer(info);\r\n    } else if (isSafari()) {\r\n      return SafariP2PSdpBuilder.generateAnswer(info);\r\n    }\r\n    \r\n    return ChromeP2PSdpBuilder.generateAnswer(info);\r\n  }\r\n}","/*\r\n *  Copyright (c) 2018-present, Evgeny Nadymov\r\n *\r\n * This source code is licensed under the GPL v.3.0 license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n */\r\n\r\nimport { addDataChannel, addExtmap, addPayloadTypes, addSsrc } from './p2PSdpBuilder';\r\n\r\nexport class FirefoxP2PSdpBuilder {\r\n    static generateOffer(info) {\r\n        const { fingerprints, ufrag, pwd, audio, video } = info;\r\n        audio.type = 'audio';\r\n        video.type = 'video';\r\n        const media = [audio, video];\r\n\r\n        let sdp = `v=0\r\no=- 1 0 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0`;\r\n        if (fingerprints) {\r\n            fingerprints.forEach(x => {\r\n                const { hash, fingerprint, setup } = x;\r\n                sdp += `\r\na=fingerprint:${hash} ${fingerprint}\r\na=setup:${setup}`;\r\n            });\r\n        }\r\n        if (ufrag && pwd) {\r\n            sdp += `\r\na=ice-ufrag:${ufrag}\r\na=ice-pwd:${pwd}`;\r\n        }\r\n\r\n        sdp += `\r\na=group:BUNDLE 0 1 2\r\na=ice-options:trickle\r\na=msid-semantic:WMS *`;\r\n        const streamName = 'stream' + media.map(x => x.ssrc).join('_');\r\n        for (let i = 0; i < media.length; i++) {\r\n            const m = media[i];\r\n            const { type, ssrc, ssrcGroups, payloadTypes, rtpExtensions } = m;\r\n            switch (type) {\r\n                case 'audio': {\r\n                    sdp += `\r\nm=audio 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    sdp += `\r\na=rtcp-mux`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n\r\n                    break;\r\n                }\r\n                case 'video': {\r\n                    sdp += `\r\nm=video 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    sdp += `\r\na=rtcp-mux\r\na=rtcp-rsize`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        sdp += addDataChannel(2);\r\n        sdp += `\r\n`;\r\n\r\n        return sdp;\r\n    }\r\n\r\n    static generateAnswer(info) {\r\n        const { fingerprints, ufrag, pwd, audio, video } = info;\r\n        audio.type = 'audio';\r\n        video.type = 'video';\r\n        const media = [audio, video];\r\n\r\n        let sdp = `v=0\r\no=- 1 0 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0`;\r\n        if (fingerprints) {\r\n            fingerprints.forEach(x => {\r\n                const { hash, fingerprint, setup } = x;\r\n                sdp += `\r\na=fingerprint:${hash} ${fingerprint}\r\na=setup:${setup}`;\r\n            });\r\n        }\r\n        if (ufrag && pwd) {\r\n            sdp += `\r\na=ice-ufrag:${ufrag}\r\na=ice-pwd:${pwd}`;\r\n        }\r\n\r\n        sdp += `\r\na=group:BUNDLE 0 1 2\r\na=ice-options:trickle\r\na=msid-semantic:WMS *`;\r\n        const streamName = 'stream' + media.map(x => x.ssrc).join('_');\r\n        for (let i = 0; i < media.length; i++) {\r\n            const m = media[i];\r\n            const { type, mid, ssrc, ssrcGroups, payloadTypes, dir, rtpExtensions } = m;\r\n            switch (type) {\r\n                case 'audio': {\r\n                    sdp += `\r\nm=audio 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    sdp += `\r\na=rtcp-mux`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n\r\n                    break;\r\n                }\r\n                case 'video': {\r\n                    sdp += `\r\nm=video 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    sdp += `\r\na=rtcp-mux\r\na=rtcp-rsize`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        sdp += addDataChannel(2);\r\n        sdp += `\r\n`;\r\n\r\n        return sdp;\r\n    }\r\n}","/*\r\n *  Copyright (c) 2018-present, Evgeny Nadymov\r\n *\r\n * This source code is licensed under the GPL v.3.0 license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n */\r\n\r\nimport { addDataChannel, addExtmap, addPayloadTypes, addSsrc } from './p2PSdpBuilder';\r\n\r\nexport class SafariP2PSdpBuilder {\r\n    static generateOffer(info) {\r\n        const { fingerprints, ufrag, pwd, audio, video } = info;\r\n        audio.type = 'audio';\r\n        video.type = 'video';\r\n        const media = [audio, video];\r\n\r\n        if (!media.length) {\r\n            return `v=0\r\no=- 1 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=msid-semantic: WMS\r\n`;\r\n        }\r\n\r\n        let sdp = `v=0\r\no=- 1 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0`;\r\n        if (fingerprints) {\r\n            fingerprints.forEach(x => {\r\n                const { hash, fingerprint, setup } = x;\r\n                sdp += `\r\na=fingerprint:${hash} ${fingerprint}\r\na=setup:${setup}`;\r\n            });\r\n        }\r\n        if (ufrag && pwd) {\r\n            sdp += `\r\na=ice-ufrag:${ufrag}\r\na=ice-pwd:${pwd}`;\r\n        }\r\n\r\n        sdp += `\r\na=group:BUNDLE 0 1 2\r\na=extmap-allow-mixed\r\na=msid-semantic: WMS *`;\r\n        const streamName = 'stream' + media.map(x => x.ssrc).join('_');\r\n        for (let i = 0; i < media.length; i++) {\r\n            const m = media[i];\r\n            const { type, ssrc, ssrcGroups, payloadTypes, rtpExtensions } = m;\r\n            switch (type) {\r\n                case 'audio': {\r\n                    sdp += `\r\nm=audio 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-options:trickle\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    if (ssrc) {\r\n                        sdp += `\r\na=msid:${streamName} audio${ssrc}`;\r\n                    }\r\n                    sdp += `\r\na=rtcp-mux`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n\r\n                    break;\r\n                }\r\n                case 'video': {\r\n                    sdp += `\r\nm=video 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-options:trickle\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    if (ssrc) {\r\n                        sdp += `\r\na=msid:${streamName} video${ssrc}`;\r\n                    }\r\n                    sdp += `\r\na=rtcp-mux\r\na=rtcp-rsize`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        sdp += addDataChannel(2);\r\n        sdp += `\r\n`;\r\n\r\n        return sdp;\r\n    }\r\n\r\n    static generateAnswer(info) {\r\n        const { fingerprints, ufrag, pwd, audio, video } = info;\r\n        audio.type = 'audio';\r\n        video.type = 'video';\r\n        const media = [audio, video];\r\n\r\n        if (!media.length) {\r\n            return `v=0\r\no=- 1 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=msid-semantic: WMS\r\n`;\r\n        }\r\n\r\n        let sdp = `v=0\r\no=- 1 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0`;\r\n        if (fingerprints) {\r\n            fingerprints.forEach(x => {\r\n                const { hash, fingerprint, setup } = x;\r\n                sdp += `\r\na=fingerprint:${hash} ${fingerprint}\r\na=setup:${setup}`;\r\n            });\r\n        }\r\n        if (ufrag && pwd) {\r\n            sdp += `\r\na=ice-ufrag:${ufrag}\r\na=ice-pwd:${pwd}`;\r\n        }\r\n\r\n        sdp += `\r\na=group:BUNDLE 0 1 2\r\na=extmap-allow-mixed\r\na=msid-semantic: WMS *`;\r\n        const streamName = 'stream' + media.map(x => x.ssrc).join('_');\r\n        for (let i = 0; i < media.length; i++) {\r\n            const m = media[i];\r\n            const { type, ssrc, ssrcGroups, payloadTypes, rtpExtensions } = m;\r\n            switch (type) {\r\n                case 'audio': {\r\n                    sdp += `\r\nm=audio 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-options:trickle\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    if (ssrc) {\r\n                        sdp += `\r\na=msid:${streamName} audio${ssrc}`;\r\n                    }\r\n                    sdp += `\r\na=rtcp-mux`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n\r\n                    break;\r\n                }\r\n                case 'video': {\r\n                    sdp += `\r\nm=video 9 UDP/TLS/RTP/SAVPF ${payloadTypes.map(x => x.id).join(' ')}\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-options:trickle\r\na=mid:${i}\r\na=sendrecv`;\r\n                    sdp += addExtmap(rtpExtensions);\r\n                    if (ssrc) {\r\n                        sdp += `\r\na=msid:${streamName} video${ssrc}`;\r\n                    }\r\n                    sdp += `\r\na=rtcp-mux\r\na=rtcp-rsize`;\r\n                    sdp += addPayloadTypes(payloadTypes);\r\n                    sdp += addSsrc(type, ssrc, ssrcGroups, streamName);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        sdp += addDataChannel(2);\r\n        sdp += `\r\n`;\r\n\r\n        return sdp;\r\n    }\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport ctx from \"../../environment/ctx\";\r\nimport { IS_SAFARI } from \"../../environment/userAgent\";\r\nimport safeAssign from \"../../helpers/object/safeAssign\";\r\nimport debounce from \"../../helpers/schedulers/debounce\";\r\nimport { GroupCallParticipantVideoSourceGroup, PhoneCall, PhoneCallDiscardReason, PhoneCallProtocol, Update } from \"../../layer\";\r\nimport { emojiFromCodePoints } from \"../../vendor/emoji\";\r\nimport type { CallId } from \"../appManagers/appCallsManager\";\r\nimport type { AppManagers } from \"../appManagers/managers\";\r\nimport { logger } from \"../logger\";\r\nimport apiManagerProxy from \"../mtproto/mtprotoworker\";\r\nimport CallConnectionInstance from \"./callConnectionInstance\";\r\nimport CallInstanceBase from \"./callInstanceBase\";\r\nimport callsController from \"./callsController\";\r\nimport CALL_STATE from \"./callState\";\r\nimport { GROUP_CALL_AMPLITUDE_ANALYSE_INTERVAL_MS } from \"./constants\";\r\nimport parseSignalingData from \"./helpers/parseSignalingData\";\r\nimport stopTrack from \"./helpers/stopTrack\";\r\nimport localConferenceDescription, { ConferenceEntry, generateSsrc } from \"./localConferenceDescription\";\r\nimport getCallProtocol from \"./p2P/getCallProtocol\";\r\nimport getRtcConfiguration from \"./p2P/getRtcConfiguration\";\r\nimport P2PEncryptor from \"./p2P/p2PEncryptor\";\r\nimport { p2pParseCandidate, P2PSdpBuilder } from \"./p2P/p2PSdpBuilder\";\r\nimport { parseSdp } from \"./sdp/utils\";\r\nimport { WebRTCLineType } from \"./sdpBuilder\";\r\nimport StreamManager from \"./streamManager\";\r\nimport { AudioCodec, CallMediaState, CallSignalingData, DiffieHellmanInfo, P2PAudioCodec, P2PVideoCodec, VideoCodec } from \"./types\";\r\n\r\nexport default class CallInstance extends CallInstanceBase<{\r\n  state: (state: CALL_STATE) => void,\r\n  id: (id: CallId, prevId: CallId) => void,\r\n  muted: (muted: boolean) => void,\r\n  mediaState: (mediaState: CallMediaState) => void,\r\n  acceptCallOverride: () => Promise<boolean>,\r\n}> {\r\n  public dh: Partial<DiffieHellmanInfo.a & DiffieHellmanInfo.b>;\r\n  public id: CallId;\r\n  public call: PhoneCall;\r\n  public interlocutorUserId: UserId;\r\n  public protocol: PhoneCallProtocol;\r\n  public isOutgoing: boolean;\r\n  public encryptionKey: Uint8Array;\r\n  public connectionInstance: CallConnectionInstance;\r\n  public encryptor: P2PEncryptor;\r\n  public decryptor: P2PEncryptor;\r\n  public candidates: RTCIceCandidate[];\r\n\r\n  public offerReceived: boolean;\r\n  public offerSent: boolean;\r\n  \r\n  public createdParticipantEntries: boolean;\r\n  public release: () => Promise<void>;\r\n  public _connectionState: CALL_STATE;\r\n\r\n  public createdAt: number;\r\n  public connectedAt: number;\r\n  public discardReason: string;\r\n\r\n  private managers: AppManagers;\r\n  \r\n  private hangUpTimeout: number;\r\n\r\n  private mediaStates: {\r\n    input: CallMediaState,\r\n    output?: CallMediaState\r\n  };\r\n\r\n  private sendMediaState: () => Promise<void>;\r\n\r\n  private decryptQueue: Uint8Array[];\r\n  \r\n  private getEmojisFingerprintPromise: Promise<CallInstance['emojisFingerprint']>;\r\n  private emojisFingerprint: [string, string, string, string];\r\n\r\n  private wasStartingScreen: boolean;\r\n  private wasStartingVideo: boolean;\r\n  public wasTryingToJoin: boolean;\r\n\r\n  public streamManager: StreamManager;\r\n\r\n  constructor(options: {\r\n    isOutgoing: boolean,\r\n    interlocutorUserId: UserId,\r\n    managers: CallInstance['managers'],\r\n    protocol?: PhoneCallProtocol\r\n  }) {\r\n    super();\r\n\r\n    this.log = logger('CALL');\r\n\r\n    if(!this.protocol) {\r\n      this.protocol = getCallProtocol();\r\n    }\r\n\r\n    safeAssign(this, options);\r\n    \r\n    this.createdAt = Date.now();\r\n    this.offerReceived = false;\r\n    this.offerSent = false;\r\n    this.decryptQueue = [];\r\n    this.candidates = [];\r\n\r\n    this.addEventListener('state', (state) => {\r\n      this.log('state', CALL_STATE[state]);\r\n\r\n      if(state === CALL_STATE.CLOSED) {\r\n        this.cleanup();\r\n      }\r\n    });\r\n\r\n    const streamManager = this.streamManager = new StreamManager(GROUP_CALL_AMPLITUDE_ANALYSE_INTERVAL_MS);\r\n    streamManager.direction = 'sendrecv';\r\n    streamManager.types.push('screencast');\r\n    if(!this.isOutgoing) {\r\n      streamManager.locked = true;\r\n      streamManager.canCreateConferenceEntry = false;\r\n    }\r\n\r\n    let mediaState: CallMediaState = {\r\n      '@type': 'MediaState',\r\n      type: 'input',\r\n      lowBattery: false,\r\n      muted: true,\r\n      screencastState: 'inactive',\r\n      videoRotation: 0,\r\n      videoState: 'inactive'\r\n    };\r\n\r\n    const self = this;\r\n    mediaState = new Proxy(mediaState, {\r\n      set: function(target, key, value) {\r\n        // @ts-ignore\r\n        target[key] = value;\r\n        self.setMediaState(mediaState);\r\n        self.sendMediaState();\r\n        return true;\r\n      }\r\n    });\r\n\r\n    this.mediaStates = {\r\n      input: mediaState\r\n    };\r\n\r\n    this.sendMediaState = debounce(this._sendMediaState.bind(this), 0, false, true);\r\n  }\r\n\r\n  get connectionState() {\r\n    const {_connectionState, connectionInstance} = this;\r\n    if(_connectionState !== undefined) {\r\n      return _connectionState;\r\n    } else if(!connectionInstance) {\r\n      return CALL_STATE.CONNECTING;\r\n    } else {\r\n      const {iceConnectionState} = connectionInstance.connection;\r\n      if(iceConnectionState === 'closed') {\r\n        return CALL_STATE.CLOSED;\r\n      } else if(iceConnectionState !== 'connected' && (!IS_SAFARI || iceConnectionState !== 'completed')) {\r\n        return CALL_STATE.CONNECTING;\r\n      } else {\r\n        return CALL_STATE.CONNECTED;\r\n      }\r\n    }\r\n  }\r\n\r\n  get sortIndex() {\r\n    const connectionState = this.connectionState;\r\n    const state = CALL_STATE.CLOSED - connectionState + 1;\r\n    let index = state * 10000000000000;\r\n    index += 2147483647000 - (connectionState === CALL_STATE.PENDING && this.isOutgoing ? 0 : this.createdAt);\r\n    return index;\r\n  }\r\n\r\n  public getVideoElement(type: CallMediaState['type']) {\r\n    if(type === 'input') return this.elements.get('main');\r\n    else {\r\n      const mediaState = this.getMediaState('output');\r\n      if(!mediaState) {\r\n        return;\r\n      }\r\n\r\n      const type: WebRTCLineType = mediaState.videoState === 'active' ? 'video' : (mediaState.screencastState === 'active' ? 'screencast' : undefined);\r\n      if(!type) {\r\n        return;\r\n      }\r\n\r\n      const entry = this.description.findEntry((entry) => entry.type === type);\r\n      if(!entry) {\r\n        return;\r\n      }\r\n\r\n      return this.elements.get('' + entry.recvEntry.source);\r\n    }\r\n  }\r\n\r\n  public async startScreenSharingInternal() {\r\n    try {\r\n      this.wasStartingScreen = true;\r\n      this.wasStartingVideo = false;\r\n      this.streamManager.types = ['audio', 'screencast'];\r\n      await this.requestScreen();\r\n    } catch(err) {\r\n      this.log.error('startScreenSharing error', err);\r\n    }\r\n  }\r\n\r\n  public async toggleScreenSharing() {\r\n    if(this.isSharingVideo) {\r\n      await this.stopVideoSharing();\r\n    }\r\n\r\n    if(this.isSharingScreen) {\r\n      return this.stopVideoSharing();\r\n    } else {\r\n      return this.startScreenSharingInternal();\r\n    }\r\n  }\r\n\r\n  public async startVideoSharingInternal() {\r\n    try {\r\n      this.wasStartingScreen = false;\r\n      this.wasStartingVideo = true;\r\n      this.streamManager.types = ['audio', 'video'];\r\n      await this.requestInputSource(false, true, false);\r\n    } catch(err) {\r\n      this.log.error('startVideoSharing error', err);\r\n    }\r\n  }\r\n\r\n  public async stopVideoSharing() {\r\n    const mediaState = this.getMediaState('input');\r\n    mediaState.videoState = mediaState.screencastState = 'inactive';\r\n\r\n    const {streamManager, description} = this;\r\n    const track = streamManager.inputStream.getVideoTracks()[0];\r\n    if(track) {\r\n      stopTrack(track);\r\n      streamManager.appendToConference(description); // clear sender track\r\n    }\r\n  }\r\n\r\n  public async toggleVideoSharing() {\r\n    if(this.isSharingScreen) {\r\n      await this.stopVideoSharing();\r\n    }\r\n\r\n    if(this.isSharingVideo) {\r\n      return this.stopVideoSharing();\r\n    } else {\r\n      return this.startVideoSharingInternal();\r\n    }\r\n  }\r\n\r\n  public getMediaState(type: CallMediaState['type']) {\r\n    return this.mediaStates[type];\r\n  }\r\n\r\n  public setMediaState(mediaState: CallMediaState) {\r\n    this.mediaStates[mediaState.type] = mediaState;\r\n    this.dispatchEvent('mediaState', mediaState);\r\n  }\r\n\r\n  public isSharingVideoType(type: 'video' | 'screencast') {\r\n    try {\r\n      const hasVideoTrack = super.isSharingVideo;\r\n      return hasVideoTrack && !!((this.wasStartingScreen && type === 'screencast') || (this.wasStartingVideo && type === 'video'));\r\n\r\n      // ! it will be used before the track appears\r\n      // return !!this.description.entries.find((entry) => entry.type === type && entry.transceiver.sender.track.enabled);\r\n    } catch(err) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public get isSharingVideo() {\r\n    return this.isSharingVideoType('video');\r\n  }\r\n\r\n  public get isSharingScreen() {\r\n    return this.isSharingVideoType('screencast');\r\n  }\r\n\r\n  public get isMuted() {\r\n    const audioTrack = this.streamManager.inputStream.getAudioTracks()[0];\r\n    return !audioTrack?.enabled;\r\n  }\r\n\r\n  public get isClosing() {\r\n    const {connectionState} = this;\r\n    return connectionState === CALL_STATE.CLOSING || connectionState === CALL_STATE.CLOSED;\r\n  }\r\n\r\n  public get description(): localConferenceDescription {\r\n    return this.connectionInstance?.description;\r\n  }\r\n\r\n  public setHangUpTimeout(timeout: number, reason: PhoneCallDiscardReason['_']) {\r\n    this.clearHangUpTimeout();\r\n    this.hangUpTimeout = ctx.setTimeout(() => {\r\n      this.hangUpTimeout = undefined;\r\n      this.hangUp(reason);\r\n    }, timeout);\r\n  }\r\n\r\n  public clearHangUpTimeout() {\r\n    if(this.hangUpTimeout !== undefined) {\r\n      clearTimeout(this.hangUpTimeout);\r\n      this.hangUpTimeout = undefined;\r\n    }\r\n  }\r\n\r\n  public setPhoneCall(phoneCall: PhoneCall) {\r\n    this.call = phoneCall;\r\n\r\n    const {id} = phoneCall;\r\n    if(this.id !== id) {\r\n      const prevId = this.id;\r\n      this.id = id;\r\n      this.dispatchEvent('id', id, prevId);\r\n    }\r\n  }\r\n\r\n  public async acceptCall() {\r\n    const canAccept = (await Promise.all(this.dispatchResultableEvent('acceptCallOverride')))[0] ?? true;\r\n    if(this.isClosing || !canAccept) {\r\n      return;\r\n    }\r\n    \r\n    // this.clearHangUpTimeout();\r\n    this.overrideConnectionState(CALL_STATE.EXCHANGING_KEYS);\r\n\r\n    const call = this.call as PhoneCall.phoneCallRequested;\r\n    this.requestInputSource(true, !!call.pFlags.video, false);\r\n\r\n    const g_a_hash = call.g_a_hash;\r\n    this.managers.appCallsManager.generateDh().then(async(dh) => {\r\n      this.dh = { // ! it is correct\r\n        g_a_hash,\r\n        b: dh.a,\r\n        g_b: dh.g_a,\r\n        g_b_hash: dh.g_a_hash,\r\n        p: dh.p,\r\n      };\r\n\r\n      return this.managers.apiManager.invokeApi('phone.acceptCall', {\r\n        peer: await this.managers.appCallsManager.getCallInput(this.id),\r\n        protocol: this.protocol,\r\n        g_b: this.dh.g_b\r\n      });\r\n    }).then(async(phonePhoneCall) => {\r\n      await this.managers.appCallsManager.savePhonePhoneCall(phonePhoneCall);\r\n    }).catch((err) => {\r\n      this.log.error('accept call error', err);\r\n      // if(err.type === 'CALL_PROTOCOL_COMPAT_LAYER_INVALID') {\r\n\r\n      // }\r\n\r\n      this.hangUp('phoneCallDiscardReasonHangup');\r\n    });\r\n  }\r\n\r\n  public joinCall() {\r\n    this.log('joinCall');\r\n\r\n    this.getEmojisFingerprint();\r\n\r\n    this.overrideConnectionState();\r\n    \r\n    const {isOutgoing, encryptionKey, streamManager} = this;\r\n    \r\n    const configuration = getRtcConfiguration(this.call as PhoneCall.phoneCall);\r\n    this.log('joinCall configuration', configuration);\r\n    if(!configuration) return;\r\n\r\n    const connectionInstance = this.connectionInstance = new CallConnectionInstance({\r\n      call: this,\r\n      streamManager,\r\n      log: this.log.bindPrefix('connection'),\r\n    });\r\n\r\n    const connection = connectionInstance.createPeerConnection(configuration);\r\n    connection.addEventListener('iceconnectionstatechange', () => {\r\n      const state = this.connectionState;\r\n      if(this.connectedAt === undefined && state === CALL_STATE.CONNECTED) {\r\n        this.connectedAt = Date.now();\r\n      }\r\n      \r\n      this.dispatchEvent('state', state);\r\n    });\r\n    connection.addEventListener('negotiationneeded', () => {\r\n      connectionInstance.negotiate();\r\n    });\r\n    connection.addEventListener('icecandidate', (event) => {\r\n      const {candidate} = event;\r\n      connection.log('onicecandidate', candidate);\r\n      if(candidate?.candidate) {\r\n        this.sendIceCandidate(candidate);\r\n      }\r\n    });\r\n    connection.addEventListener('track', (event) => {\r\n      const {track} = event;\r\n      connection.log('ontrack', track);\r\n      this.onTrack(event);\r\n    });\r\n\r\n    const description = connectionInstance.createDescription();\r\n    \r\n    this.encryptor = new P2PEncryptor(isOutgoing, encryptionKey);\r\n    this.decryptor = new P2PEncryptor(!isOutgoing, encryptionKey);\r\n\r\n    this.log('currentCall', this);\r\n\r\n    if(isOutgoing) {\r\n      connectionInstance.appendStreamToConference();\r\n    }\r\n    \r\n    this.createDataChannel();\r\n\r\n    this.processDecryptQueue();\r\n  }\r\n\r\n  private createDataChannelEntry() {\r\n    const dataChannelEntry = this.description.createEntry('application');\r\n    dataChannelEntry.setDirection('sendrecv');\r\n    dataChannelEntry.sendEntry = dataChannelEntry.recvEntry = dataChannelEntry; \r\n  }\r\n\r\n  private createDataChannel() {\r\n    if(this.connectionInstance.dataChannel) {\r\n      return;\r\n    }\r\n\r\n    const channel = this.connectionInstance.createDataChannel({\r\n      id: 0,\r\n      negotiated: true\r\n    });\r\n    channel.addEventListener('message', (e) => {\r\n      this.applyDataChannelData(JSON.parse(e.data));\r\n    });\r\n    channel.addEventListener('open', () => {\r\n      this.sendMediaState();\r\n    });\r\n  }\r\n\r\n  private applyDataChannelData(data: CallMediaState) {\r\n    switch(data['@type']) {\r\n      case 'MediaState': {\r\n        data.type = 'output';\r\n        this.log('got output media state', data);\r\n        this.setMediaState(data);\r\n        break;\r\n      }\r\n\r\n      default:\r\n        this.log.error('unknown data channel data:', data);\r\n        break;\r\n    }\r\n  }\r\n\r\n  private _sendMediaState() {\r\n    const {connectionInstance} = this;\r\n    if(!connectionInstance) return;\r\n\r\n    const mediaState = {...this.getMediaState('input')};\r\n    // mediaState.videoRotation = 90;\r\n    delete mediaState.type;\r\n    this.log('sendMediaState', mediaState);\r\n\r\n    connectionInstance.sendDataChannelData(mediaState);\r\n  }\r\n\r\n  public async sendCallSignalingData(data: CallSignalingData) {\r\n    /* if(data['@type'] === 'InitialSetup') {\r\n      this.filterNotVP8(data);\r\n    } */\r\n    \r\n    const json = JSON.stringify(data);\r\n    const arr = new TextEncoder().encode(json);\r\n    const {bytes} = await this.encryptor.encryptRawPacket(arr);\r\n    \r\n    this.log('sendCallSignalingData', this.id, json);\r\n    await this.managers.apiManager.invokeApi('phone.sendSignalingData', {\r\n      peer: await this.managers.appCallsManager.getCallInput(this.id),\r\n      data: bytes\r\n    });\r\n  }\r\n  \r\n  public sendIceCandidate(iceCandidate: RTCIceCandidate) {\r\n    this.log('sendIceCandidate', iceCandidate);\r\n    const {candidate, sdpMLineIndex} = iceCandidate;\r\n    if(sdpMLineIndex !== 0) {\r\n      return;\r\n    }\r\n    \r\n    const parsed = p2pParseCandidate(candidate);\r\n    // const parsed = {sdpString: candidate};\r\n    /* if(parsed.address.ip !== '') {\r\n      return;\r\n    } */\r\n\r\n    this.sendCallSignalingData({\r\n      '@type': 'Candidates', \r\n      candidates: [parsed]\r\n    });\r\n  }\r\n\r\n  public async confirmCall() {\r\n    const {protocol, id, call} = this;\r\n    const dh = this.dh as DiffieHellmanInfo.a;\r\n\r\n    // this.clearHangUpTimeout();\r\n    this.overrideConnectionState(CALL_STATE.EXCHANGING_KEYS);\r\n    const {key, key_fingerprint} = await this.managers.appCallsManager.computeKey((call as PhoneCall.phoneCallAccepted).g_b, dh.a, dh.p);\r\n    \r\n    const phonePhoneCall = await this.managers.apiManager.invokeApi('phone.confirmCall', {\r\n      peer: await this.managers.appCallsManager.getCallInput(id),\r\n      protocol: protocol,\r\n      g_a: dh.g_a,\r\n      key_fingerprint: key_fingerprint\r\n    });\r\n    \r\n    this.encryptionKey = key;\r\n    await this.managers.appCallsManager.savePhonePhoneCall(phonePhoneCall);\r\n    this.joinCall();\r\n  }\r\n\r\n  public getEmojisFingerprint() {\r\n    if(this.emojisFingerprint) return this.emojisFingerprint;\r\n    if(this.getEmojisFingerprintPromise) return this.getEmojisFingerprintPromise;\r\n    return this.getEmojisFingerprintPromise = apiManagerProxy.invokeCrypto('get-emojis-fingerprint', this.encryptionKey, this.dh.g_a).then((codePoints) => {\r\n      this.getEmojisFingerprintPromise = undefined;\r\n      return this.emojisFingerprint = codePoints.map((codePoints) => emojiFromCodePoints(codePoints)) as [string, string, string, string];\r\n    });\r\n  }\r\n\r\n  private unlockStreamManager() {\r\n    this.connectionInstance.streamManager.locked = false;\r\n    this.connectionInstance.appendStreamToConference();\r\n  }\r\n\r\n  private async doTheMagic() {\r\n    this.connectionInstance.appendStreamToConference();\r\n\r\n    const connection = this.connectionInstance.connection;\r\n\r\n    let answer = await connection.createAnswer();\r\n\r\n    this.log('[sdp] local', answer.type, answer.sdp);\r\n    await connection.setLocalDescription(answer);\r\n\r\n    connection.getTransceivers().filter((transceiver) => transceiver.direction === 'recvonly').forEach((transceiver) => {\r\n      const entry = this.connectionInstance.description.getEntryByMid(transceiver.mid);\r\n      entry.transceiver = entry.recvEntry.transceiver = transceiver;\r\n      transceiver.direction = 'sendrecv';\r\n    });\r\n\r\n    const isAnswer = false;\r\n\r\n    const description = this.description;\r\n    let bundle = description.entries.map((entry) => entry.mid);\r\n    const sdpDescription: RTCSessionDescriptionInit = {\r\n      type: isAnswer ? 'answer' : 'offer',\r\n      sdp: description.generateSdp({\r\n        bundle,\r\n        entries: description.entries.filter((entry) => bundle.includes(entry.mid)),\r\n        // isAnswer: isAnswer\r\n        isAnswer: !isAnswer\r\n      })\r\n    };\r\n\r\n    await connection.setRemoteDescription(sdpDescription);\r\n\r\n    answer = await connection.createAnswer();\r\n\r\n    await connection.setLocalDescription(answer);\r\n    \r\n    const initialSetup = parseSignalingData(parseSdp(answer.sdp));\r\n    this.log('[InitialSetup] send 1');\r\n    this.sendCallSignalingData(initialSetup);\r\n    \r\n    this.unlockStreamManager();\r\n  }\r\n\r\n  public overrideConnectionState(state?: CALL_STATE) {\r\n    this._connectionState = state;\r\n    this.dispatchEvent('state', this.connectionState);\r\n  }\r\n\r\n  public get duration() {\r\n    return this.connectedAt !== undefined ? (Date.now() - this.connectedAt) / 1000 | 0 : 0;\r\n  }\r\n\r\n  protected onInputStream(stream: MediaStream): void {\r\n    super.onInputStream(stream);\r\n\r\n    const videoTrack = stream.getVideoTracks()[0];\r\n    if(videoTrack) {\r\n      const state = this.getMediaState('input');\r\n\r\n      // handle starting camera\r\n      if(!this.wasStartingScreen && !this.wasStartingVideo) {\r\n        this.wasStartingVideo = true;\r\n      }\r\n\r\n      if(this.isSharingVideo) {\r\n        state.videoState = 'active';\r\n      } else if(this.isSharingScreen) {\r\n        state.screencastState = 'active';\r\n      }\r\n\r\n      videoTrack.addEventListener('ended', () => {\r\n        this.stopVideoSharing();\r\n      }, {once: true});\r\n    }\r\n\r\n    if(stream.getAudioTracks().length) {\r\n      this.onMutedChange();\r\n    }\r\n  }\r\n  \r\n  private onMutedChange() {\r\n    const isMuted = this.isMuted;\r\n    this.dispatchEvent('muted', isMuted);\r\n\r\n    const state = this.getMediaState('input');\r\n    state.muted = isMuted;\r\n  }\r\n\r\n  public toggleMuted(): Promise<void> {\r\n    return this.requestAudioSource(true).then(() => {\r\n      this.setMuted();\r\n      this.onMutedChange();\r\n    });\r\n  }\r\n\r\n  public async hangUp(discardReason?: PhoneCallDiscardReason['_'], discardedByOtherParty?: boolean) {\r\n    if(this.isClosing) {\r\n      return;\r\n    }\r\n\r\n    this.discardReason = discardReason;\r\n    this.log('hangUp', discardReason);\r\n    this.overrideConnectionState(CALL_STATE.CLOSED);\r\n\r\n    if(this.connectionInstance) {\r\n      this.connectionInstance.closeConnectionAndStream(true);\r\n    }\r\n\r\n    if(discardReason && !discardedByOtherParty) {\r\n      let hasVideo = false;\r\n      for(const type in this.mediaStates) {\r\n        const mediaState = this.mediaStates[type as 'input' | 'output'];\r\n        hasVideo = mediaState.videoState === 'active' || mediaState.screencastState === 'active' || hasVideo;\r\n      }\r\n\r\n      await this.managers.appCallsManager.discardCall(this.id, this.duration, discardReason, hasVideo);\r\n    }\r\n  }\r\n\r\n  private performCodec(_codec: P2PAudioCodec | P2PVideoCodec) {\r\n    const payloadTypes: AudioCodec['payload-types'] = _codec.payloadTypes.map((payloadType) => {\r\n      return {\r\n        ...payloadType,\r\n        'rtcp-fbs': payloadType.feedbackTypes\r\n      }\r\n    });\r\n    \r\n    const codec: AudioCodec = {\r\n      'rtp-hdrexts': _codec.rtpExtensions,\r\n      'payload-types': payloadTypes\r\n    };\r\n    \r\n    return codec;\r\n  }\r\n\r\n  private setDataToDescription(data: CallSignalingData.initialSetup) {\r\n    this.description.setData({\r\n      transport: {\r\n        pwd: data.pwd,\r\n        ufrag: data.ufrag,\r\n        fingerprints: data.fingerprints,\r\n        'rtcp-mux': true\r\n      },\r\n      audio: this.performCodec(data.audio),\r\n      video: data.video ? this.performCodec(data.video) as VideoCodec : undefined,\r\n      screencast: data.screencast ? this.performCodec(data.screencast) as VideoCodec : undefined\r\n    });\r\n  }\r\n\r\n  private filterNotVP8(initialSetup: CallSignalingData.initialSetup) {\r\n    if(!this.isOutgoing) { // only VP8 works now\r\n      [initialSetup.video, initialSetup.screencast].filter(Boolean).forEach((codec) => {\r\n        const payloadTypes = codec.payloadTypes;\r\n        const idx = payloadTypes.findIndex((payloadType) => payloadType.name === 'VP8');\r\n        const vp8PayloadType = payloadTypes[idx];\r\n        const rtxIdx = payloadTypes.findIndex((payloadType) => +payloadType.parameters?.apt === vp8PayloadType.id);\r\n        codec.payloadTypes = [payloadTypes[idx], payloadTypes[rtxIdx]];\r\n      });\r\n    }\r\n  }\r\n\r\n  public async applyCallSignalingData(data: CallSignalingData) {\r\n    this.log('applyCallSignalingData', this, data);\r\n    \r\n    const {connection, description} = this.connectionInstance;\r\n\r\n    switch(data['@type']) {\r\n      case 'InitialSetup': {\r\n        this.log('[sdp] InitialSetup', data);\r\n\r\n        this.filterNotVP8(data);\r\n        this.setDataToDescription(data);\r\n\r\n        const performSsrcGroups = (ssrcGroups: P2PVideoCodec['ssrcGroups']): GroupCallParticipantVideoSourceGroup[] => {\r\n          return ssrcGroups.map((ssrcGroup) => {\r\n            return {\r\n              _: 'groupCallParticipantVideoSourceGroup',\r\n              semantics: ssrcGroup.semantics,\r\n              sources: ssrcGroup.ssrcs.map((source) => +source)\r\n            };\r\n          });\r\n        };\r\n\r\n        const ssrcs = [\r\n          generateSsrc('audio', +data.audio.ssrc),\r\n          data.video ? generateSsrc('video', performSsrcGroups(data.video.ssrcGroups)) : undefined,\r\n          data.screencast ? generateSsrc('screencast', performSsrcGroups(data.screencast.ssrcGroups)) : undefined\r\n        ].filter(Boolean);\r\n\r\n        ssrcs.forEach((ssrc) => {\r\n          let entry = description.getEntryBySource(ssrc.source);\r\n          if(entry) {\r\n            return;\r\n          }\r\n          \r\n          const sendRecvEntry = description.findFreeSendRecvEntry(ssrc.type, false);\r\n          entry = new ConferenceEntry(sendRecvEntry.mid, ssrc.type);\r\n          entry.setDirection('sendrecv');\r\n          sendRecvEntry.recvEntry = entry;\r\n\r\n          description.setEntrySource(entry, ssrc.sourceGroups || ssrc.source);\r\n        });\r\n\r\n        this.createDataChannelEntry();\r\n\r\n        const isAnswer = this.offerSent;\r\n        this.offerSent = false;\r\n\r\n        let bundle = description.entries.map((entry) => entry.mid);\r\n        const sdpDescription: RTCSessionDescriptionInit = {\r\n          type: isAnswer ? 'answer' : 'offer',\r\n          sdp: description.generateSdp({\r\n            bundle,\r\n            entries: description.entries.filter((entry) => bundle.includes(entry.mid)),\r\n            // isAnswer: isAnswer\r\n            isAnswer: !isAnswer\r\n          })\r\n        };\r\n\r\n        this.log('[sdp] remote', sdpDescription.sdp);\r\n\r\n        await connection.setRemoteDescription(sdpDescription);\r\n\r\n        await this.tryToReleaseCandidates();\r\n\r\n        if(!isAnswer) {\r\n          await this.doTheMagic();\r\n        }\r\n\r\n        break;\r\n      }\r\n      \r\n      case 'Candidates': {\r\n        for(const candidate of data.candidates) {\r\n          const init: RTCIceCandidateInit = P2PSdpBuilder.generateCandidate(candidate);\r\n          init.sdpMLineIndex = 0;\r\n          const iceCandidate = new RTCIceCandidate(init);\r\n          this.candidates.push(iceCandidate);\r\n        }\r\n        \r\n        await this.tryToReleaseCandidates();\r\n        break;\r\n      }\r\n\r\n      default: {\r\n        this.log.error('unrecognized signaling data', data);\r\n      }\r\n    }\r\n  }\r\n\r\n  public async tryToReleaseCandidates() {\r\n    const {connectionInstance} = this;\r\n    if(!connectionInstance) {\r\n      return;\r\n    }\r\n\r\n    const {connection} = connectionInstance;\r\n    if(connection.remoteDescription) {\r\n      const promises: Promise<void>[] = this.candidates.map((candidate) => this.addIceCandidate(connection, candidate));\r\n      this.candidates.length = 0;\r\n\r\n      await Promise.all(promises);\r\n    } else {\r\n      this.log('[candidates] postpone');\r\n    }\r\n  }\r\n\r\n  private async addIceCandidate(connection: RTCPeerConnection, candidate: RTCIceCandidate) {\r\n    this.log('[candidate] start', candidate);\r\n    try {\r\n      // if(!candidate.address) return;\r\n      await connection.addIceCandidate(candidate);\r\n      this.log('[candidate] add', candidate);\r\n    } catch(e) {\r\n      this.log.error('[candidate] error', candidate, e);\r\n    }\r\n  }\r\n\r\n  private async processDecryptQueue() {\r\n    const {encryptor} = this;\r\n    if(!encryptor) {\r\n      this.log.warn('got encrypted signaling data before the encryption key');\r\n      return;\r\n    }\r\n\r\n    const length = this.decryptQueue.length;\r\n    if(!length) {\r\n      return;\r\n    }\r\n    \r\n    const queue = this.decryptQueue.slice();\r\n    this.decryptQueue.length = 0;\r\n    \r\n    for(const data of queue) {\r\n      const decryptedData = await encryptor.decryptRawPacket(data);\r\n      if(!decryptedData) {\r\n        continue;\r\n      }\r\n\r\n      // this.log('[update] updateNewCallSignalingData', update, decryptedData);\r\n      \r\n      const str = new TextDecoder().decode(decryptedData);\r\n      try {\r\n        const signalingData: CallSignalingData = JSON.parse(str);\r\n        this.log('[update] updateNewCallSignalingData', signalingData);\r\n        this.applyCallSignalingData(signalingData);\r\n      } catch(err) {\r\n        this.log.error('wrong signaling data', str);\r\n        this.hangUp('phoneCallDiscardReasonDisconnect');\r\n        callsController.dispatchEvent('incompatible', this.interlocutorUserId);\r\n      }\r\n    }\r\n  }\r\n\r\n  public onUpdatePhoneCallSignalingData(data: Uint8Array) {\r\n    this.decryptQueue.push(data);\r\n    this.processDecryptQueue();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport { PhoneCallProtocol } from \"../../../layer\";\r\n\r\nexport default function getCallProtocol(): PhoneCallProtocol {\r\n  return {\r\n    _: 'phoneCallProtocol',\r\n    pFlags: {\r\n      udp_p2p: true,\r\n      udp_reflector: true\r\n    },\r\n    min_layer: 92,\r\n    max_layer: 92,\r\n    library_versions: ['4.0.0']\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/evgeny-nadymov/telegram-react\r\n * Copyright (C) 2018 Evgeny Nadymov\r\n * https://github.com/evgeny-nadymov/telegram-react/blob/master/LICENSE\r\n */\r\n\r\nimport { PhoneCall } from \"../../../layer\";\r\n\r\nexport default function getRtcConfiguration(call: PhoneCall.phoneCall): RTCConfiguration {\r\n  const iceServers: RTCIceServer[] = [];\r\n  call.connections.forEach((connection) => {\r\n    switch(connection._) {\r\n      /* case 'callServerTypeTelegramReflector': {\r\n        break;\r\n      } */\r\n      case 'phoneConnectionWebrtc': {\r\n        const {ip, ipv6, port, username, password} = connection;\r\n        const urls: string[] = [];\r\n        if(connection.pFlags.turn) {\r\n          if(ip) {\r\n            urls.push(`turn:${ip}:${port}`);\r\n          }\r\n          if(ipv6) {\r\n            urls.push(`turn:[${ipv6}]:${port}`);\r\n          }\r\n        } else if(connection.pFlags.stun) {\r\n          if(ip) {\r\n            urls.push(`stun:${ip}:${port}`);\r\n          }\r\n          if(ipv6) {\r\n            urls.push(`stun:[${ipv6}]:${port}`);\r\n          }\r\n        }\r\n        \r\n        if(urls.length > 0) {\r\n          iceServers.push({\r\n            urls,\r\n            username,\r\n            credential: password\r\n          });\r\n        }\r\n        break;\r\n      }\r\n    }\r\n  });\r\n  \r\n  return {\r\n    iceServers,\r\n    iceTransportPolicy: call.pFlags.p2p_allowed ? 'all' : 'relay'\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport ListenerSetter from \"../helpers/listenerSetter\";\r\nimport GROUP_CALL_STATE from \"../lib/calls/groupCallState\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport ButtonIcon from \"./buttonIcon\";\r\nimport TopbarWeave from \"./topbarWeave\";\r\nimport SetTransition from \"./singleTransition\";\r\nimport PopupGroupCall from \"./groupCall\";\r\nimport GroupCallDescriptionElement from \"./groupCall/description\";\r\nimport GroupCallTitleElement from \"./groupCall/title\";\r\nimport PopupElement from \"./popups\";\r\nimport throttle from \"../helpers/schedulers/throttle\";\r\nimport GroupCallInstance from \"../lib/calls/groupCallInstance\";\r\nimport CALL_STATE from \"../lib/calls/callState\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport PeerTitle from \"./peerTitle\";\r\nimport CallDescriptionElement from \"./call/description\";\r\nimport PopupCall from \"./call\";\r\nimport GroupCallMicrophoneIconMini from \"./groupCall/microphoneIconMini\";\r\nimport CallInstance from \"../lib/calls/callInstance\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport groupCallsController from \"../lib/calls/groupCallsController\";\r\nimport StreamManager from \"../lib/calls/streamManager\";\r\nimport callsController from \"../lib/calls/callsController\";\r\n\r\nfunction convertCallStateToGroupState(state: CALL_STATE, isMuted: boolean) {\r\n  switch(state) {\r\n    case CALL_STATE.CLOSING:\r\n    case CALL_STATE.CLOSED:\r\n      return GROUP_CALL_STATE.CLOSED;\r\n    case CALL_STATE.CONNECTED:\r\n      return isMuted ? GROUP_CALL_STATE.MUTED : GROUP_CALL_STATE.UNMUTED;\r\n    default:\r\n      return GROUP_CALL_STATE.CONNECTING;\r\n  }\r\n}\r\n\r\nconst CLASS_NAME = 'topbar-call';\r\n\r\nexport default class TopbarCall {\r\n  public container: HTMLElement;\r\n  private listenerSetter: ListenerSetter;\r\n  private weave: TopbarWeave;\r\n  private center: HTMLDivElement;\r\n  private groupCallTitle: GroupCallTitleElement;\r\n  private groupCallDescription: GroupCallDescriptionElement;\r\n  private groupCallMicrophoneIconMini: GroupCallMicrophoneIconMini;\r\n  private callDescription: CallDescriptionElement;\r\n  \r\n  private currentDescription: GroupCallDescriptionElement | CallDescriptionElement;\r\n\r\n  private instance: GroupCallInstance | any/* CallInstance */;\r\n  private instanceListenerSetter: ListenerSetter;\r\n  \r\n  constructor(\r\n    private managers: AppManagers\r\n  ) {\r\n    const listenerSetter = this.listenerSetter = new ListenerSetter();\r\n\r\n    listenerSetter.add(callsController)('instance', ({instance}) => {\r\n      if(!this.instance) {\r\n        this.updateInstance(instance);\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(callsController)('accepting', (instance) => {\r\n      if(this.instance !== instance) {\r\n        this.updateInstance(instance);\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(groupCallsController)('instance', (instance) => {\r\n      this.updateInstance(instance);\r\n    });\r\n    \r\n    listenerSetter.add(rootScope)('group_call_update', (groupCall) => {\r\n      const instance = groupCallsController.groupCall;\r\n      if(instance?.id === groupCall.id) {\r\n        this.updateInstance(instance);\r\n      }\r\n    });\r\n\r\n    listenerSetter.add(StreamManager.ANALYSER_LISTENER)('amplitude', ({amplitudes, type}) => {\r\n      const {weave} = this;\r\n      if(!amplitudes.length || !weave/*  || type !== 'input' */) return;\r\n\r\n      let max = 0;\r\n      for(let i = 0; i < amplitudes.length; ++i) {\r\n        const {type, value} = amplitudes[i];\r\n        max = value > max ? value : max;\r\n      }\r\n\r\n      weave.setAmplitude(max);\r\n    });\r\n  }\r\n\r\n  private onState = () => {\r\n    this.updateInstance(this.instance);\r\n  };\r\n\r\n  private clearCurrentInstance() {\r\n    if(!this.instance) return;\r\n    this.center.textContent = '';\r\n    \r\n    if(this.currentDescription) {\r\n      this.currentDescription.detach();\r\n      this.currentDescription = undefined;\r\n    }\r\n\r\n    this.instance = undefined;\r\n    this.instanceListenerSetter.removeAll();\r\n  }\r\n\r\n  private updateInstance(instance: TopbarCall['instance']) {\r\n    if(this.construct) {\r\n      this.construct();\r\n      this.construct = undefined;\r\n    }\r\n\r\n    const isChangingInstance = this.instance !== instance;\r\n    if(isChangingInstance) {\r\n      this.clearCurrentInstance();\r\n      \r\n      this.instance = instance;\r\n      this.instanceListenerSetter = new ListenerSetter();\r\n\r\n      this.instanceListenerSetter.add(instance as GroupCallInstance)('state', this.onState);\r\n\r\n      if(instance instanceof GroupCallInstance) {\r\n        this.currentDescription = this.groupCallDescription;\r\n      } else {\r\n        this.currentDescription = this.callDescription;\r\n        this.instanceListenerSetter.add(instance)('muted', this.onState);\r\n      }\r\n\r\n      this.container.classList.toggle('is-call', !(instance instanceof GroupCallInstance));\r\n    }\r\n\r\n    const isMuted = this.instance.isMuted;\r\n    let state = instance instanceof GroupCallInstance ? instance.state : convertCallStateToGroupState(instance.connectionState, isMuted);\r\n\r\n    const {weave} = this;\r\n\r\n    weave.componentDidMount();\r\n    \r\n    const isClosed = state === GROUP_CALL_STATE.CLOSED;\r\n    if((!document.body.classList.contains('is-calling') || isChangingInstance) || isClosed) {\r\n      if(isClosed) {\r\n        weave.setAmplitude(0);\r\n      }\r\n\r\n      SetTransition(document.body, 'is-calling', !isClosed, 250, isClosed ? () => {\r\n        weave.componentWillUnmount();\r\n\r\n        this.clearCurrentInstance();\r\n      }: undefined);\r\n    }\r\n    \r\n    if(isClosed) {\r\n      return;\r\n    }\r\n    \r\n    weave.setCurrentState(state, true);\r\n    // if(state === GROUP_CALL_STATE.CONNECTING) {\r\n    //   weave.setCurrentState(state, true);\r\n    // } else {\r\n    //   /* var a = 0;\r\n    //   animate(() => {\r\n    //     a += 0.1;\r\n    //     if(a > 1) a = 0;\r\n    //     weave.setAmplitude(a);\r\n    //     return true;\r\n    //   });\r\n    //   weave.setAmplitude(1); */\r\n    //   weave.setCurrentState(state, true);\r\n    // }\r\n    \r\n    this.setTitle(instance);\r\n    this.setDescription(instance);\r\n    this.groupCallMicrophoneIconMini.setState(!isMuted);\r\n  }\r\n\r\n  private setDescription(instance: TopbarCall['instance']) {\r\n    return this.currentDescription.update(instance as any);\r\n  }\r\n\r\n  private setTitle(instance: TopbarCall['instance']) {\r\n    if(instance instanceof GroupCallInstance) {\r\n      return this.groupCallTitle.update(instance);\r\n    } else {\r\n      replaceContent(this.center, new PeerTitle({peerId: instance.interlocutorUserId.toPeerId()}).element);\r\n    }\r\n  }\r\n\r\n  private construct() {\r\n    const {listenerSetter} = this;\r\n    const container = this.container = document.createElement('div');\r\n    container.classList.add('sidebar-header', CLASS_NAME + '-container');\r\n\r\n    const left = document.createElement('div');\r\n    left.classList.add(CLASS_NAME + '-left');\r\n\r\n    const groupCallMicrophoneIconMini = this.groupCallMicrophoneIconMini = new GroupCallMicrophoneIconMini();\r\n    \r\n    const mute = ButtonIcon();\r\n    mute.append(groupCallMicrophoneIconMini.container);\r\n    left.append(mute);\r\n\r\n    const throttledMuteClick = throttle(() => {\r\n      this.instance.toggleMuted();\r\n    }, 600, true);\r\n    \r\n    attachClickEvent(mute, (e) => {\r\n      cancelEvent(e);\r\n      throttledMuteClick();\r\n    }, {listenerSetter});\r\n    \r\n    const center = this.center = document.createElement('div');\r\n    center.classList.add(CLASS_NAME + '-center');\r\n    \r\n    this.groupCallTitle = new GroupCallTitleElement(center);\r\n    this.groupCallDescription = new GroupCallDescriptionElement(left);\r\n\r\n    this.callDescription = new CallDescriptionElement(left);\r\n    \r\n    const right = document.createElement('div');\r\n    right.classList.add(CLASS_NAME + '-right');\r\n    \r\n    const end = ButtonIcon('endcall_filled');\r\n    right.append(end);\r\n    \r\n    attachClickEvent(end, (e) => {\r\n      cancelEvent(e);\r\n\r\n      const {instance} = this;\r\n      if(!instance) {\r\n        return;\r\n      }\r\n\r\n      if(instance instanceof GroupCallInstance) {\r\n        instance.hangUp();\r\n      } else {\r\n        instance.hangUp('phoneCallDiscardReasonHangup');\r\n      }\r\n    }, {listenerSetter});\r\n\r\n    attachClickEvent(container, () => {\r\n      if(this.instance instanceof GroupCallInstance) {\r\n        if(PopupElement.getPopups(PopupGroupCall).length) {\r\n          return;\r\n        }\r\n        \r\n        new PopupGroupCall().show();\r\n      } else if(this.instance instanceof CallInstance) {\r\n        const popups = PopupElement.getPopups(PopupCall);\r\n        if(popups.find((popup) => popup.getCallInstance() === this.instance)) {\r\n          return;\r\n        }\r\n\r\n        new PopupCall(this.instance).show();\r\n      }\r\n    }, {listenerSetter});\r\n    \r\n    container.append(left, center, right);\r\n\r\n    const weave = this.weave = new TopbarWeave();\r\n    const weaveContainer = weave.render(CLASS_NAME + '-weave');\r\n    container.prepend(weaveContainer);\r\n    \r\n    document.getElementById('column-center').prepend(container);\r\n    weave.componentDidMount();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport getPeerTitle from \"../../components/wrappers/getPeerTitle\";\r\nimport wrapMessageForReply from \"../../components/wrappers/messageForReply\";\r\nimport { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport { FontFamily } from \"../../config/font\";\r\nimport { IS_MOBILE } from \"../../environment/userAgent\";\r\nimport IS_VIBRATE_SUPPORTED from \"../../environment/vibrateSupport\";\r\nimport deferredPromise, { CancellablePromise } from \"../../helpers/cancellablePromise\";\r\nimport idleController from \"../../helpers/idleController\";\r\nimport deepEqual from \"../../helpers/object/deepEqual\";\r\nimport tsNow from \"../../helpers/tsNow\";\r\nimport { Message, MessagePeerReaction, PeerNotifySettings } from \"../../layer\";\r\nimport I18n, { FormatterArguments, LangPackKey } from \"../langPack\";\r\nimport apiManagerProxy from \"../mtproto/mtprotoworker\";\r\nimport singleInstance from \"../mtproto/singleInstance\";\r\nimport webPushApiManager, { PushSubscriptionNotify } from \"../mtproto/webPushApiManager\";\r\nimport fixEmoji from \"../richTextProcessor/fixEmoji\";\r\nimport wrapPlainText from \"../richTextProcessor/wrapPlainText\";\r\nimport rootScope from \"../rootScope\";\r\nimport appImManager from \"./appImManager\";\r\nimport appRuntimeManager from \"./appRuntimeManager\";\r\nimport { AppManagers } from \"./managers\";\r\nimport generateMessageId from \"./utils/messageId/generateMessageId\";\r\nimport getPeerId from \"./utils/peers/getPeerId\";\r\n\r\ntype MyNotification = Notification & {\r\n  hidden?: boolean,\r\n  show?: () => void,\r\n};\r\n\r\nexport type NotifyOptions = Partial<{\r\n  tag: string;\r\n  image: string;\r\n  key: string;\r\n  title: string;\r\n  message: string;\r\n  silent: boolean;\r\n  onclick: () => void;\r\n  noIncrement: boolean;\r\n}>;\r\n\r\nexport type NotificationSettings = {\r\n  nodesktop: boolean,\r\n  volume: number,\r\n  novibrate: boolean,\r\n  nopreview: boolean,\r\n  nopush: boolean,\r\n  nosound: boolean\r\n};\r\n\r\nexport class UiNotificationsManager {\r\n  private notificationsUiSupport: boolean;\r\n  private notificationsShown: {[key: string]: MyNotification | true} = {};\r\n  private notificationIndex = 0;\r\n  private notificationsCount = 0;\r\n  private soundsPlayed: {[tag: string]: number} = {};\r\n  private vibrateSupport = IS_VIBRATE_SUPPORTED;\r\n  private nextSoundAt: number;\r\n  private prevSoundVolume: number;\r\n\r\n  private faviconEl: HTMLLinkElement = document.head.querySelector('link[rel=\"icon\"]');\r\n\r\n  private titleBackup = document.title;\r\n  private titleChanged = false;\r\n  private titleInterval: number;\r\n  private prevFavicon: string;\r\n\r\n  private notifySoundEl: HTMLElement;\r\n\r\n  private stopped = false;\r\n\r\n  private topMessagesDeferred: CancellablePromise<void>;\r\n\r\n  private settings: NotificationSettings = {} as any;\r\n\r\n  private registeredDevice: any;\r\n  private pushInited = false;\r\n  \r\n  private managers: AppManagers;\r\n  private setAppBadge: (contents?: any) => Promise<void>;\r\n\r\n  construct(managers: AppManagers) {\r\n    this.managers = managers;\r\n\r\n    navigator.vibrate = navigator.vibrate || (navigator as any).mozVibrate || (navigator as any).webkitVibrate;\r\n    this.setAppBadge = (navigator as any).setAppBadge && (navigator as any).setAppBadge.bind(navigator);\r\n    this.setAppBadge && this.setAppBadge(0);\r\n\r\n    this.notificationsUiSupport = ('Notification' in window) || ('mozNotification' in navigator);\r\n\r\n    this.notifySoundEl = document.createElement('div');\r\n    this.notifySoundEl.id = 'notify-sound';\r\n    document.body.append(this.notifySoundEl);\r\n\r\n    this.topMessagesDeferred = deferredPromise<void>();\r\n\r\n    singleInstance.addEventListener('deactivated', () => {\r\n      this.stop();\r\n    });\r\n\r\n    singleInstance.addEventListener('activated', () => {\r\n      if(this.stopped) {\r\n        this.start();\r\n      }\r\n    });\r\n\r\n    idleController.addEventListener('change', (idle) => {\r\n      if(this.stopped) {\r\n        return;\r\n      }\r\n\r\n      if(!idle) {\r\n        this.clear();\r\n      }\r\n\r\n      this.toggleToggler();\r\n    });\r\n\r\n    rootScope.addEventListener('notification_reset', (peerString) => {\r\n      this.soundReset(peerString);\r\n    });\r\n\r\n    rootScope.addEventListener('notification_cancel', (str) => {\r\n      this.cancel(str);\r\n    });\r\n    \r\n    if(this.setAppBadge) {\r\n      rootScope.addEventListener('folder_unread', (folder) => {\r\n        if(folder.id === 0) {\r\n          this.setAppBadge(folder.unreadUnmutedPeerIds.size);\r\n        }\r\n      });\r\n    }\r\n\r\n    webPushApiManager.addEventListener('push_init', (tokenData) => {\r\n      this.pushInited = true;\r\n      if(!this.settings.nodesktop && !this.settings.nopush) {\r\n        if(tokenData) {\r\n          this.registerDevice(tokenData);\r\n        } else {\r\n          webPushApiManager.subscribe();\r\n        }\r\n      } else {\r\n        this.unregisterDevice(tokenData);\r\n      }\r\n    });\r\n    webPushApiManager.addEventListener('push_subscribe', (tokenData) => {\r\n      this.registerDevice(tokenData);\r\n    });\r\n    webPushApiManager.addEventListener('push_unsubscribe', (tokenData) => {\r\n      this.unregisterDevice(tokenData);\r\n    });\r\n\r\n    rootScope.addEventListener('dialogs_multiupdate', () => {\r\n      //unregisterTopMsgs()\r\n      this.topMessagesDeferred.resolve();\r\n    }, {once: true});\r\n\r\n    webPushApiManager.addEventListener('push_notification_click', (notificationData) => {\r\n      if(notificationData.action === 'push_settings') {\r\n        /* this.topMessagesDeferred.then(() => {\r\n          $modal.open({\r\n            templateUrl: templateUrl('settings_modal'),\r\n            controller: 'SettingsModalController',\r\n            windowClass: 'settings_modal_window mobile_modal',\r\n            backdrop: 'single'\r\n          })\r\n        }); */\r\n        return;\r\n      }\r\n\r\n      if(notificationData.action === 'mute1d') {\r\n        this.managers.apiManager.invokeApi('account.updateDeviceLocked', {\r\n          period: 86400\r\n        }).then(() => {\r\n          // var toastData = toaster.pop({\r\n          //   type: 'info',\r\n          //   body: _('push_action_mute1d_success'),\r\n          //   bodyOutputType: 'trustedHtml',\r\n          //   clickHandler: () => {\r\n          //     toaster.clear(toastData)\r\n          //   },\r\n          //   showCloseButton: false\r\n          // })\r\n        });\r\n\r\n        return;\r\n      }\r\n\r\n      const peerId = notificationData.custom && notificationData.custom.peerId.toPeerId();\r\n      console.log('click', notificationData, peerId);\r\n      if(peerId) {\r\n        this.topMessagesDeferred.then(async() => {\r\n          if(notificationData.custom.channel_id &&\r\n              !(await this.managers.appChatsManager.hasChat(notificationData.custom.channel_id))) {\r\n            return;\r\n          }\r\n\r\n          if(peerId.isUser() && !(await this.managers.appUsersManager.hasUser(peerId))) {\r\n            return;\r\n          }\r\n\r\n          appImManager.setInnerPeer({\r\n            peerId,\r\n            lastMsgId: generateMessageId(+notificationData.custom.msg_id)\r\n          });\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  public async buildNotification({message, fwdCount, peerReaction, peerTypeNotifySettings}: {\r\n    message: Message.message | Message.messageService,\r\n    fwdCount?: number,\r\n    peerReaction?: MessagePeerReaction,\r\n    peerTypeNotifySettings?: PeerNotifySettings\r\n  }) {\r\n    const peerId = message.peerId;\r\n    const isAnyChat = peerId.isAnyChat();\r\n    const notification: NotifyOptions = {};\r\n    const peerString = await this.managers.appPeersManager.getPeerString(peerId);\r\n    let notificationMessage: string;\r\n\r\n    if(peerTypeNotifySettings.show_previews) {\r\n      if(message._ === 'message' && message.fwd_from && fwdCount > 1) {\r\n        notificationMessage = I18n.format('Notifications.Forwarded', true, [fwdCount]);\r\n      } else {\r\n        notificationMessage = await wrapMessageForReply(message, undefined, undefined, true);\r\n\r\n        if(peerReaction) {\r\n          const langPackKey: LangPackKey = /* isAnyChat ? 'Notification.Group.Reacted' :  */'Notification.Contact.Reacted';\r\n          const args: FormatterArguments = [\r\n            fixEmoji(peerReaction.reaction), // can be plain heart\r\n            notificationMessage\r\n          ];\r\n  \r\n          /* if(isAnyChat) {\r\n            args.unshift(appPeersManager.getPeerTitle(message.fromId, true));\r\n          } */\r\n  \r\n          notificationMessage = I18n.format(langPackKey, true, args);\r\n        }\r\n      }\r\n    } else {\r\n      notificationMessage = I18n.format('Notifications.New', true);\r\n    }\r\n\r\n    if(peerReaction) {\r\n      notification.noIncrement = true;\r\n      notification.silent = true;\r\n    }\r\n\r\n    const notificationFromPeerId = peerReaction ? getPeerId(peerReaction.peer_id) : message.fromId;\r\n    notification.title = await getPeerTitle(peerId, true, undefined, undefined, this.managers);\r\n    if(isAnyChat && notificationFromPeerId !== message.peerId) {\r\n      notification.title = await getPeerTitle(notificationFromPeerId, true, undefined, undefined, this.managers) +\r\n        ' @ ' +\r\n        notification.title;\r\n    }\r\n\r\n    notification.title = wrapPlainText(notification.title);\r\n\r\n    notification.onclick = () => {\r\n      appImManager.setInnerPeer({peerId, lastMsgId: message.mid});\r\n    };\r\n\r\n    notification.message = notificationMessage;\r\n    notification.key = 'msg' + message.mid;\r\n    notification.tag = peerString;\r\n    notification.silent = true;//message.pFlags.silent || false;\r\n\r\n    const peerPhoto = await this.managers.appPeersManager.getPeerPhoto(peerId);\r\n    if(peerPhoto) {\r\n      this.managers.appAvatarsManager.loadAvatar(peerId, peerPhoto, 'photo_small').then((url) => {\r\n        // ! WARNING, message can be already read\r\n        if(message.pFlags.unread || peerReaction) {\r\n          notification.image = url;\r\n          this.notify(notification);\r\n        }\r\n      });\r\n    } else {\r\n      this.notify(notification);\r\n    }\r\n  }\r\n\r\n  private toggleToggler(enable = idleController.isIdle) {\r\n    if(IS_MOBILE) return;\r\n\r\n    const resetTitle = (isBlink?: boolean) => {\r\n      this.titleChanged = false;\r\n      document.title = this.titleBackup;\r\n      this.setFavicon();\r\n    };\r\n\r\n    window.clearInterval(this.titleInterval);\r\n    this.titleInterval = 0;\r\n\r\n    if(!enable) {\r\n      resetTitle();\r\n    } else {\r\n      this.titleInterval = window.setInterval(() => {\r\n        const count = this.notificationsCount;\r\n        if(!count) {\r\n          this.toggleToggler(false);\r\n        } else if(this.titleChanged) {\r\n          resetTitle(true);\r\n        } else {\r\n          this.titleChanged = true;\r\n          document.title = I18n.format('Notifications.Count', true, [count]);\r\n          //this.setFavicon('assets/img/favicon_unread.ico');\r\n\r\n          // fetch('assets/img/favicon.ico')\r\n          // .then((res) => res.blob())\r\n          // .then((blob) => {\r\n            // const img = document.createElement('img');\r\n            // img.src = URL.createObjectURL(blob);\r\n\r\n            const canvas = document.createElement('canvas');\r\n            canvas.width = 32 * window.devicePixelRatio;\r\n            canvas.height = canvas.width;\r\n  \r\n            const ctx = canvas.getContext('2d');\r\n            ctx.beginPath();\r\n            ctx.arc(canvas.width / 2, canvas.height / 2, canvas.width / 2, 0, 2 * Math.PI, false);\r\n            ctx.fillStyle = '#3390ec';\r\n            ctx.fill();\r\n\r\n            let fontSize = 24;\r\n            let str = '' + count;\r\n            if(count < 10) {\r\n              fontSize = 22;\r\n            } else if(count < 100) {\r\n              fontSize = 20;\r\n            } else {\r\n              str = '99+';\r\n              fontSize = 16;\r\n            }\r\n\r\n            fontSize *= window.devicePixelRatio;\r\n            \r\n            ctx.font = `700 ${fontSize}px ${FontFamily}`;\r\n            ctx.textBaseline = 'middle';\r\n            ctx.textAlign = 'center';\r\n            ctx.fillStyle = 'white';\r\n            ctx.fillText(str, canvas.width / 2, canvas.height * .5625);\r\n\r\n            /* const ctx = canvas.getContext('2d');\r\n            ctx.drawImage(img, 0, 0, canvas.width, canvas.height); */\r\n  \r\n            this.setFavicon(canvas.toDataURL());\r\n          // });\r\n        }\r\n      }, 1000);\r\n    }\r\n  }\r\n\r\n  private setFavicon(href: string = 'assets/img/favicon.ico') {\r\n    if(this.prevFavicon === href) {\r\n      return;\r\n    }\r\n\r\n    const link = this.faviconEl.cloneNode() as HTMLLinkElement;\r\n    link.href = href;\r\n    this.faviconEl.parentNode.replaceChild(link, this.faviconEl);\r\n    this.faviconEl = link;\r\n\r\n    this.prevFavicon = href;\r\n  }\r\n\r\n  public notify(data: NotifyOptions) {\r\n    //console.log('notify', data, rootScope.idle.isIDLE, this.notificationsUiSupport, this.stopped);\r\n    \r\n    if(this.stopped) {\r\n      return;\r\n    }\r\n\r\n    // FFOS Notification blob src bug workaround\r\n    /* if(Config.Navigator.ffos && !Config.Navigator.ffos2p) {\r\n      data.image = 'https://telegram.org/img/t_logo.png'\r\n    }\r\n    else if (data.image && !angular.isString(data.image)) {\r\n      if (Config.Navigator.ffos2p) {\r\n        FileManager.getDataUrl(data.image, 'image/jpeg').then(function (url) {\r\n          data.image = url\r\n          notify(data)\r\n        })\r\n        return false\r\n      } else {\r\n        data.image = FileManager.getUrl(data.image, 'image/jpeg')\r\n      }\r\n    }\r\n    else */ if(!data.image) {\r\n      data.image = 'assets/img/logo_filled_rounded.png';\r\n    }\r\n    // console.log('notify image', data.image)\r\n\r\n    if(!data.noIncrement) {\r\n      ++this.notificationsCount;\r\n    }\r\n\r\n    if(!this.titleInterval) {\r\n      this.toggleToggler();\r\n    }\r\n\r\n    const idx = ++this.notificationIndex;\r\n    const key = data.key || 'k' + idx;\r\n    this.notificationsShown[key] = true;\r\n\r\n    const now = tsNow();\r\n    if(this.settings.volume > 0 && !this.settings.nosound/* &&\r\n      (\r\n        !data.tag ||\r\n        !this.soundsPlayed[data.tag] ||\r\n        now > this.soundsPlayed[data.tag] + 60000\r\n      ) */\r\n    ) {\r\n      this.testSound(this.settings.volume);\r\n      this.soundsPlayed[data.tag] = now;\r\n    }\r\n\r\n    if(!this.notificationsUiSupport ||\r\n      'Notification' in window && Notification.permission !== 'granted') {\r\n      return false;\r\n    }\r\n\r\n    if(this.settings.nodesktop) {\r\n      if(this.vibrateSupport && !this.settings.novibrate) {\r\n        navigator.vibrate([200, 100, 200]);\r\n        return;\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    let notification: MyNotification;\r\n\r\n    if('Notification' in window) {\r\n      try {\r\n        if(data.tag) {\r\n          for(let i in this.notificationsShown) {\r\n            const notification = this.notificationsShown[i];\r\n            if(typeof(notification) !== 'boolean' && notification.tag === data.tag) {\r\n              notification.hidden = true;\r\n            }\r\n          }\r\n        }\r\n\r\n        notification = new Notification(data.title, {\r\n          icon: data.image || '',\r\n          body: data.message || '',\r\n          tag: data.tag || '',\r\n          silent: data.silent || false\r\n        });\r\n\r\n        //console.log('notify constructed notification');\r\n      } catch(e) {\r\n        this.notificationsUiSupport = false;\r\n        webPushApiManager.setLocalNotificationsDisabled();\r\n        return;\r\n      }\r\n    } /* else if('mozNotification' in navigator) {\r\n      notification = navigator.mozNotification.createNotification(data.title, data.message || '', data.image || '')\r\n    } else if(notificationsMsSiteMode) {\r\n      window.external.msSiteModeClearIconOverlay()\r\n      window.external.msSiteModeSetIconOverlay('img/icons/icon16.png', data.title)\r\n      window.external.msSiteModeActivate()\r\n      notification = {\r\n        index: idx\r\n      }\r\n    } */ else {\r\n      return;\r\n    }\r\n\r\n    notification.onclick = () => {\r\n      notification.close();\r\n      appRuntimeManager.focus();\r\n      this.clear();\r\n      if(data.onclick) {\r\n        data.onclick();\r\n      }\r\n    };\r\n\r\n    notification.onclose = () => {\r\n      if(!notification.hidden) {\r\n        delete this.notificationsShown[key];\r\n        this.clear();\r\n      }\r\n    };\r\n\r\n    if(notification.show) {\r\n      notification.show();\r\n    }\r\n    this.notificationsShown[key] = notification;\r\n\r\n    if(!IS_MOBILE) {\r\n      setTimeout(() => {\r\n        this.hide(key);\r\n      }, 8000);\r\n    }\r\n  }\r\n\r\n  public updateLocalSettings = () => {\r\n    const keys = ['notify_nodesktop', 'notify_volume', 'notify_novibrate', 'notify_nopreview', 'notify_nopush'];\r\n    const promises = keys.map(() => undefined);\r\n    // const promises = keys.map((k) => stateStorage.get(k as any));\r\n    Promise.all(promises)\r\n    .then((updSettings) => {\r\n      this.settings.nodesktop = updSettings[0];\r\n      this.settings.volume = updSettings[1] === undefined ? 0.5 : updSettings[1];\r\n      this.settings.novibrate = updSettings[2];\r\n      this.settings.nopreview = updSettings[3];\r\n      this.settings.nopush = updSettings[4];\r\n\r\n      if(this.pushInited) {\r\n        const needPush = !this.settings.nopush && !this.settings.nodesktop && webPushApiManager.isAvailable || false;\r\n        const hasPush = this.registeredDevice !== false;\r\n        if(needPush !== hasPush) {\r\n          if(needPush) {\r\n            webPushApiManager.subscribe();\r\n          } else {\r\n            webPushApiManager.unsubscribe();\r\n          }\r\n        }\r\n      }\r\n\r\n      webPushApiManager.setSettings(this.settings);\r\n    });\r\n\r\n    apiManagerProxy.getState().then((state) => {\r\n      this.settings.nosound = !state.settings.notifications.sound;\r\n    });\r\n  }\r\n\r\n  public getLocalSettings() {\r\n    return this.settings;\r\n  }\r\n\r\n  private hide(key: string) {\r\n    const notification = this.notificationsShown[key];\r\n    if(notification && typeof(notification) !== 'boolean') {\r\n      try {\r\n        if(notification.close) {\r\n          notification.hidden = true;\r\n          notification.close();\r\n        }\r\n      } catch(e) {}\r\n    }\r\n  }\r\n\r\n  public soundReset(tag: string) {\r\n    delete this.soundsPlayed[tag];\r\n  }\r\n\r\n  private requestPermission = () => {\r\n    Notification.requestPermission();\r\n    window.removeEventListener('click', this.requestPermission);\r\n  };\r\n\r\n  public testSound(volume: number) {\r\n    const now = tsNow();\r\n    if(this.nextSoundAt && now < this.nextSoundAt && this.prevSoundVolume === volume) {\r\n      return;\r\n    }\r\n\r\n    this.nextSoundAt = now + 1000;\r\n    this.prevSoundVolume = volume;\r\n    const filename = 'assets/audio/notification.mp3';\r\n    const audio = document.createElement('audio');\r\n    audio.autoplay = true;\r\n    audio.setAttribute('mozaudiochannel', 'notification');\r\n    audio.volume = volume;\r\n    audio.innerHTML = `\r\n      <source src=\"${filename}\" type=\"audio/mpeg\" />\r\n      <embed hidden=\"true\" autostart=\"true\" loop=\"false\" volume=\"${volume * 100}\" src=\"${filename}\" />\r\n    `;\r\n    this.notifySoundEl.append(audio);\r\n\r\n    audio.addEventListener('ended', () => {\r\n      audio.remove();\r\n    }, {once: true});\r\n  }\r\n\r\n  public cancel(key: string) {\r\n    const notification = this.notificationsShown[key];\r\n    if(notification) {\r\n      if(this.notificationsCount > 0) {\r\n        --this.notificationsCount;\r\n      }\r\n\r\n      try {\r\n        if(typeof(notification) !== 'boolean' && notification.close) {\r\n          notification.hidden = true;\r\n          notification.close();\r\n        }/*  else if(notificationsMsSiteMode &&\r\n          notification.index === notificationIndex) {\r\n          window.external.msSiteModeClearIconOverlay()\r\n        } */\r\n      } catch(e) {}\r\n\r\n      delete this.notificationsShown[key];\r\n    }\r\n  }\r\n\r\n  public clear() {\r\n    /* if(notificationsMsSiteMode) {\r\n      window.external.msSiteModeClearIconOverlay()\r\n    } else { */\r\n      for(const i in this.notificationsShown) {\r\n        const notification = this.notificationsShown[i];\r\n        try {\r\n          if(typeof(notification) !== 'boolean' && notification.close) {\r\n            notification.close();\r\n          }\r\n        } catch(e) {}\r\n      }\r\n    /* } */\r\n    this.notificationsShown = {};\r\n    this.notificationsCount = 0;\r\n\r\n    webPushApiManager.hidePushNotifications();\r\n  }\r\n\r\n  public start() {\r\n    this.updateLocalSettings();\r\n    rootScope.addEventListener('settings_updated', this.updateLocalSettings);\r\n    webPushApiManager.start();\r\n\r\n    if(!this.notificationsUiSupport) {\r\n      return false;\r\n    }\r\n\r\n    if('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {\r\n      window.addEventListener('click', this.requestPermission);\r\n    }\r\n\r\n    try {\r\n      if('onbeforeunload' in window) {\r\n        window.addEventListener('beforeunload', this.clear);\r\n      }\r\n    } catch(e) {}\r\n  }\r\n\r\n  private stop() {\r\n    this.clear();\r\n    window.clearInterval(this.titleInterval);\r\n    this.titleInterval = 0;\r\n    this.setFavicon();\r\n    this.stopped = true;\r\n  }\r\n\r\n  private registerDevice(tokenData: PushSubscriptionNotify) {\r\n    if(this.registeredDevice && deepEqual(this.registeredDevice, tokenData)) {\r\n      return false;\r\n    }\r\n\r\n    this.managers.apiManager.invokeApi('account.registerDevice', {\r\n      token_type: tokenData.tokenType,\r\n      token: tokenData.tokenValue,\r\n      other_uids: [],\r\n      app_sandbox: false,\r\n      secret: new Uint8Array()\r\n    }).then(() => {\r\n      this.registeredDevice = tokenData;\r\n    }, (error) => {\r\n      error.handled = true;\r\n    });\r\n  }\r\n\r\n  private unregisterDevice(tokenData: PushSubscriptionNotify) {\r\n    if(!this.registeredDevice) {\r\n      return false;\r\n    }\r\n\r\n    this.managers.apiManager.invokeApi('account.unregisterDevice', {\r\n      token_type: tokenData.tokenType,\r\n      token: tokenData.tokenValue,\r\n      other_uids: []\r\n    }).then(() => {\r\n      this.registeredDevice = false;\r\n    }, (error) => {\r\n      error.handled = true;\r\n    });\r\n  }\r\n}\r\n\r\nconst uiNotificationsManager = new UiNotificationsManager();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.uiNotificationsManager = uiNotificationsManager);\r\nexport default uiNotificationsManager;\r\n","export default async function getFilesFromEvent(e: ClipboardEvent | DragEvent, onlyTypes = false): Promise<any[]> {\r\n  const files: any[] = [];\r\n\r\n  const scanFiles = async(entry: any, item: DataTransferItem) => {\r\n    if(entry.isDirectory) {\r\n      const directoryReader = entry.createReader();\r\n      await new Promise<void>((resolve, reject) => {\r\n        directoryReader.readEntries(async(entries: any) => {\r\n          for(const entry of entries) {\r\n            await scanFiles(entry, item);\r\n          }\r\n\r\n          resolve();\r\n        });\r\n      });\r\n    } else if(entry) {\r\n      if(onlyTypes) {\r\n        files.push(entry.type);\r\n      } else {\r\n        const itemFile = item.getAsFile(); // * Safari can't handle entry.file with pasting\r\n        const file = entry instanceof File ? \r\n          entry : \r\n          (\r\n            entry instanceof DataTransferItem ? \r\n              entry.getAsFile() : \r\n              await new Promise((resolve, reject) => entry.file(resolve, (err: any) => resolve(itemFile)))\r\n          );\r\n\r\n        /* if(!onlyTypes) {\r\n          console.log('getFilesFromEvent: got file', item, file);\r\n        } */\r\n\r\n        if(!file) return;\r\n        files.push(file);\r\n      }\r\n    }\r\n  };\r\n\r\n  if(e instanceof DragEvent && e.dataTransfer.files && !e.dataTransfer.items) {\r\n    for(let i = 0; i < e.dataTransfer.files.length; i++) {\r\n      const file = e.dataTransfer.files[i];\r\n      files.push(onlyTypes ? file.type : file);\r\n    }\r\n  } else {\r\n    // @ts-ignore\r\n    const items = (e.dataTransfer || e.clipboardData || e.originalEvent.clipboardData).items;\r\n\r\n    const promises: Promise<any>[] = [];\r\n    for(let i = 0; i < items.length; ++i) {\r\n      const item: DataTransferItem = items[i];\r\n      if(item.kind === 'file') {\r\n        const entry = (onlyTypes ? item : item.webkitGetAsEntry()) || item.getAsFile();\r\n        promises.push(scanFiles(entry, item));\r\n      }\r\n    }\r\n    \r\n    await Promise.all(promises);\r\n  }\r\n\r\n  /* if(!onlyTypes) {\r\n    console.log('getFilesFromEvent: got files:', e, files);\r\n  } */\r\n  \r\n  return files;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport animationIntersector from '../../components/animationIntersector';\r\nimport appSidebarLeft, { LEFT_COLUMN_ACTIVE_CLASSNAME } from \"../../components/sidebarLeft\";\r\nimport appSidebarRight, { RIGHT_COLUMN_ACTIVE_CLASSNAME } from '../../components/sidebarRight';\r\nimport mediaSizes, { ScreenSize } from '../../helpers/mediaSizes';\r\nimport { logger, LogTypes } from \"../logger\";\r\nimport rootScope from '../rootScope';\r\nimport Chat, { ChatType } from '../../components/chat/chat';\r\nimport PopupNewMedia, { getCurrentNewMediaPopup } from '../../components/popups/newMedia';\r\nimport MarkupTooltip from '../../components/chat/markupTooltip';\r\nimport IS_TOUCH_SUPPORTED from '../../environment/touchSupport';\r\nimport SetTransition from '../../components/singleTransition';\r\nimport ChatDragAndDrop from '../../components/chat/dragAndDrop';\r\nimport { doubleRaf } from '../../helpers/schedulers';\r\nimport lottieLoader from '../rlottie/lottieLoader';\r\nimport useHeavyAnimationCheck, { dispatchHeavyAnimationEvent } from '../../hooks/useHeavyAnimationCheck';\r\nimport stateStorage from '../stateStorage';\r\nimport { MOUNT_CLASS_TO } from '../../config/debug';\r\nimport appNavigationController from '../../components/appNavigationController';\r\nimport AppPrivateSearchTab from '../../components/sidebarRight/tabs/search';\r\nimport I18n, { i18n, join, LangPackKey } from '../langPack';\r\nimport { ChatFull, ChatInvite, ChatParticipants, Message, MessageAction, MessageMedia, SendMessageAction } from '../../layer';\r\nimport PeerTitle from '../../components/peerTitle';\r\nimport PopupPeer from '../../components/popups/peer';\r\nimport blurActiveElement from '../../helpers/dom/blurActiveElement';\r\nimport cancelEvent from '../../helpers/dom/cancelEvent';\r\nimport disableTransition from '../../helpers/dom/disableTransition';\r\nimport placeCaretAtEnd from '../../helpers/dom/placeCaretAtEnd';\r\nimport replaceContent from '../../helpers/dom/replaceContent';\r\nimport whichChild from '../../helpers/dom/whichChild';\r\nimport PopupElement from '../../components/popups';\r\nimport singleInstance, { InstanceDeactivateReason, SingleInstance } from '../mtproto/singleInstance';\r\nimport PopupStickers from '../../components/popups/stickers';\r\nimport PopupJoinChatInvite from '../../components/popups/joinChatInvite';\r\nimport { toast, toastNew } from '../../components/toast';\r\nimport debounce from '../../helpers/schedulers/debounce';\r\nimport pause from '../../helpers/schedulers/pause';\r\nimport { InternalLink, InternalLinkTypeMap, INTERNAL_LINK_TYPE } from './internalLink';\r\nimport MEDIA_MIME_TYPES_SUPPORTED from '../../environment/mediaMimeTypesSupport';\r\nimport { NULL_PEER_ID } from '../mtproto/mtproto_config';\r\nimport telegramMeWebManager from '../mtproto/telegramMeWebManager';\r\nimport { ONE_DAY } from '../../helpers/date';\r\nimport type { GroupCallId, MyGroupCall } from './appGroupCallsManager';\r\nimport TopbarCall from '../../components/topbarCall';\r\nimport confirmationPopup from '../../components/confirmationPopup';\r\nimport IS_GROUP_CALL_SUPPORTED from '../../environment/groupCallSupport';\r\nimport IS_CALL_SUPPORTED from '../../environment/callSupport';\r\nimport { CallType } from '../calls/types';\r\nimport { Modify, SendMessageEmojiInteractionData } from '../../types';\r\nimport htmlToSpan from '../../helpers/dom/htmlToSpan';\r\nimport getVisibleRect from '../../helpers/dom/getVisibleRect';\r\nimport { simulateClickEvent } from '../../helpers/dom/clickEvent';\r\nimport PopupCall from '../../components/call';\r\nimport copy from '../../helpers/object/copy';\r\nimport getObjectKeysAndSort from '../../helpers/object/getObjectKeysAndSort';\r\nimport type GroupCallInstance from '../calls/groupCallInstance';\r\nimport type CallInstance from '../calls/callInstance';\r\nimport numberThousandSplitter from '../../helpers/number/numberThousandSplitter';\r\nimport ChatBackgroundPatternRenderer from '../../components/chat/patternRenderer';\r\nimport { IS_FIREFOX } from '../../environment/userAgent';\r\nimport compareVersion from '../../helpers/compareVersion';\r\nimport { AppManagers } from './managers';\r\nimport uiNotificationsManager from './uiNotificationsManager';\r\nimport appMediaPlaybackController from '../../components/appMediaPlaybackController';\r\nimport { PHONE_NUMBER_REG_EXP } from '../richTextProcessor';\r\nimport wrapEmojiText from '../richTextProcessor/wrapEmojiText';\r\nimport wrapRichText from '../richTextProcessor/wrapRichText';\r\nimport wrapUrl from '../richTextProcessor/wrapUrl';\r\nimport generateMessageId from './utils/messageId/generateMessageId';\r\nimport getUserStatusString from '../../components/wrappers/getUserStatusString';\r\nimport getChatMembersString from '../../components/wrappers/getChatMembersString';\r\nimport { STATE_INIT } from '../../config/state';\r\nimport CacheStorageController from '../cacheStorage';\r\nimport themeController from '../../helpers/themeController';\r\nimport overlayCounter from '../../helpers/overlayCounter';\r\nimport appDialogsManager from './appDialogsManager';\r\nimport idleController from '../../helpers/idleController';\r\nimport EventListenerBase from '../../helpers/eventListenerBase';\r\nimport { AckedResult } from '../mtproto/superMessagePort';\r\nimport groupCallsController from '../calls/groupCallsController';\r\nimport callsController from '../calls/callsController';\r\nimport getFilesFromEvent from '../../helpers/files/getFilesFromEvent';\r\nimport apiManagerProxy from '../mtproto/mtprotoworker';\r\nimport appRuntimeManager from './appRuntimeManager';\r\nimport paymentsWrapCurrencyAmount from '../../helpers/paymentsWrapCurrencyAmount';\r\nimport findUpClassName from '../../helpers/dom/findUpClassName';\r\nimport { CLICK_EVENT_NAME } from '../../helpers/dom/clickEvent';\r\n\r\nexport const CHAT_ANIMATION_GROUP = 'chat';\r\n\r\nexport type ChatSavedPosition = {\r\n  mids: number[], \r\n  top: number\r\n};\r\n\r\nexport type ChatSetPeerOptions = {\r\n  peerId?: PeerId, \r\n  lastMsgId?: number, \r\n  threadId?: number,\r\n  startParam?: string\r\n};\r\n\r\nexport type ChatSetInnerPeerOptions = Modify<ChatSetPeerOptions, {\r\n  peerId: PeerId\r\n}> & {\r\n  type?: ChatType\r\n};\r\n\r\nexport class AppImManager extends EventListenerBase<{\r\n  chat_changing: (details: {from: Chat, to: Chat}) => void,\r\n  peer_changed: (peerId: PeerId) => void,\r\n  peer_changing: (chat: Chat) => void,\r\n}> {\r\n  public columnEl = document.getElementById('column-center') as HTMLDivElement;\r\n  public chatsContainer: HTMLElement;\r\n\r\n  public offline = false;\r\n  public updateStatusInterval = 0;\r\n\r\n  public log: ReturnType<typeof logger>;\r\n\r\n  public setPeerPromise: Promise<void> = null;\r\n\r\n  public tabId = -1;\r\n  \r\n  public chats: Chat[] = [];\r\n  private prevTab: HTMLElement;\r\n  private chatsSelectTabDebounced: () => void;\r\n  \r\n  public markupTooltip: MarkupTooltip;\r\n  private backgroundPromises: {[slug: string]: Promise<string>};\r\n  \r\n  private topbarCall: TopbarCall;\r\n  public emojiAnimationContainer: HTMLDivElement;\r\n\r\n  private lastBackgroundUrl: string;\r\n\r\n  public managers: AppManagers;\r\n  \r\n  public cacheStorage = new CacheStorageController('cachedFiles');\r\n\r\n  get myId() {\r\n    return rootScope.myId;\r\n  }\r\n\r\n  get chat(): Chat {\r\n    return this.chats[this.chats.length - 1];\r\n  }\r\n\r\n  public construct(managers: AppManagers) {\r\n    this.managers = managers;\r\n\r\n    const {\r\n      apiUpdatesManager\r\n    } = managers;\r\n    apiUpdatesManager.attach(I18n.lastRequestedLangCode);\r\n    \r\n    appMediaPlaybackController.construct(managers);\r\n    uiNotificationsManager.construct(managers);\r\n    // uiNotificationsManager.start();\r\n\r\n    this.log = logger('IM', LogTypes.Log | LogTypes.Warn | LogTypes.Debug | LogTypes.Error);\r\n\r\n    this.backgroundPromises = {};\r\n    STATE_INIT.settings.themes.forEach((theme) => {\r\n      if(theme.background.slug) {\r\n        const url = 'assets/img/' + theme.background.slug + '.svg' + (IS_FIREFOX ? '?1' : '');\r\n        this.backgroundPromises[theme.background.slug] = Promise.resolve(url);\r\n      }\r\n    });\r\n\r\n    this.selectTab(0);\r\n\r\n    idleController.addEventListener('change', (idle) => {\r\n      this.offline = idle;\r\n      this.updateStatus();\r\n      if(idle) {\r\n        clearInterval(this.updateStatusInterval);\r\n      } else {\r\n        this.updateStatusInterval = window.setInterval(() => this.updateStatus(), 50e3);\r\n      }\r\n    });\r\n    \r\n    this.chatsContainer = document.createElement('div');\r\n    this.chatsContainer.classList.add('chats-container', 'tabs-container');\r\n    this.chatsContainer.dataset.animation = 'navigation';\r\n\r\n    this.emojiAnimationContainer = document.createElement('div');\r\n    this.emojiAnimationContainer.classList.add('emoji-animation-container');\r\n    this.appendEmojiAnimationContainer(mediaSizes.activeScreen);\r\n\r\n    this.columnEl.append(this.chatsContainer);\r\n    \r\n    this.createNewChat();\r\n    this.chatsSelectTab(this.chat.container);\r\n\r\n    appNavigationController.onHashChange = this.onHashChange;\r\n    //window.addEventListener('hashchange', this.onHashChange);\r\n\r\n    this.setSettings();\r\n    rootScope.addEventListener('settings_updated', this.setSettings);\r\n\r\n    useHeavyAnimationCheck(() => {\r\n      animationIntersector.setOnlyOnePlayableGroup('lock');\r\n      animationIntersector.checkAnimations(true);\r\n    }, () => {\r\n      animationIntersector.setOnlyOnePlayableGroup('');\r\n      animationIntersector.checkAnimations(false);\r\n    });\r\n\r\n    if(IS_FIREFOX && apiManagerProxy.oldVersion && compareVersion(apiManagerProxy.oldVersion, '1.4.3') === -1) {\r\n      this.deleteFilesIterative((response) => {\r\n        return response.headers.get('Content-Type') === 'image/svg+xml';\r\n      }).then(() => {\r\n        this.applyCurrentTheme();\r\n      });\r\n    } else {\r\n      this.applyCurrentTheme();\r\n    }\r\n\r\n    // * fix simultaneous opened both sidebars, can happen when floating sidebar is opened with left sidebar\r\n    mediaSizes.addEventListener('changeScreen', (from, to) => {\r\n      if(document.body.classList.contains(LEFT_COLUMN_ACTIVE_CLASSNAME) \r\n        && document.body.classList.contains(RIGHT_COLUMN_ACTIVE_CLASSNAME)) {\r\n        appSidebarRight.toggleSidebar(false);\r\n      }\r\n\r\n      this.appendEmojiAnimationContainer(to);\r\n    });\r\n\r\n    mediaSizes.addEventListener('resize', () => {\r\n      // const perf = performance.now();\r\n      const rect = this.chatsContainer.getBoundingClientRect();\r\n      ChatBackgroundPatternRenderer.resizeInstances(rect.width, rect.height).then(() => {\r\n        // this.log.warn('resize bg time:', performance.now() - perf);\r\n        // for(const chat of this.chats) {\r\n        //   if(chat.renderDarkPattern) {\r\n        //     chat.renderDarkPattern();\r\n        //   }\r\n        // }\r\n      });\r\n    });\r\n\r\n    this.addEventListener('peer_changing', (chat) => {\r\n      this.saveChatPosition(chat);\r\n    });\r\n\r\n    rootScope.addEventListener('theme_change', () => {\r\n      this.applyCurrentTheme();\r\n    });\r\n\r\n    rootScope.addEventListener('choosing_sticker', (choosing) => {\r\n      this.setChoosingStickerTyping(!choosing);\r\n    });\r\n\r\n    rootScope.addEventListener('peer_typings', ({peerId, typings}) => {\r\n      const chat = this.chat;\r\n      if(\r\n        !chat || \r\n        chat.peerId !== peerId || \r\n        overlayCounter.isOverlayActive || (\r\n          mediaSizes.activeScreen === ScreenSize.mobile && \r\n          this.tabId !== 1\r\n        )\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      const typing = typings.find((typing) => typing.action._ === 'sendMessageEmojiInteraction');\r\n      if(typing?.action?._ === 'sendMessageEmojiInteraction') {\r\n        const action = typing.action;\r\n        const bubble = chat.bubbles.bubbles[generateMessageId(typing.action.msg_id)];\r\n        if(bubble && bubble.classList.contains('emoji-big') && bubble.classList.contains('sticker') && getVisibleRect(bubble, chat.bubbles.scrollable.container)) {\r\n          const stickerWrapper: HTMLElement = bubble.querySelector('.media-sticker-wrapper:not(.bubble-hover-reaction-sticker):not(.reaction-sticker)');\r\n\r\n          const data: SendMessageEmojiInteractionData = JSON.parse(action.interaction.data);\r\n          data.a.forEach((a) => {\r\n            setTimeout(() => {\r\n              simulateClickEvent(stickerWrapper);\r\n            }, a.t * 1000);\r\n          });\r\n          \r\n          this.managers.appMessagesManager.setTyping(peerId, {\r\n            _: 'sendMessageEmojiInteractionSeen',\r\n            emoticon: action.emoticon\r\n          });\r\n        }\r\n      }\r\n    });\r\n\r\n    const onInstanceDeactivated = (reason: InstanceDeactivateReason) => {\r\n      const isUpdated = reason === 'version';\r\n      const popup = new PopupElement('popup-instance-deactivated', {overlayClosable: true});\r\n      const c = document.createElement('div');\r\n      c.classList.add('instance-deactivated-container');\r\n      (popup as any).container.replaceWith(c);\r\n\r\n      const header = document.createElement('div');\r\n      header.classList.add('header');\r\n      header.append(i18n(isUpdated ? 'Deactivated.Version.Title' : 'Deactivated.Title'));\r\n\r\n      const subtitle = document.createElement('div');\r\n      subtitle.classList.add('subtitle');\r\n      subtitle.append(i18n(isUpdated ? 'Deactivated.Version.Subtitle' : 'Deactivated.Subtitle'));\r\n\r\n      c.append(header, subtitle);\r\n\r\n      document.body.classList.add('deactivated');\r\n\r\n      const onClose = isUpdated ? () => {\r\n        appRuntimeManager.reload();\r\n      } : () => {\r\n        document.body.classList.add('deactivated-backwards');\r\n\r\n        singleInstance.activateInstance();\r\n\r\n        setTimeout(() => {\r\n          document.body.classList.remove('deactivated', 'deactivated-backwards');\r\n        }, 333);\r\n      };\r\n\r\n      popup.addEventListener('close', onClose);\r\n      popup.show();\r\n    };\r\n\r\n    singleInstance.addEventListener('deactivated', onInstanceDeactivated);\r\n    if(singleInstance.deactivatedReason) {\r\n      onInstanceDeactivated(singleInstance.deactivatedReason);\r\n    }\r\n\r\n    // remove scroll listener when setting chat to tray\r\n    this.addEventListener('chat_changing', ({to}) => {\r\n      this.toggleChatGradientAnimation(to);\r\n    });\r\n\r\n    rootScope.addEventListener('service_notification', (update) => {\r\n      confirmationPopup({\r\n        button: {langKey: 'OK', isCancel: true},\r\n        description: wrapRichText(update.message)\r\n      });\r\n    });\r\n\r\n    rootScope.addEventListener('payment_sent', async({peerId, mid, receiptMessage}) => {\r\n      const message = await this.managers.appMessagesManager.getMessageByPeer(peerId, mid);\r\n      if(!message) {\r\n        return;\r\n      }\r\n\r\n      const action = receiptMessage.action as MessageAction.messageActionPaymentSent;\r\n      toastNew({\r\n        langPackKey: 'PaymentInfoHint',\r\n        langPackArguments: [\r\n          paymentsWrapCurrencyAmount(action.total_amount, action.currency),\r\n          wrapEmojiText(((message as Message.message).media as MessageMedia.messageMediaInvoice).title)\r\n        ]\r\n      });\r\n    });\r\n\r\n    (window as any).onSpoilerClick = (e: MouseEvent) => {\r\n      const spoiler = findUpClassName(e.target, 'spoiler');\r\n      const parentElement = findUpClassName(spoiler, 'message') || spoiler.parentElement;\r\n\r\n      const className = 'is-spoiler-visible';\r\n      const isVisible = parentElement.classList.contains(className);\r\n      if(!isVisible) {\r\n        cancelEvent(e);\r\n\r\n        if(CLICK_EVENT_NAME !== 'click') {\r\n          window.addEventListener('click', cancelEvent, {capture: true, once: true});\r\n        }\r\n      }\r\n\r\n      const duration = 400 / 2;\r\n      const showDuration = 5000;\r\n      const useRafs = !isVisible ? 2 : 0;\r\n      if(useRafs) {\r\n        parentElement.classList.add('will-change');\r\n      }\r\n\r\n      const spoilerTimeout = parentElement.dataset.spoilerTimeout;\r\n      if(spoilerTimeout !== null) {\r\n        clearTimeout(+spoilerTimeout);\r\n        delete parentElement.dataset.spoilerTimeout;\r\n      }\r\n\r\n      SetTransition(parentElement, className, true, duration, () => {\r\n        parentElement.dataset.spoilerTimeout = '' + window.setTimeout(() => {\r\n          SetTransition(parentElement, className, false, duration, () => {\r\n            parentElement.classList.remove('will-change');\r\n            delete parentElement.dataset.spoilerTimeout;\r\n          });\r\n        }, showDuration);\r\n      }, useRafs);\r\n    };\r\n    \r\n    apiManagerProxy.addEventListener('notificationBuild', (options) => {\r\n      if(this.chat.peerId === options.message.peerId && !idleController.isIdle) {\r\n        return;\r\n      }\r\n      \r\n      uiNotificationsManager.buildNotification(options);\r\n    });\r\n\r\n    this.addEventListener('peer_changed', async(peerId) => {\r\n      document.body.classList.toggle('has-chat', !!peerId);\r\n\r\n      this.overrideHash(peerId);\r\n\r\n      apiManagerProxy.updateTabState('chatPeerIds', this.chats.map((chat) => chat.peerId).filter(Boolean));\r\n    });\r\n\r\n    // stateStorage.get('chatPositions').then((c) => {\r\n      stateStorage.setToCache('chatPositions', /* c ||  */{});\r\n    // });\r\n\r\n    if(IS_CALL_SUPPORTED || IS_GROUP_CALL_SUPPORTED) {\r\n      this.topbarCall = new TopbarCall(managers);\r\n    }\r\n\r\n    if(IS_CALL_SUPPORTED) {\r\n      callsController.addEventListener('instance', ({instance/* , hasCurrent */}) => {\r\n        // if(hasCurrent) {\r\n          // return;\r\n        // }\r\n        \r\n        const popup = new PopupCall(instance);\r\n\r\n        instance.addEventListener('acceptCallOverride', () => {\r\n          return this.discardCurrentCall(instance.interlocutorUserId.toPeerId(), undefined, instance)\r\n          .then(() => {\r\n            callsController.dispatchEvent('accepting', instance);\r\n            return true;\r\n          })\r\n          .catch(() => false);\r\n        });\r\n\r\n        popup.addEventListener('close', () => {\r\n          const currentCall = callsController.currentCall;\r\n          if(currentCall && currentCall !== instance && !instance.wasTryingToJoin) {\r\n            instance.hangUp('phoneCallDiscardReasonBusy');\r\n          }\r\n        }, {once: true});\r\n\r\n        popup.show();\r\n      });\r\n\r\n      callsController.addEventListener('incompatible', (userId) => {\r\n        toastNew({\r\n          langPackKey: 'VoipPeerIncompatible', \r\n          langPackArguments: [\r\n            new PeerTitle({peerId: userId.toPeerId()}).element\r\n          ]\r\n        });\r\n      });\r\n    }\r\n\r\n    // ! do not remove this line \r\n    // ! instance can be deactivated before the UI starts, because it waits in background for RAF that is delayed\r\n    singleInstance.activateInstance();\r\n\r\n    const setAuthorized = () => {\r\n      telegramMeWebManager.setAuthorized(true);\r\n    };\r\n\r\n    setInterval(setAuthorized, ONE_DAY);\r\n    setAuthorized();\r\n\r\n    this.addAnchorListener<{}>({\r\n      name: 'showMaskedAlert', \r\n      callback: (params, element) => {\r\n        const href = element.href;\r\n\r\n        const a = element.cloneNode(true) as HTMLAnchorElement;\r\n        a.className = 'anchor-url';\r\n        a.innerText = href;\r\n        a.removeAttribute('onclick');\r\n\r\n        new PopupPeer('popup-masked-url', {\r\n          titleLangKey: 'OpenUrlTitle',\r\n          descriptionLangKey: 'OpenUrlAlert2',\r\n          descriptionLangArgs: [a],\r\n          buttons: [{\r\n            langKey: 'Open',\r\n            callback: () => {\r\n              a.click();\r\n            },\r\n          }]\r\n        }).show();\r\n      }\r\n    });\r\n\r\n    this.addAnchorListener<{uriParams: {command: string, bot: string}}>({\r\n      name: 'execBotCommand', \r\n      callback: ({uriParams}) => {\r\n        const {command, bot} = uriParams;\r\n\r\n        /* const promise = bot ? this.openUsername(bot).then(() => this.chat.peerId) : Promise.resolve(this.chat.peerId);\r\n        promise.then((peerId) => {\r\n          this.managers.appMessagesManager.sendText(peerId, '/' + command);\r\n        }); */\r\n\r\n        this.managers.appMessagesManager.sendText(this.chat.peerId, '/' + command + (bot ? '@' + bot : ''));\r\n\r\n        //console.log(command, bot);\r\n      }\r\n    });\r\n\r\n    this.addAnchorListener<{uriParams: {hashtag: string}}>({\r\n      name: 'searchByHashtag', \r\n      callback: ({uriParams}) => {\r\n        const {hashtag} = uriParams;\r\n        if(!hashtag) {\r\n          return;\r\n        }\r\n\r\n        this.chat.initSearch('#' + hashtag + ' ');\r\n      }\r\n    });\r\n\r\n    this.addAnchorListener<{pathnameParams: ['addstickers', string]}>({\r\n      name: 'addstickers', \r\n      callback: ({pathnameParams}) => {\r\n        const link: InternalLink = {\r\n          _: INTERNAL_LINK_TYPE.STICKER_SET,\r\n          set: pathnameParams[1]\r\n        };\r\n\r\n        this.processInternalLink(link);\r\n      }\r\n    });\r\n\r\n    // Support old t.me/joinchat/asd and new t.me/+asd\r\n    this.addAnchorListener<{pathnameParams: ['joinchat', string]}>({\r\n      name: 'joinchat', \r\n      callback: ({pathnameParams}) => {\r\n        const link: InternalLink = {\r\n          _: INTERNAL_LINK_TYPE.JOIN_CHAT,\r\n          invite: pathnameParams[1] || decodeURIComponent(pathnameParams[0]).slice(1)\r\n        };\r\n\r\n        this.processInternalLink(link);\r\n      }\r\n    });\r\n\r\n    if(IS_GROUP_CALL_SUPPORTED) {\r\n      this.addAnchorListener<{\r\n        uriParams: Omit<InternalLink.InternalLinkVoiceChat, '_'>\r\n      }>({\r\n        name: 'voicechat',\r\n        protocol: 'tg',\r\n        callback: ({uriParams}) => {\r\n          const link = this.makeLink(INTERNAL_LINK_TYPE.VOICE_CHAT, uriParams);\r\n          this.processInternalLink(link);\r\n        }\r\n      });\r\n    }\r\n\r\n    this.addAnchorListener<{\r\n    //   pathnameParams: ['c', string, string],\r\n    //   uriParams: {thread?: number}\r\n    // } | {\r\n    //   pathnameParams: [string, string?],\r\n    //   uriParams: {comment?: number}\r\n      pathnameParams: ['c', string, string] | [string, string?],\r\n      uriParams: {thread?: string, comment?: string} | {comment?: string, start?: string}\r\n    }>({\r\n      name: 'im',\r\n      callback: async({pathnameParams, uriParams}) => {\r\n        let link: InternalLink;\r\n        if(PHONE_NUMBER_REG_EXP.test(pathnameParams[0])) {\r\n          link = {\r\n            _: INTERNAL_LINK_TYPE.USER_PHONE_NUMBER,\r\n            phone: pathnameParams[0].slice(1)\r\n          };\r\n        } else if(pathnameParams[0] === 'c') {\r\n          link = {\r\n            _: INTERNAL_LINK_TYPE.PRIVATE_POST,\r\n            channel: pathnameParams[1],\r\n            post: pathnameParams[2],\r\n            thread: 'thread' in uriParams && uriParams.thread,\r\n            comment: uriParams.comment\r\n          };\r\n        } else {\r\n          link = {\r\n            _: INTERNAL_LINK_TYPE.MESSAGE,\r\n            domain: pathnameParams[0],\r\n            post: pathnameParams[1],\r\n            comment: uriParams.comment,\r\n            start: 'start' in uriParams ? uriParams.start : undefined\r\n          };\r\n        }\r\n\r\n        this.processInternalLink(link);\r\n      }\r\n    });\r\n\r\n    this.addAnchorListener<{\r\n      uriParams: {\r\n        domain: string,\r\n\r\n        // telegrampassport\r\n        scope?: string,\r\n        nonce?: string,\r\n        payload?: string,\r\n        bot_id?: string,\r\n        public_key?: string,\r\n        callback_url?: string,\r\n\r\n        // regular\r\n        start?: string,\r\n        startgroup?: string,\r\n        game?: string,\r\n        voicechat?: string,\r\n        post?: string,\r\n        thread?: string,\r\n        comment?: string,\r\n        phone?: string\r\n      }\r\n    }>({\r\n      name: 'resolve',\r\n      protocol: 'tg',\r\n      callback: ({uriParams}) => {\r\n        let link: InternalLink;\r\n        if(uriParams.phone) {\r\n          link = this.makeLink(INTERNAL_LINK_TYPE.USER_PHONE_NUMBER, uriParams as Required<typeof uriParams>);\r\n        } else if(uriParams.domain === 'telegrampassport') {\r\n\r\n        } else {\r\n          link = this.makeLink(INTERNAL_LINK_TYPE.MESSAGE, uriParams);\r\n        }\r\n\r\n        this.processInternalLink(link);\r\n      }\r\n    });\r\n\r\n    this.addAnchorListener<{\r\n      uriParams: {\r\n        channel: string,\r\n        post: string,\r\n        thread?: string,\r\n        comment?: string\r\n      }\r\n    }>({\r\n      name: 'privatepost',\r\n      protocol: 'tg',\r\n      callback: ({uriParams}) => {\r\n        const link = this.makeLink(INTERNAL_LINK_TYPE.PRIVATE_POST, uriParams);\r\n        this.processInternalLink(link);\r\n      }\r\n    });\r\n\r\n    this.addAnchorListener<{\r\n      uriParams: {\r\n        set: string\r\n      }\r\n    }>({\r\n      name: 'addstickers',\r\n      protocol: 'tg',\r\n      callback: ({uriParams}) => {\r\n        const link = this.makeLink(INTERNAL_LINK_TYPE.STICKER_SET, uriParams);\r\n        this.processInternalLink(link);\r\n      }\r\n    });\r\n\r\n    ['joinchat' as const, 'join' as const].forEach((name) => {\r\n      this.addAnchorListener<{\r\n        uriParams: {\r\n          invite: string\r\n        }\r\n      }>({\r\n        name,\r\n        protocol: 'tg',\r\n        callback: ({uriParams}) => {\r\n          const link = this.makeLink(INTERNAL_LINK_TYPE.JOIN_CHAT, uriParams);\r\n          this.processInternalLink(link);\r\n        }\r\n      });\r\n    });\r\n\r\n    this.onHashChange(true);\r\n    this.attachKeydownListener();\r\n  }\r\n\r\n  private deleteFilesIterative(callback: (response: Response) => boolean) {\r\n    return this.cacheStorage.timeoutOperation((cache) => {\r\n      const perf = performance.now();\r\n      return cache.keys().then((requests) => {\r\n        const promises = requests.map((request) => {\r\n          return cache.match(request).then((response) => {\r\n            return callback(response);\r\n          });\r\n        });\r\n\r\n        return Promise.all(promises).then((values) => {\r\n          values.map((isBad, idx) => {\r\n            if(!isBad) {\r\n              return;\r\n            }\r\n\r\n            const request = requests[idx];\r\n            return cache.delete(request);\r\n          });\r\n\r\n          return Promise.all(values.filter(Boolean));\r\n        });\r\n      }).then(() => {\r\n        this.log('deleted files', performance.now() - perf);\r\n      });\r\n    });\r\n  }\r\n\r\n  private toggleChatGradientAnimation(activatingChat: Chat) {\r\n    this.chats.forEach((chat) => {\r\n      if(chat.gradientRenderer) {\r\n        chat.gradientRenderer.scrollAnimate(rootScope.settings.animationsEnabled && chat === activatingChat);\r\n      }\r\n    });\r\n  }\r\n\r\n  private appendEmojiAnimationContainer(screen: ScreenSize) {\r\n    const appendTo = screen === ScreenSize.mobile ? this.columnEl : document.body;\r\n    if(this.emojiAnimationContainer.parentElement !== appendTo) {\r\n      appendTo.append(this.emojiAnimationContainer)\r\n    }\r\n  }\r\n\r\n  private attachKeydownListener() {\r\n    const IGNORE_KEYS = new Set(['PageUp', 'PageDown', 'Meta', 'Control']);\r\n    const onKeyDown = (e: KeyboardEvent) => {\r\n      const key = e.key;\r\n      if(overlayCounter.isOverlayActive || IGNORE_KEYS.has(key)) return;\r\n      \r\n      const target = e.target as HTMLElement;\r\n      \r\n      //if(target.tagName === 'INPUT') return;\r\n      \r\n      //this.log('onkeydown', e, document.activeElement);\r\n\r\n      const chat = this.chat;\r\n\r\n      if(e.code === 'KeyC' && (e.ctrlKey || e.metaKey) && target.tagName !== 'INPUT') {\r\n        return;\r\n      } else if(e.altKey && (key === 'ArrowUp' || key === 'ArrowDown')) {\r\n        cancelEvent(e);\r\n        this.managers.dialogsStorage.getNextDialog(this.chat.peerId, key === 'ArrowDown', appDialogsManager.filterId).then((dialog) => {\r\n          if(dialog) {\r\n            this.setPeer({peerId: dialog.peerId});\r\n          }\r\n        });\r\n      } else if(key === 'ArrowUp' && this.chat.type !== 'scheduled') {\r\n        if(!chat.input.editMsgId && chat.input.isInputEmpty()) {\r\n          this.managers.appMessagesManager.getFirstMessageToEdit(chat.peerId, chat.threadId).then((message) => {\r\n            if(message) {\r\n              chat.input.initMessageEditing(message.mid);\r\n              cancelEvent(e); // * prevent from scrolling\r\n            }\r\n          });\r\n        } else {\r\n          return;\r\n        }\r\n      } else if(key === 'ArrowDown') {\r\n        return;\r\n      }\r\n      \r\n      if(\r\n        chat?.input?.messageInput && \r\n        e.target !== chat.input.messageInput && \r\n        target.tagName !== 'INPUT' && \r\n        !target.hasAttribute('contenteditable') && \r\n        !IS_TOUCH_SUPPORTED && \r\n        (!mediaSizes.isMobile || this.tabId === 1) && \r\n        !chat.selection.isSelecting && \r\n        !chat.input.recording\r\n      ) {\r\n        chat.input.messageInput.focus();\r\n        placeCaretAtEnd(chat.input.messageInput);\r\n\r\n        // clone and dispatch same event to new input. it is needed for sending message if input was blurred\r\n        const newEvent = new KeyboardEvent(e.type, e);\r\n        chat.input.messageInput.dispatchEvent(newEvent);\r\n      }\r\n    };\r\n    \r\n    document.body.addEventListener('keydown', onKeyDown);\r\n  }\r\n\r\n  private makeLink<T extends INTERNAL_LINK_TYPE>(type: T, uriParams: Omit<InternalLinkTypeMap[T], '_'>) {\r\n    return {\r\n      _: type,\r\n      ...uriParams\r\n    } as any as InternalLinkTypeMap[T];\r\n  }\r\n\r\n  public async processInternalLink(link: InternalLink) {\r\n    switch(link?._) {\r\n      case INTERNAL_LINK_TYPE.MESSAGE: {\r\n        const postId = link.post ? generateMessageId(+link.post) : undefined;\r\n        const commentId = link.comment ? generateMessageId(+link.comment) : undefined;\r\n\r\n        this.openUsername({\r\n          userName: link.domain, \r\n          lastMsgId: postId, \r\n          commentId,\r\n          startParam: link.start\r\n        });\r\n        break;\r\n      }\r\n\r\n      case INTERNAL_LINK_TYPE.PRIVATE_POST: {\r\n        const chatId = link.channel.toChatId();\r\n        const peerId = chatId.toPeerId(true);\r\n\r\n        const chat = await this.managers.appChatsManager.getChat(chatId);\r\n        if(chat.deleted) {\r\n          try {\r\n            await this.managers.appChatsManager.resolveChannel(chatId);\r\n          } catch(err) {\r\n            toastNew({langPackKey: 'LinkNotFound'});\r\n            throw err;\r\n          }\r\n        }\r\n\r\n        const postId = generateMessageId(+link.post);\r\n        const threadId = link.thread ? generateMessageId(+link.thread) : undefined;\r\n\r\n        if(threadId) this.openThread(peerId, postId, threadId);\r\n        else this.setInnerPeer({\r\n          peerId,\r\n          lastMsgId: postId,\r\n          threadId\r\n        });\r\n        break;\r\n      }\r\n\r\n      case INTERNAL_LINK_TYPE.STICKER_SET: {\r\n        new PopupStickers({id: link.set}).show();\r\n        break;\r\n      }\r\n\r\n      case INTERNAL_LINK_TYPE.JOIN_CHAT: {\r\n        this.managers.appChatsManager.checkChatInvite(link.invite).then((chatInvite) => {\r\n          if((chatInvite as ChatInvite.chatInvitePeek).chat) {\r\n            this.managers.appChatsManager.saveApiChat((chatInvite as ChatInvite.chatInvitePeek).chat, true);\r\n          }\r\n\r\n          // console.log(chatInvite);\r\n\r\n          if(chatInvite._ === 'chatInviteAlready' ||\r\n            chatInvite._ === 'chatInvitePeek'/*  && chatInvite.expires > tsNow(true) */) {\r\n            this.setInnerPeer({\r\n              peerId: chatInvite.chat.id.toPeerId(true)\r\n            });\r\n            return;\r\n          }\r\n\r\n          new PopupJoinChatInvite(link.invite, chatInvite);\r\n        }, (err) => {\r\n          if(err.type === 'INVITE_HASH_EXPIRED') {\r\n            toast(i18n('InviteExpired'));\r\n          }\r\n        });\r\n        break;\r\n      }\r\n\r\n      case INTERNAL_LINK_TYPE.VOICE_CHAT: {\r\n        if(IS_GROUP_CALL_SUPPORTED) {\r\n          this.joinGroupCall(link.chat_id.toPeerId(true), link.id);\r\n        }\r\n        \r\n        break;\r\n      }\r\n\r\n      case INTERNAL_LINK_TYPE.USER_PHONE_NUMBER: {\r\n        this.managers.appUsersManager.resolvePhone(link.phone).then((user) => {\r\n          this.setInnerPeer({\r\n            peerId: user.id.toPeerId(false)\r\n          });\r\n        }).catch((err) => {\r\n          if(err.type === 'PHONE_NOT_OCCUPIED') {\r\n            toastNew({langPackKey: 'Alert.UserDoesntExists'});\r\n          }\r\n        });\r\n\r\n        break;\r\n      }\r\n\r\n      default: {\r\n        this.log.warn('Not supported internal link:', link);\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  public openUrl(url: string) {\r\n    const {url: wrappedUrl, onclick} = wrapUrl(url);\r\n    const a = document.createElement('a');\r\n    a.href = wrappedUrl;\r\n    \r\n    (window as any)[onclick](a);\r\n  }\r\n\r\n  private addAnchorListener<Params extends {pathnameParams?: any, uriParams?: any}>(options: {\r\n    name: 'showMaskedAlert' | 'execBotCommand' | 'searchByHashtag' | 'addstickers' | 'im' |\r\n          'resolve' | 'privatepost' | 'addstickers' | 'voicechat' | 'joinchat' | 'join', \r\n    protocol?: 'tg',\r\n    callback: (params: Params, element?: HTMLAnchorElement) => boolean | any, \r\n    noPathnameParams?: boolean,\r\n    noUriParams?: boolean\r\n  }) {\r\n    (window as any)[(options.protocol ? options.protocol + '_' : '') + options.name] = (element?: HTMLAnchorElement/* , e: Event */) => {\r\n      cancelEvent(null);\r\n\r\n      const href = element.href;\r\n      let pathnameParams: any[];\r\n      let uriParams: any;\r\n\r\n      if(!options.noPathnameParams) pathnameParams = new URL(element.href).pathname.split('/').slice(1);\r\n      if(!options.noUriParams) uriParams = this.parseUriParams(href);\r\n\r\n      const res = options.callback({pathnameParams, uriParams} as Params, element);\r\n      return res === undefined ? res : false;\r\n    };\r\n  }\r\n\r\n  private parseUriParams(uri: string, splitted = uri.split('?')) {\r\n    const params: any = {};\r\n    if(!splitted[1]) return params;\r\n    splitted[1].split('&').forEach((item) => {\r\n      params[item.split('=')[0]] = decodeURIComponent(item.split('=')[1]);\r\n    });\r\n\r\n    return params;\r\n  }\r\n\r\n  private onHashChange = (saveState?: boolean) => {\r\n    const hash = location.hash;\r\n    if(!saveState) {\r\n      appNavigationController.replaceState();\r\n    }\r\n\r\n    const splitted = hash.split('?');\r\n    const params = this.parseUriParams(hash, splitted);\r\n    this.log('hashchange', hash, splitted[0], params);\r\n    if(!hash) {\r\n      return;\r\n    }\r\n\r\n    if(params.tgaddr) {\r\n      const {onclick} = wrapUrl(params.tgaddr);\r\n      if(onclick) {\r\n        const a = document.createElement('a');\r\n        a.href = params.tgaddr;\r\n        (window as any)[onclick](a);\r\n      }\r\n      return;\r\n    }\r\n\r\n    switch(splitted[0]) {\r\n      default: {\r\n        params.p = splitted[0].slice(1);\r\n      }\r\n\r\n      case '#/im': {\r\n        const p: string = params.p;\r\n        let postId = params.post !== undefined ? generateMessageId(+params.post) : undefined;\r\n\r\n        switch(p[0]) {\r\n          case '@': {\r\n            this.openUsername({\r\n              userName: p, \r\n              lastMsgId: postId\r\n            });\r\n            break;\r\n          }\r\n\r\n          default: { // peerId\r\n            this.setInnerPeer({\r\n              peerId: postId ? p.toPeerId(true) : p.toPeerId(), \r\n              lastMsgId: postId\r\n            });\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    //appNavigationController.replaceState();\r\n    //location.hash = '';\r\n  };\r\n\r\n  public openUsername(options: {\r\n    userName: string, \r\n    lastMsgId?: number, \r\n    threadId?: number, \r\n    commentId?: number,\r\n    startParam?: string\r\n  }) {\r\n    const {userName, lastMsgId, threadId, commentId, startParam} = options;\r\n    return this.managers.appUsersManager.resolveUsername(userName).then((peer) => {\r\n      const isUser = peer._ === 'user';\r\n      const peerId = peer.id.toPeerId(!isUser);\r\n\r\n      if(threadId) {\r\n        return this.openThread(peerId, lastMsgId, threadId);\r\n      } else if(commentId) {\r\n        return this.openComment(peerId, lastMsgId, commentId);\r\n      }\r\n      \r\n      return this.setInnerPeer({\r\n        peerId,\r\n        lastMsgId,\r\n        startParam: startParam\r\n      });\r\n    }, (err) => {\r\n      if(err.type === 'USERNAME_NOT_OCCUPIED') {\r\n        toastNew({langPackKey: 'NoUsernameFound'});\r\n      } else if(err.type === 'USERNAME_INVALID') {\r\n        toastNew({langPackKey: 'Alert.UserDoesntExists'});\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Opens thread when peerId of discussion group is known\r\n   */\r\n  public openThread(peerId: PeerId, lastMsgId: number, threadId: number) {\r\n    return this.managers.appMessagesManager.wrapSingleMessage(peerId, threadId).then((message) => {\r\n      // const message: Message = this.managers.appMessagesManager.getMessageByPeer(peerId, threadId);\r\n      if(!message) {\r\n        lastMsgId = undefined;\r\n      } else {\r\n        this.managers.appMessagesManager.generateThreadServiceStartMessage(message);\r\n      }\r\n\r\n      return this.setInnerPeer({\r\n        peerId,\r\n        lastMsgId,\r\n        threadId,\r\n        type: 'discussion'\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Opens comment directly from original channel\r\n   */\r\n  public openComment(peerId: PeerId, msgId: number, commentId: number) {\r\n    return this.managers.appMessagesManager.getDiscussionMessage(peerId, msgId).then((message) => {\r\n      return this.openThread(message.peerId, commentId, message.mid);\r\n    });\r\n  }\r\n\r\n  public async callUser(userId: UserId, type: CallType) {\r\n    const call = callsController.getCallByUserId(userId);\r\n    if(call) {\r\n      return;\r\n    }\r\n    \r\n    const userFull = await this.managers.appProfileManager.getProfile(userId);\r\n    if(userFull.pFlags.phone_calls_private) {\r\n      confirmationPopup({\r\n        descriptionLangKey: 'Call.PrivacyErrorMessage',\r\n        descriptionLangArgs: [new PeerTitle({peerId: userId.toPeerId()}).element],\r\n        button: {\r\n          langKey: 'OK',\r\n          isCancel: true\r\n        }\r\n      });\r\n\r\n      return;\r\n    }\r\n\r\n    await this.discardCurrentCall(userId.toPeerId());\r\n\r\n    callsController.startCallInternal(userId, type === 'video');\r\n  }\r\n\r\n  private discardCurrentCall(toPeerId: PeerId, ignoreGroupCall?: GroupCallInstance, ignoreCall?: CallInstance) {\r\n    if(groupCallsController.groupCall && groupCallsController.groupCall !== ignoreGroupCall) return this.discardGroupCallConfirmation(toPeerId);\r\n    else if(callsController.currentCall && callsController.currentCall !== ignoreCall) return this.discardCallConfirmation(toPeerId);\r\n    else return Promise.resolve();\r\n  }\r\n\r\n  private async discardCallConfirmation(toPeerId: PeerId) {\r\n    const currentCall = callsController.currentCall;\r\n    if(currentCall) {\r\n      await confirmationPopup({\r\n        titleLangKey: 'Call.Confirm.Discard.Call.Header',\r\n        descriptionLangKey: toPeerId.isUser() ? 'Call.Confirm.Discard.Call.ToCall.Text' : 'Call.Confirm.Discard.Call.ToVoice.Text',\r\n        descriptionLangArgs: [\r\n          new PeerTitle({peerId: currentCall.interlocutorUserId.toPeerId(false)}).element, \r\n          new PeerTitle({peerId: toPeerId}).element\r\n        ],\r\n        button: {\r\n          langKey: 'OK'\r\n        }\r\n      });\r\n\r\n      if(!currentCall.isClosing) {\r\n        await currentCall.hangUp('phoneCallDiscardReasonDisconnect');\r\n      }\r\n    }\r\n  }\r\n\r\n  private async discardGroupCallConfirmation(toPeerId: PeerId) {\r\n    const currentGroupCall = groupCallsController.groupCall;\r\n    if(currentGroupCall) {\r\n      await confirmationPopup({\r\n        titleLangKey: 'Call.Confirm.Discard.Voice.Header',\r\n        descriptionLangKey: toPeerId.isUser() ? 'Call.Confirm.Discard.Voice.ToCall.Text' : 'Call.Confirm.Discard.Voice.ToVoice.Text',\r\n        descriptionLangArgs: [\r\n          new PeerTitle({peerId: currentGroupCall.chatId.toPeerId(true)}).element, \r\n          new PeerTitle({peerId: toPeerId}).element\r\n        ],\r\n        button: {\r\n          langKey: 'OK'\r\n        }\r\n      });\r\n\r\n      if(groupCallsController.groupCall === currentGroupCall) {\r\n        await currentGroupCall.hangUp();\r\n      }\r\n    }\r\n  }\r\n\r\n  public async joinGroupCall(peerId: PeerId, groupCallId?: GroupCallId) {\r\n    const chatId = peerId.toChatId();\r\n    const hasRights = this.managers.appChatsManager.hasRights(chatId, 'manage_call');\r\n    const next = async() => {\r\n      const chatFull = await this.managers.appProfileManager.getChatFull(chatId);\r\n      let call: MyGroupCall;\r\n      if(!chatFull.call) {\r\n        if(!hasRights) {\r\n          return;\r\n        }\r\n  \r\n        call = await this.managers.appGroupCallsManager.createGroupCall(chatId);\r\n      } else {\r\n        call = chatFull.call;\r\n      }\r\n  \r\n      groupCallsController.joinGroupCall(chatId, call.id, true, false);\r\n    };\r\n\r\n    if(groupCallId) {\r\n      const groupCall = await this.managers.appGroupCallsManager.getGroupCallFull(groupCallId);\r\n      if(groupCall._ === 'groupCallDiscarded') {\r\n        if(!hasRights) {\r\n          toastNew({\r\n            langPackKey: 'VoiceChat.Chat.Ended'\r\n          });\r\n\r\n          return;\r\n        }\r\n\r\n        await confirmationPopup({\r\n          descriptionLangKey: 'VoiceChat.Chat.StartNew',\r\n          button: {\r\n            langKey: 'VoiceChat.Chat.StartNew.OK'\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    // await this.discardCurrentCall(peerId);\r\n\r\n    next();\r\n  };\r\n\r\n  public setCurrentBackground(broadcastEvent = false): ReturnType<AppImManager['setBackground']> {\r\n    const theme = themeController.getTheme();\r\n\r\n    if(theme.background.slug) {\r\n      const defaultTheme = STATE_INIT.settings.themes.find((t) => t.name === theme.name);\r\n      // const isDefaultBackground = theme.background.blur === defaultTheme.background.blur && \r\n        // theme.background.slug === defaultTheme.background.slug;\r\n\r\n      // if(!isDefaultBackground) {\r\n        return this.getBackground(theme.background.slug).then((url) => {\r\n          return this.setBackground(url, broadcastEvent);\r\n        }, () => { // * if NO_ENTRY_FOUND\r\n          theme.background = copy(defaultTheme.background); // * reset background\r\n          return this.setCurrentBackground(true);\r\n        });\r\n      // }\r\n    }\r\n    \r\n    return this.setBackground('', broadcastEvent);\r\n  }\r\n\r\n  private getBackground(slug: string) {\r\n    if(this.backgroundPromises[slug]) return this.backgroundPromises[slug];\r\n    return this.backgroundPromises[slug] = this.cacheStorage.getFile('backgrounds/' + slug).then((blob) => {\r\n      return URL.createObjectURL(blob);\r\n    });\r\n  }\r\n\r\n  public setBackground(url: string, broadcastEvent = true): Promise<void> {\r\n    this.lastBackgroundUrl = url;\r\n    const promises = this.chats.map((chat) => chat.setBackground(url));\r\n    return promises[promises.length - 1].then(() => {\r\n      if(broadcastEvent) {\r\n        rootScope.dispatchEvent('background_change');\r\n      }\r\n    });\r\n  }\r\n\r\n  public saveChatPosition(chat: Chat) {\r\n    if(!(['chat', 'discussion'] as ChatType[]).includes(chat.type) || !chat.peerId) {\r\n      return;\r\n    }\r\n\r\n    //const bubble = chat.bubbles.getBubbleByPoint('top');\r\n    //if(bubble) {\r\n      //const top = bubble.getBoundingClientRect().top;\r\n      const chatBubbles = chat.bubbles;\r\n      const key = chat.peerId + (chat.threadId ? '_' + chat.threadId : '');\r\n      const chatPositions = stateStorage.getFromCache('chatPositions');\r\n      if(!(chatBubbles.scrollable.getDistanceToEnd() <= 16 && chatBubbles.scrollable.loadedAll.bottom) && chatBubbles.getRenderedLength()) {\r\n        chatBubbles.sliceViewport(true);\r\n        const top = chatBubbles.scrollable.scrollTop;\r\n        \r\n        const position = {\r\n          mids: getObjectKeysAndSort(chatBubbles.bubbles, 'desc').filter((mid) => !chatBubbles.skippedMids.has(mid)),\r\n          top\r\n        };\r\n\r\n        chatPositions[key] = position;\r\n\r\n        this.log('saved chat position:', position);\r\n      } else {\r\n        delete chatPositions[key];\r\n\r\n        this.log('deleted chat position');\r\n      }\r\n\r\n      stateStorage.set({chatPositions}, true);\r\n    //}\r\n  }\r\n\r\n  public getChatSavedPosition(chat: Chat): ChatSavedPosition {\r\n    if(!(['chat', 'discussion'] as ChatType[]).includes(chat.type) || !chat.peerId) {\r\n      return;\r\n    }\r\n    \r\n    const key = chat.peerId + (chat.threadId ? '_' + chat.threadId : '');\r\n    const cache = stateStorage.getFromCache('chatPositions');\r\n    return cache && cache[key];\r\n  }\r\n\r\n  public applyCurrentTheme(slug?: string, backgroundUrl?: string, broadcastEvent?: boolean) {\r\n    if(backgroundUrl) {\r\n      this.backgroundPromises[slug] = Promise.resolve(backgroundUrl);\r\n    }\r\n\r\n    themeController.setTheme();\r\n    \r\n    return this.setCurrentBackground(broadcastEvent === undefined ? !!slug : broadcastEvent);\r\n  }\r\n\r\n  private setSettings = () => {\r\n    document.documentElement.style.setProperty('--messages-text-size', rootScope.settings.messagesTextSize + 'px');\r\n    \r\n    document.body.classList.toggle('animation-level-0', !rootScope.settings.animationsEnabled);\r\n    document.body.classList.toggle('animation-level-1', false);\r\n    document.body.classList.toggle('animation-level-2', rootScope.settings.animationsEnabled);\r\n\r\n    this.chatsSelectTabDebounced = debounce(() => {\r\n      const topbar = this.chat.topbar;\r\n      if(topbar.pinnedMessage) { // *   ,     ,       \r\n        topbar.pinnedMessage.setCorrectIndex(0);\r\n      }\r\n\r\n      this.managers.apiFileManager.setQueueId(this.chat.bubbles.lazyLoadQueue.queueId);\r\n    }, rootScope.settings.animationsEnabled ? 250 : 0, false, true);\r\n\r\n    lottieLoader.setLoop(rootScope.settings.stickers.loop);\r\n    animationIntersector.checkAnimations(false);\r\n    \r\n    for(const chat of this.chats) {\r\n      chat.setAutoDownloadMedia();\r\n    }\r\n    \r\n    I18n.setTimeFormat(rootScope.settings.timeFormat);\r\n\r\n    this.toggleChatGradientAnimation(this.chat);\r\n  };\r\n\r\n  // *     TransitionSlider,        \r\n  // * (   )     (. scrollTop)\r\n  private chatsSelectTab(tab: HTMLElement, animate?: boolean) {\r\n    if(this.prevTab === tab) {\r\n      return;\r\n    }\r\n\r\n    if(animate === false && this.prevTab) { // * will be used for Safari iOS history swipe\r\n      disableTransition([tab, this.prevTab].filter(Boolean));\r\n    }\r\n\r\n    if(this.prevTab) {\r\n      this.prevTab.classList.remove('active');\r\n      this.chatsSelectTabDebounced();\r\n\r\n      // !    animation,         250\r\n      if(rootScope.settings.animationsEnabled && animate !== false) { \r\n        dispatchHeavyAnimationEvent(pause(250 + 150), 250 + 150);\r\n      }\r\n\r\n      const prevIdx = whichChild(this.prevTab);\r\n      const idx = whichChild(tab);\r\n      if(idx > prevIdx) {\r\n        appNavigationController.pushItem({\r\n          type: 'chat', \r\n          onPop: (canAnimate) => {\r\n            this.setPeer({}, canAnimate);\r\n            blurActiveElement();\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    tab.classList.add('active');\r\n    this.prevTab = tab;\r\n  }\r\n\r\n  private init() {\r\n    document.addEventListener('paste', this.onDocumentPaste, true);\r\n    \r\n    if(!IS_TOUCH_SUPPORTED) {\r\n      this.attachDragAndDropListeners();\r\n    }\r\n\r\n    //if(!isTouchSupported) {\r\n      this.markupTooltip = new MarkupTooltip(this);\r\n      this.markupTooltip.handleSelection();\r\n    //}\r\n  }\r\n\r\n  private attachDragAndDropListeners() {\r\n    const drops: ChatDragAndDrop[] = [];\r\n    const mediaDrops: ChatDragAndDrop[] = [];\r\n    let mounted = false;\r\n    const toggle = async(e: DragEvent, mount: boolean) => {\r\n      if(mount === mounted) return;\r\n\r\n      const _types = e.dataTransfer.types;\r\n      // @ts-ignore\r\n      const isFiles = _types.contains ? _types.contains('Files') : _types.indexOf('Files') >= 0;\r\n\r\n      const newMediaPopup = getCurrentNewMediaPopup();\r\n      const types: string[] = await getFilesFromEvent(e, true);\r\n      if(!isFiles || (!(await this.canDrag()) && !newMediaPopup)) { // * skip dragging text case\r\n        counter = 0;\r\n        return;\r\n      }\r\n\r\n      const _dropsContainer = newMediaPopup ? mediaDropsContainer : dropsContainer;\r\n      const _drops = newMediaPopup ? mediaDrops : drops;\r\n\r\n      if(mount && !_drops.length) {\r\n        const force = isFiles && !types.length; // * can't get file items not from 'drop' on Safari\r\n        \r\n        const foundMedia = types.filter((t) => MEDIA_MIME_TYPES_SUPPORTED.has(t)).length;\r\n        // const foundDocuments = types.length - foundMedia;\r\n  \r\n        this.log('drag files', types);\r\n\r\n        if(newMediaPopup) {\r\n          newMediaPopup.appendDrops(_dropsContainer);\r\n\r\n          if(types.length || force) {\r\n            _drops.push(new ChatDragAndDrop(_dropsContainer, {\r\n              header: 'Preview.Dragging.AddItems',\r\n              headerArgs: [types.length],\r\n              onDrop: (e: DragEvent) => {\r\n                toggle(e, false);\r\n                this.log('drop', e);\r\n                this.onDocumentPaste(e, 'document');\r\n              }\r\n            }));\r\n          }\r\n        } else {\r\n          if(types.length || force) {\r\n            _drops.push(new ChatDragAndDrop(_dropsContainer, {\r\n              icon: 'dragfiles',\r\n              header: 'Chat.DropTitle',\r\n              subtitle: 'Chat.DropAsFilesDesc',\r\n              onDrop: (e: DragEvent) => {\r\n                toggle(e, false);\r\n                this.log('drop', e);\r\n                this.onDocumentPaste(e, 'document');\r\n              }\r\n            }));\r\n          }\r\n    \r\n          // if((foundMedia && !foundDocuments) || force) {\r\n          if(foundMedia || force) {\r\n            _drops.push(new ChatDragAndDrop(_dropsContainer, {\r\n              icon: 'dragmedia',\r\n              header: 'Chat.DropTitle',\r\n              subtitle: 'Chat.DropQuickDesc',\r\n              onDrop: (e: DragEvent) => {\r\n                toggle(e, false);\r\n                this.log('drop', e);\r\n                this.onDocumentPaste(e, 'media');\r\n              }\r\n            }));\r\n          }\r\n\r\n          this.chat.container.append(_dropsContainer);\r\n        }\r\n      }\r\n\r\n      //if(!mount) return;\r\n\r\n      SetTransition(_dropsContainer, 'is-visible', mount, 200, () => {\r\n        if(!mount) {\r\n          _drops.forEach((drop) => {\r\n            drop.destroy();\r\n          });\r\n\r\n          _drops.length = 0;\r\n        }\r\n      });\r\n\r\n      if(mount) {\r\n        _drops.forEach((drop) => {\r\n          drop.setPath();\r\n        });\r\n      } else {\r\n        counter = 0;\r\n      }\r\n\r\n      document.body.classList.toggle('is-dragging', mount);\r\n      mounted = mount;\r\n    };\r\n\r\n    /* document.body.addEventListener('dragover', (e) => {\r\n      cancelEvent(e);\r\n    }); */\r\n\r\n    let counter = 0;\r\n    document.body.addEventListener('dragenter', (e) => {\r\n      counter++;\r\n    });\r\n\r\n    document.body.addEventListener('dragover', (e) => {\r\n      //this.log('dragover', e/* , e.dataTransfer.types[0] */);\r\n      toggle(e, true);\r\n      cancelEvent(e);\r\n    });\r\n\r\n    document.body.addEventListener('dragleave', (e) => {\r\n      //this.log('dragleave', e, counter);\r\n      //if((e.pageX <= 0 || e.pageX >= this.managers.appPhotosManager.windowW) || (e.pageY <= 0 || e.pageY >= this.managers.appPhotosManager.windowH)) {\r\n      counter--;\r\n      if(counter === 0) { \r\n      //if(!findUpClassName(e.target, 'drops-container')) {\r\n        toggle(e, false);\r\n      }\r\n    });\r\n\r\n    const dropsContainer = document.createElement('div');\r\n    dropsContainer.classList.add('drops-container');\r\n\r\n    const mediaDropsContainer = dropsContainer.cloneNode(true) as HTMLElement;\r\n  }\r\n\r\n  private async canDrag() {\r\n    const chat = this.chat;\r\n    const peerId = chat?.peerId;\r\n    return !(!peerId || overlayCounter.isOverlayActive || !(await chat.canSend('send_media')));\r\n  }\r\n\r\n  private onDocumentPaste = async(e: ClipboardEvent | DragEvent, attachType?: 'media' | 'document') => {\r\n    const newMediaPopup = getCurrentNewMediaPopup();\r\n\r\n    //console.log('document paste');\r\n    //console.log('item', event.clipboardData.getData());\r\n\r\n    if(e instanceof DragEvent) {\r\n      const _types = e.dataTransfer.types;\r\n      // @ts-ignore\r\n      const isFiles = _types.contains ? _types.contains('Files') : _types.indexOf('Files') >= 0;\r\n      if(isFiles) {\r\n        cancelEvent(e);\r\n      }\r\n    }\r\n    \r\n    const files = await getFilesFromEvent(e);\r\n    if(!(await this.canDrag()) && !newMediaPopup) return;\r\n    if(files.length) {\r\n      if(newMediaPopup) {\r\n        newMediaPopup.addFiles(files);\r\n        return;\r\n      }\r\n  \r\n      const chatInput = this.chat.input;\r\n      chatInput.willAttachType = attachType || (MEDIA_MIME_TYPES_SUPPORTED.has(files[0].type) ? 'media' : 'document');\r\n      PopupElement.createPopup(PopupNewMedia, this.chat, files, chatInput.willAttachType);\r\n    }\r\n  };\r\n\r\n  private async overrideHash(peerId?: PeerId) {\r\n    let str: string;\r\n    if(peerId) {\r\n      const username = await this.managers.appPeersManager.getPeerUsername(peerId);\r\n      str = username ? '@' + username : '' + peerId;\r\n    }\r\n\r\n    appNavigationController.overrideHash(str);\r\n  }\r\n\r\n  public selectTab(id: number, animate?: boolean) {\r\n    if(animate === false) { // * will be used for Safari iOS history swipe\r\n      disableTransition([appSidebarLeft.sidebarEl, this.columnEl, appSidebarRight.sidebarEl]);\r\n    }\r\n\r\n    document.body.classList.toggle(LEFT_COLUMN_ACTIVE_CLASSNAME, id === 0);\r\n\r\n    const prevTabId = this.tabId;\r\n    if(prevTabId !== -1) {\r\n      this.overrideHash(id > 0 ? this.chat?.peerId : undefined);\r\n    }\r\n\r\n    this.log('selectTab', id, prevTabId);\r\n\r\n    let animationPromise: Promise<any> = rootScope.settings.animationsEnabled ? doubleRaf() : Promise.resolve();\r\n    if(prevTabId !== -1 && prevTabId !== id && rootScope.settings.animationsEnabled && animate !== false && mediaSizes.activeScreen !== ScreenSize.large) {\r\n      const transitionTime = (mediaSizes.isMobile ? 250 : 200) + 100; // * cause transition time could be > 250ms\r\n      animationPromise = pause(transitionTime);\r\n      dispatchHeavyAnimationEvent(animationPromise, transitionTime);\r\n\r\n      // ! it's very heavy operation. will blink in firefox\r\n      /* this.columnEl.classList.add('disable-hover');\r\n      animationPromise.finally(() => {\r\n        this.columnEl.classList.remove('disable-hover');\r\n      }); */\r\n    }\r\n\r\n    this.tabId = id;\r\n    blurActiveElement();\r\n    if(mediaSizes.isMobile && prevTabId === 2 && id < 2) {\r\n      document.body.classList.remove(RIGHT_COLUMN_ACTIVE_CLASSNAME);\r\n    }\r\n\r\n    if(prevTabId !== -1 && id > prevTabId) {\r\n      if(id < 2 || !appNavigationController.findItemByType('im')) {\r\n        appNavigationController.pushItem({\r\n          type: 'im', \r\n          onPop: (canAnimate) => {\r\n            //this.selectTab(prevTabId, !isSafari);\r\n            this.setPeer({}, canAnimate);\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    const onImTabChange = (window as any).onImTabChange;\r\n    onImTabChange && onImTabChange(id);\r\n\r\n    //this._selectTab(id, mediaSizes.isMobile);\r\n    //document.body.classList.toggle(RIGHT_COLUMN_ACTIVE_CLASSNAME, id === 2);\r\n\r\n    return animationPromise;\r\n  }\r\n  \r\n  public updateStatus() {\r\n    return this.managers.appUsersManager.updateMyOnlineStatus(this.offline);\r\n  }\r\n\r\n  private createNewChat() {\r\n    const chat = new Chat(\r\n      this, \r\n      this.managers\r\n    );\r\n\r\n    if(this.chats.length) {\r\n      chat.setBackground(this.lastBackgroundUrl, true);\r\n    }\r\n\r\n    this.chats.push(chat);\r\n\r\n    return chat;\r\n  }\r\n\r\n  private spliceChats(fromIndex: number, justReturn = true, animate?: boolean, spliced?: Chat[]) {\r\n    if(fromIndex >= this.chats.length) return;\r\n\r\n    const chatFrom = this.chat;\r\n    if(this.chats.length > 1 && justReturn) {\r\n      this.dispatchEvent('peer_changing', this.chat);\r\n    }\r\n\r\n    if(!spliced) {\r\n      spliced = this.chats.splice(fromIndex, this.chats.length - fromIndex);\r\n    }\r\n\r\n    const chatTo = this.chat;\r\n    this.dispatchEvent('chat_changing', {from: chatFrom, to: chatTo});\r\n\r\n    // * -1 because one item is being sliced when closing the chat by calling .removeByType\r\n    for(let i = 0; i < spliced.length - 1; ++i) {\r\n      appNavigationController.removeByType('chat', true);\r\n    }\r\n\r\n    // * fix middle chat z-index on animation\r\n    if(spliced.length > 1) {\r\n      spliced.slice(0, -1).forEach((chat) => {\r\n        chat.container.remove();\r\n      });\r\n    }\r\n\r\n    this.chatsSelectTab(chatTo.container, animate);\r\n\r\n    if(justReturn) {\r\n      this.dispatchEvent('peer_changed', chatTo.peerId);\r\n\r\n      const searchTab = appSidebarRight.getTab(AppPrivateSearchTab);\r\n      if(searchTab) {\r\n        searchTab.close();\r\n      }\r\n\r\n      appSidebarRight.replaceSharedMediaTab(chatTo.sharedMediaTab);\r\n    }\r\n\r\n    spliced.forEach((chat) => {\r\n      chat.beforeDestroy();\r\n    });\r\n    \r\n    setTimeout(() => {\r\n      //chat.setPeer(0);\r\n      spliced.forEach((chat) => {\r\n        chat.destroy();\r\n      });\r\n    }, 250 + 100);\r\n  }\r\n\r\n  public async setPeer(options: ChatSetPeerOptions = {}, animate?: boolean): Promise<boolean> {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    options.peerId ??= NULL_PEER_ID;\r\n\r\n    const {peerId, lastMsgId} = options;\r\n\r\n    const chat = this.chat;\r\n    const chatIndex = this.chats.indexOf(chat);\r\n\r\n    if(!peerId) {\r\n      if(chatIndex > 0) {\r\n        this.spliceChats(chatIndex, undefined, animate);\r\n        return;\r\n      } else if(mediaSizes.activeScreen === ScreenSize.medium) { // * floating sidebar case\r\n        this.selectTab(+!this.tabId, animate);\r\n        return;\r\n      }\r\n    } else if(chatIndex > 0 && chat.peerId && chat.peerId !== peerId) {\r\n      // const firstChat = this.chats[0];\r\n      // if(firstChat.peerId !== chat.peerId) {\r\n        /* // * slice idx > 0, set background and slice first, so new one will be the first\r\n        const spliced = this.chats.splice(1, this.chats.length - 1);\r\n        this.createNewChat();\r\n        this.chats.splice(0, 1); */\r\n        const spliced = this.chats.splice(1, this.chats.length - 1);\r\n        if(this.chat.peerId === peerId) {\r\n          this.spliceChats(0, true, true, spliced);\r\n          return;\r\n        } else {\r\n          const ret = this.setPeer(options);\r\n          this.spliceChats(0, false, false, spliced);\r\n          return ret;\r\n        }\r\n      // } else {\r\n      //   this.spliceChats(1, false, animate);\r\n      // }\r\n\r\n      //return ret;\r\n    }\r\n\r\n    // * don't reset peer if returning\r\n    if(peerId === chat.peerId && mediaSizes.activeScreen <= ScreenSize.medium && document.body.classList.contains(LEFT_COLUMN_ACTIVE_CLASSNAME)) {\r\n      this.selectTab(1, animate);\r\n      return false;\r\n    }\r\n\r\n    if(peerId || mediaSizes.activeScreen !== ScreenSize.mobile) {\r\n      const result = await chat.setPeer(peerId, lastMsgId, options.startParam);\r\n\r\n      // * wait for cached render\r\n      const promise = result?.cached ? result.promise : Promise.resolve();\r\n      if(peerId) {\r\n        Promise.all([\r\n          promise,\r\n          chat.setBackgroundPromise\r\n        ]).then(() => {\r\n          //window.requestAnimationFrame(() => {\r\n          setTimeout(() => { // * setTimeout is better here\r\n            setTimeout(() => {\r\n              this.chatsSelectTab(this.chat.container);\r\n            }, 0);\r\n            this.selectTab(1, animate);\r\n          }, 0);\r\n        });\r\n      }\r\n    }\r\n\r\n    if(!peerId) {\r\n      this.selectTab(0, animate);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public setInnerPeer(options: ChatSetInnerPeerOptions) {\r\n    const {peerId} = options;\r\n    if(peerId === NULL_PEER_ID || !peerId) {\r\n      return;\r\n    }\r\n\r\n    if(options.threadId) {\r\n      options.type = 'discussion';\r\n    }\r\n\r\n    const type = options.type ??= 'chat';\r\n\r\n    // * prevent opening already opened peer\r\n    const existingIndex = this.chats.findIndex((chat) => chat.peerId === peerId && chat.type === type);\r\n    if(existingIndex !== -1) {\r\n      this.spliceChats(existingIndex + 1);\r\n      return this.setPeer(options);\r\n    }\r\n\r\n    const oldChat = this.chat;\r\n    let chat = oldChat;\r\n    if(oldChat.inited) { // * use first not inited chat\r\n      chat = this.createNewChat();\r\n    }\r\n\r\n    if(type) {\r\n      chat.setType(type);\r\n\r\n      if(options.threadId) {\r\n        chat.threadId = options.threadId;\r\n      }\r\n    }\r\n\r\n    this.dispatchEvent('chat_changing', {from: oldChat, to: chat});\r\n\r\n    //this.chatsSelectTab(chat.container);\r\n\r\n    return this.setPeer(options);\r\n  }\r\n\r\n  public openScheduled(peerId: PeerId) {\r\n    this.setInnerPeer({\r\n      peerId, \r\n      type: 'scheduled'\r\n    });\r\n  }\r\n\r\n  private getTypingElement(action: SendMessageAction) {\r\n    const el = document.createElement('span');\r\n    let c = 'peer-typing';\r\n    el.classList.add(c);\r\n    el.dataset.action = action._;\r\n    switch(action._) {\r\n      case 'sendMessageTypingAction': {\r\n      //default: {\r\n        c += '-text';\r\n        for(let i = 0; i < 3; ++i) {\r\n          const dot = document.createElement('span');\r\n          dot.className = c + '-dot';\r\n          el.append(dot);\r\n        }\r\n        break;\r\n      }\r\n\r\n      case 'sendMessageUploadAudioAction':\r\n      case 'sendMessageUploadDocumentAction':\r\n      case 'sendMessageUploadRoundAction':\r\n      case 'sendMessageUploadVideoAction':\r\n      case 'sendMessageUploadPhotoAction': {\r\n        c += '-upload';\r\n        /* const trail = document.createElement('span');\r\n        trail.className = c + '-trail';\r\n        el.append(trail); */\r\n        break;\r\n      }\r\n\r\n      case 'sendMessageRecordAudioAction':\r\n      case 'sendMessageRecordRoundAction':\r\n      case 'sendMessageRecordVideoAction': {\r\n        c += '-record';\r\n        break;\r\n      }\r\n\r\n      case 'sendMessageEmojiInteractionSeen':\r\n      case 'sendMessageChooseStickerAction': {\r\n        c += '-choosing-sticker';\r\n        for(let i = 0; i < 2; ++i) {\r\n          const eye = document.createElement('div');\r\n          eye.className = c + '-eye';\r\n          el.append(eye);\r\n        }\r\n        break;\r\n      }\r\n    }\r\n\r\n    el.classList.add(c);\r\n\r\n    return el;\r\n  }\r\n\r\n  public async getPeerTyping(peerId: PeerId, container?: HTMLElement) {\r\n    // const log = this.log.bindPrefix('getPeerTyping-' + peerId);\r\n    // log('getting peer typing');\r\n\r\n    const isUser = peerId.isUser();\r\n    if(isUser && await this.managers.appUsersManager.isBot(peerId)) {\r\n      // log('a bot');\r\n      return;\r\n    }\r\n\r\n    const typings = await this.managers.appProfileManager.getPeerTypings(peerId);\r\n    if(!typings?.length) {\r\n      // log('have no typing');\r\n      return;\r\n    }\r\n\r\n    const typing = typings[0];\r\n\r\n    const langPackKeys: {\r\n      [peerType in 'private' | 'chat' | 'multi']?: Partial<{[action in SendMessageAction['_']]: LangPackKey}>\r\n    } = {\r\n      private: {\r\n        'sendMessageTypingAction': 'Peer.Activity.User.TypingText',\r\n        'sendMessageUploadAudioAction': 'Peer.Activity.User.SendingFile',\r\n        'sendMessageUploadDocumentAction': 'Peer.Activity.User.SendingFile',\r\n        'sendMessageUploadPhotoAction': 'Peer.Activity.User.SendingPhoto',\r\n        'sendMessageUploadVideoAction': 'Peer.Activity.User.SendingVideo',\r\n        'sendMessageUploadRoundAction': 'Peer.Activity.User.SendingVideo',\r\n        'sendMessageRecordVideoAction': 'Peer.Activity.User.RecordingVideo',\r\n        'sendMessageRecordAudioAction': 'Peer.Activity.User.RecordingAudio',\r\n        'sendMessageRecordRoundAction': 'Peer.Activity.User.RecordingVideo',\r\n        'sendMessageGamePlayAction': 'Peer.Activity.User.PlayingGame',\r\n        'sendMessageChooseStickerAction': 'Peer.Activity.User.ChoosingSticker',\r\n        'sendMessageEmojiInteractionSeen': 'Peer.Activity.User.EnjoyingAnimations'\r\n      },\r\n      chat: {\r\n        'sendMessageTypingAction': 'Peer.Activity.Chat.TypingText',\r\n        'sendMessageUploadAudioAction': 'Peer.Activity.Chat.SendingFile',\r\n        'sendMessageUploadDocumentAction': 'Peer.Activity.Chat.SendingFile',\r\n        'sendMessageUploadPhotoAction': 'Peer.Activity.Chat.SendingPhoto',\r\n        'sendMessageUploadVideoAction': 'Peer.Activity.Chat.SendingVideo',\r\n        'sendMessageUploadRoundAction': 'Peer.Activity.Chat.SendingVideo',\r\n        'sendMessageRecordVideoAction': 'Peer.Activity.Chat.RecordingVideo',\r\n        'sendMessageRecordAudioAction': 'Peer.Activity.Chat.RecordingAudio',\r\n        'sendMessageRecordRoundAction': 'Peer.Activity.Chat.RecordingVideo',\r\n        'sendMessageGamePlayAction': 'Peer.Activity.Chat.PlayingGame',\r\n        'sendMessageChooseStickerAction': 'Peer.Activity.Chat.ChoosingSticker',\r\n        'sendMessageEmojiInteractionSeen': 'Peer.Activity.Chat.EnjoyingAnimations'\r\n      },\r\n      multi: {\r\n        'sendMessageTypingAction': 'Peer.Activity.Chat.Multi.TypingText1',\r\n        'sendMessageUploadAudioAction': 'Peer.Activity.Chat.Multi.SendingFile1',\r\n        'sendMessageUploadDocumentAction': 'Peer.Activity.Chat.Multi.SendingFile1',\r\n        'sendMessageUploadPhotoAction': 'Peer.Activity.Chat.Multi.SendingPhoto1',\r\n        'sendMessageUploadVideoAction': 'Peer.Activity.Chat.Multi.SendingVideo1',\r\n        'sendMessageUploadRoundAction': 'Peer.Activity.Chat.Multi.SendingVideo1',\r\n        'sendMessageRecordVideoAction': 'Peer.Activity.Chat.Multi.RecordingVideo1',\r\n        'sendMessageRecordAudioAction': 'Peer.Activity.Chat.Multi.RecordingAudio1',\r\n        'sendMessageRecordRoundAction': 'Peer.Activity.Chat.Multi.RecordingVideo1',\r\n        'sendMessageGamePlayAction': 'Peer.Activity.Chat.Multi.PlayingGame1',\r\n        'sendMessageChooseStickerAction': 'Peer.Activity.Chat.Multi.ChoosingSticker1'\r\n      }\r\n    };\r\n\r\n    const mapa = isUser ? langPackKeys.private : (typings.length > 1 ? langPackKeys.multi : langPackKeys.chat);\r\n    let action = typing.action;\r\n\r\n    if(typings.length > 1) {\r\n      const s: any = {};\r\n      typings.forEach((typing) => {\r\n        const type = typing.action._;\r\n        if(s[type] === undefined) s[type] = 0;\r\n        ++s[type];\r\n      });\r\n\r\n      if(Object.keys(s).length > 1) {\r\n        action = {\r\n          _: 'sendMessageTypingAction'\r\n        };\r\n      }\r\n    }\r\n\r\n    const langPackKey = mapa[action._];\r\n    if(!langPackKey) {\r\n      // log('no langPackKey');\r\n      return;\r\n    }\r\n\r\n    let peerTitlePromise: Promise<any>;\r\n    let args: any[];\r\n    if(peerId.isAnyChat()) {\r\n      const peerTitle = new PeerTitle();\r\n      peerTitlePromise = peerTitle.update({peerId: typing.userId.toPeerId(false), onlyFirstName: true});\r\n      args = [\r\n        peerTitle.element,\r\n        typings.length - 1\r\n      ];\r\n\r\n      await peerTitlePromise;\r\n    }\r\n\r\n    if(!container) {\r\n      container = document.createElement('span');\r\n      container.classList.add('online', 'peer-typing-container');\r\n    }\r\n\r\n    container.classList.toggle('peer-typing-flex', action._ === 'sendMessageChooseStickerAction' || action._ === 'sendMessageEmojiInteractionSeen');\r\n\r\n    let typingElement = container.firstElementChild as HTMLElement;\r\n    if(!typingElement) {\r\n      typingElement = this.getTypingElement(action);\r\n      container.prepend(typingElement);\r\n    } else {\r\n      if(typingElement.dataset.action !== action._) {\r\n        typingElement.replaceWith(this.getTypingElement(action));\r\n      }\r\n    }\r\n\r\n    if(action._ === 'sendMessageEmojiInteractionSeen') {\r\n      if(args) {\r\n        args.pop();\r\n      } else {\r\n        args = [];\r\n      }\r\n\r\n      const span = htmlToSpan(wrapEmojiText(action.emoticon));\r\n      args.push(span);\r\n    }\r\n\r\n    const descriptionElement = i18n(langPackKey, args);\r\n    descriptionElement.classList.add('peer-typing-description');\r\n\r\n    if(container.childElementCount > 1) container.lastElementChild.replaceWith(descriptionElement);\r\n    else container.append(descriptionElement);\r\n    \r\n    // log('returning typing');\r\n    return container;\r\n  }\r\n\r\n  private async getChatStatus(chatId: ChatId): Promise<AckedResult<HTMLElement>> {\r\n    const typingEl = await this.getPeerTyping(chatId.toPeerId(true));\r\n    if(typingEl) {\r\n      return {cached: true, result: Promise.resolve(typingEl)};\r\n    }\r\n\r\n    const result = await this.managers.acknowledged.appProfileManager.getChatFull(chatId);\r\n    const dooo = async(chatInfo: ChatFull) => {\r\n      // this.chat.log('chatInfo res:', chatInfo);\r\n\r\n      const participants_count = (chatInfo as ChatFull.channelFull).participants_count || \r\n        ((chatInfo as ChatFull.chatFull).participants as ChatParticipants.chatParticipants)?.participants?.length || \r\n        1;\r\n      //if(participants_count) {\r\n        let subtitle = await getChatMembersString(chatId);\r\n  \r\n        if(participants_count < 2) {\r\n          return subtitle;\r\n        }\r\n  \r\n        const onlines = await this.managers.appProfileManager.getOnlines(chatId);\r\n        if(onlines > 1) {\r\n          const span = document.createElement('span');\r\n          \r\n          span.append(...join([subtitle, i18n('OnlineCount', [numberThousandSplitter(onlines)])], false));\r\n          subtitle = span;\r\n        }\r\n  \r\n        return subtitle;\r\n      //}\r\n    }; \r\n\r\n    const promise = Promise.resolve(result.result).then(dooo);\r\n    return {\r\n      cached: result.cached,\r\n      result: promise\r\n    };\r\n  }\r\n\r\n  private async getUserStatus(userId: UserId, ignoreSelf?: boolean) {\r\n    const result: AckedResult<HTMLElement> = {\r\n      cached: true,\r\n      result: Promise.resolve(undefined as HTMLElement)\r\n    };\r\n\r\n    const user = await this.managers.appUsersManager.getUser(userId);\r\n    if(!user || (user.pFlags.self && !ignoreSelf)) {\r\n      return result;\r\n    }\r\n\r\n    const subtitle = getUserStatusString(user);\r\n\r\n    if(!user.pFlags.bot) {\r\n      let typingEl = await this.getPeerTyping(userId.toPeerId());\r\n      if(!typingEl && user.status?._ === 'userStatusOnline') {\r\n        typingEl = document.createElement('span');\r\n        typingEl.classList.add('online');\r\n        typingEl.append(subtitle);\r\n      }\r\n\r\n      if(typingEl) {\r\n        result.result = Promise.resolve(typingEl);\r\n        return result;\r\n      }\r\n    }\r\n    \r\n    result.result = Promise.resolve(subtitle);\r\n    return result;\r\n  }\r\n\r\n  private async getPeerStatus(peerId: PeerId, ignoreSelf?: boolean) {\r\n    if(!peerId) return;\r\n    let promise: Promise<AckedResult<HTMLElement>>;\r\n    if(peerId.isAnyChat()) {\r\n      promise = this.getChatStatus(peerId.toChatId());\r\n    } else {\r\n      promise = this.getUserStatus(peerId.toUserId(), ignoreSelf);\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  public async setPeerStatus(\r\n    peerId: PeerId, \r\n    element: HTMLElement, \r\n    needClear: boolean, \r\n    useWhitespace: boolean, \r\n    middleware: () => boolean, \r\n    ignoreSelf?: boolean\r\n  ) {\r\n    // const log = this.log.bindPrefix('status-' + peerId);\r\n    // log('setting status', element);\r\n\r\n    if(!needClear) {\r\n      // * good good good\r\n      const typingContainer = element.querySelector('.peer-typing-container') as HTMLElement;\r\n      if(typingContainer && await this.getPeerTyping(peerId, typingContainer)) {\r\n        // log('already have a status');\r\n        return;\r\n      }\r\n    }\r\n    \r\n    const result = await this.getPeerStatus(peerId, ignoreSelf);\r\n    // log('getPeerStatus result', result);\r\n    if(!middleware()) {\r\n      // log.warn('middleware');\r\n      return;\r\n    }\r\n\r\n    const set = async() => {\r\n      const subtitle = result && await result.result;\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n  \r\n      return () => replaceContent(element, subtitle || placeholder);\r\n    };\r\n    \r\n    const placeholder = useWhitespace ? '' : ''; // ! HERE U CAN FIND WHITESPACE\r\n    if(!result || result.cached) {\r\n      return await set();\r\n    } else if(needClear) {\r\n      return () => {\r\n        element.textContent = placeholder;\r\n        return set().then((callback) => callback && callback());\r\n      };\r\n    }\r\n  }\r\n\r\n  public setChoosingStickerTyping(cancel: boolean) {\r\n    this.managers.appMessagesManager.setTyping(this.chat.peerId, {_: cancel ? 'sendMessageCancelAction' : 'sendMessageChooseStickerAction'});\r\n  }\r\n}\r\n\r\nconst appImManager = new AppImManager();\r\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.appImManager = appImManager);\r\nexport default appImManager;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appMediaPlaybackController from \"../components/appMediaPlaybackController\";\r\nimport { IS_APPLE_MOBILE, IS_MOBILE } from \"../environment/userAgent\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport ListenerSetter, { Listener } from \"../helpers/listenerSetter\";\r\nimport ButtonMenu from \"../components/buttonMenu\";\r\nimport { ButtonMenuToggleHandler } from \"../components/buttonMenuToggle\";\r\nimport ControlsHover from \"../helpers/dom/controlsHover\";\r\nimport { addFullScreenListener, cancelFullScreen, isFullScreen, requestFullScreen } from \"../helpers/dom/fullScreen\";\r\nimport toHHMMSS from \"../helpers/string/toHHMMSS\";\r\nimport MediaProgressLine from \"../components/mediaProgressLine\";\r\nimport VolumeSelector from \"../components/volumeSelector\";\r\nimport debounce from \"../helpers/schedulers/debounce\";\r\nimport overlayCounter from \"../helpers/overlayCounter\";\r\nimport onMediaLoad from \"../helpers/onMediaLoad\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\n\r\nexport default class VideoPlayer extends ControlsHover {\r\n  private static PLAYBACK_RATES = [0.5, 1, 1.5, 2];\r\n  private static PLAYBACK_RATES_ICONS = ['playback_05', 'playback_1x', 'playback_15', 'playback_2x'];\r\n\r\n  protected video: HTMLVideoElement;\r\n  protected wrapper: HTMLDivElement;\r\n  protected progress: MediaProgressLine;\r\n  protected skin: 'default';\r\n\r\n  protected listenerSetter: ListenerSetter;\r\n  protected playbackRateButton: HTMLElement;\r\n  protected pipButton: HTMLElement;\r\n\r\n  /* protected videoParent: HTMLElement;\r\n  protected videoWhichChild: number; */\r\n\r\n  protected onPlaybackRackMenuToggle?: (open: boolean) => void;\r\n  protected onPip?: (pip: boolean) => void;\r\n  protected onPipClose?: () => void;\r\n\r\n  constructor({video, play = false, streamable = false, duration, onPlaybackRackMenuToggle, onPip, onPipClose}: {\r\n    video: HTMLVideoElement, \r\n    play?: boolean, \r\n    streamable?: boolean, \r\n    duration?: number,\r\n    onPlaybackRackMenuToggle?: VideoPlayer['onPlaybackRackMenuToggle'],\r\n    onPip?: VideoPlayer['onPip'],\r\n    onPipClose?: VideoPlayer['onPipClose']\r\n  }) {\r\n    super();\r\n\r\n    this.video = video;\r\n    this.wrapper = document.createElement('div');\r\n    this.wrapper.classList.add('ckin__player');\r\n\r\n    this.onPlaybackRackMenuToggle = onPlaybackRackMenuToggle;\r\n    this.onPip = onPip;\r\n    this.onPipClose = onPipClose;\r\n\r\n    this.listenerSetter = new ListenerSetter();\r\n\r\n    this.setup({\r\n      element: this.wrapper, \r\n      listenerSetter: this.listenerSetter, \r\n      canHideControls: () => {\r\n        return !this.video.paused && (!this.playbackRateButton || !this.playbackRateButton.classList.contains('menu-open'));\r\n      },\r\n      showOnLeaveToClassName: 'media-viewer-caption',\r\n      ignoreClickClassName: 'ckin__controls'\r\n    });\r\n\r\n    video.parentNode.insertBefore(this.wrapper, video);\r\n    this.wrapper.appendChild(video);\r\n\r\n    this.skin = 'default';\r\n\r\n    this.stylePlayer(duration);\r\n    this.setBtnMenuToggle();\r\n\r\n    if(this.skin === 'default') {\r\n      const controls = this.wrapper.querySelector('.default__controls.ckin__controls') as HTMLDivElement;\r\n      this.progress = new MediaProgressLine(video, streamable);\r\n      controls.prepend(this.progress.container);\r\n    }\r\n\r\n    if(play/*  && video.paused */) {\r\n      const promise = video.play();\r\n      promise.catch((err: Error) => {\r\n        if(err.name === 'NotAllowedError') {\r\n          video.muted = true;\r\n          video.autoplay = true;\r\n          video.play();\r\n        }\r\n      }).finally(() => { // due to autoplay, play will not call\r\n        this.wrapper.classList.toggle('is-playing', !this.video.paused);\r\n      });\r\n    }\r\n  }\r\n\r\n  private stylePlayer(initDuration: number) {\r\n    const {wrapper, video, skin, listenerSetter} = this;\r\n\r\n    wrapper.classList.add(skin);\r\n  \r\n    const html = this.buildControls();\r\n    wrapper.insertAdjacentHTML('beforeend', html);\r\n    let timeDuration: HTMLElement;\r\n  \r\n    if(skin === 'default') {\r\n      this.playbackRateButton = this.wrapper.querySelector('.playback-rate') as HTMLElement;\r\n      this.pipButton = this.wrapper.querySelector('.pip') as HTMLElement;\r\n      \r\n      const toggle = wrapper.querySelectorAll('.toggle') as NodeListOf<HTMLElement>;\r\n      const fullScreenButton = wrapper.querySelector('.fullscreen') as HTMLElement;\r\n      const timeElapsed = wrapper.querySelector('#time-elapsed');\r\n      timeDuration = wrapper.querySelector('#time-duration') as HTMLElement;\r\n      timeDuration.innerHTML = toHHMMSS(video.duration | 0);\r\n\r\n      const volumeSelector = new VolumeSelector(listenerSetter);\r\n\r\n      const leftControls = wrapper.querySelector('.left-controls');\r\n      volumeSelector.btn.classList.remove('btn-icon');\r\n      leftControls.insertBefore(volumeSelector.btn, timeElapsed.parentElement);\r\n\r\n      Array.from(toggle).forEach((button) => {\r\n        attachClickEvent(button, () => {\r\n          this.togglePlay();\r\n        }, {listenerSetter: this.listenerSetter});\r\n      });\r\n\r\n      if(this.pipButton) {\r\n        attachClickEvent(this.pipButton, () => {\r\n          this.video.requestPictureInPicture();\r\n        }, {listenerSetter: this.listenerSetter});\r\n\r\n        const onPip = (pip: boolean) => {\r\n          this.wrapper.style.visibility = pip ? 'hidden': '';\r\n          if(this.onPip) {\r\n            this.onPip(pip);\r\n          }\r\n        };\r\n\r\n        const debounceTime = 20;\r\n        const debouncedPip = debounce(onPip, debounceTime, false, true);\r\n\r\n        listenerSetter.add(video)('enterpictureinpicture', () => {\r\n          debouncedPip(true);\r\n\r\n          listenerSetter.add(video)('leavepictureinpicture', () => {\r\n            const onPause = () => {\r\n              clearTimeout(timeout);\r\n              if(this.onPipClose) {\r\n                this.onPipClose();\r\n              }\r\n            };\r\n            const listener = listenerSetter.add(video)('pause', onPause, {once: true}) as any as Listener;\r\n            const timeout = setTimeout(() => {\r\n              listenerSetter.remove(listener);\r\n            }, debounceTime);\r\n          }, {once: true});\r\n        });\r\n\r\n        listenerSetter.add(video)('leavepictureinpicture', () => {\r\n          debouncedPip(false);\r\n        });\r\n      }\r\n\r\n      if(!IS_TOUCH_SUPPORTED) {\r\n        attachClickEvent(video, () => {\r\n          this.togglePlay();\r\n        }, {listenerSetter: this.listenerSetter});\r\n\r\n        listenerSetter.add(document)('keydown', (e: KeyboardEvent) => {\r\n          if(overlayCounter.overlaysActive > 1 || document.pictureInPictureElement === video) { // forward popup is active, etc\r\n            return;\r\n          }\r\n\r\n          const {key, code} = e;\r\n\r\n          let good = true;\r\n          if(code === 'KeyF') {\r\n            this.toggleFullScreen();\r\n          } else if(code === 'KeyM') {\r\n            appMediaPlaybackController.muted = !appMediaPlaybackController.muted;\r\n          } else if(code === 'Space') {\r\n            this.togglePlay();\r\n          } else if(e.altKey && (code === 'Equal' || code === 'Minus')) {\r\n            const add = code === 'Equal' ? 1 : -1;\r\n            const playbackRate = appMediaPlaybackController.playbackRate;\r\n            const idx = VideoPlayer.PLAYBACK_RATES.indexOf(playbackRate);\r\n            const nextIdx = idx + add;\r\n            if(nextIdx >= 0 && nextIdx < VideoPlayer.PLAYBACK_RATES.length) {\r\n              appMediaPlaybackController.playbackRate = VideoPlayer.PLAYBACK_RATES[nextIdx];\r\n            }\r\n          } else if(wrapper.classList.contains('ckin__fullscreen') && (key === 'ArrowLeft' || key === 'ArrowRight')) {\r\n            if(key === 'ArrowLeft') appMediaPlaybackController.seekBackward({action: 'seekbackward'});\r\n            else appMediaPlaybackController.seekForward({action: 'seekforward'});\r\n          } else {\r\n            good = false;\r\n          }\r\n\r\n          if(good) {\r\n            cancelEvent(e);\r\n            return false;\r\n          }\r\n        });\r\n      }\r\n\r\n      listenerSetter.add(video)('dblclick', () => {\r\n        if(!IS_TOUCH_SUPPORTED) {\r\n          this.toggleFullScreen();\r\n        }\r\n      });\r\n\r\n      attachClickEvent(fullScreenButton, () => {\r\n        this.toggleFullScreen();\r\n      }, {listenerSetter: this.listenerSetter});\r\n\r\n      addFullScreenListener(wrapper, this.onFullScreen.bind(this, fullScreenButton), listenerSetter);\r\n\r\n      listenerSetter.add(video)('timeupdate', () => {\r\n        timeElapsed.innerHTML = toHHMMSS(video.currentTime | 0);\r\n      });\r\n\r\n      listenerSetter.add(video)('play', () => {\r\n        wrapper.classList.add('played');\r\n\r\n        if(!IS_TOUCH_SUPPORTED) {\r\n          listenerSetter.add(video)('play', () => {\r\n            this.hideControls(true);\r\n          });\r\n        }\r\n      }, {once: true});\r\n\r\n      listenerSetter.add(video)('pause', () => {\r\n        this.showControls(false);\r\n      });\r\n\r\n      listenerSetter.add(appMediaPlaybackController)('playbackParams', () => {\r\n        this.setPlaybackRateIcon();\r\n      });\r\n    }\r\n\r\n    listenerSetter.add(video)('play', () => {\r\n      wrapper.classList.add('is-playing');\r\n    });\r\n\r\n    listenerSetter.add(video)('pause', () => {\r\n      wrapper.classList.remove('is-playing');\r\n    });\r\n\r\n    if(video.duration || initDuration) {\r\n      timeDuration.innerHTML = toHHMMSS(Math.round(video.duration || initDuration));\r\n    } else {\r\n      onMediaLoad(video).then(() => {\r\n        timeDuration.innerHTML = toHHMMSS(Math.round(video.duration));\r\n      });\r\n    }\r\n  }\r\n\r\n  protected togglePlay() {\r\n    this.video[this.video.paused ? 'play' : 'pause']();\r\n  }\r\n\r\n  private buildControls() {\r\n    const skin = this.skin;\r\n    if(skin === 'default') {\r\n      return `\r\n      <button class=\"${skin}__button--big toggle tgico\" title=\"Toggle Play\"></button>\r\n      <div class=\"${skin}__gradient-bottom ckin__controls\"></div>\r\n      <div class=\"${skin}__controls ckin__controls\">\r\n        <div class=\"bottom-controls\">\r\n          <div class=\"left-controls\">\r\n            <button class=\"btn-icon ${skin}__button toggle tgico\" title=\"Toggle Video\"></button>\r\n            <div class=\"time\">\r\n              <time id=\"time-elapsed\">0:00</time>\r\n              <span> / </span>\r\n              <time id=\"time-duration\">0:00</time>\r\n            </div>\r\n          </div>\r\n          <div class=\"right-controls\">\r\n            <button class=\"btn-icon ${skin}__button btn-menu-toggle playback-rate night\" title=\"Playback Rate\"></button>\r\n            ${!IS_MOBILE && document.pictureInPictureEnabled ? `<button class=\"btn-icon ${skin}__button pip tgico-pip\" title=\"Picture-in-Picture\"></button>` : ''}\r\n            <button class=\"btn-icon ${skin}__button fullscreen tgico-fullscreen\" title=\"Full Screen\"></button>\r\n          </div>\r\n        </div>\r\n      </div>`;\r\n    }\r\n  }\r\n\r\n  protected setBtnMenuToggle() {\r\n    const buttons: Parameters<typeof ButtonMenu>[0] = VideoPlayer.PLAYBACK_RATES.map((rate, idx) => {\r\n      return { \r\n        // icon: VideoPlayer.PLAYBACK_RATES_ICONS[idx],\r\n        regularText: rate + 'x', \r\n        onClick: () => {\r\n          appMediaPlaybackController.playbackRate = rate;\r\n        }\r\n      };\r\n    });\r\n    const btnMenu = ButtonMenu(buttons);\r\n    btnMenu.classList.add('top-left');\r\n    ButtonMenuToggleHandler(\r\n      this.playbackRateButton, \r\n      this.onPlaybackRackMenuToggle ? () => {\r\n        this.onPlaybackRackMenuToggle(true);\r\n      } : undefined, \r\n      undefined, \r\n      this.onPlaybackRackMenuToggle ? () => {\r\n        this.onPlaybackRackMenuToggle(false);\r\n      } : undefined\r\n    );\r\n    this.playbackRateButton.append(btnMenu);\r\n\r\n    this.setPlaybackRateIcon();\r\n  }\r\n\r\n  protected setPlaybackRateIcon() {\r\n    const playbackRateButton = this.playbackRateButton;\r\n    VideoPlayer.PLAYBACK_RATES_ICONS.forEach((className) => {\r\n      className = 'tgico-' + className;\r\n      playbackRateButton.classList.remove(className);\r\n    });\r\n\r\n    let idx = VideoPlayer.PLAYBACK_RATES.indexOf(appMediaPlaybackController.playbackRate);\r\n    if(idx === -1) idx = VideoPlayer.PLAYBACK_RATES.indexOf(1);\r\n\r\n    playbackRateButton.classList.add('tgico-' + VideoPlayer.PLAYBACK_RATES_ICONS[idx]);\r\n  }\r\n  \r\n  protected toggleFullScreen() {\r\n    const player = this.wrapper;\r\n\r\n    // * https://caniuse.com/#feat=fullscreen\r\n    if(IS_APPLE_MOBILE) {\r\n      const video = this.video as any;\r\n      video.webkitEnterFullscreen();\r\n      video.enterFullscreen();\r\n      return;\r\n    }\r\n    \r\n    if(!isFullScreen()) {\r\n      /* const videoParent = this.video.parentElement;\r\n      const videoWhichChild = whichChild(this.video);\r\n      const needVideoRemount = videoParent !== player;\r\n\r\n      if(needVideoRemount) {\r\n        this.videoParent = videoParent;\r\n        this.videoWhichChild = videoWhichChild;\r\n        player.prepend(this.video);\r\n      } */\r\n  \r\n      requestFullScreen(player);\r\n    } else {\r\n      /* if(this.videoParent) {\r\n        const {videoWhichChild, videoParent} = this;\r\n        if(!videoWhichChild) {\r\n          videoParent.prepend(this.video);\r\n        } else {\r\n          videoParent.insertBefore(this.video, videoParent.children[videoWhichChild]);\r\n        }\r\n\r\n        this.videoParent = null;\r\n        this.videoWhichChild = -1;\r\n      } */\r\n  \r\n      cancelFullScreen();\r\n    }\r\n  }\r\n  \r\n  protected onFullScreen(fullScreenButton: HTMLElement) {\r\n    const isFull = isFullScreen();\r\n    this.wrapper.classList.toggle('ckin__fullscreen', isFull);\r\n    if(!isFull) {\r\n      fullScreenButton.classList.remove('tgico-smallscreen');\r\n      fullScreenButton.classList.add('tgico-fullscreen');\r\n      fullScreenButton.setAttribute('title', 'Full Screen');\r\n    } else {\r\n      fullScreenButton.classList.remove('tgico-fullscreen');\r\n      fullScreenButton.classList.add('tgico-smallscreen');\r\n      fullScreenButton.setAttribute('title', 'Exit Full Screen');\r\n    }\r\n  }\r\n\r\n  public cleanup() {\r\n    super.cleanup();\r\n    this.listenerSetter.removeAll();\r\n    this.progress.removeListeners();\r\n    this.onPlaybackRackMenuToggle = this.onPip = undefined;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport deferredPromise from \"../helpers/cancellablePromise\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport IS_TOUCH_SUPPORTED from \"../environment/touchSupport\";\r\nimport { IS_MOBILE_SAFARI, IS_SAFARI } from \"../environment/userAgent\";\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport type { MyPhoto } from \"../lib/appManagers/appPhotosManager\";\r\nimport { logger } from \"../lib/logger\";\r\nimport VideoPlayer from \"../lib/mediaPlayer\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport animationIntersector from \"./animationIntersector\";\r\nimport appMediaPlaybackController, { AppMediaPlaybackController } from \"./appMediaPlaybackController\";\r\nimport AvatarElement from \"./avatar\";\r\nimport ButtonIcon from \"./buttonIcon\";\r\nimport { ButtonMenuItemOptions } from \"./buttonMenu\";\r\nimport ButtonMenuToggle from \"./buttonMenuToggle\";\r\nimport ProgressivePreloader from \"./preloader\";\r\nimport SwipeHandler from \"./swipeHandler\";\r\nimport { formatFullSentTime } from \"../helpers/date\";\r\nimport appNavigationController, { NavigationItem } from \"./appNavigationController\";\r\nimport { Message } from \"../layer\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport renderImageFromUrl, { renderImageFromUrlPromise } from \"../helpers/dom/renderImageFromUrl\";\r\nimport getVisibleRect from \"../helpers/dom/getVisibleRect\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport fillPropertyValue from \"../helpers/fillPropertyValue\";\r\nimport generatePathData from \"../helpers/generatePathData\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport PeerTitle from \"./peerTitle\";\r\nimport { doubleRaf, fastRaf } from \"../helpers/schedulers\";\r\nimport RangeSelector from \"./rangeSelector\";\r\nimport windowSize from \"../helpers/windowSize\";\r\nimport ListLoader from \"../helpers/listLoader\";\r\nimport EventListenerBase from \"../helpers/eventListenerBase\";\r\nimport { MyMessage } from \"../lib/appManagers/appMessagesManager\";\r\nimport { NULL_PEER_ID } from \"../lib/mtproto/mtproto_config\";\r\nimport { isFullScreen } from \"../helpers/dom/fullScreen\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport SearchListLoader from \"../helpers/searchListLoader\";\r\nimport createVideo from \"../helpers/dom/createVideo\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport getStrippedThumbIfNeeded from \"../helpers/getStrippedThumbIfNeeded\";\r\nimport setAttachmentSize from \"../helpers/setAttachmentSize\";\r\nimport wrapEmojiText from \"../lib/richTextProcessor/wrapEmojiText\";\r\nimport LazyLoadQueueBase from \"./lazyLoadQueueBase\";\r\nimport overlayCounter from \"../helpers/overlayCounter\";\r\nimport { ThumbCache } from \"../lib/storages/thumbs\";\r\nimport appDownloadManager from \"../lib/appManagers/appDownloadManager\";\r\nimport wrapPeerTitle from \"./wrappers/peerTitle\";\r\n\r\nconst ZOOM_STEP = 0.5;\r\nconst ZOOM_INITIAL_VALUE = 1;\r\nconst ZOOM_MIN_VALUE = 0.5;\r\nconst ZOOM_MAX_VALUE = 4;\r\n\r\n// TODO:   ( SVG)  ,      \r\n// TODO:  \"\"      ,     (,  )\r\n// TODO:    ,    :    ,     , ..  -   ,   \r\n\r\nexport const MEDIA_VIEWER_CLASSNAME = 'media-viewer';\r\n\r\nexport default class AppMediaViewerBase<\r\n  ContentAdditionType extends string, \r\n  ButtonsAdditionType extends string, \r\n  TargetType extends {element: HTMLElement\r\n}> extends EventListenerBase<{\r\n  setMoverBefore: () => void,\r\n  setMoverAfter: () => void\r\n}> {\r\n  protected wholeDiv: HTMLElement;\r\n  protected overlaysDiv: HTMLElement;\r\n  protected author: {[k in 'container' | 'avatarEl' | 'nameEl' | 'date']: HTMLElement} = {} as any;\r\n  protected content: {[k in 'main' | 'container' | 'media' | 'mover' | ContentAdditionType]: HTMLElement} = {} as any;\r\n  protected buttons: {[k in 'download' | 'close' | 'prev' | 'next' | 'mobile-close' | 'zoom' | ButtonsAdditionType]: HTMLElement} = {} as any;\r\n  protected topbar: HTMLElement;\r\n  protected moversContainer: HTMLElement;\r\n  \r\n  protected tempId = 0;\r\n  protected preloader: ProgressivePreloader = null;\r\n  protected preloaderStreamable: ProgressivePreloader = null;\r\n\r\n  //protected targetContainer: HTMLElement = null;\r\n  //protected loadMore: () => void = null;\r\n\r\n  protected log: ReturnType<typeof logger>; \r\n\r\n  protected isFirstOpen = true;\r\n\r\n  // protected needLoadMore = true;\r\n\r\n  protected pageEl = document.getElementById('page-chats') as HTMLDivElement;\r\n\r\n  protected setMoverPromise: Promise<void>;\r\n  protected setMoverAnimationPromise: Promise<void>;\r\n\r\n  protected lazyLoadQueue: LazyLoadQueueBase;\r\n\r\n  protected highlightSwitchersTimeout: number;\r\n\r\n  protected onDownloadClick: (e: MouseEvent) => void;\r\n  protected onPrevClick: (target: TargetType) => void;\r\n  protected onNextClick: (target: TargetType) => void;\r\n\r\n  protected videoPlayer: VideoPlayer;\r\n\r\n  protected zoomElements: {\r\n    container: HTMLElement,\r\n    btnOut: HTMLElement,\r\n    btnIn: HTMLElement,\r\n    rangeSelector: RangeSelector\r\n  } = {} as any;\r\n  // protected zoomValue = ZOOM_INITIAL_VALUE;\r\n  protected zoomSwipeHandler: SwipeHandler;\r\n  protected zoomSwipeStartX = 0;\r\n  protected zoomSwipeStartY = 0;\r\n  protected zoomSwipeX = 0;\r\n  protected zoomSwipeY = 0;\r\n  \r\n  protected ctrlKeyDown: boolean;\r\n  protected releaseSingleMedia: ReturnType<AppMediaPlaybackController['setSingleMedia']>;\r\n  protected navigationItem: NavigationItem;\r\n\r\n  protected managers: AppManagers;\r\n\r\n  get target() {\r\n    return this.listLoader.current;\r\n  }\r\n\r\n  set target(value) {\r\n    this.listLoader.current = value;\r\n  }\r\n\r\n  constructor(\r\n    protected listLoader: ListLoader<TargetType, any>, \r\n    topButtons: Array<keyof AppMediaViewerBase<ContentAdditionType, ButtonsAdditionType, TargetType>['buttons']>\r\n  ) {\r\n    super(false);\r\n\r\n    this.managers = rootScope.managers;\r\n\r\n    this.log = logger('AMV');\r\n    this.preloader = new ProgressivePreloader();\r\n    this.preloaderStreamable = new ProgressivePreloader({\r\n      cancelable: false,\r\n      streamable: true\r\n    });\r\n    this.preloader.construct();\r\n    this.preloaderStreamable.construct();\r\n    this.lazyLoadQueue = new LazyLoadQueueBase();\r\n\r\n    this.wholeDiv = document.createElement('div');\r\n    this.wholeDiv.classList.add(MEDIA_VIEWER_CLASSNAME + '-whole');\r\n\r\n    this.overlaysDiv = document.createElement('div');\r\n    this.overlaysDiv.classList.add('overlays');\r\n\r\n    const mainDiv = document.createElement('div');\r\n    mainDiv.classList.add(MEDIA_VIEWER_CLASSNAME);\r\n\r\n    const topbar = this.topbar = document.createElement('div');\r\n    topbar.classList.add(MEDIA_VIEWER_CLASSNAME + '-topbar', MEDIA_VIEWER_CLASSNAME + '-appear');\r\n\r\n    const topbarLeft = document.createElement('div');\r\n    topbarLeft.classList.add(MEDIA_VIEWER_CLASSNAME + '-topbar-left');\r\n\r\n    this.buttons['mobile-close'] = ButtonIcon('close', {onlyMobile: true});\r\n    \r\n    // * author\r\n    this.author.container = document.createElement('div');\r\n    this.author.container.classList.add(MEDIA_VIEWER_CLASSNAME + '-author', 'no-select');\r\n    const authorRight = document.createElement('div');\r\n    \r\n    this.author.avatarEl = new AvatarElement();\r\n    this.author.avatarEl.classList.add(MEDIA_VIEWER_CLASSNAME + '-userpic', 'avatar-44');\r\n    \r\n    this.author.nameEl = document.createElement('div');\r\n    this.author.nameEl.classList.add(MEDIA_VIEWER_CLASSNAME + '-name');\r\n    \r\n    this.author.date = document.createElement('div');\r\n    this.author.date.classList.add(MEDIA_VIEWER_CLASSNAME + '-date');\r\n    \r\n    authorRight.append(this.author.nameEl, this.author.date);\r\n    \r\n    this.author.container.append(this.author.avatarEl, authorRight);\r\n    \r\n    // * buttons\r\n    const buttonsDiv = document.createElement('div');\r\n    buttonsDiv.classList.add(MEDIA_VIEWER_CLASSNAME + '-buttons');\r\n    \r\n    topButtons.concat(['download', 'zoom', 'close']).forEach((name) => {\r\n      const button = ButtonIcon(name, {noRipple: true});\r\n      this.buttons[name] = button;\r\n      buttonsDiv.append(button);\r\n    });\r\n\r\n    this.buttons.zoom.classList.add('zoom-in');\r\n\r\n    // * zoom\r\n    this.zoomElements.container = document.createElement('div');\r\n    this.zoomElements.container.classList.add('zoom-container');\r\n\r\n    this.zoomElements.btnOut = ButtonIcon('zoomout', {noRipple: true});\r\n    attachClickEvent(this.zoomElements.btnOut, () => this.changeZoom(false));\r\n    this.zoomElements.btnIn = ButtonIcon('zoomin', {noRipple: true});\r\n    attachClickEvent(this.zoomElements.btnIn, () => this.changeZoom(true));\r\n\r\n    this.zoomElements.rangeSelector = new RangeSelector({\r\n      step: ZOOM_STEP, \r\n      min: ZOOM_MIN_VALUE, \r\n      max: ZOOM_MAX_VALUE, \r\n      withTransition: true\r\n    }, ZOOM_INITIAL_VALUE);\r\n    this.zoomElements.rangeSelector.setListeners();\r\n    this.zoomElements.rangeSelector.setHandlers({\r\n      onScrub: this.setZoomValue,\r\n      onMouseUp: () => this.setZoomValue()\r\n    });\r\n\r\n    this.zoomElements.container.append(this.zoomElements.btnOut, this.zoomElements.rangeSelector.container, this.zoomElements.btnIn);\r\n\r\n    this.wholeDiv.append(this.zoomElements.container);\r\n\r\n    // * content\r\n    this.content.main = document.createElement('div');\r\n    this.content.main.classList.add(MEDIA_VIEWER_CLASSNAME + '-content');\r\n\r\n    this.content.container = document.createElement('div');\r\n    this.content.container.classList.add(MEDIA_VIEWER_CLASSNAME + '-container');\r\n\r\n    this.content.media = document.createElement('div');\r\n    this.content.media.classList.add(MEDIA_VIEWER_CLASSNAME + '-media');\r\n\r\n    this.content.container.append(this.content.media);\r\n\r\n    this.content.main.append(this.content.container);\r\n    mainDiv.append(this.content.main);\r\n    this.overlaysDiv.append(mainDiv);\r\n    // * overlays end\r\n    \r\n    topbarLeft.append(this.buttons['mobile-close'], this.author.container);\r\n    topbar.append(topbarLeft, buttonsDiv);\r\n\r\n    this.buttons.prev = document.createElement('div');\r\n    this.buttons.prev.className = `${MEDIA_VIEWER_CLASSNAME}-switcher ${MEDIA_VIEWER_CLASSNAME}-switcher-left`;\r\n    this.buttons.prev.innerHTML = `<span class=\"tgico-down ${MEDIA_VIEWER_CLASSNAME}-prev-button\"></span>`;\r\n\r\n    this.buttons.next = document.createElement('div');\r\n    this.buttons.next.className = `${MEDIA_VIEWER_CLASSNAME}-switcher ${MEDIA_VIEWER_CLASSNAME}-switcher-right`;\r\n    this.buttons.next.innerHTML = `<span class=\"tgico-down ${MEDIA_VIEWER_CLASSNAME}-next-button\"></span>`;\r\n\r\n    this.moversContainer = document.createElement('div');\r\n    this.moversContainer.classList.add(MEDIA_VIEWER_CLASSNAME + '-movers');\r\n\r\n    this.wholeDiv.append(this.overlaysDiv, this.buttons.prev, this.buttons.next, this.topbar, this.moversContainer);\r\n\r\n    // * constructing html end\r\n\r\n    this.listLoader.onLoadedMore = () => {\r\n      this.buttons.prev.classList.toggle('hide', !this.listLoader.previous.length);\r\n      this.buttons.next.classList.toggle('hide', !this.listLoader.next.length);\r\n    };\r\n\r\n    this.setNewMover();\r\n  }\r\n\r\n  protected setListeners() {\r\n    attachClickEvent(this.buttons.download, this.onDownloadClick);\r\n    [this.buttons.close, this.buttons['mobile-close'], this.preloaderStreamable.preloader].forEach((el) => {\r\n      attachClickEvent(el, this.close.bind(this));\r\n    });\r\n\r\n    ([[-1, this.buttons.prev], [1, this.buttons.next]] as [number, HTMLElement][]).forEach(([moveLength, button]) => {\r\n      // attachClickEvent(button, (e) => {\r\n      button.addEventListener('click', (e) => {\r\n        cancelEvent(e);\r\n        if(this.setMoverPromise) return;\r\n  \r\n        this.listLoader.go(moveLength);\r\n      });\r\n    });\r\n\r\n    attachClickEvent(this.buttons.zoom, () => {\r\n      if(this.isZooming()) this.toggleZoom(false);\r\n      else {\r\n        this.changeZoom(true);\r\n      }\r\n    });\r\n\r\n    // ! cannot use the function because it'll cancel slide event on touch devices\r\n    // attachClickEvent(this.wholeDiv, this.onClick);\r\n    this.wholeDiv.addEventListener('click', this.onClick);\r\n\r\n    this.listLoader.onJump = (item, older) => {\r\n      if(older) this.onNextClick(item);\r\n      else this.onPrevClick(item);\r\n    };\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      const swipeHandler = new SwipeHandler({\r\n        element: this.wholeDiv, \r\n        onSwipe: (xDiff, yDiff) => {\r\n          if(isFullScreen()) {\r\n            return;\r\n          }\r\n          //console.log(xDiff, yDiff);\r\n\r\n          const percents = Math.abs(xDiff) / windowSize.width;\r\n          if(percents > .2 || xDiff > 125) {\r\n            //console.log('will swipe', xDiff);\r\n\r\n            if(xDiff < 0) {\r\n              this.buttons.prev.click();\r\n            } else {\r\n              this.buttons.next.click();\r\n            }\r\n\r\n            return true;\r\n          }\r\n\r\n          const percentsY = Math.abs(yDiff) / windowSize.height;\r\n          if(percentsY > .2 || yDiff > 125) {\r\n            this.close();\r\n            return true;\r\n          }\r\n\r\n          return false;\r\n        }, \r\n        verifyTouchTarget: (evt) => {\r\n          // * Fix for seek input\r\n          if((evt.target as HTMLElement).tagName === 'INPUT' || findUpClassName(evt.target, 'media-viewer-caption')) {\r\n            return false;\r\n          }\r\n\r\n          return true;\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  protected toggleZoom(enable?: boolean) {\r\n    const isVisible = this.isZooming();\r\n    if(this.zoomElements.rangeSelector.mousedown || this.ctrlKeyDown) {\r\n      enable = true;\r\n    }\r\n\r\n    if(isVisible === enable) return;\r\n\r\n    if(enable === undefined) {\r\n      enable = !isVisible;\r\n    }\r\n\r\n    this.buttons.zoom.classList.toggle('zoom-in', !enable);\r\n    this.zoomElements.container.classList.toggle('is-visible', enable);\r\n    const zoomValue = enable ? this.zoomElements.rangeSelector.value : 1;\r\n    this.setZoomValue(zoomValue);\r\n    this.zoomElements.rangeSelector.setProgress(zoomValue);\r\n\r\n    if(this.videoPlayer) {\r\n      this.videoPlayer.lockControls(enable ? false : undefined);\r\n    }\r\n\r\n    if(enable) {\r\n      if(!this.zoomSwipeHandler) {\r\n        let lastDiffX: number, lastDiffY: number;\r\n        const multiplier = -1;\r\n        this.zoomSwipeHandler = new SwipeHandler({\r\n          element: this.moversContainer,\r\n          onFirstSwipe: () => {\r\n            lastDiffX = lastDiffY = 0;\r\n            this.moversContainer.classList.add('no-transition');\r\n          },\r\n          onSwipe: (xDiff, yDiff) => {\r\n            [xDiff, yDiff] = [xDiff * multiplier, yDiff * multiplier];\r\n            this.zoomSwipeX += xDiff - lastDiffX;\r\n            this.zoomSwipeY += yDiff - lastDiffY;\r\n            [lastDiffX, lastDiffY] = [xDiff, yDiff];\r\n\r\n            this.setZoomValue();\r\n          },\r\n          onReset: () => {\r\n            this.moversContainer.classList.remove('no-transition');\r\n          },\r\n          cursor: 'move'\r\n        });\r\n      } else {\r\n        this.zoomSwipeHandler.setListeners();\r\n      }\r\n      \r\n      this.zoomElements.rangeSelector.setProgress(zoomValue);\r\n    } else if(!enable) {\r\n      this.zoomSwipeHandler.removeListeners();\r\n    }\r\n  }\r\n\r\n  protected changeZoom(add: boolean) {\r\n    this.zoomElements.rangeSelector.addProgress(ZOOM_STEP * (add ? 1 : -1));\r\n    this.setZoomValue();\r\n  }\r\n\r\n  protected setZoomValue = (value = this.zoomElements.rangeSelector.value) => {\r\n    // this.zoomValue = value;\r\n    if(value === ZOOM_INITIAL_VALUE) {\r\n      this.zoomSwipeX = 0;\r\n      this.zoomSwipeY = 0;\r\n    }\r\n\r\n    this.moversContainer.style.transform = `matrix(${value}, 0, 0, ${value}, ${this.zoomSwipeX}, ${this.zoomSwipeY})`;\r\n\r\n    this.zoomElements.btnOut.classList.toggle('inactive', value === ZOOM_MIN_VALUE);\r\n    this.zoomElements.btnIn.classList.toggle('inactive', value === ZOOM_MAX_VALUE);\r\n\r\n    this.toggleZoom(value !== ZOOM_INITIAL_VALUE);\r\n  };\r\n\r\n  protected isZooming() {\r\n    return this.zoomElements.container.classList.contains('is-visible');\r\n  }\r\n\r\n  protected setBtnMenuToggle(buttons: ButtonMenuItemOptions[]) {\r\n    const btnMenuToggle = ButtonMenuToggle({onlyMobile: true}, 'bottom-left', buttons);\r\n    this.topbar.append(btnMenuToggle);\r\n  }\r\n\r\n  public close(e?: MouseEvent) {\r\n    if(e) {\r\n      cancelEvent(e);\r\n    }\r\n\r\n    if(this.setMoverAnimationPromise) return Promise.reject();\r\n\r\n    if(this.navigationItem) {\r\n      appNavigationController.removeItem(this.navigationItem);\r\n    }\r\n\r\n    this.lazyLoadQueue.clear();\r\n\r\n    const promise = this.setMoverToTarget(this.target?.element, true).then(({onAnimationEnd}) => onAnimationEnd);\r\n\r\n    this.listLoader.reset();\r\n    (this.listLoader as SearchListLoader<any>).cleanup && (this.listLoader as SearchListLoader<any>).cleanup();\r\n    this.setMoverPromise = null;\r\n    this.tempId = -1;\r\n    if((window as any).appMediaViewer === this) {\r\n      (window as any).appMediaViewer = undefined;\r\n    }\r\n\r\n    /* if(appSidebarRight.historyTabIDs.slice(-1)[0] === AppSidebarRight.SLIDERITEMSIDS.forward) {\r\n      promise.then(() => {\r\n        appSidebarRight.forwardTab.closeBtn.click();\r\n      });\r\n    } */\r\n\r\n    this.removeGlobalListeners();\r\n\r\n    this.zoomSwipeHandler = undefined;\r\n\r\n    promise.finally(() => {\r\n      this.wholeDiv.remove();\r\n      this.toggleOverlay(false);\r\n    });\r\n\r\n    return promise;\r\n  }\r\n\r\n  protected toggleOverlay(active: boolean) {\r\n    overlayCounter.isOverlayActive = active;\r\n    animationIntersector.checkAnimations(active);\r\n  }\r\n\r\n  protected toggleGlobalListeners(active: boolean) {\r\n    if(active) this.setGlobalListeners();\r\n    else this.removeGlobalListeners();\r\n  }\r\n\r\n  protected removeGlobalListeners() {\r\n    if(this.zoomSwipeHandler) {\r\n      this.zoomSwipeHandler.removeListeners();\r\n    }\r\n\r\n    window.removeEventListener('keydown', this.onKeyDown);\r\n    window.removeEventListener('keyup', this.onKeyUp);\r\n    window.removeEventListener('wheel', this.onWheel, {capture: true});\r\n  }\r\n\r\n  protected setGlobalListeners() {\r\n    if(this.isZooming()) {\r\n      this.zoomSwipeHandler.setListeners();\r\n    }\r\n\r\n    window.addEventListener('keydown', this.onKeyDown);\r\n    window.addEventListener('keyup', this.onKeyUp);\r\n    if(!IS_TOUCH_SUPPORTED) window.addEventListener('wheel', this.onWheel, {passive: false, capture: true});\r\n  }\r\n\r\n  onClick = (e: MouseEvent) => {\r\n    if(this.setMoverAnimationPromise) return;\r\n\r\n    const target = e.target as HTMLElement;\r\n    if(target.tagName === 'A') return;\r\n    cancelEvent(e);\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      if(this.highlightSwitchersTimeout) {\r\n        clearTimeout(this.highlightSwitchersTimeout);\r\n      } else {\r\n        this.wholeDiv.classList.add('highlight-switchers');\r\n      }\r\n\r\n      this.highlightSwitchersTimeout = window.setTimeout(() => {\r\n        this.wholeDiv.classList.remove('highlight-switchers');\r\n        this.highlightSwitchersTimeout = 0;\r\n      }, 3e3);\r\n      \r\n      return;\r\n    }\r\n\r\n    const isZooming = this.isZooming();\r\n    let mover: HTMLElement = null;\r\n    const classNames = ['ckin__player', 'media-viewer-buttons', 'media-viewer-author', 'media-viewer-caption', 'zoom-container'];\r\n    if(isZooming) {\r\n      classNames.push('media-viewer-movers');\r\n    }\r\n\r\n    classNames.find((s) => {\r\n      try {\r\n        mover = findUpClassName(target, s);\r\n        if(mover) return true;\r\n      } catch(err) {return false;}\r\n    });\r\n\r\n    if(/* target === this.mediaViewerDiv */!mover || (!isZooming && (target.tagName === 'IMG' || target.tagName === 'image'))) {\r\n      this.close();\r\n    }\r\n  };\r\n\r\n  private onKeyDown = (e: KeyboardEvent) => {\r\n    //this.log('onKeyDown', e);\r\n    if(overlayCounter.overlaysActive > 1) {\r\n      return;\r\n    }\r\n\r\n    const key = e.key;\r\n    \r\n    let good = true;\r\n    if(key === 'ArrowRight') {\r\n      this.buttons.next.click();\r\n    } else if(key === 'ArrowLeft') {\r\n      this.buttons.prev.click();\r\n    } else if(key === '-' || key === '=') {\r\n      if(this.ctrlKeyDown) {\r\n        this.changeZoom(key === '=');\r\n      }\r\n    } else {\r\n      good = false;\r\n    }\r\n\r\n    if(e.ctrlKey || e.metaKey) {\r\n      this.ctrlKeyDown = true;\r\n    }\r\n\r\n    if(good) {\r\n      cancelEvent(e);\r\n    }\r\n  };\r\n\r\n  private onKeyUp = (e: KeyboardEvent) => {\r\n    if(overlayCounter.overlaysActive > 1) {\r\n      return;\r\n    }\r\n\r\n    if(!(e.ctrlKey || e.metaKey)) {\r\n      this.ctrlKeyDown = false;\r\n\r\n      if(this.isZooming()) {\r\n        this.setZoomValue();\r\n      }\r\n    }\r\n  };\r\n\r\n  private onWheel = (e: WheelEvent) => {\r\n    if(overlayCounter.overlaysActive > 1 || (findUpClassName(e.target, 'media-viewer-caption') && !this.ctrlKeyDown)) {\r\n      return;\r\n    }\r\n\r\n    cancelEvent(e);\r\n\r\n    if(this.ctrlKeyDown) {\r\n      const scrollingUp = e.deltaY < 0;\r\n      // if(!scrollingUp && !this.isZooming()) return;\r\n      this.changeZoom(!!scrollingUp);\r\n    }\r\n  };\r\n\r\n  protected async setMoverToTarget(target: HTMLElement, closing = false, fromRight = 0) {\r\n    this.dispatchEvent('setMoverBefore');\r\n\r\n    const mover = this.content.mover;\r\n\r\n    if(!closing) {\r\n      mover.innerHTML = '';\r\n      //mover.append(this.buttons.prev, this.buttons.next);\r\n    }\r\n    \r\n    const zoomValue = this.isZooming() && closing /* && false */ ? this.zoomElements.rangeSelector.value : ZOOM_INITIAL_VALUE;\r\n    /* if(!(zoomValue > 1 && closing)) */ this.removeCenterFromMover(mover);\r\n\r\n    const wasActive = fromRight !== 0;\r\n\r\n    const delay = rootScope.settings.animationsEnabled ? (wasActive ? 350 : 200) : 0;\r\n    //let delay = wasActive ? 350 : 10000;\r\n\r\n    /* if(wasActive) {\r\n      this.moveTheMover(mover);\r\n      mover = this.setNewMover();\r\n    } */\r\n\r\n    /* if(DEBUG) {\r\n      this.log('setMoverToTarget', target, closing, wasActive, fromRight);\r\n    } */\r\n\r\n    let realParent: HTMLElement;\r\n\r\n    let rect: DOMRect;\r\n    if(target) {\r\n      if(target instanceof AvatarElement || target.classList.contains('grid-item')/*  || target.classList.contains('document-ico') */) {\r\n        realParent = target;\r\n        rect = target.getBoundingClientRect();\r\n      } else if(target instanceof SVGImageElement || target.parentElement instanceof SVGForeignObjectElement) {\r\n        realParent = findUpClassName(target, 'attachment');\r\n        rect = realParent.getBoundingClientRect();\r\n      } else if(target.classList.contains('profile-avatars-avatar')) {\r\n        realParent = findUpClassName(target, 'profile-avatars-container');\r\n        rect = realParent.getBoundingClientRect();\r\n\r\n        // * if not active avatar\r\n        if(closing && target.getBoundingClientRect().left !== rect.left) {\r\n          target = realParent = rect = undefined;\r\n        }\r\n      }\r\n    }\r\n\r\n    if(!target) {\r\n      target = this.content.media;\r\n    }\r\n\r\n    if(!rect) {\r\n      realParent = target.parentElement as HTMLElement;\r\n      rect = target.getBoundingClientRect();\r\n    }\r\n\r\n    let needOpacity = false;\r\n    if(target !== this.content.media && !target.classList.contains('profile-avatars-avatar')) {\r\n      const overflowElement = findUpClassName(realParent, 'scrollable');\r\n      const visibleRect = getVisibleRect(realParent, overflowElement, true);\r\n\r\n      if(closing && (!visibleRect || visibleRect.overflow.vertical === 2 || visibleRect.overflow.horizontal === 2)) {\r\n        target = this.content.media;\r\n        realParent = target.parentElement as HTMLElement;\r\n        rect = target.getBoundingClientRect();\r\n      } else if(visibleRect && (visibleRect.overflow.vertical === 1 || visibleRect.overflow.horizontal === 1)) {\r\n        needOpacity = true;\r\n      }\r\n    }\r\n\r\n    const containerRect = this.content.media.getBoundingClientRect();\r\n    \r\n    let transform = '';\r\n    let left: number;\r\n    let top: number;\r\n\r\n    if(wasActive) {\r\n      left = fromRight === 1 ? windowSize.width : -containerRect.width;\r\n      top = containerRect.top;\r\n    } else {\r\n      left = rect.left;\r\n      top = rect.top;\r\n    }\r\n\r\n    /* if(zoomValue > 1) { // 33\r\n      // const diffX = (rect.width * zoomValue - rect.width) / 4;\r\n      const diffX = (rect.width * zoomValue - rect.width) / 2;\r\n      const diffY = (rect.height * zoomValue - rect.height) / 4;\r\n      // left -= diffX;\r\n      // top += diffY;\r\n    } */\r\n\r\n    transform += `translate3d(${left}px,${top}px,0) `;\r\n\r\n    /* if(wasActive) {\r\n      left = fromRight === 1 ? appPhotosManager.windowW / 2 : -(containerRect.width + appPhotosManager.windowW / 2);\r\n      transform += `translate(${left}px,-50%) `;\r\n    } else {\r\n      left = rect.left - (appPhotosManager.windowW / 2);\r\n      top = rect.top - (appPhotosManager.windowH / 2);\r\n      transform += `translate(${left}px,${top}px) `;\r\n    } */\r\n\r\n    let aspecter: HTMLDivElement;\r\n    if(target instanceof HTMLImageElement || target instanceof HTMLVideoElement || target.tagName === 'DIV') {\r\n      if(mover.firstElementChild && mover.firstElementChild.classList.contains('media-viewer-aspecter')) {\r\n        aspecter = mover.firstElementChild as HTMLDivElement;\r\n\r\n        const player = aspecter.querySelector('.ckin__player');\r\n        if(player) {\r\n          const video = player.firstElementChild as HTMLVideoElement;\r\n          aspecter.append(video);\r\n          player.remove();\r\n        }\r\n\r\n        if(!aspecter.style.cssText) { //  - ,   ,       \r\n          mover.classList.remove('active');\r\n          this.setFullAspect(aspecter, containerRect, rect);\r\n          void mover.offsetLeft; // reflow\r\n          mover.classList.add('active');\r\n        }\r\n      } else {\r\n        aspecter = document.createElement('div');\r\n        aspecter.classList.add('media-viewer-aspecter'/* , 'disable-hover' */);\r\n        mover.prepend(aspecter);\r\n      }\r\n      \r\n      aspecter.style.cssText = `width: ${rect.width}px; height: ${rect.height}px; transform: scale3d(${containerRect.width / rect.width}, ${containerRect.height / rect.height}, 1);`;\r\n    }\r\n\r\n    mover.style.width = containerRect.width + 'px';\r\n    mover.style.height = containerRect.height + 'px';\r\n\r\n    // const scaleX = rect.width / (containerRect.width * zoomValue);\r\n    // const scaleY = rect.height / (containerRect.height * zoomValue);\r\n    const scaleX = rect.width / containerRect.width;\r\n    const scaleY = rect.height / containerRect.height;\r\n    if(!wasActive) {\r\n      transform += `scale3d(${scaleX},${scaleY},1) `;\r\n    }\r\n\r\n    let borderRadius = window.getComputedStyle(realParent).getPropertyValue('border-radius');\r\n    const brSplitted = fillPropertyValue(borderRadius) as string[];\r\n    borderRadius = brSplitted.map((r) => (parseInt(r) / scaleX) + 'px').join(' ');\r\n    if(!wasActive) {\r\n      mover.style.borderRadius = borderRadius;\r\n    }\r\n    //let borderRadius = '0px 0px 0px 0px';\r\n\r\n    if(closing && zoomValue !== 1) {\r\n      // const width = this.moversContainer.scrollWidth * scaleX;\r\n      // const height = this.moversContainer.scrollHeight * scaleY;\r\n      const willBeLeft = windowSize.width / 2 - rect.width / 2;\r\n      const willBeTop = windowSize.height / 2 - rect.height / 2;\r\n      const left = rect.left - willBeLeft/*  + (width - rect.width) / 2 */;\r\n      const top = rect.top - willBeTop/*  + (height - rect.height) / 2 */;\r\n      this.moversContainer.style.transform = `matrix(${scaleX}, 0, 0, ${scaleY}, ${left}, ${top})`;\r\n    } else {\r\n      mover.style.transform = transform;\r\n    }\r\n\r\n    needOpacity && (mover.style.opacity = '0'/* !closing ? '0' : '' */);\r\n\r\n    /* if(wasActive) {\r\n      this.log('setMoverToTarget', mover.style.transform);\r\n    } */\r\n\r\n    let path: SVGPathElement;\r\n    const isOut = target.classList.contains('is-out');\r\n\r\n    const deferred = this.setMoverAnimationPromise = deferredPromise<void>();\r\n    const ret = {onAnimationEnd: deferred};\r\n\r\n    const timeout = setTimeout(() => {\r\n      if(!deferred.isFulfilled && !deferred.isRejected) {\r\n        deferred.resolve();\r\n      }\r\n    }, 1000);\r\n\r\n    deferred.finally(() => {\r\n      this.dispatchEvent('setMoverAfter');\r\n\r\n      if(this.setMoverAnimationPromise === deferred) {\r\n        this.setMoverAnimationPromise = null;\r\n      }\r\n      \r\n      clearTimeout(timeout);\r\n    });\r\n\r\n    if(!closing) {\r\n      let mediaElement: HTMLImageElement | HTMLVideoElement;\r\n      let src: string;\r\n\r\n      if(target instanceof HTMLVideoElement) {\r\n        const elements = Array.from(target.parentElement.querySelectorAll('img')) as HTMLImageElement[];\r\n        if(elements.length) {\r\n          target = elements.pop();\r\n        }\r\n      }\r\n\r\n      if(target.tagName === 'DIV' || target.tagName === 'AVATAR-ELEMENT') { // useContainerAsTarget\r\n        const images = Array.from(target.querySelectorAll('img')) as HTMLImageElement[];\r\n        const image = images.pop();\r\n        if(image) {\r\n          mediaElement = new Image();\r\n          src = image.src;\r\n          mover.append(mediaElement);\r\n        }\r\n        /* mediaElement = new Image();\r\n        src = target.style.backgroundImage.slice(5, -2); */\r\n        \r\n      } else if(target instanceof HTMLImageElement) {\r\n        mediaElement = new Image();\r\n        src = target.src;\r\n      } else if(target instanceof HTMLVideoElement) {\r\n        mediaElement = createVideo();\r\n        mediaElement.src = target.src;\r\n      } else if(target instanceof SVGSVGElement) {\r\n        const clipId = target.dataset.clipId;\r\n        const newClipId = clipId + '-mv';\r\n\r\n        const {width, height} = containerRect;\r\n\r\n        const newSvg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\r\n        newSvg.setAttributeNS(null, 'width', '' + width);\r\n        newSvg.setAttributeNS(null, 'height', '' + height);\r\n\r\n        //     \r\n        newSvg.setAttributeNS(null, 'viewBox', `0 0 ${width} ${height}`);\r\n        newSvg.setAttributeNS(null, 'preserveAspectRatio', 'xMidYMid meet');\r\n\r\n        newSvg.insertAdjacentHTML('beforeend', target.firstElementChild.outerHTML.replace(clipId, newClipId));\r\n        newSvg.insertAdjacentHTML('beforeend', target.lastElementChild.outerHTML.replace(clipId, newClipId));\r\n\r\n        //       \r\n        const defs = newSvg.firstElementChild;\r\n        const use = defs.firstElementChild.firstElementChild as SVGUseElement;\r\n        if(use instanceof SVGUseElement) {\r\n          let transform = use.getAttributeNS(null, 'transform');\r\n          transform = transform.replace(/translate\\((.+?), (.+?)\\) scale\\((.+?), (.+?)\\)/, (match, x, y, sX, sY) => {\r\n            x = +x;\r\n            if(x !== 2) {\r\n              x = width - (2 / scaleX);\r\n            } else {\r\n              x = 2 / scaleX;\r\n            }\r\n            \r\n            y = height;\r\n  \r\n            return `translate(${x}, ${y}) scale(${+sX / scaleX}, ${+sY / scaleY})`;\r\n          });\r\n          use.setAttributeNS(null, 'transform', transform);\r\n  \r\n          //   RECT\r\n          path = defs.firstElementChild.lastElementChild as SVGPathElement;\r\n\r\n          //            \r\n          let d: string;\r\n          const br: [number, number, number, number] = borderRadius.split(' ').map((v) => parseInt(v)) as any;\r\n          if(isOut) d = generatePathData(0, 0, width - 9 / scaleX, height, ...br);\r\n          else d = generatePathData(9 / scaleX, 0, width - 9 / scaleX, height, ...br);\r\n          path.setAttributeNS(null, 'd', d);\r\n        }\r\n\r\n        const foreignObject = newSvg.lastElementChild;\r\n        foreignObject.setAttributeNS(null, 'width', '' + containerRect.width);\r\n        foreignObject.setAttributeNS(null, 'height', '' + containerRect.height);\r\n        \r\n        mover.prepend(newSvg);\r\n      }\r\n\r\n      if(aspecter) {\r\n        aspecter.style.borderRadius = borderRadius;\r\n\r\n        if(mediaElement) {\r\n          aspecter.append(mediaElement);\r\n        }\r\n      }\r\n\r\n      mediaElement = mover.querySelector('video, img');\r\n      if(mediaElement instanceof HTMLImageElement) {\r\n        mediaElement.classList.add('thumbnail');\r\n        if(!aspecter) {\r\n          mediaElement.style.width = containerRect.width + 'px';\r\n          mediaElement.style.height = containerRect.height + 'px';\r\n        }\r\n\r\n        if(src) {\r\n          await renderImageFromUrlPromise(mediaElement, src);\r\n        }\r\n      }/*  else if(mediaElement instanceof HTMLVideoElement && mediaElement.firstElementChild && ((mediaElement.firstElementChild as HTMLSourceElement).src || src)) {\r\n        await new Promise((resolve, reject) => {\r\n          mediaElement.addEventListener('loadeddata', resolve);\r\n\r\n          if(src) {\r\n            (mediaElement.firstElementChild as HTMLSourceElement).src = src;\r\n          }\r\n        });\r\n      } */\r\n  \r\n      mover.style.display = '';\r\n\r\n      fastRaf(() => {\r\n        mover.classList.add(wasActive ? 'moving' : 'active');\r\n      });\r\n    } else {\r\n      /* if(mover.classList.contains('center')) {\r\n        mover.classList.remove('center');\r\n        void mover.offsetLeft; // reflow\r\n      } */\r\n      \r\n      if(target instanceof SVGSVGElement) {\r\n        path = mover.querySelector('path');\r\n\r\n        if(path) {\r\n          this.sizeTailPath(path, containerRect, scaleX, delay, false, isOut, borderRadius);\r\n        }\r\n      }\r\n\r\n      if(target.classList.contains('media-viewer-media')) {\r\n        mover.classList.add('hiding');\r\n      }\r\n\r\n      this.toggleWholeActive(false);\r\n\r\n      //return ret;\r\n\r\n      setTimeout(() => {\r\n        mover.style.borderRadius = borderRadius;\r\n\r\n        if(mover.firstElementChild) {\r\n          (mover.firstElementChild as HTMLElement).style.borderRadius = borderRadius;\r\n        }\r\n      }, delay / 2);\r\n\r\n      setTimeout(() => {\r\n        mover.innerHTML = '';\r\n        mover.classList.remove('moving', 'active', 'hiding');\r\n        mover.style.cssText = 'display: none;';\r\n\r\n        deferred.resolve();\r\n      }, delay);\r\n\r\n      mover.classList.remove('opening');\r\n\r\n      return ret;\r\n    }\r\n\r\n    mover.classList.add('opening');\r\n\r\n    //await new Promise((resolve) => setTimeout(resolve, 0));\r\n    //await new Promise((resolve) => window.requestAnimationFrame(resolve));\r\n    // *  RAF' ,       (  )\r\n    await doubleRaf();\r\n\r\n    //     - \r\n    // throw '';\r\n\r\n    //await new Promise((resolve) => setTimeout(resolve, 5e3));\r\n\r\n    mover.style.transform = `translate3d(${containerRect.left}px,${containerRect.top}px,0) scale3d(1,1,1)`;\r\n    //mover.style.transform = `translate(-50%,-50%) scale(1,1)`;\r\n    needOpacity && (mover.style.opacity = ''/* closing ? '0' : '' */);\r\n\r\n    if(aspecter) {\r\n      this.setFullAspect(aspecter, containerRect, rect);\r\n    }\r\n\r\n    //throw '';\r\n\r\n    setTimeout(() => {\r\n      mover.style.borderRadius = '';\r\n\r\n      if(mover.firstElementChild) {\r\n        (mover.firstElementChild as HTMLElement).style.borderRadius = '';\r\n      }\r\n    }, 0/* delay / 2 */);\r\n\r\n    mover.dataset.timeout = '' + setTimeout(() => {\r\n      mover.classList.remove('moving', 'opening');\r\n\r\n      if(aspecter) { //  - ,   ,       \r\n        if(mover.querySelector('video') || true) {\r\n          mover.classList.remove('active');\r\n          aspecter.style.cssText = '';\r\n          void mover.offsetLeft; // reflow\r\n        }\r\n        \r\n        //aspecter.classList.remove('disable-hover');\r\n      }\r\n\r\n      //       ,      \r\n      mover.classList.add('center', 'no-transition');\r\n      /* mover.style.left = mover.style.top = '50%';\r\n      mover.style.transform = 'translate(-50%, -50%)';\r\n      void mover.offsetLeft; // reflow */\r\n\r\n      //      \r\n      mover.classList.add('active');\r\n      delete mover.dataset.timeout;\r\n\r\n      deferred.resolve();\r\n    }, delay);\r\n\r\n    if(path) {\r\n      this.sizeTailPath(path, containerRect, scaleX, delay, true, isOut, borderRadius);\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  protected toggleWholeActive(active: boolean) {\r\n    if(active) {\r\n      this.wholeDiv.classList.add('active');\r\n    } else {\r\n      this.wholeDiv.classList.add('backwards');\r\n      setTimeout(() => {\r\n        this.wholeDiv.classList.remove('active');\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  protected setFullAspect(aspecter: HTMLDivElement, containerRect: DOMRect, rect: DOMRect) {\r\n    /* let media = aspecter.firstElementChild;\r\n    let proportion: number;\r\n    if(media instanceof HTMLImageElement) {\r\n      proportion = media.naturalWidth / media.naturalHeight;\r\n    } else if(media instanceof HTMLVideoElement) {\r\n      proportion = media.videoWidth / media.videoHeight;\r\n    } */\r\n    const proportion = containerRect.width / containerRect.height;\r\n\r\n    let {width, height} = rect;\r\n    /* if(proportion === 1) {\r\n      aspecter.style.cssText = '';\r\n    } else { */\r\n      if(proportion > 0) {\r\n        width = height * proportion;\r\n      } else {\r\n        height = width * proportion;\r\n      }\r\n\r\n      //this.log('will set style aspecter:', `width: ${width}px; height: ${height}px; transform: scale(${containerRect.width / width}, ${containerRect.height / height});`);\r\n\r\n      aspecter.style.cssText = `width: ${width}px; height: ${height}px; transform: scale3d(${containerRect.width / width}, ${containerRect.height / height}, 1);`;\r\n    //}\r\n  }\r\n\r\n  protected sizeTailPath(path: SVGPathElement, rect: DOMRect, scaleX: number, delay: number, upscale: boolean, isOut: boolean, borderRadius: string) {\r\n    const start = Date.now();\r\n    const {width, height} = rect;\r\n    delay = delay / 2;\r\n\r\n    const br = borderRadius.split(' ').map((v) => parseInt(v));\r\n\r\n    const step = () => {\r\n      const diff = Date.now() - start;\r\n\r\n      let progress = delay ? diff / delay : 1;\r\n      if(progress > 1) progress = 1;\r\n      if(upscale) progress = 1 - progress;\r\n\r\n      const _br: [number, number, number, number] = br.map((v) => v * progress) as any;\r\n\r\n      let d: string;\r\n      if(isOut) d = generatePathData(0, 0, width - (9 / scaleX * progress), height, ..._br);\r\n      else d = generatePathData(9 / scaleX * progress, 0, width/* width - (9 / scaleX * progress) */, height, ..._br);\r\n      path.setAttributeNS(null, 'd', d);\r\n\r\n      if(diff < delay) fastRaf(step);\r\n    };\r\n    \r\n    //window.requestAnimationFrame(step);\r\n    step();\r\n  }\r\n\r\n  protected removeCenterFromMover(mover: HTMLElement) {\r\n    if(mover.classList.contains('center')) {\r\n      //const rect = mover.getBoundingClientRect();\r\n      const rect = this.content.media.getBoundingClientRect();\r\n      mover.style.transform = `translate3d(${rect.left}px,${rect.top}px,0)`;\r\n      mover.classList.remove('center');\r\n      void mover.offsetLeft; // reflow\r\n      mover.classList.remove('no-transition');\r\n    }\r\n  }\r\n\r\n  protected moveTheMover(mover: HTMLElement, toLeft = true) {\r\n    const windowW = windowSize.width;\r\n\r\n    this.removeCenterFromMover(mover);\r\n\r\n    //mover.classList.remove('active');\r\n    mover.classList.add('moving');\r\n\r\n    if(mover.dataset.timeout) { //     -  ,      \r\n      clearTimeout(+mover.dataset.timeout);\r\n    }\r\n\r\n    const rect = mover.getBoundingClientRect();\r\n\r\n    const newTransform = mover.style.transform.replace(/translate3d\\((.+?),/, (match, p1) => {\r\n      const x = toLeft ? -rect.width : windowW;\r\n      //const x = toLeft ? -(rect.right + (rect.width / 2)) : windowW / 2;\r\n\r\n      return match.replace(p1, x + 'px');\r\n    });\r\n\r\n    ////////this.log('set newTransform:', newTransform, mover.style.transform, toLeft);\r\n    mover.style.transform = newTransform;\r\n\r\n    setTimeout(() => {\r\n      mover.remove();\r\n    }, 350);\r\n  }\r\n\r\n  protected setNewMover() {\r\n    const newMover = document.createElement('div');\r\n    newMover.classList.add('media-viewer-mover');\r\n    newMover.style.display = 'none';\r\n\r\n    if(this.content.mover) {\r\n      const oldMover = this.content.mover;\r\n      oldMover.parentElement.append(newMover);\r\n    } else {\r\n      this.moversContainer.append(newMover);\r\n    }\r\n\r\n    return this.content.mover = newMover;\r\n  }\r\n\r\n  protected updateMediaSource(target: HTMLElement, url: string, tagName: 'video' | 'img') {\r\n    //if(target instanceof SVGSVGElement) {\r\n      const el = target.tagName.toLowerCase() === tagName ? target : target.querySelector(tagName) as HTMLElement;\r\n      if(el && !findUpClassName(target, 'document')) {\r\n        if(findUpClassName(target, 'attachment')) {\r\n          // two parentElements because element can be contained in aspecter\r\n          const preloader = target.parentElement.parentElement.querySelector('.preloader-container') as HTMLElement;\r\n          if(preloader) {\r\n            if(tagName === 'video') {\r\n              if(preloader.classList.contains('manual')) {\r\n                preloader.click();\r\n                // return;\r\n              }\r\n    \r\n              return;\r\n            }\r\n            \r\n            preloader.remove();\r\n          }\r\n        }\r\n\r\n        renderImageFromUrl(el, url);\r\n\r\n        // ! ,       \r\n        if(el.classList.contains('thumbnail') && el.parentElement.classList.contains('media-container-aspecter')) {\r\n          el.classList.remove('thumbnail');\r\n        }\r\n      }\r\n    /* } else {\r\n\r\n    } */\r\n  }\r\n\r\n  protected setAuthorInfo(fromId: PeerId | string, timestamp: number) {\r\n    const isPeerId = fromId.isPeerId();\r\n    let wrapTitlePromise: Promise<HTMLElement> | HTMLElement;\r\n    if(isPeerId) {\r\n      wrapTitlePromise = wrapPeerTitle({\r\n        peerId: fromId as PeerId,\r\n        dialog: false,\r\n        onlyFirstName: false,\r\n        plainText: false\r\n      })\r\n    } else {\r\n      const title = wrapTitlePromise = document.createElement('span');\r\n      title.append(wrapEmojiText(fromId));\r\n      title.classList.add('peer-title');\r\n    }\r\n\r\n    let oldAvatar = this.author.avatarEl;\r\n    const newAvatar = this.author.avatarEl = (oldAvatar.cloneNode() as AvatarElement);\r\n\r\n    return Promise.all([\r\n      (this.author.avatarEl as AvatarElement).updateWithOptions({\r\n        peerId: fromId as PeerId || NULL_PEER_ID,\r\n        peerTitle: isPeerId ? undefined : '' + fromId\r\n      }),\r\n\r\n      wrapTitlePromise\r\n    ]).then(([_, title]) => {\r\n      if(this.author.avatarEl !== newAvatar) {\r\n        return;\r\n      }\r\n\r\n      replaceContent(this.author.date, formatFullSentTime(timestamp));\r\n      replaceContent(this.author.nameEl, title);\r\n      oldAvatar.replaceWith(this.author.avatarEl);\r\n    });\r\n  }\r\n  \r\n  protected async _openMedia(\r\n    media: MyDocument | MyPhoto, \r\n    timestamp: number, \r\n    fromId: PeerId | string, \r\n    fromRight: number, \r\n    target?: HTMLElement, \r\n    reverse = false, \r\n    prevTargets: TargetType[] = [], \r\n    nextTargets: TargetType[] = [], \r\n    message?: MyMessage\r\n    /* , needLoadMore = true */\r\n  ) {\r\n    if(this.setMoverPromise) return this.setMoverPromise;\r\n\r\n    /* if(DEBUG) {\r\n      this.log('openMedia:', media, fromId, prevTargets, nextTargets);\r\n    } */\r\n\r\n    const setAuthorPromise = this.setAuthorInfo(fromId, timestamp);\r\n    \r\n    const isDocument = media._ === 'document';\r\n    const isVideo = isDocument && media.mime_type && ((['video', 'gif'] as MyDocument['type'][]).includes(media.type) || media.mime_type.indexOf('video/') === 0);\r\n\r\n    if(this.isFirstOpen) {\r\n      //this.targetContainer = targetContainer;\r\n      // this.needLoadMore = needLoadMore;\r\n      this.isFirstOpen = false;\r\n      this.listLoader.setTargets(prevTargets, nextTargets, reverse);\r\n      (window as any).appMediaViewer = this;\r\n      //this.loadMore = loadMore;\r\n\r\n      /* if(appSidebarRight.historyTabIDs.slice(-1)[0] === AppSidebarRight.SLIDERITEMSIDS.forward) {\r\n        appSidebarRight.forwardTab.closeBtn.click();\r\n        await new Promise((resolve) => setTimeout(resolve, 200));\r\n      } */\r\n    }\r\n\r\n    if(this.listLoader.next.length < 10) {\r\n      setTimeout(() => {\r\n        this.listLoader.load(true);\r\n      }, 0);\r\n    }\r\n\r\n    //if(prevTarget && (!prevTarget.parentElement || !this.isElementVisible(this.targetContainer, prevTarget))) prevTarget = null;\r\n    //if(nextTarget && (!nextTarget.parentElement || !this.isElementVisible(this.targetContainer, nextTarget))) nextTarget = null;\r\n\r\n    this.buttons.prev.classList.toggle('hide', !this.listLoader.previous.length);\r\n    this.buttons.next.classList.toggle('hide', !this.listLoader.next.length);\r\n    \r\n    const container = this.content.media;\r\n    const useContainerAsTarget = !target || target === container;\r\n    if(useContainerAsTarget) target = container;\r\n\r\n    this.target = {element: target} as any;\r\n    const tempId = ++this.tempId;\r\n\r\n    if(container.firstElementChild) {\r\n      container.innerHTML = '';\r\n    }\r\n    \r\n    // ok set\r\n\r\n    const wasActive = fromRight !== 0;\r\n    if(wasActive) {\r\n      this.moveTheMover(this.content.mover, fromRight === 1);\r\n      this.setNewMover();\r\n    } else {\r\n      this.toggleOverlay(true);\r\n      this.setGlobalListeners();\r\n      await setAuthorPromise;\r\n\r\n      if(!this.wholeDiv.parentElement) {\r\n        this.pageEl.insertBefore(this.wholeDiv, document.getElementById('main-columns'));\r\n        void this.wholeDiv.offsetLeft; // reflow\r\n      }\r\n\r\n      this.toggleWholeActive(true);\r\n\r\n      if(!IS_MOBILE_SAFARI) {\r\n        this.navigationItem = {\r\n          type: 'media',\r\n          onPop: (canAnimate) => {\r\n            if(this.setMoverAnimationPromise) {\r\n              return false;\r\n            }\r\n            \r\n            this.close();\r\n          }\r\n        };\r\n\r\n        appNavigationController.pushItem(this.navigationItem);\r\n      }\r\n    }\r\n\r\n    ////////this.log('wasActive:', wasActive);\r\n\r\n    const mover = this.content.mover;\r\n\r\n    const maxWidth = windowSize.width;\r\n    //const maxWidth = this.pageEl.scrollWidth;\r\n    // TODO: const maxHeight = mediaSizes.isMobile ? appPhotosManager.windowH : appPhotosManager.windowH - 100;\r\n    let padding = 0;\r\n    const windowH = windowSize.height;\r\n    if(windowH < 1000000 && !mediaSizes.isMobile) {\r\n      padding = 120;\r\n    }\r\n    const maxHeight = windowH - 120 - padding;\r\n    let thumbPromise: Promise<any> = Promise.resolve();\r\n    const size = setAttachmentSize(media, container, maxWidth, maxHeight, mediaSizes.isMobile ? false : true, undefined, !!(isDocument && media.w && media.h)).photoSize;\r\n    if(useContainerAsTarget) {\r\n      const cacheContext = await this.managers.thumbsStorage.getCacheContext(media, size.type);\r\n      let img: HTMLImageElement | HTMLCanvasElement;\r\n      if(cacheContext.downloaded) {\r\n        img = new Image();\r\n        img.src = cacheContext.url;\r\n      } else {\r\n        const gotThumb = getStrippedThumbIfNeeded(media, cacheContext, true);\r\n        if(gotThumb) {\r\n          thumbPromise = gotThumb.loadPromise;\r\n          img = gotThumb.image;\r\n        }\r\n      }\r\n\r\n      if(img) {\r\n        img.classList.add('thumbnail');\r\n        container.append(img);\r\n      }\r\n    }\r\n\r\n    // need after setAttachmentSize\r\n    /* if(useContainerAsTarget) {\r\n      target = target.querySelector('img, video') || target;\r\n    } */\r\n\r\n    const supportsStreaming: boolean = !!(isDocument && media.supportsStreaming);\r\n    const preloader = supportsStreaming ? this.preloaderStreamable : this.preloader;\r\n\r\n    const getCacheContext = () => {\r\n      return this.managers.thumbsStorage.getCacheContext(media, size?.type);\r\n    };\r\n\r\n    let setMoverPromise: Promise<void>;\r\n    if(isVideo) {\r\n      ////////this.log('will wrap video', media, size);\r\n\r\n      //    safari     event'\r\n      // const video = document.createElement('video');\r\n      const useController = message && media.type !== 'gif';\r\n      const video = /* useController ? \r\n        appMediaPlaybackController.addMedia(message, false, true) as HTMLVideoElement : \r\n         */createVideo({pip: useController});\r\n\r\n      const set = () => this.setMoverToTarget(target, false, fromRight).then(({onAnimationEnd}) => {\r\n      //return; // set and don't move\r\n      //if(wasActive) return;\r\n        //return;\r\n  \r\n        const div = mover.firstElementChild && mover.firstElementChild.classList.contains('media-viewer-aspecter') ? mover.firstElementChild : mover;\r\n        //const video = mover.querySelector('video') || document.createElement('video');\r\n  \r\n        const moverVideo = mover.querySelector('video');\r\n        if(moverVideo) {\r\n          moverVideo.remove();\r\n        }\r\n  \r\n        //video.src = '';\r\n  \r\n        video.setAttribute('playsinline', 'true');\r\n  \r\n        // * fix for playing video if viewer is closed (https://contest.com/javascript-web-bonus/entry1425#issue11629)\r\n        video.addEventListener('timeupdate', () => {\r\n          if(this.tempId !== tempId) {\r\n            video.pause();\r\n          }\r\n        });\r\n\r\n        this.addEventListener('setMoverAfter', () => {\r\n          video.src = '';\r\n          video.load();\r\n        }, {once: true});\r\n  \r\n        if(IS_SAFARI) {\r\n          // test stream\r\n          // video.controls = true;\r\n          video.autoplay = true;\r\n        }\r\n  \r\n        if(media.type === 'gif') {\r\n          video.muted = true;\r\n          video.autoplay = true;\r\n          video.loop = true;\r\n        } else if(media.duration < 60) {\r\n          video.loop = true;\r\n        }\r\n  \r\n        // if(!video.parentElement) {\r\n          div.append(video);\r\n        // }\r\n  \r\n        const canPlayThrough = new Promise((resolve) => {\r\n          video.addEventListener('canplay', resolve, {once: true});\r\n        });\r\n  \r\n        const createPlayer = () => {\r\n          if(media.type !== 'gif') {\r\n            video.dataset.ckin = 'default';\r\n            video.dataset.overlay = '1';\r\n\r\n            Promise.all([canPlayThrough, onAnimationEnd]).then(() => {\r\n              if(this.tempId !== tempId) {\r\n                return;\r\n              }\r\n  \r\n              // const play = useController ? appMediaPlaybackController.willBePlayedMedia === video : true;\r\n              const play = true;\r\n              const player = this.videoPlayer = new VideoPlayer({\r\n                video, \r\n                play, \r\n                streamable: supportsStreaming,\r\n                onPlaybackRackMenuToggle: (open) => {\r\n                  this.wholeDiv.classList.toggle('hide-caption', !!open);\r\n                },\r\n                onPip: (pip) => {\r\n                  const otherMediaViewer = (window as any).appMediaViewer;\r\n                  if(!pip && otherMediaViewer && otherMediaViewer !== this) {\r\n                    this.releaseSingleMedia = undefined;\r\n                    this.close();\r\n                    return;\r\n                  }\r\n\r\n                  const mover = this.moversContainer.lastElementChild as HTMLElement;\r\n                  mover.classList.toggle('hiding', pip);\r\n                  this.toggleWholeActive(!pip);\r\n                  this.toggleOverlay(!pip);\r\n                  this.toggleGlobalListeners(!pip);\r\n\r\n                  if(this.navigationItem) {\r\n                    if(pip) appNavigationController.removeItem(this.navigationItem);\r\n                    else appNavigationController.pushItem(this.navigationItem);\r\n                  }\r\n\r\n                  if(useController) {\r\n                    if(pip) {\r\n                      // appMediaPlaybackController.toggleSwitchers(true);\r\n\r\n                      this.releaseSingleMedia(false);\r\n                      this.releaseSingleMedia = undefined;\r\n\r\n                      appMediaPlaybackController.setPictureInPicture(video);\r\n                    } else {\r\n                      this.releaseSingleMedia = appMediaPlaybackController.setSingleMedia(video, message as Message.message);\r\n                    }\r\n                  }\r\n                },\r\n                onPipClose: () => {\r\n                  // this.target = undefined;\r\n                  // this.toggleWholeActive(false);\r\n                  // this.toggleOverlay(false);\r\n                  this.close();\r\n                }\r\n              });\r\n              player.addEventListener('toggleControls', (show) => {\r\n                this.wholeDiv.classList.toggle('has-video-controls', show);\r\n              });\r\n\r\n              this.addEventListener('setMoverBefore', () => {\r\n                this.wholeDiv.classList.remove('has-video-controls');\r\n                this.videoPlayer.cleanup();\r\n                this.videoPlayer = undefined;\r\n              }, {once: true});\r\n\r\n              if(this.isZooming()) {\r\n                this.videoPlayer.lockControls(false);\r\n              }\r\n              /* div.append(video);\r\n              mover.append(player.wrapper); */\r\n            });\r\n          }\r\n        };\r\n  \r\n        if(supportsStreaming) {\r\n          onAnimationEnd.then(() => {\r\n            if(video.readyState < video.HAVE_FUTURE_DATA) {\r\n              console.log('ppp 1');\r\n              preloader.attach(mover, true);\r\n            }\r\n  \r\n            /* canPlayThrough.then(() => {\r\n              preloader.detach();\r\n            }); */\r\n          });\r\n  \r\n          const attachCanPlay = () => {\r\n            video.addEventListener('canplay', () => {\r\n              console.log('ppp 2');\r\n              preloader.detach();\r\n              video.parentElement.classList.remove('is-buffering');\r\n            }, {once: true});\r\n          };\r\n  \r\n          video.addEventListener('waiting', () => {\r\n            const loading = video.networkState === video.NETWORK_LOADING;\r\n            const isntEnoughData = video.readyState < video.HAVE_FUTURE_DATA;\r\n  \r\n            //this.log('video waiting for progress', loading, isntEnoughData);\r\n            if(loading && isntEnoughData) {\r\n              attachCanPlay();\r\n  \r\n              console.log('ppp 3');\r\n              preloader.attach(mover, true);\r\n  \r\n              //    ,        \r\n              video.parentElement.classList.add('is-buffering');\r\n            }\r\n          });\r\n\r\n          if(this.wholeDiv.classList.contains('no-forwards')) {\r\n            video.addEventListener('contextmenu', (e) => {\r\n              cancelEvent(e);\r\n            });\r\n          }\r\n  \r\n          attachCanPlay();\r\n        }\r\n        \r\n        //if(!video.src || media.url !== video.src) {\r\n          const load = async() => {\r\n            /* if(useController) {\r\n              appMediaPlaybackController.resolveWaitingForLoadMedia(message.peerId, message.mid, message.pFlags.is_scheduled);\r\n            } */\r\n\r\n            const promise: Promise<any> = supportsStreaming ? Promise.resolve() : appDownloadManager.downloadMediaURL({media});\r\n            \r\n            if(!supportsStreaming) {\r\n              onAnimationEnd.then(async() => {\r\n                if(!(await getCacheContext()).url) {\r\n                  console.log('ppp 4');\r\n                  preloader.attach(mover, true, promise);\r\n                }\r\n              });\r\n            }\r\n  \r\n            Promise.all([promise, onAnimationEnd]).then(async() => {\r\n              if(this.tempId !== tempId) {\r\n                this.log.warn('media viewer changed video');\r\n                return;\r\n              }\r\n\r\n              const url = (await getCacheContext()).url;\r\n\r\n              video.addEventListener('error', () => {\r\n                if(video.error.code !== 4) {\r\n                  this.log.error(\"Error \" + video.error.code + \"; details: \" + video.error.message);\r\n                }\r\n      \r\n                if(preloader) {\r\n                  preloader.detach();\r\n                }\r\n              }, {once: true});\r\n\r\n              if(target instanceof SVGSVGElement/*  && (video.parentElement || !isSafari) */) { // if video exists\r\n                //if(!video.parentElement) {\r\n                  div.firstElementChild.lastElementChild.append(video);\r\n                //}\r\n              } else {\r\n                renderImageFromUrl(video, url);\r\n              }\r\n\r\n              // * have to set options (especially playbackRate) after src\r\n              // * https://github.com/videojs/video.js/issues/2516\r\n              if(useController) {\r\n                this.releaseSingleMedia = appMediaPlaybackController.setSingleMedia(video, message as Message.message);\r\n\r\n                this.addEventListener('setMoverBefore', () => {\r\n                  if(this.releaseSingleMedia) {\r\n                    this.releaseSingleMedia();\r\n                    this.releaseSingleMedia = undefined;\r\n                  }\r\n                }, {once: true});\r\n              }\r\n\r\n              this.updateMediaSource(target, url, 'video');\r\n\r\n              createPlayer();\r\n            });\r\n  \r\n            return promise;\r\n          };\r\n  \r\n          this.lazyLoadQueue.unshift({load});\r\n        //} else createPlayer();\r\n      });\r\n\r\n      setMoverPromise = thumbPromise.then(set);\r\n    } else {\r\n      const set = () => this.setMoverToTarget(target, false, fromRight).then(({onAnimationEnd}) => {\r\n      //return; // set and don't move\r\n      //if(wasActive) return;\r\n        //return;\r\n        \r\n        const load = async() => {\r\n          const cancellablePromise = isDocument ? appDownloadManager.downloadMediaURL({media}) : appDownloadManager.downloadMediaURL({media, thumb: size});\r\n  \r\n          onAnimationEnd.then(async() => {\r\n            if(!(await getCacheContext()).url) {\r\n              this.preloader.attachPromise(cancellablePromise);\r\n              //this.preloader.attach(mover, true, cancellablePromise);\r\n            }\r\n          });\r\n          \r\n          Promise.all([onAnimationEnd, cancellablePromise]).then(async() => {\r\n            if(this.tempId !== tempId) {\r\n              this.log.warn('media viewer changed photo');\r\n              return;\r\n            }\r\n            \r\n            ///////this.log('indochina', blob);\r\n    \r\n            const url = (await getCacheContext()).url;\r\n            if(target instanceof SVGSVGElement) {\r\n              this.updateMediaSource(target, url, 'img');\r\n              this.updateMediaSource(mover, url, 'img');\r\n  \r\n              if(mediaSizes.isMobile) {\r\n                const imgs = mover.querySelectorAll('img');\r\n                if(imgs && imgs.length) {\r\n                  imgs.forEach((img) => {\r\n                    img.classList.remove('thumbnail'); //      \r\n                  });\r\n                }\r\n              }\r\n            } else {\r\n              const div = mover.firstElementChild && mover.firstElementChild.classList.contains('media-viewer-aspecter') ? mover.firstElementChild : mover;\r\n              const haveImage = div.firstElementChild?.tagName === 'IMG' ? div.firstElementChild as HTMLImageElement : null;\r\n              if(!haveImage || haveImage.src !== url)  {\r\n                let image = new Image();\r\n                image.classList.add('thumbnail');\r\n    \r\n                //this.log('will renderImageFromUrl:', image, div, target);\r\n    \r\n                renderImageFromUrl(image, url, () => {\r\n                  this.updateMediaSource(target, url, 'img');\r\n  \r\n                  if(haveImage) {\r\n                    fastRaf(() => {\r\n                      haveImage.remove();\r\n                    });\r\n                  }\r\n    \r\n                  div.append(image);\r\n                });\r\n              }\r\n            }\r\n    \r\n            //this.preloader.detach();\r\n          }).catch((err) => {\r\n            this.log.error(err);\r\n            this.preloader.attach(mover);\r\n            this.preloader.setManual();\r\n          });\r\n  \r\n          return cancellablePromise;\r\n        };\r\n  \r\n        this.lazyLoadQueue.unshift({load});\r\n      });\r\n\r\n      setMoverPromise = thumbPromise.then(set);\r\n    }\r\n\r\n    return this.setMoverPromise = setMoverPromise.catch(() => {\r\n      this.setMoverAnimationPromise = null;\r\n    }).finally(() => {\r\n      this.setMoverPromise = null;\r\n    });\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport default function fillPropertyValue(str: string) {\r\n  let splitted = str.split(' ');\r\n  if(splitted.length !== 4) {\r\n    if(!splitted[0]) splitted[0] = '0px';\r\n    for(let i = splitted.length; i < 4; ++i) {\r\n      splitted[i] = splitted[i % 2] || splitted[0] || '0px';\r\n    }\r\n  }\r\n\r\n  return splitted;\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport MEDIA_MIME_TYPES_SUPPORTED from \"../environment/mediaMimeTypesSupport\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent, detachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport findUpTag from \"../helpers/dom/findUpTag\";\r\nimport setInnerHTML from \"../helpers/dom/setInnerHTML\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport SearchListLoader from \"../helpers/searchListLoader\";\r\nimport { Message } from \"../layer\";\r\nimport type { MyDocument } from \"../lib/appManagers/appDocsManager\";\r\nimport appDownloadManager from \"../lib/appManagers/appDownloadManager\";\r\nimport appImManager from \"../lib/appManagers/appImManager\";\r\nimport { MyMessage } from \"../lib/appManagers/appMessagesManager\";\r\nimport { MyPhoto } from \"../lib/appManagers/appPhotosManager\";\r\nimport getMediaFromMessage from \"../lib/appManagers/utils/messages/getMediaFromMessage\";\r\nimport wrapRichText from \"../lib/richTextProcessor/wrapRichText\";\r\nimport { MediaSearchContext } from \"./appMediaPlaybackController\";\r\nimport AppMediaViewerBase, { MEDIA_VIEWER_CLASSNAME } from \"./appMediaViewerBase\";\r\nimport { ButtonMenuItemOptions } from \"./buttonMenu\";\r\nimport PopupDeleteMessages from \"./popups/deleteMessages\";\r\nimport PopupForward from \"./popups/forward\";\r\nimport Scrollable from \"./scrollable\";\r\nimport appSidebarRight from \"./sidebarRight\";\r\nimport AppSharedMediaTab from \"./sidebarRight/tabs/sharedMedia\";\r\n\r\ntype AppMediaViewerTargetType = {\r\n  element: HTMLElement,\r\n  mid: number,\r\n  peerId: PeerId\r\n};\r\nexport default class AppMediaViewer extends AppMediaViewerBase<'caption', 'delete' | 'forward', AppMediaViewerTargetType> {\r\n  protected listLoader: SearchListLoader<AppMediaViewerTargetType>;\r\n  protected btnMenuForward: ButtonMenuItemOptions;\r\n  protected btnMenuDownload: ButtonMenuItemOptions;\r\n  protected btnMenuDelete: ButtonMenuItemOptions;\r\n\r\n  get searchContext() {\r\n    return this.listLoader.searchContext;\r\n  }\r\n\r\n  constructor() {\r\n    super(new SearchListLoader({\r\n      processItem: (item) => {\r\n        const isForDocument = this.searchContext.inputFilter._ === 'inputMessagesFilterDocument';\r\n        const {mid, peerId} = item;\r\n        const media: MyPhoto | MyDocument = getMediaFromMessage(item);\r\n\r\n        if(!media) return;\r\n        \r\n        if(isForDocument && !AppMediaViewer.isMediaCompatibleForDocumentViewer(media)) {\r\n          return;\r\n        }\r\n\r\n        return {element: null as HTMLElement, mid, peerId};\r\n      }\r\n    }), ['delete', 'forward']);\r\n\r\n    this.listLoader.onEmptied = () => {\r\n      this.close();\r\n    };\r\n\r\n    /* const stub = document.createElement('div');\r\n    stub.classList.add(MEDIA_VIEWER_CLASSNAME + '-stub');\r\n    this.content.main.prepend(stub); */\r\n\r\n    this.content.caption = document.createElement('div');\r\n    this.content.caption.classList.add(MEDIA_VIEWER_CLASSNAME + '-caption', 'message'/* , 'media-viewer-stub' */);\r\n\r\n    let captionTimeout: number;\r\n    const setCaptionTimeout = () => {\r\n      if(captionTimeout) {\r\n        clearTimeout(captionTimeout);\r\n      }\r\n\r\n      captionTimeout = window.setTimeout(() => {\r\n        captionTimeout = undefined;\r\n        this.content.caption.classList.remove('is-focused');\r\n      }, 800);\r\n    };\r\n    this.content.caption.addEventListener('touchstart', () => {\r\n      if(!mediaSizes.isMobile) return;\r\n\r\n      this.content.caption.classList.add('is-focused');\r\n      \r\n      if(captionTimeout) {\r\n        clearTimeout(captionTimeout);\r\n        captionTimeout = undefined;\r\n      }\r\n      \r\n      document.addEventListener('touchend', setCaptionTimeout, {once: true});\r\n    });\r\n\r\n    const captionScrollable = new Scrollable(this.content.caption);\r\n    captionScrollable.onAdditionalScroll = setCaptionTimeout;\r\n\r\n    //this.content.main.append(this.content.caption);\r\n    this.wholeDiv.append(this.content.caption);\r\n\r\n    attachClickEvent(this.buttons.delete, this.onDeleteClick);\r\n\r\n    const buttons: ButtonMenuItemOptions[] = [this.btnMenuForward = {\r\n      icon: 'forward',\r\n      text: 'Forward',\r\n      onClick: this.onForwardClick\r\n    }, this.btnMenuDownload = {\r\n      icon: 'download',\r\n      text: 'MediaViewer.Context.Download',\r\n      onClick: this.onDownloadClick\r\n    }, this.btnMenuDelete = {\r\n      icon: 'delete danger',\r\n      text: 'Delete',\r\n      onClick: this.onDeleteClick\r\n    }];\r\n\r\n    this.setBtnMenuToggle(buttons);\r\n\r\n    // * constructing html end\r\n    \r\n    this.setListeners();\r\n  }\r\n\r\n  protected setListeners() {\r\n    super.setListeners();\r\n    attachClickEvent(this.buttons.forward, this.onForwardClick);\r\n    attachClickEvent(this.author.container, this.onAuthorClick);\r\n\r\n    const onCaptionClick = (e: MouseEvent) => {\r\n      const a = findUpTag(e.target, 'A');\r\n      const spoiler = findUpClassName(e.target, 'spoiler');\r\n      if(a instanceof HTMLAnchorElement && (!spoiler || this.content.caption.classList.contains('is-spoiler-visible'))) { // close viewer if it's t.me/ redirect\r\n        const onclick = a.getAttribute('onclick');\r\n        if(!onclick || onclick.includes('showMaskedAlert')) {\r\n          return;\r\n        }\r\n\r\n        cancelEvent(e);\r\n\r\n        this.close().then(() => {\r\n          this.content.caption.removeEventListener('click', onCaptionClick, {capture: true});\r\n          a.click();\r\n        });\r\n\r\n        return false;\r\n      }\r\n    };\r\n\r\n    this.content.caption.addEventListener('click', onCaptionClick, {capture: true});\r\n  }\r\n\r\n  /* public close(e?: MouseEvent) {\r\n    const good = !this.setMoverAnimationPromise;\r\n    const promise = super.close(e);\r\n\r\n    if(good) { // clear\r\n      this.currentMessageId = 0;\r\n      this.peerId = 0;\r\n    }\r\n\r\n    return promise;\r\n  } */\r\n\r\n  protected getMessageByPeer(peerId: PeerId, mid: number) {\r\n    return this.searchContext.isScheduled ? this.managers.appMessagesManager.getScheduledMessageByPeer(peerId, mid) : this.managers.appMessagesManager.getMessageByPeer(peerId, mid);\r\n  }\r\n\r\n  onPrevClick = async(target: AppMediaViewerTargetType) => {\r\n    this.openMedia(await this.getMessageByPeer(target.peerId, target.mid), target.element, -1);\r\n  };\r\n\r\n  onNextClick = async(target: AppMediaViewerTargetType) => {\r\n    this.openMedia(await this.getMessageByPeer(target.peerId, target.mid), target.element, 1);\r\n  };\r\n\r\n  onDeleteClick = () => {\r\n    const target = this.target;\r\n    new PopupDeleteMessages(target.peerId, [target.mid], 'chat', () => {\r\n      this.target = {element: this.content.media} as any;\r\n      this.close();\r\n    });\r\n  };\r\n\r\n  onForwardClick = () => {\r\n    const target = this.target;\r\n    if(target.mid) {\r\n      //appSidebarRight.forwardTab.open([target.mid]);\r\n      new PopupForward({\r\n        [target.peerId]: [target.mid]\r\n      }, () => {\r\n        return this.close();\r\n      });\r\n    }\r\n  };\r\n\r\n  onAuthorClick = async(e: MouseEvent) => {\r\n    const {mid, peerId} = this.target;\r\n    if(mid && mid !== Number.MAX_SAFE_INTEGER) {\r\n      const threadId = this.searchContext.threadId;\r\n      const message = await this.getMessageByPeer(peerId, mid);\r\n      this.close(e)\r\n      //.then(() => mediaSizes.isMobile ? appSidebarRight.sharedMediaTab.closeBtn.click() : Promise.resolve())\r\n      .then(async() => {\r\n        if(mediaSizes.isMobile) {\r\n          const tab = appSidebarRight.getTab(AppSharedMediaTab);\r\n          if(tab) {\r\n            tab.close();\r\n          }\r\n        }\r\n        \r\n        appImManager.setInnerPeer({\r\n          peerId: message.peerId, \r\n          lastMsgId: mid, \r\n          type: threadId ? 'discussion' : undefined, \r\n          threadId\r\n        });\r\n      });\r\n    }\r\n  };\r\n\r\n  onDownloadClick = async() => {\r\n    const {peerId, mid} = this.target;\r\n    const message = await this.getMessageByPeer(peerId, mid);\r\n    const media = getMediaFromMessage(message);\r\n    if(!media) return;\r\n    appDownloadManager.downloadToDisc({media, queueId: appImManager.chat.bubbles.lazyLoadQueue.queueId});\r\n  };\r\n\r\n  private setCaption(message: MyMessage) {\r\n    const caption = (message as Message.message).message;\r\n    let html: Parameters<typeof setInnerHTML>[1] = '';\r\n    if(caption) {\r\n      html = wrapRichText(caption, {\r\n        entities: (message as Message.message).totalEntities\r\n      });\r\n    }\r\n    \r\n    // html = 'Dandelion are a family of flowering plants that grow in many parts of the world.';\r\n    setInnerHTML(this.content.caption.firstElementChild, html);\r\n    this.content.caption.classList.toggle('hide', !caption);\r\n    // this.content.container.classList.toggle('with-caption', !!caption);\r\n  }\r\n\r\n  public setSearchContext(context: MediaSearchContext) {\r\n    this.listLoader.setSearchContext(context);\r\n\r\n    return this;\r\n  }\r\n\r\n  public async openMedia(message: MyMessage, target?: HTMLElement, fromRight = 0, reverse = false, \r\n    prevTargets: AppMediaViewerTargetType[] = [], nextTargets: AppMediaViewerTargetType[] = []/* , needLoadMore = true */) {\r\n    if(this.setMoverPromise) return this.setMoverPromise;\r\n\r\n    const mid = message.mid;\r\n    const fromId = (message as Message.message).fwd_from && !message.fromId ? (message as Message.message).fwd_from.from_name : message.fromId;\r\n    const media = getMediaFromMessage(message);\r\n\r\n    const cantForwardMessage = message._ === 'messageService' || !this.managers.appMessagesManager.canForward(message);\r\n    [this.buttons.forward, this.btnMenuForward.element].forEach((button) => {\r\n      button.classList.toggle('hide', cantForwardMessage);\r\n    });\r\n\r\n    this.wholeDiv.classList.toggle('no-forwards', cantForwardMessage);\r\n    \r\n    const cantDownloadMessage = cantForwardMessage;\r\n    [this.buttons.download, this.btnMenuDownload.element].forEach((button) => {\r\n      button.classList.toggle('hide', cantDownloadMessage);\r\n    });\r\n\r\n    const canDeleteMessage = this.managers.appMessagesManager.canDeleteMessage(message);\r\n    [this.buttons.delete, this.btnMenuDelete.element].forEach((button) => {\r\n      button.classList.toggle('hide', !canDeleteMessage);\r\n    });\r\n\r\n    this.setCaption(message);\r\n    const promise = super._openMedia(media, message.date, fromId, fromRight, target, reverse, prevTargets, nextTargets, message/* , needLoadMore */);\r\n    this.target.mid = mid;\r\n    this.target.peerId = message.peerId;\r\n\r\n    return promise;\r\n  }\r\n\r\n  public static isMediaCompatibleForDocumentViewer(media: MyPhoto | MyDocument) {\r\n    return media._ === 'photo' || MEDIA_MIME_TYPES_SUPPORTED.has(media.mime_type);\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Photo } from \"../layer\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport ListLoader, { ListLoaderOptions } from \"./listLoader\";\r\n\r\nexport default class AvatarListLoader<Item extends {photoId: Photo.photo['id']}> extends ListLoader<Item, any> {\r\n  private peerId: PeerId;\r\n  private managers: AppManagers;\r\n\r\n  constructor(options: Omit<ListLoaderOptions<Item, any>, 'loadMore'> & {peerId: PeerId, managers: AppManagers}) {\r\n    super({\r\n      ...options,\r\n      loadMore: (anchor, older, loadCount) => {\r\n        if(this.peerId.isAnyChat() || !older) return Promise.resolve({count: 0, items: []}); // !  ,    ,    .\r\n\r\n        const maxId = anchor?.photoId;\r\n        return this.managers.appPhotosManager.getUserPhotos(this.peerId, maxId, loadCount).then((value) => {\r\n          const items = value.photos.map((photoId) => {\r\n            return {element: null as HTMLElement, photoId} as any;\r\n          });\r\n\r\n          return {count: value.count, items};\r\n        });\r\n      }\r\n    });\r\n\r\n    this.loadedAllUp = true;\r\n    this.peerId = options.peerId;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport AvatarListLoader from \"../helpers/avatarListLoader\";\r\nimport { Photo } from \"../layer\";\r\nimport appDownloadManager from \"../lib/appManagers/appDownloadManager\";\r\nimport appImManager from \"../lib/appManagers/appImManager\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport AppMediaViewerBase from \"./appMediaViewerBase\";\r\n\r\ntype AppMediaViewerAvatarTargetType = {element: HTMLElement, photoId: Photo.photo['id']};\r\nexport default class AppMediaViewerAvatar extends AppMediaViewerBase<'', 'delete', AppMediaViewerAvatarTargetType> {\r\n  public peerId: PeerId;\r\n\r\n  constructor(peerId: PeerId) {\r\n    super(new AvatarListLoader({peerId, managers: rootScope.managers}), [/* 'delete' */]);\r\n\r\n    this.peerId = peerId;\r\n\r\n    this.setBtnMenuToggle([{\r\n      icon: 'download',\r\n      text: 'MediaViewer.Context.Download',\r\n      onClick: this.onDownloadClick\r\n    }/* , {\r\n      icon: 'delete danger btn-disabled',\r\n      text: 'Delete',\r\n      onClick: () => {}\r\n    } */]);\r\n\r\n    // * constructing html end\r\n    \r\n    this.setListeners();\r\n  }\r\n\r\n  onPrevClick = (target: AppMediaViewerAvatarTargetType) => {\r\n    this.openMedia(target.photoId, target.element, -1);\r\n  };\r\n\r\n  onNextClick = (target: AppMediaViewerAvatarTargetType) => {\r\n    this.openMedia(target.photoId, target.element, 1);\r\n  };\r\n\r\n  onDownloadClick = async() => {\r\n    appDownloadManager.downloadToDisc({\r\n      media: await this.managers.appPhotosManager.getPhoto(this.target.photoId), \r\n      queueId: appImManager.chat.bubbles.lazyLoadQueue.queueId\r\n    });\r\n  };\r\n\r\n  public async openMedia(photoId: Photo.photo['id'], target?: HTMLElement, fromRight = 0, prevTargets?: AppMediaViewerAvatarTargetType[], nextTargets?: AppMediaViewerAvatarTargetType[]) {\r\n    if(this.setMoverPromise) return this.setMoverPromise;\r\n\r\n    const photo = await this.managers.appPhotosManager.getPhoto(photoId);\r\n    const ret = super._openMedia(photo, photo.date, this.peerId, fromRight, target, false, prevTargets, nextTargets);\r\n    this.target.photoId = photo.id;\r\n\r\n    return ret;\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { Message, Photo } from \"../layer\";\r\nimport type LazyLoadQueue from \"./lazyLoadQueue\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport AppMediaViewer from \"./appMediaViewer\";\r\nimport AppMediaViewerAvatar from \"./appMediaViewerAvatar\";\r\nimport isObject from \"../helpers/object/isObject\";\r\nimport { ArgumentTypes } from \"../types\";\r\nimport putPhoto from \"./putPhoto\";\r\nimport { recordPromise } from \"../helpers/recordPromise\";\r\n\r\nconst onAvatarUpdate = (peerId: PeerId) => {\r\n  (Array.from(document.querySelectorAll('avatar-element[data-peer-id=\"' + peerId + '\"]')) as AvatarElement[]).forEach((elem) => {\r\n    //console.log('updating avatar:', elem);\r\n    elem.update();\r\n  });\r\n};\r\n\r\nrootScope.addEventListener('avatar_update', onAvatarUpdate);\r\nrootScope.addEventListener('peer_title_edit', async(peerId) => {\r\n  if(!(await rootScope.managers.appAvatarsManager.isAvatarCached(peerId))) {\r\n    onAvatarUpdate(peerId);\r\n  }\r\n});\r\n\r\nexport async function openAvatarViewer(\r\n  target: HTMLElement, \r\n  peerId: PeerId, \r\n  middleware: () => boolean, \r\n  message?: any, \r\n  prevTargets?: {element: HTMLElement, item: Photo.photo['id'] | Message.messageService}[], \r\n  nextTargets?: typeof prevTargets\r\n) {\r\n  let photo = await rootScope.managers.appProfileManager.getFullPhoto(peerId);\r\n  if(!middleware() || !photo) {\r\n    return;\r\n  }\r\n\r\n  const getTarget = () => {\r\n    const good = Array.from(target.querySelectorAll('img')).find((img) => !img.classList.contains('emoji'));\r\n    return good ? target : null;\r\n  };\r\n\r\n  if(peerId.isAnyChat()) {\r\n    const hadMessage = !!message;\r\n    const inputFilter = 'inputMessagesFilterChatPhotos';\r\n    if(!message) {\r\n      message = await rootScope.managers.appMessagesManager.getSearch({\r\n        peerId, \r\n        inputFilter: {_: inputFilter}, \r\n        maxId: 0, \r\n        limit: 1 \r\n      }).then((value) => {\r\n        //console.log(lol);\r\n        // ! by descend\r\n        return value.history[0];\r\n      });\r\n\r\n      if(!middleware()) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    if(message) {\r\n      // !   ,  (  )\r\n      const messagePhoto = message.action.photo;\r\n      if(messagePhoto.id !== photo.id) {\r\n        if(!hadMessage) {\r\n          message = rootScope.managers.appMessagesManager.generateFakeAvatarMessage(peerId, photo);\r\n        } else {\r\n          \r\n        }\r\n      }\r\n\r\n      const f = (arr: typeof prevTargets) => arr.map((el) => ({\r\n        element: el.element,\r\n        mid: (el.item as Message.messageService).mid,\r\n        peerId: (el.item as Message.messageService).peerId\r\n      }));\r\n\r\n      new AppMediaViewer()\r\n      .setSearchContext({\r\n        peerId,\r\n        inputFilter: {_: inputFilter},\r\n      })\r\n      .openMedia(message, getTarget(), undefined, undefined, prevTargets ? f(prevTargets) : undefined, nextTargets ? f(nextTargets) : undefined);\r\n\r\n      return;\r\n    }\r\n  }\r\n\r\n  if(photo) {\r\n    if(!isObject(message) && message) {\r\n      photo = await rootScope.managers.appPhotosManager.getPhoto(message);\r\n    }\r\n    \r\n    const f = (arr: typeof prevTargets) => arr.map((el) => ({\r\n      element: el.element,\r\n      photoId: el.item as string\r\n    }));\r\n\r\n    new AppMediaViewerAvatar(peerId).openMedia(\r\n      photo.id, \r\n      getTarget(), \r\n      undefined, \r\n      prevTargets ? f(prevTargets) : undefined, \r\n      nextTargets ? f(nextTargets) : undefined\r\n    );\r\n  }\r\n}\r\n\r\nconst believeMe: Map<PeerId, Set<AvatarElement>> = new Map();\r\nconst seen: Set<PeerId> = new Set();\r\n\r\nexport default class AvatarElement extends HTMLElement {\r\n  public peerId: PeerId;\r\n  public isDialog: boolean;\r\n  public peerTitle: string;\r\n  public loadPromises: Promise<any>[];\r\n  public lazyLoadQueue: LazyLoadQueue;\r\n  public isBig: boolean;\r\n  private addedToQueue = false;\r\n\r\n  disconnectedCallback() {\r\n    //         \r\n    // (   ,    /)\r\n    const set = believeMe.get(this.peerId);\r\n    if(set && set.has(this)) {\r\n      set.delete(this);\r\n      if(!set.size) {\r\n        believeMe.delete(this.peerId);\r\n      }\r\n    }\r\n\r\n    if(this.lazyLoadQueue) {\r\n      this.lazyLoadQueue.unobserve(this);\r\n    }\r\n  }\r\n\r\n  public attachClickEvent() {\r\n    let loading = false;\r\n    attachClickEvent(this, async(e) => {\r\n      cancelEvent(e);\r\n      if(loading) return;\r\n      //console.log('avatar clicked');\r\n      const peerId = this.peerId;\r\n      loading = true;\r\n      await openAvatarViewer(this, this.peerId, () => this.peerId === peerId);\r\n      loading = false;\r\n    });\r\n  }\r\n\r\n  public updateOptions(options: Partial<ArgumentTypes<AvatarElement['updateWithOptions']>[0]>) {\r\n    for(let i in options) {\r\n      // @ts-ignore\r\n      this[i] = options[i];\r\n    }\r\n  }\r\n\r\n  public updateWithOptions(options: {\r\n    peerId: PeerId,\r\n    isDialog?: boolean,\r\n    isBig?: boolean,\r\n    peerTitle?: string,\r\n    lazyLoadQueue?: LazyLoadQueue,\r\n    loadPromises?: Promise<any>[]\r\n  }) {\r\n    const wasPeerId = this.peerId;\r\n    this.updateOptions(options);\r\n    const newPeerId = this.peerId;\r\n\r\n    if(wasPeerId === newPeerId) {\r\n      return;\r\n    }\r\n\r\n    this.peerId = /* rootScope.managers.appPeersManager.getPeerMigratedTo(newPeerId) ||  */newPeerId;\r\n    this.dataset.peerId = '' + newPeerId;\r\n\r\n    if(wasPeerId) {\r\n      const set = believeMe.get(wasPeerId);\r\n      if(set) {\r\n        set.delete(this);\r\n        if(!set.size) {\r\n          believeMe.delete(wasPeerId);\r\n        }\r\n      }\r\n    }\r\n\r\n    return this.update();\r\n  }\r\n\r\n  private r(onlyThumb = false) {\r\n    const promise = putPhoto(this, this.peerId, this.isDialog, this.peerTitle, onlyThumb, this.isBig);\r\n    // recordPromise(promise, 'avatar putPhoto-' + this.peerId);\r\n\r\n    if(this.loadPromises) {\r\n      this.loadPromises.push(promise);\r\n\r\n      promise.finally(() => {\r\n        this.loadPromises = undefined;\r\n      });\r\n    }\r\n\r\n    return promise;\r\n  }\r\n\r\n  public update() {\r\n    if(this.lazyLoadQueue) {\r\n      if(!seen.has(this.peerId)) {\r\n        if(this.addedToQueue) return;\r\n        this.addedToQueue = true;\r\n        \r\n        let set = believeMe.get(this.peerId);\r\n        if(!set) {\r\n          set = new Set();\r\n          believeMe.set(this.peerId, set);\r\n        }\r\n  \r\n        set.add(this);\r\n\r\n        this.lazyLoadQueue.push({\r\n          div: this, \r\n          load: () => {\r\n            seen.add(this.peerId);\r\n            return this.update();\r\n          }\r\n        });\r\n\r\n        return this.r(true);\r\n      } else if(this.addedToQueue) {\r\n        this.lazyLoadQueue.unobserve(this);\r\n      }\r\n    } \r\n    \r\n    seen.add(this.peerId);\r\n    \r\n    const promise = this.r();\r\n\r\n    if(this.addedToQueue) {\r\n      promise.finally(() => {\r\n        this.addedToQueue = false;\r\n      });\r\n    }\r\n\r\n    const set = believeMe.get(this.peerId);\r\n    if(set) {\r\n      set.delete(this);\r\n      const arr = Array.from(set);\r\n      believeMe.delete(this.peerId);\r\n      \r\n\r\n      for(let i = 0, length = arr.length; i < length; ++i) {\r\n        arr[i].update();\r\n      }\r\n    }\r\n\r\n    return promise;\r\n  }\r\n}\r\n\r\ncustomElements.define('avatar-element', AvatarElement);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport appDialogsManager, { DIALOG_LIST_ELEMENT_TAG } from \"../lib/appManagers/appDialogsManager\";\r\nimport type { Dialog } from \"../lib/appManagers/appMessagesManager\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport ButtonMenu, { ButtonMenuItemOptions } from \"./buttonMenu\";\r\nimport PopupDeleteDialog from \"./popups/deleteDialog\";\r\nimport { i18n } from \"../lib/langPack\";\r\nimport findUpTag from \"../helpers/dom/findUpTag\";\r\nimport PopupPeer from \"./popups/peer\";\r\nimport AppChatFoldersTab from \"./sidebarLeft/tabs/chatFolders\";\r\nimport appSidebarLeft from \"./sidebarLeft\";\r\nimport { toastNew } from \"./toast\";\r\nimport PopupMute from \"./popups/mute\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport positionMenu from \"../helpers/positionMenu\";\r\nimport contextMenuController from \"../helpers/contextMenuController\";\r\n\r\nexport default class DialogsContextMenu {\r\n  private element: HTMLElement;\r\n  private buttons: (ButtonMenuItemOptions & {verify: () => boolean | Promise<boolean>})[];\r\n\r\n  private selectedId: PeerId;\r\n  private filterId: number;\r\n  private dialog: Dialog;\r\n\r\n  constructor(private managers: AppManagers) {\r\n\r\n  }\r\n\r\n  private init() {\r\n    this.buttons = [{\r\n      icon: 'unread',\r\n      text: 'MarkAsUnread',\r\n      onClick: this.onUnreadClick,\r\n      verify: async() => !(await this.managers.appMessagesManager.isDialogUnread(this.dialog))\r\n    }, {\r\n      icon: 'readchats',\r\n      text: 'MarkAsRead',\r\n      onClick: this.onUnreadClick,\r\n      verify: () => this.managers.appMessagesManager.isDialogUnread(this.dialog)\r\n    }, {\r\n      icon: 'pin',\r\n      text: 'ChatList.Context.Pin',\r\n      onClick: this.onPinClick,\r\n      verify: async() => {\r\n        const isPinned = this.filterId > 1 ? \r\n          (await this.managers.appMessagesManager.getFilter(this.filterId)).pinnedPeerIds.includes(this.dialog.peerId) : \r\n          !!this.dialog.pFlags?.pinned;\r\n        return !isPinned;\r\n      }\r\n    }, {\r\n      icon: 'unpin',\r\n      text: 'ChatList.Context.Unpin',\r\n      onClick: this.onPinClick,\r\n      verify: async() => {\r\n        const isPinned = this.filterId > 1 ? \r\n          (await this.managers.appMessagesManager.getFilter(this.filterId)).pinnedPeerIds.includes(this.dialog.peerId) : \r\n          !!this.dialog.pFlags?.pinned;\r\n        return isPinned;\r\n      }\r\n    }, {\r\n      icon: 'mute',\r\n      text: 'ChatList.Context.Mute',\r\n      onClick: this.onMuteClick,\r\n      verify: async() => {\r\n        return this.selectedId !== rootScope.myId && !(await this.managers.appNotificationsManager.isPeerLocalMuted(this.dialog.peerId)); \r\n      }\r\n    }, {\r\n      icon: 'unmute',\r\n      text: 'ChatList.Context.Unmute',\r\n      onClick: this.onUnmuteClick,\r\n      verify: async() => {\r\n        return this.selectedId !== rootScope.myId && (await this.managers.appNotificationsManager.isPeerLocalMuted(this.dialog.peerId)); \r\n      }\r\n    }, {\r\n      icon: 'archive',\r\n      text: 'Archive',\r\n      onClick: this.onArchiveClick,\r\n      verify: () => this.filterId === 0 && this.selectedId !== rootScope.myId\r\n    }, {\r\n      icon: 'unarchive',\r\n      text: 'Unarchive',\r\n      onClick: this.onArchiveClick,\r\n      verify: () => this.filterId === 1 && this.selectedId !== rootScope.myId\r\n    }, {\r\n      icon: 'delete danger',\r\n      text: 'Delete',\r\n      onClick: this.onDeleteClick,\r\n      verify: () => true\r\n    }];\r\n\r\n    this.element = ButtonMenu(this.buttons);\r\n    this.element.id = 'dialogs-contextmenu';\r\n    this.element.classList.add('contextmenu');\r\n    document.getElementById('page-chats').append(this.element);\r\n  }\r\n\r\n  private onArchiveClick = async() => {\r\n    const dialog = await this.managers.appMessagesManager.getDialogOnly(this.selectedId);\r\n    if(dialog) {\r\n      this.managers.appMessagesManager.editPeerFolders([dialog.peerId], +!dialog.folder_id);\r\n    }\r\n  };\r\n\r\n  private onPinClick = () => {\r\n    this.managers.appMessagesManager.toggleDialogPin(this.selectedId, this.filterId).catch(async(err) => {\r\n      if(err.type === 'PINNED_DIALOGS_TOO_MUCH') {\r\n        if(this.filterId >= 1) {\r\n          toastNew({langPackKey: 'PinFolderLimitReached'});\r\n        } else {\r\n          const config = await this.managers.apiManager.getConfig();\r\n          new PopupPeer('pinned-dialogs-too-much', {\r\n            buttons: [{\r\n              langKey: 'OK',\r\n              isCancel: true\r\n            }, {\r\n              langKey: 'FiltersSetupPinAlert',\r\n              callback: () => {\r\n                appSidebarLeft.createTab(AppChatFoldersTab);\r\n              }\r\n            }],\r\n            descriptionLangKey: 'PinToTopLimitReached2',\r\n            descriptionLangArgs: [i18n('Chats', [config.pinned_dialogs_count_max])]\r\n          }).show();\r\n        }\r\n      }\r\n    });\r\n  };\r\n\r\n  private onUnmuteClick = () => {\r\n    this.managers.appMessagesManager.togglePeerMute(this.selectedId, false);\r\n  };\r\n  \r\n  private onMuteClick = () => {\r\n    new PopupMute(this.selectedId);\r\n  };\r\n\r\n  private onUnreadClick = async() => {\r\n    const selectedId = this.selectedId;\r\n    const dialog = await this.managers.appMessagesManager.getDialogOnly(selectedId);\r\n    if(!dialog) return;\r\n\r\n    if(dialog.unread_count) {\r\n      this.managers.appMessagesManager.readHistory(selectedId, dialog.top_message);\r\n      this.managers.appMessagesManager.markDialogUnread(selectedId, true);\r\n    } else {\r\n      this.managers.appMessagesManager.markDialogUnread(selectedId);\r\n    }\r\n  };\r\n\r\n  private onDeleteClick = () => {\r\n    new PopupDeleteDialog(this.selectedId/* , 'delete' */);\r\n  };\r\n\r\n  onContextMenu = (e: MouseEvent | Touch) => {\r\n    if(this.init) {\r\n      this.init();\r\n      this.init = null;\r\n    }\r\n\r\n    let li: HTMLElement = null;\r\n    \r\n    try {\r\n      li = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG);\r\n    } catch(e) {}\r\n    \r\n    if(!li) return;\r\n\r\n    if(e instanceof MouseEvent) e.preventDefault();\r\n    if(this.element.classList.contains('active')) {\r\n      return false;\r\n    }\r\n    if(e instanceof MouseEvent) e.cancelBubble = true;\r\n\r\n    const r = async() => {\r\n      this.filterId = appDialogsManager.filterId;\r\n      this.selectedId = li.dataset.peerId.toPeerId();\r\n      this.dialog = await this.managers.appMessagesManager.getDialogOnly(this.selectedId);\r\n  \r\n      await Promise.all(this.buttons.map(async(button) => {\r\n        const good = await button.verify();\r\n  \r\n        button.element.classList.toggle('hide', !good);\r\n      }));\r\n  \r\n      // delete button\r\n      this.buttons[this.buttons.length - 1].element.lastChild.replaceWith(i18n(await this.managers.appPeersManager.getDeleteButtonText(this.selectedId)));\r\n  \r\n      li.classList.add('menu-open');\r\n      positionMenu(e, this.element);\r\n      contextMenuController.openBtnMenu(this.element, () => {\r\n        li.classList.remove('menu-open');\r\n        this.selectedId = this.dialog = this.filterId = undefined;\r\n      });\r\n    };\r\n\r\n    r();\r\n  };\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { Message } from \"../layer\";\r\n/* import findUpClassName from \"../helpers/dom/findUpClassName\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport Transition from \"./transition\"; */\r\n\r\nexport enum SENDING_STATUS {\r\n  Error = -1,\r\n  Pending,\r\n  Sent,\r\n  Read\r\n}\r\n\r\nexport function getSendingStatus(message: Message.message | Message.messageService) {\r\n  return message.pFlags.is_outgoing ? \r\n    SENDING_STATUS.Pending : (\r\n      message.pFlags.unread ? \r\n      SENDING_STATUS.Sent : \r\n      SENDING_STATUS.Read\r\n    );\r\n}\r\n\r\nexport function setSendingStatus(\r\n  container: HTMLElement, \r\n  message?: Message.message | Message.messageService, \r\n  disableAnimationIfRippleFound?: boolean\r\n) {\r\n  let className: 'check' | 'checks' | 'sending';\r\n  if(message?.pFlags.out) {\r\n    if(message.pFlags.is_outgoing) {\r\n      className = 'sending';\r\n    } else if(message.pFlags.unread) {\r\n      className = 'check';\r\n    } else {\r\n      className = 'checks';\r\n    }\r\n  }\r\n\r\n  if(!className) {\r\n    container.textContent = '';\r\n    return;\r\n  }\r\n  \r\n  const iconClassName = 'tgico-' + className;\r\n  const lastElement = container.lastElementChild as HTMLElement;\r\n  if(lastElement && lastElement.classList.contains(iconClassName)) {\r\n    return;\r\n  }\r\n  \r\n  const element = document.createElement('i');\r\n  element.classList.add('sending-status-icon', /* 'transition-item', */ iconClassName);\r\n  container.append(element);\r\n\r\n  if(lastElement) {\r\n    lastElement.remove();\r\n  }\r\n\r\n  /* if(!lastElement) {\r\n    element.classList.add('active');\r\n    return;\r\n  }\r\n\r\n  const select = Transition(container, undefined, 350, () => {\r\n    lastElement.remove();\r\n  }, false, true, false);\r\n\r\n  let animate = rootScope.settings.animationsEnabled && className !== 'sending' && !lastElement.classList.contains('tgico-sending');\r\n  if(disableAnimationIfRippleFound && animate) {\r\n    const parent = findUpClassName(container, 'rp');\r\n    if(parent.querySelector('.c-ripple__circle') || parent.matches(':hover')) {\r\n      animate = false;\r\n    }\r\n  }\r\n\r\n  select(element, animate, lastElement); */\r\n\r\n  /* SetTransition(lastElement, 'is-visible', false, 350, () => {\r\n    // lastElement.remove();\r\n  }, 2);\r\n  SetTransition(element, 'is-visible', true, 350, undefined, 2); */\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport App from \"../config/app\";\r\nimport DEBUG from \"../config/debug\";\r\nimport replaceContent from \"../helpers/dom/replaceContent\";\r\nimport { LangPackKey, i18n } from \"../lib/langPack\";\r\nimport { logger } from \"../lib/logger\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport Button from \"./button\";\r\nimport ProgressivePreloader from \"./preloader\";\r\nimport SetTransition from \"./singleTransition\";\r\nimport sessionStorage from '../lib/sessionStorage';\r\nimport { ConnectionStatus } from \"../lib/mtproto/connectionStatus\";\r\nimport cancelEvent from \"../helpers/dom/cancelEvent\";\r\nimport { attachClickEvent } from \"../helpers/dom/clickEvent\";\r\nimport { AppManagers } from \"../lib/appManagers/managers\";\r\nimport singleInstance from \"../lib/mtproto/singleInstance\";\r\n\r\nexport default class ConnectionStatusComponent {\r\n  public static CHANGE_STATE_DELAY = 1000;\r\n\r\n  private statusContainer: HTMLElement;\r\n  private statusEl: HTMLElement;\r\n  private statusPreloader: ProgressivePreloader;\r\n\r\n  private currentLangPackKey: LangPackKey;\r\n\r\n  private hadConnect = false;\r\n  private retryAt: number;\r\n  private connecting = false;\r\n  private timedOut = false;\r\n  private updating = false;\r\n\r\n  private log: ReturnType<typeof logger>;\r\n\r\n  private setFirstConnectionTimeout: number;\r\n  private setStateTimeout: number;\r\n\r\n  constructor(private managers: AppManagers, chatsContainer: HTMLElement) {\r\n    this.log = logger('CS', undefined, undefined);\r\n  \r\n    this.statusContainer = document.createElement('div');\r\n    this.statusContainer.classList.add('connection-status'/* , 'hide' */);\r\n\r\n    this.statusEl = Button('btn-primary bg-warning connection-status-button', {noRipple: true});\r\n    this.statusPreloader = new ProgressivePreloader({cancelable: false});\r\n    this.statusPreloader.constructContainer({color: 'transparent', bold: true});\r\n    this.statusContainer.append(this.statusEl);\r\n\r\n    chatsContainer.prepend(this.statusContainer);\r\n\r\n    rootScope.addEventListener('connection_status_change', (status) => {\r\n      console.log(status);\r\n\r\n      this.setConnectionStatus();\r\n    });\r\n\r\n    rootScope.addEventListener('state_synchronizing', (channelId) => {\r\n      if(!channelId) {\r\n        this.updating = true;\r\n        DEBUG && this.log('updating', this.updating);\r\n        this.setState();\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('state_synchronized', (channelId) => {\r\n      DEBUG && this.log('state_synchronized', channelId);\r\n      if(!channelId) {\r\n        this.updating = false;\r\n        DEBUG && this.log('updating', this.updating);\r\n        this.setState();\r\n      }\r\n    });\r\n\r\n    this.setFirstConnectionTimeout = window.setTimeout(this.setConnectionStatus, ConnectionStatusComponent.CHANGE_STATE_DELAY + 1e3);\r\n\r\n    /* let bool = true;\r\n    document.addEventListener('dblclick', () => {\r\n      const dcId = 2;\r\n      rootScope.dispatchEvent('connection_status_change', {\r\n        dcId: dcId,\r\n        isFileDownload: false,\r\n        isFileNetworker: false,\r\n        isFileUpload: false,\r\n        name: \"NET-\" + dcId,\r\n        status: bool ? (bool = false, ConnectionStatus.Closed) : (bool = true, ConnectionStatus.Connected),\r\n        _: \"networkerStatus\"\r\n      });\r\n    }); */\r\n  }\r\n\r\n  private setConnectionStatus = () => {\r\n    Promise.all([\r\n      sessionStorage.get('dc'),\r\n      rootScope.managers.rootScope.getConnectionStatus()\r\n    ]).then(([baseDcId, connectionStatus]) => {\r\n      if(!baseDcId) {\r\n        baseDcId = App.baseDcId;\r\n      }\r\n      \r\n      if(this.setFirstConnectionTimeout) {\r\n        clearTimeout(this.setFirstConnectionTimeout);\r\n        this.setFirstConnectionTimeout = 0;\r\n      }\r\n\r\n      const status = connectionStatus['NET-' + baseDcId];\r\n      const online = status && status.status === ConnectionStatus.Connected;\r\n\r\n      if(this.connecting && online) {\r\n        this.managers.apiUpdatesManager.forceGetDifference();\r\n      }\r\n\r\n      if(online && !this.hadConnect) {\r\n        this.hadConnect = true;\r\n      }\r\n      \r\n      this.timedOut = status && status.status === ConnectionStatus.TimedOut;\r\n      this.connecting = !online;\r\n      this.retryAt = status && status.retryAt;\r\n      DEBUG && this.log('connecting', this.connecting);\r\n      this.setState();\r\n    });\r\n  };\r\n\r\n  private setStatusText = (langPackKey: LangPackKey, args?: any[]) => {\r\n    if(this.currentLangPackKey === langPackKey) return;\r\n    this.currentLangPackKey = langPackKey;\r\n    replaceContent(this.statusEl, i18n(langPackKey, args));\r\n    this.statusPreloader.attach(this.statusEl);\r\n  };\r\n\r\n  private getA(langPackKey: LangPackKey, callback: () => void) {\r\n    const a = document.createElement('a');\r\n    a.classList.add('force-reconnect');\r\n    a.append(i18n(langPackKey));\r\n    attachClickEvent(a, (e) => {\r\n      cancelEvent(e);\r\n      callback();\r\n    });\r\n\r\n    return a;\r\n  }\r\n\r\n  private setState = () => {\r\n    if(singleInstance.deactivatedReason) {\r\n      return;\r\n    }\r\n\r\n    const timeout = ConnectionStatusComponent.CHANGE_STATE_DELAY;\r\n    if(this.connecting) {\r\n      if(this.timedOut) {\r\n        const a = this.getA('ConnectionStatus.ForceReconnect', () => this.managers.networkerFactory.forceReconnect());\r\n        this.setStatusText('ConnectionStatus.TimedOut', [a]);\r\n      } else if(this.hadConnect) {\r\n        if(this.retryAt !== undefined) {\r\n          const timerSpan = document.createElement('span');\r\n          const retryAt = this.retryAt;\r\n          const setTime = () => {\r\n            const now = Date.now();\r\n            timerSpan.innerText = '' + Math.round((retryAt - now) / 1000);\r\n            if(now > retryAt) {\r\n              clearInterval(interval);\r\n            }\r\n          };\r\n          const interval = setInterval(setTime, 1e3);\r\n          setTime();\r\n  \r\n          const a = this.getA('ConnectionStatus.Reconnect', () => this.managers.networkerFactory.forceReconnectTimeout());\r\n          this.setStatusText('ConnectionStatus.ReconnectIn', [timerSpan, a]);\r\n        } else {\r\n          this.setStatusText('ConnectionStatus.Reconnecting');\r\n        }\r\n      } else {\r\n        this.setStatusText('ConnectionStatus.Waiting');\r\n      }\r\n    } else if(this.updating) {\r\n      this.setStatusText('Updating');\r\n    }\r\n\r\n    DEBUG && this.log('setState', this.connecting || this.updating);\r\n    window.requestAnimationFrame(() => {\r\n      if(this.setStateTimeout) clearTimeout(this.setStateTimeout);\r\n\r\n      const cb = () => {\r\n        SetTransition(this.statusContainer, 'is-shown', this.connecting || this.updating, 200);\r\n        this.setStateTimeout = 0;\r\n        DEBUG && this.log('setState: isShown:', this.connecting || this.updating);\r\n      };\r\n\r\n      this.setStateTimeout = window.setTimeout(cb, timeout);\r\n      //cb();\r\n      /* if(timeout) this.setStateTimeout = window.setTimeout(cb, timeout);\r\n      else cb(); */\r\n    });\r\n  };\r\n}\r\n","// https://spicyyoghurt.com/tools/easing-functions\r\nexport default function easeInOutSine(t: number, b: number, c: number, d: number) {\r\n  return t >= d ? b + c : -c / 2 * (Math.cos(Math.PI * t / d) - 1) + b;\r\n}\r\n","export default function roundRect(\r\n  ctx: CanvasRenderingContext2D, \r\n  x: number, \r\n  y: number, \r\n  width: number, \r\n  height: number, \r\n  radius: {[k in 'tl' | 'tr' | 'br' | 'bl']?: number} | number, \r\n  fill?: boolean, \r\n  stroke?: boolean\r\n) {\r\n  const dpr = ctx.canvas.dpr;\r\n  if(dpr) {\r\n    x *= dpr;\r\n    y *= dpr;\r\n    width *= dpr;\r\n    height *= dpr;\r\n  }\r\n\r\n  if(typeof(radius) === 'number') {\r\n    if(dpr) radius *= dpr;\r\n    radius = {tl: radius, tr: radius, br: radius, bl: radius};\r\n  } else {\r\n    const defaultRadius = {tl: 0, tr: 0, br: 0, bl: 0};\r\n    for(const side in defaultRadius) {\r\n      // @ts-ignore\r\n      radius[side] = radius[side] ? (dpr ? radius[side] * dpr : radius[side]) : defaultRadius[side];\r\n    }\r\n  }\r\n\r\n  ctx.beginPath();\r\n  ctx.moveTo(x + radius.tl, y);\r\n  ctx.lineTo(x + width - radius.tr, y);\r\n  ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);\r\n  ctx.lineTo(x + width, y + height - radius.br);\r\n  ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);\r\n  ctx.lineTo(x + radius.bl, y + height);\r\n  ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);\r\n  ctx.lineTo(x, y + radius.tl);\r\n  ctx.quadraticCurveTo(x, y, x + radius.tl, y);\r\n  ctx.closePath();\r\n\r\n  if(fill) {\r\n    ctx.fill();\r\n  }\r\n\r\n  if(stroke) {\r\n    ctx.stroke();\r\n  }\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport { animate } from \"../helpers/animation\";\r\nimport customProperties from \"../helpers/dom/customProperties\";\r\nimport easeInOutSine from \"../helpers/easing/easeInOutSine\";\r\nimport mediaSizes from \"../helpers/mediaSizes\";\r\nimport roundRect from \"../helpers/canvas/roundRect\";\r\n\r\nconst DPR = window.devicePixelRatio;\r\nconst SIZE = 20 * DPR;\r\nconst MARGIN = 2.5 * DPR;\r\nconst WIDTH = 2 * DPR;\r\nconst RADIUS = 1 * DPR;\r\nconst LENGTH = 3;\r\n\r\nconst MIN_HEIGHT = 4;\r\nconst MAX_HEIGHT = 12;\r\nconst DURATION = 1000;\r\n\r\nexport default function groupCallActiveIcon(isActive = false) {\r\n  const canvas = document.createElement('canvas');\r\n  canvas.width = canvas.height = SIZE;\r\n  const context = canvas.getContext('2d');\r\n  \r\n  const TOTAL_WIDTH = LENGTH * WIDTH + (LENGTH - 1) * MARGIN;\r\n  const START_X = (SIZE - TOTAL_WIDTH) / 2;\r\n  \r\n  const startTime = Date.now();\r\n  let wasMounted = false;\r\n  // let hadRound = false;\r\n  const renderFrame = () => {\r\n    if(!canvas.isConnected) {\r\n      if(wasMounted) {\r\n        return false;\r\n      }\r\n    } else if(!wasMounted) {\r\n      wasMounted = canvas.isConnected;\r\n    }\r\n    \r\n    const time = Date.now();\r\n    // if(((time - startTime) / DURATION) >= 1) {\r\n    //   hadRound = true;\r\n    // }\r\n    \r\n    const progress = easeInOutSine((time - startTime) % DURATION, 0, 1, DURATION);\r\n    \r\n    context.clearRect(0, 0, SIZE, SIZE);\r\n    context.fillStyle = isActive && !mediaSizes.isMobile ? customProperties.getProperty('primary-color') : '#fff';\r\n\r\n    for(let i = 0; i < LENGTH; ++i) {\r\n      const x = START_X + (i * WIDTH) + (i * MARGIN);\r\n\r\n      let itemProgress: number;\r\n      if(progress >= .5) {\r\n        itemProgress = i % 2 ? 2 - progress * 2 : (progress - .5) * 2;\r\n      } else {\r\n        itemProgress = i % 2 ? progress * 2 : 1 - progress * 2;\r\n      }\r\n\r\n      let height = MIN_HEIGHT + (itemProgress * (MAX_HEIGHT - MIN_HEIGHT));\r\n      /* if(!hadRound && i === 1) {\r\n        console.log('call status animation', itemProgress, height, progress, progress >= .5);\r\n      } */\r\n      \r\n      height *= DPR;\r\n      const y = (SIZE - height) / 2;\r\n      \r\n      roundRect(context, x, y, WIDTH, height, RADIUS, true);\r\n    }\r\n\r\n    return true;\r\n  };\r\n\r\n  return {\r\n    canvas,\r\n    startAnimation: () => {\r\n      animate(renderFrame);\r\n      renderFrame();\r\n    },\r\n    setActive: (active: boolean) => {\r\n      isActive = active;\r\n      renderFrame();\r\n    }\r\n  };\r\n}\r\n","import customProperties from \"../dom/customProperties\";\r\nimport clamp from \"../number/clamp\";\r\n\r\nexport default class Shimmer {\r\n  private canvas: HTMLCanvasElement;\r\n  private ctx: CanvasRenderingContext2D;\r\n  private font = \"30pt Helvetica\";\r\n  private currTime = Date.now();\r\n  private diffTime = 0;\r\n  private spread = 0;\r\n  private paused = false;\r\n  private pausedTime = 0;\r\n  private pauseInterval = 850;\r\n  private lightSource = 0;\r\n  private inc = 0.032;\r\n  private lightSpread = 0.55;\r\n  private animations = ['slide','slide','slide','slide'];\r\n  private currentAnimationIndex = 0;\r\n  private text: string;\r\n  private fillStyle: CanvasRenderingContext2D['fillStyle'];\r\n  \r\n  private keepTime() {\r\n    this.diffTime = Date.now() - this.currTime;\r\n    this.currTime = Date.now();\r\n  }\r\n  \r\n  private cycleAnimation() {\r\n    ++this.currentAnimationIndex;\r\n    if(this.currentAnimationIndex >= this.animations.length) {\r\n      this.currentAnimationIndex = 0;\r\n    }\r\n  }\r\n  \r\n  private animate() {\r\n    const currentAnimation = this.animations[this.currentAnimationIndex];\r\n    if(currentAnimation === 'glow') {\r\n      return this.animateGlow(); // return glow style\r\n    } else if(currentAnimation === 'slide') {\r\n      return this.animateSlide(); // return slide gradient\r\n    } else {\r\n      console.log(\"unknown animation type: \" + String(currentAnimation));\r\n    }\r\n  }\r\n  \r\n  private animateGlow() {\r\n    var glowEnd = 255, \r\n      rgbStart = 68,\r\n      r = rgbStart,\r\n      g = r,\r\n      b = r,\r\n      increment = 10,\r\n      interval = 800;\r\n\r\n    return () => {\r\n      var smartInc = increment * (this.diffTime / (1000 / 60));\r\n      if(this.paused) {\r\n        if((Date.now() - this.pausedTime) > interval){\r\n          r = rgbStart;\r\n          this.cycleAnimation()\r\n          this.paused = false;\r\n        }\r\n      } else {\r\n        r = parseInt('' + (r + smartInc));\r\n        if(r >= glowEnd){\r\n          this.paused = true;\r\n          this.pausedTime = Date.now()\r\n        }\r\n      }\r\n      return \"rgb(\"+ r + \",\" + r + \",\" + r + \")\";\r\n    };\r\n  }\r\n  \r\n  private animateSlide(): CanvasGradient {\r\n    var gradient = this.ctx.createLinearGradient(0, 0, this.canvas.width, 0),\r\n      smartInc = this.inc * (this.diffTime / (1000 / 60)),\r\n      lightLeft,\r\n      lightRight,\r\n      lightCenter;\r\n    if(this.paused) {\r\n      if((Date.now() - this.pausedTime) > this.pauseInterval) {\r\n        this.lightSource = -0.6; \r\n        this.cycleAnimation()\r\n        this.paused = false;\r\n        return this.animateSlide();\r\n      }\r\n    } else {\r\n      this.lightSource += smartInc;\r\n      if(this.lightSource > (1 + this.lightSpread)) { \r\n        this.paused = true;\r\n        this.pausedTime = Date.now();\r\n      }\r\n    }\r\n    // lighting positions:\r\n    lightCenter = clamp(this.lightSource, 0, 1);\r\n    lightLeft = clamp(this.lightSource - this.lightSpread, 0, 1);\r\n    lightRight = clamp(this.lightSource + this.lightSpread, 0, 1);\r\n    \r\n    const backgroundColor = customProperties.getProperty('background-color-true');\r\n    const shimmerColor = customProperties.getProperty('surface-color');\r\n    gradient.addColorStop(lightLeft, backgroundColor);\r\n    gradient.addColorStop(lightCenter, shimmerColor);\r\n    gradient.addColorStop(lightRight, backgroundColor);\r\n    \r\n    return gradient;\r\n  }\r\n  \r\n  public settings(dict: Partial<{\r\n    canvas: Shimmer['canvas'],\r\n    fillStyle: Shimmer['fillStyle'],\r\n    font: Shimmer['font'],\r\n    lightSpread: Shimmer['lightSpread'],\r\n    inc: Shimmer['inc'],\r\n    animations: Shimmer['animations'],\r\n    text: Shimmer['text']\r\n  }> = {}) {\r\n    this.canvas = dict.canvas ?? document.createElement('canvas');\r\n    this.ctx = this.canvas.getContext('2d');\r\n    this.font = dict.font ?? this.font;\r\n    this.lightSpread = dict.lightSpread ?? this.lightSpread;\r\n    this.inc = dict.inc ?? this.inc;\r\n    this.animations = dict.animations ?? this.animations;\r\n    this.text = dict.text ?? this.text;\r\n    this.fillStyle = dict.fillStyle;\r\n\r\n    this.canvas.classList.add('shimmer-canvas');\r\n  }\r\n  \r\n  public on() {\r\n    const {width, height} = this.canvas;\r\n    // record the time we ran:\r\n    this.keepTime();\r\n    // clear and fill the canvas:\r\n    this.ctx.clearRect(0, 0, width, height);\r\n\r\n    if(this.font) {\r\n      this.ctx.font = this.font;\r\n    }\r\n\r\n    this.ctx.fillStyle = this.animate() as any;\r\n    this.ctx.fillRect(0, 0, width, height);\r\n\r\n    if(this.fillStyle) {\r\n      this.ctx.fillStyle = this.fillStyle;\r\n      this.ctx.fillRect(0, 0, width, height);\r\n    }\r\n\r\n    if(this.text) {\r\n      this.ctx.fillText(this.text, 50, 50);\r\n    }\r\n  }\r\n}","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Scrollable from \"../components/scrollable\";\r\nimport rootScope from \"../lib/rootScope\";\r\nimport { animate } from \"./animation\";\r\nimport { drawCircleFromStart } from \"./canvas/drawCircle\";\r\nimport roundRect from \"./canvas/roundRect\";\r\nimport Shimmer from \"./canvas/shimmer\";\r\nimport customProperties from \"./dom/customProperties\";\r\nimport easeInOutSine from \"./easing/easeInOutSine\";\r\nimport mediaSizes from \"./mediaSizes\";\r\n\r\nexport default class DialogsPlaceholder {\r\n  private canvas: HTMLCanvasElement;\r\n  private ctx: CanvasRenderingContext2D;\r\n  private shimmer: Shimmer;\r\n  private tempId: number;\r\n  private detachTime: number;\r\n  \r\n  private length: number;\r\n  private dialogHeight: number;\r\n  private availableLength: number;\r\n\r\n  private avatarSize: number;\r\n  private marginVertical: number;\r\n  private lineHeight: number;\r\n  private lineBorderRadius: number;\r\n  private lineMarginVertical: number;\r\n  private statusWidth: number;\r\n  private generatedValues: {\r\n    firstLineWidth: number,\r\n    secondLineWidth: number,\r\n    statusWidth: number\r\n  }[];\r\n  \r\n  private getRectFrom: Element;\r\n  private onRemove: () => void;\r\n  private blockScrollable: Scrollable;\r\n\r\n  constructor() {\r\n    this.shimmer = new Shimmer();\r\n    this.tempId = 0;\r\n    this.canvas = document.createElement('canvas');\r\n    this.canvas.classList.add('dialogs-placeholder-canvas');\r\n    this.ctx = this.canvas.getContext('2d');\r\n\r\n    this.generatedValues = [];\r\n    this.avatarSize = 54;\r\n    this.marginVertical = 9;\r\n    this.lineHeight = 10;\r\n    this.lineBorderRadius = 6;\r\n    this.lineMarginVertical = 8;\r\n    this.statusWidth = 24;\r\n  }\r\n\r\n  public attach({container, rect, getRectFrom, onRemove, blockScrollable}: {\r\n    container: HTMLElement, \r\n    rect?: {width: number, height: number},\r\n    getRectFrom?: HTMLElement,\r\n    onRemove?: DialogsPlaceholder['onRemove'],\r\n    blockScrollable?: DialogsPlaceholder['blockScrollable']\r\n  }) {\r\n    const {canvas} = this;\r\n\r\n    this.onRemove = onRemove;\r\n    this.getRectFrom = getRectFrom || container;\r\n    if(this.blockScrollable = blockScrollable) {\r\n      blockScrollable.container.style.overflowY = 'hidden';\r\n    }\r\n    \r\n    this.updateCanvasSize(rect);\r\n    this.startAnimation();\r\n    container.append(canvas);\r\n  }\r\n\r\n  public detach(availableLength: number) {\r\n    if(this.detachTime) {\r\n      return;\r\n    }\r\n    \r\n    this.availableLength = availableLength;\r\n    this.detachTime = Date.now();\r\n    \r\n    if(!rootScope.settings.animationsEnabled) {\r\n      this.remove();\r\n    }\r\n  }\r\n\r\n  public remove() {\r\n    this.stopAnimation();\r\n\r\n    if(this.canvas.parentElement) {\r\n      this.canvas.remove();\r\n\r\n      if(this.onRemove) {\r\n        this.onRemove();\r\n        this.onRemove = undefined;\r\n      }\r\n\r\n      if(this.blockScrollable) {\r\n        this.blockScrollable.container.style.overflowY = '';\r\n        this.blockScrollable = undefined;\r\n      }\r\n    }\r\n  }\r\n\r\n  private updateCanvasSize(rect: {width: number, height: number} = this.getRectFrom.getBoundingClientRect()) {\r\n    const {canvas} = this;\r\n    const dpr = canvas.dpr = window.devicePixelRatio;\r\n    canvas.width = rect.width * dpr;\r\n    canvas.height = rect.height * dpr;\r\n    canvas.style.width = rect.width + 'px';\r\n    canvas.style.height = rect.height + 'px';\r\n  }\r\n\r\n  private renderDetachAnimationFrame() {\r\n    const {\r\n      canvas, \r\n      ctx, \r\n      detachTime, \r\n      length, \r\n      availableLength\r\n    } = this;\r\n\r\n    if(!detachTime) {\r\n      return;\r\n    } else if(!rootScope.settings.animationsEnabled) {\r\n      this.remove();\r\n      return;\r\n    }\r\n\r\n    const {width} = canvas;\r\n\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n\r\n    // ctx.fillStyle = 'rgba(0, 0, 0, 0)';\r\n    // ctx.fillRect(0, 0, width, height);\r\n\r\n    // const DURATION = 500;\r\n    // const DELAY = DURATION;\r\n    const DURATION = 150;\r\n    const DELAY = 15;\r\n    const elapsedTime = Date.now() - detachTime;\r\n    let completed = true;\r\n    for(let i = 0; i < length; ++i) {\r\n      const delay = availableLength < length && i >= availableLength ? DELAY * (availableLength - 1) : DELAY * i;\r\n      const elapsedRowTime = elapsedTime - delay;\r\n      if(elapsedRowTime <= 0) {\r\n        completed = false;\r\n        continue;\r\n      }\r\n\r\n      const progress = easeInOutSine(elapsedRowTime, 0, 1, DURATION);\r\n\r\n      ctx.beginPath();\r\n      ctx.rect(0, this.dialogHeight * i, width, this.dialogHeight);\r\n      ctx.fillStyle = `rgba(0, 0, 0, ${progress})`;\r\n      ctx.fill();\r\n\r\n      if(progress < 1) {\r\n        completed = false;\r\n      }\r\n    }\r\n\r\n    // const totalRadius = Math.sqrt(width ** 2 + height ** 2);\r\n    // const gradient = ctx.createRadialGradient(\r\n    //   0, 0, 0, \r\n    //   0, 0, totalRadius);\r\n    // gradient.addColorStop(0, 'rgba(0, 0, 0, 1)');\r\n    // gradient.addColorStop(progress, 'rgba(0, 0, 0, 0)');\r\n    // gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');\r\n\r\n    // const gradient = ctx.createLinearGradient(0, 0, 0, height);\r\n    // gradient.addColorStop(0, 'rgba(0, 0, 0, 1)');\r\n    // gradient.addColorStop(progress, 'rgba(0, 0, 0, 0)');\r\n    // gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');\r\n    \r\n    // ctx.fillStyle = gradient;\r\n    // ctx.fillRect(0, 0, width, height);\r\n\r\n    ctx.globalCompositeOperation = 'source-over';\r\n\r\n    if(completed) {\r\n      this.remove();\r\n    }\r\n  }\r\n\r\n  private renderFrame() {\r\n    this.shimmer.on();\r\n    this.renderDetachAnimationFrame();\r\n  }\r\n\r\n  private startAnimation() {\r\n    const {canvas, shimmer} = this;\r\n    const tempId = ++this.tempId;\r\n    const pattern = this.createPattern();\r\n\r\n    shimmer.settings({\r\n      canvas,\r\n      fillStyle: pattern\r\n    });\r\n\r\n    const middleware = () => {\r\n      return this.tempId === tempId;\r\n    };\r\n\r\n    this.renderFrame();\r\n    animate(() => {\r\n      if(!middleware()) {\r\n        return false;\r\n      }\r\n\r\n      // ! should've removed the loop if animations are disabled\r\n      if(rootScope.settings.animationsEnabled) {\r\n        this.renderFrame();\r\n      }\r\n\r\n      // ! tempId can be changed during renderFrame\r\n      return middleware();\r\n    });\r\n\r\n    rootScope.addEventListener('theme_change', this.onThemeChange);\r\n    mediaSizes.addEventListener('resize', this.onResize);\r\n  }\r\n\r\n  private stopAnimation() {\r\n    ++this.tempId;\r\n    rootScope.removeEventListener('theme_change', this.onThemeChange);\r\n    mediaSizes.removeEventListener('resize', this.onResize);\r\n  }\r\n\r\n  private onThemeChange = () => {\r\n    this.stopAnimation();\r\n    this.startAnimation();\r\n  };\r\n\r\n  private onResize = () => {\r\n    const {canvas} = this;\r\n    const {width, height, dpr} = canvas;\r\n    this.updateCanvasSize();\r\n    if(canvas.width === width && canvas.height === height && canvas.dpr === dpr) {\r\n      return;\r\n    }\r\n    \r\n    this.stopAnimation();\r\n    this.startAnimation();\r\n  };\r\n\r\n  private createPattern() {\r\n    const {canvas, ctx} = this;\r\n\r\n    const patternCanvas = document.createElement('canvas');\r\n    const patternContext = patternCanvas.getContext('2d');\r\n    const dpr = canvas.dpr;\r\n    patternCanvas.dpr = dpr;\r\n    patternCanvas.width = canvas.width;\r\n    patternCanvas.height = canvas.height;\r\n    \r\n    patternContext.fillStyle = customProperties.getProperty('surface-color');\r\n    patternContext.fillRect(0, 0, patternCanvas.width, patternCanvas.height);\r\n    \r\n    patternContext.fillStyle = '#000';\r\n    patternContext.globalCompositeOperation = 'destination-out';\r\n    \r\n    const dialogHeight = this.dialogHeight = (this.avatarSize + this.marginVertical * 2) * dpr;\r\n    const length = this.length = Math.ceil(canvas.height / dialogHeight);\r\n    for(let i = 0; i < length; ++i) {\r\n      this.drawChat(patternContext, i, i * dialogHeight);\r\n    }\r\n\r\n    return ctx.createPattern(patternCanvas, 'no-repeat');\r\n  }\r\n\r\n  private drawChat(ctx: CanvasRenderingContext2D, i: number, y: number) {\r\n    let generatedValues = this.generatedValues[i];\r\n    if(!generatedValues) {\r\n      generatedValues = this.generatedValues[i] = {\r\n        firstLineWidth: 40 + Math.random() * 100, // 120\r\n        secondLineWidth: 120 + Math.random() * 130, // 240\r\n        statusWidth: 24 + Math.random() * 16,\r\n      };\r\n    }\r\n    \r\n    const {\r\n      firstLineWidth,\r\n      secondLineWidth,\r\n      statusWidth\r\n    } = generatedValues;\r\n\r\n    const {canvas} = ctx;\r\n    const {dpr} = canvas;\r\n    y /= dpr;\r\n\r\n    const {\r\n      avatarSize, \r\n      marginVertical, \r\n      lineHeight, \r\n      lineBorderRadius, \r\n      lineMarginVertical, \r\n    } = this;\r\n\r\n    let marginLeft = 17;\r\n    drawCircleFromStart(ctx, marginLeft, y + marginVertical, avatarSize / 2, true);\r\n\r\n    marginLeft += avatarSize + 10;\r\n    roundRect(ctx, marginLeft, y + marginVertical + lineMarginVertical, firstLineWidth, lineHeight, lineBorderRadius, true);\r\n    roundRect(ctx, marginLeft, y + marginVertical + avatarSize - lineHeight - lineMarginVertical, secondLineWidth, lineHeight, lineBorderRadius, true);\r\n\r\n    roundRect(ctx, canvas.width / dpr - 24 - statusWidth, y + marginVertical + lineMarginVertical, statusWidth, lineHeight, lineBorderRadius, true);\r\n  }\r\n}\r\n","export default function drawCircle(ctx: CanvasRenderingContext2D, x: number, y: number, radius: number, fill?: boolean, stroke?: boolean) {\r\n  const dpr = ctx.canvas.dpr;\r\n  if(dpr) {\r\n    x *= dpr;\r\n    y *= dpr;\r\n    radius *= dpr;\r\n  }\r\n\r\n  ctx.beginPath();\r\n  ctx.arc(x, y, radius, 0, 2 * Math.PI, false);\r\n  ctx.closePath();\r\n\r\n  if(fill) {\r\n    ctx.fill();\r\n  }\r\n\r\n  if(stroke) {\r\n    ctx.stroke();\r\n  }\r\n}\r\n\r\nexport function drawCircleFromStart(ctx: CanvasRenderingContext2D, x: number, y: number, radius: number, fill?: boolean, stroke?: boolean) {\r\n  return drawCircle(ctx, x + radius, y + radius, radius, fill, stroke);\r\n}\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport type { MyDialogFilter as DialogFilter, MyDialogFilter } from \"../storages/filters\";\r\nimport type LazyLoadQueue from \"../../components/lazyLoadQueue\";\r\nimport type { Dialog, MyMessage } from \"./appMessagesManager\";\r\nimport type { MyPhoto } from \"./appPhotosManager\";\r\nimport type { MyDocument } from \"./appDocsManager\";\r\nimport type { State } from \"../../config/state\";\r\nimport AvatarElement from \"../../components/avatar\";\r\nimport DialogsContextMenu from \"../../components/dialogsContextMenu\";\r\nimport { horizontalMenu } from \"../../components/horizontalMenu\";\r\nimport ripple from \"../../components/ripple\";\r\nimport Scrollable, { ScrollableX, SliceSides } from \"../../components/scrollable\";\r\nimport { formatDateAccordingToTodayNew } from \"../../helpers/date\";\r\nimport { IS_MOBILE_SAFARI, IS_SAFARI } from \"../../environment/userAgent\";\r\nimport { logger, LogTypes } from \"../logger\";\r\nimport rootScope from \"../rootScope\";\r\nimport appImManager from \"./appImManager\";\r\nimport Button from \"../../components/button\";\r\nimport SetTransition from \"../../components/singleTransition\";\r\nimport { MyDraftMessage } from \"./appDraftsManager\";\r\nimport DEBUG, { MOUNT_CLASS_TO } from \"../../config/debug\";\r\nimport PeerTitle from \"../../components/peerTitle\";\r\nimport I18n, { FormatterArguments, i18n, LangPackKey, _i18n } from \"../langPack\";\r\nimport findUpTag from \"../../helpers/dom/findUpTag\";\r\nimport lottieLoader from \"../rlottie/lottieLoader\";\r\nimport { wrapPhoto } from \"../../components/wrappers\";\r\nimport AppEditFolderTab from \"../../components/sidebarLeft/tabs/editFolder\";\r\nimport appSidebarLeft, { SettingSection } from \"../../components/sidebarLeft\";\r\nimport { attachClickEvent, simulateClickEvent } from \"../../helpers/dom/clickEvent\";\r\nimport positionElementByIndex from \"../../helpers/dom/positionElementByIndex\";\r\nimport replaceContent from \"../../helpers/dom/replaceContent\";\r\nimport ConnectionStatusComponent from \"../../components/connectionStatus\";\r\nimport { renderImageFromUrlPromise } from \"../../helpers/dom/renderImageFromUrl\";\r\nimport { fastRafConventional, fastRafPromise } from \"../../helpers/schedulers\";\r\nimport SortedUserList from \"../../components/sortedUserList\";\r\nimport IS_TOUCH_SUPPORTED from \"../../environment/touchSupport\";\r\nimport handleTabSwipe from \"../../helpers/dom/handleTabSwipe\";\r\nimport windowSize from \"../../helpers/windowSize\";\r\nimport isInDOM from \"../../helpers/dom/isInDOM\";\r\nimport { setSendingStatus } from \"../../components/sendingStatus\";\r\nimport SortedList, { SortedElementBase } from \"../../helpers/sortedList\";\r\nimport debounce from \"../../helpers/schedulers/debounce\";\r\nimport { NULL_PEER_ID } from \"../mtproto/mtproto_config\";\r\nimport groupCallActiveIcon from \"../../components/groupCallActiveIcon\";\r\nimport { Chat, Message, NotifyPeer } from \"../../layer\";\r\nimport IS_GROUP_CALL_SUPPORTED from \"../../environment/groupCallSupport\";\r\nimport mediaSizes from \"../../helpers/mediaSizes\";\r\nimport appNavigationController, { NavigationItem } from \"../../components/appNavigationController\";\r\nimport assumeType from \"../../helpers/assumeType\";\r\nimport generateTitleIcons from \"../../components/generateTitleIcons\";\r\nimport appMediaPlaybackController from \"../../components/appMediaPlaybackController\";\r\nimport setInnerHTML from \"../../helpers/dom/setInnerHTML\";\r\nimport { AppManagers } from \"./managers\";\r\nimport appSidebarRight from \"../../components/sidebarRight\";\r\nimport PopupElement from \"../../components/popups\";\r\nimport choosePhotoSize from \"./utils/photos/choosePhotoSize\";\r\nimport wrapEmojiText from \"../richTextProcessor/wrapEmojiText\";\r\nimport wrapMessageForReply from \"../../components/wrappers/messageForReply\";\r\nimport isMessageRestricted from \"./utils/messages/isMessageRestricted\";\r\nimport getMediaFromMessage from \"./utils/messages/getMediaFromMessage\";\r\nimport getMessageSenderPeerIdOrName from \"./utils/messages/getMessageSenderPeerIdOrName\";\r\nimport wrapStickerEmoji from \"../../components/wrappers/stickerEmoji\";\r\nimport getDialogIndexKey from \"./utils/dialogs/getDialogIndexKey\";\r\nimport getProxiedManagers from \"./getProxiedManagers\";\r\nimport getDialogIndex from \"./utils/dialogs/getDialogIndex\";\r\nimport { attachContextMenuListener } from \"../../helpers/dom/attachContextMenuListener\";\r\nimport deferredPromise, { CancellablePromise } from \"../../helpers/cancellablePromise\";\r\nimport wrapPeerTitle from \"../../components/wrappers/peerTitle\";\r\nimport middlewarePromise from \"../../helpers/middlewarePromise\";\r\nimport appDownloadManager from \"./appDownloadManager\";\r\nimport groupCallsController from \"../calls/groupCallsController\";\r\nimport callsController from \"../calls/callsController\";\r\nimport cancelEvent from \"../../helpers/dom/cancelEvent\";\r\nimport noop from \"../../helpers/noop\";\r\nimport DialogsPlaceholder from \"../../helpers/dialogsPlaceholder\";\r\nimport pause from \"../../helpers/schedulers/pause\";\r\nimport apiManagerProxy from \"../mtproto/mtprotoworker\";\r\nimport { add } from \"../../vendor/leemon\";\r\n\r\nexport const DIALOG_LIST_ELEMENT_TAG = 'A';\r\n\r\nexport type DialogDom = {\r\n  avatarEl: AvatarElement,\r\n  captionDiv: HTMLDivElement,\r\n  titleSpan: HTMLSpanElement,\r\n  titleSpanContainer: HTMLSpanElement,\r\n  statusSpan: HTMLSpanElement,\r\n  lastTimeSpan: HTMLSpanElement,\r\n  unreadBadge: HTMLElement,\r\n  callIcon?: ReturnType<typeof groupCallActiveIcon>,\r\n  mentionsBadge?: HTMLElement,\r\n  lastMessageSpan: HTMLSpanElement,\r\n  containerEl: HTMLElement,\r\n  listEl: HTMLElement,\r\n  subtitleEl: HTMLElement,\r\n\r\n  setLastMessagePromise?: CancellablePromise<void>,\r\n  setUnreadMessagePromise?: CancellablePromise<void>\r\n};\r\n\r\ninterface SortedDialog extends SortedElementBase {\r\n  dom: DialogDom,\r\n  loadPromises?: Promise<any>[]\r\n}\r\n\r\nfunction setPromiseMiddleware<T extends {[smth in K as K]?: CancellablePromise<void>}, K extends keyof T>(obj: T, key: K) {\r\n  const oldPromise = (obj[key] as unknown as CancellablePromise<void>);\r\n  if(oldPromise) {\r\n    oldPromise.reject();\r\n  }\r\n\r\n  // @ts-ignore\r\n  const deferred = (obj[key] = deferredPromise<void>());\r\n  deferred.catch(() => {}).finally(() => {\r\n    if(obj[key] as unknown as CancellablePromise<void> === deferred) {\r\n      delete obj[key];\r\n    }\r\n  });\r\n\r\n  const middleware = middlewarePromise(() => (obj[key] as unknown as CancellablePromise<void>) === deferred);\r\n  return {deferred, middleware};\r\n}\r\n\r\nclass SortedDialogList extends SortedList<SortedDialog> {\r\n  constructor(\r\n    public managers: AppManagers,\r\n    public list: HTMLUListElement, \r\n    public indexKey: ReturnType<typeof getDialogIndexKey>,\r\n    public onListLengthChange?: () => void,\r\n  ) {\r\n    super({\r\n      getIndex: (element) => managers.dialogsStorage.getDialogIndex(element.id, this.indexKey),\r\n      onDelete: (element) => {\r\n        element.dom.listEl.remove();\r\n        this.onListLengthChange && this.onListLengthChange();\r\n      },\r\n      onSort: (element, idx) => {\r\n        const willChangeLength = element.dom.listEl.parentElement !== this.list;\r\n        positionElementByIndex(element.dom.listEl, this.list, idx);\r\n\r\n        if(willChangeLength) {\r\n          this.onListLengthChange && this.onListLengthChange();\r\n        }\r\n      },\r\n      onElementCreate: (base, batch) => {\r\n        const loadPromises: Promise<any>[] = batch ? [] : undefined;\r\n\r\n        const {dom} = appDialogsManager.addListDialog({peerId: base.id, loadPromises, isBatch: batch});\r\n        (base as SortedDialog).dom = dom;\r\n\r\n        if(loadPromises?.length) {\r\n          (base as SortedDialog).loadPromises = loadPromises;\r\n          Promise.all(loadPromises).finally(() => {\r\n            delete (base as SortedDialog).loadPromises;\r\n          });\r\n        }\r\n\r\n        return base as SortedDialog;\r\n      },\r\n      updateElementWith: fastRafConventional\r\n    });\r\n  }\r\n\r\n  public clear() {\r\n    this.list.innerHTML = '';\r\n    super.clear();\r\n  }\r\n}\r\n\r\n//const testScroll = false;\r\n//let testTopSlice = 1;\r\n\r\nexport class AppDialogsManager {\r\n  private chatsContainer = document.getElementById('chatlist-container') as HTMLDivElement;\r\n\r\n  private loadDialogsPromise: Promise<{cached: boolean, renderPromise: AppDialogsManager['loadDialogsRenderPromise']}>;\r\n  private loadDialogsRenderPromise: Promise<void>;\r\n\r\n  private scroll: Scrollable = null;\r\n  \r\n  private log = logger('DIALOGS', LogTypes.Log | LogTypes.Error | LogTypes.Warn | LogTypes.Debug);\r\n\r\n  private contextMenu: DialogsContextMenu;\r\n\r\n  private sortedList: SortedDialogList;\r\n  public placeholders: {[filterId: number]: DialogsPlaceholder} = {};\r\n  public sortedLists: {[filterId: number]: SortedDialogList} = {};\r\n  public scrollables: {[filterId: number]: Scrollable} = {};\r\n  public filterId: number;\r\n  private folders: {[k in 'menu' | 'container' | 'menuScrollContainer']: HTMLElement} = {\r\n    menu: document.getElementById('folders-tabs'),\r\n    menuScrollContainer: null,\r\n    container: document.getElementById('folders-container')\r\n  };\r\n  private filtersRendered: {\r\n    [filterId: string]: {\r\n      menu: HTMLElement, \r\n      container: HTMLElement,\r\n      unread: HTMLElement,\r\n      title: HTMLElement\r\n    }\r\n  } = {};\r\n  private showFiltersPromise: Promise<void>;\r\n\r\n  private sliceTimeout: number;\r\n\r\n  private lastActiveElements: Set<HTMLElement> = new Set();\r\n\r\n  private offsets: {top: number, bottom: number} = {top: 0, bottom: 0};\r\n  \r\n  private loadContacts: () => void;\r\n  private processContact: (peerId: PeerId) => void;\r\n\r\n  private indexKey: ReturnType<typeof getDialogIndexKey>;\r\n\r\n  private initedListeners = false;\r\n\r\n  private onListLengthChange: () => Promise<void>;\r\n  private loadedDialogsAtLeastOnce = false;\r\n  private allChatsIntlElement: I18n.IntlElement;\r\n\r\n  private emptyDialogsPlaceholderSubtitle: I18n.IntlElement;\r\n  private updateContactsLengthPromise: Promise<number>;\r\n\r\n  private filtersNavigationItem: NavigationItem;\r\n\r\n  private managers: AppManagers;\r\n\r\n  constructor() {\r\n    const managers = this.managers = getProxiedManagers();\r\n\r\n    this.contextMenu = new DialogsContextMenu(managers);\r\n\r\n    this.folders.menuScrollContainer = this.folders.menu.parentElement;\r\n\r\n    this.onListLengthChange = debounce(this._onListLengthChange, 100, false, true);\r\n\r\n    const bottomPart = document.createElement('div');\r\n    bottomPart.classList.add('connection-status-bottom');\r\n    bottomPart.append(this.folders.container);\r\n\r\n    /* if(isTouchSupported && isSafari) {\r\n      let allowUp: boolean, allowDown: boolean, slideBeginY: number;\r\n      const container = this.scroll.container;\r\n      container.addEventListener('touchstart', (event) => {\r\n        allowUp = container.scrollTop > 0;\r\n        allowDown = (container.scrollTop < container.scrollHeight - container.clientHeight);\r\n        // @ts-ignore\r\n        slideBeginY = event.pageY;\r\n      });\r\n      \r\n      container.addEventListener('touchmove', (event: any) => {\r\n        var up = (event.pageY > slideBeginY);\r\n        var down = (event.pageY < slideBeginY);\r\n        slideBeginY = event.pageY;\r\n        if((up && allowUp) || (down && allowDown)) {\r\n          event.stopPropagation();\r\n        } else if(up || down) {\r\n          event.preventDefault();\r\n        }\r\n      });\r\n    } */\r\n\r\n    if(IS_TOUCH_SUPPORTED) {\r\n      handleTabSwipe({\r\n        element: this.folders.container,\r\n        onSwipe: (xDiff) => {\r\n          const prevId = selectTab.prevId();\r\n          selectTab(xDiff > 0 ? prevId + 1 : prevId - 1);\r\n        }\r\n      });\r\n    }\r\n\r\n    this.allChatsIntlElement = new I18n.IntlElement({\r\n      key: 'FilterAllChatsShort'\r\n    });\r\n\r\n    /* if(testScroll) {\r\n      let i = 0;\r\n      let add = () => {\r\n        let li = document.createElement('li');\r\n        li.dataset.id = '' + i;\r\n        li.id = '' + i;\r\n        li.innerHTML = `<div class=\"rp\"><avatar-element style=\"background-color: rgb(166, 149, 231); font-size: 0px;\"><img src=\"assets/img/pepe.jpg\"></avatar-element><div class=\"user-caption\"><p><span class=\"user-title\">${i}</span><span><span class=\"message-status\"></span><span class=\"message-time\">18:33</span></span></p><p><span class=\"user-last-message\"><b>-_-_-_-: </b>qweasd</span><span></span></p></div></div>`;\r\n        i++;\r\n        this.scroll.append(li);\r\n      };\r\n      for(let i = 0; i < 500; ++i) {\r\n        add();\r\n      }\r\n      (window as any).addElement = add;\r\n    } */\r\n\r\n    rootScope.addEventListener('state_cleared', () => {\r\n      //setTimeout(() => \r\n      apiManagerProxy.getState().then(async(state) => {\r\n        this.loadedDialogsAtLeastOnce = false;\r\n\r\n        /* const clearPromises: Promise<any>[] = [];\r\n        for(const name in this.managers.appStateManager.storagesResults) {\r\n          const results = this.managers.appStateManager.storagesResults[name as keyof AppStateManager['storages']];\r\n          const storage = this.managers.appStateManager.storages[name as keyof AppStateManager['storages']];\r\n          results.length = 0;\r\n          clearPromises.push(storage.clear());\r\n        } */\r\n\r\n        this.sortedList.clear();\r\n        this.onTabChange();\r\n        this.onStateLoaded(state);\r\n      })//, 5000);\r\n    });\r\n\r\n    this.setFilterId(0, 0);\r\n    this.addFilter({\r\n      id: this.filterId,\r\n      title: '',\r\n      orderIndex: 0\r\n    });\r\n\r\n    const foldersScrollable = new ScrollableX(this.folders.menuScrollContainer);\r\n    bottomPart.prepend(this.folders.menuScrollContainer);\r\n    const selectTab = horizontalMenu(this.folders.menu, this.folders.container, (id, tabContent) => {\r\n      /* if(id !== 0) {\r\n        id += 1;\r\n      } */\r\n\r\n      id = +tabContent.dataset.filterId || 0;\r\n\r\n      if(!IS_MOBILE_SAFARI) {\r\n        if(id) {\r\n          if(!this.filtersNavigationItem) {\r\n            this.filtersNavigationItem = {\r\n              type: 'filters',\r\n              onPop: () => {\r\n                selectTab(0);\r\n                this.filtersNavigationItem = undefined;\r\n              }\r\n            };\r\n    \r\n            appNavigationController.spliceItems(1, 0, this.filtersNavigationItem);\r\n          }\r\n        } else if(this.filtersNavigationItem) {\r\n          appNavigationController.removeItem(this.filtersNavigationItem);\r\n          this.filtersNavigationItem = undefined;\r\n        }\r\n      }\r\n\r\n      if(this.filterId === id) return;\r\n\r\n      this.sortedLists[id].clear();\r\n      return this.setFilterIdAndChangeTab(id).then(({cached, renderPromise}) => {\r\n        if(cached) {\r\n          return renderPromise;\r\n        }\r\n      });\r\n    }, () => {\r\n      for(const folderId in this.sortedLists) {\r\n        if(+folderId !== this.filterId) {\r\n          this.sortedLists[folderId].clear();\r\n          const placeholder = this.placeholders[folderId];\r\n          if(placeholder) {\r\n            placeholder.remove();\r\n          }\r\n        }\r\n      }\r\n    }, undefined, foldersScrollable);\r\n\r\n    apiManagerProxy.getState().then((state) => {\r\n      // * it should've had a better place :(\r\n      appMediaPlaybackController.setPlaybackParams(state.playbackParams);\r\n      appMediaPlaybackController.addEventListener('playbackParams', (params) => {\r\n        this.managers.appStateManager.pushToState('playbackParams', params);\r\n      });\r\n      \r\n      return this.onStateLoaded(state);\r\n    })/* .then(() => {\r\n      const isLoadedMain = this.managers.appMessagesManager.dialogsStorage.isDialogsLoaded(0);\r\n      const isLoadedArchive = this.managers.appMessagesManager.dialogsStorage.isDialogsLoaded(1);\r\n      const wasLoaded = isLoadedMain || isLoadedArchive;\r\n      const a: Promise<any> = isLoadedMain ? Promise.resolve() : this.managers.appMessagesManager.getConversationsAll('', 0);\r\n      const b: Promise<any> = isLoadedArchive ? Promise.resolve() : this.managers.appMessagesManager.getConversationsAll('', 1);\r\n      a.finally(() => {\r\n        b.then(() => {\r\n          if(wasLoaded) {\r\n            (apiUpdatesManager.updatesState.syncLoading || Promise.resolve()).then(() => {\r\n              this.managers.appMessagesManager.refreshConversations();\r\n            });\r\n          }\r\n        });\r\n      });\r\n    }) */;\r\n\r\n    mediaSizes.addEventListener('resize', () => {\r\n      this.changeFiltersAllChatsKey();\r\n    });\r\n\r\n    new ConnectionStatusComponent(this.managers, this.chatsContainer);\r\n    this.chatsContainer.append(bottomPart);\r\n\r\n    setTimeout(() => {\r\n      lottieLoader.loadLottieWorkers();\r\n    }, 200);\r\n\r\n    PopupElement.MANAGERS = rootScope.managers = managers;\r\n    appDownloadManager.construct(managers);\r\n    appSidebarLeft.construct(managers);\r\n    appSidebarRight.construct(managers);\r\n    groupCallsController.construct(managers);\r\n    callsController.construct(managers);\r\n    appImManager.construct(managers);\r\n\r\n    // start\r\n\r\n    this.sortedList = this.sortedLists[this.filterId];\r\n    this.scroll = this.scrollables[this.filterId];\r\n\r\n    //selectTab(0);\r\n    simulateClickEvent(this.folders.menu.firstElementChild as HTMLElement);\r\n  }\r\n\r\n  public get chatList() {\r\n    return this.sortedList.list;\r\n  }\r\n\r\n  public setFilterId(filterId: number, orderIndex: MyDialogFilter['orderIndex']) {\r\n    this.indexKey = getDialogIndexKey(orderIndex);\r\n    this.filterId = filterId;\r\n  }\r\n\r\n  public async setFilterIdAndChangeTab(filterId: number) {\r\n    this.indexKey = await this.managers.dialogsStorage.getDialogIndexKeyByFilterId(filterId);\r\n    this.filterId = filterId;\r\n    return this.onTabChange();\r\n  }\r\n\r\n  private setOnlineStatus(element: HTMLElement, online: boolean) {\r\n    const className = 'is-online';\r\n    const hasClassName = element.classList.contains(className);\r\n    !hasClassName && online && element.classList.add(className);\r\n    SetTransition(element, 'is-visible', online, 250, online ? undefined : () => {\r\n      element.classList.remove(className);\r\n    }, online && !hasClassName ? 2 : 0);\r\n  }\r\n\r\n  private initListeners() {\r\n    rootScope.addEventListener('user_update', async(userId) => {\r\n      //console.log('updating user:', user, dialog);\r\n      \r\n      const peerId = userId.toPeerId();\r\n      const dom = this.getDialogDom(peerId);\r\n      if(dom && peerId !== rootScope.myId && !(await this.managers.appUsersManager.isBot(userId))) {\r\n        const user = await this.managers.appUsersManager.getUser(userId);\r\n        const online = user.status?._ === 'userStatusOnline';\r\n        this.setOnlineStatus(dom.avatarEl, online);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('chat_update', async(chatId) => {\r\n      const peerId = chatId.toPeerId(true);\r\n      const dialog = await this.managers.appMessagesManager.getDialogOnly(peerId);\r\n      if(dialog) {\r\n        this.processDialogForCallStatus(dialog);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('folder_unread', (folder) => {\r\n      this.setFilterUnreadCount(folder.id);\r\n    });\r\n\r\n    rootScope.addEventListener('contacts_update', (userId) => {\r\n      this.processContact && this.processContact(userId.toPeerId());\r\n    });\r\n\r\n    rootScope.addEventListener('dialog_flush', ({dialog}) => {\r\n      if(!dialog) {\r\n        return;\r\n      }\r\n\r\n      this.setLastMessageN({\r\n        dialog, \r\n        setUnread: true\r\n      });\r\n      this.validateDialogForFilter(dialog);\r\n      this.setFiltersUnreadCount();\r\n    });\r\n\r\n    rootScope.addEventListener('dialogs_multiupdate', (dialogs) => {\r\n      for(const peerId in dialogs) {\r\n        const dialog = dialogs[peerId];\r\n        this.updateDialog(dialog);\r\n\r\n        if(this.processContact) {\r\n          this.processContact(peerId.toPeerId());\r\n        }\r\n\r\n        this.validateDialogForFilter(dialog);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('dialog_drop', ({peerId}) => {\r\n      this.deleteDialog(peerId);\r\n\r\n      if(this.processContact) {\r\n        this.processContact(peerId);\r\n      }\r\n    });\r\n\r\n    rootScope.addEventListener('dialog_unread', ({dialog}) => {\r\n      if(!dialog) {\r\n        return;\r\n      }\r\n\r\n      this.setUnreadMessagesN({dialog});\r\n      this.validateDialogForFilter(dialog);\r\n    });\r\n\r\n    rootScope.addEventListener('dialog_notify_settings', (dialog) => {\r\n      this.validateDialogForFilter(dialog);\r\n      this.setUnreadMessagesN({dialog}); //    ,    is-muted\r\n    });\r\n\r\n    rootScope.addEventListener('dialog_draft', ({dialog, drop, peerId}) => {\r\n      if(drop) {\r\n        this.sortedList.delete(peerId);\r\n      } else {\r\n        this.updateDialog(dialog);\r\n      }\r\n\r\n      if(this.processContact) {\r\n        this.processContact(peerId);\r\n      }\r\n    });\r\n\r\n    appImManager.addEventListener('peer_changed', (peerId) => {\r\n      //const perf = performance.now();\r\n      for(const element of this.lastActiveElements) {\r\n        if(element.dataset.peerId.toPeerId() !== peerId) {\r\n          this.setDialogActive(element, false);\r\n        }\r\n      }\r\n\r\n      const elements = Array.from(document.querySelectorAll(`[data-autonomous=\"0\"] .chatlist-chat[data-peer-id=\"${peerId}\"]`)) as HTMLElement[];\r\n      elements.forEach((element) => {\r\n        this.setDialogActive(element, true);\r\n      });\r\n      //this.log('peer_changed total time:', performance.now() - perf);\r\n    });\r\n\r\n    rootScope.addEventListener('filter_update', async(filter) => {\r\n      if(!this.filtersRendered[filter.id]) {\r\n        this.addFilter(filter);\r\n        return;\r\n      } else if(filter.id === this.filterId) { //     ,    dialogs_multiupdate\r\n        const dialogs = await this.managers.dialogsStorage.getCachedDialogs(true);\r\n        await this.validateListForFilter();\r\n        for(let i = 0, length = dialogs.length; i < length; ++i) {\r\n          const dialog = dialogs[i];\r\n          this.updateDialog(dialog);\r\n        }\r\n      }\r\n\r\n      const elements = this.filtersRendered[filter.id];\r\n      setInnerHTML(elements.title, wrapEmojiText(filter.title));\r\n    });\r\n\r\n    rootScope.addEventListener('filter_delete', (filter) => {\r\n      const elements = this.filtersRendered[filter.id];\r\n      if(!elements) return;\r\n\r\n      // set tab\r\n      //(this.folders.menu.firstElementChild.children[Math.max(0, filter.id - 2)] as HTMLElement).click();\r\n      simulateClickEvent(this.folders.menu.firstElementChild as HTMLElement);\r\n\r\n      elements.container.remove();\r\n      elements.menu.remove();\r\n      \r\n      delete this.sortedLists[filter.id];\r\n      delete this.scrollables[filter.id];\r\n      delete this.filtersRendered[filter.id];\r\n\r\n      this.onFiltersLengthChange();\r\n    });\r\n\r\n    rootScope.addEventListener('filter_order', async(order) => {\r\n      const containerToAppend = this.folders.menu as HTMLElement;\r\n      const r = await Promise.all(order.map(async(filterId) => {\r\n        return {\r\n          indexKey: await this.managers.dialogsStorage.getDialogIndexKeyByFilterId(filterId), \r\n          filter: await this.managers.filtersStorage.getFilter(filterId)\r\n        };\r\n      }));\r\n\r\n      order.forEach((filterId, idx) => {\r\n        const {indexKey, filter} = r[idx];\r\n        const renderedFilter = this.filtersRendered[filterId];\r\n\r\n        const sortedList = this.sortedLists[filterId];\r\n        sortedList.indexKey = indexKey;\r\n\r\n        positionElementByIndex(renderedFilter.menu, containerToAppend, filter.orderIndex);\r\n        positionElementByIndex(renderedFilter.container, this.folders.container, filter.orderIndex);\r\n      });\r\n\r\n      this.indexKey = await this.managers.dialogsStorage.getDialogIndexKeyByFilterId(this.filterId);\r\n\r\n      /* if(this.filterId) {\r\n        const tabIndex = order.indexOf(this.filterId) + 1;\r\n        selectTab.prevId = tabIndex;\r\n      } */\r\n    });\r\n\r\n    rootScope.addEventListener('peer_typings', async({peerId, typings}) => {\r\n      const dialog = await this.managers.appMessagesManager.getDialogOnly(peerId);\r\n      if(!dialog) return;\r\n\r\n      if(typings.length) {\r\n        this.setTyping(dialog);\r\n      } else {\r\n        this.unsetTyping(dialog);\r\n      }\r\n    });\r\n  }\r\n\r\n  private setDialogActive(listEl: HTMLElement, active: boolean) {\r\n    // @ts-ignore\r\n    const dom = listEl.dialogDom as DialogDom;\r\n    listEl.classList.toggle('active', active);\r\n    if(active) {\r\n      this.lastActiveElements.add(listEl);\r\n    } else {\r\n      this.lastActiveElements.delete(listEl);\r\n    }\r\n\r\n    if(dom?.callIcon) {\r\n      dom.callIcon.setActive(active);\r\n    }\r\n  }\r\n\r\n  private async onStateLoaded(state: State) {\r\n    const loadDialogsPromise = this.onChatsScroll();\r\n\r\n    if(!this.initedListeners) {\r\n      this.initListeners();\r\n      this.initedListeners = true;\r\n    }\r\n\r\n    const haveFilters = !!(state.filters && Object.keys(state.filters).length);\r\n    const getDialogsFiltersPromise = haveFilters ? Promise.resolve(Object.values(state.filters).sort((a, b) => a.orderIndex - b.orderIndex)) : this.managers.filtersStorage.getDialogFilters();\r\n    const renderFiltersPromise = getDialogsFiltersPromise.then((filters) => {\r\n      for(const filter of filters) {\r\n        this.addFilter(filter);\r\n      }\r\n    });\r\n\r\n    if(haveFilters) {\r\n      await renderFiltersPromise;\r\n      if(this.showFiltersPromise) {\r\n        await this.showFiltersPromise;\r\n      }\r\n    }\r\n\r\n    this.managers.appNotificationsManager.getNotifyPeerTypeSettings();\r\n\r\n    await (await loadDialogsPromise).renderPromise;\r\n    this.managers.appMessagesManager.fillConversations();\r\n  }\r\n\r\n  /* private getOffset(side: 'top' | 'bottom'): {index: number, pos: number} {\r\n    if(!this.scroll.loadedAll[side]) {\r\n      const element = (side === 'top' ? this.chatList.firstElementChild : this.chatList.lastElementChild) as HTMLElement;\r\n      if(element) {\r\n        const peerId = element.dataset.peerId;\r\n        const dialog = this.managers.appMessagesManager.getDialogByPeerId(peerId);\r\n        return {index: dialog[0].index, pos: dialog[1]};\r\n      }\r\n    }\r\n\r\n    return {index: 0, pos: -1};\r\n  } */\r\n  private getOffsetIndex(side: 'top' | 'bottom') {\r\n    return {index: this.scroll.loadedAll[side] ? 0 : this.offsets[side]};\r\n  }\r\n\r\n  private isDialogMustBeInViewport(dialog: Dialog) {\r\n    if(dialog.migratedTo !== undefined || !this.testDialogForFilter(dialog)) return false;\r\n    //return true;\r\n    const topOffset = this.getOffsetIndex('top');\r\n    const bottomOffset = this.getOffsetIndex('bottom');\r\n    \r\n    if(!topOffset.index && !bottomOffset.index) {\r\n      return true;\r\n    }\r\n    \r\n    const index = getDialogIndex(dialog, this.indexKey);\r\n    return (!topOffset.index || index <= topOffset.index) && (!bottomOffset.index || index >= bottomOffset.index);\r\n  }\r\n\r\n  private deleteDialog(peerId: PeerId) {\r\n    this.sortedList.delete(peerId);\r\n  }\r\n\r\n  private updateDialog(dialog: Dialog) {\r\n    if(this.isDialogMustBeInViewport(dialog)) {\r\n      if(!this.sortedList.has(dialog.peerId)) {\r\n        this.sortedList.add(dialog.peerId);\r\n        return;\r\n      }\r\n    } else {\r\n      this.deleteDialog(dialog.peerId);\r\n      return;\r\n    }\r\n\r\n    const dom = this.getDialogDom(dialog.peerId);\r\n    if(dom) {\r\n      this.setLastMessageN({\r\n        dialog,\r\n        dom,\r\n        setUnread: true\r\n      });\r\n      this.sortedList.update(dialog.peerId);\r\n    }\r\n  }\r\n\r\n  public onTabChange = () => {\r\n    this.scroll = this.scrollables[this.filterId];\r\n    this.scroll.loadedAll.top = true;\r\n    this.scroll.loadedAll.bottom = false;\r\n    this.offsets.top = this.offsets.bottom = 0;\r\n    this.loadDialogsRenderPromise = undefined;\r\n    this.loadDialogsPromise = undefined;\r\n    this.sortedList = this.sortedLists[this.filterId];\r\n    return this.onChatsScroll();\r\n  };\r\n\r\n  private async setFilterUnreadCount(filterId: number) {\r\n    if(filterId === 0) {\r\n      return;\r\n    }\r\n\r\n    const unreadSpan = this.filtersRendered[filterId]?.unread;\r\n    if(!unreadSpan) {\r\n      return;\r\n    }\r\n\r\n    const {unreadUnmutedCount, unreadCount} = await this.managers.dialogsStorage.getFolderUnreadCount(filterId);\r\n    unreadSpan.classList.toggle('badge-gray', !unreadUnmutedCount);\r\n    unreadSpan.innerText = unreadCount ? '' + unreadCount : '';\r\n  }\r\n\r\n  private setFiltersUnreadCount() {\r\n    for(const filterId in this.filtersRendered) {\r\n      this.setFilterUnreadCount(+filterId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   *     ,    (!)\r\n   */\r\n  private async validateListForFilter() {\r\n    this.sortedList.getAll().forEach(async(element) => {\r\n      const dialog = await this.managers.appMessagesManager.getDialogOnly(element.id);\r\n      if(!this.testDialogForFilter(dialog)) {\r\n        this.deleteDialog(element.id);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   *     ,    (!)\r\n   */\r\n  private validateDialogForFilter(dialog: Dialog) {\r\n    if(!this.getDialogDom(dialog.peerId)) {\r\n      return;\r\n    }\r\n\r\n    if(!this.testDialogForFilter(dialog)) {\r\n      this.deleteDialog(dialog.peerId);\r\n    }\r\n  }\r\n\r\n  public testDialogForFilter(dialog: Dialog) {\r\n    if(\r\n      !dialog || \r\n      (this.filterId > 1 ? getDialogIndex(dialog, this.indexKey) === undefined : this.filterId !== dialog.folder_id)\r\n      // (filter && !(await this.managers.filtersStorage.testDialogForFilter(dialog, filter)))\r\n    ) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public generateScrollable(list: HTMLUListElement, filter: Parameters<AppDialogsManager['addFilter']>[0]) {\r\n    const filterId = filter.id;\r\n    const scrollable = new Scrollable(null, 'CL', 500);\r\n    scrollable.container.addEventListener('scroll', this.onChatsRegularScroll);\r\n    scrollable.container.dataset.filterId = '' + filterId;\r\n    scrollable.onScrolledTop = this.onChatsScrollTop;\r\n    scrollable.onScrolledBottom = this.onChatsScroll;\r\n    scrollable.setVirtualContainer(list);\r\n\r\n    const sortedDialogList = new SortedDialogList(\r\n      this.managers,\r\n      list, \r\n      getDialogIndexKey(filter.orderIndex),\r\n      this.onListLengthChange\r\n    );\r\n\r\n    this.scrollables[filterId] = scrollable;\r\n    this.sortedLists[filterId] = sortedDialogList;\r\n\r\n    // list.classList.add('hide');\r\n    // scrollable.container.style.backgroundColor = '#' + (Math.random() * (16 ** 6 - 1) | 0).toString(16);\r\n\r\n    return scrollable;\r\n  }\r\n  \r\n  /* TODO: rename this function so it could be found faster\r\n   * this function adds FOLDER, not FILTER\r\n  */\r\n  private addFilter(filter: Pick<DialogFilter, 'title' | 'id' | 'orderIndex'>) {\r\n    if(filter.id === 1) {\r\n      return;\r\n    }\r\n\r\n    const containerToAppend = this.folders.menu as HTMLElement;\r\n    const renderedFilter = this.filtersRendered[filter.id];\r\n    if(renderedFilter) {\r\n      positionElementByIndex(renderedFilter.menu, containerToAppend, filter.orderIndex);\r\n      positionElementByIndex(renderedFilter.container, this.folders.container, filter.orderIndex);\r\n      return;\r\n    }\r\n\r\n    const folderButton = document.createElement('div');\r\n    folderButton.classList.add('menu-horizontal-div-item');\r\n    folderButton.classList.add('chats-group');\r\n    const titleAndUnreadSpan = document.createElement('span');\r\n    const titleSpan = document.createElement('span');\r\n    titleSpan.classList.add('text-super');\r\n    if(filter.id === 0) titleSpan.append(this.allChatsIntlElement.element);\r\n    else setInnerHTML(titleSpan, wrapEmojiText(filter.title));\r\n\r\n    const firstChats = document.createElement('ul');\r\n\r\n    this.managers.dialogsStorage.getFolderDialogs(filter.id).then((dialogs) => {\r\n      dialogs.sort((dialog_a: Dialog, dialog_b: Dialog) => dialog_b[this.indexKey] - dialog_a[this.indexKey]);\r\n      for (const dialog of dialogs) {\r\n        if (firstChats.children.length >= 2) {\r\n            const showMore = document.createElement('li');\r\n            showMore.innerText = '...';\r\n            firstChats.append(showMore);\r\n            break;\r\n          }\r\n\r\n          const dialogDom = this.addDialog(dialog.peerId, firstChats, false, null, true, null, 32);\r\n          \r\n          this.setLastMessage(dialog, null, dialogDom.dom);\r\n          setInterval(() => {\r\n            this.setLastMessage(dialog, null, dialogDom.dom);\r\n          }, 3000);\r\n      }\r\n    }); // to let dialogsStorage be initialized\r\n\r\n    const unreadSpan = document.createElement('div');\r\n    unreadSpan.classList.add('badge', 'badge-20', 'badge-primary');\r\n    const i = document.createElement('i');\r\n    titleAndUnreadSpan.append(titleSpan, unreadSpan, i);\r\n    ripple(folderButton);\r\n    folderButton.append(titleAndUnreadSpan, firstChats);\r\n\r\n    positionElementByIndex(folderButton, containerToAppend, filter.orderIndex);\r\n    //containerToAppend.append(li);\r\n\r\n    const ul = this.createChatList();\r\n    const scrollable = this.generateScrollable(ul, filter);\r\n\r\n    scrollable.container.classList.add('tabs-tab', 'chatlist-parts');\r\n\r\n    /* const parts = document.createElement('div');\r\n    parts.classList.add('chatlist-parts'); */\r\n    \r\n    const top = document.createElement('div');\r\n    top.classList.add('chatlist-top');\r\n    \r\n    const bottom = document.createElement('div');\r\n    bottom.classList.add('chatlist-bottom');\r\n\r\n    top.append(ul);\r\n    scrollable.container.append(top, bottom);\r\n    /* parts.append(top, bottom);\r\n    scrollable.container.append(parts); */\r\n    \r\n    const div = scrollable.container;\r\n    //this.folders.container.append(div);\r\n    positionElementByIndex(scrollable.container, this.folders.container, filter.orderIndex);\r\n\r\n    this.setListClickListener(ul, null, true);\r\n\r\n    this.filtersRendered[filter.id] = {\r\n      menu: folderButton,\r\n      container: div,\r\n      unread: unreadSpan,\r\n      title: titleSpan\r\n    };\r\n\r\n    this.onFiltersLengthChange();\r\n  }\r\n\r\n  private changeFiltersAllChatsKey() {\r\n    const scrollable = this.folders.menuScrollContainer.firstElementChild;\r\n    const key: LangPackKey = scrollable.scrollWidth > scrollable.clientWidth ? 'FilterAllChatsShort' : 'FilterAllChats';\r\n    this.allChatsIntlElement.compareAndUpdate({key});\r\n  }\r\n\r\n  private onFiltersLengthChange() {\r\n    if(!this.showFiltersPromise) {\r\n      this.showFiltersPromise = new Promise<void>((resolve) => {\r\n        window.setTimeout(() => {\r\n          const length = Object.keys(this.filtersRendered).length;\r\n          const show = length > 1;\r\n          const wasShowing = !this.folders.menuScrollContainer.classList.contains('hide');\r\n\r\n          if(show !== wasShowing) {\r\n            this.folders.menuScrollContainer.classList.toggle('hide', !show);\r\n            if(show && !wasShowing) {\r\n              this.setFiltersUnreadCount();\r\n            }\r\n\r\n            this.chatsContainer.classList.toggle('has-filters', show);\r\n          }\r\n\r\n          this.changeFiltersAllChatsKey();\r\n\r\n          this.showFiltersPromise = undefined;\r\n          resolve();\r\n        }, 0);\r\n      });\r\n    }\r\n\r\n    return this.showFiltersPromise;\r\n  }\r\n\r\n  private loadDialogs(side: SliceSides) {\r\n    /* if(testScroll) {\r\n      return;\r\n    } */\r\n\r\n    if(this.loadDialogsPromise || this.loadDialogsRenderPromise/*  || 1 === 1 */) return this.loadDialogsPromise;\r\n    else if(this.scroll.loadedAll[side]) {\r\n      return Promise.resolve({\r\n        cached: true,\r\n        renderPromise: Promise.resolve()\r\n      });\r\n    }\r\n\r\n    const cachedInfoPromise = deferredPromise<boolean>();\r\n    const renderPromise = new Promise<void>(async(resolve, reject) => {\r\n      const {chatList, filterId, indexKey} = this;\r\n      \r\n      //return;\r\n      \r\n      // let loadCount = 30/*this.chatsLoadCount */;\r\n      let loadCount = windowSize.height / 72 * 1.25 | 0;\r\n      let offsetIndex = 0;\r\n      \r\n      const {index: currentOffsetIndex} = this.getOffsetIndex(side);\r\n      if(currentOffsetIndex) {\r\n        if(side === 'top') {\r\n          const storage = await this.managers.dialogsStorage.getFolderDialogs(filterId, true);\r\n          const index = storage.findIndex((dialog) => getDialogIndex(dialog, indexKey) <= currentOffsetIndex);\r\n          const needIndex = Math.max(0, index - loadCount);\r\n          loadCount = index - needIndex;\r\n          offsetIndex = getDialogIndex(storage[needIndex], indexKey) + 1;\r\n        } else {\r\n          offsetIndex = currentOffsetIndex;\r\n        }\r\n      }\r\n      \r\n      //let offset = storage[storage.length - 1]?.index || 0;\r\n      \r\n      let placeholder = this.placeholders[filterId];\r\n      try {\r\n        const getConversationsResult = this.managers.acknowledged.appMessagesManager.getConversations('', offsetIndex, loadCount, filterId, true);\r\n        if(\r\n          !chatList.childElementCount && \r\n          !placeholder && \r\n          (\r\n            !this.loadedDialogsAtLeastOnce || \r\n            !(await getConversationsResult).cached\r\n          )\r\n        ) {\r\n          placeholder = this.placeholders[filterId] = new DialogsPlaceholder();\r\n          const getRectFrom = filterId === 1 ? this.chatsContainer : this.folders.container;\r\n          placeholder.attach({\r\n            container: chatList.parentElement, \r\n            getRectFrom, \r\n            onRemove: () => {\r\n              delete this.placeholders[filterId];\r\n            },\r\n            blockScrollable: this.scroll\r\n          });\r\n\r\n          cachedInfoPromise.resolve(false);\r\n        }\r\n  \r\n        const a = await getConversationsResult;\r\n        const result = await a.result;\r\n        if(this.loadDialogsRenderPromise !== renderPromise) {\r\n          reject();\r\n          cachedInfoPromise.reject();\r\n          return;\r\n        }\r\n\r\n        cachedInfoPromise.resolve(a.cached);\r\n  \r\n        //console.timeEnd('getDialogs time');\r\n  \r\n        // * loaded all\r\n        //if(!result.dialogs.length || chatList.childElementCount === result.count) {\r\n        // !result.dialogs.length  ,      getConversations   .\r\n        //if(chatList.childElementCount === result.count) {\r\n        if(side === 'bottom') {\r\n          if(result.isEnd) {\r\n            this.scroll.loadedAll[side] = true;\r\n          }\r\n        } else if(result.isTopEnd) {\r\n          this.scroll.loadedAll[side] = true;\r\n        }\r\n\r\n        this.loadedDialogsAtLeastOnce = true;\r\n        \r\n        if(result.dialogs.length) {\r\n          const dialogs = side === 'top' ? result.dialogs.slice().reverse() : result.dialogs;\r\n  \r\n          const loadPromises: Promise<any>[] = [];\r\n\r\n          const callbacks: (() => void)[] = [];\r\n          const cccc = (callback: () => void) => {\r\n            callbacks.push(callback);\r\n          };\r\n\r\n          dialogs.forEach((dialog) => {\r\n            // :(\r\n            // const isBuggedDialog = !this.managers.appMessagesManager.getDialogOnly(dialog.peerId);\r\n            // if(isBuggedDialog) {\r\n            //   return;\r\n            // }\r\n\r\n            const element = this.sortedList.add(dialog.peerId, true, /* undefined, false,  */cccc, false);\r\n            if(element.loadPromises) {\r\n              loadPromises.push(...element.loadPromises);\r\n            }\r\n          });\r\n\r\n          loadPromises.push(fastRafPromise()); // it is needed here\r\n          await Promise.all(loadPromises).finally();\r\n          if(this.loadDialogsRenderPromise !== renderPromise) {\r\n            reject();\r\n            cachedInfoPromise.reject();\r\n            return;\r\n          }\r\n\r\n          callbacks.forEach((callback) => callback());\r\n        } else {\r\n          this.onListLengthChange();\r\n        }\r\n\r\n        const offsetDialog = result.dialogs[side === 'top' ? 0 : result.dialogs.length - 1];\r\n        if(offsetDialog) {\r\n          this.offsets[side] = getDialogIndex(offsetDialog, indexKey);\r\n        }\r\n\r\n        this.log.debug('getDialogs ' + loadCount + ' dialogs by offset:', offsetIndex, result, chatList.childElementCount);\r\n  \r\n        setTimeout(() => {\r\n          this.scroll.onScroll();\r\n        }, 0);\r\n      } catch(err) {\r\n        this.log.error(err);\r\n      }\r\n      \r\n      if(placeholder) {\r\n        // await pause(500);\r\n        placeholder.detach(chatList.childElementCount);\r\n      }\r\n      \r\n      resolve();\r\n    }).finally(() => {\r\n      if(this.loadDialogsRenderPromise === renderPromise) {\r\n        this.loadDialogsRenderPromise = undefined;\r\n        this.loadDialogsPromise = undefined;\r\n      }\r\n    });\r\n\r\n    this.loadDialogsRenderPromise = renderPromise;\r\n    return this.loadDialogsPromise = cachedInfoPromise.then((cached) => ({\r\n      cached,\r\n      renderPromise\r\n    }));\r\n  }\r\n\r\n  private generateEmptyPlaceholder(options: {\r\n    title: LangPackKey,\r\n    subtitle?: LangPackKey,\r\n    subtitleArgs?: FormatterArguments,\r\n    classNameType: string\r\n  }) {\r\n    const BASE_CLASS = 'empty-placeholder';\r\n    const container = document.createElement('div');\r\n    container.classList.add(BASE_CLASS, BASE_CLASS + '-' + options.classNameType);\r\n    \r\n    const header = document.createElement('div');\r\n    header.classList.add(BASE_CLASS + '-header');\r\n    _i18n(header, options.title);\r\n\r\n    const subtitle = document.createElement('div');\r\n    subtitle.classList.add(BASE_CLASS + '-subtitle');\r\n    if(options.subtitle) {\r\n      _i18n(subtitle, options.subtitle, options.subtitleArgs);\r\n    }\r\n\r\n    container.append(header, subtitle);\r\n\r\n    return {container, header, subtitle};\r\n  }\r\n\r\n  private checkIfPlaceholderNeeded() {\r\n    if(this.filterId === 1) {\r\n      return;\r\n    }\r\n\r\n    const chatList = this.chatList;\r\n    const part = chatList.parentElement as HTMLElement;\r\n    let placeholderContainer = (Array.from(part.children) as HTMLElement[]).find((el) => el.matches('.empty-placeholder'));\r\n    const needPlaceholder = this.scroll.loadedAll.bottom && !chatList.childElementCount/*  || true */;\r\n    // chatList.style.display = 'none';\r\n\r\n    if(needPlaceholder && placeholderContainer) {\r\n      return;\r\n    } else if(!needPlaceholder) {\r\n      if(placeholderContainer) {\r\n        part.classList.remove('with-placeholder');\r\n        placeholderContainer.remove();\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    let placeholder: ReturnType<AppDialogsManager['generateEmptyPlaceholder']>, type: 'dialogs' | 'folder';\r\n    if(!this.filterId) {\r\n      placeholder = this.generateEmptyPlaceholder({\r\n        title: 'ChatList.Main.EmptyPlaceholder.Title',\r\n        classNameType: type = 'dialogs'\r\n      });\r\n      \r\n      placeholderContainer = placeholder.container;\r\n      \r\n      const img = document.createElement('img');\r\n      img.classList.add('empty-placeholder-dialogs-icon');\r\n\r\n      this.emptyDialogsPlaceholderSubtitle = new I18n.IntlElement({\r\n        element: placeholder.subtitle\r\n      });\r\n      \r\n      Promise.all([\r\n        this.updateContactsLength(false),\r\n        renderImageFromUrlPromise(img, 'assets/img/EmptyChats.svg'),\r\n        fastRafPromise()\r\n      ]).then(([usersLength]) => {\r\n        placeholderContainer.classList.add('visible');\r\n        part.classList.toggle('has-contacts', !!usersLength);\r\n      });\r\n\r\n      placeholderContainer.prepend(img);\r\n    } else {\r\n      placeholder = this.generateEmptyPlaceholder({\r\n        title: 'FilterNoChatsToDisplay',\r\n        subtitle: 'FilterNoChatsToDisplayInfo',\r\n        classNameType: type = 'folder'\r\n      });\r\n\r\n      placeholderContainer = placeholder.container;\r\n\r\n      const div = document.createElement('div');\r\n      const emoji = '';\r\n      const size = 128;\r\n      wrapStickerEmoji({\r\n        div,\r\n        emoji: emoji,\r\n        width: size,\r\n        height: size\r\n      });\r\n\r\n      placeholderContainer.prepend(div);\r\n\r\n      const button = Button('btn-primary btn-color-primary btn-control tgico', {\r\n        text: 'FilterHeaderEdit',\r\n        icon: 'settings'\r\n      });\r\n\r\n      attachClickEvent(button, async() => {\r\n        appSidebarLeft.createTab(AppEditFolderTab).open(await this.managers.filtersStorage.getFilter(this.filterId));\r\n      });\r\n\r\n      placeholderContainer.append(button);\r\n    }\r\n\r\n    part.append(placeholderContainer);\r\n    part.classList.add('with-placeholder');\r\n    part.dataset.placeholderType = type;\r\n  }\r\n\r\n  private updateContactsLength(updatePartClassName: boolean) {\r\n    if(this.updateContactsLengthPromise) return this.updateContactsLengthPromise;\r\n    return this.updateContactsLengthPromise = this.managers.appUsersManager.getContacts().then((users) => {\r\n      const subtitle = this.emptyDialogsPlaceholderSubtitle;\r\n      if(subtitle) {\r\n        let key: LangPackKey, args: FormatterArguments;\r\n        \r\n        if(users.length/*  && false */) {\r\n          key = 'ChatList.Main.EmptyPlaceholder.Subtitle';\r\n          args = [i18n('Contacts.Count', [users.length])];\r\n        } else {\r\n          key = 'ChatList.Main.EmptyPlaceholder.SubtitleNoContacts';\r\n          args = [];\r\n        }\r\n\r\n        subtitle.compareAndUpdate({\r\n          key,\r\n          args\r\n        });\r\n      }\r\n\r\n      if(updatePartClassName) {\r\n        const chatList = this.chatList;\r\n        const part = chatList.parentElement as HTMLElement;\r\n        part.classList.toggle('has-contacts', !!users.length);\r\n      }\r\n\r\n      this.updateContactsLengthPromise = undefined;\r\n      \r\n      return users.length;\r\n    });\r\n  }\r\n\r\n  private removeContactsPlaceholder() {\r\n    const chatList = this.chatList;\r\n    const parts = chatList.parentElement.parentElement;\r\n    const bottom = chatList.parentElement.nextElementSibling as HTMLElement;\r\n    parts.classList.remove('with-contacts');\r\n    bottom.innerHTML = '';\r\n    this.loadContacts = undefined;\r\n    this.processContact = undefined;\r\n  }\r\n\r\n  private _onListLengthChange = () => {\r\n    if(!this.loadedDialogsAtLeastOnce) {\r\n      return;\r\n    }\r\n\r\n    this.checkIfPlaceholderNeeded();\r\n\r\n    if(this.filterId > 0) return;\r\n\r\n    const chatList = this.chatList;\r\n    const count = chatList.childElementCount;\r\n\r\n    const parts = chatList.parentElement.parentElement;\r\n    const bottom = chatList.parentElement.nextElementSibling as HTMLElement;\r\n    const hasContacts = !!bottom.childElementCount;\r\n    if(count >= 10) {\r\n      if(hasContacts) {\r\n        this.removeContactsPlaceholder();\r\n      }\r\n\r\n      return;\r\n    } else if(hasContacts) return;\r\n\r\n    parts.classList.add('with-contacts');\r\n\r\n    const section = new SettingSection({\r\n      name: 'Contacts',\r\n      noDelimiter: true,\r\n      fakeGradientDelimiter: true\r\n    });\r\n\r\n    section.container.classList.add('hide');\r\n\r\n    this.managers.appUsersManager.getContactsPeerIds(undefined, undefined, 'online').then((contacts) => {\r\n      let ready = false;\r\n      const onListLengthChange = () => {\r\n        if(ready) {\r\n          section.container.classList.toggle('hide', !sortedUserList.list.childElementCount);\r\n        }\r\n\r\n        this.updateContactsLength(true);\r\n      };\r\n\r\n      const sortedUserList = new SortedUserList({\r\n        avatarSize: 42, \r\n        createChatListOptions: {\r\n          dialogSize: 48,\r\n          new: true\r\n        },\r\n        autonomous: false, \r\n        onListLengthChange,\r\n        managers: this.managers\r\n      });\r\n\r\n      this.loadContacts = () => {\r\n        const pageCount = windowSize.height / 60 | 0;\r\n        const arr = contacts.splice(0, pageCount).filter(this.verifyPeerIdForContacts);\r\n\r\n        arr.forEach((peerId) => {\r\n          sortedUserList.add(peerId);\r\n        });\r\n\r\n        if(!contacts.length) {\r\n          this.loadContacts = undefined;\r\n        }\r\n      };\r\n\r\n      this.loadContacts();\r\n\r\n      this.processContact = (peerId) => {\r\n        if(peerId.isAnyChat()) {\r\n          return;\r\n        }\r\n\r\n        const good = this.verifyPeerIdForContacts(peerId);\r\n        const added = sortedUserList.has(peerId);\r\n        if(!added && good) sortedUserList.add(peerId);\r\n        else if(added && !good) sortedUserList.delete(peerId);\r\n      };\r\n\r\n      const list = sortedUserList.list;\r\n      list.classList.add('chatlist-new');\r\n      this.setListClickListener(list);\r\n      section.content.append(list);\r\n\r\n      ready = true;\r\n      onListLengthChange();\r\n    });\r\n\r\n    bottom.append(section.container);\r\n  };\r\n\r\n  private verifyPeerIdForContacts = async(peerId: PeerId) => {\r\n    return await this.managers.appPeersManager.isContact(peerId) && !(await this.managers.appMessagesManager.getDialogOnly(peerId));\r\n  };\r\n\r\n  public onChatsRegularScroll = () => {\r\n    // return;\r\n\r\n    if(this.sliceTimeout) clearTimeout(this.sliceTimeout);\r\n    this.sliceTimeout = window.setTimeout(() => {\r\n      this.sliceTimeout = undefined;\r\n\r\n      if(!this.chatList.childElementCount || this.processContact) {\r\n        return;\r\n      }\r\n\r\n      /* const observer = new IntersectionObserver((entries) => {\r\n        const \r\n      });\r\n\r\n      Array.from(this.chatList.children).forEach((el) => {\r\n        observer.observe(el);\r\n      }); */\r\n\r\n      fastRafConventional(() => {\r\n\r\n      const perf = performance.now();\r\n\r\n      const scrollTopWas = this.scroll.scrollTop;\r\n\r\n      const firstElementChild = this.chatList.firstElementChild;\r\n      const rectContainer = this.scroll.container.getBoundingClientRect();\r\n      const rectTarget = firstElementChild.getBoundingClientRect();\r\n      const children = Array.from(this.scroll.splitUp.children) as HTMLElement[];\r\n\r\n      // const padding = 8;\r\n      // const offsetTop = this.folders.container.offsetTop;\r\n      let offsetTop = this.scroll.splitUp.offsetTop;\r\n      if(offsetTop && scrollTopWas < offsetTop) offsetTop -= scrollTopWas;\r\n      // const offsetTop = scrollTopWas < padding ? padding - scrollTopWas : 0;\r\n      const firstY = rectContainer.y + offsetTop;\r\n      const lastY = rectContainer.y/*  - 8 */; // 8px - .chatlist padding-bottom\r\n      \r\n      const firstElement = findUpTag(document.elementFromPoint(Math.ceil(rectTarget.x), Math.ceil(firstY + 1)), firstElementChild.tagName) as HTMLElement;\r\n      const lastElement = findUpTag(document.elementFromPoint(Math.ceil(rectTarget.x), Math.floor(lastY + rectContainer.height - 1)), firstElementChild.tagName) as HTMLElement;\r\n\r\n      //alert('got element:' + rect.y);\r\n\r\n      if(!firstElement || !lastElement) {\r\n        return;\r\n      }\r\n\r\n      //alert('got element:' + !!firstElement);\r\n\r\n      const firstElementRect = firstElement.getBoundingClientRect();\r\n      const elementOverflow = firstElementRect.y - firstY;\r\n\r\n      const sliced: HTMLElement[] = [];\r\n      const firstIndex = children.indexOf(firstElement);\r\n      const lastIndex = children.indexOf(lastElement);\r\n\r\n      const saveLength = 10;\r\n\r\n      const sliceFromStart = IS_SAFARI ? [] : children.slice(0, Math.max(0, firstIndex - saveLength));\r\n      const sliceFromEnd = children.slice(lastIndex + saveLength);\r\n\r\n      /* if(sliceFromStart.length !== sliceFromEnd.length) {\r\n        console.log('not equal', sliceFromStart.length, sliceFromEnd.length);\r\n      }\r\n\r\n      if(sliceFromStart.length > sliceFromEnd.length) {\r\n        const diff = sliceFromStart.length - sliceFromEnd.length;\r\n        sliceFromStart.splice(0, diff);\r\n      } else if(sliceFromEnd.length > sliceFromStart.length) {\r\n        const diff = sliceFromEnd.length - sliceFromStart.length;\r\n        sliceFromEnd.splice(sliceFromEnd.length - diff, diff);\r\n      } */\r\n\r\n      if(sliceFromStart.length) {\r\n        this.scroll.loadedAll.top = false;\r\n      }\r\n\r\n      if(sliceFromEnd.length) {\r\n        this.scroll.loadedAll.bottom = false;\r\n      }\r\n\r\n      sliced.push(...sliceFromStart);\r\n      sliced.push(...sliceFromEnd);\r\n\r\n      sliced.forEach((el) => {\r\n        const peerId = el.dataset.peerId.toPeerId();\r\n        this.deleteDialog(peerId);\r\n      });\r\n\r\n      this.setOffsets();\r\n\r\n      //this.log('[slicer] elements', firstElement, lastElement, rect, sliced, sliceFromStart.length, sliceFromEnd.length);\r\n\r\n      //this.log('[slicer] reset scrollTop', this.scroll.scrollTop, firstElement.offsetTop, firstElementRect.y, rect.y, elementOverflow);\r\n\r\n      //alert('left length:' + children.length);\r\n\r\n      this.scroll.scrollTop = firstElement.offsetTop - elementOverflow;\r\n\r\n      this.log('slice time', performance.now() - perf);\r\n      /* const firstElementRect = firstElement.getBoundingClientRect();\r\n      const scrollTop =  */\r\n\r\n      //this.scroll.scrollIntoView(firstElement, false);\r\n    });\r\n    }, 200);\r\n  };\r\n\r\n  private async setOffsets() {\r\n    const chatList = this.chatList;\r\n    const firstDialog = await this.getDialogFromElement(chatList.firstElementChild as HTMLElement);\r\n    const lastDialog = await this.getDialogFromElement(chatList.lastElementChild as HTMLElement);\r\n\r\n    const indexKey = this.indexKey;\r\n    this.offsets.top = getDialogIndex(firstDialog, indexKey);\r\n    this.offsets.bottom = getDialogIndex(lastDialog, indexKey);\r\n  }\r\n\r\n  private getDialogFromElement(element: HTMLElement) {\r\n    return this.managers.appMessagesManager.getDialogOnly(element.dataset.peerId.toPeerId());\r\n  }\r\n\r\n  public onChatsScrollTop = () => {\r\n    return this.onChatsScroll('top');\r\n  };\r\n  \r\n  public onChatsScroll = (side: SliceSides = 'bottom') => {\r\n    if(this.scroll.loadedAll[side]) {\r\n      if(this.loadContacts) {\r\n        this.loadContacts();\r\n      }\r\n    }\r\n\r\n    this.log('onChatsScroll', side);\r\n    return this.loadDialogs(side);\r\n  };\r\n\r\n  public setListClickListener(list: HTMLUListElement, onFound?: () => void, withContext = false, autonomous = false, openInner = false) {\r\n    let lastActiveListElement: HTMLElement;\r\n\r\n    const setPeerFunc = (openInner ? appImManager.setInnerPeer : appImManager.setPeer).bind(appImManager);\r\n\r\n    list.dataset.autonomous = '' + +autonomous;\r\n    list.addEventListener('mousedown', (e) => {\r\n      if(e.button !== 0) return;\r\n      \r\n      this.log('dialogs click list');\r\n      const target = e.target as HTMLElement;\r\n      const elem = findUpTag(target, DIALOG_LIST_ELEMENT_TAG);\r\n      \r\n      if(!elem) {\r\n        return;\r\n      }\r\n\r\n      const peerId = elem.dataset.peerId.toPeerId();\r\n\r\n      if(e.ctrlKey || e.metaKey) {\r\n        window.open((elem as HTMLAnchorElement).href || ('#' + peerId), '_blank');\r\n        cancelEvent(e);\r\n        return;\r\n      }\r\n\r\n      if(autonomous) {\r\n        const sameElement = lastActiveListElement === elem;\r\n        if(lastActiveListElement && !sameElement) {\r\n          lastActiveListElement.classList.remove('active');\r\n        }\r\n\r\n        if(elem) {\r\n          elem.classList.add('active');\r\n          lastActiveListElement = elem;\r\n          this.lastActiveElements.add(elem);\r\n        }\r\n      }\r\n\r\n      if(elem) {\r\n        if(onFound) onFound();\r\n\r\n        const lastMsgId = +elem.dataset.mid || undefined;\r\n\r\n        setPeerFunc({\r\n          peerId, lastMsgId\r\n        });\r\n      } else {\r\n        setPeerFunc();\r\n      }\r\n    }, {capture: true});\r\n\r\n    // cancel link click\r\n    // ! do not change it to attachClickEvent\r\n    list.addEventListener('click', (e) => {\r\n      if(e.button === 0) {\r\n        cancelEvent(e);\r\n      }\r\n    }, {capture: true});\r\n\r\n    if(DEBUG) {\r\n      list.addEventListener('dblclick', (e) => {\r\n        const li = findUpTag(e.target, DIALOG_LIST_ELEMENT_TAG);\r\n        if(li) {\r\n          const peerId = li.dataset.peerId.toPeerId();\r\n          this.log('debug dialog:', this.managers.appMessagesManager.getDialogByPeerId(peerId));\r\n        }\r\n      });\r\n    }\r\n\r\n    if(withContext) {\r\n      attachContextMenuListener(list, this.contextMenu.onContextMenu);\r\n    }\r\n  }\r\n\r\n  public createChatList(options: {\r\n    // avatarSize?: number,\r\n    // handheldsSize?: number,\r\n    // size?: number,\r\n    new?: boolean,\r\n    dialogSize?: number,\r\n    ignoreClick?: boolean\r\n  } = {}) {\r\n    const list = document.createElement('ul');\r\n    list.classList.add('chatlist'/* , \r\n      'chatlist-avatar-' + (options.avatarSize || 54) *//* , 'chatlist-' + (options.size || 72) */);\r\n\r\n    if(options.new) {\r\n      list.classList.add('chatlist-new');\r\n    }\r\n\r\n    if(options.dialogSize) {\r\n      list.classList.add('chatlist-' + options.dialogSize);\r\n    }\r\n\r\n    // if(options.ignoreClick) {\r\n    //   list.classList.add('disable-hover');\r\n    // }\r\n\r\n    /* if(options.handheldsSize) {\r\n      list.classList.add('chatlist-handhelds-' + options.handheldsSize);\r\n    } */\r\n\r\n    return list;\r\n  }\r\n\r\n  public setLastMessageN(options: {\r\n    dialog: Dialog, \r\n    lastMessage?: Message.message | Message.messageService, \r\n    dom?: DialogDom, \r\n    highlightWord?: string, \r\n    isBatch?: boolean,\r\n    setUnread?: boolean\r\n  }) {\r\n    const promise = this.setLastMessage(options.dialog, options.lastMessage, options.dom, options.highlightWord, options.isBatch, options.setUnread);\r\n    return promise.catch(noop);\r\n  }\r\n\r\n  private async setLastMessage(\r\n    dialog: Dialog, \r\n    lastMessage: Message.message | Message.messageService, \r\n    dom: DialogDom, \r\n    highlightWord?: string, \r\n    isBatch = false,\r\n    setUnread = false\r\n  ) {\r\n    if(!dom) {\r\n      dom = this.getDialogDom(dialog.peerId);\r\n\r\n      if(!dom) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    const {deferred: promise, middleware} = setPromiseMiddleware(dom, 'setLastMessagePromise');\r\n\r\n    let draftMessage: MyDraftMessage;\r\n    if(!lastMessage) {\r\n      if(dialog.draft?._ === 'draftMessage') {\r\n        draftMessage = dialog.draft;\r\n      }\r\n\r\n      lastMessage = dialog.topMessage;\r\n      if(!lastMessage || lastMessage.mid !== dialog.top_message) {\r\n        const promise = this.managers.appMessagesManager.getMessageByPeer(dialog.peerId, dialog.top_message);\r\n        lastMessage = await middleware(promise);\r\n      }\r\n    }\r\n\r\n    if(setUnread) {\r\n      this.setUnreadMessagesN({dialog, dom, isBatch, setLastMessagePromise: promise});\r\n    }\r\n\r\n    if(!lastMessage/*  || (lastMessage._ === 'messageService' && !lastMessage.rReply) */) {\r\n      dom.lastMessageSpan.textContent = '';\r\n      dom.lastTimeSpan.textContent = '';\r\n      delete dom.listEl.dataset.mid;\r\n\r\n      promise.resolve();\r\n      return;\r\n    }\r\n\r\n    const peerId = dialog.peerId;\r\n    const isRestricted = lastMessage && isMessageRestricted(lastMessage as Message.message);\r\n\r\n    /* if(!dom.lastMessageSpan.classList.contains('user-typing')) */ {\r\n      let mediaContainer: HTMLElement;\r\n      const willPrepend: (Promise<any> | HTMLElement)[] = [];\r\n      if(lastMessage && !draftMessage && !isRestricted) {\r\n        const media: MyDocument | MyPhoto = getMediaFromMessage(lastMessage);\r\n        const videoTypes: Set<MyDocument['type']> = new Set(['video', 'gif', 'round']);\r\n        if(media && (media._ === 'photo' || videoTypes.has(media.type))) {\r\n          const size = choosePhotoSize(media, 20, 20);\r\n\r\n          if(size._ !== 'photoSizeEmpty') {\r\n            mediaContainer = document.createElement('div');\r\n            mediaContainer.classList.add('dialog-subtitle-media');\r\n\r\n            if((media as MyDocument).type === 'round') {\r\n              mediaContainer.classList.add('is-round');\r\n            }\r\n            \r\n            willPrepend.push(wrapPhoto({\r\n              photo: media,\r\n              message: lastMessage,\r\n              container: mediaContainer,\r\n              withoutPreloader: true,\r\n              size\r\n            }).then(() => mediaContainer));\r\n\r\n            if(videoTypes.has((media as MyDocument).type)) {\r\n              const playIcon = document.createElement('span');\r\n              playIcon.classList.add('tgico-play');\r\n\r\n              mediaContainer.append(playIcon);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      /* if(lastMessage.from_id === auth.id) { // You:  */\r\n      if(draftMessage) {\r\n        const bold = document.createElement('b');\r\n        bold.classList.add('danger');\r\n        bold.append(i18n('Draft'), ': ');\r\n        willPrepend.unshift(bold);\r\n      } else if(peerId.isAnyChat() && peerId !== lastMessage.fromId && !(lastMessage as Message.messageService).action) {\r\n        const senderBold = document.createElement('b');\r\n\r\n        if(lastMessage.fromId === rootScope.myId) {\r\n          senderBold.append(i18n('FromYou'));\r\n          willPrepend.unshift(senderBold);\r\n        } else {\r\n          //str = sender.first_name || sender.last_name || sender.username;\r\n          const p = middleware(wrapPeerTitle({\r\n            peerId: lastMessage.fromId,\r\n            onlyFirstName: true,\r\n          })).then((element) => {\r\n            senderBold.prepend(element);\r\n            return senderBold;\r\n          }, noop);\r\n\r\n          willPrepend.unshift(p);\r\n        }\r\n\r\n        senderBold.append(': ');\r\n        //console.log(sender, senderBold.innerText);\r\n      }\r\n\r\n      const withoutMediaType = !!mediaContainer && !!(lastMessage as Message.message)?.message;\r\n\r\n      let fragment: DocumentFragment;\r\n      if(highlightWord && (lastMessage as Message.message).message) {\r\n        fragment = await middleware(wrapMessageForReply(lastMessage, undefined, undefined, false, highlightWord, withoutMediaType));\r\n      } else if(draftMessage) {\r\n        fragment = await middleware(wrapMessageForReply(draftMessage));\r\n      } else if(lastMessage) {\r\n        fragment = await middleware(wrapMessageForReply(lastMessage, undefined, undefined, false, undefined, withoutMediaType));\r\n      } else { // rare case\r\n        fragment = document.createDocumentFragment();\r\n      }\r\n\r\n      if(willPrepend.length) {\r\n        const elements = await middleware(Promise.all(willPrepend));\r\n        fragment.prepend(...elements);\r\n      }\r\n\r\n      replaceContent(dom.lastMessageSpan, fragment);\r\n    }\r\n\r\n    if(lastMessage || draftMessage/*  && lastMessage._ !== 'draftMessage' */) {\r\n      const date = draftMessage ? Math.max(draftMessage.date, lastMessage.date || 0) : lastMessage.date;\r\n      replaceContent(dom.lastTimeSpan, formatDateAccordingToTodayNew(new Date(date * 1000)));\r\n    } else dom.lastTimeSpan.textContent = '';\r\n\r\n    if(setUnread !== null && !setUnread) { // means search\r\n      dom.listEl.dataset.mid = '' + lastMessage.mid;\r\n    }\r\n\r\n    promise.resolve();\r\n  }\r\n\r\n  private setUnreadMessagesN(options: {\r\n    dialog: Dialog,\r\n    dom?: DialogDom,\r\n    isBatch?: boolean,\r\n    setLastMessagePromise?: Promise<void>\r\n  }) {\r\n    return this.setUnreadMessages(options.dialog, options.dom, options.isBatch, options.setLastMessagePromise).catch(() => {});\r\n  }\r\n\r\n  private async setUnreadMessages(\r\n    dialog: Dialog, \r\n    dom = this.getDialogDom(dialog.peerId), \r\n    isBatch = false,\r\n    setLastMessagePromise?: Promise<void>\r\n  ) {\r\n    if(!dom) {\r\n      //this.log.error('setUnreadMessages no dom!', dialog);\r\n      return;\r\n    }\r\n\r\n    const {deferred, middleware} = setPromiseMiddleware(dom, 'setUnreadMessagePromise');\r\n\r\n    const isMuted = await middleware(this.managers.appNotificationsManager.isPeerLocalMuted(dialog.peerId, true));\r\n    const wasMuted = dom.listEl.classList.contains('is-muted');\r\n\r\n    let setStatusMessage: MyMessage;\r\n    if(dialog.draft?._ !== 'draftMessage') {\r\n      const lastMessage: MyMessage = await middleware(this.managers.appMessagesManager.getMessageByPeer(dialog.peerId, dialog.top_message));\r\n      if(lastMessage && lastMessage.pFlags.out && lastMessage.peerId !== rootScope.myId) {\r\n        setStatusMessage = lastMessage;\r\n      }\r\n    }\r\n\r\n    const filter = await middleware(this.managers.filtersStorage.getFilter(this.filterId));\r\n    let isPinned: boolean;\r\n    if(filter) {\r\n      isPinned = filter.pinnedPeerIds.indexOf(dialog.peerId) !== -1;\r\n    } else {\r\n      isPinned = !!dialog.pFlags.pinned;\r\n    }\r\n\r\n    const isDialogUnread = await middleware(this.managers.appMessagesManager.isDialogUnread(dialog));\r\n    const hasUnreadBadge = isPinned || isDialogUnread;\r\n    // dom.messageEl.classList.toggle('has-badge', hasBadge);\r\n\r\n    // * have to await all promises before modifying something\r\n\r\n    if(setLastMessagePromise) {\r\n      try {\r\n        await middleware(setLastMessagePromise);\r\n      } catch(err) {\r\n        // return;\r\n      }\r\n    }\r\n\r\n    const transitionDuration = isBatch ? 0 : 200;\r\n\r\n    if(isMuted !== wasMuted) {\r\n      SetTransition(dom.listEl, 'is-muted', isMuted, transitionDuration);\r\n    }\r\n\r\n    setSendingStatus(dom.statusSpan, setStatusMessage, true);\r\n\r\n    const isUnreadBadgeMounted = isInDOM(dom.unreadBadge);\r\n    if(hasUnreadBadge && !isUnreadBadgeMounted) {\r\n      dom.subtitleEl.append(dom.unreadBadge);\r\n    }\r\n\r\n    const hasMentionsBadge = dialog.unread_mentions_count && (dialog.unread_mentions_count > 1 || dialog.unread_count > 1);\r\n    const isMentionBadgeMounted = dom.mentionsBadge && isInDOM(dom.mentionsBadge);\r\n    if(hasMentionsBadge) {\r\n      if(!dom.mentionsBadge) {\r\n        dom.mentionsBadge = document.createElement('div');\r\n        dom.mentionsBadge.className = 'dialog-subtitle-badge badge badge-24 mention mention-badge';\r\n        dom.mentionsBadge.innerText = '@';\r\n        dom.subtitleEl.insertBefore(dom.mentionsBadge, dom.lastMessageSpan.nextSibling);\r\n      }\r\n    }\r\n\r\n    SetTransition(dom.unreadBadge, 'is-visible', hasUnreadBadge, transitionDuration, hasUnreadBadge ? undefined : () => {\r\n      dom.unreadBadge.remove();\r\n    }, !isUnreadBadgeMounted ? 2 : 0);\r\n\r\n    if(dom.mentionsBadge) {\r\n      SetTransition(dom.mentionsBadge, 'is-visible', hasMentionsBadge, transitionDuration, hasMentionsBadge ? undefined : () => {\r\n        dom.mentionsBadge.remove();\r\n        delete dom.mentionsBadge;\r\n      }, !isMentionBadgeMounted ? 2 : 0);\r\n    }\r\n\r\n    if(!hasUnreadBadge) {\r\n      deferred.resolve();\r\n      return;\r\n    }\r\n\r\n    if(isPinned) {\r\n      dom.unreadBadge.classList.add('tgico-chatspinned', 'tgico');\r\n    } else {\r\n      dom.unreadBadge.classList.remove('tgico-chatspinned', 'tgico');\r\n    }\r\n\r\n    let isUnread = true, isMention = false;\r\n    if(dialog.unread_mentions_count && dialog.unread_count === 1) {\r\n      dom.unreadBadge.innerText = '@';\r\n      isMention = true;\r\n      // dom.unreadBadge.classList.add('tgico-mention', 'tgico');\r\n    } else if(isDialogUnread) {\r\n      //dom.unreadMessagesSpan.innerText = '' + (dialog.unread_count ? formatNumber(dialog.unread_count, 1) : ' ');\r\n      dom.unreadBadge.innerText = '' + (dialog.unread_count || ' ');\r\n    } else {\r\n      dom.unreadBadge.innerText = '';\r\n      isUnread = false;\r\n    }\r\n\r\n    dom.unreadBadge.classList.toggle('unread', isUnread);\r\n    dom.unreadBadge.classList.toggle('mention', isMention);\r\n    deferred.resolve();\r\n  }\r\n\r\n  private getDialogDom(peerId: PeerId) {\r\n    // return this.doms[peerId];\r\n    const element = this.sortedList.get(peerId);\r\n    return element?.dom;\r\n  }\r\n\r\n  private async getDialog(dialog: Dialog | PeerId) {\r\n    if(typeof(dialog) !== 'object') {\r\n      const originalDialog = await this.managers.appMessagesManager.getDialogOnly(dialog);\r\n      if(!originalDialog) {\r\n        const peerId = dialog || NULL_PEER_ID;\r\n        return {\r\n          peerId,\r\n          peer: await this.managers.appPeersManager.getOutputPeer(peerId),\r\n          pFlags: {}\r\n        } as any as Dialog;\r\n      }\r\n\r\n      return originalDialog;\r\n    }\r\n    \r\n    return dialog as Dialog;\r\n  }\r\n\r\n  private setCallStatus(dom: DialogDom, visible: boolean) {\r\n    let {callIcon, listEl} = dom;\r\n    if(!callIcon && visible) {\r\n      const {canvas, startAnimation} = dom.callIcon = callIcon = groupCallActiveIcon(listEl.classList.contains('active'));\r\n      canvas.classList.add('dialog-group-call-icon');\r\n      listEl.append(canvas);\r\n      startAnimation();\r\n    }\r\n\r\n    if(!callIcon) {\r\n      return;\r\n    }\r\n\r\n    SetTransition(dom.callIcon.canvas, 'is-visible', visible, 200, visible ? undefined : () => {\r\n      dom.callIcon.canvas.remove();\r\n      dom.callIcon = undefined;\r\n    }, visible ? 2 : 0);\r\n  }\r\n\r\n  public addListDialog(options: Parameters<AppDialogsManager['addDialogNew']>[0] & {isBatch?: boolean}) {\r\n    options.autonomous = false;\r\n    \r\n    const ret = this.addDialogNew(options);\r\n    \r\n    if(ret) {\r\n      const promise = this.getDialog(options.peerId).then((dialog) => {\r\n        const {peerId} = dialog;\r\n        const promises: Promise<any>[] = [];\r\n        if(!peerId.isUser()) {\r\n          promises.push(this.processDialogForCallStatus(dialog, ret.dom));\r\n        }\r\n\r\n        if(peerId !== rootScope.myId && peerId.isUser()) {\r\n          promises.push(this.managers.appUsersManager.getUser(peerId).then((user) => {\r\n            if(user.status?._ === 'userStatusOnline') {\r\n              this.setOnlineStatus(ret.dom.avatarEl, true);\r\n            }\r\n          }));\r\n        }\r\n  \r\n        promises.push(this.setLastMessageN({\r\n          dialog,\r\n          dom: ret.dom,\r\n          isBatch: options.isBatch,\r\n          setUnread: true\r\n        }));\r\n\r\n        return Promise.all(promises);\r\n      });\r\n\r\n      if(options.loadPromises) {\r\n        options.loadPromises.push(promise);\r\n      }\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  private async processDialogForCallStatus(dialog: Dialog, dom?: DialogDom) {\r\n    if(!IS_GROUP_CALL_SUPPORTED) {\r\n      return;\r\n    }\r\n\r\n    if(!dom) dom = this.getDialogDom(dialog.peerId);\r\n    if(!dom) return;\r\n    \r\n    const chat: Chat.chat | Chat.channel = await this.managers.appChatsManager.getChat(dialog.peerId.toChatId());\r\n    this.setCallStatus(dom, !!(chat.pFlags.call_active && chat.pFlags.call_not_empty));\r\n  }\r\n\r\n  /**\r\n   * use for rendering search result\r\n   */\r\n  public addDialogAndSetLastMessage(options: Omit<Parameters<AppDialogsManager['addDialogNew']>[0], 'dialog'> & {\r\n    message: MyMessage, \r\n    peerId: PeerId,\r\n    query?: string\r\n  }) {\r\n    const {peerId, message, query} = options;\r\n    const ret = this.addDialogNew({\r\n      ...options,\r\n      ...getMessageSenderPeerIdOrName(message),\r\n      peerId,\r\n    });\r\n\r\n    this.setLastMessage({_: 'dialog', peerId} as any, message, ret.dom, query);\r\n\r\n    if(message.peerId !== peerId) {\r\n      ret.dom.listEl.dataset.peerId = '' + message.peerId;\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  public addDialogNew(options: {\r\n    peerId: Parameters<AppDialogsManager['addDialog']>[0],\r\n    container?: Parameters<AppDialogsManager['addDialog']>[1],\r\n    rippleEnabled?: boolean,\r\n    onlyFirstName?: boolean,\r\n    meAsSaved?: boolean,\r\n    append?: boolean,\r\n    avatarSize?: number,\r\n    autonomous?: boolean,\r\n    lazyLoadQueue?: LazyLoadQueue,\r\n    loadPromises?: Promise<any>[],\r\n    fromName?: string\r\n  }) {\r\n    return this.addDialog(options.peerId, options.container, options.rippleEnabled, options.onlyFirstName, options.meAsSaved, options.append, options.avatarSize, options.autonomous, options.lazyLoadQueue, options.loadPromises, options.fromName);\r\n  }\r\n\r\n  public addDialog(\r\n    peerId: PeerId, \r\n    container?: HTMLElement | Scrollable | DocumentFragment | false, \r\n    rippleEnabled = true, \r\n    onlyFirstName = false, \r\n    meAsSaved = true, \r\n    append = true, \r\n    avatarSize = 54, \r\n    autonomous = !!container, \r\n    lazyLoadQueue?: LazyLoadQueue,\r\n    loadPromises?: Promise<any>[],\r\n    fromName?: string\r\n  ) {\r\n    // const dialog = await this.getDialog(_dialog);\r\n    const avatarEl = new AvatarElement();\r\n    avatarEl.classList.add('dialog-avatar', 'avatar-' + avatarSize);\r\n    avatarEl.updateWithOptions({\r\n      loadPromises,\r\n      lazyLoadQueue,\r\n      isDialog: !!meAsSaved,\r\n      peerId,\r\n      peerTitle: fromName\r\n    });\r\n\r\n    const captionDiv = document.createElement('div');\r\n    captionDiv.classList.add('user-caption');\r\n\r\n    const titleSpanContainer = document.createElement('span');\r\n    titleSpanContainer.classList.add('user-title');\r\n\r\n    const peerTitle = new PeerTitle();\r\n    const peerTitlePromise = peerTitle.update({\r\n      peerId,\r\n      fromName,\r\n      dialog: meAsSaved,\r\n      onlyFirstName,\r\n      plainText: false\r\n    });\r\n\r\n    if(loadPromises) {\r\n      loadPromises.push(peerTitlePromise);\r\n    }\r\n\r\n    titleSpanContainer.append(peerTitle.element);\r\n    //p.classList.add('')\r\n\r\n    //        (  -   )\r\n    //if(!container) {\r\n      \r\n      // for muted icon\r\n      titleSpanContainer.classList.add('tgico'); // *       !container,  \r\n      \r\n      const titleIconsPromise = generateTitleIcons(peerId).then((elements) => {\r\n        titleSpanContainer.append(...elements);\r\n      });\r\n\r\n      if(loadPromises) {\r\n        loadPromises.push(titleIconsPromise);\r\n      }\r\n    //}\r\n    \r\n    const span = document.createElement('span');\r\n    span.classList.add('user-last-message');\r\n    span.setAttribute('dir', 'auto');\r\n\r\n    //captionDiv.append(titleSpan);\r\n    //captionDiv.append(span);\r\n\r\n    const li = document.createElement(DIALOG_LIST_ELEMENT_TAG);\r\n    li.classList.add('chatlist-chat');\r\n    if(!autonomous) (li as HTMLAnchorElement).href = '#' + peerId;\r\n    if(rippleEnabled) {\r\n      ripple(li);\r\n    }\r\n\r\n    li.append(avatarEl, captionDiv);\r\n    li.dataset.peerId = '' + peerId;\r\n\r\n    const statusSpan = document.createElement('span');\r\n    statusSpan.classList.add('message-status', 'sending-status'/* , 'transition', 'reveal' */);\r\n\r\n    const lastTimeSpan = document.createElement('span');\r\n    lastTimeSpan.classList.add('message-time');\r\n\r\n    const unreadBadge = document.createElement('div');\r\n    unreadBadge.className = 'dialog-subtitle-badge badge badge-24';\r\n\r\n    const titleP = document.createElement('p');\r\n    titleP.classList.add('dialog-title');\r\n\r\n    const rightSpan = document.createElement('span');\r\n    rightSpan.classList.add('dialog-title-details');\r\n    rightSpan.append(statusSpan, lastTimeSpan);\r\n    titleP.append(titleSpanContainer, rightSpan);\r\n\r\n    const subtitleEl = document.createElement('p');\r\n    subtitleEl.classList.add('dialog-subtitle');\r\n    subtitleEl.append(span);\r\n\r\n    captionDiv.append(titleP, subtitleEl);\r\n\r\n    const dom: DialogDom = {\r\n      avatarEl,\r\n      captionDiv,\r\n      titleSpan: peerTitle.element,\r\n      titleSpanContainer,\r\n      statusSpan,\r\n      lastTimeSpan,\r\n      unreadBadge,\r\n      lastMessageSpan: span,\r\n      containerEl: li,\r\n      listEl: li,\r\n      subtitleEl\r\n    };\r\n\r\n    /* let good = false;\r\n    for(const folderId in this.chatLists) {\r\n      if(this.chatLists[folderId] === container) {\r\n        good = true;\r\n      }\r\n    } */\r\n    if(container) {\r\n      const method = append ? 'append' : 'prepend';\r\n      container[method](li);\r\n    }\r\n\r\n    if(!autonomous) {\r\n      // @ts-ignore\r\n      li.dialogDom = dom;\r\n\r\n      if(appImManager.chat?.peerId === peerId) {\r\n        this.setDialogActive(li, true);\r\n      }\r\n    } \r\n    \r\n    return {dom};\r\n  }\r\n\r\n  public async setTyping(dialog: Dialog) {\r\n    const dom = this.getDialogDom(dialog.peerId);\r\n    if(!dom) {\r\n      return;\r\n    }\r\n\r\n    const oldTypingElement = dom.lastMessageSpan.querySelector('.peer-typing-container') as HTMLElement;\r\n    const newTypingElement = await appImManager.getPeerTyping(dialog.peerId, oldTypingElement);\r\n    if(!oldTypingElement && newTypingElement) {\r\n      replaceContent(dom.lastMessageSpan, newTypingElement);\r\n      dom.lastMessageSpan.classList.add('user-typing');\r\n    }\r\n  }\r\n\r\n  public unsetTyping(dialog: Dialog) {\r\n    const dom = this.getDialogDom(dialog.peerId);\r\n    if(!dom) {\r\n      return;\r\n    }\r\n\r\n    dom.lastMessageSpan.classList.remove('user-typing');\r\n    this.setLastMessageN({\r\n      dialog, \r\n      lastMessage: null, \r\n      dom,\r\n      setUnread: null\r\n    });\r\n  }\r\n}\r\n\r\nconst appDialogsManager = new AppDialogsManager();\r\nMOUNT_CLASS_TO.appDialogsManager = appDialogsManager;\r\nexport default appDialogsManager;\r\n","!function(e,t){\"object\"==typeof exports&&\"object\"==typeof module?module.exports=t():\"function\"==typeof define&&define.amd?define([],t):\"object\"==typeof exports?exports.Recorder=t():e.Recorder=t()}(\"undefined\"!=typeof self?self:this,(function(){return function(e){var t={};function o(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,i){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},o.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var n in e)o.d(i,n,function(t){return e[t]}.bind(null,n));return i},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,\"a\",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p=\"\",o(o.s=0)}([function(e,t,o){\"use strict\";(function(t){var o=t.AudioContext||t.webkitAudioContext,i=function(e){if(!i.isRecordingSupported())throw new Error(\"Recording is not supported in this browser\");e||(e={}),this.state=\"inactive\",this.config=Object.assign({bufferLength:4096,encoderApplication:2049,encoderFrameSize:20,encoderPath:\"encoderWorker.min.js\",encoderSampleRate:48e3,maxFramesPerPage:40,mediaTrackConstraints:!0,monitorGain:0,numberOfChannels:1,recordingGain:1,resampleQuality:3,streamPages:!1,reuseWorker:!1,wavBitDepth:16},e),this.encodedSamplePosition=0};i.isRecordingSupported=function(){return o&&t.navigator&&t.navigator.mediaDevices&&t.navigator.mediaDevices.getUserMedia&&t.WebAssembly},i.prototype.clearStream=function(){this.stream&&(this.stream.getTracks?this.stream.getTracks().forEach((function(e){e.stop()})):this.stream.stop(),delete this.stream),this.audioContext&&this.closeAudioContext&&(this.audioContext.close(),delete this.audioContext)},i.prototype.encodeBuffers=function(e){if(\"recording\"===this.state){for(var t=[],o=0;o<e.numberOfChannels;o++)t[o]=e.getChannelData(o);this.encoder.postMessage({command:\"encode\",buffers:t})}},i.prototype.initAudioContext=function(e){return e&&e.context?(this.audioContext=e.context,this.closeAudioContext=!1):(this.audioContext=new o,this.closeAudioContext=!0),this.audioContext},i.prototype.initAudioGraph=function(){this.encodeBuffers=function(){delete this.encodeBuffers},this.scriptProcessorNode=this.audioContext.createScriptProcessor(this.config.bufferLength,this.config.numberOfChannels,this.config.numberOfChannels),this.scriptProcessorNode.connect(this.audioContext.destination),this.scriptProcessorNode.onaudioprocess=e=>{this.encodeBuffers(e.inputBuffer)},this.monitorGainNode=this.audioContext.createGain(),this.setMonitorGain(this.config.monitorGain),this.monitorGainNode.connect(this.audioContext.destination),this.recordingGainNode=this.audioContext.createGain(),this.setRecordingGain(this.config.recordingGain),this.recordingGainNode.connect(this.scriptProcessorNode)},i.prototype.initSourceNode=function(e){return e&&e.context?t.Promise.resolve(e):t.navigator.mediaDevices.getUserMedia({audio:this.config.mediaTrackConstraints}).then(e=>(this.stream=e,this.audioContext.createMediaStreamSource(e)))},i.prototype.loadWorker=function(){this.encoder||(this.encoder=new t.Worker(this.config.encoderPath))},i.prototype.initWorker=function(){var e=(this.config.streamPages?this.streamPage:this.storePage).bind(this);return this.recordedPages=[],this.totalLength=0,this.loadWorker(),new Promise((t,o)=>{var i=o=>{switch(o.data.message){case\"ready\":t();break;case\"page\":this.encodedSamplePosition=o.data.samplePosition,e(o.data.page);break;case\"done\":this.encoder.removeEventListener(\"message\",i),this.finish()}};this.encoder.addEventListener(\"message\",i),this.encoder.postMessage(Object.assign({command:\"init\",originalSampleRate:this.audioContext.sampleRate,wavSampleRate:this.audioContext.sampleRate},this.config))})},i.prototype.pause=function(e){if(\"recording\"===this.state){if(this.state=\"paused\",e&&this.config.streamPages){var t=this.encoder;return new Promise((e,o)=>{var i=o=>{\"flushed\"===o.data.message&&(t.removeEventListener(\"message\",i),this.onpause(),e())};t.addEventListener(\"message\",i),t.postMessage({command:\"flush\"})})}return this.onpause(),Promise.resolve()}},i.prototype.resume=function(){\"paused\"===this.state&&(this.state=\"recording\",this.onresume())},i.prototype.setRecordingGain=function(e){this.config.recordingGain=e,this.recordingGainNode&&this.audioContext&&this.recordingGainNode.gain.setTargetAtTime(e,this.audioContext.currentTime,.01)},i.prototype.setMonitorGain=function(e){this.config.monitorGain=e,this.monitorGainNode&&this.audioContext&&this.monitorGainNode.gain.setTargetAtTime(e,this.audioContext.currentTime,.01)},i.prototype.start=function(e){if(\"inactive\"===this.state)return this.initAudioContext(e),this.initAudioGraph(),this.encodedSamplePosition=0,this.initWorker().then(()=>this.initSourceNode(e)).then(e=>{this.sourceNode=e,this.state=\"recording\",this.onstart(),this.encoder.postMessage({command:\"getHeaderPages\"}),this.sourceNode.connect(this.monitorGainNode),this.sourceNode.connect(this.recordingGainNode)})},i.prototype.stop=function(){if(\"inactive\"!==this.state){this.state=\"inactive\",this.monitorGainNode.disconnect(),this.scriptProcessorNode.disconnect(),this.recordingGainNode.disconnect(),this.sourceNode.disconnect(),this.clearStream();var e=this.encoder;return new Promise(t=>{var o=i=>{\"done\"===i.data.message&&(e.removeEventListener(\"message\",o),t())};e.addEventListener(\"message\",o),e.postMessage({command:\"done\"}),this.config.reuseWorker||e.postMessage({command:\"close\"})})}return Promise.resolve()},i.prototype.destroyWorker=function(){\"inactive\"===this.state&&this.encoder&&(this.encoder.postMessage({command:\"close\"}),delete this.encoder)},i.prototype.storePage=function(e){this.recordedPages.push(e),this.totalLength+=e.length},i.prototype.streamPage=function(e){this.ondataavailable(e)},i.prototype.finish=function(){if(!this.config.streamPages){var e=new Uint8Array(this.totalLength);this.recordedPages.reduce((function(t,o){return e.set(o,t),t+o.length}),0),this.ondataavailable(e)}this.onstop(),this.config.reuseWorker||delete this.encoder},i.prototype.ondataavailable=function(){},i.prototype.onpause=function(){},i.prototype.onresume=function(){},i.prototype.onstart=function(){},i.prototype.onstop=function(){},e.exports=i}).call(this,o(1))},function(e,t){var o;o=function(){return this}();try{o=o||new Function(\"return this\")()}catch(e){\"object\"==typeof window&&(o=window)}e.exports=o}])}));"],"names":["className","options","button","document","createElement","asDiv","icon","noRipple","rippleSquare","classList","add","onlyMobile","disabled","setAttribute","text","append","CodeInputField","constructor","super","plainText","input","this","type","autocomplete","lastLength","addEventListener","e","remove","setLabel","value","replace","slice","length","setValueSilently","onFill","PasswordMonkey","passwordInputField","size","needFrame","container","load","loadPromise","loop","autoplay","width","height","noCache","then","_animation","animation","currentFrame","direction","setSpeed","pause","onVisibilityClickAdditional","passwordVisible","setDirection","curFrame","play","TrackingMonkey","inputField","max","playAnimation","frame","Math","min","round","idleAnimation","stop","canvas","style","display","Promise","all","PasswordInputField","onVisibilityClick","toggleVisible","toggle","name","stealthy","tabIndex","parentElement","prepend","insertBefore","cloneNode","nextSibling","putPreloader","elem","returnDiv","html","div","innerHTML","appendChild","insertAdjacentHTML","lastElementChild","setButtonLoader","removeAttribute","rippleClickId","ripple","callback","resolve","onEnd","attachListenerTo","querySelector","handler","r","contains","drawRipple","clientX","clientY","startTime","Date","now","clickId","duration","window","getComputedStyle","getPropertyValue","elapsedTime","cb","delay","setTimeout","removeEventListener","touchStartFired","requestAnimationFrame","rect","getBoundingClientRect","clickX","left","clickY","top","sqrt","abs","x","y","isRippleUnneeded","target","includes","tagName","touchEnd","touches","once","cancelBubble","stopPropagation","passive","dataset","badCharsRe","trimRe","C2L","clearBadCharsAndTrim","cleanSearchText","latinize","processSearchText","clearBadChars","ignoreCase","hasTag","includeTag","charAt","originalText","ch","latinizeCh","latinizeString","toLowerCase","fixCyrillic","htmlToSpan","span","sequentialDom","promises","raf","scheduled","do","kind","promise","scheduleFlush","undefined","measure","mutate","mutateElement","element","isConnected","read","write","SearchGroup","clearable","clickable","autonomous","onFound","list","nameEl","clear","setActive","childElementCount","AppSearch","searchInput","searchGroups","onSearch","minMsgId","loadedCount","foundCount","searchPromise","searchTimeout","query","listsContainer","threadId","scrollable","i","messages","setVirtualContainer","onChange","reset","searchMore","onScrolledBottom","trim","peerId","beginSearch","focus","maxId","inputFilter","_","limit","res","count","history","mid","shift","searchGroup","forEach","message","fromId","avatarSize","meAsSaved","err","console","error","replaceContent","catch","InputSearch","placeholder","prevValue","timeout","onInput","clearTimeout","onClearClick","onClear","searchIcon","clearBtn","SliderSuperTab","slider","destroyable","_constructor","header","closeBtn","title","content","addTab","listenerSetter","close","closeTab","open","args","init","result","selectTab","onCloseAfterTimeout","tabs","delete","destroy","removeAll","setTitle","key","SliderSuperTabEventable","eventListener","dispatchEvent","cleanup","SidebarSlider","historyTabIds","canHideFirst","onCloseBtnClick","appNavigationController","navigationType","id","animate","isNavigation","closingId","pop","onCloseTab","tab","_selectTab","safeAssign","Map","tabsContainer","sidebarEl","Array","from","querySelectorAll","el","get","onOpen","onOpenAfterTimeout","onPop","canAnimate","push","removeTabFromHistory","indexOfAndSplice","sliceTabsUntilTab","tabConstructor","preserveTab","getTab","find","t","isTabExists","onClose","TRANSITION_TIME","createTab","ctor","doNotAppend","managers","AvatarEdit","getContext","clearRect","months","days","ONE_DAY","getWeekNumber","date","d","UTC","getFullYear","getMonth","getDate","dayNum","getUTCDay","setUTCDate","getUTCDate","yearStart","getUTCFullYear","ceil","getTime","formatDateAccordingToTodayNew","time","today","timestamp","hour","minute","year","day","month","weekday","formatFullSentTimeRaw","timeEl","formatTime","dateEl","capitalize","textTransform","formatFullSentTime","fragment","createDocumentFragment","getFullDate","joiner","monthAsNumber","getHours","getMinutes","noSeconds","getSeconds","leadingZero","noTime","minYear","yearPattern","RegExp","monthYearOrDayPattern","yearOrDayAndMonthPattern","shortDate","longDate","numberOfDaysEachMonth","fillTipDates","dates","q","indexOf","setFullYear","setHours","minDate","maxDate","dayOfWeek","c","setDate","formatWeekLong","getDay","getDayOfWeek","distance","setTime","matches","exec","g1","g2","k","createForDayMonth","createForMonthYear","selectedYear","currentYear","g3","parseInt","validDateForMonth","formatterYearMax","k1","setMonth","formatterMonthYear","formatterDayMonth","getUserStatusString","user","pFlags","bot","support","status","was_online","diff","AppNewGroupTab","uploadAvatar","isGeoChat","avatarEdit","_upload","section","SettingSection","inputWrapper","groupNameInputField","label","maxLength","groupLocationInputField","canBeEdited","valueCheck","userLocationCoords","userLocationAddress","nextBtn","appChatsManager","createChannel","about","geo_point","address","megagroup","chatId","inputFile","editPhoto","peerIds","inviteToChannel","createChat","map","toUserId","toPeerId","chatsSection","nameArgs","new","startLocating","userId","dom","rippleEnabled","lastMessageSpan","appUsersManager","getUser","navigator","geolocation","getCurrentPosition","location","lat","coords","latitude","long","longitude","uri","fetch","response","json","display_name","GeolocationPositionError","VisibilityIntersector","onVisibilityChange","items","locked","observer","IntersectionObserver","entries","changed","entry","isIntersecting","set","change","visible","item","getVisible","clearVisible","isVisible","disconnect","refresh","targets","keys","observe","refreshVisible","unobserve","unlock","unlockAndRefresh","lock","findAndSpliceAll","array","verify","out","idx","findIndex","splice","LazyLoadQueueIntersector","parallelLimit","queue","inProcess","Set","intersector","loadItem","addElement","method","setProcessQueueTimeout","intersectorTimeout","processQueue","unshift","LazyLoadQueue","wasSeen","getItem","findAndSplice","processItem","hasOwnProperty","choosePhotoSize","photo","boxWidth","boxHeight","useBytes","pushDocumentSize","devicePixelRatio","bestPhotoSize","sizes","thumbs","concat","w","h","photoSize","calcImageInBox","accumulate","arr","initialValue","reduce","acc","Layouter","maxWidth","minWidth","spacing","maxHeight","ratios","countRatios","proportions","countProportions","averageRatio","maxSizeRatio","layout","ComplexLayouter","layoutTwo","layoutThree","layoutFour","layoutTwoTopBottom","layoutTwoLeftRightEqual","layoutTwoLeftRight","layoutThreeLeftAndOther","layoutThreeTopAndOther","layoutFourTopAndOther","layoutFourLeftAndOther","geometry","sides","RectPart","minimalWidth","secondWidth","firstWidth","firstHeight","thirdHeight","secondHeight","rightWidth","leftWidth","thirdWidth","h0","w0","w2","w1","h1","h2","static","ratio","join","cropRatios","clamp","attempts","multiHeight","offset","sum","pushAttempt","lineCounts","heights","first","second","third","fourth","optimalAttempt","optimalDiff","attempt","counts","lineCount","totalHeight","minLineHeight","bad1","bad2","line","optimalCounts","optimalHeights","rowCount","index","row","colCount","lineHeight","col","prepareAlbum","widthItem","heightItem","children","borderTopLeftRadius","borderBottomLeftRadius","borderTopRightRadius","borderBottomRightRadius","forMedia","mediaDiv","loadedURLs","url","HTMLImageElement","HTMLVideoElement","src","SVGImageElement","setAttributeNS","backgroundImage","renderImageFromUrl","useCache","isImage","loader","Image","renderImageFromUrlPromise","renderImageWithFadeIn","image","needFadeIn","aspecter","thumbImage","SetTransition","forwards","onTransitionEnd","useRafs","cancelAnimationFrame","afterTimeout","ProgressivePreloader","tempId","detached","isUpload","cancelable","streamable","tryAgainOnFail","attachMethod","onClick","cancelEvent","preloader","loadFunc","cancel","constructContainer","color","bold","constructDownloadIcon","construct","totalLength","downloadSvg","cancelSvg","previousElementSibling","circle","firstElementChild","setDownloadFunction","func","setManual","setProgress","attachPromise","notify","notifyAll","detach","attach","addNotifyListener","details","percents","done","total","isInDOM","getTotalLength","strokeDasharray","heavyQueue","processingQueue","addHeavyTask","processHeavyQueue","todo","results","reject","f","start","performance","possiblePromise","process","apply","context","realResult","timedChunk","finally","requireBlurPromise","fastBlurFunc","processBlurNext","img","radius","iterations","ctx","alpha","filter","drawImage","m","default","cache","dataUri","cached","onload","JPEG_HEADER","bytesFromHex","JPEG_TAIL","getPreviewURLFromBytes","bytes","isSticker","mimeType","Uint8Array","IS_SAFARI","btoa","String","fromCharCode","bytesToDataURL","getPreviewURLFromThumb","thumb","getImageFromStrippedThumb","useBlur","getStrippedThumbIfNeeded","cacheContext","ignoreCache","downloaded","setAttachmentSize","noZoom","_isWebDocument","isWebDocument","isDocument","boxSize","aspect","isFit","aspectCovered","reply_to_mid","media","webpage","replies","comments","channel_id","toChatId","wrapPhoto","withTail","isOut","lazyLoadQueue","middleware","withoutPreloader","loadPromises","autoDownloadSize","noBlur","noThumb","noFadeIn","blurAfter","isWebDoc","full","images","noAutoDownload","mediaSizes","loadThumbPromise","isGif","mime_type","thumbsStorage","getCacheContext","gotThumb","uploadingFileName","appDownloadManager","renderOnLoad","onLoad","toDataURL","canAttachPreloader","haveToDownload","queueId","onlyCache","getDownloadPromise","renderPromise","download","render","createVideo","video","pip","disablePictureInPicture","toHHMMSS","str","leadZero","sec_num","hours","floor","minutes","seconds","FontFamily","getTextWidth","font","measureText","testQueue","pendingTest","setTestQueue","testElement","getElementWidth","sizeType","mapped","firstTime","textLength","multiplier","textWidth","elementWidth","textContent","fontWeight","newElementWidth","widthChanged","smallerText","smallerWidth","smallerTextLength","half","half1","substr","half2","capture","MiddleEllipsisElement","HTMLElement","connectedCallback","disconnectedCallback","throttleWithRaf","fn","schedulerFn","waiting","_args","throttleWith","formatBytes","decimals","dm","log","parseFloat","pow","toFixed","attachGrabListeners","onStart","onMove","onMouseMove","event","pageX","pageY","onMouseUp","onMouseDown","onTouchMove","preventDefault","isTouch","onTouchEnd","onTouchStart","customElements","define","RangeSelector","mousedown","events","withTransition","useTransform","vertical","scrub","seek","setFilled","onScrub","filled","step","stepStr","setHandlers","setListeners","_removeListeners","addProgress","transform","rectMax","offsetAxisValue","bottom","removeListeners","MediaProgressLine","progressRAF","onLoadedData","onEnded","onPlay","paused","setLoadProgress","onTimeUpdate","onProgress","setMedia","filledLoad","currentTime","wasPlaying","setSeekMax","scrubTime","appMediaPlaybackController","buf","buffered","numRanges","nearestStart","end","getMessageSenderPeerIdOrName","fromName","fwd_from","from_name","weakMap","WeakMap","peerTitle","update","PeerTitle","onlyFirstName","dialog","setOptions","limitSymbols","setInnerHTML","wrapEmojiText","getPeerTitle","wrapSenderToPeer","senderTitle","fromMe","wrapSentTime","constructDownloadPreloader","mids","attr","findMediaTargets","anchor","anchorMid","prev","next","isBubbles","findUpClassName","justAudioSelector","selectors","prefix","s","selector","elements","mediaItems","reverse","AudioElement","withTime","voiceAsMusic","showSender","doc","getMediaFromMessage","isRealVoice","isVoice","isOutgoing","is_outgoing","durationStr","downloadDiv","media_unread","onTypeLoad","audioEl","waveform","attributes","attribute","valueCount","dataView","DataView","buffer","byteIndex","bitShift","getUint16","decodeWaveform","svg","svgContainer","availW","barHeightMax","minW","maxW","createElementNS","normValue","wfSize","barCount","maxValue","maxDelta","barX","sumI","bar_value","barWidth","createWaveformBars","fakeSvgContainer","waveformContainer","timeDiv","progress","audio","throttledTimeUpdate","addAudioListener","readyPromise","mousemove","offsetX","MouseEvent","targetTouches","noop","wrapVoiceMessage","descriptionEl","audioAttribute","parts","performer","titleEl","middleEllipsisEl","file_name","subtitleDiv","launched","progressLine","supportsStreaming","lastChild","replaceWith","wrapAudio","audioTimeDiv","autoload","readyState","HAVE_CURRENT_DATA","onTypeDisconnect","getTimeStr","innerText","togglePlay","hadSearchContext","searchContext","useSearch","imgs","wrapped","autoDownload","shouldPlay","is_scheduled","onDownloadInit","pauseListener","deferred","Error","playListener","roundVideoCircumference","wrapVideo","noInfo","group","onlyPreview","noPlayButton","isAlbumItem","canAutoplay","spanTime","spanPlay","needPlayButton","photoRes","muted","divRound","halfSize","strokeWidth","PI","strokeDashoffset","globalVideo","onPaused","onFrame","throttle","foreignObject","getAttributeNS","uploadFileName","renderDeferred","code","isFulfilled","onMediaLoad","animationIntersector","loadPhotoThumbFunc","apiFileManager","downloadMediaURL","wrapAlbum","attachmentDiv","uploading","chat","thumbPromise","to","wrapDocument","audioElement","extSplitted","split","ext","isArray","docDiv","docId","icoDiv","hadContext","fileName","wrapPlainText","descriptionParts","nameDiv","_downloadDiv","save","isTrusted","appDocsManager","getDoc","canOpenAfter","downloadFileName","getDownloadMediaDetails","isDownloading","uploadPromise","savingLottiePreview","saveLottiePreview","toneIndex","saving","toBlob","blob","wrapStickerAnimation","side","skipRatio","animationDiv","stickerPromise","withThumb","assumeType","frameNo","maxFrame","onScroll","vibrate","generateRandomSigned","random","randomOffsetX","randomOffsetY","stableOffsetX","setPosition","right","onlyThumb","emoji","needUpscale","asStatic","stickerType","sticker","lottieLoader","isAnimated","isThumbNeededForType","lottieCachedThumb","getLottieCachedThumb","haveThumbCached","afterRender","path","num","getPathFromBytes","ns","stickerThumbConverted","webpWorkerController","saveWebPConvertedStrippedThumb","animationData","data","a","v","sendInteractionThrottled","appStickersManager","preloadAnimatedEmojiStickerAnimation","getAnimatedEmojiSoundDocument","restart","isUser","getAnimatedEmojiSticker","bubble","appMessagesManager","setTyping","msg_id","getServerMessageId","emoticon","interaction","JSON","stringify","isSavingLottiePreview","EditPeer","_disabled","isChanged","changedLength","requiredLength","requiredValidLength","inputFields","isValid","required","handleChange","toggleAttribute","withoutAvatar","avatarElem","updateWithOptions","doNotEditAvatar","lockWithPromise","unlockOnSuccess","RadioForm","radios","form","checked","Row","freezed","radioField","checkboxField","subtitle","subtitleLangKey","subtitleLangArgs","havePadding","isToggle","titleRight","noCheckboxSubtitle","titleLangKey","titleRightSecondary","noWrap","titleRightEl","navigationTab","createMedia","RadioFormFromRows","rows","copyTextToClipboard","clipboard","writeText","textArea","position","body","select","execCommand","removeChild","fallbackCopyTextToClipboard","RadioField","alignRight","stateKey","state","getDeepProperty","main","langKey","Event","bubbles","toastEl","toast","toastNew","langPackKey","langPackArguments","isUsernameValid","username","test","UsernameInputField","checkUsernameDebounced","debounce","checkUsername","bind","getValue","originalValue","setState","I","setError","invalidText","head","checkUsernamePromise","available","availableText","takenText","isValidToChange","PopupPeer","overlayClosable","buttons","avatarEl","AvatarElement","isDialog","noTitle","titleLangArgs","descriptionLangKey","description","p","descriptionLangArgs","checkboxes","o","withRipple","original","nextElementSibling","AppChatTypeTab","isBroadcast","privateRow","publicRow","privateSection","publicSection","getChat","linkRow","chatFull","exported_invite","link","btnRevoke","toggleDisability","appProfileManager","getChatInviteLink","show","caption","noDelimiter","linkInputField","applyBtn","migrateChat","channelId","updateUsername","setOriginalValue","toggleNoForwards","onChatUpdate","noforwards","ScrollableLoader","loading","loaded","getPromise","checkForTriggers","windowSize","visualViewport","innerWidth","innerHeight","filterAsync","Boolean","numberThousandSplitter","toString","getChatMembersString","getCachedFullChat","participants_count","participants","broadcast","AppSelectPeers","chatsContainer","selected","folderId","offsetIndex","loadedWhat","renderedPeerIds","peerType","multiSelect","exceptSelf","tempIds","selfPresence","needSwitchList","cachedContacts","getMoreResults","renderResultsFunc","renderResults","splitUp","notRendered","has","filterPeerTypeBy","isPeerId","appPeersManager","getPeer","deleted","innerContainer","topContainer","selectedContainer","selectedScrollable","li","sectionNameLangPackKey","noShadow","findUpAttribute","checkbox","debouncedInput","generateDelimiter","appendTo","getResultsPromise","onFirstRender","renderSaved","testSelfSearch","getTempId","getMoreDialogs","dialogs","archived","pageCount","getConversations","newOffsetIndex","getDialogIndex","chatRightsAction","filterByRights","isEnd","contacts","getMoreContacts","peer","canSendToUser","hasRights","isGlobalSearch","getContactsPeerIds","searchContacts","searchResult","resultPeerIds","my_results","filterUnique","getMoreChannelParticipants","channelParticipants","getChannelParticipants","participant","getParticipantPeerId","isNonContactUser","containerEl","subtitleEl","isAnyChat","scroll","insertAdjacentElement","scrollIntoViewNew","offsetWidth","onAnimationEnd","getSelected","addInitial","values","forceDirection","PopupPickUser","closable","onSelect","hide","peerTypes","AppUserPermissionsTab","destroyListener","ChatPermissions","rights","takeOut","deepEqual","banned_rights","editBanned","btnDeleteException","clearChannelParticipantBannedRights","btnDelete","kickFromChannel","flags","exceptionText","toggleWith","defaultBannedRights","default_banned_rights","copy","defaultRights","combineParticipantBannedRights","restrictionText","info","mainFlag","restriction","until_date","flag","AppGroupPermissionsTab","chatPermissions","editChatDefaultBannedRights","addExceptionRow","openPermissions","getChannelParticipant","generateContentElement","findUpTag","DIALOG_LIST_ELEMENT_TAG","setSubtitle","bannedRights","cantWhat","getPeerId","listEl","setLength","exceptionsCount","setLoader","isChannel","migrateFrom","migrateTo","PopupDeleteDialog","peerTitleElement","getDialogType","callbackLeave","flush","leave","flushHistory","callbackDelete","descriptionArgs","isDanger","textArgs","AppChatReactionsTab","availableReactions","appReactionsManager","getActiveAvailableReactions","getChatFull","originalReactions","available_reactions","enabledReactions","toggleSection","toggleCheckboxField","toggleRow","reactionsSection","checkboxFields","availableReaction","reaction","saveReactionsDebounced","wrapStickerToRow","static_icon","every","saveReactions","newReactions","sort","setChatAvailableReactions","AppEditChatTab","_init","chatUpdateListeners","addChatUpdateListener","canChangeType","canChangePermissions","chatNameInputField","descriptionInputField","editPeer","chatTypeRow","setChatTypeSubtitle","reactionsRow","setReactionsLength","availableReactionsLength","getAvailableReactions","inactive","reactions","permissionsRow","setPermissionsLength","getChatTyped","editTitle","editAbout","race","signMessagesCheckboxField","signatures","toggleSignatures","showChatHistoryCheckboxField","togglePreHistoryHidden","hidden_prehistory","formatUserPhone","phone","formatPhoneNumber","formatted","AppEditContactTab","isNew","isContact","nameInputField","lastNameInputField","setDraftValue","first_name","last_name","notificationsCheckboxField","togglePeerMute","enabled","appNotificationsManager","isMuted","notify_settings","profileNameDiv","profileSubtitleDiv","phoneRow","notificationsRow","isPeerLocalMuted","addContact","deleteContacts","AppAddMembersTab","sel","skippable","attachToPromise","removeLoader","ret","isPrivacy","selectedPeerIds","generateFakeIcon","isScam","generateTitleIcons","verified","use","use2","generateVerifiedIcon","fake","scam","DialogColorsFg","DialogColors","DialogColorsMap","getPeerColorById","pic","getAbbreviation","onlyFirst","splitted","last","putAvatar","renderThumbPromise","isFullLoaded","stripped_thumb","putPhoto","isBig","myId","getPeerPhoto","avatarAvailable","avatarRendered","appAvatarsManager","isAvatarCached","abbr","getPeerInitials","ContextMenuController","openedMenu","diffX","diffY","closeBtnMenu","menuOverlay","openedMenuOnClose","IS_MOBILE_SAFARI","isOpened","openBtnMenu","menuElement","getEvent","attachGlobalListenerTo","RESET_GLOBAL","SwipeHandler","cursor","listenerOptions","hadMove","xDown","yDown","handleMove","setCursorTo","onReset","handleStart","_e","verifyTouchTarget","xUp","yUp","xDiff","yDiff","setProperty","onFirstSwipe","onSwipeResult","onSwipe","setCursor","PeerProfileAvatars","photoId","avatar","BASE_CLASS","avatars","appPhotosManager","getPhoto","action","draggable","loadCallback","intersectionObserver","loadCallbacks","gradient","arrowPrevious","arrowNext","checkScrollTop","scrollTop","SWITCH_ZONE","freeze","listLoader","previous","current","prevTargets","nextTargets","openAvatarViewer","toRight","offsetLeft","go","cancelNextClick","lastDiffX","minX","swipeHandler","lastX","SCALE","TRANSLATE_TEMPLATE","addIndex","loadNearestToTarget","setPeer","loadCount","loadMore","older","getUserPhotos","photos","getSearch","Number","MAX_SAFE_INTEGER","backLimit","filterChatPhotosMessages","chat_photo","generateFakeAvatarMessage","onJump","activeTab","photo_id","wrapPeerTitle","setText","PeerProfile","setPeerStatus","needClear","attachClickEvent","bio","getProfileByPeerId","notifications","setMoreDetails","fillUsername","self","fillUserPhone","setAvatar","setPeerStatusInterval","setInterval","cleanupHTML","clearSetMoreDetailsTimeout","canBeDetailed","oldAvatars","getPeerUsername","fillNotifications","fillRows","icons","fillProfileElements","cleaned","_setMoreDetails","peerFull","wrapRichText","exportedInvite","setMoreDetailsTimeout","override","isRestricted","acknowledged","setPromise","clearInterval","historiesStorage","AppSharedMediaTab","newCloseBtn","animatedCloseIcon","transitionContainer","transitionFirstItem","editBtn","transitionLastItem","secondTitle","profile","onAdditionalScroll","searchSuper","nav","setIsSharedMedia","isSharedMedia","transition","cleanScrollPositions","isHeavyAnimationInProgress","toggleEditBtn","renderNewMessages","msgs","deleteDeletedMessages","AppSearchSuper","mediaTabs","onChangeTab","mediaTab","btnAddMembers","scrollStartCallback","showConfirmation","b","onError","addChatUser","filtered","filterMessagesByType","usedFromHistory","performSearchResult","selection","isSelecting","toggleByElement","canViewMembers","setLoadMutex","loadMutex","peerChanged","setQuery","historyStorage","loadSidebarMedia","single","justLoad","RIGHT_COLUMN_ACTIVE_CLASSNAME","appSidebarRight","getElementById","isColumnProportionSet","toggleSidebar","setColumnProportion","createSharedMediaTab","replaceSharedMediaTab","previousTab","sharedMediaTab","proportion","scrollWidth","documentElement","enable","active","willChange","animationPromise","AppPollResultsTab","resultsDiv","poll","appPollsManager","getPoll","quiz","question","voters","total_voters","roundPercents","hr","answer","answers","answerEl","answerTitle","answerPercents","minHeight","getVotes","option","votesList","votes","vote","user_id","showMore","next_offset","down","CLASS_NAME","StackedAvatars","avatarContainer","AVATAR_CLASS_NAME","updateOptions","parentNode","lineTotalLength","minIndex","minRemainder","remainder","maxRemainder","pollElement","isClosed","closed","performResults","chosenIndexes","PollElement","setMaxLength","resizePolls","hideQuizHint","onHide","prevQuizHint","prevQuizHintOnHide","prevQuizHintTimeout","isListenerSet","isQuiz","isRetracted","isPublic","isMultiple","chosingIndexes","sentVote","MAX_LENGTH","MAX_OFFSET","svgLines","setLineProgress","descKey","public_voters","multiple_choice","multipleSelect","descDiv","typeDiv","avatarsDiv","close_period","close_date","timeLeftDiv","quizTimer","circumference","period","closeTime","quizInterval","timeLeft","stroke","getResults","answerDivs","numberDivs","footerDiv","viewResults","votersCountDiv","sendVoteBtn","sendVotes","canVote","setVotersCount","clickHandler","initQuizHint","solution","solution_entities","toggleHint","textEl","entities","setQuizHint","correctResult","correct","chosen","answerIndex","foundIndex","indexes","sendVotePromise","sendVote","setResults","recent_voters","stackedAvatars","isVoted","hideSendVoteBtn","hideViewResultsBtn","maxPercents","getPercentValue","iterate","fullTime","times","votersCount","DivAndCaption","fill","border","htmlToDocumentFragment","DocumentFragment","template","platforms","ignore","getRestrictionReason","reasons","reason","platform","escapeRegExp","isMessageRestricted","restriction_reason","CALL_DURATION_LANG_KEYS","formatCallDuration","plain","showLast","modulus","formatDuration","strings","paymentsWrapCurrencyAmount","amount","currency","skipSymbol","isNegative","currencyData","amountExp","exp","number","dec_point","thousands_sep","n","isFinite","prec","sep","dec","toFixedFix","number_format","decimal_sep","symbol","space_between","symbol_left","splitter","wrapJoinVoiceChatAnchor","onclick","wrapUrl","call","access_hash","href","wrapLinkToMessage","savedFrom","dir","wrapMessageForReply","wrapMessageActionTextNew","unsafeMessage","noLinebreaks","getNameDivHTML","endsWith","post","users","schedule_date","daysToStart","tomorrowDate","pinnedMessage","getMessageByPeer","fetchMessageReplyTo","joined","anchorHTML","domain","total_amount","invoiceMessage","reply_to","reply_to_peer_id","langPack","waited","wrapMessageActionTextNewUnsafe","usingMids","highlightWord","withoutMediaType","hasAlbumKey","addPart","part","totalEntities","usingFullAlbum","grouped_id","getMidsByMessage","albumText","getAlbumText","game","stickerEmojiRaw","actionWrapped","match","found","regExp","sortEntities","messageWrapped","noLinks","noTextFormat","MEDIA_SIZE","wrapReplyDivAndCaption","mediaEl","isRound","mediaChildren","CHAT_ANIMATION_GROUP","child","ReplyContainer","isMediaSet","wrapReply","setColorPeerId","replyContainer","fillPromise","hex","g","wrapStickerSetThumb","downloadOptions","getStickerSetThumbDownloadOptions","animated","videos","URL","createObjectURL","getStickerSet","stickerSet","documents","previousMedia","_size","positionElementByIndex","pos","prevPos","whichChild","SortedList","updateElementWith","updateListWith","sorted","clean","_updateList","onSort","updateList","canUpdate","getAll","batch","updateBatch","base","onElementCreate","noScheduler","onDelete","getIndex","onUpdate","insertInDescendSortedArray","SortedUserList","getUserStatusForSort","onListLengthChange","willChangeLength","createChatListOptions","doTimeout","good","SORT_INTERVAL","_cancelContextMenuOpening","_cancelContextMenuOpeningTimeout","cancelContextMenuOpening","attachContextMenuListener","removeManual","IS_APPLE","onCancel","handleHorizontalSwipe","cancelY","isSwipingBackSafari","handleTabSwipe","ButtonMenuItem","noCheckboxClickListener","textElement","regularText","keepOpen","menu","PopupForward","peerIdMids","overrideOnSelect","PopupDeleteMessages","onConfirm","revoke","deleteScheduledMessages","deleteMessages","titleArgs","isMegagroup","_hasRights","canRevoke","PopupSendNow","sendScheduledMessages","cancelSelection","getSelection","empty","removeAllRanges","accumulateMapSet","AppSelection","selectedMids","targetLookupClassName","verifyTarget","seen","selecting","firstTarget","processElement","checkBetween","seenSet","isSelected","isMidSelected","seenLength","findUpAsChild","elementsBetween","getElementsBetween","toggleByMid","canceledSelection","getElementFromTarget","verifyMouseMoveTarget","listenElement","documentListenerOptions","firstRect","lastRect","isHigher","parent","lookupBetweenParentClassName","lookupBetweenElementsQuery","firstIndex","lastIndex","doNotAnimate","onCancelSelection","toggleSelection","attachListeners","selectedText","createRange","verifyTouchLongPress","isElementShouldBeSelected","appendCheckbox","toggleElementCheckbox","hasCheckbox","getCheckboxInputFromElement","updateContainer","forceSelection","cantForward","cantDelete","cantSend","storageKey","isScheduled","cantForwardDeleteMids","onUpdateContainer","toggleCheckboxes","wasSelecting","blurActiveElement","onToggleSelection","updateElementSelection","toggleMid","unselect","deleteSelectedMids","SearchSelection","contentTab","selectionCountEl","selectionGotoBtn","selectionForwardBtn","selectionDeleteBtn","navScrollableContainer","selectionContainer","btnCancel","attachClickOptions","lastMsgId","obj","fromPeerId","isPrivate","transitionElement","opacity","ChatSelection","recording","canSelectBubble","isGroupedBubbleSelected","getMidsFromGroupContainer","getBubbleGroupedItems","groupContainer","isGroupedSelected","isGroupedMidsSelected","mounted","getMountedBubble","needTranslateX","widthFrom","widthTo","center","selectionInputWrapper","selectionSendNowBtn","selectionLeft","selectionRight","translateButtonsX","inputContainer","skippedMids","isGrouped","groupedCheckboxInput","wrapWebPageDescription","webPage","shortDescriptionText","wrapWebPageTitle","shortTitle","author","site_name","positionMenu","additionalPadding","getScrollWidthFromElement","menuWidth","scrollHeight","menuHeight","windowWidth","windowHeight","paddingTop","paddingRight","paddingBottom","paddingLeft","verticalSide","maxTop","maxLeft","minLeft","intermediateX","intermediateY","possibleSides","SearchContextMenu","attachTo","onGotoClick","onForwardClick","onSelectClick","onClearSelectionClick","onDeleteClick","withSelection","canForward","canDeleteMessage","prevTabId","urlsToRevoke","nextRates","loadedChats","firstLoad","logger","monthContainers","mediaTabsMap","asChatList","groupByMonth","hideEmptyTabs","onTransitionStart","searchContextMenu","navScrollable","tabsMenu","menuTab","unlockScroll","prevId","lockers","lockTouchScroll","searchGroupMedia","canLoadMediaTab","horizontalMenu","tabContent","skipScroll","startCallback","newMediaTab","fromMediaTab","offsetTop","rect2","onMediaClick","targetClassName","warn","AppMediaViewer","setSearchContext","copySearchContext","openMedia","inputMessagesFilterPhotoVideo","inputMessagesFilterDocument","useHeavyAnimationCheck","filterMessagesByInputFilter","processEmptyFilter","setLastMessagePromise","lastMessage","processPhotoVideoFilter","processDocumentFilter","processUrlFilter","entity","display_url","sliced","matchUrl","same","hostname","hash","previewDiv","subtitleFragment","HTMLAnchorElement","decodeURIComponent","firstChild","elemsToAppend","sharedMediaDiv","processCallback","awaited","monthContainer","getMonthContainerByTimestamp","afterPerforming","loadChats","inputMessagesFilterEmpty","showMembersCount","titleSpan","arg","globalContacts","intlElement","isShort","renderRecentSearch","recent","recentSearch","getTopPeers","peers","people","loadMembers","renderParticipants","membersList","LOAD_COUNT","loadType","used","slicedLength","ids","notFilteredMessages","nextRate","next_rate","loadFirstTime","filters","counters","getSearchCounters","firstMediaTab","counter","membersTab","loadFirstTimePromise","toLoad","dateTimestamp","containers","dateElement","haveTimestamps","getObjectKeysAndSort","goFirst","revokeObjectURL","newInputFilter","ButtonMenuToggleHandler","btnMenu","getPrivacyRulesDetails","rules","types","allowPeers","chats","disallowPeers","rule","PrivacyType","PrivacySection","onRadioChange","captions","captionElement","radioSection","exceptions","radioRows","skipTypes","noExceptions","generateSection","exceptionTexts","exception","_peerIds","newPeerIds","generateStr","splitPeersByType","appPrivacyManager","getPrivacy","inputKey","setRadio","chatKey","usersKey","getUserInput","setPrivacy","AppPrivacyPhoneNumberTab","getSelf","captionEl","mePath","anchorCopy","phoneSection","sCaption","wrapStickerEmoji","AppTwoStepVerificationSetTab","captionOld","stickerContainer","inputContent","btnReturn","AppSettingsTab","canFocus","isFirstInput","AppTwoStepVerificationEmailConfirmationTab","isFirst","email","codeInputField","passwordManager","confirmPasswordEmail","goNext","btnChange","btnResend","disable","cancelPasswordEmail","AppTwoStepVerificationEmailTab","resendPasswordEmail","matchEmail","E","onContinueClick","btnContinue","btnSkip","toggleButtons","updateSettings","hint","currentPassword","plainPassword","newPassword","symbols","isCancel","AppTwoStepVerificationHintTab","onSkipClick","saveHint","AppTwoStepVerificationReEnterPasswordTab","monkey","verifyInput","AppTwoStepVerificationEnterPasswordTab","has_password","labelText","getStateInterval","getState","_state","check","auth","AppTwoStepVerificationTab","btnChangePassword","btnDisablePassword","btnSetRecoveryEmail","has_recovery","btnSetPassword","AppPrivacyLastSeenTab","AppPrivacyProfilePhotoTab","AppPrivacyForwardMessagesTab","AppPrivacyAddToGroupsTab","AppPrivacyCallsTab","AppActiveSessionsTab","Session","app_name","app_version","ip","country","date_active","date_created","midtitle","device_model","system_version","authorizations","session","btnTerminate","apiManager","invokeApi","otherSection","onTerminateClick","AppBlockedUsersTab","btnAdd","toggleBlock","blocked","getBlocked","convertKeyToInputKey","toUpperCase","confirmationPopup","cancelButton","AppPrivacyAndSecurityTab","SUBTITLE","blockedPeerIds","blockedUsersRow","passwordState","twoFactorRowOptions","email_unconfirmed_pattern","twoFactorRow","activeSessionsRow","updateActiveSessions","setBlockedCount","updateBlocked","rowsByKeys","numberVisibilityRow","lastSeenTimeRow","photoVisibilityRow","callRow","linkAccountRow","groupChatsAddRow","updatePrivacyRow","disallowLength","allowLength","settings","sensitive_can_change","sensitive_enabled","sensitiveRow","_enabled","deleteButton","appDraftsManager","clearAllDrafts","payment","clearButton","appPaymentsManager","clearSavedInfo","auths","averageColorFromCanvas","pixel","pixels","getImageData","pixelsLength","outPixel","Uint8ClampedArray","highlightningColor","rgba","l","ChatBackgroundGradientRenderer","_width","_height","_tails","_scrollTails","_curve","_positions","_phases","onWheel","_animatingToNextPosition","_scrollDelta","deltaY","_onWheelRAF","drawOnWheel","changeTail","curPos","curPosition","_phase","_tail","drawGradient","drawNextPositionAnimated","frames","_frames","drawImageData","leftLength","_incrementalCurve","hexToRgb","getPositions","positions","getNextPositions","phase","curveMax","curve","distances","nextPos","tail","getGradientImageData","_hctx","createImageData","centerDistanceY","centerDistanceY2","centerDistanceX","swirlFactor","theta","sinTheta","sin","cosTheta","cos","pixelX","pixelY","distanceSum","_colors","distanceX","distanceY","putImageData","_ctx","_hc","colors","getAttribute","_canvas","fillStyle","fillRect","toNextPosition","tails","nextPhaseOnIdx","inc","curves","scrollAnimate","_addedScrollListener","createCanvas","gradientRenderer","ColorPicker","hue","saturation","lightness","onGrabStart","boxDragger","onGrabEnd","box","sliders","hueDragger","hexInputField","rgbInputField","inputs","valid","setColor","rgbRegExp","attachBoxListeners","attachHueListeners","boxRect","saturationHandler","hueRect","hueHandler","updateHexInput","updateRgbInput","rgb","boxX","percentY","boxY","percentHue","hueX","updatePicker","getCurrentColor","rgbaArray","hexa","hsl","hsla","maxX","maxY","posX","posY","lightnessX","lightnessY","AppBackgroundColorTab","_applyColor","updateColorPicker","colorPicker","background","theme","intensity","slug","appStateManager","pushToState","onColorChange","applyColor","themeController","gridSection","grid","backgroundColor","isColored","scaleMediaElement","mediaSize","aspectFitted","quality","AppBackgroundTab","clicked","wallPapersByElement","elementsByKey","onUploadClick","accept","file","files","click","requestFile","naturalWidth","naturalHeight","File","wallPaper","prepareWallPaperUpload","uploadWallPaper","uploadDeferred","newKey","getWallPaperKey","setBackgroundDocument","addWallPaper","onResetClick","defaultTheme","blurCheckboxField","blur","onGridClick","wallpaper","saveToCache","_tempId","onReady","getPixelPromise","imageUrl","averageColor","create","getColorsFromWallPaper","getWallPaperKeyFromTheme","uploadButton","colorButton","resetButton","pattern","getWallPapers","wallPapers","gridContainer","background_color","second_background_color","third_background_color","fourth_background_color","hasFile","isDark","dark","webkitMaskImage","ANIMATION_GROUP","PopupStickers","stickerSetInput","onStickersClick","fileId","stickersDiv","stickersFooter","btn","loadStickerSet","installed_date","toggleStickerSet","divs","AppQuickReactionTab","getQuickReaction","quickReaction","setDefaultReaction","RangeSettingSelector","minValue","writeValue","valueDiv","valueContainer","range","AppGeneralSettingsTab","chatBackgroundButton","animationsCheckboxField","enterRow","ctrlEnterRow","kilometersRow","milesRow","formats","format","runFirst","getNextTimeout","_callback","run","eachTimeout","eachMinute","toLocaleTimeString","suggestCheckboxField","bigCheckboxField","renderQuickReaction","loopCheckboxField","stickerSets","stickersContent","renderStickerSet","getAllStickers","allStickers","sets","AppEditProfileTab","appConfig","getAppConfig","firstNameInputField","bioInputField","about_length_limit_premium","about_length_limit_default","usernameInputField","setProfileUrl","profileUrlContainer","profileUrlAnchor","updateProfile","uploadProfilePhoto","userFull","getProfile","AppIncludedChatsTab","getContacts","foundInFilters","dialogsByFilters","onSelectChange","confirmBtn","cmp","forEachReverse","pinnedPeerIds","pinned_peers","other","otherLegacy","getInputPeerById","editFolderTab","setFilter","filtersStorage","getDialogFilters","dialogsStorage","getFolderDialogs","categoriesSection","exclude_muted","ico","exclude_archived","exclude_read","non_contacts","groups","broadcasts","bots","selectedPeers","includePeerIds","excludePeerIds","addedInitial","_add","originalFilter","AppEditFolderTab","deleteFolderButton","updateDialogFilter","bool","menuBtn","inputSection","generateList","h2Text","categories","includedFlagsContainer","excludedFlagsContainer","include","include_peers","createDialogFilter","editCheckForChange","reloadMissingPromises","reloadMissingPeerIds","loadAnimationPromise","player","onCreateOpen","onEditOpen","documentFragmentToHTML","wrapDraftText","ul","ignoreClick","hasPeer","getDialogOnly","renderMore","_length","exclude_peers","AppChatFoldersTab","filtersRendered","renderFolder","dialogFilter","Object","folder","channels","isAnyGroup","filterId","getFilter","orderIndex","createFolderBtn","foldersSection","suggestedSection","dialog_filters_limit_premium","dialog_filters_limit_default","onFiltersContainerUpdate","getSuggestedFilters","order","getSuggestedDialogsFilters","suggestedFilters","AppNotificationsTab","NotifySection","enabledRow","typeText","previewEnabledRow","inputNotifyPeer","getNotifySettings","notifySettings","applySettings","show_previews","mute","showPreviews","inputSettings","mute_until","updateNotifySettings","contactsSignUpRow","soundRow","sound","getContactSignUpNotification","setContactSignUpNotification","AppLanguageTab","invokeApiCacheable","lang_pack","languages1","languages2","rendered","webLangCodes","language","lang_code","native_name","autoDownloadPeerTypeSection","contactsCheckboxField","privateCheckboxField","groupsCheckboxField","channelsCheckboxField","AppAutoDownloadPhotoTab","AppAutoDownloadFileTab","debouncedSave","sizeMax","setByKey","MIN","MAX_RANGE","MAX","upTo","compareAndUpdate","AppAutoDownloadVideoTab","AUTO_DOWNLOAD_FOR_KEYS","private","AppDataAndStorageTab","autoCheckboxField","autoDownloadNew","setSubtitles","setAutoDownloadSubtitle","photoRow","videoRow","fileRow","file_size_max","openTab","onDisabledChange","gifsCheckboxField","videosCheckboxField","peerKeys","enabledKeys","isAll","logOut","edit","changeAvatarBtn","upload","updateChangeAvatarBtn","buttonsDiv","devicesRow","languageRow","buttonsSection","getAuthorizations","overwrite","getAuthorizationsPromise","AppNewChannelTab","channelNameInputField","channelDescriptionInputField","onLengthChange","PopupCreateContact","withConfirm","btnConfirm","importContact","telInputField","validate","country_code","AppContactsTab","inputSearch","openContacts","sortedUserList","createList","IS_MOBILE","renderPage","AppArchivedTab","wasFilterId","chatList","AppPeopleNearbyTab","isLocationWatched","parseDistance","retryBtn","latestLocationSaved","accuracy","getLocated","updates","orderedPeers","groupsCounter","usersCounter","peopleSection","locatedPeers","sortedList","errorCategory","startWatching","watchPosition","isLongitudeDifferent","isLatitudeDifferent","distanceCheck","calculateDistance","stopWatching","lat1","long1","lat2","long2","asin","formatNumber","LEFT_COLUMN_ACTIVE_CLASSNAME","fakeGradientDelimiter","captionArgs","delimiter","appSidebarLeft","sidebarHeader","onContactsClick","backBtn","btnArchive","isDialogsLoaded","themeCheckboxField","filteredButtons","sessionStorage","kz_version","toolsBtn","btnMenuFooter","rel","newBtnMenu","updateBtn","reload","initSearch","archivedCount","unreadPeerIds","navigationItem","noHistory","checkUpdateInterval","ok","hasUpdate","searchContainer","pickedElements","selectedPeerId","selectedMinDate","selectedMaxDate","updatePicked","removeProperty","helper","unselectEntity","renderEntity","dateData","pushRecentSearch","peopleContainer","hideNewBtnMenuTimeout","activeClassName","onFocus","clearRecentSearchBtn","clearRecentSearch","BubbleGroup","createAvatar","avatarLoadPromise","fwdFrom","fwdFromId","isForwardFromChannel","from_id","currentPeerId","firstTimestamp","firstItem","firstMid","lastTimestamp","lastItem","lastMid","updateClassNames","insertItem","sortGroupItemsKey","insertGroup","removeItem","mount","onItemUnmount","mountItem","onItemMount","unmountItem","dateContainer","getDateContainerByTimestamp","dateGroups","_group","dateGroupsLength","unmountedLength","STICKY_OFFSET","deleteEmptyDateGroups","BubbleGroups","itemsArr","itemsMap","newGroupDiff","sortItemsKey","sortGroupsKey","removeItemFromCache","removeAndUnmountBubble","getItemByBubble","siblings","getSiblingsAtIndex","modifiedGroups","previousSibling","canItemsBeGrouped","groupUngrouped","mountUnmountGroups","toMount","toUnmount","bad","partition","getLastGroup","changeBubbleMid","insertItemToArray","changeItemBubble","changeBubbleByBubble","item1","item2","itemIndex","findGroupSiblingByItem","findGroupSiblingInItems","previousItem","siblingGroupedItem","nextItem","addItemToGroup","addItemToCache","getMessageFromId","viaBotId","createItem","SERVICE_AS_REGULAR","getDateForDateContainer","groupMid","splitSiblingsOnGrouping","previousGroup","prepareForGrouping","hadGroup","foundItem","splittedGroups","PopupDatePicker","initDate","onPick","noButtons","selectedDate","onPrevClick","selectedMonth","minMonth","prevBtn","onNextClick","maxMonth","onDateClick","selectedEl","setTimeTitle","controlsDiv","monthTitle","monthsContainer","handleTimeInput","onOverflow","maxString","hoursInputField","minutesInputField","setMinutes","popupCenterer","timeOptions","sendDate","dateOptions","renderElement","firstDate","weekStartDate","dayIndex","clonedDate","showOverflowMonths","lines","StickyIntersector","observeHeaders","observeElements","headersObserver","targetInfo","boundingClientRect","stickyTarget","rootBoundsInfo","rootBounds","threshold","root","elementsObserver","addSentinel","sentinel","observeStickyHeaderChanges","headerSentinel","ReactionElement","reactionCount","_reactionCount","setCanRenderAvatars","canRenderAvatars","doNotRenderSticker","hadStickerContainer","getReaction","callbackify","center_icon","wrapPromise","wrapStickerPromise","renderCounter","displayOn","renderAvatars","recentReactions","peer_id","setIsChosen","isChosen","fireAroundAnimation","REACTION_INLINE_SIZE","REACTION_BLOCK_SIZE","around_animation","iconPlayer","aroundPlayer","REACTIONS_ELEMENTS","ReactionsElement","onConnectCallback","getReactionCount","reactionElement","getMessage","isPlaceholder","changeMessage","changedResults","hasReactions","availableReactionsResult","isReactionActive","some","totalReactions","can_see_list","reactionElementIdx","recent_reactions","handleChangedResults","childNodes","timeSpan","RepliesElement","updated","postKey","leftPart","recent_repliers","isUnread","read_max_id","max_id","textSpan","iconSpan","rippleContainer","subscribeRepliesThread","updateMessage","makeEdited","edited","makeSponsored","MessageRender","chatType","editedSpan","sponsoredSpan","reactionsElement","reactionsMessage","isSponsored","sponsored","isMessage","views","postAuthor","post_author","postViewsSpan","channelViews","edit_date","edit_hide","pinned","inner","clonedArgs","_reactionsElement","renderReplies","bubbleContainer","messageDiv","isFooter","repliesFooter","setReply","isReplacing","currentReplyDiv","replyToPeerId","originalPeerTitle","titlePeerId","originalMessage","originalMessageFwdFromId","needUpdate","replyMid","getElementByPoint","horizontalSide","elementFromPoint","reflowScrollableElement","SEND_WHEN_ONLINE_TIMESTAMP","getVisibleRect","overflowElement","lookForSticky","overflowRect","overflowTop","overflowRight","overflowBottom","overflowLeft","sticky","overflow","horizontal","INTERNAL_LINK_TYPE","PopupJoinChatInvite","chatInvite","request_needed","importChatInvite","savePhoto","peopleCount","ScrollSaver","getSaved","clientHeight","findElements","containerRect","elementRect","replaceSaved","findAndSetElements","_save","scrollHeightMinusTop","onRestore","useReflow","setScrollTop","newScrollTop","setScrollTopSilently","restore","_restore","previousScrollHeightMinusTop","SuperIntersectionObserver","observing","observingQueue","freezedObservingNew","callbacks","toggleObservingNew","isMentionUnread","mentioned","middlewarePromise","throwWhat","getEmojiEntityFromEmoji","unicode","appendEmoji","unify","spanEmoji","kek","wrapSingleEmoji","fixEmoji","getEmojiFromElement","nodeType","nodeValue","EmojiTab","closeScrollTop","onContentClick","category","emojis","titleDiv","itemsDiv","unified","emojiScroll","appEmojiManager","getRecentEmojis","hasRecent","activeId","EmoticonsDropdown","menuOnClick","stickyIntersector","setMenuActive","recentItemsDiv","LazyLoadQueueRepeat2","spliced","GifsMasonry","scrollPromise","processInvisibleDiv","processVisibleDiv","gifWidth","gifHeight","willUseWidth","GifsTab","gifsContainer","masonry","EMOTICONSSTICKERGROUP","getGifs","docs","LazyLoadQueueRepeat","_queue","SuperStickerRenderer","regularLazyLoadQueue","checkAnimationContainer","processVisible","processInvisible","renderSticker","observeAnimated","unobserveAnimated","StickersTab","categoriesMap","createCategory","_title","menuTabPadding","categoriesIntersector","categoryAppendStickers","isCategoryVisible","superStickerRenderer","setCategoryItemsHeight","containerWidth","stickerSize","itemsPerRow","menuWrapper","menuScroll","intersectionOptions","clearCategoryItems","recentCategory","toggleRecentCategory","clearRecentStickers","onRecentStickers","stickers","getRecentStickers","rendererLazyLoadQueue","resizeCategories","pushRecentSticker","ANIMATIONGROUP","AppGifsTab","nextOffset","loadedAll","onGifsClick","search","gifsDiv","newSearch","gifBotPeerId","resolveUsername","appInlineBotsManager","getInlineResults","AppStickersTab","setsDiv","renderSet","countDiv","stickerDiv","renderFeatured","getFeaturedStickers","coveredSets","filterRendered","covered","searchStickerSets","DropdownHover","forceClose","inited","onMouseOut","isActive","displayTimeout","toElement","willBeActive","dispatchResultableEvent","attachButtonListener","onmouseout","onmouseover","tabId","onSelectTabClick","searchButton","deleteBtn","checkRights","tabsEl","tabsElements","canSendStickers","canSendToPeer","canSendGifs","savedRange","getGoodRange","emojiTab","stickersTab","gifsTab","HIDE_EMOJI_TAB","IS_APPLE_MOBILE","INIT_TAB_ID","getElement","addLazyLoadQueueRepeat","getSavedRange","rangeCount","activeElement","getRangeAt","jumpedTo","stuck","which","axis","clearDraft","emoticonsDropdown","stringResults","numberResults","replaceNonNumber","CARD_BRAND_REGEXP","visa","mastercard","amex","discover","diners","diners14","jcb","unionpay","elo","mir","CARD_BRANDS","minLength","cvcMaxLength","cvcMinLength","unknown","detectCardBrand","card","sanitizedCard","brand","detectUnifiedCardBrand","createArray","delta","charCodeAt","buggedRegExp","getDistanceFromBuggedToNormal","char","fixBuggedNumbers","makeOptionalCharacter","consumed","makeRequiredCharacter","partial","wrapCharacterRegExpFactory","optional","_regExp","source","makeCharacter","makeMonthDigitPatternCharacter","digit","capitalCharacter","cleanedResult","formattingCharacter","str1","makeFormattingCharacter","optionalPattern","spaceCharacter","yearOptionalPattern","sixteenPattern","fifteenPattern","requiredPostcodes","generateFourPattern","cardFormattingPatterns","cardNumber","cardExpiry","cardCvc","cardCvcFromBrand","postalCodeFromCountry","iso2","IS_ANDROID","optionalDigits","accumulateLengths","strs","nbspRegExp","makeValidationError","validateCardNumber","sanitized","getCardInfoByNumber","ignoreIncomplete","validateCompleteCardNumber","makeCardNumberError","validateCardExpiry","monthStr","yearStr","_year","nextMonth","isNaN","validateExpiry","createVerificationIframe","iframe","allow","contentWindow","parse","PopupPaymentVerification","eventType","eventData","path_full","InputFieldCorrected","onKeyDown","lastKeyDown","deleting","lastTransformed","getPattern","pushRest","autocorrectComplete","selectionStart","selectionEnd","character","getCharacter","meta","formatInputValueByPattern","formatMethod","transformedValue","validateNew","onBlur","justReturn","validateMethod","validateAnyIncomplete","errorKeys","handleInputFieldsOnChange","_onChange","createCountryZipFields","zip","countryInputField","postcodeInputField","noPhoneCodes","onCountryChange","inputMode","SUPPORTED_NATIVE_PROVIDERS","PopupPaymentCard","paymentForm","savedCard","native_provider","cardOut","token","credentials","can_save_credentials","cardSection","nativeParams","native_params","lastBrand","lastBrandImg","brandIconTempId","cardInputField","invalid","incomplete","transformed","getPaymentBrandIconPath","setBrandIcon","cvcInputField","need_cardholder_name","expireInputField","switchFocusOrder","previousInputField","placeCaretAtEnd","nextInputField","inputFieldsRow","billingSection","saveCheckboxField","need_country","need_zip","canSave","saveRow","payButton","PaymentButton","expiryFull","expiryMonth","expiryYear","cvc","cardholderName","nativeProvider","URLSearchParams","headers","Authorization","publishable_key","params","expiration_month","expiration_year","security_code","Accept","public_token","btnConfirmOnEnter","PopupPaymentCardConfirmation","inputCheckPassword","getInputCheckPassword","tmpPassword","password","handled","PopupPaymentShipping","invoice","savedInfo","saved_info","addressSection","address1InputField","address2InputField","cityInputField","stateInputField","receiverSection","emailInputField","shipping_address_requested","name_requested","email_requested","phone_requested","validateEmail","validatePhone","selectedCountry","shipping_address","street_line1","street_line2","city","country_iso2","post_code","requestedInfo","validateRequestedInfo","shippingAddress","ADDRESS_STREET_LINE1_INVALID","ADDRESS_STREET_LINE2_INVALID","ADDRESS_COUNTRY_INVALID","ADDRESS_CITY_INVALID","ADDRESS_STATE_INVALID","ADDRESS_POSTCODE_INVALID","REQ_INFO_NAME_INVALID","REQ_INFO_EMAIL_INVALID","REQ_INFO_PHONE_INVALID","selectCountryByIso2","focusField","PopupPaymentShippingMethods","shippingOption","shipping_options","prices","lastShippingId","PopupPayment","receiptPeerId","receiptMsgId","tipButtonsMap","confirmed","onConfirmed","popupPaymentVerification","mediaInvoice","isReceipt","receipt_msg_id","itemEl","detailsClassName","photoEl","linesClassName","botName","preloaderContainer","getPaymentReceipt","getPaymentForm","savedCredentials","saved_credentials","lastRequestedInfo","providerPeerTitle","provider_id","bot_id","wrapAmount","makeLabel","labelEl","pricesClassName","makePricesElements","price","_label","wrappedAmount","pricesElements","getTipsAmount","shippingAmount","setTotal","totalAmount","totalLabel","payI18n","canTip","max_tip_amount","tip_amount","tipsClassName","getInputValue","setInputWidth","setInputValue","unsetActiveTip","tipEl","tipsLabel","haveToIgnoreEvents","HTMLInputElement","onSelectionChange","ignoreNextSelectionChange","onFocusOut","tipsEl","tipClassName","tipButtons","suggested_tip_amounts","tipAmount","prevTipEl","setRowIcon","createRow","setRowTitle","setCardSubtitle","methodRow","onMethodClick","previousCardDetails","previousToken","credentials_title","providerRow","providerAvatar","shippingAddressRow","shippingNameRow","shippingEmailRow","shippingPhoneRow","shippingMethodRow","lastShippingOption","onShippingAddressClick","onShippingMethodClick","setShippingTitle","postAddress","setShippingInfo","setShippingOption","scrollSaver","lastShippingPricesElements","node","onContentUpdate","shipping","lastTmpPasword","missingInfo","tmp_password","paymentResult","sendPaymentForm","form_id","_passwordState","valid_until","tsNow","IGNORE_ACTIONS","TEST_SCROLL_TIMES","TEST_SCROLL","PEER_CHANGED_ERROR","getMainMidForGrouped","ChatBubbles","unreadOut","bubblesNewByGroupedId","bubblesNew","dateMessages","scrolledDown","isScrollingTimeout","unreaded","unreadedSeen","messagesQueuePromise","messagesQueue","messagesQueueOnRenderAdditional","firstUnreadBubble","replyFollowHistory","isFirstLoad","passEntities","viewsMids","isTopPaddingSet","renderingMessages","bubblesToEject","bubblesToReplace","setPeerTempId","renderNewPromises","unreadedObserverCallback","onUnreadedInViewport","viewsObserverCallback","sendViewCountersDebounced","sponsoredMessage","random_id","viewSponsoredMessage","onBubblesMouseMove","unhoverPrevious","hoverBubble","hoverReaction","setHoverVisible","stickerWrapper","getGroupsFirstMessage","getMiddleware","getAvailableReactionsByMessage","select_animation","sendReaction","onBubblesClick","appImManager","setInnerPeer","chatInner","onDatePick","contactDiv","callDiv","callUser","bubbleMid","reply_to_top_id","saved_from_msg_id","openThread","message1","getMessageWithReplies","getDiscussionMessage","via","setDraft","peerIdStr","messageId","documentDiv","groupedItem","SINGLE_MEDIA_CLASSNAME","isSingleMedia","isMediaCompatibleForDocumentViewer","parents","hasAspecter","albumItem","isReplyClick","replyToMid","reply_to_msg_id","ignoreHeavyAnimation","scrollDimensions","sliceViewportDebounced","topbar","setCorrectIndexThrottled","lastScrollDirection","setStickyDateManually","distanceToEnd","getDistanceToEnd","setPeerPromise","requestHistory","setMessageId","constructBubbles","bubbleGroups","sequential","messagesStorageKey","newItem","_items","groupBubbles","scrollingToBubble","scrollToEnd","deleteMessagesByIds","tempMessage","_bubble","groupedId","getMessagesByAlbum","reactionsElements","repliesElement","newDiv","safeRenderMessage","scrollToBubbleIfLast","deletedMids","wasMainMid","mainMid","createScrollSaver","appendReactionsElementToBubble","dateMessage","dateBubble","previousStickyDate","sliceViewport","setScroll","attachContainerListeners","contextMenu","highlightBubble","replyAfter","shouldReply","canSend","_target","initMessageReply","constructPeerHelpers","renderNewMessage","setUnreadCount","updateUnreadByDialog","finishPeerChange","postViewsElements","different","postViews","incrementMessageViews","createResizeObserver","resizeObserver","wasHeight","resizing","skip","scrolled","rAF","onResizeEnd","offsetHeight","isScrolledDown","setEndRAF","ResizeObserver","contentRect","realDiff","_part","needScrollTop","destroyResizeObserver","setReactionsHoverListeners","overlayCounter","getRenderedLength","readUnreaded","readPromise","idleController","bubblesMaxId","getHistoryMaxId","readContents","readMessages","readHistory","constructPinnedHelpers","constructScheduledHelpers","getScheduledMessagesStorage","onGoDownClick","getBubbleByPoint","getGroupedBubble","groupId","getMidsByAlbum","findNextMountedBubbleByMsgId","filterCallback","_mid","foundMid","loadMoreHistory","getHistoryTopPromise","getHistoryBottomPromise","getHistory1","destroyScrollable","setLoaded","onScrolledTop","getHistoryStorage","readMaxId","readOutboxMaxId","msgId","permanent","ignoreOnScroll","emptyPlaceholderBubble","ignoreNextScrollEvent","setTopPadding","setPaddingTo","isPaddingNeeded","unsetPadding","_renderNewMessage","newMessage","replyTo","getLastBubble","performHistoryResult","scrollToBubbleEnd","scrollToBubble","forceDuration","fallbackToElementStartWhenCentering","isChangingHeight","messageInput","margin","getNormalSize","dimensions","lastScrollPosition","datasetKey","createDateBubble","bubbleContent","serviceMsg","fakeBubble","bubblesToo","cleanupPlaceholders","attachedUnreadBubble","fetchNewPromise","getSponsoredMessagePromise","onAnimateLadder","resolveLadderAnimation","attachPlaceholderOnRender","cancelMeasure","samePeer","startParam","perf","bindPrefix","onChangePeer","topMessage","getPinnedMessagesMaxId","isTarget","followingUnread","savedPosition","overrideAdditionMsgId","getChatSavedPosition","getReadMaxIdIfUnread","unread_count","foundSlice","findSliceOffset","isJump","isStartButtonNeeded","setStartParam","setQueueId","messageEntityBotCommand","isBot","additionMsgId","maxBubbleId","oldChatInner","oldPlaceholderBubble","haveToScrollToBubble","fromUp","scrollFromDown","scrollFromUp","willScrollOnLoad","setPeerOptions","waitPromise","setPeerCached","mountedByLastMsgId","setCorrectIndex","lastBubble","onRenderScrollSet","afterSetPromise","setFetchReactionsInterval","setFetchHistoryInterval","onScrolledAllDown","unread_mark","markDialogUnread","fetchReactions","getMessagesReactions","needFetchInterval","isFetchIntervalNeeded","getNewHistory","isBottomEnd","historyMaxId","canWrite","renderMessagesQueue","setMessagesQueuePromise","renderQueue","renderQueuePromises","loadQueue","filterQueue","avatarPromises","updatePosition","timePromises","groupCollapsed","groupEnd","setUnreadDelimiter","restoreScroll","prepareToSaveScroll","ejectBubbles","oldBubble","local","updatePlaceholderPosition","isAvatarNeeded","additionalCallback","processResult","newBubble","originalPromise","renderMessage","albumMids","albumMessages","albumMustBeRenderedFull","our","isOurMessage","contentWrapper","unread","chat_id","is_single","messageMessage","messageMedia","richText","canHaveTail","isStandaloneMedia","needToSetHTML","emojiEntities","strLength","curr","forward","replyMarkup","reply_markup","containerDiv","rowDiv","buttonEl","botId","same_peer","checkSwitchReturn","popup","switchInlineQuery","column","callbackButtonClick","callbackAnswer","messageWithReplies","getMessageWithCommentReplies","withReplies","isOutMessage","nameContainer","canHideNameIfMedia","processingWebPage","previewResizer","preview","quote","quoteTextDiv","strong","textDiv","isSquare","emojiSticker","animatedSticker","staticSticker","newNameContainer","getMidsByMid","wrapper","wrapGroupedDocuments","lastContainer","contact","contactDetails","contactNameDiv","contactNumberDiv","phone_number","wrapPoll","isTest","priceEl","needName","titleVia","isHidden","goto","generateTail","documentContainer","documentMessageDiv","viewportSlice","getViewportSlice","deleteViewportSlice","historyResult","needReflowScroll","setLoadedPromises","firstSlice","lastSlice","both","processLocalMessageRender","getHistory","ackedResult","getScheduledMessages","animateAsLadder","additionMsgIds","isAdditionRender","targetMid","sortedMids","topIds","middleIds","bottomIds","setBubbles","lastMsDelay","elementsToAnimate","transitionDelay","topRes","middleRes","bottomRes","delays","renderEmptyPlaceholder","listElements","getRestrictionReasonText","getGreetingSticker","channel_post","generateMessageId","start_param","chat_invite","chat_invite_hash","JOIN_CHAT","invite","processInternalLink","creator","isWaitingForAnimation","noTransition","setOn","generateLocalMessageId","addOffset","generateLocalFirstMessage","service","getOutputPeer","saveMessages","storage","extraSize","invisibleTop","invisibleBottom","foundVisible","visibleRect","minTop","maxBottom","ignoreScrollSaving","invisible","checkPlaceholders","toggleSponsoredMessage","renderBotPlaceholder","checkIfEmptyPlaceholderNeeded","_log","getSponsoredMessage","sponsoredMessages","messagePromise","processPromise","bot_info","isBackLimit","resultPromise","isFirstMessageRender","serviceStartMessageId","getThreadServiceMessageId","sup","_promise","mustBeCount","PopupPinMessage","unpin","canUnpin","canPinMessage","oneSide","silent","unpinAllMessages","hidePinnedMessages","updatePinnedMessage","buttonText","getPinnedMessagesCount","pinButtonText","isSelectionEmpty","selectionRange","START_TO_END","preloadAnimatedEmojiSticker","PopupReportMessagesConfirm","reportMessages","STICKER_EMOJI","PopupReportMessages","preloadStickerPromise","buttonsEl","marginTop","PopupSponsored","PopupReactedList","canViewReadParticipants","canViewMessageReadParticipants","btnClose","loaders","hasAllReactions","createFakeReaction","hasReadParticipants","readUserIds","getMessageReadParticipants","chatlist","dialogSize","skipReadParticipants","skipReactionsList","getMessageReactionsListAndReadParticipants","combined","getReactionCached","allReactionsSticker","REACTION_CLASS_NAME","REACTIONS_CLASS_NAME","CAN_USE_TRANSFORM","ChatReactionsMenu","reactionsMap","players","onScrollProcessItem","reactionDiv","appear","widthContainer","reactionsContainer","reactionsScrollable","animationGroup","renderReaction","setVisible","canUseAnimations","scaleContainer","appearWrapper","selectWrapper","appear_animation","selectLoadPromise","selectPlayer","REACTION_SIZE","ChatContextMenu","onContextMenu","isSelectable","isTextSelected","isAnchorTarget","isUsernameTarget","selectedMid","isOverBubble","isTargetAGroupedItem","noForwards","viewerPeerId","canOpenReactedList","initResult","menuPadding","reactionsMenu","reactionsMenuPosition","isReactionsMenuVisible","offsetSize","nextVisiblePart","MIN_NEXT_VISIBLE_PART","minSize","onSendScheduledClick","onReplyClick","onEditClick","initMessageEditing","onCopyClick","onCopyAnchorLinkClick","onCopyLinkClick","threadMessage","onPinClick","onUnpinClick","onRetractVote","onStopPoll","stopPoll","attachListenerSetter","closest","filterButtons","setButtons","hasAttribute","notDirect","scheduleSending","editMessage","scheduleDate","onMessageSent","canEditMessage","getMessageFromStorage","hasTarget","isGoodType","viewsButton","isViewingReactions","participantsCount","reactedLength","i18nElem","fakeText","AVATAR_SIZE","MAX_AVATARS","PADDING_PER_AVATAR","visibility","reactionsCount","fakeElem","readParticipants","isFull","totalSize","SendMenu","sendMenuButtons","onSilentClick","onScheduleClick","sendMenu","openSide","onContextElement","setPeerId","PopupCreatePoll","onSubmitClick","send","radioLabel","isEmpty","isInputEmpty","questions","appendMoreField","correctAnswers","optionInputFields","labelOptions","questionInputField","sendSilent","dd","settingsCaption","anonymousCheckboxField","multipleCheckboxField","quizCheckboxField","quizSolutionField","quizElements","quizSolutionCaption","quizHr","quizSolutionContainer","quizSolutionSubtitle","onEscape","getFilledAnswers","getRichValue","quizSolution","force","quizSolutionEntities","inputMediaPoll","getInputMediaPoll","sendOther","getMessageSendingParams","helperType","clearHelper","questionField","createPosterFromMedia","videoWidth","videoHeight","getGifDuration","arrayBuffer","currentPopup","getCurrentNewMediaPopup","PopupNewMedia","willAttachType","confirmShortcutIsSendShortcut","attachFile","willAttach","shouldCompress","itemDiv","attachMedia","attachDocument","sendFileDetails","config","getConfig","captionLengthMax","caption_length_max","mediaContainer","withLinebreaks","wasInputValue","messageInputField","attachFiles","appendDrops","appendGroupCheckboxField","groupCheckboxField","mediaCheckboxField","appendMediaCheckboxField","addFiles","toPush","_file","lastModified","isMedia","sendingParams","sendText","sendAlbum","assign","replyToMsgId","startsWith","objectURL","controls","audioDecodedByteCount","webkitAudioDecodedByteCount","noSound","onseeked","onerror","createPosterFromVideo","isPhoto","isAudio","finish","onRender","foundPhotos","foundVideos","foundFiles","appendMediaToContainer","firstType","albumContainer","HANDLE_EVENT","ACTIVE_CLASS_NAME","AXIS_Y_KEYS","AXIS_X_KEYS","AutocompleteHelper","hidden","onVisible","resetTarget","waitForKey","waitForKeySet","keyNames","getCurrentTarget","setCurrentTarget","scrollTo","hadTarget","fastSmoothScroll","getNextTargetX","currentTarget","isNext","nextTarget","handleArrowKey","property","endProperty","currentRect","targetRect","getNextTargetY","fireSelect","canContinue","attached","_onKeyDown","attachListNavigation","listType","noBlurOnPop","attachNavigation","controller","addHelper","toggleListNavigation","fromController","skipAnimation","hideOtherHelpers","StickersHelper","onChangeScreen","checkEmoticon","getStickersByEmoticon","ready","getMinDate","getMaxDate","PopupSchedule","canSendWhenOnline","btnSendWhenOnline","getRichValueWithCaret","field","withEntities","selNode","selOffset","startOffset","startContainer","endContainer","endOffset","possibleChildrenFocusOffset","alt","getRichElementValue","caretPos","combineSameEntities","EmojiHelper","chatInput","onEmojiSelected","scrollLeft","checkQuery","firstChar","getBothEmojiKeywords","searchEmojis","AutocompletePeerHelper","doNotShow","listElement","BASE","BASE_CLASS_LIST_ELEMENT","processPeerFullForCommands","botInfos","commands","botInfo","command","indexObject","CommandsHelper","getReadyToSend","sendMessage","AutocompleteHelperController","helpers","preserveHelper","MentionsHelper","insertAtCaret","topMsgId","trimmed","getMentions","ReplyKeyboard","onBodyTouchStart","btnHover","checkAvailability","checkForceReply","touchListener","sendContact","getReplyMarkup","getHistoryStorageTransferable","InlineHelper","queryId","queryAndResultIds","generateQId","resultId","sendInlineResult","_checkQuery","botResults","query_id","gifsMasonry","isGallery","gallery","noCommands","separator","dcId","readBlobAsDataURL","dataURL","switch_pm","btnSwitchToPM","switchToPM","ChatBotCommands","setUserId","modifyAckedResult","acked","modifyAckedPromise","ChatSendAs","sendAsButtons","previousAvatar","onSendAsMenuToggle","updateButtons","sendAsPeerId","changeSendAsPeerId","executeButtonsUpdate","sendAsPeerIds","saveDefaultSendAs","updateAvatar","getDefaultSendAs","getChannelFull","channelFull","default_send_as","updateManual","updatingPromise","wasSkippingAnimation","auto","getSendAs","addedListener","InputFieldAnimated","inputFake","onFakeInput","setHeight","newHeight","currentHeight","transitionDuration","fromSet","POSTING_MEDIA_NOT_ALLOWED","ChatInput","lastUrl","lastTimeType","replyElements","willSendWebPage","recordCanceled","recordStartTime","lockRedo","canRedoFromHTML","undoHistory","executedHistory","canUndoFromHTML","onCancelRecordClick","recorder","opusDecodeController","onEmoticonsOpen","toggleClass","btnToggleEmoticons","onEmoticonsClose","isUserOnlineVisible","openScheduled","prepareDocumentExecute","undoRedo","needHTML","sameHTMLTimes","currentHTML","handleMarkdownShortcut","formatKeys","markupTooltip","applyMarkdown","showLinkEditor","shiftKey","onMessageInput","richValue","markdownEntities","parseMarkdown","mergeEntities","parseEntities","urlEntities","getWebPagePromise","appWebPagesManager","getWebPage","setTopInfo","noWebPage","onHelperCancel","helperFunc","botCommands","resetCurrentFontFormatting","updateBotCommandsToggle","editMsgId","saveDraftDebounced","checkAutocomplete","updateSendBtn","onBtnSendClick","forwarding","releaseMediaPlayback","setRecording","showDiscardPopup","btnCancelRecord","recordingOverlayListener","recordingNavigationItem","sourceNode","analyser","createAnalyser","connect","fftSize","frequencyData","frequencyBinCount","getByteFrequencyData","recordRippleEl","ms","recordTimeEl","needReturn","onHelperClick","forwardElements","rowsWrapperWrapper","rowsWrapper","fakeRowsWrapper","fakeSelectionWrapper","goDownBtn","controlContainer","iconBtn","cancelBtn","onHideAuthorClick","isChangingAuthor","canToggleHideAuthor","onHideCaptionClick","forwardButtons","hideSender","showCaption","hideCaption","changePeer","changeForwardRecipient","forwardBtnMenu","forwardWasDroppingAuthor","replyTitle","forwardHover","modifyArgs","newMessageWrapper","inputMessageContainer","goDownUnreadBadge","goMentionBtn","goMentionUnreadBadge","goToNextMention","btnScheduled","btnToggleReplyMarkup","replyKeyboard","botCommandsToggle","scaler","botCommandsIcon","attachMenuButtons","fileInput","attachMenu","multiple","autocompleteHelperController","stickersHelper","emojiHelper","commandsHelper","mentionsHelper","inlineHelper","btnSendContainer","btnSend","attachMessageInputField","previousQuery","draft","saveDraft","encoderSampleRate","monitorGain","numberOfChannels","recordingGain","reuseWorker","touchMouseDown","onstop","ondataavailable","typedArray","dataBlob","Blob","sendFile","isVoiceMessage","botStartBtn","toggleBotStartBtnDisability","startBot","pinnedControlBtn","originalChat","pinnedMessageContainer","_center","neededFakeContainer","fakeWrapperTo","oldFakeWrapperTo","borderRadius","fakeSelectionRect","fakeRowsRect","scale","initTranslateX","br","getNeededFakeContainer","hasMentions","unread_mentions_count","no_webpage","syncDraft","helperToo","clearInput","fromUpdate","getDraft","wrappedDraft","myEntities","apiEntities","wrapDraft","createSendAs","firstChange","sendAs","updateOffset","getPlaceholderKey","updateMessageInputPlaceholder","previousSendAs","ackedPeerFull","ackedScheduledMids","setSendAsCallback","filteredAttachMenuButtons","filterAttachMenuButtons","placeholderKey","hasBotCommands","updateBotCommands","updateMessageInput","isAnonymousSending","oldInputField","attachMessageInputListeners","fixSafariStickyInputFocusing","isSendShortcutPressed","ctrlKey","metaKey","setStart","collapse","addRange","readAllHistory","commandsMap","italic","underline","strikethrough","monospace","spoiler","saveExecuted","executed","checkType","haveThisType","isCollapsed","tag","commonAncestorContainer","resetCurrentFormatting","setActiveMarkupButton","insertText","insertEntity","isHelper","fullValue","suffix","AUTO_COMPLETE_REG_EXP","matchIndex","newValue","hadEntities","insertLength","addEntities","caretEntity","insertCaretAtIndex","caret","originalNode","newNode","createTextNode","setStartAfter","insertNode","setCaretAt","_value","foundHelper","checkInlineAutocomplete","needPlaceholder","inlineMatch","btnPreloader","bot_inline_placeholder","inlinePlaceholder","helperWaitingForward","canSetDraft","fireEvent","clearValue","fixSafariStickyInput","clearReply","pushRecentEmoji","forwardMessages","dropAuthor","dropCaptions","isDroppingCaptions","sendMessageWithDocument","hideCaptionCheckboxField","replyFragment","initMessagesForward","fromPeerIdsMids","fromPeerIds","smth","messagesWithCaptionsLength","peerTitles","titleKey","senderTitles","firstMessage","newReply","intl","peerTitleEl","wrapSingleMessage","_message","callerFunc","replyParent","oldReply","haveReply","CLASSNAME_BASE","PinnedContainer","floating","divAndCaption","wrapperUtils","attachOnCloseEvent","needClose","isFloating","setFloating","setUtilsWidth","VolumeSelector","onMuteClick","setVolume","volume","iconIndex","ICONS","ChatAudio","onPlaybackParams","playbackParams","fasterEl","playbackRate","repeatEl","onPause","toggleEl","onStop","onMediaPlay","isMusic","volumeSelector","prevEl","nextEl","attachClick","volumeProgressLineContainer","tunnel","progressWrapper","playingDetails","BAR_HEIGHTS","PinnedMessageBorder","drawRect","getClipPath","barHeight","GAP","clipPath","getBarHeight","ONE","TWO","THREE","FOUR","MORE","getMarkHeight","markHeight","getMarkTranslateY","getTrackTranslateY","trackHeight","getTrackHeight","cssText","clipPathId","markTranslateY","trackTranslateY","defs","mark","AnimatedSuper","getRow","animateFirst","clearRow","clearRows","currentIndex","DURATION","setNewRow","reflow","previousIndex","fromTop","ignorePrevious","previousRow","AnimatedCounter","previousNumber","getDecimal","animatedSuper","decimal","hideLeft","previousDecimalNumber","EMPTY_INDEX","setCount","previousByDecimal","decimalNumber","ChatPinnedMessage","pinnedMaxMid","pinnedMid","pinnedIndex","wasPinnedIndex","wasPinnedMediaIndex","waitForScrollBottom","loadedBottom","loadedTop","scrollDownListenerSetter","getCurrentIndexPromise","debug","isStatic","dAC","pinnedMessageBorder","animatedSubtitle","animatedMedia","animatedCounter","btnOpen","openPinned","setPinnedMessage","_setPinnedMessage","unsetScrollDownListener","testMid","isNeededMore","getCurrentIndex","LOAD_OFFSET","correctAfter","gotRest","getPinnedMessage","backLimited","offset_id_offset","setScrollDownListener","lastY","isDown","handleScrollSideEvent","refreshPosition","handleFollowingPinnedMessage","followPinnedMessage","isLast","writeTo","writeMediaTo","ONE_HOUR","PopupMute","mutePeer","radioForm","AudioAssetPlayer","assets","playSound","assetName","createAudio","playSoundIfDifferent","Audio","stopSound","cancelDelayedPlay","playSoundWithTimeout","audioAsset","getAudioConstraints","constraints","channelCount","constraint","mediaDevices","getSupportedConstraints","constraintSupported","getScreenConstraints","skipAudio","frameRate","getScreenStream","screenStream","getDisplayMedia","getVideoTracks","contentHint","getStream","stream","getUserMedia","getTracks","getStreamCached","_cache","screen","isScreen","stopTrack","track","StringFromLineBuilder","newLine","word","addJoined","finalize","toTelegramSource","fromTelegramSource","fixMediaLineType","mediaType","getConnectionTypeForMediaType","generateMediaFirstLine","port","payloadIds","connectionType","SDPBuilder","addCandidate","foundation","component","protocol","priority","generation","performCandidate","addHeader","sId","bundleMids","bundle","addTransport","transport","skipCandidates","ufrag","pwd","fingerprint","fingerprints","setup","candidates","candidate","addSsrc","streamName","sourceGroups","addSource","ssrc","addMsid","ssrcGroup","sources","semantics","addSsrcEntry","isAnswer","isApplication","codec","isInactive","shouldBeSkipped","payloadTypes","hdrexts","hdrext","clockrate","parameters","fbs","fb","subtype","addConference","conference","sessionId","IS_FIREFOX","recvEntry","sendEntry","AudioStreamAnalyser","streamSource","createMediaStreamSource","gain","createGain","minDecibels","maxDecibels","smoothingTimeConstant","StreamManager","interval","getAmplitude","streamAnalyser","rms","analyse","amplitudes","ANALYSER_LISTENER","AudioContext","webkitAudioContext","outputStream","MediaStream","inputStream","canCreateConferenceEntry","addStream","addTrack","getSource","itemSource","removeTrack","finalizeAddingTrack","changeTimer","hasInputTrackKind","substring","replaceInputAudio","oldTrack","timer","appendToConference","transceiverInit","streams","tracks","findEntry","createEntry","transceiver","createTransceiver","connection","mediaTrackType","trackIdx","sender","replaceTrack","CallInstanceBase","fixSafariAudio","isSharingAudio","streamManager","isSharingVideo","requestAudioSource","requestInputSource","isAudioGood","isVideoGood","onInputStream","requestScreen","endpoint","onTrack","tryAddTrack","saveInputVideoStream","isOutput","isVideo","elementEndpoint","useStream","srcObject","sinkId","outputDeviceId","setSinkId","setMuted","getAudioTracks","isClosing","ConferenceEntry","originalDirection","setPort","setEndpoint","addTransceiver","setSource","generateSsrc","LocalConferenceDescription","maxSeenId","entriesByMid","entriesBySource","entriesByPeerId","setData","deleteEntry","setEntrySource","setEntryPeerId","findFreeSendRecvEntry","isSending","getEntryByMid","getEntryBySource","getEntriesByPeerId","generateSdp","fromConference","CallConnectionInstanceBase","createPeerConnection","RTCPeerConnection","signalingState","connectionState","iceConnectionState","createDataChannel","dict","dataChannel","channel","createDescription","appendStreamToConference","closeConnection","closeConnectionAndStream","stopStream","negotiate","negotiating","negotiateInternal","sendDataChannelData","SDP","mediaSections","parsed","splitStringByLimitWithRest","UniqueNumberGenerator","generate","maxTries","_try","SDPAttributeSplitted","SDPMediaLineParts","SDPLine","mediaLineParts","SDPAttributeInner","missed","exists","rest","nestedMap","makeAttributes","innerParts","SDPAttributes","fillAttributes","attributesMap","linesArray","SDPMediaSection","mediaLine","isReceiving","lookupAttributeKeys","resultShouldBeArray","SDPSessionSection","parseSdp","createSection","sessionSection","lineStr","isIncorrectSdpLine","parseSdpLine","parseMediaSectionInfo","sdp","clientInfo","telegramSourceGroups","sdpLines","parseSourceGroups","raw","GROUP_CALL_STATE","GroupCallConnectionInstance","negotiateThrottled","iceServers","iceTransportPolicy","bundlePolicy","rtcpMuxPolicy","iceCandidatePoolSize","maybeUpdateRemoteVideoConstraints","updateConstraintsInterval","invokeJoinGroupCall","localSdp","mainChannels","groupCall","groupCallId","processedChannels","processed","sectionInfo","payload","processMediaSection","audioChannel","videoChannel","useChannel","appGroupCallsManager","joinGroupCall","connections","extmap","performExtmap","filterServerCodecs","isNewConnection","originalOffer","createOffer","iceRestart","offer","hasMunged","skipAddingMulticast","generator","originalSsrcs","ssrcs","ssrcs2","ssrcsStrLines","ssrc2","addSimulcast","localMLine","codecIds","newData","newChannel","mungedSdp","fixLocalOffer","setLocalDescription","entriesToDelete","answerDescription","iceGatheringState","setRemoteDescription","updateConstraints","getTransceivers","setParameters","getParameters","degradationPreference","colibriClass","defaultConstraints","onStageEndpoints","addInputVideoStream","GroupCallInstance","isSpeakingMap","pinnedSources","participantsSsrcs","hadAutoPinnedSources","dispatchPinnedThrottled","pinnedSource","can_self_unmute","getCachedParticipants","isSharingScreen","presentation","pinSource","unpinSource","unpinAll","getParticipantByPeerId","toggleMuted","changeUserMuted","editParticipant","getVideoElementFromParticipantByType","source_groups","clone","createConnectionInstance","changeRaiseHand","raise","raiseHand","startScreenSharingInternal","connectionInstance","stopScreenSharing","startScreenSharing","startScreenSharingPromise","saveApiParticipant","leaveGroupCallPresentation","toggleScreenSharing","startVideoSharingInternal","videoPaused","videoStopped","startVideoSharing","startVideoSharingPromise","stopVideoSharing","toggleVideoSharing","hangUp","discard","rejoin","isDiscarded","isUpdatingMeInCurrentCall","raise_hand_rating","audio_source","audioSource","onParticipantUpdate","doNotDispatchParticipantUpdate","hasLeft","oldSsrcs","makeSsrcFromParticipant","makeSsrcsFromParticipant","modifiedTypes","oldSsrc","oldSource","oldEntry","GroupCallsController","currentGroupCall","setCurrentGroupCall","startConnectingSound","stopConnectingSound","joinVideo","createMainStreamManager","joinGroupCallInternal","getGroupCallFull","getGroupCallParticipants","handleUpdateGroupCallParticipants","updatingSdp","groupCallsController","ChatTopbar","verifyButtons","isMenuOpen","btnMore","deleteButtonText","getDeleteButtonText","menuButtons","buttonsToVerify","verifyVideoChatButton","call_active","verifyCallButton","getCachedFullUser","phone_calls_available","video_calls_available","onJoinGroupCallClick","onResize","resize","setUtilsRAF","chatUtils","chatAudio","setPeerStatusManual","btnBack","chatInfoContainer","chatInfo","person","avatarElement","btnJoin","btnPinned","btnCall","btnGroupCall","btnMute","btnSearch","pushButtonToVerify","onBtnBackClick","isFirstChat","constructUtils","linked_chat_id","onCallClick","chatContextMenuHintWasShown","contactPeerId","constructAvatar","joinChannel","setMutedState","isTopMessage","hiddenPinnedMessages","constructDiscussionHelpers","byCurrent","newAvatar","setTitleCallback","setStatusCallback","setTitleManual","wasAlreadyUsed","newPinnedMessage","AppPrivateSearchTab","appSearch","btnPickDate","ChatSearch","selectedIndex","onResultsClick","selectResult","onFooterClick","onUpClick","onDownClick","foundCountEl","upBtn","downBtn","footer","dateBtn","renderedCount","ChatBackgroundPatternRenderer","canvases","instance","INSTANCES","renderToCanvas","fillCanvas","crossOrigin","objectUrl","imageWidth","imageHeight","patternHeight","dpr","originalHeight","mask","globalCompositeOperation","centerY","topY","endY","bottomY","setCanvasDimensions","Chat","backgroundEl","Log","backgroundTempId","sharedMediaTabs","setBackground","patternRenderer","gradientCanvas","previousGradientRenderer","previousPatternRenderer","previousPatternCanvas","patternCanvas","isDarkPattern","getInstance","_gradientRenderer","setBackgroundPromise","setType","beforeDestroy","cleanupBackground","searchTab","_isAnyGroup","setAutoDownloadMedia","destroySharedMediaTab","bubblesSetPeerPromise","photoSizeMax","videoSizeMax","fileSizeMax","photo_size_max","video_size_max","getAutoDownloadSettingsByPeerId","callbacksPromise","setPrefix","ignoreThreadId","historyStorageTransferable","historySerialized","MarkupTooltip","waitingForMouseUp","mouseUpCounter","onMouseUpSingle","resetSelection","tools1","tools2","cancelClosening","linkBackButton","linkInput","applyLink","isLinkValid","setTooltipPosition","linkApplyButton","applyDiv","delimiter1","delimiter2","delimiter3","matchUrlProtocol","hideTimeout","getActiveMarkupButton","nodes","getSelectedNodes","currentMarkups","activeButtons","isLinkToggle","bodyRect","selectionRect","inputRect","selectionTop","sizesRect","isFirstShow","setMouseUpEvent","handleSelection","arcParameter","rx","ry","xAxisRotation","largeArcFlag","sweepFlag","generatePathData","tl","tr","bl","ChatDragAndDrop","dropIcon","onDragOver","onDragLeave","onDrop","outlineWrapper","dropHeader","dropSubtitle","headerArgs","setPath","disableTransition","LineBlobDrawable","maxRadius","minRadius","N","radiusNext","speed","generateBlob","radDif","generateNextBlob","amplitude","speedScale","draw","paint","pinnedTop","progressToPinned","beginPath","moveTo","lineTo","r1","progressNext","x1","x2","cx","y1","y2","bezierCurveTo","closePath","WeavingState","stateId","createGradient","shader","getGradientFromType","x0","y0","createLinearGradient","addColorStop","dt","TopbarWeave","handleDevicePixelRatioChanged","setSize","forceUpdate","handleResize","resizeHandler","resizeCanvas","invokeDraw","handleFocus","focused","handleBlur","lbd","lbd1","lbd2","currentState","previousState","progressToState","lastUpdateTime","animateToAmplitude","animateAmplitudeDiff","amplitude2","animateAmplitudeDiff2","top1","top2","paint1","globalAlpha","setCurrentState","states","componentDidMount","matchMedia","setAmplitude","componentWillUnmount","setCanvasSize","customProperties","computedStyle","getProperty","RLottieIconItemPart","playPart","RLottieIconItem","createPart","initFrame","skipFirstFrameRendering","inverseColor","onLoadForColor","onLoadForPart","getPart","RLottieIcon","startFrame","endFrame","frameCount","SuperRLottieIcon","partState","colorState","getColor","partCallback","changedPartState","changedColorState","setPartState","setColorState","prevState","renderIfPaused","invoke","GroupCallMicrophoneIcon","GROUP_CALL_MICROPHONE_BUTTON_STATE","partName","HAND","MUTED","UNMUTED","GroupCallParticipantMutedIcon","colored","GROUP_CALL_PARTICIPANT_MUTED_STATE","colorStr","MUTED_FOR_ME","MUTED_BY_ADMIN","propertyValue","getColorByMutedState","generateEqualParts","clearMutedStateModifier","GroupCallParticipantStatusElement","withIcons","iconClassName","element2","actionClassName","GroupCallParticipantsList","onElementDestroy","getGroupCallParticipantMutedState","mutedIcon","ControlsHover","hideControls","setHideTimeout","hideControlsTimeout","isShown","controlsLocked","canHideControls","showControls","toggleControls","ignoreClickClassName","relatedTarget","showOnLeaveToClassName","lockControls","callVideoCanvasBlur","renderFrame","GroupCallParticipantVideoElement","setPinned","setParticipant","groupCallParticipantMutedIcon","groupCallParticipantStatus","updateParticipant","GroupCallParticipantsVideoElement","participantsElements","setElementDisplay","setInstance","shouldDisplayElement","displayPinned","shouldDisplay","isPinned","hasAnyVideo","participantElements","participantVideo","_onLengthChange","GroupCallParticipantContextMenu","onOpenProfileClick","PopupGroupCall","targetPeerId","toggleParticipantMuted","canManageCall","muted_by_you","kickFromChat","getContainer","GroupCallParticipantsElement","groupCallParticipantsVideo","GroupCallDescriptionElement","descriptionIntl","GroupCallTitleElement","makeButton","_className","buttonDiv","isConfirm","resizeHandlerClassName","MovableElement","fixDimensions","fixPosition","addResizeHandlers","setSwipeHandler","destroyElements","handlers","startTop","startLeft","startWidth","startHeight","resizingSide","isEnlarging","resizeDiff","maxPossible","setPositionToCenter","MovablePanel","toggleMovable","movable","movableOptions","toggleClassName","withoutOverlay","onFullScreenClick","onToggleControls","buttonsContainer","onVideoClick","btnVideo","onScreenClick","btnScreen","onLeaveClick","onFullScreenChange","toggleBigLayout","btnFullScreen","btnExitFullScreen","wasFullScreen","movablePanel","videosCount","wasBig","btnInvite","btnShowColumn","toggleRightColumn","btnFullScreen2","headerInfo","newHeader","newHeaderInfo","newHeaderTitle","btnHideColumn","videosScrollable","groupCallTitle","groupCallDescription","groupCallBodyHeaderDescription","constructButtons","groupCallParticipants","updateInstance","setHasPinned","groupCallMicrophoneIcon","_makeButton","microphoneIcon","btnLeave","setDescription","microphoneButtonState","getGroupCallMicrophoneButtonState","micState","CALL_STATE","CallDescriptionElement","connectedAt","GroupCallMicrophoneIconMini","INIT_STATE","PopupCall","resizeVideoContainers","videoContainers","interlocutorUserId","emojisSubtitle","partyStates","partyMutedState","stateText","constructFirstButtons","constructSecondButtons","wasTryingToJoin","movableElement","controlsHover","getCallInstance","firstButtonsRow","muteI18nElement","secondButtonsRow","declineI18nElement","btnDecline","btnAccept","acceptCall","createVideoContainer","big","isPendingIncoming","outputState","getMediaState","oldContainers","mediaState","getVideoElement","hasFrame","hasPromise","videoState","screencastState","videoContainer","output","getEmojisFingerprint","popupWidth","MAX_WIDTH_PX","MAX_HEIGHT_PX","isVertical","MAX_SIZE","biggestSideSize","widthRatio","heightRatio","parseSignalingData","screencast","convertNumber","ssrcGroups","sourceGroup","rtpExtensions","payloadTypesMap","getPayloadType","payloadType","feedbackTypes","CallConnectionInstance","localDescription","remoteDescription","descriptionInit","offerReceived","createAnswer","offerSent","initialSetup","sendCallSignalingData","CALL_REQUEST_TIMEOUT","CallsController","instances","sortedInstances","setPhoneCall","confirmCall","createCallInstance","admin_id","overrideConnectionState","setHangUpTimeout","encryptionKey","g_a","dh","g_a_or_b","g_a_hash","bytesCmp","key_fingerprint","appCallsManager","computeKey","joinCall","callId","onUpdatePhoneCallSignalingData","currentCall","getCallByUserId","CallInstance","hasConnected","clearHangUpTimeout","discardReason","hasCurrent","startCallInternal","fullInfo","participant_id","generateDh","requestCall","phoneCall","callsController","crypto","subtle","P2PEncryptor","p2pKey","seqMap","concatSHA256","bufferConcats","convertToUint8Array","encryptPrepared","msgKeyLarge","subarray","msgKey","aesKeyIv","prepareAesKeyIv","aesProcessCtr","encryptRawPacket","seq","ArrayBuffer","setUint32","sha256a","sha256b","iv","encryptedData","dataSize","encrypt","cryptoKey","constTimeIsDifferent","msgKeyEquals","decryptRawPacket","encryptedDataSize","decryptionBuffer","getUint32","ChromeP2PSdpBuilder","stringBuilder","addExtmap","addPayloadTypes","FirefoxP2PSdpBuilder","SafariP2PSdpBuilder","isFirefox","userAgent","isSafari","j","fmtp","getOwnPropertyNames","pName","P2PSdpBuilder","sdpString","sdpMLineIndex","sdpMid","relAddress","tcpType","networkId","networkCost","generateOffer","generateAnswer","udp_p2p","udp_reflector","min_layer","max_layer","library_versions","createdAt","decryptQueue","lowBattery","videoRotation","Proxy","setMediaState","sendMediaState","mediaStates","_sendMediaState","_connectionState","sortIndex","wasStartingScreen","wasStartingVideo","isSharingVideoType","audioTrack","hangUpTimeout","canAccept","g_b","g_b_hash","getCallInput","phonePhoneCall","savePhonePhoneCall","configuration","ipv6","urls","turn","stun","credential","p2p_allowed","getRtcConfiguration","sendIceCandidate","encryptor","decryptor","processDecryptQueue","createDataChannelEntry","dataChannelEntry","negotiated","applyDataChannelData","TextEncoder","encode","iceCandidate","p2pParseCandidate","emojisFingerprint","getEmojisFingerprintPromise","codePoints","unlockStreamManager","doTheMagic","sdpDescription","videoTrack","onMutedChange","discardedByOtherParty","hasVideo","discardCall","performCodec","_codec","setDataToDescription","filterNotVP8","vp8PayloadType","rtxIdx","apt","applyCallSignalingData","performSsrcGroups","sendRecvEntry","tryToReleaseCandidates","generateCandidate","RTCIceCandidate","addIceCandidate","decryptedData","TextDecoder","decode","signalingData","TopbarCall","onState","weave","clearCurrentInstance","currentDescription","instanceListenerSetter","isChangingInstance","callDescription","convertCallStateToGroupState","groupCallMicrophoneIconMini","throttledMuteClick","weaveContainer","uiNotificationsManager","notificationsShown","notificationIndex","notificationsCount","soundsPlayed","vibrateSupport","faviconEl","titleBackup","titleChanged","stopped","pushInited","updateLocalSettings","updSettings","nodesktop","novibrate","nopreview","nopush","needPush","webPushApiManager","registeredDevice","nosound","requestPermission","Notification","mozVibrate","webkitVibrate","setAppBadge","notificationsUiSupport","notifySoundEl","topMessagesDeferred","singleInstance","idle","toggleToggler","peerString","soundReset","unreadUnmutedPeerIds","tokenData","unregisterDevice","registerDevice","notificationData","custom","hasChat","hasUser","buildNotification","fwdCount","peerReaction","peerTypeNotifySettings","notification","getPeerString","notificationMessage","noIncrement","notificationFromPeerId","peerPhoto","loadAvatar","resetTitle","isBlink","setFavicon","titleInterval","arc","fontSize","textBaseline","textAlign","fillText","prevFavicon","replaceChild","testSound","permission","appRuntimeManager","onclose","getLocalSettings","nextSoundAt","prevSoundVolume","filename","token_type","tokenType","tokenValue","other_uids","app_sandbox","secret","getFilesFromEvent","onlyTypes","scanFiles","isDirectory","directoryReader","createReader","readEntries","itemFile","getAsFile","DataTransferItem","DragEvent","dataTransfer","clipboardData","originalEvent","webkitGetAsEntry","AppImManager","columnEl","offline","updateStatusInterval","cacheStorage","onHashChange","saveState","parseUriParams","tgaddr","postId","openUsername","userName","setSettings","chatsSelectTabDebounced","toggleChatGradientAnimation","onDocumentPaste","attachType","newMediaPopup","_types","canDrag","apiUpdatesManager","backgroundPromises","updateStatus","emojiAnimationContainer","appendEmojiAnimationContainer","createNewChat","chatsSelectTab","compareVersion","deleteFilesIterative","applyCurrentTheme","resizeInstances","saveChatPosition","choosing","setChoosingStickerTyping","typings","typing","onInstanceDeactivated","isUpdated","receiptMessage","onSpoilerClick","spoilerTimeout","overrideHash","stateStorage","topbarCall","discardCurrentCall","setAuthorized","telegramMeWebManager","addAnchorListener","uriParams","hashtag","pathnameParams","STICKER_SET","makeLink","VOICE_CHAT","USER_PHONE_NUMBER","PRIVATE_POST","thread","comment","MESSAGE","attachKeydownListener","timeoutOperation","requests","request","isBad","activatingChat","IGNORE_KEYS","altKey","getFirstMessageToEdit","getNextDialog","newEvent","KeyboardEvent","commentId","resolveChannel","checkChatInvite","saveApiChat","resolvePhone","openUrl","wrappedUrl","noPathnameParams","pathname","noUriParams","openComment","generateThreadServiceStartMessage","phone_calls_private","ignoreGroupCall","ignoreCall","discardGroupCallConfirmation","discardCallConfirmation","createGroupCall","setCurrentBackground","broadcastEvent","getBackground","getFile","lastBackgroundUrl","chatBubbles","chatPositions","backgroundUrl","prevTab","prevIdx","attachDragAndDropListeners","drops","mediaDrops","isFiles","_dropsContainer","mediaDropsContainer","dropsContainer","_drops","foundMedia","drop","transitionTime","onImTabChange","updateMyOnlineStatus","spliceChats","fromIndex","chatFrom","chatTo","chatIndex","existingIndex","oldChat","getTypingElement","dot","eye","getPeerTyping","getPeerTypings","langPackKeys","multi","mapa","peerTitlePromise","typingElement","descriptionElement","getChatStatus","typingEl","onlines","getOnlines","getUserStatus","ignoreSelf","getPeerStatus","useWhitespace","typingContainer","VideoPlayer","onPlaybackRackMenuToggle","onPip","onPipClose","playbackRateButton","skin","stylePlayer","setBtnMenuToggle","initDuration","buildControls","timeDuration","pipButton","fullScreenButton","timeElapsed","leftControls","requestPictureInPicture","debounceTime","debouncedPip","listener","pictureInPictureElement","toggleFullScreen","nextIdx","PLAYBACK_RATES","onFullScreen","setPlaybackRateIcon","pictureInPictureEnabled","rate","PLAYBACK_RATES_ICONS","webkitEnterFullscreen","enterFullscreen","AppMediaViewerBase","topButtons","preloaderStreamable","isFirstOpen","pageEl","zoomElements","zoomSwipeStartX","zoomSwipeStartY","zoomSwipeX","zoomSwipeY","setZoomValue","rangeSelector","moversContainer","btnOut","btnIn","toggleZoom","setMoverAnimationPromise","highlightSwitchersTimeout","wholeDiv","isZooming","mover","classNames","ctrlKeyDown","changeZoom","onKeyUp","scrollingUp","MEDIA_VIEWER_CLASSNAME","overlaysDiv","mainDiv","topbarLeft","authorRight","zoom","onLoadedMore","setNewMover","onDownloadClick","moveLength","setMoverPromise","evt","zoomValue","videoPlayer","zoomSwipeHandler","lastDiffY","btnMenuToggle","setMoverToTarget","appMediaViewer","removeGlobalListeners","toggleOverlay","toggleGlobalListeners","setGlobalListeners","closing","fromRight","removeCenterFromMover","wasActive","realParent","SVGForeignObjectElement","needOpacity","setFullAspect","scaleX","scaleY","brSplitted","fillPropertyValue","willBeLeft","willBeTop","isRejected","SVGSVGElement","sizeTailPath","toggleWholeActive","mediaElement","clipId","newClipId","newSvg","outerHTML","SVGUseElement","sX","sY","upscale","_br","moveTheMover","toLeft","windowW","newTransform","p1","newMover","updateMediaSource","setAuthorInfo","wrapTitlePromise","oldAvatar","_openMedia","setAuthorPromise","setTargets","useContainerAsTarget","padding","windowH","useController","moverVideo","canPlayThrough","createPlayer","ckin","overlay","otherMediaViewer","releaseSingleMedia","HAVE_FUTURE_DATA","attachCanPlay","networkState","NETWORK_LOADING","isntEnoughData","cancellablePromise","haveImage","captionTimeout","isForDocument","onAuthorClick","onEmptied","setCaptionTimeout","btnMenuForward","btnMenuDownload","btnMenuDelete","onCaptionClick","getScheduledMessageByPeer","setCaption","cantForwardMessage","cantDownloadMessage","AvatarListLoader","loadedAllUp","AppMediaViewerAvatar","onAvatarUpdate","getTarget","hadMessage","isObject","believeMe","addedToQueue","wasPeerId","newPeerId","DialogsContextMenu","onArchiveClick","selectedId","editPeerFolders","folder_id","toggleDialogPin","pinned_dialogs_count_max","onUnmuteClick","onUnreadClick","top_message","isDialogUnread","SENDING_STATUS","ConnectionStatusComponent","hadConnect","connecting","timedOut","updating","setConnectionStatus","rootScope","baseDcId","connectionStatus","setFirstConnectionTimeout","online","forceGetDifference","retryAt","setStatusText","currentLangPackKey","statusEl","statusPreloader","CHANGE_STATE_DELAY","getA","networkerFactory","forceReconnect","timerSpan","forceReconnectTimeout","setStateTimeout","statusContainer","easeInOutSine","roundRect","defaultRadius","quadraticCurveTo","DPR","SIZE","MARGIN","Shimmer","currTime","diffTime","spread","pausedTime","pauseInterval","lightSource","lightSpread","animations","currentAnimationIndex","keepTime","cycleAnimation","currentAnimation","animateGlow","animateSlide","smartInc","lightLeft","lightRight","lightCenter","shimmerColor","on","DialogsPlaceholder","onThemeChange","stopAnimation","startAnimation","updateCanvasSize","shimmer","generatedValues","marginVertical","lineBorderRadius","lineMarginVertical","statusWidth","getRectFrom","onRemove","blockScrollable","overflowY","availableLength","detachTime","renderDetachAnimationFrame","completed","elapsedRowTime","dialogHeight","createPattern","patternContext","drawChat","firstLineWidth","secondLineWidth","marginLeft","drawCircle","drawCircleFromStart","setPromiseMiddleware","oldPromise","SortedDialogList","indexKey","appDialogsManager","addListDialog","isBatch","AppDialogsManager","placeholders","sortedLists","scrollables","folders","menuScrollContainer","lastActiveElements","offsets","initedListeners","loadedDialogsAtLeastOnce","onTabChange","loadDialogsRenderPromise","loadDialogsPromise","onChatsScroll","_onListLengthChange","checkIfPlaceholderNeeded","hasContacts","removeContactsPlaceholder","updateContactsLength","loadContacts","verifyPeerIdForContacts","processContact","added","setListClickListener","onChatsRegularScroll","sliceTimeout","scrollTopWas","rectContainer","rectTarget","firstY","firstElement","lastElement","elementOverflow","sliceFromStart","sliceFromEnd","deleteDialog","setOffsets","onChatsScrollTop","loadDialogs","getProxiedManagers","bottomPart","allChatsIntlElement","onStateLoaded","setFilterId","addFilter","foldersScrollable","filtersNavigationItem","setFilterIdAndChangeTab","changeFiltersAllChatsKey","getDialogIndexKey","getDialogIndexKeyByFilterId","setOnlineStatus","hasClassName","initListeners","getDialogDom","processDialogForCallStatus","setFilterUnreadCount","setLastMessageN","setUnread","validateDialogForFilter","setFiltersUnreadCount","updateDialog","setUnreadMessagesN","setDialogActive","getCachedDialogs","validateListForFilter","onFiltersLengthChange","containerToAppend","renderedFilter","unsetTyping","dialogDom","callIcon","haveFilters","renderFiltersPromise","showFiltersPromise","getNotifyPeerTypeSettings","fillConversations","getOffsetIndex","isDialogMustBeInViewport","migratedTo","testDialogForFilter","topOffset","bottomOffset","unreadSpan","unreadUnmutedCount","unreadCount","getFolderUnreadCount","generateScrollable","sortedDialogList","folderButton","titleAndUnreadSpan","firstChats","dialog_a","dialog_b","addDialog","setLastMessage","createChatList","clientWidth","wasShowing","cachedInfoPromise","currentOffsetIndex","needIndex","getConversationsResult","isTopEnd","cccc","offsetDialog","generateEmptyPlaceholder","classNameType","subtitleArgs","placeholderContainer","emptyDialogsPlaceholderSubtitle","usersLength","placeholderType","updatePartClassName","updateContactsLengthPromise","firstDialog","getDialogFromElement","lastDialog","withContext","openInner","lastActiveListElement","setPeerFunc","sameElement","getDialogByPeerId","draftMessage","lastTimeSpan","willPrepend","videoTypes","playIcon","senderBold","setUnreadMessages","wasMuted","setStatusMessage","hasUnreadBadge","disableAnimationIfRippleFound","setSendingStatus","statusSpan","isUnreadBadgeMounted","unreadBadge","hasMentionsBadge","isMentionBadgeMounted","mentionsBadge","isMention","getDialog","originalDialog","setCallStatus","START_X","wasMounted","itemProgress","groupCallActiveIcon","addDialogNew","call_not_empty","addDialogAndSetLastMessage","captionDiv","titleSpanContainer","titleIconsPromise","titleP","rightSpan","oldTypingElement","newTypingElement","module","exports","defineProperty","enumerable","Symbol","toStringTag","__esModule","prototype","isRecordingSupported","bufferLength","encoderApplication","encoderFrameSize","encoderPath","maxFramesPerPage","mediaTrackConstraints","resampleQuality","streamPages","wavBitDepth","encodedSamplePosition","WebAssembly","clearStream","audioContext","closeAudioContext","encodeBuffers","getChannelData","encoder","postMessage","buffers","initAudioContext","initAudioGraph","scriptProcessorNode","createScriptProcessor","destination","onaudioprocess","inputBuffer","monitorGainNode","setMonitorGain","recordingGainNode","setRecordingGain","initSourceNode","loadWorker","Worker","initWorker","streamPage","storePage","recordedPages","samplePosition","page","originalSampleRate","sampleRate","wavSampleRate","onpause","resume","onresume","setTargetAtTime","onstart","destroyWorker","Function"],"sourceRoot":""}